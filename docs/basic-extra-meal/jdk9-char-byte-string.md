---
category:
  - Javaæ ¸å¿ƒ
tag:
  - Java
---

# jdk9ä¸ºä½•è¦å°†Stringçš„åº•å±‚å®ç°ç”±char[]æ”¹æˆäº†byte[]?

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯äºŒå“¥å‘€ï¼å¦‚æœä½ ä¸æ˜¯ Java8 çš„é’‰å­æˆ·ï¼Œä½ åº”è¯¥æ—©å°±å‘ç°äº†ï¼šString ç±»çš„æºç å·²ç»ç”± `char[]` ä¼˜åŒ–ä¸ºäº† `byte[]` æ¥å­˜å‚¨å­—ç¬¦ä¸²å†…å®¹ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿ

å¼€é—¨è§å±±åœ°è¯´ï¼Œä» `char[]` åˆ° `byte[]`ï¼Œæœ€ä¸»è¦çš„ç›®çš„æ˜¯**ä¸ºäº†èŠ‚çœå­—ç¬¦ä¸²å ç”¨çš„å†…å­˜**ã€‚å†…å­˜å ç”¨å‡å°‘å¸¦æ¥çš„å¦å¤–ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯ GC æ¬¡æ•°ä¹Ÿä¼šå‡å°‘ã€‚

### ä¸€ã€ä¸ºä»€ä¹ˆè¦ä¼˜åŒ– String èŠ‚çœå†…å­˜ç©ºé—´

æˆ‘ä»¬ä½¿ç”¨ `jmap -histo:live pid | head -n 10` å‘½ä»¤å°±å¯ä»¥æŸ¥çœ‹åˆ°å †å†…å¯¹è±¡ç¤ºä¾‹çš„ç»Ÿè®¡ä¿¡æ¯ã€æŸ¥çœ‹ ClassLoader çš„ä¿¡æ¯ä»¥åŠ finalizer é˜Ÿåˆ—ã€‚

ä»¥æˆ‘æ­£åœ¨è¿è¡Œç€çš„ç¼–ç¨‹å–µå–µé¡¹ç›®å®ä¾‹ï¼ˆåŸºäº Java 8ï¼‰æ¥è¯´ï¼Œç»“æœæ˜¯è¿™æ ·çš„ã€‚

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/basic-extra-meal/jdk9-char-byte-string-d826ce88-bbbe-47a3-a1a9-4dd86dd3632f.png)

å…¶ä¸­ String å¯¹è±¡æœ‰ 17638 ä¸ªï¼Œå ç”¨äº† 423312 ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œæ’åœ¨ç¬¬ä¸‰ä½ã€‚

ç”±äº Java 8 çš„ String å†…éƒ¨å®ç°ä»ç„¶æ˜¯ `char[]`ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†…å­˜å ç”¨æ’åœ¨ç¬¬ 1 ä½çš„å°±æ˜¯ char æ•°ç»„ã€‚

`char[]` å¯¹è±¡æœ‰ 17673 ä¸ªï¼Œå ç”¨äº† 1621352 ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œæ’åœ¨ç¬¬ä¸€ä½ã€‚

é‚£ä¹Ÿå°±æ˜¯è¯´ä¼˜åŒ– String èŠ‚çœå†…å­˜ç©ºé—´æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œå¦‚æœæ˜¯å»ä¼˜åŒ–ä¸€ä¸ªä½¿ç”¨é¢‘ç‡æ²¡æœ‰ String è¿™ä¹ˆé«˜çš„ç±»åº“ï¼Œå°±æ˜¾å¾—éå¸¸çš„é¸¡è‚‹ã€‚

### äºŒã€`byte[]` ä¸ºä»€ä¹ˆå°±èƒ½èŠ‚çœå†…å­˜ç©ºé—´å‘¢ï¼Ÿ

ä¼—æ‰€å‘¨çŸ¥ï¼Œchar ç±»å‹çš„æ•°æ®åœ¨ JVM ä¸­æ˜¯å ç”¨ä¸¤ä¸ªå­—èŠ‚çš„ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ˜¯ UTF-8 ç¼–ç ï¼Œå…¶å€¼èŒƒå›´åœ¨ '\u0000'ï¼ˆ0ï¼‰å’Œ '\uffff'ï¼ˆ65,535ï¼‰ï¼ˆåŒ…å«ï¼‰ä¹‹é—´ã€‚



ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨ `char[]` æ¥è¡¨ç¤º String å°±å¯¼è‡´äº†å³ä½¿ String ä¸­çš„å­—ç¬¦åªç”¨ä¸€ä¸ªå­—èŠ‚å°±èƒ½è¡¨ç¤ºï¼Œä¹Ÿå¾—å ç”¨ä¸¤ä¸ªå­—èŠ‚ã€‚

è€Œå®é™…å¼€å‘ä¸­ï¼Œå•å­—èŠ‚çš„å­—ç¬¦ä½¿ç”¨é¢‘ç‡ä»ç„¶è¦é«˜äºåŒå­—èŠ‚çš„ã€‚

å½“ç„¶äº†ï¼Œä»…ä»…å°† `char[]` ä¼˜åŒ–ä¸º `byte[]` æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜è¦é…åˆ Latin-1 çš„ç¼–ç æ–¹å¼ï¼Œè¯¥ç¼–ç æ–¹å¼æ˜¯ç”¨å•ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºå­—ç¬¦çš„ï¼Œè¿™æ ·å°±æ¯” UTF-8 ç¼–ç èŠ‚çœäº†æ›´å¤šçš„ç©ºé—´ã€‚

æ¢å¥è¯è¯´ï¼Œå¯¹äºï¼š

```java
String name = "jack";
```

è¿™æ ·çš„ï¼Œä½¿ç”¨ Latin-1 ç¼–ç ï¼Œå ç”¨ 4 ä¸ªå­—èŠ‚å°±å¤Ÿäº†ã€‚

ä½†å¯¹äºï¼š

```java
String name = "å°äºŒ";
```

è¿™ç§ï¼Œæœ¨çš„åŠæ³•ï¼Œåªèƒ½ä½¿ç”¨ UTF16 æ¥ç¼–ç ã€‚

é’ˆå¯¹ JDK 9 çš„ String æºç é‡Œï¼Œä¸ºäº†åŒºåˆ«ç¼–ç æ–¹å¼ï¼Œè¿½åŠ äº†ä¸€ä¸ª coder å­—æ®µæ¥åŒºåˆ†ã€‚

```java
/**
 * The identifier of the encoding used to encode the bytes in
 * {@code value}. The supported values in this implementation are
 *
 * LATIN1
 * UTF16
 *
 * @implNote This field is trusted by the VM, and is a subject to
 * constant folding if String instance is constant. Overwriting this
 * field after construction will cause problems.
 */
private final byte coder;
```

Java ä¼šæ ¹æ®å­—ç¬¦ä¸²çš„å†…å®¹è‡ªåŠ¨è®¾ç½®ä¸ºç›¸åº”çš„ç¼–ç ï¼Œè¦ä¹ˆ Latin-1 è¦ä¹ˆ UTF16ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä» `char[]` åˆ° `byte[]`ï¼Œ**ä¸­æ–‡æ˜¯ä¸¤ä¸ªå­—èŠ‚ï¼Œçº¯è‹±æ–‡æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œåœ¨æ­¤ä¹‹å‰å‘¢ï¼Œä¸­æ–‡æ˜¯ä¸¤ä¸ªå­—èŠ‚ï¼Œåº”ä¸ºä¹Ÿæ˜¯ä¸¤ä¸ªå­—èŠ‚**ã€‚

### ä¸‰ã€ä¸ºä»€ä¹ˆç”¨UTF-16è€Œä¸ç”¨UTF-8å‘¢ï¼Ÿ

åœ¨ UTF-8 ä¸­ï¼Œ0-127 å·çš„å­—ç¬¦ç”¨ 1 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œä½¿ç”¨å’Œ ASCII ç›¸åŒçš„ç¼–ç ã€‚åªæœ‰ 128 å·åŠä»¥ä¸Šçš„å­—ç¬¦æ‰ç”¨ 2 ä¸ªã€3 ä¸ªæˆ–è€… 4 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚

- å¦‚æœåªæœ‰ä¸€ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆæœ€é«˜çš„æ¯”ç‰¹ä½ä¸º 0ï¼›
- å¦‚æœæœ‰å¤šä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå­—èŠ‚ä»æœ€é«˜ä½å¼€å§‹ï¼Œè¿ç»­æœ‰å‡ ä¸ªæ¯”ç‰¹ä½çš„å€¼ä¸º 1ï¼Œå°±ä½¿ç”¨å‡ ä¸ªå­—èŠ‚ç¼–ç ï¼Œå‰©ä¸‹çš„å­—èŠ‚å‡ä»¥ 10 å¼€å¤´ã€‚

å…·ä½“çš„è¡¨ç°å½¢å¼ä¸ºï¼š

- 0xxxxxxxï¼šä¸€ä¸ªå­—èŠ‚ï¼›
- 110xxxxx 10xxxxxxï¼šä¸¤ä¸ªå­—èŠ‚ç¼–ç å½¢å¼ï¼ˆå¼€å§‹ä¸¤ä¸ª 1ï¼‰ï¼› - 1110xxxx 10xxxxxx 10xxxxxxï¼šä¸‰å­—èŠ‚ç¼–ç å½¢å¼ï¼ˆå¼€å§‹ä¸‰ä¸ª 1ï¼‰ï¼› 
- 11110xxx 10xxxxxx 10xxxxxx 10xxxxxxï¼šå››å­—èŠ‚ç¼–ç å½¢å¼ï¼ˆå¼€å§‹å››ä¸ª 1ï¼‰ã€‚

å…³äºå­—ç¬¦ç¼–ç ï¼Œæˆ‘åœ¨ã€ŠJava ç¨‹åºå‘˜è¿›é˜¶ä¹‹è·¯ã€‹é‡Œæ›¾è®²åˆ°è¿‡ï¼Œæƒ³è¦æ·±å…¥äº†è§£çš„å°ä¼™ä¼´æŸ¥çœ‹ä¸‹é¢çš„é“¾æ¥ğŸ”—ï¼š

>https://tobebetterjavaer.com/basic-extra-meal/java-unicode.html

ä¹Ÿå°±æ˜¯è¯´ï¼ŒUTF-8 æ˜¯å˜é•¿çš„ï¼Œé‚£å¯¹äº String è¿™ç§æœ‰éšæœºè®¿é—®æ–¹æ³•çš„ç±»æ¥è¯´ï¼Œå°±å¾ˆä¸æ–¹ä¾¿ã€‚æ‰€è°“çš„éšæœºè®¿é—®ï¼Œå°±æ˜¯charAtã€subStringè¿™ç§æ–¹æ³•ï¼Œéšä¾¿æŒ‡å®šä¸€ä¸ªæ•°å­—ï¼ŒStringè¦èƒ½ç»™å‡ºç»“æœã€‚å¦‚æœå­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦å ç”¨çš„å†…å­˜æ˜¯ä¸å®šé•¿çš„ï¼Œé‚£ä¹ˆè¿›è¡Œéšæœºè®¿é—®çš„æ—¶å€™ï¼Œå°±éœ€è¦ä»å¤´å¼€å§‹æ•°æ¯ä¸ªå­—ç¬¦çš„é•¿åº¦ï¼Œæ‰èƒ½æ‰¾åˆ°ä½ æƒ³è¦çš„å­—ç¬¦ã€‚

é‚£æœ‰å°ä¼™ä¼´å¯èƒ½ä¼šé—®ï¼ŒUTF-16ä¹Ÿæ˜¯å˜é•¿çš„å‘¢ï¼Ÿä¸€ä¸ªå­—ç¬¦è¿˜å¯èƒ½å ç”¨ 4 ä¸ªå­—èŠ‚å‘¢ï¼Ÿ

çš„ç¡®ï¼ŒUTF-16 ä½¿ç”¨ 2 ä¸ªæˆ–è€… 4 ä¸ªå­—èŠ‚æ¥å­˜å‚¨å­—ç¬¦ã€‚

- å¯¹äº Unicode ç¼–å·èŒƒå›´åœ¨ 0 ~ FFFF ä¹‹é—´çš„å­—ç¬¦ï¼ŒUTF-16 ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚å­˜å‚¨ã€‚
- å¯¹äº Unicode ç¼–å·èŒƒå›´åœ¨ 10000 ~ 10FFFF ä¹‹é—´çš„å­—ç¬¦ï¼ŒUTF-16 ä½¿ç”¨å››ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ï¼šå°†å­—ç¬¦ç¼–å·çš„æ‰€æœ‰æ¯”ç‰¹ä½åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œè¾ƒé«˜çš„ä¸€äº›æ¯”ç‰¹ä½ç”¨ä¸€ä¸ªå€¼ä»‹äº D800~DBFF ä¹‹é—´çš„åŒå­—èŠ‚å­˜å‚¨ï¼Œè¾ƒä½çš„ä¸€äº›æ¯”ç‰¹ä½ï¼ˆå‰©ä¸‹çš„æ¯”ç‰¹ä½ï¼‰ç”¨ä¸€ä¸ªå€¼ä»‹äº DC00~DFFF ä¹‹é—´çš„åŒå­—èŠ‚å­˜å‚¨ã€‚

ä½†æ˜¯åœ¨ Java ä¸­ï¼Œä¸€ä¸ªå­—ç¬¦ï¼ˆcharï¼‰å°±æ˜¯ 2 ä¸ªå­—èŠ‚ï¼Œå  4 ä¸ªå­—èŠ‚çš„å­—ç¬¦ï¼Œåœ¨ Java é‡Œä¹Ÿæ˜¯ç”¨ä¸¤ä¸ª char æ¥å­˜å‚¨çš„ï¼Œè€ŒStringçš„å„ç§æ“ä½œï¼Œéƒ½æ˜¯ä»¥Javaçš„å­—ç¬¦ï¼ˆcharï¼‰ä¸ºå•ä½çš„ï¼ŒcharAtæ˜¯å–å¾—ç¬¬å‡ ä¸ªcharï¼ŒsubStringå–çš„ä¹Ÿæ˜¯ç¬¬å‡ ä¸ªåˆ°ç¬¬å‡ ä¸ªcharç»„æˆçš„å­ä¸²ï¼Œç”šè‡³lengthè¿”å›çš„éƒ½æ˜¯charçš„ä¸ªæ•°ã€‚

æ‰€ä»¥UTF-16åœ¨Javaçš„ä¸–ç•Œé‡Œï¼Œå°±å¯ä»¥è§†ä¸ºä¸€ä¸ªå®šé•¿çš„ç¼–ç ã€‚

>å‚è€ƒé“¾æ¥ï¼šhttps://www.zhihu.com/question/447224628

<img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/xingbiaogongzhonghao.png" width="700px">
