<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.14" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.52" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta name="keywords" content="Redisé¢è¯•é¢˜,Redis,å…«è‚¡æ–‡,é¢è¯•é¢˜"><meta property="og:url" content="https://javabetter.cn/sidebar/sanfene/redis.html"><meta property="og:site_name" content="äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯"><meta property="og:title" content="Redisé¢è¯•é¢˜ï¼Œ57é“Rediså…«è‚¡æ–‡ï¼ˆ4.6ä¸‡å­—286å¼ æ‰‹ç»˜å›¾ï¼‰ï¼Œé¢æ¸£é€†è¢­å¿…çœ‹ğŸ‘"><meta property="og:description" content="ä¸‹è½½æ¬¡æ•°è¶… 1 ä¸‡æ¬¡ï¼Œ4.6 ä¸‡å­— 286 å¼ æ‰‹ç»˜å›¾ï¼Œè¯¦è§£ 57 é“ Redis é¢è¯•é«˜é¢‘é¢˜ï¼ˆè®©å¤©ä¸‹æ²¡æœ‰éš¾èƒŒçš„å…«è‚¡ï¼‰ï¼Œé¢æ¸£èƒŒä¼šè¿™äº› Redis å…«è‚¡æ–‡ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚"><meta property="og:type" content="article"><meta property="og:image" content="https://cdn.tobebetterjavaer.com/stutymore/redis-mianzhanixi-redis1.jpg"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-06-15T02:06:33.000Z"><meta property="article:author" content="ä¸‰åˆ†æ¶"><meta property="article:tag" content="é¢æ¸£é€†è¢­"><meta property="article:published_time" content="2024-10-31T00:00:00.000Z"><meta property="article:modified_time" content="2025-06-15T02:06:33.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Redisé¢è¯•é¢˜ï¼Œ57é“Rediså…«è‚¡æ–‡ï¼ˆ4.6ä¸‡å­—286å¼ æ‰‹ç»˜å›¾ï¼‰ï¼Œé¢æ¸£é€†è¢­å¿…çœ‹ğŸ‘","image":["https://cdn.tobebetterjavaer.com/stutymore/redis-mianzhanixi-redis1.jpg","https://cdn.tobebetterjavaer.com/stutymore/redis-20250614154255.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250614154416.png","https://cdn.tobebetterjavaer.com/stutymore/collection-20250512160410.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250614154601.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250427143333.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250427152053.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240420093229.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250427152536.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250427152627.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d44c2397-5994-452f-8b7b-eb85d2b87685.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240420100012.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250428152255.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250428163928.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-10434dc7-c7a3-4c1a-b484-de3fb37669ee.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250429112032.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250429112708.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250429113019.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250429113501.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240315120652.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250429120349.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250429121524.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250429132129.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250429134358.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240315115713.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250429155817.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250430112922.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250430132517.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250430143547.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250430150054.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250430145617.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250430145654.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250430151846.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250430152926.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504095007.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250501102228.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250501104352.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250501104549.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240918114125.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-eb541432-d68a-4dd9-b427-96c4dd607d64.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250501113356.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250501113618.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250501113710.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250502100516.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250502100006.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-344b8461-98d4-495b-a697-70275b0abad6.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250503091439.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b7b24e25-d2dc-4457-994f-95bdb3674b8e.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250502095838.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250503100720.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250503095411.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250503101721.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250427143852.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240408100900.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-3bda4a46-adc3-4f0d-a135-b8ae5d4c0d5d.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504101901.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504102121.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-ffe56e32-34c5-453d-8859-c2febbe6a038.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504103113.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504102942.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504104821.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504105937.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-a9fb6202-b1a1-484d-a4fa-fef519090b44.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504113511.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504115144.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504114626.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20241208204853.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250504121938.png","https://cdn.tobebetterjavaer.com/stutymore/redis-è¿˜æ˜¯çœ‹çº¸è´¨ç‰ˆå¿ƒé‡Œè¸å®.jpg","https://cdn.tobebetterjavaer.com/stutymore/redis-20250505092638.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250505094156.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250505095347.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-f9aab5e9-a875-4316-9ec9-0c5650afe5c1.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250505101045.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250506103814.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-19c531e5-da95-495a-a4c4-d63a0b8bba95.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250506105448.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-60497f1e-8afb-44b3-bb7a-d4c29e5ac484.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250507142235.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250507142500.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250507143956.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250507162724.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240709135618.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250508104145.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5d91a67c-dbff-4a8d-bf9d-1fe7602d5a27.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-71074254-699a-480b-bbb0-c68f364a380b.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-dff14203-5e01-4d1b-a775-10ee444ada54.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250508105718.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250508110132.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250508143059.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250508143956.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250508145116.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250508144622.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250508151116.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250509114339.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-aa8d2960-b341-49cc-b04c-201241fd15de.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-87600c72-cc6a-4656-81b2-e71864c97f23.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250509154335.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250509154541.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250510110627.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250510112217.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250510114037.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250510220656.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-8b1a055c-f077-49ff-9432-c194d4fc3639.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250511135906.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-11839a24-9249-48a5-8c9d-888aa80d91dc.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250511141612.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250511141103.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250512171147.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250511142127.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240819112712.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250512174725.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-03976d35-20b6-4efe-aa9c-7d3759460d34.png","https://cdn.tobebetterjavaer.com/stutymore/redis-è¿™ä¸ç”¨é€‰ï¼Œè‚¯å®šæœ‰é™æºç¨‹å•Š.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5cbc6009-251e-4d5b-8f22-8d543938eccb.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240408104101.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250514144353.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250514150007.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250514144913.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e0ed9d62-3406-40db-8b01-c931f1020612.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250514151059.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-8b1fcaec-37e6-420a-9ca2-03615232af17.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-89bd1c1c-251c-4f53-bba3-fe945b2ae9e2.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250515104833.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250515104933.png","https://cdn.tobebetterjavaer.com/stutymore/redis-çœ‹çœ‹ï¼Œæ˜Ÿçƒç¼–å·æ˜¯.jpg","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e6064ba6-fd6f-4270-92f9-68c0bb98fd4b.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250516093632.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250516093948.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-15341792-e7a6-428c-a109-22827e02be5f.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-84a2a89e-f9ea-4681-b748-1a4f1dee172b.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b61a6109-7aea-45ab-a53c-267eebb9180a.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d0e16ea3-6683-43f4-82a3-80478703ae06.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250516100305.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-dd3e9494-eddb-4861-85f7-2646018d93f6.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-1d24bb63-2b05-4db9-bd6b-983f16a4830e.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250517100408.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250517100517.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250517101545.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250518092219.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-cf63911a-8501-493e-a375-8b47a9f33358.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250518093130.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250519082725.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250519085312.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-288af5a2-ae5a-427a-95e9-b4a658b01386.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250520092547.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-1464fe22-c463-4850-8989-b899510cb10e.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240326220634.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240421105333.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250520094922.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d0b8d85c-85dc-4843-b4be-d5d48338a44e.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20241019191741.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20241019192648.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250521151850.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240325221330.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250522100735.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-ebad0a67-3012-4466-a4dc-e834104c48f8.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250522102052.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5c929a9e-a723-43b3-8f3c-f22c83765f9d.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250522102954.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240325225250.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e4a61193-515a-409f-a436-2733abc3a86e.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-37c07418-9cd8-43d9-90e7-0cb43b329025.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-fab24753-9c53-4432-9413-5feba07ae1e3.png","https://cdn.tobebetterjavaer.com/stutymore/redis-æ„Ÿè°¢äºŒå“¥çš„æŒ‡æ­£ï¼Œæ¯ä¸€å¥éƒ½æ„Ÿè§‰æ¯”æˆ‘çš„å¥½å¾ˆå¤šï¼Œæ”¹å®Œä¹‹åç®€å†è´¨é‡é ­é—´æ¶¨äº†ä¸å°‘ï¼Œå¤ªæ„Ÿè°¢äº†.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-6d4ab7e6-8337-4576-bbf0-79202a1c3331.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-20c15f0d-fb3c-4922-94b1-edcd856658be.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250524105015.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250524110756.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-6fa972ec-5531-48f2-a608-4465d79d4518.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250524111114.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240309090340.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e4aaafda-fce1-47f0-8b2b-7261d47b720b.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250524112308.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250525071018.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250525074224.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250525075244.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240326214119.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250527111551.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240326214800.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240326215240.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250527115004.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250527120727.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e4b192a1-3ba7-4f4e-98de-e93f437cff7c.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-bc6d05be-3701-4e23-b4ca-6330c949f020.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-54bbcc36-0b00-4142-a6eb-bf2ef48c2213.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250528203451.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529063154.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240314101439.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529063910.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529065426.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529065131.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529082025.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529082120.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529082216.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529082551.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529085332.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529085959.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250529090547.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250530151227.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250601080336.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-38aee4c1-efd2-495e-8a6d-164d21a129b1.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250601092704.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250601094500.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250601082813.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-710cdd19-98ea-4e96-b579-ff1ebb0d5de9.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20241122191044.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20241122192038.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250602113225.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240918110433.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250603092903.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240816113330.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250602112537.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250603100457.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-a1b2d2f9-6895-4749-9bda-9314f08bca68.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-7c038f2c-b5ee-4229-9449-713fab3b1855.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-9934b4a2-c253-4d42-acf4-c6c940840779.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250604112041.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250604112357.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250604113025.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-886ee2a8-fb02-4908-bbba-d4ad2a211094.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250604113520.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250604114217.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250604114432.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-1adef9c0-8feb-4836-8997-84bda96e2498.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-833dbfb2-7c79-4e7b-a143-8a4a2936cdd8.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250605132505.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250605134114.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250605135850.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250607094736.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240403105313.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240403105754.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250607100252.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250605142339.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-2541fd26-4e84-467d-8d8c-c731154a85d7.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-fc26a4e7-1c8d-4e82-b7f8-1f6b43d16d38.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e08347a6-efd5-47c0-9adb-23baff82dbbd.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250606105102.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250606105352.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250606111301.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250608111336.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-08391728-5ba8-42a0-a287-9284451e0ee7.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250607102238.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250607103728.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250607104019.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250607110105.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250607103155.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250608115835.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250608112525.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250608113417.png","https://cdn.tobebetterjavaer.com/stutymore/redis-äºŒå“¥ï¼Œæˆ‘æ„Ÿè§‰ä½ è¿™äº›çŸ¥è¯†ç‚¹å†™çš„çœŸä¸é”™ï¼Œâ‘¤ä¹‹å‰.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-6be492f7-9f92-4607-a4c4-81a612a3d7bd.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20241225105623.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250609093621.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250609093736.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b5d224c2-53ee-40a3-9efc-2feb7dd3d7a8.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250604112846.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250609094439.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250609094615.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250609100519.png","https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-3b9785b0-6573-4c2d-8b7d-d5d1be799e26.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250610105328.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250610110115.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250610112125.png","https://cdn.tobebetterjavaer.com/stutymore/redis-äºŒå“¥ï¼Œæˆ‘æ˜¯ä¹‹å‰å‘é‚®ä»¶è¯·æ‚¨ä¿®æ”¹ç®€.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250612102525.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240420102552.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250612103728.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250612104416.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250612104916.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250612152123.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250613104134.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240420104633.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240420104921.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20240420114025.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250613110150.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250614112846.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250614114251.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250614160051.png","https://cdn.tobebetterjavaer.com/stutymore/mysql-20250427104555.png","https://cdn.tobebetterjavaer.com/stutymore/mysql-æˆ‘æŠŠä½ æ¨èç»™æˆ‘ä»¬å®éªŒå®¤çš„åŸºæœ¬æ‰€æœ‰äººäº†.png","https://cdn.tobebetterjavaer.com/stutymore/mysql-20250427104304.png","https://cdn.tobebetterjavaer.com/stutymore/mysql-20250427104416.png","https://cdn.tobebetterjavaer.com/stutymore/collection-20250512160410.png","https://cdn.tobebetterjavaer.com/stutymore/redis-20250614154745.png"],"datePublished":"2024-10-31T00:00:00.000Z","dateModified":"2025-06-15T02:06:33.000Z","author":[{"@type":"Person","name":"ä¸‰åˆ†æ¶"}]}</script><meta name="robots" content="all"><meta name="author" content="æ²‰é»˜ç‹äºŒ"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta name="apple-mobile-web-app-capable" content="yes"><script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?5230ac143650bf5eb3c14f3fb9b1d3ec";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
      </script><script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?59aa453e7e706422c636c079fc1cb031";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
      </script><link rel="stylesheet" href="//at.alicdn.com/t/font_3180624_7cy10l7jqqh.css"><link rel="icon" href="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><title>Redisé¢è¯•é¢˜ï¼Œ57é“Rediså…«è‚¡æ–‡ï¼ˆ4.6ä¸‡å­—286å¼ æ‰‹ç»˜å›¾ï¼‰ï¼Œé¢æ¸£é€†è¢­å¿…çœ‹ğŸ‘ | äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯</title><meta name="description" content="ä¸‹è½½æ¬¡æ•°è¶… 1 ä¸‡æ¬¡ï¼Œ4.6 ä¸‡å­— 286 å¼ æ‰‹ç»˜å›¾ï¼Œè¯¦è§£ 57 é“ Redis é¢è¯•é«˜é¢‘é¢˜ï¼ˆè®©å¤©ä¸‹æ²¡æœ‰éš¾èƒŒçš„å…«è‚¡ï¼‰ï¼Œé¢æ¸£èƒŒä¼šè¿™äº› Redis å…«è‚¡æ–‡ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚">
    <link rel="preload" href="/assets/style-Dlp_gcQZ.css" as="style"><link rel="stylesheet" href="/assets/style-Dlp_gcQZ.css">
    <link rel="modulepreload" href="/assets/app-DlNMEcLQ.js"><link rel="modulepreload" href="/assets/redis.html-BSsD7Gvg.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/logo-02.png" alt><!----><span class="vp-site-name hide-in-pad">äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog.html" aria-label="åšå®¢"><!--[--><span class="font-icon icon iconfont icon-gaishu" style=""></span><!--]-->åšå®¢<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/home.html" aria-label="è¿›é˜¶ä¹‹è·¯"><!--[--><span class="font-icon icon iconfont icon-lujing" style=""></span><!--]-->è¿›é˜¶ä¹‹è·¯<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/zhishixingqiu/" aria-label="çŸ¥è¯†æ˜Ÿçƒ"><!--[--><span class="font-icon icon iconfont icon-Artboard" style=""></span><!--]-->çŸ¥è¯†æ˜Ÿçƒ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/xuexiluxian/" aria-label="å­¦ä¹ è·¯çº¿"><!--[--><span class="font-icon icon iconfont icon-luxian" style=""></span><!--]-->å­¦ä¹ è·¯çº¿<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/sidebar/sanfene/nixi.html" aria-label="é¢æ¸£é€†è¢­"><!--[--><span class="font-icon icon iconfont icon-zhunbei" style=""></span><!--]-->é¢æ¸£é€†è¢­<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="çè—èµ„æº"><!--[--><span class="font-icon icon iconfont icon-youzhi" style=""></span>çè—èµ„æº<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/pdf/" aria-label="PDFä¸‹è½½"><!--[--><span class="font-icon icon iconfont icon-java" style=""></span><!--]-->PDFä¸‹è½½<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/nice-article/itmind/" aria-label="ç ´è§£åˆé›†"><!--[--><span class="font-icon icon iconfont icon-zhongyaotishi" style=""></span><!--]-->ç ´è§£åˆé›†<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/sidebar/sjtu/" aria-label="ä¸Šäº¤å¤§ç”Ÿå­˜æ‰‹å†Œ"><!---->ä¸Šäº¤å¤§ç”Ÿå­˜æ‰‹å†Œ<!----></a></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/itwanger/toBeBetterJavaer" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢æ–‡æ¡£"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢æ–‡æ¡£</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/nixi.html" aria-label="é¢æ¸£é€†è¢­"><!---->é¢æ¸£é€†è¢­<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/mysql.html" aria-label="é¢æ¸£é€†è¢­-MySQL"><!---->é¢æ¸£é€†è¢­-MySQL<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/sidebar/sanfene/redis.html" aria-label="é¢æ¸£é€†è¢­-Redis"><!---->é¢æ¸£é€†è¢­-Redis<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/spring.html" aria-label="é¢æ¸£é€†è¢­-Spring"><!---->é¢æ¸£é€†è¢­-Spring<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/javase.html" aria-label="é¢æ¸£é€†è¢­-Java SE"><!---->é¢æ¸£é€†è¢­-Java SE<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/collection.html" aria-label="é¢æ¸£é€†è¢­-Javaé›†åˆæ¡†æ¶"><!---->é¢æ¸£é€†è¢­-Javaé›†åˆæ¡†æ¶<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/javathread.html" aria-label="é¢æ¸£é€†è¢­-Javaå¹¶å‘ç¼–ç¨‹"><!---->é¢æ¸£é€†è¢­-Javaå¹¶å‘ç¼–ç¨‹<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/jvm.html" aria-label="é¢æ¸£é€†è¢­-JVM"><!---->é¢æ¸£é€†è¢­-JVM<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/mybatis.html" aria-label="é¢æ¸£é€†è¢­-MyBatis"><!---->é¢æ¸£é€†è¢­-MyBatis<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/os.html" aria-label="é¢æ¸£é€†è¢­-æ“ä½œç³»ç»Ÿ"><!---->é¢æ¸£é€†è¢­-æ“ä½œç³»ç»Ÿ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/network.html" aria-label="é¢æ¸£é€†è¢­-è®¡ç®—æœºç½‘ç»œ"><!---->é¢æ¸£é€†è¢­-è®¡ç®—æœºç½‘ç»œ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/rocketmq.html" aria-label="é¢æ¸£é€†è¢­-RocketMQ"><!---->é¢æ¸£é€†è¢­-RocketMQ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/fenbushi.html" aria-label="é¢æ¸£é€†è¢­-åˆ†å¸ƒå¼"><!---->é¢æ¸£é€†è¢­-åˆ†å¸ƒå¼<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/weifuwu.html" aria-label="é¢æ¸£é€†è¢­-å¾®æœåŠ¡"><!---->é¢æ¸£é€†è¢­-å¾®æœåŠ¡<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/shejimoshi.html" aria-label="é¢æ¸£é€†è¢­-è®¾è®¡æ¨¡å¼"><!---->é¢æ¸£é€†è¢­-è®¾è®¡æ¨¡å¼<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/sidebar/sanfene/linux.html" aria-label="é¢æ¸£é€†è¢­-Linux"><!---->é¢æ¸£é€†è¢­-Linux<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Redisé¢è¯•é¢˜ï¼Œ57é“Rediså…«è‚¡æ–‡ï¼ˆ4.6ä¸‡å­—286å¼ æ‰‹ç»˜å›¾ï¼‰ï¼Œé¢æ¸£é€†è¢­å¿…çœ‹ğŸ‘</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">ä¸‰åˆ†æ¶</span></span><span property="author" content="ä¸‰åˆ†æ¶"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-10-31T00:00:00.000Z"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color3 clickable" role="navigation">é¢æ¸£é€†è¢­</span><!--]--><meta property="articleSection" content="é¢æ¸£é€†è¢­"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color3 clickable" role="navigation">é¢æ¸£é€†è¢­</span><!--]--><meta property="keywords" content="é¢æ¸£é€†è¢­"></span><span class="page-word-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon" name="word"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 56499 å­—</span><meta property="wordCount" content="56499"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 188 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT188M"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å‰è¨€">å‰è¨€</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#åŸºç¡€">åŸºç¡€</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1-ğŸŒŸè¯´è¯´ä»€ä¹ˆæ˜¯-redis">1.ğŸŒŸè¯´è¯´ä»€ä¹ˆæ˜¯ Redis?</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-redis-å¯ä»¥ç”¨æ¥å¹²ä»€ä¹ˆ">2.Redis å¯ä»¥ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-ğŸŒŸredisæœ‰å“ªäº›æ•°æ®ç±»å‹">3.ğŸŒŸRedisæœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-ğŸŒŸredis-ä¸ºä»€ä¹ˆå¿«å‘¢">4.ğŸŒŸRedis ä¸ºä»€ä¹ˆå¿«å‘¢ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-èƒ½è¯¦ç»†è¯´ä¸€ä¸‹ioå¤šè·¯å¤ç”¨å—">5.èƒ½è¯¦ç»†è¯´ä¸€ä¸‹IOå¤šè·¯å¤ç”¨å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_6-redisä¸ºä»€ä¹ˆæ—©æœŸé€‰æ‹©å•çº¿ç¨‹">6.Redisä¸ºä»€ä¹ˆæ—©æœŸé€‰æ‹©å•çº¿ç¨‹ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-redis-6-0-ä½¿ç”¨å¤šçº¿ç¨‹æ˜¯æ€ä¹ˆå›äº‹">7.Redis 6.0 ä½¿ç”¨å¤šçº¿ç¨‹æ˜¯æ€ä¹ˆå›äº‹?</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-è¯´è¯´-redis-çš„å¸¸ç”¨å‘½ä»¤-è¡¥å……">8.è¯´è¯´ Redis çš„å¸¸ç”¨å‘½ä»¤ï¼ˆè¡¥å……ï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_9-å•çº¿ç¨‹çš„redis-qps-èƒ½åˆ°å¤šå°‘-è¡¥å……">9.å•çº¿ç¨‹çš„Redis QPS èƒ½åˆ°å¤šå°‘ï¼Ÿ(è¡¥å……)</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æŒä¹…åŒ–">æŒä¹…åŒ–</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_10-ğŸŒŸredisçš„æŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›">10.ğŸŒŸRedisçš„æŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_11-rdb-å’Œ-aof-å„è‡ªæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹">11.RDB å’Œ AOF å„è‡ªæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_12-rdb-å’Œ-aof-å¦‚ä½•é€‰æ‹©">12.RDB å’Œ AOF å¦‚ä½•é€‰æ‹©ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_13-rediså¦‚ä½•æ¢å¤æ•°æ®">13.Rediså¦‚ä½•æ¢å¤æ•°æ®ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_14-ğŸŒŸredis-4-0-çš„æ··åˆæŒä¹…åŒ–äº†è§£å—">14.ğŸŒŸRedis 4.0 çš„æ··åˆæŒä¹…åŒ–äº†è§£å—ï¼Ÿ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#é«˜å¯ç”¨">é«˜å¯ç”¨</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_15-ä¸»ä»å¤åˆ¶äº†è§£å—">15.ä¸»ä»å¤åˆ¶äº†è§£å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_16-redisä¸»ä»æœ‰å‡ ç§å¸¸è§çš„æ‹“æ‰‘ç»“æ„">16.Redisä¸»ä»æœ‰å‡ ç§å¸¸è§çš„æ‹“æ‰‘ç»“æ„ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_17-redisçš„ä¸»ä»å¤åˆ¶åŸç†äº†è§£å—">17.Redisçš„ä¸»ä»å¤åˆ¶åŸç†äº†è§£å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_18-è¯¦ç»†è¯´è¯´å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥">18.è¯¦ç»†è¯´è¯´å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_19-ä¸»ä»å¤åˆ¶å­˜åœ¨å“ªäº›é—®é¢˜å‘¢">19.ä¸»ä»å¤åˆ¶å­˜åœ¨å“ªäº›é—®é¢˜å‘¢ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_20-rediså“¨å…µæœºåˆ¶äº†è§£å—">20.Rediså“¨å…µæœºåˆ¶äº†è§£å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_21-rediså“¨å…µçš„å·¥ä½œåŸç†çŸ¥é“å—">21.Rediså“¨å…µçš„å·¥ä½œåŸç†çŸ¥é“å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_22-redisé¢†å¯¼è€…é€‰ä¸¾äº†è§£å—">22.Redisé¢†å¯¼è€…é€‰ä¸¾äº†è§£å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_23-æ–°çš„ä¸»èŠ‚ç‚¹æ˜¯æ€æ ·è¢«æŒ‘é€‰å‡ºæ¥çš„">23.æ–°çš„ä¸»èŠ‚ç‚¹æ˜¯æ€æ ·è¢«æŒ‘é€‰å‡ºæ¥çš„ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_24-redisé›†ç¾¤äº†è§£å—">24.Redisé›†ç¾¤äº†è§£å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_25-è¯·è¯¦ç»†è¯´ä¸€è¯´redis-cluster-è¡¥å……">25.è¯·è¯¦ç»†è¯´ä¸€è¯´Redis Clusterï¼Ÿï¼ˆè¡¥å……ï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_26-é›†ç¾¤ä¸­æ•°æ®å¦‚ä½•åˆ†åŒº">26.é›†ç¾¤ä¸­æ•°æ®å¦‚ä½•åˆ†åŒºï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_27-èƒ½è¯´è¯´-redis-é›†ç¾¤çš„åŸç†å—">27.èƒ½è¯´è¯´ Redis é›†ç¾¤çš„åŸç†å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_28-è¯´è¯´redisé›†ç¾¤çš„åŠ¨æ€ä¼¸ç¼©">28.è¯´è¯´Redisé›†ç¾¤çš„åŠ¨æ€ä¼¸ç¼©ï¼Ÿ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç¼“å­˜è®¾è®¡">ç¼“å­˜è®¾è®¡</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_29-ğŸŒŸä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿">29.ğŸŒŸä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_30-ğŸŒŸèƒ½è¯´è¯´å¸ƒéš†è¿‡æ»¤å™¨å—">30.ğŸŒŸèƒ½è¯´è¯´å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_31-ğŸŒŸå¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§">31.ğŸŒŸå¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®â¼€è‡´æ€§ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_32-å¦‚ä½•ä¿è¯æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜çš„ä¸€è‡´">32.å¦‚ä½•ä¿è¯æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜çš„ä¸€è‡´ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_33-ä»€ä¹ˆæ˜¯çƒ­key">33.ä»€ä¹ˆæ˜¯çƒ­Keyï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_34-é‚£æ€ä¹ˆå¤„ç†çƒ­key-å‘¢">34.é‚£æ€ä¹ˆå¤„ç†çƒ­Key å‘¢ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_35-æ€ä¹ˆå¤„ç†å¤§-key-å‘¢">35.æ€ä¹ˆå¤„ç†å¤§ Key å‘¢ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_36-ç¼“å­˜é¢„çƒ­æ€ä¹ˆåšå‘¢">36.ç¼“å­˜é¢„çƒ­æ€ä¹ˆåšå‘¢ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_37-æ— åº•æ´é—®é¢˜å¬è¯´è¿‡å—-å¦‚ä½•è§£å†³">37.æ— åº•æ´é—®é¢˜å¬è¯´è¿‡å—ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#redis-è¿ç»´">Redis è¿ç»´</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_38-redis-æŠ¥å†…å­˜ä¸è¶³æ€ä¹ˆå¤„ç†">38.Redis æŠ¥å†…å­˜ä¸è¶³æ€ä¹ˆå¤„ç†ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_39-redis-keyè¿‡æœŸç­–ç•¥æœ‰å“ªäº›">39.Redis keyè¿‡æœŸç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_40-ğŸŒŸredisæœ‰å“ªäº›å†…å­˜æ·˜æ±°ç­–ç•¥">40.ğŸŒŸRedisæœ‰å“ªäº›å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_41-lru-å’Œ-lfu-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ">41.LRU å’Œ LFU çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_42-rediså‘ç”Ÿé˜»å¡äº†æ€ä¹ˆè§£å†³">42.Rediså‘ç”Ÿé˜»å¡äº†æ€ä¹ˆè§£å†³ï¼Ÿ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#redis-åº”ç”¨">Redis åº”ç”¨</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_43-rediså¦‚ä½•å®ç°å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—">43.Rediså¦‚ä½•å®ç°å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_44-rediså¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—">44.Rediså¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—?</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_45-ğŸŒŸredisæ”¯æŒäº‹åŠ¡å—">45.ğŸŒŸRedisæ”¯æŒäº‹åŠ¡å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_46-æœ‰luaè„šæœ¬æ“ä½œredisçš„ç»éªŒå—">46.æœ‰Luaè„šæœ¬æ“ä½œRedisçš„ç»éªŒå—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_47-redisçš„ç®¡é“pipelineäº†è§£å—">47.Redisçš„ç®¡é“Pipelineäº†è§£å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_48-ğŸŒŸredisèƒ½å®ç°åˆ†å¸ƒå¼é”å—">48.ğŸŒŸRedisèƒ½å®ç°åˆ†å¸ƒå¼é”å—ï¼Ÿ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#åº•å±‚ç»“æ„">åº•å±‚ç»“æ„</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_49-ğŸŒŸrediséƒ½æœ‰å“ªäº›åº•å±‚æ•°æ®ç»“æ„">49.ğŸŒŸRediséƒ½æœ‰å“ªäº›åº•å±‚æ•°æ®ç»“æ„ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_50-redis-ä¸ºä»€ä¹ˆä¸ç”¨-c-è¯­è¨€çš„åŸç”Ÿå­—ç¬¦ä¸²">50.Redis ä¸ºä»€ä¹ˆä¸ç”¨ C è¯­è¨€çš„åŸç”Ÿå­—ç¬¦ä¸²ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_51-ä½ ç ”ç©¶è¿‡-redis-çš„å­—å…¸æºç å—">51.ä½ ç ”ç©¶è¿‡ Redis çš„å­—å…¸æºç å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_52-ğŸŒŸä½ äº†è§£è·³è¡¨å—">52.ğŸŒŸä½ äº†è§£è·³è¡¨å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_53-å‹ç¼©åˆ—è¡¨äº†è§£å—">53.å‹ç¼©åˆ—è¡¨äº†è§£å—ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_54-quicklist-äº†è§£å—">54.quicklist äº†è§£å—ï¼Ÿ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#è¡¥å……">è¡¥å……</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_55-å‡å¦‚-redis-é‡Œé¢æœ‰-1-äº¿ä¸ª-key-å…¶ä¸­æœ‰-10w-ä¸ª-key-æ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥çš„å‰ç¼€å¼€å¤´çš„-å¦‚ä½•å°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥">55.å‡å¦‚ Redis é‡Œé¢æœ‰ 1 äº¿ä¸ª keyï¼Œå…¶ä¸­æœ‰ 10w ä¸ª key æ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥çš„å‰ç¼€å¼€å¤´çš„ï¼Œå¦‚ä½•å°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_56-redisåœ¨ç§’æ€åœºæ™¯ä¸‹å¯ä»¥æ‰®æ¼”ä»€ä¹ˆè§’è‰²">56.Redisåœ¨ç§’æ€åœºæ™¯ä¸‹å¯ä»¥æ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_57-å®¢æˆ·ç«¯å®•æœºå-redis-æœåŠ¡ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°">57.å®¢æˆ·ç«¯å®•æœºå Redis æœåŠ¡ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°ï¼Ÿ</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-mianzhanixi-redis1.jpg" alt="é¢æ¸£é€†è¢­Redisç¯‡å°é¢å›¾" tabindex="0" loading="lazy"><figcaption>é¢æ¸£é€†è¢­Redisç¯‡å°é¢å›¾</figcaption></figure><h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€"><span>å‰è¨€</span></a></h2><p>4.6 ä¸‡å­— 286 å¼ æ‰‹ç»˜å›¾ï¼Œè¯¦è§£ 57 é“ Redis é¢è¯•é«˜é¢‘é¢˜ï¼ˆè®©å¤©ä¸‹æ²¡æœ‰éš¾èƒŒçš„å…«è‚¡ï¼‰ï¼Œé¢æ¸£èƒŒä¼šè¿™äº› Redis å…«è‚¡æ–‡ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚æ•´ç†ï¼šæ²‰é»˜ç‹äºŒï¼Œæˆ³<a href="https://mp.weixin.qq.com/s/19u34NXALB1nOlBCE6Eg-Q" target="_blank" rel="noopener noreferrer">è½¬è½½é“¾æ¥</a>ï¼Œä½œè€…ï¼šä¸‰åˆ†æ¶ï¼Œæˆ³<a href="https://mp.weixin.qq.com/s/iJtNJYgirRugNBnzxkbB4Q" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a>ã€‚</p><p>äº®ç™½ç‰ˆæœ¬æ›´é€‚åˆæ‹¿å‡ºæ¥æ‰“å°ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¤šå­¦ç”Ÿå…šå–œæ¬¢çš„æ–¹å¼ï¼Œæ‰“å°å‡ºæ¥èƒŒè¯µçš„æ•ˆç‡ä¼šæ›´é«˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250614154255.png" alt="é¢æ¸£é€†è¢­Redisç¯‡.pdfç¬¬äºŒç‰ˆ" tabindex="0" loading="lazy"><figcaption>é¢æ¸£é€†è¢­Redisç¯‡.pdfç¬¬äºŒç‰ˆ</figcaption></figure><p>2025 å¹´ 04 æœˆ 27 æ—¥å¼€å§‹ç€æ‰‹ç¬¬äºŒç‰ˆæ›´æ–°ã€‚</p><ul><li>å¯¹äºé«˜é¢‘é¢˜ï¼Œä¼šæ ‡æ³¨åœ¨ã€Š<a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>ã€‹ä¸­å‡ºç°çš„ä½ç½®ï¼Œå“ªå®¶å…¬å¸ï¼ŒåŸé¢˜æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”ä¼šåŠ ğŸŒŸï¼Œç›®å½•ä¸€ç›®äº†ç„¶ï¼›å¦‚æœä½ æƒ³èŠ‚çœæ—¶é—´çš„è¯ï¼Œå¯ä»¥ä¼˜å…ˆèƒŒè¯µè¿™äº›é¢˜ç›®ï¼Œå°½å¿«åšåˆ°çŸ¥å½¼çŸ¥å·±ï¼Œç™¾æˆ˜ä¸æ®†ã€‚</li><li>åŒºåˆ†å…«è‚¡ç²¾åå›ç­”ç‰ˆæœ¬å’ŒåŸç†åº•å±‚è§£é‡Šï¼Œè®©å¤§å®¶çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼ŒåŒæ—¶åˆèƒ½åšåˆ°é¢è¯•æ—¶çš„é«˜æ•ˆå›ç­”ã€‚</li><li>ç»“åˆé¡¹ç›®ï¼ˆ<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" target="_blank" rel="noopener noreferrer">æŠ€æœ¯æ´¾</a>ã€<a href="https://javabetter.cn/zhishixingqiu/pmhub.html" target="_blank" rel="noopener noreferrer">pmhub</a>ï¼‰æ¥ç»„ç»‡è¯­è¨€ï¼Œè®©é¢è¯•å®˜æœ€å¤§ç¨‹åº¦æ„Ÿå—åˆ°ä½ çš„è¯šæ„ï¼Œè€Œä¸æ˜¯æœºæ¢°åŒ–çš„èƒŒè¯µã€‚</li><li>ä¿®å¤ç¬¬ä¸€ç‰ˆä¸­å‡ºç°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬çƒå‹ä»¬çš„ç§ä¿¡åé¦ˆï¼Œç½‘ç«™ç•™è¨€åŒºçš„è¯„è®ºï¼Œä»¥åŠ <a href="https://github.com/itwanger/toBeBetterJavaer/issues" target="_blank" rel="noopener noreferrer">GitHub ä»“åº“</a>ä¸­çš„ issueï¼Œè®©è¿™ä»½é¢è¯•æŒ‡å—æ›´åŠ å®Œå–„ã€‚</li><li>å¢åŠ <a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">äºŒå“¥ç¼–ç¨‹æ˜Ÿçƒ</a>çš„çƒå‹ä»¬æ‹¿åˆ°çš„ä¸€äº› offerï¼Œå¯¹é¢æ¸£é€†è¢­çš„æ„Ÿè°¢ï¼Œä»¥åŠå¯¹ç®€å†ä¿®æ”¹çš„ä¸€äº›è®¤å¯ï¼Œä»¥æ­¤æ¥æ¿€åŠ±å¤§å®¶ï¼Œç»™å¤§å®¶æ›´å¤šä¿¡å¿ƒã€‚</li><li>ä¼˜åŒ–æ’ç‰ˆï¼Œå¢åŠ æ‰‹ç»˜å›¾ï¼Œé‡æ–°ç»„ç»‡ç­”æ¡ˆï¼Œä½¿å…¶æ›´åŠ å£è¯­åŒ–ï¼Œä»è€Œæ›´è´´è¿‘é¢è¯•å®˜çš„é¢„æœŸã€‚</li></ul><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250614154416.png" alt="é¢æ¸£é€†è¢­å·²ç»æäº¤ 1478 æ¬¡ GitHub è®°å½•" tabindex="0" loading="lazy"><figcaption>é¢æ¸£é€†è¢­å·²ç»æäº¤ 1478 æ¬¡ GitHub è®°å½•</figcaption></figure><p>ç”±äº PDF æ²¡åŠæ³•è‡ªæˆ‘æ›´æ–°ï¼Œæ‰€ä»¥éœ€è¦æœ€æ–°ç‰ˆçš„å°ä¼™ä¼´ï¼Œå¯ä»¥å¾®ä¿¡æœã€<strong>æ²‰é»˜ç‹äºŒ</strong>ã€‘ï¼Œæˆ–è€…æ‰«æ/é•¿æŒ‰è¯†åˆ«ä¸‹é¢çš„äºŒç»´ç ï¼Œå…³æ³¨äºŒå“¥çš„å…¬ä¼—å·ï¼Œå›å¤ã€<strong>222</strong>ã€‘å³å¯æ‹‰å–æœ€æ–°ç‰ˆæœ¬ã€‚</p><div style="text-align:center;margin:20px 0;"><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width:100%;height:auto;border-radius:10px;"></div><p>å½“ç„¶äº†ï¼Œè¯·å…è®¸æˆ‘çš„ä¸€ç‚¹ç‚¹ç§å¿ƒï¼Œé‚£å°±æ˜¯æ˜Ÿçƒçš„ PDF ç‰ˆæœ¬ä¼šæ¯”å…¬ä¼—å·æ—©ä¸€ä¸ªæœˆæ—¶é—´ï¼Œæ¯•ç«Ÿæ˜Ÿçƒç”¨æˆ·éƒ½ä»˜è´¹è¿‡äº†ï¼Œæˆ‘æœ‰å¿…è¦è®©ä»–ä»¬å…ˆäº«å—åˆ°ä¸€ç‚¹ç‚¹ç¦åˆ©ã€‚ç›¸ä¿¡å¤§å®¶ä¹Ÿéƒ½èƒ½ç†è§£ï¼Œæ¯•ç«Ÿåœ¨çº¿ç‰ˆæ˜¯å…è´¹çš„ï¼ŒCDNã€æœåŠ¡å™¨ã€åŸŸåã€OSS ç­‰ç­‰éƒ½æ˜¯éœ€è¦æˆæœ¬çš„ã€‚</p><p>æ›´åˆ«è¯´æˆ‘ä»˜å‡ºçš„æ—¶é—´å’Œç²¾åŠ›äº†ï¼Œå¤§å®¶è§‰å¾—æœ‰å¸®åŠ©è¿˜è¯·ç»™ä¸ªå£ç¢‘ï¼Œè®©ä½ èº«è¾¹çš„åŒäº‹ã€åŒå­¦éƒ½èƒ½å—ç›Šåˆ°ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/collection-20250512160410.png" alt="å›å¤ 222" tabindex="0" loading="lazy"><figcaption>å›å¤ 222</figcaption></figure><p>æˆ‘æŠŠäºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ã€JVM è¿›é˜¶ä¹‹è·¯ã€å¹¶å‘ç¼–ç¨‹è¿›é˜¶ä¹‹è·¯ï¼Œä»¥åŠæ‰€æœ‰é¢æ¸£é€†è¢­çš„ç‰ˆæœ¬éƒ½æ”¾è¿›æ¥äº†ï¼Œæ¶µç›– JavaåŸºç¡€ã€Javaé›†åˆã€Javaå¹¶å‘ã€JVMã€Springã€MyBatisã€è®¡ç®—æœºç½‘ç»œã€æ“ä½œç³»ç»Ÿã€MySQLã€Redisã€RocketMQã€åˆ†å¸ƒå¼ã€å¾®æœåŠ¡ã€è®¾è®¡æ¨¡å¼ã€Linux ç­‰ 16 ä¸ªå¤§çš„ä¸»é¢˜ï¼Œå…±æœ‰ 40 å¤šä¸‡å­—ï¼Œ2000+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯è¯šæ„æ»¡æ»¡ã€‚</p><p>å±•ç¤ºä¸€ä¸‹æš—é»‘ç‰ˆæœ¬çš„ PDF å§ï¼Œæ’ç‰ˆæ¸…æ™°ï¼Œå­—ä½“ä¼˜é›…ï¼Œæ›´åŠ é€‚åˆå¤œæœï¼Œæ™šä¸Šçœ‹ä¼šæ›´èˆ’æœä¸€ç‚¹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250614154601.png" alt="é¢æ¸£é€†è¢­Redisç¯‡.pdfæš—é»‘ç‰ˆ" tabindex="0" loading="lazy"><figcaption>é¢æ¸£é€†è¢­Redisç¯‡.pdfæš—é»‘ç‰ˆ</figcaption></figure><h2 id="åŸºç¡€" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€"><span>åŸºç¡€</span></a></h2><h3 id="_1-ğŸŒŸè¯´è¯´ä»€ä¹ˆæ˜¯-redis" tabindex="-1"><a class="header-anchor" href="#_1-ğŸŒŸè¯´è¯´ä»€ä¹ˆæ˜¯-redis"><span>1.ğŸŒŸè¯´è¯´ä»€ä¹ˆæ˜¯ Redis?</span></a></h3><p><a href="https://javabetter.cn/redis/rumen.html" target="_blank" rel="noopener noreferrer">Redis</a> æ˜¯ä¸€ç§åŸºäºé”®å€¼å¯¹çš„ NoSQL æ•°æ®åº“ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250427143333.png" alt="äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼šmacOS å¯åŠ¨ Redis" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼šmacOS å¯åŠ¨ Redis</figcaption></figure><p>å®ƒä¸»è¦çš„ç‰¹ç‚¹æ˜¯æŠŠæ•°æ®æ”¾åœ¨å†…å­˜å½“ä¸­ï¼Œç›¸æ¯”ç›´æ¥è®¿é—®ç£ç›˜çš„å…³ç³»å‹æ•°æ®åº“ï¼Œè¯»å†™é€Ÿåº¦ä¼šå¿«å¾ˆå¤šï¼ŒåŸºæœ¬ä¸Šèƒ½è¾¾åˆ°å¾®ç§’çº§çš„å“åº”ã€‚</p><p>æ‰€ä»¥åœ¨ä¸€äº›å¯¹æ€§èƒ½è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚ç¼“å­˜çƒ­ç‚¹æ•°æ®ã€é˜²æ­¢æ¥å£çˆ†åˆ·ï¼Œéƒ½ä¼šç”¨åˆ° Redisã€‚</p><p>ä¸ä»…å¦‚æ­¤ï¼ŒRedis è¿˜æ”¯æŒæŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®å¼‚æ­¥è½ç›˜ï¼Œä»¥ä¾¿æœåŠ¡å®•æœºé‡å¯åèƒ½æ¢å¤æ•°æ®ã€‚</p><h4 id="redis-å’Œ-mysql-çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#redis-å’Œ-mysql-çš„åŒºåˆ«"><span>Redis å’Œ MySQL çš„åŒºåˆ«ï¼Ÿ</span></a></h4><p>Redis å±äºéå…³ç³»å‹æ•°æ®åº“ï¼Œæ•°æ®æ˜¯é€šè¿‡é”®å€¼å¯¹çš„å½¢å¼æ”¾åœ¨å†…å­˜å½“ä¸­çš„ï¼›MySQL å±äºå…³ç³»å‹æ•°æ®åº“ï¼Œæ•°æ®ä»¥è¡Œå’Œåˆ—çš„å½¢å¼å­˜å‚¨åœ¨ç£ç›˜å½“ä¸­ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250427152053.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis ä½œä¸º MySQL çš„ç¼“å­˜" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis ä½œä¸º MySQL çš„ç¼“å­˜</figcaption></figure><p>å®é™…å¼€å‘ä¸­ï¼Œä¼šå°† MySQL ä½œä¸ºä¸»å­˜å‚¨ï¼ŒRedis ä½œä¸ºç¼“å­˜ï¼Œé€šè¿‡å…ˆæŸ¥ Redisï¼Œæœªå‘½ä¸­å†æŸ¥ MySQL å¹¶å†™å›Redis çš„æ–¹å¼æ¥æé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚</p><h4 id="é¡¹ç›®é‡Œå“ªé‡Œç”¨åˆ°äº†-redis" tabindex="-1"><a class="header-anchor" href="#é¡¹ç›®é‡Œå“ªé‡Œç”¨åˆ°äº†-redis"><span>é¡¹ç›®é‡Œå“ªé‡Œç”¨åˆ°äº† Redisï¼Ÿ</span></a></h4><p>åœ¨<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" target="_blank" rel="noopener noreferrer">æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®</a>å½“ä¸­ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹éƒ½ç”¨åˆ°äº† Redisï¼Œæ¯”å¦‚è¯´ç”¨æˆ·æ´»è·ƒæ’è¡Œæ¦œç”¨åˆ°äº† zsetï¼Œä½œè€…ç™½åå•ç”¨åˆ°äº† setã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240420093229.png" alt="æŠ€æœ¯æ´¾ä¸“æ ï¼šç”¨æˆ·æ´»è¶Šæ’è¡Œæ¦œ" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾ä¸“æ ï¼šç”¨æˆ·æ´»è¶Šæ’è¡Œæ¦œ</figcaption></figure><p>è¿˜æœ‰ç”¨æˆ·ç™»å½•åçš„ Sessionã€ç«™ç‚¹åœ°å›¾ SiteMapï¼Œåˆ†åˆ«ç”¨åˆ°äº† Redis çš„å­—ç¬¦ä¸²å’Œå“ˆå¸Œè¡¨ä¸¤ç§æ•°æ®ç±»å‹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250427152536.png" alt="æŠ€æœ¯æ´¾ä¸“æ ï¼šRedis çš„ä½¿ç”¨ç¤ºä¾‹" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾ä¸“æ ï¼šRedis çš„ä½¿ç”¨ç¤ºä¾‹</figcaption></figure><p>å…¶ä¸­æ¯”è¾ƒæœ‰æŒ‘æˆ˜æ€§çš„ä¸€ä¸ªåº”ç”¨æ˜¯ï¼Œé€šè¿‡ Lua è„šæœ¬å°è£… Redis çš„ setnex å‘½ä»¤æ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œä»¥ä¿è¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œçƒ­ç‚¹æ–‡ç« åœ¨çŸ­æ—¶é—´å†…çš„é«˜é¢‘è®¿é—®ä¸ä¼šå‡»ç©¿ MySQLã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250427152627.png" alt="æŠ€æœ¯æ´¾ä¸“æ ï¼šRedis åˆ†å¸ƒå¼é”çš„åº”ç”¨" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾ä¸“æ ï¼šRedis åˆ†å¸ƒå¼é”çš„åº”ç”¨</figcaption></figure><h4 id="éƒ¨ç½²è¿‡-redis-å—" tabindex="-1"><a class="header-anchor" href="#éƒ¨ç½²è¿‡-redis-å—"><span>éƒ¨ç½²è¿‡ Redis å—ï¼Ÿ</span></a></h4><p>ç¬¬ä¸€ç§å›ç­”ç‰ˆæœ¬ï¼š</p><p>æˆ‘åªåœ¨æœ¬åœ°éƒ¨ç½²è¿‡å•æœºç‰ˆï¼Œä¸‹è½½ Redis çš„å®‰è£…åŒ…ï¼Œè§£å‹åè¿è¡Œ <code>redis-server</code> å‘½ä»¤å³å¯ã€‚</p><p>ç¬¬äºŒç§å›ç­”ç‰ˆæœ¬ï¼š</p><p>æˆ‘æœ‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²å•æœºç‰ˆ Redisï¼Œä»å®˜ç½‘ä¸‹è½½æºç åŒ…è§£å‹åæ‰§è¡Œ <code>make &amp;&amp; make install</code> ç¼–è¯‘å®‰è£…ã€‚ç„¶åç¼–è¾‘ <code>redis.conf</code> æ–‡ä»¶ï¼Œå¼€å¯è¿œç¨‹è®¿é—®ã€è®¾ç½®å¯†ç ã€é™åˆ¶å†…å­˜ã€è®¾ç½®å†…å­˜è¿‡æœŸæ·˜æ±°ç­–ç•¥ã€å¼€å¯ AOF æŒä¹…åŒ–ç­‰ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>bind 0.0.0.0        # å…è®¸è¿œç¨‹è®¿é—®</span></span>
<span class="line"><span>requirepass your_password  # è®¾ç½®å¯†ç </span></span>
<span class="line"><span>maxmemory 4gb      # é™åˆ¶å†…å­˜ï¼Œé¿å… OOM</span></span>
<span class="line"><span>maxmemory-policy allkeys-lru  # å†…å­˜æ·˜æ±°ç­–ç•¥</span></span>
<span class="line"><span>appendonly yes     # å¼€å¯ AOF æŒä¹…åŒ–</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬ä¸‰ç§å›ç­”ç‰ˆæœ¬ï¼š</p><p>æˆ‘æœ‰ä½¿ç”¨ Docker æ‹‰å– Redis é•œåƒåè¿›è¡Œå®¹å™¨åŒ–éƒ¨ç½²ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redis</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 6379:6379</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redis:7.0-alpine</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="redis-çš„é«˜å¯ç”¨æ–¹æ¡ˆæœ‰éƒ¨ç½²è¿‡å—" tabindex="-1"><a class="header-anchor" href="#redis-çš„é«˜å¯ç”¨æ–¹æ¡ˆæœ‰éƒ¨ç½²è¿‡å—"><span>Redis çš„é«˜å¯ç”¨æ–¹æ¡ˆæœ‰éƒ¨ç½²è¿‡å—ï¼Ÿ</span></a></h4><p>æœ‰éƒ¨ç½²è¿‡å“¨å…µæœºåˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹æˆç†Ÿçš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„æ˜¯ä¸€ä¸»ä¸¤ä»çš„ Redis å®ä¾‹ï¼Œå†åŠ ä¸Šä¸‰ä¸ª Sentinel èŠ‚ç‚¹ç›‘æ§å®ƒä»¬ã€‚Sentinel çš„é…ç½®ç›¸å¯¹ç®€å•ï¼Œä¸»è¦è®¾ç½®äº†æ•…éšœè½¬ç§»çš„åˆ¤å®šæ¡ä»¶å’Œè¶…æ—¶é˜ˆå€¼ã€‚</p><p>ä¸»èŠ‚ç‚¹é…ç½®ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">port</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6379</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»èŠ‚ç‚¹é…ç½®ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">replicaof</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.1.10</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6379</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å“¨å…µèŠ‚ç‚¹é…ç½®ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> monitor</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.1.10</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6379</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> down-after-milliseconds</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> failover-timeout</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parallel-syncs</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼ŒSentinel èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹å¹¶åå•†é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å¤§æ¦‚éœ€è¦ 10-15 ç§’ã€‚</p><p>å¦ä¸€ä¸ªå¤§å‹é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Redis Cluster é›†ç¾¤æ–¹æ¡ˆã€‚è¯¥é¡¹ç›®æ•°æ®é‡å¤§ä¸”å¢é•¿å¿«ï¼Œéœ€è¦æ°´å¹³æ‰©å±•èƒ½åŠ›ã€‚æˆ‘ä»¬éƒ¨ç½²äº† 6 ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹é…å¤‡ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå½¢æˆäº†ä¸€ä¸ª 3ä¸»3ä» çš„åˆå§‹é›†ç¾¤ã€‚Redis Cluster çš„è®¾ç½®æ¯” Sentinel å¤æ‚ä¸€äº›ï¼Œéœ€è¦æ­£ç¡®é…ç½®é›†ç¾¤èŠ‚ç‚¹é—´é€šä¿¡ã€åˆ†ç‰‡æ˜ å°„ç­‰ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redis-7000.conf</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redis-7001.conf</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># ä½¿ç”¨ redis-cli åˆ›å»ºé›†ç¾¤</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># Redis ä¼šè‡ªåŠ¨å°† key å“ˆå¸Œåˆ° 16384 ä¸ªæ§½ä½</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># ä¸»èŠ‚ç‚¹å‡åˆ†æ§½ä½ï¼Œä»èŠ‚ç‚¹è‡ªåŠ¨è·Ÿéš</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --cluster</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  127.0.0.1:7000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 127.0.0.1:7001</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 127.0.0.1:7002</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  127.0.0.1:7003</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 127.0.0.1:7004</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 127.0.0.1:7005</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  --cluster-replicas</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redis Cluster æœ€å¤§çš„ä¼˜åŠ¿æ˜¯æ•°æ®è‡ªåŠ¨åˆ†ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç®€å•åœ°å¢åŠ èŠ‚ç‚¹æ¥æ‰©å±•é›†ç¾¤å®¹é‡ã€‚æ­¤å¤–ï¼Œå®ƒçš„æ•…éšœè½¬ç§»ä¹Ÿå¾ˆå¿«ï¼Œé€šå¸¸åœ¨å‡ ç§’å†…å°±èƒ½å®Œæˆã€‚</p><p>å¯¹äºä¸€äº›è½»é‡çº§åº”ç”¨ï¼Œæˆ‘ä¹Ÿä½¿ç”¨è¿‡ä¸»ä»å¤åˆ¶åŠ æ‰‹åŠ¨æ•…éšœè½¬ç§»çš„æ–¹æ¡ˆã€‚ä¸»èŠ‚ç‚¹è´Ÿè´£è¯»å†™æ“ä½œï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»æ“ä½œã€‚æ‰‹åŠ¨æ•…éšœè½¬ç§»æ—¶ï¼Œæˆ‘ä»¬ä¼šå…ˆå°†ä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œç„¶åé‡æ–°é…ç½®å…¶ä»–ä»èŠ‚ç‚¹ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 1. å–æ¶ˆä»èŠ‚ç‚¹èº«ä»½</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">slave-i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">slaveof</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> no</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> one</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 2. å°†å…¶ä»–ä»èŠ‚ç‚¹æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">other-slave-i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">slaveof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">new-master-i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p&gt; &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">por</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">t&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åä¸ºä¸€é¢åŸé¢˜ï¼šè¯´ä¸‹ Redis å’Œ HashMap çš„åŒºåˆ«</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨å•†ä¸šåŒ–ä¸€é¢çš„åŸé¢˜ï¼šRedis å’Œ MySQL çš„åŒºåˆ«</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 7 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis ç›¸å…³çš„åŸºç¡€çŸ¥è¯†</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åä¸º OD é¢ç»åŒå­¦ 1 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„äº†è§£, éƒ¨ç½²æ–¹æ¡ˆ?</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 3 Java åç«¯é¢è¯•åŸé¢˜ï¼šé¡¹ç›®é‡Œå“ªé‡Œç”¨åˆ°äº† Redis</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ 360 é¢ç»åŒå­¦ 3 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šç”¨è¿‡ redis å— ç”¨æ¥å¹²ä»€ä¹ˆ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æ‹›å•†é“¶è¡Œé¢ç»åŒå­¦ 6 æ‹›é“¶ç½‘ç»œç§‘æŠ€é¢è¯•åŸé¢˜ï¼šäº†è§£ MySQLã€Redis å—ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç™¾åº¦é¢ç»åŒå­¦ 1 æ–‡å¿ƒä¸€è¨€ 25 å®ä¹  Java åç«¯é¢è¯•åŸé¢˜ï¼šé¡¹ç›®ä¸­ä»€ä¹ˆåœ°æ–¹ä½¿ç”¨äº† redis ç¼“å­˜ï¼Œredis ä¸ºä»€ä¹ˆå¿«ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å›½ä¼é›¶ç¢é¢ç»åŒå­¦ 9 é¢è¯•åŸé¢˜ï¼šæ•°æ®åº“ç”¨ä»€ä¹ˆå¤šï¼ˆè¯´äº† Mysql å’Œ Redisï¼‰</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è£è€€é¢ç»åŒå­¦ 4 é¢è¯•åŸé¢˜ï¼šRediså’ŒMySQLçš„åŒºåˆ«ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æµ·åº·å¨è§†åŒå­¦ 4é¢è¯•åŸé¢˜ï¼šRediséƒ¨ç½²</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åä¸º OD é¢ç»åŒå­¦ 1 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„äº†è§£, éƒ¨ç½²æ–¹æ¡ˆ?</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šredisçš„éƒ¨ç½²æ–¹å¼éƒ½æœ‰å“ªäº›å‘¢ï¼Œå„è‡ªæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ</li></ol></blockquote><h3 id="_2-redis-å¯ä»¥ç”¨æ¥å¹²ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_2-redis-å¯ä»¥ç”¨æ¥å¹²ä»€ä¹ˆ"><span>2.Redis å¯ä»¥ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ</span></a></h3><p>Redis å¯ä»¥ç”¨æ¥åšç¼“å­˜ï¼Œæ¯”å¦‚è¯´æŠŠé«˜é¢‘è®¿é—®çš„æ–‡ç« è¯¦æƒ…ã€å•†å“ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯æ”¾å…¥ Redis å½“ä¸­ï¼Œå¹¶é€šè¿‡è®¾ç½®è¿‡æœŸæ—¶é—´æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œè¿™æ ·å°±å¯ä»¥å‡è½»æ•°æ®åº“çš„è®¿é—®å‹åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d44c2397-5994-452f-8b7b-eb85d2b87685.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisç¼“å­˜" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisç¼“å­˜</figcaption></figure><p>Redis çš„ Zset è¿˜å¯ä»¥ç”¨æ¥å®ç°ç§¯åˆ†æ¦œã€çƒ­æœæ¦œï¼Œé€šè¿‡ score å­—æ®µè¿›è¡Œæ’åºï¼Œç„¶åå–å‰ N ä¸ªå…ƒç´ ï¼Œå°±èƒ½å®ç° TOPN çš„æ¦œå•åŠŸèƒ½ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240420100012.png" alt="æŠ€æœ¯æ´¾ï¼šé˜…è¯»æ´»è·ƒæ¦œ" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾ï¼šé˜…è¯»æ´»è·ƒæ¦œ</figcaption></figure><p>åˆ©ç”¨ Redis çš„ SETNX å‘½ä»¤æˆ–è€… Redisson è¿˜å¯ä»¥å®ç°åˆ†å¸ƒå¼é”ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æŒæœ‰é”ï¼›ä¸ºäº†é˜²æ­¢å‡ºç°æ­»é”ï¼Œå¯ä»¥ç»™é”è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸåè‡ªåŠ¨é‡Šæ”¾ï¼›å¹¶ä¸”æœ€å¥½å¼€å¯ä¸€ä¸ªç›‘å¬çº¿ç¨‹ï¼Œå½“ä»»åŠ¡å°šæœªå®Œæˆæ—¶ç»™é”è‡ªåŠ¨ç»­æœŸã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250428152255.png" alt="PmHubï¼šRedisåˆ†å¸ƒå¼é”ä¿éšœæµç¨‹çŠ¶æ€æ›´æ–°" tabindex="0" loading="lazy"><figcaption>PmHubï¼šRedisåˆ†å¸ƒå¼é”ä¿éšœæµç¨‹çŠ¶æ€æ›´æ–°</figcaption></figure><p>å¦‚æœæ˜¯ç§’æ€æ¥å£ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ Lua è„šæœ¬æ¥å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œé™åˆ¶æ¯ç§’åªèƒ½å¤„ç† N ä¸ªè¯·æ±‚ã€‚</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- KEYS[1]: ä»¤ç‰Œæ¡¶çš„key</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- ARGV[1]: æ¡¶å®¹é‡</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- ARGV[2]: ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼ˆæ¯ç§’ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- ARGV[3]: å½“å‰æ—¶é—´æˆ³ï¼ˆç§’ï¼‰</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> bucket</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;HMGET&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">], </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;tokens&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;timestamp&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bucket</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]) or </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> last_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bucket</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]) or </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- è®¡ç®—æ–°ä»¤ç‰Œæ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> delta</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">math.max</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">last_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> add_tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">delta</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rate</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">math.min</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> + </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">add_tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">last_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> allowed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt;= </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> - </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    allowed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;HMSET&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">], </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;tokens&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">tokens</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;timestamp&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">last_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;EXPIRE&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">], </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3600</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- è¿‡æœŸæ—¶é—´å¯è‡ªå®šä¹‰</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> allowed</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Java ä¸­è°ƒç”¨ Lua è„šæœ¬ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ä»¤ç‰Œæ¡¶å‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> capacity </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // æ¡¶å®¹é‡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rate </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">      // æ¯ç§’2ä¸ªä»¤ç‰Œ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> now </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentTimeMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> /</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> key </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;token_bucket:user:123&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è°ƒç”¨ Lua è„šæœ¬ï¼Œè¿”å› 1 è¡¨ç¤ºé€šè¿‡ï¼Œ0 è¡¨ç¤ºè¢«é™æµ</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> allowed </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (Long) </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">eval</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(luaScript, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, key, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">valueOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(capacity), </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">valueOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(rate), </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">valueOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(now));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 7 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis ç›¸å…³çš„åŸºç¡€çŸ¥è¯†</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šè®²ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦ç”¨ Redis å»å­˜æƒé™åˆ—è¡¨ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 20 æµ‹å¼€ä¸€é¢çš„åŸé¢˜ï¼šredis æœ‰ä»€ä¹ˆå¥½å¤„ï¼Œä¸ºä»€ä¹ˆç”¨ redis</li></ol></blockquote><p>memoï¼š2025 å¹´ 4 æœˆ 28 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">å¸®çƒå‹ä¿®æ”¹ç®€å†</a>çš„æ—¶å€™ï¼Œç¢°åˆ°ä¸€ä½ä¸œå—å¤§å­¦æœ¬ç¡•è¿è¯»çš„çƒå‹ï¼Œæ˜Ÿçƒèƒ½æ¥è¿™ä¹ˆå¤šä¼˜ç§€çš„çƒå‹ï¼ŒçœŸçš„å¾ˆå¼€å¿ƒå•Šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250428163928.png" alt="ä¸œå—å¤§å­¦æœ¬ç¡•çš„çƒå‹" tabindex="0" loading="lazy"><figcaption>ä¸œå—å¤§å­¦æœ¬ç¡•çš„çƒå‹</figcaption></figure><h3 id="_3-ğŸŒŸredisæœ‰å“ªäº›æ•°æ®ç±»å‹" tabindex="-1"><a class="header-anchor" href="#_3-ğŸŒŸredisæœ‰å“ªäº›æ•°æ®ç±»å‹"><span>3.ğŸŒŸRedisæœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Ÿ</span></a></h3><p>Redis æ”¯æŒäº”ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å“ˆå¸Œã€é›†åˆå’Œæœ‰åºé›†åˆã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-10434dc7-c7a3-4c1a-b484-de3fb37669ee.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisåŸºæœ¬æ•°æ®ç±»å‹" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisåŸºæœ¬æ•°æ®ç±»å‹</figcaption></figure><p>è¿˜æœ‰ä¸‰ç§æ‰©å±•æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ç”¨äºä½çº§æ“ä½œçš„ Bitmapã€ç”¨äºåŸºæ•°ä¼°ç®—çš„ HyperLogLogã€æ”¯æŒå­˜å‚¨å’ŒæŸ¥è¯¢åœ°ç†åæ ‡çš„ GEOã€‚</p><h4 id="è¯¦ç»†ä»‹ç»ä¸‹å­—ç¬¦ä¸²" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†ä»‹ç»ä¸‹å­—ç¬¦ä¸²"><span>è¯¦ç»†ä»‹ç»ä¸‹å­—ç¬¦ä¸²ï¼Ÿ</span></a></h4><p>å­—ç¬¦ä¸²æ˜¯æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥å­˜å‚¨æ–‡æœ¬ã€æ•°å­—æˆ–è€…äºŒè¿›åˆ¶æ•°æ®ï¼Œæœ€å¤§å®¹é‡æ˜¯ 512 MBã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250429112032.png" alt="Mräºï¼šRedis çš„ string" tabindex="0" loading="lazy"><figcaption>Mräºï¼šRedis çš„ string</figcaption></figure><p>é€‚åˆç¼“å­˜å•ä¸ªå¯¹è±¡ï¼Œæ¯”å¦‚éªŒè¯ç ã€tokenã€è®¡æ•°å™¨ç­‰ã€‚</p><h4 id="è¯¦ç»†ä»‹ç»ä¸‹åˆ—è¡¨" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†ä»‹ç»ä¸‹åˆ—è¡¨"><span>è¯¦ç»†ä»‹ç»ä¸‹åˆ—è¡¨ï¼Ÿ</span></a></h4><p>åˆ—è¡¨æ˜¯ä¸€ä¸ªæœ‰åºçš„å…ƒç´ é›†åˆï¼Œæ”¯æŒä»å¤´éƒ¨æˆ–å°¾éƒ¨æ’å…¥/åˆ é™¤å…ƒç´ ï¼Œå¸¸ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—æˆ–ä»»åŠ¡åˆ—è¡¨ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250429112708.png" alt="Mräºï¼šRedis çš„ list" tabindex="0" loading="lazy"><figcaption>Mräºï¼šRedis çš„ list</figcaption></figure><h4 id="è¯¦ç»†ä»‹ç»ä¸‹å“ˆå¸Œ" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†ä»‹ç»ä¸‹å“ˆå¸Œ"><span>è¯¦ç»†ä»‹ç»ä¸‹å“ˆå¸Œï¼Ÿ</span></a></h4><p>å“ˆå¸Œæ˜¯ä¸€ä¸ªé”®å€¼å¯¹é›†åˆï¼Œé€‚åˆå­˜å‚¨å¯¹è±¡ï¼Œå¦‚å•†å“ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯ç­‰ã€‚æ¯”å¦‚è¯´ <code>value = {name: &#39;æ²‰é»˜ç‹äºŒ&#39;, age: 18}</code>ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250429113019.png" alt="Mräºï¼šRedis çš„hash" tabindex="0" loading="lazy"><figcaption>Mräºï¼šRedis çš„hash</figcaption></figure><h4 id="è¯¦ç»†ä»‹ç»ä¸‹é›†åˆ" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†ä»‹ç»ä¸‹é›†åˆ"><span>è¯¦ç»†ä»‹ç»ä¸‹é›†åˆï¼Ÿ</span></a></h4><p>é›†åˆæ˜¯æ— åºä¸”ä¸é‡å¤çš„ï¼Œæ”¯æŒäº¤é›†ã€å¹¶é›†æ“ä½œï¼ŒæŸ¥è¯¢æ•ˆç‡èƒ½è¾¾åˆ° <code>O(1)</code> çº§åˆ«ï¼Œä¸»è¦ç”¨äºå»é‡ã€æ ‡ç­¾ã€å…±åŒå¥½å‹ç­‰åœºæ™¯ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250429113501.png" alt="Mräºï¼šRedis çš„ set" tabindex="0" loading="lazy"><figcaption>Mräºï¼šRedis çš„ set</figcaption></figure><h4 id="è¯¦ç»†ä»‹ç»ä¸‹æœ‰åºé›†åˆ" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†ä»‹ç»ä¸‹æœ‰åºé›†åˆ"><span>è¯¦ç»†ä»‹ç»ä¸‹æœ‰åºé›†åˆï¼Ÿ</span></a></h4><p>æœ‰åºé›†åˆçš„å…ƒç´ æŒ‰åˆ†æ•°è¿›è¡Œæ’åºï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œé€‚ç”¨äºæ’è¡Œæ¦œæˆ–ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240315120652.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯</figcaption></figure><h4 id="è¯¦ç»†ä»‹ç»ä¸‹bitmap" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†ä»‹ç»ä¸‹bitmap"><span>è¯¦ç»†ä»‹ç»ä¸‹Bitmapï¼Ÿ</span></a></h4><p>Bitmap å¯ä»¥æŠŠä¸€ç»„äºŒè¿›åˆ¶ä½ç´§å‡‘åœ°å­˜å‚¨åœ¨ä¸€å—è¿ç»­å†…å­˜ä¸­ï¼Œæ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ˜¯å¦ç­¾åˆ°ã€æ˜¯å¦æ´»è·ƒç­‰ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250429120349.png" alt="ç å“¥å­—èŠ‚ï¼šBitmap" tabindex="0" loading="lazy"><figcaption>ç å“¥å­—èŠ‚ï¼šBitmap</figcaption></figure><p>æ¯”å¦‚ç”¨æˆ· 0 çš„å·²ç­¾åˆ° 1ã€ç”¨æˆ· 1 æœªç­¾åˆ° 0ã€ç”¨æˆ· 2 å·²ç­¾åˆ°ï¼ŒRedis å°±ä¼šæŠŠè¿™äº›çŠ¶æ€æ”¾è¿›ä¸€ä¸ªè¿ç»­çš„äºŒè¿›åˆ¶ä¸² <code>101</code>ï¼Œ1 äº¿ç”¨æˆ·ç­¾åˆ°ä»…éœ€ <code>100,000,000 / 8 / 1024 â‰ˆ 12MB</code> çš„ç©ºé—´ï¼ŒçœŸçš„çœåˆ°ç¦»è°±ã€‚</p><h4 id="è¯¦ç»†ä»‹ç»ä¸‹hyperloglog" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†ä»‹ç»ä¸‹hyperloglog"><span>è¯¦ç»†ä»‹ç»ä¸‹HyperLogLogï¼Ÿ</span></a></h4><p>HyperLogLog æ˜¯ä¸€ç§ç”¨äºåŸºæ•°ç»Ÿè®¡çš„æ¦‚ç‡æ€§æ•°æ®ç»“æ„ï¼Œå¯ä»¥åœ¨ä»…æœ‰ 12KB çš„å†…å­˜ç©ºé—´ä¸‹ï¼Œç»Ÿè®¡æµ·é‡æ•°æ®é›†ä¸­ä¸é‡å¤å…ƒç´ çš„ä¸ªæ•°ï¼Œè¯¯å·®ç‡ä»… 0.81%ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250429121524.png" alt="devops.devï¼šHyperLogLog" tabindex="0" loading="lazy"><figcaption>devops.devï¼šHyperLogLog</figcaption></figure><p>åº•å±‚åŸºäº LogLog ç®—æ³•æ”¹è¿›ï¼Œå…ˆæŠŠæ¯ä¸ªå…ƒç´ å“ˆå¸Œæˆä¸€ä¸ªäºŒè¿›åˆ¶ä¸²ï¼Œç„¶åå–å‰ 14 ä½è¿›è¡Œåˆ†ç»„ï¼Œæ”¾åˆ° 16384 ä¸ªæ¡¶ä¸­ï¼Œè®°å½•æ¯ç»„æœ€å¤§çš„å‰å¯¼é›¶æ•°é‡ï¼Œæœ€åç”¨ä¸€ä¸ªè¿‘ä¼¼å…¬å¼æ¨ç®—å‡ºæ€»ä½“çš„åŸºæ•°ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250429132129.png" alt="æ—å† å®ï¼šè¿‘ä¼¼å…¬å¼" tabindex="0" loading="lazy"><figcaption>æ—å† å®ï¼šè¿‘ä¼¼å…¬å¼</figcaption></figure><blockquote><p><mjx-container class="MathJax" jax="SVG" style="position:relative;"><svg style="vertical-align:0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.904ex" role="img" focusable="false" viewBox="0 -841.7 1290.1 841.7" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>14</mn></mrow></msup></math></mjx-assistive-mml></mjx-container>ä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶ 6 Bitï¼Œåˆšå¥½ <code>16384 * 6 /8 / 1024 K = 12KB</code>ï¼Œ8 bit = 1 byteã€‚</p></blockquote><p>ä¸¾ä¸ªè¶…ç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æœ‰ä¸€ä¸ªç¥å¥‡çš„å“ˆå¸Œå‡½æ•°ï¼Œå¯ä»¥æŠŠå…ƒç´ æ•£åˆ—æˆä¸€ä¸ªäºŒè¿›åˆ¶æ•°ï¼Œæ¯”å¦‚ï¼š</p><table><thead><tr><th>å…ƒç´ </th><th>å“ˆå¸Œå€¼</th><th>å‰å¯¼é›¶ä¸ªæ•°</th></tr></thead><tbody><tr><td>userA</td><td>000100101â€¦</td><td>3</td></tr><tr><td>userB</td><td>001010011â€¦</td><td>2</td></tr><tr><td>userC</td><td>000000101â€¦</td><td>6</td></tr></tbody></table><p>å¯ä»¥å‘ç°ï¼Œå“ˆå¸Œå€¼è¶Šé•¿å‰å¯¼é›¶è¶Šå¤šï¼Œä¹Ÿå°±è¯´æ˜é›†åˆé‡Œçš„å…ƒç´ è¶Šå¤šã€‚</p><p>å¤§å‹ç½‘ç«™ UV ç»Ÿè®¡ç³»ç»Ÿç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UVCounter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Jedis</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> jedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> recordVisit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> date</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> userId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;uv:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> date;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        jedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pfadd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, userId);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getUV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> date</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> jedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pfcount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;uv:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> date);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getUVBetween</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> startDate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> endDate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">keys</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getDateKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(startDate, endDate);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> jedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pfcount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">keys</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toArray</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è¯¦ç»†ä»‹ç»ä¸‹geo" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†ä»‹ç»ä¸‹geo"><span>è¯¦ç»†ä»‹ç»ä¸‹GEOï¼Ÿ</span></a></h4><p>GEO ç”¨äºå­˜å‚¨å’ŒæŸ¥è¯¢åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼ŒæŸ¥æ‰¾æŸä½ç½®åŠå¾„å†…çš„å…¶ä»–å…ƒç´ ã€‚</p><p>å¸¸è§çš„åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼šé™„è¿‘çš„äººæˆ–è€…å•†å®¶ã€è®¡ç®—å¤–å–å‘˜å’Œå•†å®¶çš„è·ç¦»ã€åˆ¤æ–­ç”¨æˆ·æ˜¯å¦è¿›å…¥æŸä¸ªåŒºåŸŸç­‰ã€‚</p><p>åº•å±‚åŸºäº ZSet å®ç°ï¼Œé€šè¿‡ Geohash ç®—æ³•æŠŠç»çº¬åº¦ç¼–ç æˆ scoreã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250429134358.png" alt="å°å¾å…ˆç”Ÿçš„ç¼–ç¨‹ä¸–ç•Œï¼šGEO åŸç†" tabindex="0" loading="lazy"><figcaption>å°å¾å…ˆç”Ÿçš„ç¼–ç¨‹ä¸–ç•Œï¼šGEO åŸç†</figcaption></figure><p>æ¯”å¦‚è¯´æŸ¥è¯¢é™„è¿‘çš„å•†å®¶æ—¶ï¼ŒRedis ä¼šæ ¹æ®ä¸­å¿ƒç‚¹ç»çº¬åº¦åæ¨å¯èƒ½çš„ Geohash èŒƒå›´ï¼Œ åœ¨ ZSet ä¸ŠåšèŒƒå›´æŸ¥è¯¢ï¼Œæ‹¿åˆ°å€™é€‰ç‚¹åï¼Œç”¨ Haversine å…¬å¼ç²¾ç¡®è®¡ç®—çƒé¢è·ç¦»ï¼Œç­›é€‰å‡ºæœ€ç»ˆç¬¦åˆè¦æ±‚çš„ä½ç½®ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NearbyShopService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Jedis</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> jedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> SHOP_KEY </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;shops:geo&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ·»åŠ å•†é“º</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> addShop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> shopId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> longitude</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> latitude</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        jedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">geoadd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(SHOP_KEY, longitude, latitude, shopId);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æŸ¥è¯¢é™„è¿‘çš„å•†é“º</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">GeoRadiusResponse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getNearbyShops</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            double</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> longitude</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            double</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> latitude</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            double</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> radiusKm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> jedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">georadius</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(SHOP_KEY, </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                             longitude, </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                             latitude, </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                             radiusKm, </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                             GeoUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">KM</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                             GeoRadiusParam</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">geoRadiusParam</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                         .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">withCoord</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                         .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">withDist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                         .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sortAscending</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                         .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // è®¡ç®—ä¸¤ä¸ªå•†é“ºä¹‹é—´çš„è·ç¦»</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> double</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getShopDistance</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> shop1Id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> shop2Id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> jedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">geodist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(SHOP_KEY, </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                           shop1Id, </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                           shop2Id, </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                           GeoUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">KILOMETERS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸ºä»€ä¹ˆä½¿ç”¨-hash-ç±»å‹è€Œä¸ä½¿ç”¨-string-ç±»å‹åºåˆ—åŒ–å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆä½¿ç”¨-hash-ç±»å‹è€Œä¸ä½¿ç”¨-string-ç±»å‹åºåˆ—åŒ–å­˜å‚¨"><span>ä¸ºä»€ä¹ˆä½¿ç”¨ hash ç±»å‹è€Œä¸ä½¿ç”¨ string ç±»å‹åºåˆ—åŒ–å­˜å‚¨ï¼Ÿ</span></a></h4><p>Hash å¯ä»¥åªè¯»å–æˆ–è€…ä¿®æ”¹æŸä¸€ä¸ªå­—æ®µï¼Œè€Œ String éœ€è¦ä¸€æ¬¡æ€§æŠŠæ•´ä¸ªå¯¹è±¡å–å‡ºæ¥ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240315115713.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šhash å’Œ string çš„åŒºåˆ«" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šhash å’Œ string çš„åŒºåˆ«</figcaption></figure><p>æ¯”å¦‚è¯´æœ‰ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ <code>user = {name: &#39;æ²‰é»˜ç‹äºŒ&#39;, age: 18}</code>ï¼Œå¦‚æœä½¿ç”¨ Hash å­˜å‚¨ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ <code>age</code> å­—æ®µï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;age&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">19</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å¦‚æœä½¿ç”¨ String å­˜å‚¨ï¼Œéœ€è¦å…ˆå–å‡ºæ•´ä¸ªå¯¹è±¡ï¼Œä¿®æ”¹åå†å­˜å›å»ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> userJson </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">User</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> user </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> JSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">parseObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(userJson, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">User</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setAge</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">19</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">JSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toJSONString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(user));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨å•†ä¸šåŒ–ä¸€é¢çš„åŸé¢˜ï¼šè¯´è¯´ Redis çš„ zsetï¼Œä»€ä¹ˆæ˜¯è·³è¡¨ï¼Œæ’å…¥ä¸€ä¸ªèŠ‚ç‚¹è¦æ„å»ºå‡ å±‚ç´¢å¼•</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 9 é£ä¹¦åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„æ•°æ®ç±»å‹ï¼ŒZSet çš„å®ç°</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³æš‘æœŸå®ä¹ åŒå­¦ E ä¸€é¢é¢è¯•åŸé¢˜ï¼šä½ å¯¹ Redis äº†è§£å¤šå°‘ï¼Œè¯´è¯´å¸¸è§çš„æ•°æ®ç»“æ„å’Œåº”ç”¨åœºæ™¯</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 23 QQ åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„æ•°æ®ç±»å‹</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 7 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´ä¸€ä¸‹ Redis å¸¸ç”¨çš„æ•°æ®ç»“æ„</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 7 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis ç›¸å…³çš„åŸºç¡€çŸ¥è¯†</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åä¸ºé¢ç»åŒå­¦ 11 é¢è¯•åŸé¢˜ï¼šé¡¹ç›®ä¸­ä½¿ç”¨äº† redisï¼Œredis æœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Ÿåˆ†åˆ«ä½¿ç”¨çš„åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆä½¿ç”¨ hash ç±»å‹è€Œä¸ä½¿ç”¨ string ç±»å‹åºåˆ—åŒ–å­˜å‚¨ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ OPPO é¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRediså¸¸è§æ•°æ®ç»“æ„</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢åŒå­¦ 9 ä¸€é¢é¢è¯•åŸé¢˜ï¼šredisçš„æ•°æ®ç»“æ„ç±»å‹ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„é˜¿é‡Œäº‘é¢ç»åŒå­¦ 22 é¢ç»ï¼šredisé«˜çº§æ•°æ®ç»“æ„çš„ä½¿ç”¨åœºæ™¯</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 29 Java åç«¯ä¸€é¢åŸé¢˜ï¼šRedisä¿è¯incrå‘½ä»¤åŸå­æ€§çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 4 æœˆ 29 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘ä¿¡æ¯</a>è¯´æ‹¿åˆ°äº†äºšé©¬é€Šçš„ offerï¼Œå·¥èµ„è¿˜ç»™çš„å¾ˆé«˜ï¼Œé—®æˆ‘è¦ä¸è¦é€‰ï¼Ÿ çœŸçš„æ­å–œäº†ğŸ‰ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250429155817.png" alt="çƒå‹æ‹¿åˆ°äº†äºšé©¬é€Šçš„ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†äºšé©¬é€Šçš„ offer</figcaption></figure><h3 id="_4-ğŸŒŸredis-ä¸ºä»€ä¹ˆå¿«å‘¢" tabindex="-1"><a class="header-anchor" href="#_4-ğŸŒŸredis-ä¸ºä»€ä¹ˆå¿«å‘¢"><span>4.ğŸŒŸRedis ä¸ºä»€ä¹ˆå¿«å‘¢ï¼Ÿ</span></a></h3><p>ç¬¬ä¸€ï¼ŒRedis çš„æ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨å†…å­˜ä¸­ï¼Œè€Œå†…å­˜çš„è¯»å†™é€Ÿåº¦æœ¬èº«å°±æ¯”ç£ç›˜å¿«å‡ ä¸ªæ•°é‡çº§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250430112922.png" alt="Shirleyï¼šRedis åŸºäºå†…å­˜" tabindex="0" loading="lazy"><figcaption>Shirleyï¼šRedis åŸºäºå†…å­˜</figcaption></figure><p>ç¬¬äºŒï¼ŒRedis é‡‡ç”¨äº†åŸºäº IO å¤šè·¯å¤ç”¨æŠ€æœ¯çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹æ¥å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å’Œæ‰§è¡Œ Redis å‘½ä»¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250430132517.png" alt="å£«äº‘ï¼šRedisçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹" tabindex="0" loading="lazy"><figcaption>å£«äº‘ï¼šRedisçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹</figcaption></figure><p>å…¶ä¸­çš„ IO å¤šè·¯å¤ç”¨æŠ€æœ¯å¯ä»¥åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼ŒåŒæ—¶ç›‘å¬æˆåƒä¸Šä¸‡ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œè§£å†³ä¼ ç»Ÿ IO æ¨¡å‹ä¸­æ¯ä¸ªè¿æ¥éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250430143547.png" alt="Ricoï¼šIO å¤šè·¯å¤ç”¨" tabindex="0" loading="lazy"><figcaption>Ricoï¼šIO å¤šè·¯å¤ç”¨</figcaption></figure><p>IO å¤šè·¯å¤ç”¨ä¼šæŒç»­ç›‘å¬è¯·æ±‚ï¼Œç„¶åæŠŠå‡†å¤‡å¥½çš„è¯·æ±‚å‹å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—å½“ä¸­ï¼Œå¹¶å°†å…¶æœ‰åºåœ°ä¼ é€’ç»™æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼Œæœ€åç”±äº‹ä»¶å¤„ç†å™¨æ¥æ‰§è¡Œå¯¹åº”çš„ acceptã€read å’Œ write è¯·æ±‚ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250430150054.png" alt="å¼€å‘è€…å†…åŠŸä¿®ç‚¼ï¼šRedis äº‹ä»¶é©±åŠ¨æœºåˆ¶" tabindex="0" loading="lazy"><figcaption>å¼€å‘è€…å†…åŠŸä¿®ç‚¼ï¼šRedis äº‹ä»¶é©±åŠ¨æœºåˆ¶</figcaption></figure><p>Redis ä¼šæ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©æœ€ä¼˜çš„ IO å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œæ¯”å¦‚ Linux ä¸‹ä½¿ç”¨ epollï¼ŒmacOS ä¸‹ä½¿ç”¨ kqueue ç­‰ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// epoll çš„åˆ›å»ºå’Œä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> epfd </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> epoll_create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // åˆ›å»º epoll å®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> epoll_event ev, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">events</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[MAX_EVENTS];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ·»åŠ ç›‘å¬äº‹ä»¶</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ev.events </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> EPOLLIN;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ev.data.fd </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> listen_sock;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">epoll_ctl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">epfd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> EPOLL_CTL_ADD</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> listen_sock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">ev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ç­‰å¾…äº‹ä»¶å‘ç”Ÿ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nfds </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> epoll_wait</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(epfd, events, MAX_EVENTS, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nfds; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å¤„ç†å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Redis 6.0 ä¹‹å‰ï¼ŒåŒ…æ‹¬è¿æ¥å»ºç«‹ã€è¯·æ±‚è¯»å–ã€å“åº”å‘é€ï¼Œä»¥åŠå‘½ä»¤æ‰§è¡Œéƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­é¡ºåºæ‰§è¡Œçš„ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„é”ç«äº‰å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸º Redis çš„ç»å¤§éƒ¨åˆ†æ“ä½œéƒ½æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œçš„ï¼Œæ€§èƒ½ç“¶é¢ˆä¸»è¦æ˜¯å†…å­˜æ“ä½œå’Œç½‘ç»œé€šä¿¡ï¼Œè€Œä¸æ˜¯ CPUã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250430145617.png" alt="å°çœ¼ç›èŠæŠ€æœ¯ï¼šRedis å•çº¿ç¨‹" tabindex="0" loading="lazy"><figcaption>å°çœ¼ç›èŠæŠ€æœ¯ï¼šRedis å•çº¿ç¨‹</figcaption></figure><p>ä¸ºäº†è¿›ä¸€æ­¥è§£å†³ç½‘ç»œ IO çš„æ€§èƒ½ç“¶é¢ˆï¼ŒRedis 6.0 å¼•å…¥äº†å¤šçº¿ç¨‹æœºåˆ¶ï¼ŒæŠŠç½‘ç»œ IO å’Œå‘½ä»¤æ‰§è¡Œåˆ†å¼€ï¼Œç½‘ç»œ IO äº¤ç»™çº¿ç¨‹æ± æ¥å¤„ç†ï¼Œè€Œå‘½ä»¤æ‰§è¡Œä»ç„¶åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œï¼Œè¿™æ ·å°±å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„æ€§èƒ½ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250430145654.png" alt="å°çœ¼ç›èŠæŠ€æœ¯ï¼šRedis6.0 å¼•å…¥äº†å¤šçº¿ç¨‹" tabindex="0" loading="lazy"><figcaption>å°çœ¼ç›èŠæŠ€æœ¯ï¼šRedis6.0 å¼•å…¥äº†å¤šçº¿ç¨‹</figcaption></figure><p>ä¸»çº¿ç¨‹ä¸“æ³¨äºå‘½ä»¤æ‰§è¡Œï¼Œç½‘ç»œIO ç”±å…¶ä»–çº¿ç¨‹åˆ†æ‹…ï¼Œåœ¨å¤šæ ¸ CPU ç¯å¢ƒä¸‹ï¼ŒRedis çš„æ€§èƒ½å¯ä»¥å¾—åˆ°æ˜¾è‘—æå‡ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250430151846.png" alt="lxkkaï¼šRedis io çº¿ç¨‹å’Œä¸»çº¿ç¨‹çš„å…³ç³»" tabindex="0" loading="lazy"><figcaption>lxkkaï¼šRedis io çº¿ç¨‹å’Œä¸»çº¿ç¨‹çš„å…³ç³»</figcaption></figure><p>ç¬¬ä¸‰ï¼ŒRedis å¯¹åº•å±‚æ•°æ®ç»“æ„åšäº†æè‡´çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚è¯´ String çš„åº•å±‚æ•°æ®ç»“æ„åŠ¨æ€å­—ç¬¦ä¸²æ”¯æŒåŠ¨æ€æ‰©å®¹ã€é¢„åˆ†é…å†—ä½™ç©ºé—´ï¼Œèƒ½å¤Ÿå‡å°‘å†…å­˜ç¢ç‰‡å’Œå†…å­˜åˆ†é…çš„å¼€é”€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250430152926.png" alt="å¤æ˜åœ°ç›†ï¼šRedis çš„æ•°æ®ç±»å‹å’Œåº•å±‚æ•°æ®ç»“æ„" tabindex="0" loading="lazy"><figcaption>å¤æ˜åœ°ç›†ï¼šRedis çš„æ•°æ®ç±»å‹å’Œåº•å±‚æ•°æ®ç»“æ„</figcaption></figure><p>æ€»ç»“ï¼š</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504095007.png" alt="Backend Scaling Playbookï¼šRedis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«" tabindex="0" loading="lazy"><figcaption>Backend Scaling Playbookï¼šRedis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«</figcaption></figure><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯ Java åç«¯å®ä¹ ä¸€é¢åŸé¢˜ï¼šRedis ä¸ºä»€ä¹ˆè¯»å†™æ€§èƒ½é«˜ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆ redis å¿«ï¼Œæ·˜æ±°ç­–ç•¥ æŒä¹…åŒ–</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šå•çº¿ç¨‹çš„ Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¾®ä¼—é“¶è¡ŒåŒå­¦ 1 Java åç«¯ä¸€é¢çš„åŸé¢˜ï¼šRedis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç™¾åº¦é¢ç»åŒå­¦ 1 æ–‡å¿ƒä¸€è¨€ 25 å®ä¹  Java åç«¯é¢è¯•åŸé¢˜ï¼šé¡¹ç›®ä¸­ä»€ä¹ˆåœ°æ–¹ä½¿ç”¨äº† redis ç¼“å­˜ï¼Œredis ä¸ºä»€ä¹ˆå¿«ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 8 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis ä¸ºä»€ä¹ˆå¿«</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 21 æŠ–éŸ³å•†åŸä¸€é¢é¢è¯•åŸé¢˜ï¼šredisä¸ºä»€ä¹ˆèƒ½å¤„ç†é«˜å¹¶å‘</li></ol></blockquote><p>memoï¼š2025 å¹´ 4 æœˆ 30 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘ä¿¡æ¯</a>è¯´æ‹¿åˆ°äº†æ»´æ»´çš„å®ä¹  offerï¼ŒçœŸçš„æ­å–œäº†ğŸ‰ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250501102228.png" alt="çƒå‹æ‹¿åˆ°äº†æ»´æ»´çš„æš‘æœŸå®ä¹  offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†æ»´æ»´çš„æš‘æœŸå®ä¹  offer</figcaption></figure><h3 id="_5-èƒ½è¯¦ç»†è¯´ä¸€ä¸‹ioå¤šè·¯å¤ç”¨å—" tabindex="-1"><a class="header-anchor" href="#_5-èƒ½è¯¦ç»†è¯´ä¸€ä¸‹ioå¤šè·¯å¤ç”¨å—"><span>5.èƒ½è¯¦ç»†è¯´ä¸€ä¸‹IOå¤šè·¯å¤ç”¨å—ï¼Ÿ</span></a></h3><p>IO å¤šè·¯å¤ç”¨æ˜¯ä¸€ç§å…è®¸å•ä¸ªè¿›ç¨‹åŒæ—¶ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æŠ€æœ¯ï¼Œä½¿å¾—ç¨‹åºèƒ½å¤Ÿé«˜æ•ˆå¤„ç†å¤šä¸ªå¹¶å‘è¿æ¥è€Œæ— éœ€åˆ›å»ºå¤§é‡çº¿ç¨‹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250501104352.png" alt="Journey-Cï¼šIO å¤šè·¯å¤ç”¨" tabindex="0" loading="lazy"><figcaption>Journey-Cï¼šIO å¤šè·¯å¤ç”¨</figcaption></figure><p>IO å¤šè·¯å¤ç”¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šè®©å•ä¸ªçº¿ç¨‹å¯ä»¥ç­‰å¾…å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼Œç„¶åå¯¹å°±ç»ªçš„æè¿°ç¬¦è¿›è¡Œæ“ä½œã€‚è¿™æ ·å¯ä»¥åœ¨ä¸ä½¿ç”¨å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹çš„æƒ…å†µä¸‹å¤„ç†å¹¶å‘è¿æ¥ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250501104549.png" alt="è›®è†ï¼šIO å¤šè·¯å¤ç”¨å’Œå¤šçº¿ç¨‹" tabindex="0" loading="lazy"><figcaption>è›®è†ï¼šIO å¤šè·¯å¤ç”¨å’Œå¤šçº¿ç¨‹</figcaption></figure><p>ä¸»è¦çš„å®ç°æœºåˆ¶åŒ…æ‹¬ selectã€pollã€epollã€kqueue å’Œ IOCP ç­‰ã€‚</p><h4 id="è¯·è¯´è¯´-selectã€pollã€epollã€kqueue-å’Œ-iocp-çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#è¯·è¯´è¯´-selectã€pollã€epollã€kqueue-å’Œ-iocp-çš„åŒºåˆ«"><span>è¯·è¯´è¯´ selectã€pollã€epollã€kqueue å’Œ IOCP çš„åŒºåˆ«ï¼Ÿ</span></a></h4><p>select çš„ç¼ºç‚¹æ˜¯å•ä¸ªè¿›ç¨‹èƒ½ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡æœ‰é™ï¼Œä¸€èˆ¬ä¸º 1024 ä¸ªï¼Œä¸”æ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆä»ç”¨æˆ·æ€å¤åˆ¶åˆ°å†…æ ¸æ€ï¼Œç„¶åéå†æ‰¾å‡ºå°±ç»ªçš„æè¿°ç¬¦ï¼Œæ€§èƒ½è¾ƒå·®ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// select çš„åŸºæœ¬ä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> nfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> fd_set </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">readfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> fd_set </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">writefds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">           fd_set </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">exceptfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> timeval </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ç¤ºä¾‹ä»£ç </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">fd_set readfds;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">FD_ZERO</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">readfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // æ¸…ç©ºé›†åˆ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">FD_SET</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sockfd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">readfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         // æ·»åŠ ç›‘å¬å¥—æ¥å­—</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sockfd </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">readfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">FD_ISSET</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sockfd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">readfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) {</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // æ£€æŸ¥æ˜¯å¦å°±ç»ª</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å¤„ç†è¯»äº‹ä»¶</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>poll çš„ä¼˜ç‚¹æ˜¯æ²¡æœ‰æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ï¼Œä½†æ˜¯æ¯æ¬¡è°ƒç”¨ä»ç„¶éœ€è¦å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆä»ç”¨æˆ·æ€å¤åˆ¶åˆ°å†…æ ¸æ€ï¼Œä¾ç„¶éœ€è¦éå†ï¼Œæ€§èƒ½ä»ç„¶è¾ƒå·®ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// poll çš„åŸºæœ¬ä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> poll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> pollfd </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">fds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> nfds_t</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> nfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ç¤ºä¾‹ä»£ç </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pollfd </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[MAX_EVENTS];</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].fd </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sockfd;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].events </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> POLLIN;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç›‘å¬è¯»äº‹ä»¶</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">poll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">fds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].revents </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> POLLIN) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å¤„ç†è¯»äº‹ä»¶</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>epoll æ˜¯ Linux ç‰¹æœ‰çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œæ”¯æŒå¤§è§„æ¨¡å¹¶å‘è¿æ¥ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œæ€§èƒ½æ›´é«˜ã€‚å…¶å·¥ä½œåŸç†æ˜¯å°†æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ°å†…æ ¸ä¸­ï¼Œç„¶åé€šè¿‡äº‹ä»¶é€šçŸ¥æœºåˆ¶æ¥å¤„ç†å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸éœ€è¦è½®è¯¢ï¼Œä¹Ÿä¸éœ€è¦æ•°æ®æ‹·è´ï¼Œæ›´æ²¡æœ‰æ•°é‡é™åˆ¶ï¼Œæ‰€ä»¥æ€§èƒ½éå¸¸é«˜ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// epoll çš„åŸºæœ¬ä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> epoll_create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> epoll_ctl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> epfd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> op</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> fd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> epoll_event </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">event</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> epoll_wait</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> epfd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> epoll_event </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">events</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> maxevents</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ç¤ºä¾‹ä»£ç </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> epfd </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> epoll_create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> epoll_event ev, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">events</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[MAX_EVENTS];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ev.events </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> EPOLLIN;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ev.data.fd </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sockfd;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">epoll_ctl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">epfd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> EPOLL_CTL_ADD</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> sockfd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">ev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nfds </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> epoll_wait</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(epfd, events, MAX_EVENTS, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nfds; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">events</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fd</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sockfd) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // å¤„ç†è¯»äº‹ä»¶</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>kqueue æ˜¯ BSD/macOS ç³»ç»Ÿä¸‹çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œç±»ä¼¼äº epollï¼Œæ”¯æŒå¤§è§„æ¨¡å¹¶å‘è¿æ¥ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å‹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> kqueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> kevent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> kq</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> kevent </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">changelist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> nchanges</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> kevent </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">eventlist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> nevents</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> timespec </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>IOCP æ˜¯ Windows ç³»ç»Ÿä¸‹çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä½¿ç”¨ä½¿ç”¨å®Œæˆç«¯å£æ¨¡å‹è€Œéäº‹ä»¶é€šçŸ¥ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">HANDLE </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CreateIoCompletionPort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">HANDLE </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">FileHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> HANDLE </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">ExistingCompletionPort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> ULONG_PTR </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">CompletionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> DWORD </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">NumberOfConcurrentThreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="ä¸¾ä¸ªä¾‹å­è¯´ä¸€ä¸‹-io-å¤šè·¯å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#ä¸¾ä¸ªä¾‹å­è¯´ä¸€ä¸‹-io-å¤šè·¯å¤ç”¨"><span>ä¸¾ä¸ªä¾‹å­è¯´ä¸€ä¸‹ IO å¤šè·¯å¤ç”¨ï¼Ÿ</span></a></h4><p>æ¯”å¦‚è¯´æˆ‘æ˜¯ä¸€åæ•°å­¦è€å¸ˆï¼Œä¸Šè¯¾æ—¶æå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼šâ€œä»Šå¤©è°æ¥è¯æ˜ä¸€ä¸‹å‹¾è‚¡å®šå¾‹ï¼Ÿâ€</p><p>åŒå­¦å°ç‹ä¸¾æ‰‹ï¼Œæˆ‘å°±è®©å°ç‹å›ç­”ï¼›å°æä¸¾æ‰‹ï¼Œæˆ‘å°±è®©å°æå›ç­”ï¼›å°å¼ ä¸¾æ‰‹ï¼Œæˆ‘å°±è®©å°å¼ å›ç­”ã€‚</p><p>è¿™ç§æ¨¡å¼å°±æ˜¯ IO å¤šè·¯å¤ç”¨ï¼Œæˆ‘åªéœ€è¦åœ¨è®²å°ä¸Šç­‰ï¼Œè°ä¸¾æ‰‹è°å›ç­”ï¼Œä¸éœ€è¦ä¸€ä¸ªä¸€ä¸ªå»é—®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240918114125.png" alt="æœ‰ç›å…ˆç”Ÿï¼šIO å¤šè·¯å¤ç”¨" tabindex="0" loading="lazy"><figcaption>æœ‰ç›å…ˆç”Ÿï¼šIO å¤šè·¯å¤ç”¨</figcaption></figure><p>Redis å°±æ˜¯ä½¿ç”¨ epoll è¿™æ ·çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåœ¨å•çº¿ç¨‹æ¨¡å‹ä¸‹å®ç°é«˜æ•ˆçš„ç½‘ç»œ IOï¼Œä»è€Œæ”¯æŒé«˜å¹¶å‘çš„è¯·æ±‚å¤„ç†ã€‚</p><h4 id="ä¸¾ä¾‹å­è¯´ä¸€ä¸‹é˜»å¡-ioå’Œ-io-å¤šè·¯å¤ç”¨çš„å·®åˆ«" tabindex="-1"><a class="header-anchor" href="#ä¸¾ä¾‹å­è¯´ä¸€ä¸‹é˜»å¡-ioå’Œ-io-å¤šè·¯å¤ç”¨çš„å·®åˆ«"><span>ä¸¾ä¾‹å­è¯´ä¸€ä¸‹é˜»å¡ IOå’Œ IO å¤šè·¯å¤ç”¨çš„å·®åˆ«ï¼Ÿ</span></a></h4><p>å‡è®¾æˆ‘æ˜¯ä¸€åè€å¸ˆï¼Œè®©å­¦ç”Ÿè§£ç­”ä¸€é“é¢˜ç›®ã€‚</p><p>æˆ‘çš„ç¬¬ä¸€ç§é€‰æ‹©ï¼šæŒ‰é¡ºåºé€ä¸ªæ£€æŸ¥ï¼Œå…ˆæ£€æŸ¥ AåŒå­¦ï¼Œç„¶åæ˜¯ Bï¼Œä¹‹åæ˜¯ Cã€Dã€‚ã€‚ã€‚è¿™ä¸­é—´å¦‚æœæœ‰ä¸€ä¸ªå­¦ç”Ÿå¡ä½ï¼Œå…¨ç­éƒ½ä¼šè¢«è€½è¯¯ã€‚</p><p>è¿™ç§å°±æ˜¯é˜»å¡ IOï¼Œä¸å…·æœ‰å¹¶å‘èƒ½åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-eb541432-d68a-4dd9-b427-96c4dd607d64.png" alt="é˜»å¡ IOå’Œ IOå¤šè·¯å¤ç”¨å·®åˆ«" tabindex="0" loading="lazy"><figcaption>é˜»å¡ IOå’Œ IOå¤šè·¯å¤ç”¨å·®åˆ«</figcaption></figure><p>æˆ‘çš„ç¬¬äºŒç§é€‰æ‹©ï¼Œæˆ‘ç«™åœ¨è®²å°ä¸Šç­‰ï¼Œè°ä¸¾æ‰‹æˆ‘å»æ£€æŸ¥è°ã€‚Cã€D ä¸¾æ‰‹ï¼Œæˆ‘å»æ£€æŸ¥ Cã€D çš„ç­”æ¡ˆï¼Œç„¶åç»§ç»­å›åˆ°è®²å°ä¸Šç­‰ã€‚æ­¤æ—¶ Eã€A åˆä¸¾æ‰‹ï¼Œç„¶åå»å¤„ç† E å’Œ Aã€‚</p><h4 id="selectã€poll-å’Œ-epoll-çš„å®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#selectã€poll-å’Œ-epoll-çš„å®ç°åŸç†"><span>selectã€poll å’Œ epoll çš„å®ç°åŸç†ï¼Ÿ</span></a></h4><p>select å’Œ poll éƒ½æ˜¯é€šè¿‡æŠŠæ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™å†…æ ¸ï¼Œç”±å†…æ ¸éå†åˆ¤æ–­å“ªäº›å°±ç»ªã€‚</p><p>select å°†æ–‡ä»¶æè¿°ç¬¦ FD é€šè¿‡ BitsMap ä¼ å…¥å†…æ ¸ï¼Œè½®è¯¢æ‰€æœ‰çš„ FDï¼Œé€šè¿‡è°ƒç”¨ file-&gt;poll å‡½æ•°æŸ¥è¯¢æ˜¯å¦æœ‰å¯¹åº”äº‹ä»¶ï¼Œæ²¡æœ‰å°±å°† task åŠ å…¥ FD å¯¹åº” file çš„å¾…å”¤é†’é˜Ÿåˆ—ï¼Œç­‰å¾…äº‹ä»¶æ¥ä¸´è¢«å”¤é†’ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250501113356.png" alt="journey-cï¼šselect" tabindex="0" loading="lazy"><figcaption>journey-cï¼šselect</figcaption></figure><p>poll æ”¹è¿›äº†è¿æ¥æ•°ä¸Šé™é—®é¢˜ï¼Œä¸å†ç”¨ BitsMap æ¥ä¼ å…¥ FDï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åŠ¨æ€æ•°ç»„ pollfdï¼Œä½†æœ¬è´¨ä¸Šä»æ˜¯çº¿æ€§éå†ï¼Œæ€§èƒ½æ²¡æœ‰æå‡å¤ªå¤šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250501113618.png" alt="journey-cï¼špoll" tabindex="0" loading="lazy"><figcaption>journey-cï¼špoll</figcaption></figure><p>selectå’Œpollçš„æ¨¡å¼éƒ½æ˜¯ï¼Œä¸€æ¬¡å°†å‚æ•°æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œç­‰æœ‰ç»“æœäº†å†ä¸€æ¬¡æ‹·è´å‡ºå»ã€‚</p><p>epoll å°†ç›‘å¬çš„ FD æ³¨å†Œè¿›å†…æ ¸çš„çº¢é»‘æ ‘ï¼Œç”±å†…æ ¸åœ¨äº‹ä»¶è§¦å‘æ—¶å°†å°±ç»ªçš„ FD æ”¾å…¥ ready listã€‚åº”ç”¨ç¨‹åºé€šè¿‡ epoll_wait è·å–å°±ç»ªçš„ FDï¼Œä»è€Œé¿å…éå†æ‰€æœ‰è¿æ¥çš„å¼€é”€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250501113710.png" alt="journey-cï¼šepoll" tabindex="0" loading="lazy"><figcaption>journey-cï¼šepoll</figcaption></figure><p>epoll æœ€å¤§çš„ä¼˜ç‚¹æ˜¯ï¼šæ”¯æŒäº‹ä»¶é©±åŠ¨ + è¾¹ç¼˜è§¦å‘ï¼ŒADD æ—¶æ‹·è´ä¸€æ¬¡ï¼Œepoll_wait æ—¶åˆ©ç”¨ MMAP å’Œç”¨æˆ·å…±äº«ç©ºé—´ï¼Œç›´æ¥æ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå› æ­¤åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½è¿œé«˜äº select å’Œ pollã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 21 æŠ–éŸ³å•†åŸä¸€é¢é¢è¯•åŸé¢˜ï¼šioå¤šè·¯å¤ç”¨äº†è§£å—ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¿«æ‰‹åŒå­¦ 4 ä¸€é¢åŸé¢˜ï¼šIOå¤šè·¯å¤ç”¨ä¸­select/poll/epollå„è‡ªçš„å®ç°åŸç†å’ŒåŒºåˆ«ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦19ç•ªèŒ„å°è¯´ä¸€é¢é¢è¯•åŸé¢˜ï¼šLinuxä¸­çš„IOå¤šè·¯å¤ç”¨</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 1 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">å¸®çƒå‹ä¿®æ”¹ç®€å†æ—¶</a> æ—¶ï¼Œç¢°åˆ°ä¸€ååŒ—äº¬äº¤é€šå¤§å­¦çš„åŒå­¦ï¼Œåˆä¸€æ‰€ 211 é™¢æ ¡ï¼Œæ˜ŸçƒçœŸçš„æ˜¯äººæ‰æµæµï¼Œå¤§å®¶ä¸€èµ·åŠ æ²¹å§ï¼ˆéª„å‚²ï¼‰ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250502100516.png" alt="åŒ—äº¬äº¤é€šå¤§å­¦çš„çƒå‹" tabindex="0" loading="lazy"><figcaption>åŒ—äº¬äº¤é€šå¤§å­¦çš„çƒå‹</figcaption></figure><h3 id="_6-redisä¸ºä»€ä¹ˆæ—©æœŸé€‰æ‹©å•çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#_6-redisä¸ºä»€ä¹ˆæ—©æœŸé€‰æ‹©å•çº¿ç¨‹"><span>6.Redisä¸ºä»€ä¹ˆæ—©æœŸé€‰æ‹©å•çº¿ç¨‹ï¼Ÿ</span></a></h3><p>ç¬¬ä¸€ï¼Œå•çº¿ç¨‹æ¨¡å‹ä¸éœ€è¦è€ƒè™‘å¤æ‚çš„é”æœºåˆ¶ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ­»é”ã€ç«æ€æ¡ä»¶ç­‰é—®é¢˜ï¼Œå¼€å‘èµ·æ¥æ›´å¿«ï¼Œä¹Ÿæ›´å®¹æ˜“ç»´æŠ¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250502100006.png" alt="wsh-study.comï¼šRedisçš„å•çº¿ç¨‹æ¨¡å‹" tabindex="0" loading="lazy"><figcaption>wsh-study.comï¼šRedisçš„å•çº¿ç¨‹æ¨¡å‹</figcaption></figure><p>ç¬¬äºŒï¼ŒRedis æ˜¯IO å¯†é›†å‹è€Œé CPU å¯†é›†å‹ï¼Œä¸»è¦å—å†…å­˜å’Œç½‘ç»œ IO é™åˆ¶ï¼Œè€Œé CPU çš„è®¡ç®—èƒ½åŠ›ï¼Œå•çº¿ç¨‹å¯ä»¥é¿å…çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚</p><p>å“ªæ€•æˆ‘ä»¬åœ¨ä¸€ä¸ªæ™®é€šçš„ Linux æœåŠ¡å™¨ä¸Šå¯åŠ¨ Redis æœåŠ¡ï¼Œå®ƒä¹Ÿèƒ½åœ¨ 1s å†…å¤„ç† 1000000 ä¸ªç”¨æˆ·è¯·æ±‚ã€‚</p><p>ç¬¬ä¸‰ï¼Œå•çº¿ç¨‹å¯ä»¥ä¿è¯å‘½ä»¤æ‰§è¡Œçš„åŸå­æ€§ï¼Œæ— éœ€é¢å¤–çš„åŒæ­¥æœºåˆ¶ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-344b8461-98d4-495b-a697-70275b0abad6.png" alt="å®˜æ–¹å•çº¿ç¨‹è§£é‡Š" tabindex="0" loading="lazy"><figcaption>å®˜æ–¹å•çº¿ç¨‹è§£é‡Š</figcaption></figure><p>Redis è™½ç„¶æœ€åˆé‡‡ç”¨äº†å•çº¿ç¨‹è®¾è®¡ï¼Œä½†åç»­çš„ç‰ˆæœ¬ä¸­ä¹Ÿåœ¨ç‰¹å®šæ–¹é¢å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œæ¯”å¦‚è¯´ Redis 4.0 å°±å¼•å¼‚æ­¥å¤šçº¿ç¨‹ï¼Œç”¨äºæ¸…ç†è„æ•°æ®ã€é‡Šæ”¾æ— ç”¨è¿æ¥ã€åˆ é™¤å¤§ Key ç­‰ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/* ä»æ•°æ®åº“ä¸­åˆ é™¤ä¸€ä¸ªé”®ã€å€¼ä»¥åŠç›¸å…³çš„è¿‡æœŸæ¡ç›®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * å¦‚æœé‡Šæ”¾å€¼å¯¹è±¡éœ€è¦å¤§é‡çš„å†…å­˜åˆ†é…æ“ä½œï¼Œè¯¥å¯¹è±¡å¯èƒ½ä¼šè¢«æ”¾å…¥</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * å»¶è¿Ÿé‡Šæ”¾åˆ—è¡¨ä¸­ï¼Œè€Œä¸æ˜¯åŒæ­¥é‡Šæ”¾ã€‚å»¶è¿Ÿé‡Šæ”¾åˆ—è¡¨å°†åœ¨</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * bio.c çš„å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿›è¡Œå›æ”¶ã€‚ */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> LAZYFREE_THRESHOLD</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 64</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> dbAsyncDelete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">redisDb </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> robj </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /* ä»è¿‡æœŸå­—å…¸ä¸­åˆ é™¤æ¡ç›®ä¸ä¼šé‡Šæ”¾é”®çš„ sdsï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * å› ä¸ºå®ƒä¸ä¸»å­—å…¸å…±äº«ã€‚ */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dictSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">expires</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dictDelete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">expires</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /* å¦‚æœå€¼å¯¹è±¡åªåŒ…å«å°‘é‡çš„å†…å­˜åˆ†é…ï¼Œä½¿ç”¨å»¶è¿Ÿé‡Šæ”¾æ–¹å¼</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * å®é™…ä¸Šä¼šæ›´æ…¢... æ‰€ä»¥åœ¨ä¸€å®šé˜ˆå€¼ä»¥ä¸‹ï¼Œæˆ‘ä»¬å°±ç›´æ¥</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * åŒæ­¥é‡Šæ”¾å¯¹è±¡ã€‚ */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    dictEntry </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">de </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> dictUnlink</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dict</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (de) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        robj </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> dictGetVal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(de);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // è®¡ç®—valueçš„å›æ”¶æ”¶ç›Š</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> free_effort </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lazyfreeGetFreeEffort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(val);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        /* å¦‚æœé‡Šæ”¾å¯¹è±¡çš„å·¥ä½œé‡å¤ªå¤§ï¼Œå°±é€šè¿‡å°†å¯¹è±¡æ·»åŠ åˆ°å»¶è¿Ÿé‡Šæ”¾åˆ—è¡¨</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         * åœ¨åå°è¿›è¡Œå¤„ç†ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         * æ³¨æ„ï¼Œå¦‚æœå¯¹è±¡æ˜¯å…±äº«çš„ï¼Œç°åœ¨å°±å›æ”¶å®ƒæ˜¯ä¸å¯èƒ½çš„ã€‚è¿™ç§æƒ…å†µ</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         * å¾ˆå°‘å‘ç”Ÿï¼Œä½†æ˜¯æœ‰æ—¶ Redis æ ¸å¿ƒçš„æŸäº›å®ç°éƒ¨åˆ†å¯èƒ½ä¼šè°ƒç”¨</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         * incrRefCount() æ¥ä¿æŠ¤å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ dbDelete()ã€‚åœ¨è¿™ç§</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         * æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šç»§ç»­æ‰§è¡Œå¹¶åˆ°è¾¾ dictFreeUnlinkedEntry() </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         * è°ƒç”¨ï¼Œè¿™ç›¸å½“äºä»…ä»…è°ƒç”¨ decrRefCount()ã€‚ */</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // åªæœ‰å›æ”¶æ”¶ç›Šè¶…è¿‡ä¸€å®šå€¼ï¼Œæ‰ä¼šæ‰§è¡Œå¼‚æ­¥åˆ é™¤ï¼Œå¦åˆ™è¿˜æ˜¯ä¼šé€€åŒ–åˆ°åŒæ­¥åˆ é™¤</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (free_effort </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> LAZYFREE_THRESHOLD </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">refcount</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            atomicIncr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(lazyfree_objects,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            bioCreateBackgroundJob</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(BIO_LAZY_FREE,val,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            dictSetVal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dict</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,de,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /* é‡Šæ”¾é”®å€¼å¯¹ï¼Œå¦‚æœæˆ‘ä»¬å°† val å­—æ®µè®¾ç½®ä¸º NULL ä»¥ä¾¿ç¨å</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * å»¶è¿Ÿé‡Šæ”¾ï¼Œé‚£ä¹ˆå°±åªé‡Šæ”¾é”®ã€‚ */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (de) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        dictFreeUnlinkedEntry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dict</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,de);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cluster_enabled</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">slotToKeyDel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®˜æ–¹è§£é‡Šï¼š<a href="https://redis.io/topics/faq" target="_blank" rel="noopener noreferrer">https://redis.io/topics/faq</a></p><p>memoï¼š2025 å¹´ 5 æœˆ 2 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">å¸®çƒå‹ä¿®æ”¹ç®€å†æ—¶</a> æ—¶ï¼Œç¢°åˆ°ä¸€ååŒæµå¤§å­¦çš„åŒå­¦ï¼Œè®©æ„Ÿè§‰è‡ªå·±çš„ä»˜å‡ºæ­£åœ¨è¶Šæ¥è¶Šå¤šè¢«æ›´å¤šäººçœ‹åˆ°ï¼ŒçœŸçš„å¾ˆå¼€å¿ƒã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250503091439.png" alt="åŒæµå¤§å­¦çš„çƒå‹æ¥äº†" tabindex="0" loading="lazy"><figcaption>åŒæµå¤§å­¦çš„çƒå‹æ¥äº†</figcaption></figure><h3 id="_7-redis-6-0-ä½¿ç”¨å¤šçº¿ç¨‹æ˜¯æ€ä¹ˆå›äº‹" tabindex="-1"><a class="header-anchor" href="#_7-redis-6-0-ä½¿ç”¨å¤šçº¿ç¨‹æ˜¯æ€ä¹ˆå›äº‹"><span>7.Redis 6.0 ä½¿ç”¨å¤šçº¿ç¨‹æ˜¯æ€ä¹ˆå›äº‹?</span></a></h3><p>Redis 6.0 çš„å¤šçº¿ç¨‹ä»…ç”¨äºå¤„ç†ç½‘ç»œ IOï¼ŒåŒ…æ‹¬ç½‘ç»œæ•°æ®çš„è¯»å–ã€å†™å…¥ï¼Œä»¥åŠè¯·æ±‚è§£æã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>â”‚ å•çº¿ç¨‹æ‰§è¡Œå‘½ä»¤ â”‚</span></span>
<span class="line"><span>                  â”‚    â†‘    â†“     â”‚</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”</span></span>
<span class="line"><span>â”‚ I/Oçº¿ç¨‹1 â”‚ â†â†’ â”‚                 â”‚</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚                 â”‚</span></span>
<span class="line"><span>â”‚ I/Oçº¿ç¨‹2 â”‚ â†â†’ â”‚    ä¸»çº¿ç¨‹       â”‚</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚                 â”‚</span></span>
<span class="line"><span>â”‚ I/Oçº¿ç¨‹3 â”‚ â†â†’ â”‚                 â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è€Œå‘½ä»¤çš„æ‰§è¡Œä¾ç„¶æ˜¯å•çº¿ç¨‹ï¼Œè¿™ç§è®¾è®¡è¢«ç§°ä¸ºâ€œIO çº¿ç¨‹åŒ–â€ï¼Œèƒ½å¤Ÿåœ¨é«˜è´Ÿè½½çš„æƒ…å†µä¸‹ï¼Œæœ€å¤§é™åº¦åœ°æå‡ Redis çš„å“åº”é€Ÿåº¦ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b7b24e25-d2dc-4457-994f-95bdb3674b8e.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis6.0å¤šçº¿ç¨‹" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis6.0å¤šçº¿ç¨‹</figcaption></figure><p>---- è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ start ----</p><p>è¿™ä¸€å˜åŒ–ä¸»è¦æ˜¯å› ä¸ºéšç€ç½‘ç»œå¸¦å®½å’ŒæœåŠ¡å™¨æ€§èƒ½çš„æå‡ï¼ŒRedis çš„ç“¶é¢ˆä» CPU é€æ¸è½¬ç§»åˆ°äº†ç½‘ç»œ IOï¼š</p><ul><li>å¸¦å®½ä» 10Gbps æå‡åˆ° 100Gbpsï¼Œç”šè‡³æ›´é«˜ã€‚</li><li>è¯·æ±‚çš„å¹¶å‘æ•°ä»å‡ åƒåˆ°å‡ ä¸‡ï¼Œç”šè‡³å‡ åä¸‡ã€‚</li></ul><p>å•çº¿ç¨‹åœ¨é«˜è´Ÿè½½åœºæ™¯ä¸‹å¤„ç†ç½‘ç»œ IO å‡ºç°äº†æ˜æ˜¾çš„æ€§èƒ½ç“¶é¢ˆï¼ŒRedis çš„å¼€å‘å›¢é˜Ÿé€šè¿‡ç ”ç©¶å‘ç°ï¼Œåœ¨å¤„ç†å¤§æ•°æ®åŒ…æ—¶ï¼Œå•çº¿ç¨‹ Redis æœ‰è¶…è¿‡ 80% çš„ CPU æ—¶é—´èŠ±åœ¨ç½‘ç»œ IO ä¸Šï¼Œè€Œå®é™…å‘½ä»¤æ‰§è¡Œä»…å  20% å·¦å³ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250502095838.png" alt="wsh-study.comï¼šRedis 6.0çš„å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹" tabindex="0" loading="lazy"><figcaption>wsh-study.comï¼šRedis 6.0çš„å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹</figcaption></figure><p>Redis 6.0 çš„å¤šçº¿ç¨‹ IO æ¨¡å‹ä¸»è¦åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š</p><ul><li>ä»ç„¶ç”±ä¸»çº¿ç¨‹è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚</li><li>ä¸»çº¿ç¨‹å°†è¿æ¥è¯·æ±‚åˆ†å‘ç»™å¤šä¸ª IO çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸»çº¿ç¨‹è´Ÿè´£è§£æå’Œæ‰§è¡Œå‘½ä»¤ã€‚</li><li>å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œç”±å¤šä¸ª IO çº¿ç¨‹å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ul><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Redis ä¸»äº‹ä»¶å¾ªç¯ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> beforeSleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> aeEventLoop </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // 1. ä¸»çº¿ç¨‹åˆ†æ´¾è¯»ä»»åŠ¡ç»™ I/O çº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    handleClientsWithPendingReadsUsingThreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // 2. ç­‰å¾… I/O çº¿ç¨‹å®Œæˆè¯»å–</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    waitForIOThreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // 3. ä¸»çº¿ç¨‹å¤„ç†å‘½ä»¤</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    processInputBuffer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // 4. ä¸»çº¿ç¨‹åˆ†æ´¾å†™ä»»åŠ¡ç»™ I/O çº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    handleClientsWithPendingWritesUsingThreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redis 6.0 é»˜è®¤ä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼ï¼Œä½†å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æˆ–å‘½ä»¤è¡Œå‚æ•°å¯ç”¨å¤šçº¿ç¨‹æ¨¡å¼ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># å¯ç”¨å¤šçº¿ç¨‹æ¨¡å¼</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">io-threads</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># å¯ç”¨å¤šçº¿ç¨‹å†™å…¥ï¼ˆRedis 6.0 é»˜è®¤åªå¼€å¯å¤šçº¿ç¨‹è¯»å–ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">io-threads-do-reads</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å»ºè®®å°† IO çº¿ç¨‹æ•°è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°çš„ä¸€åŠï¼Œä¸€èˆ¬ä¸å»ºè®®è¶…è¿‡ 8 ä¸ªã€‚</p><p>ç»è¿‡å¤šæ¬¡æµ‹è¯•ï¼ŒRedis 6.0 åœ¨å¤„ç† 1-200 å­—èŠ‚çš„å°æ•°æ®åŒ…æ—¶ï¼Œæ€§èƒ½æå‡ 1.5-2 å€ï¼›åœ¨å¤„ç† 1KB ä»¥ä¸Šçš„å¤§æ•°æ®åŒ…æ—¶æå‡çº¦ 3-5 å€ã€‚</p><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ end ----</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šredis6.0å¼•å…¥çš„å¤šçº¿ç¨‹ç”¨ä½œä»€ä¹ˆåœ°æ–¹</li></ol></blockquote><h3 id="_8-è¯´è¯´-redis-çš„å¸¸ç”¨å‘½ä»¤-è¡¥å……" tabindex="-1"><a class="header-anchor" href="#_8-è¯´è¯´-redis-çš„å¸¸ç”¨å‘½ä»¤-è¡¥å……"><span>8.è¯´è¯´ Redis çš„å¸¸ç”¨å‘½ä»¤ï¼ˆè¡¥å……ï¼‰</span></a></h3><blockquote><p>2024 å¹´ 04 æœˆ 11 æ—¥å¢è¡¥</p></blockquote><p>ä¸€å¥è¯å›ç­”ï¼ˆä¹Ÿä¸ç”¨å…¨éƒ¨éƒ½èƒŒï¼ŒæŒ‘ä¸‰ä¸ªå°±è¡Œï¼‰ï¼š</p><p>Redis æ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå¸¸ç”¨çš„å‘½ä»¤ä¹Ÿæ¯”è¾ƒå¤šï¼Œæ¯”å¦‚è¯´æ“ä½œå­—ç¬¦ä¸²å¯ä»¥ç”¨ <code>SET/GET/INCR</code>ï¼Œæ“ä½œå“ˆå¸Œå¯ä»¥ç”¨ <code>HSET/HGET/HGETALL</code>ï¼Œæ“ä½œåˆ—è¡¨å¯ä»¥ç”¨ <code>LPUSH/LPOP/LRANGE</code>ï¼Œæ“ä½œé›†åˆå¯ä»¥ç”¨ <code>SADD/SISMEMBER</code>ï¼Œæ“ä½œæœ‰åºé›†åˆå¯ä»¥ç”¨ <code>ZADD/ZRANGE/ZINCRBY</code>ç­‰ï¼Œé€šç”¨å‘½ä»¤æœ‰ <code>EXPIRE/DEL/KEYS</code> ç­‰ã€‚</p><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ start----</p><p>â‘ ã€æ“ä½œå­—ç¬¦ä¸²çš„å‘½ä»¤æœ‰ï¼š</p><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>SET key value</code></td><td>è®¾ç½®å­—ç¬¦ä¸²é”®å€¼</td><td><code>SET name jack</code></td></tr><tr><td><code>GET key</code></td><td>è·å–å­—ç¬¦ä¸²å€¼</td><td><code>GET name</code></td></tr><tr><td><code>INCR key</code></td><td>æ•°å€¼è‡ªå¢ 1</td><td><code>INCR count</code></td></tr><tr><td><code>DECR key</code></td><td>æ•°å€¼è‡ªå‡ 1</td><td><code>DECR stock</code></td></tr><tr><td><code>INCRBY key N</code></td><td>å¢åŠ  N</td><td><code>INCRBY views 10</code></td></tr><tr><td><code>APPEND key value</code></td><td>è¿½åŠ å­—ç¬¦ä¸²</td><td><code>APPEND log &quot;done&quot;</code></td></tr><tr><td><code>GETRANGE key start end</code></td><td>è·å–å­ä¸²</td><td><code>GETRANGE name 0 3</code></td></tr><tr><td><code>MSET k1 v1 k2 v2</code></td><td>æ‰¹é‡è®¾ç½®å¤šä¸ªé”®å€¼</td><td><code>MSET a 1 b 2</code></td></tr></tbody></table><p>â‘¡ã€æ“ä½œåˆ—è¡¨çš„å‘½ä»¤æœ‰ï¼š</p><ul><li><code>LPUSH key value</code>ï¼šå°†ä¸€ä¸ªå€¼æ’å…¥åˆ°åˆ—è¡¨ key çš„å¤´éƒ¨ã€‚</li><li><code>RPUSH key value</code>ï¼šå°†ä¸€ä¸ªå€¼æ’å…¥åˆ°åˆ—è¡¨ key çš„å°¾éƒ¨ã€‚</li><li><code>LPOP key</code>ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨ key çš„å¤´å…ƒç´ ã€‚</li><li><code>RPOP key</code>ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨ key çš„å°¾å…ƒç´ ã€‚</li><li><code>LRANGE key start stop</code>ï¼šè·å–åˆ—è¡¨ key ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ã€‚</li></ul><p>â‘¢ã€æ“ä½œé›†åˆçš„å‘½ä»¤æœ‰ï¼š</p><ul><li><code>SADD key member</code>ï¼šå‘é›†åˆ key æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚</li><li><code>SREM key member</code>ï¼šä»é›†åˆ key ä¸­ç§»é™¤ä¸€ä¸ªå…ƒç´ ã€‚</li><li><code>SMEMBERS key</code>ï¼šè¿”å›é›†åˆ key ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚</li></ul><p>â‘£ã€æ“ä½œæœ‰åºé›†åˆçš„å‘½ä»¤æœ‰ï¼š</p><ul><li><code>ZADD key score member</code>ï¼šå‘æœ‰åºé›†åˆ key æ·»åŠ ä¸€ä¸ªæˆå‘˜ï¼Œæˆ–æ›´æ–°å…¶åˆ†æ•°ã€‚</li><li><code>ZRANGE key start stop [WITHSCORES]</code>ï¼šæŒ‰ç…§ç´¢å¼•åŒºé—´è¿”å›æœ‰åºé›†åˆ key ä¸­çš„æˆå‘˜ï¼Œå¯é€‰ WITHSCORES å‚æ•°è¿”å›åˆ†æ•°ã€‚</li><li><code>ZREVRANGE key start stop [WITHSCORES]</code>ï¼šè¿”å›æœ‰åºé›†åˆ key ä¸­ï¼ŒæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ï¼ŒæŒ‰åˆ†æ•°é€’å‡ã€‚</li><li><code>ZREM key member</code>ï¼šç§»é™¤æœ‰åºé›†åˆ key ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ã€‚</li></ul><p>â‘¤ã€æ“ä½œå“ˆå¸Œçš„å‘½ä»¤æœ‰ï¼š</p><ul><li><code>HSET key field value</code>ï¼šå‘é”®ä¸º key çš„å“ˆå¸Œè¡¨ä¸­è®¾ç½®å­—æ®µ field çš„å€¼ä¸º valueã€‚</li><li><code>HGET key field</code>ï¼šè·å–é”®ä¸º key çš„å“ˆå¸Œè¡¨ä¸­å­—æ®µ field çš„å€¼ã€‚</li><li><code>HGETALL key</code>ï¼šè·å–é”®ä¸º key çš„å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„å­—æ®µå’Œå€¼ã€‚</li><li><code>HDEL key field</code>ï¼šåˆ é™¤é”®ä¸º key çš„å“ˆå¸Œè¡¨ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µã€‚</li></ul><h4 id="è¯¦ç»†è¯´è¯´-set-å‘½ä»¤" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†è¯´è¯´-set-å‘½ä»¤"><span>è¯¦ç»†è¯´è¯´ set å‘½ä»¤ï¼Ÿ</span></a></h4><p>SET å‘½ä»¤ç”¨äºè®¾ç½®å­—ç¬¦ä¸²çš„ keyï¼Œæ”¯æŒè¿‡æœŸæ—¶é—´å’Œæ¡ä»¶å†™å…¥ï¼Œå¸¸ç”¨äºè®¾ç½®ç¼“å­˜ã€å®ç°åˆ†å¸ƒå¼é”ã€å»¶é•¿ Session ç­‰åœºæ™¯ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> key</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [EX </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">seconds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PX</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> milliseconds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">EXAT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> timestamp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PXAT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> timestamp-milliseconds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">KEEPTTL]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [NX | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">XX]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [GET]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSET ä¼šè¦†ç›–é”®å·²æœ‰çš„å€¼ã€‚</p><p>æ”¯æŒå¤šç§è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ–¹å¼ï¼Œæ¯”å¦‚è¯´ EX è®¾ç½®ç§’çº§è¿‡æœŸæ—¶é—´ï¼ŒPX è®¾ç½®æ¯«ç§’è¿‡æœŸæ—¶é—´ã€‚</p><p>æ”¯æŒæ¡ä»¶å†™å…¥ï¼Œä½¿å…¶å¯ä»¥å®ç°åŸå­æ€§æ“ä½œï¼Œæ¯”å¦‚è¯´ NX ä»…åœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½®å€¼ï¼ŒXX ä»…åœ¨é”®å­˜åœ¨æ—¶è®¾ç½®å€¼ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250503100720.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šset å‘½ä»¤" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šset å‘½ä»¤</figcaption></figure><p>ç¼“å­˜å®ç°ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> user:profile:{userid}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {JSONæ•°æ®}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> EX</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3600</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # å­˜å‚¨ç”¨æˆ·èµ„æ–™ï¼Œå¹¶è®¾ç½®1å°æ—¶è¿‡æœŸ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å®ç°åˆ†å¸ƒå¼é”ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lock:resource_name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {random_value}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> EX</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> NX</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # è·å–é”ï¼Œ10ç§’åè‡ªåŠ¨é‡Šæ”¾</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å­˜å‚¨ Sessionï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> session:{sessionid}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {session_data}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> EX</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1800</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # å­˜å‚¨ç”¨æˆ·ä¼šè¯ï¼Œ30åˆ†é’Ÿè¿‡æœŸ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="sadd-å‘½ä»¤çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘" tabindex="-1"><a class="header-anchor" href="#sadd-å‘½ä»¤çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘"><span>sadd å‘½ä»¤çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿ</span></a></h4><p>SADD æ”¯æŒä¸€æ¬¡æ·»åŠ å¤šä¸ªå…ƒç´ ï¼Œè¿”å›å€¼ä¸ºå®é™…æ·»åŠ æˆåŠŸçš„å…ƒç´ æ•°é‡ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(N)ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> SADD</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> myset</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;apple&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;banana&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;orange&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="incrå‘½ä»¤äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#incrå‘½ä»¤äº†è§£å—"><span>incrå‘½ä»¤äº†è§£å—ï¼Ÿ</span></a></h4><p>INCR æ˜¯ä¸€ä¸ªåŸå­å‘½ä»¤ï¼Œå¯ä»¥å°†æŒ‡å®šé”®çš„å€¼åŠ  1ï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œä¼šå…ˆå°†å…¶è®¾ç½®ä¸º 0ï¼Œå†æ‰§è¡ŒåŠ  1 æ“ä½œã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250503095411.png" alt="äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼šINCR" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼šINCR</figcaption></figure><p>å¸¸ç”¨äºç½‘ç«™è®¿é—®é‡ã€æ–‡ç« ç‚¹èµæ•°ç­‰è®¡æ•°å™¨çš„å®ç°ï¼›ç»“åˆè¿‡æœŸæ—¶é—´å®ç°é™æµå™¨ï¼›ç”Ÿæˆåˆ†å¸ƒå¼å”¯ä¸€ IDï¼›åº“å­˜æ‰£å‡ç­‰ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># é™åˆ¶ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤šè®¿é—®10æ¬¡</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">FUNCTION</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> limit_api_call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">user_id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    current</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> INCR</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&quot;rate:&quot;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">+user_id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    IF</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> current</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> THEN</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        EXPIRE(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&quot;rate:&quot;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">+user_id,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    END</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    IF</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> current</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> THEN</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        RETURN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # è¶…å‡ºé™åˆ¶</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    ELSE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        RETURN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   # å…è®¸è®¿é—®</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    END</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">END</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 1 Java æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´è¯´ Redis å¸¸ç”¨å‘½ä»¤</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 3 Java åç«¯é¢è¯•åŸé¢˜ï¼šè¯´çš„é‚£ä¹ˆå¥½ï¼ŒRedis è®¾ç½® key value çš„å‡½æ•°æ˜¯å•¥</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 1 éƒ¨é—¨ä¸»ç«™æŠ€æœ¯éƒ¨é¢è¯•åŸé¢˜ï¼šRedis çš„ sadd å‘½ä»¤æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 3 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘ä¿¡æ¯</a>è¯´æ‹¿åˆ°äº†ç¾çš„çš„è½¯å¼€æš‘æœŸå®ä¹  offerï¼Œè™½ç„¶ä»–è‡ªå·±ä¸æ»¡æ„ï¼Œä½†æš‚æ—¶æ²¡æœ‰å…¶ä»–æ›´å¥½çš„ï¼Œæˆ‘å»ºè®®ä»–å…ˆå»è¯•ä¸€ä¸‹ğŸ‰ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250503101721.png" alt="çƒå‹æ‹¿åˆ°äº†ç¾çš„çš„ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†ç¾çš„çš„ offer</figcaption></figure><h3 id="_9-å•çº¿ç¨‹çš„redis-qps-èƒ½åˆ°å¤šå°‘-è¡¥å……" tabindex="-1"><a class="header-anchor" href="#_9-å•çº¿ç¨‹çš„redis-qps-èƒ½åˆ°å¤šå°‘-è¡¥å……"><span>9.å•çº¿ç¨‹çš„Redis QPS èƒ½åˆ°å¤šå°‘ï¼Ÿ(è¡¥å……)</span></a></h3><blockquote><p>2024 å¹´ 4 æœˆ 14 æ—¥å¢è¡¥</p></blockquote><p>æ ¹æ®<a href="https://redis.io/docs/latest/operate/oss_and_stack/management/optimization/benchmarks/" target="_blank" rel="noopener noreferrer">å®˜æ–¹çš„åŸºå‡†æµ‹è¯•</a>ï¼Œä¸€ä¸ªæ™®é€šæœåŠ¡å™¨çš„ Redis å®ä¾‹é€šå¸¸å¯ä»¥è¾¾åˆ°æ¯ç§’åä¸‡å·¦å³çš„ QPSã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250427143852.png" alt="æ¯ç§’è¯·æ±‚æ•°èƒ½è¾¾åˆ°10 ä¸‡çº§" tabindex="0" loading="lazy"><figcaption>æ¯ç§’è¯·æ±‚æ•°èƒ½è¾¾åˆ°10 ä¸‡çº§</figcaption></figure><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ start ----</p><p>Redis çš„ QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰æ€§èƒ½å–å†³äºå¤šç§å› ç´ ï¼ŒåŒ…æ‹¬ç¡¬ä»¶é…ç½®ã€ç½‘ç»œå»¶è¿Ÿã€æ•°æ®ç»“æ„ã€å‘½ä»¤ç±»å‹ç­‰ã€‚</p><p>å¯ä»¥é€šè¿‡ <code>redis-benchmark</code> å‘½ä»¤è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-benchmark</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -h</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 127.0.0.1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6379</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 50</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>-h</code>ï¼šæŒ‡å®š Redis æœåŠ¡å™¨çš„åœ°å€ï¼Œé»˜è®¤æ˜¯ 127.0.0.1ã€‚</li><li><code>-p</code>ï¼šæŒ‡å®š Redis æœåŠ¡å™¨çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯ 6379ã€‚</li><li><code>-c</code>ï¼šå¹¶å‘è¿æ¥æ•°ï¼Œå³åŒæ—¶æœ‰å¤šå°‘ä¸ªå®¢æˆ·ç«¯åœ¨è¿›è¡Œæµ‹è¯•ã€‚</li><li><code>-n</code>ï¼šè¯·æ±‚æ€»æ•°ï¼Œå³æµ‹è¯•è¿‡ç¨‹ä¸­æ€»å…±è¦æ‰§è¡Œå¤šå°‘ä¸ªè¯·æ±‚ã€‚</li></ul><p>2023 å¹´å‰ï¼Œæˆ‘ç”¨çš„æ˜¯ä¸€å° macOSï¼Œ4 GHz å››æ ¸ Intel Core i7ï¼Œ32 GB 1867 MHz DDR3ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240408100900.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis çš„åŸºå‡†æµ‹è¯•" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis çš„åŸºå‡†æµ‹è¯•</figcaption></figure><p>å¯ä»¥çœ‹å¾—å‡ºï¼Œæ¯ç§’èƒ½å¤„ç†è¶…è¿‡ 10 ä¸‡æ¬¡è¯·æ±‚ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>QPS = æ€»è¯·æ±‚æ•° / æ€»è€—æ—¶ = 10000 / 0.09 â‰ˆ 111111 QPS</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å»¶è¿Ÿä¹Ÿéå¸¸ä½ï¼Œ99% çš„è¯·æ±‚éƒ½åœ¨ 0.3ms ä»¥å†…å®Œæˆäº†ã€‚</p><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ end ----</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šå•çº¿ç¨‹ Redis çš„ QPS æ˜¯å¤šå°‘ï¼Ÿ</li></ol></blockquote><div style="border:1px solid #096dd9;padding:20px;border-radius:15px;background-color:#f0f8ff;max-width:800px;margin:0 auto;box-shadow:0 4px 8px rgba(0, 0, 0, 0.1);"><p>å—¨å—¨å—¨ï¼Œæ—¶éš”ä¸¤å¹´ï¼Œé¢æ¸£é€†è¢­<a href="https://javabetter.cn/sidebar/sanfene/nixi.html" style="color:#096dd9;text-decoration:none;font-weight:bold;">ç¬¬äºŒç‰ˆ PDF ç»ˆäºå¯ä»¥ä¸‹è½½äº†</a>ã€‚æˆ‘ä»¬åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼š</p><ol style="margin-left:20px;"><li><strong><span style="color:#d32f2f;">å¯¹äºé«˜é¢‘é¢˜</span></strong>ï¼šä¼šæ ‡æ³¨åœ¨ã€Š<a href="https://javabetter.cn/zhishixingqiu/mianshi.html" style="color:#096dd9;">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>ä¸­å‡ºç°çš„ä½ç½®ï¼Œå“ªå®¶å…¬å¸ï¼ŒåŸé¢˜æ˜¯ä»€ä¹ˆï¼›å¦‚æœä½ æƒ³èŠ‚çœæ—¶é—´çš„è¯ï¼Œå¯ä»¥ä¼˜å…ˆèƒŒè¯µè¿™äº›é¢˜ç›®ï¼Œå°½å¿«åšåˆ°çŸ¥å½¼çŸ¥å·±ï¼Œç™¾æˆ˜ä¸æ®†ã€‚</li><li><strong><span style="color:#d32f2f;">ç»“åˆé¡¹ç›®</span></strong>ï¼šåŒ…æ‹¬<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" style="color:#096dd9;">æŠ€æœ¯æ´¾</a>ã€<a href="https://t.zsxq.com/0bhcI0Gs6" style="color:#096dd9;">mydb</a>ã€<a href="https://javabetter.cn/zhishixingqiu/pmhub.html" style="color:#096dd9;">pmhub</a>æ¥ç»„ç»‡è¯­è¨€ï¼Œè®©é¢è¯•å®˜æœ€å¤§ç¨‹åº¦æ„Ÿå—åˆ°ä½ çš„è¯šæ„ï¼Œè€Œä¸æ˜¯æœºæ¢°åŒ–çš„èƒŒè¯µã€‚</li><li><strong><span style="color:#d32f2f;">ä¿®å¤é—®é¢˜</span></strong>ï¼šç¬¬ä¸€ç‰ˆä¸­å‡ºç°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬çƒå‹ä»¬çš„ç§ä¿¡åé¦ˆï¼Œç½‘ç«™ç•™è¨€åŒºçš„è¯„è®ºï¼Œä»¥åŠ<a href="https://github.com/itwanger/toBeBetterJavaer/issues" style="color:#096dd9;"> GitHub ä»“åº“ä¸­çš„ issue</a>ï¼Œè®©è¿™ä»½é¢è¯•æŒ‡å—æ›´åŠ å®Œå–„ã€‚</li><li><strong><span style="color:#d32f2f;">ä¼˜åŒ–æ’ç‰ˆ</span></strong>ï¼šå¢åŠ æ‰‹ç»˜å›¾ï¼Œé‡æ–°ç»„ç»‡ç­”æ¡ˆï¼Œä½¿å…¶æ›´åŠ å£è¯­åŒ–ï¼Œä»è€Œæ›´è´´è¿‘é¢è¯•å®˜çš„é¢„æœŸã€‚</li></ol><p>ä½ å¯ä»¥æ‰«ä¸‹é¢çš„äºŒç»´ç ï¼ˆæˆ–è€…é•¿æŒ‰è‡ªåŠ¨è¯†åˆ«ï¼‰å…³æ³¨ã€<b>æ²‰é»˜ç‹äºŒ</b>ã€‘å…¬ä¼—å·ï¼Œå‘é€å…³é”®å­— <b>222</b> æ¥è·å– PDF ç‰ˆæœ¬ï¼Œå¦‚æœé¢æ¸£é€†è¢­çœŸçš„å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¸Œæœ›èƒ½ç»™äºŒå“¥çš„å…¬ä¼—å·åŠ ä¸€ä¸ªæ˜Ÿæ ‡ï¼Œæ»¡è¶³æˆ‘é‚£ä¸€ä¸ç‚¹è™šè£å¿ƒï¼Œè¿™å°†æ˜¯æˆ‘æ›´æ–°ä¸‹å»çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p><div style="text-align:center;margin:20px 0;"><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width:100%;height:auto;border-radius:10px;"></div><p>é¢æ¸£é€†è¢­çš„æ•´ç†å·¥ä½œçœŸçš„å¤ªä¸å®¹æ˜“äº†ï¼ŒèŠ±äº†æˆ‘å¥½å¤šå¥½å¤šçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œå†…å®¹å®Œå…¨å…è´¹ï¼Œä½†è´¨é‡å´æœ‰å£çš†ç¢‘ï¼Œå°±æ˜¯ä¸ºäº†åšä¸€ç‚¹çœŸæ­£æœ‰æ„ä¹‰çš„ã€çº¯ç²¹çš„äº‹æƒ…ã€‚</p></div><h2 id="æŒä¹…åŒ–" tabindex="-1"><a class="header-anchor" href="#æŒä¹…åŒ–"><span>æŒä¹…åŒ–</span></a></h2><h3 id="_10-ğŸŒŸredisçš„æŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›" tabindex="-1"><a class="header-anchor" href="#_10-ğŸŒŸredisçš„æŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›"><span>10.ğŸŒŸRedisçš„æŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</span></a></h3><p>ä¸»è¦æœ‰ä¸¤ç§ï¼ŒRDB å’Œ AOFã€‚RDB é€šè¿‡åˆ›å»ºæ—¶é—´ç‚¹å¿«ç…§æ¥å®ç°æŒä¹…åŒ–ï¼ŒAOF é€šè¿‡è®°å½•æ¯ä¸ªå†™æ“ä½œå‘½ä»¤æ¥å®ç°æŒä¹…åŒ–ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-3bda4a46-adc3-4f0d-a135-b8ae5d4c0d5d.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisæŒä¹…åŒ–çš„ä¸¤ç§æ–¹å¼" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisæŒä¹…åŒ–çš„ä¸¤ç§æ–¹å¼</figcaption></figure><p>è¿™ä¸¤ç§æ–¹å¼å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚è¿™æ ·å°±å¯ä»¥ä¿è¯ Redis æœåŠ¡å™¨åœ¨é‡å¯åä¸ä¸¢å¤±æ•°æ®ï¼Œé€šè¿‡ RDB å’Œ AOF æ–‡ä»¶æ¥æ¢å¤å†…å­˜ä¸­åŸæœ‰çš„æ•°æ®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504101901.png" alt="Gauravï¼šRDB å’Œ AOF" tabindex="0" loading="lazy"><figcaption>Gauravï¼šRDB å’Œ AOF</figcaption></figure><h4 id="è¯¦ç»†è¯´ä¸€ä¸‹-rdb" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†è¯´ä¸€ä¸‹-rdb"><span>è¯¦ç»†è¯´ä¸€ä¸‹ RDBï¼Ÿ</span></a></h4><p>RDB æŒä¹…åŒ–æœºåˆ¶å¯ä»¥åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…å°† Redis æŸä¸€æ—¶åˆ»çš„æ•°æ®ä¿å­˜åˆ°ç£ç›˜ä¸Šçš„ RDB æ–‡ä»¶ä¸­ï¼Œå½“ Redis é‡å¯æ—¶ï¼Œå¯ä»¥é€šè¿‡åŠ è½½è¿™ä¸ª RDB æ–‡ä»¶æ¥æ¢å¤æ•°æ®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504102121.png" alt="Animesh Gaitondeï¼šRDB" tabindex="0" loading="lazy"><figcaption>Animesh Gaitondeï¼šRDB</figcaption></figure><p>RDB æŒä¹…åŒ–å¯ä»¥é€šè¿‡ save å’Œ bgsave å‘½ä»¤æ‰‹åŠ¨è§¦å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ save æŒ‡ä»¤è‡ªåŠ¨è§¦å‘ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-ffe56e32-34c5-453d-8859-c2febbe6a038.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šsaveå’Œbgsave" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šsaveå’Œbgsave</figcaption></figure><p>save å‘½ä»¤ä¼šé˜»å¡ Redis è¿›ç¨‹ï¼Œç›´åˆ° RDB æ–‡ä»¶åˆ›å»ºå®Œæˆã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504103113.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šæ‰‹åŠ¨æ‰§è¡Œ RDB" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šæ‰‹åŠ¨æ‰§è¡Œ RDB</figcaption></figure><p>bgsave å‘½ä»¤ä¼šåœ¨åå° fork ä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œ RDB æŒä¹…åŒ–æ“ä½œï¼Œä¸»è¿›ç¨‹ä¸ä¼šè¢«é˜»å¡ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504102942.png" alt="Mräºï¼šRedis bgsave" tabindex="0" loading="lazy"><figcaption>Mräºï¼šRedis bgsave</figcaption></figure><h4 id="ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè‡ªåŠ¨è§¦å‘-rdb-æŒä¹…åŒ–" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè‡ªåŠ¨è§¦å‘-rdb-æŒä¹…åŒ–"><span>ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè‡ªåŠ¨è§¦å‘ RDB æŒä¹…åŒ–ï¼Ÿ</span></a></h4><p>ç¬¬ä¸€ç§ï¼Œåœ¨ Redis é…ç½®æ–‡ä»¶ä¸­è®¾ç½® RDB æŒä¹…åŒ–å‚æ•° <code>save &lt;seconds&gt; &lt;changes&gt;</code>ï¼Œè¡¨ç¤ºåœ¨æŒ‡å®šæ—¶é—´é—´éš”å†…ï¼Œå¦‚æœæœ‰æŒ‡å®šæ•°é‡çš„é”®å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘ RDB æŒä¹…åŒ–ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 900</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">      # 900 ç§’ï¼ˆ15 åˆ†é’Ÿï¼‰å†…æœ‰ 1 ä¸ª key å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘å¿«ç…§</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 300</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     # 300 ç§’ï¼ˆ5 åˆ†é’Ÿï¼‰å†…æœ‰ 10 ä¸ª key å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘å¿«ç…§</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10000</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   # 60 ç§’å†…æœ‰ 10000 ä¸ª key å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘å¿«ç…§</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒç§ï¼Œä¸»ä»å¤åˆ¶æ—¶ï¼Œå½“ä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥åˆ°ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šè‡ªåŠ¨æ‰§è¡Œ bgsave ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘é€ç»™ä»èŠ‚ç‚¹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504104821.png" alt="è¾¾æ‘©é™¢çš„BLOGï¼šRedis ä¸»ä»å¤åˆ¶æ—¶ RDB è‡ªåŠ¨ç”Ÿæˆ" tabindex="0" loading="lazy"><figcaption>è¾¾æ‘©é™¢çš„BLOGï¼šRedis ä¸»ä»å¤åˆ¶æ—¶ RDB è‡ªåŠ¨ç”Ÿæˆ</figcaption></figure><p>ç¬¬ä¸‰ç§ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ AOFï¼Œæ‰§è¡Œ shutdown å‘½ä»¤æ—¶ï¼ŒRedis ä¼šè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ RDB æ–‡ä»¶ï¼Œä»¥ç¡®ä¿æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚</p><h4 id="è¯¦ç»†è¯´ä¸€ä¸‹-aof" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†è¯´ä¸€ä¸‹-aof"><span>è¯¦ç»†è¯´ä¸€ä¸‹ AOFï¼Ÿ</span></a></h4><p>AOF é€šè¿‡è®°å½•æ¯ä¸ªå†™æ“ä½œå‘½ä»¤ï¼Œå¹¶å°†å…¶è¿½åŠ åˆ° AOF æ–‡ä»¶æ¥å®ç°æŒä¹…åŒ–ï¼ŒRedis æœåŠ¡å™¨å®•æœºåå¯ä»¥é€šè¿‡é‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥æ¢å¤æ•°æ®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504105937.png" alt="Animesh Gaitondeï¼šAOF" tabindex="0" loading="lazy"><figcaption>Animesh Gaitondeï¼šAOF</figcaption></figure><p>å½“ Redis æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šå°†å†™å‘½ä»¤è¿½åŠ åˆ° AOF ç¼“å†²åŒºï¼›Redis ä¼šæ ¹æ®åŒæ­¥ç­–ç•¥å°†ç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ° AOF æ–‡ä»¶ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-a9fb6202-b1a1-484d-a4fa-fef519090b44.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šAOFå·¥ä½œæµç¨‹" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šAOFå·¥ä½œæµç¨‹</figcaption></figure><p>å½“ AOF æ–‡ä»¶è¿‡å¤§æ—¶ï¼ŒRedis ä¼šè‡ªåŠ¨è¿›è¡Œ AOF é‡å†™ï¼Œå‰”é™¤å¤šä½™çš„å‘½ä»¤ï¼Œæ¯”å¦‚è¯´å¤šæ¬¡å¯¹åŒä¸€ä¸ª key çš„ set å’Œ delï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ï¼›å½“ Redis é‡å¯æ—¶ï¼Œè¯»å– AOF æ–‡ä»¶ä¸­çš„å‘½ä»¤å¹¶é‡æ–°æ‰§è¡Œï¼Œä»¥æ¢å¤æ•°æ®ã€‚</p><h4 id="aof-çš„åˆ·ç›˜ç­–ç•¥äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#aof-çš„åˆ·ç›˜ç­–ç•¥äº†è§£å—"><span>AOF çš„åˆ·ç›˜ç­–ç•¥äº†è§£å—ï¼Ÿ</span></a></h4><p>Redis å°† AOF ç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ° AOF æ–‡ä»¶æ—¶ï¼Œæ¶‰åŠä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼šwrite å°†æ•°æ®å†™å…¥åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å†²åŒºï¼Œfsync å°† OS ç¼“å†²åŒºçš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ã€‚</p><p>è¿™é‡Œçš„åˆ·ç›˜æ¶‰åŠåˆ°ä¸‰ç§ç­–ç•¥ï¼šalwaysã€everysec å’Œ noã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504113511.png" alt="bytebytegoï¼šRedis AOF çš„åˆ·ç›˜ç­–ç•¥" tabindex="0" loading="lazy"><figcaption>bytebytegoï¼šRedis AOF çš„åˆ·ç›˜ç­–ç•¥</figcaption></figure><ul><li>alwaysï¼šæ¯æ¬¡å†™å‘½ä»¤æ‰§è¡Œå®Œï¼Œç«‹å³è°ƒç”¨ fsync åŒæ­¥åˆ°ç£ç›˜ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†æ€§èƒ½è¾ƒå·®ã€‚</li><li>everysecï¼šæ¯ç§’è°ƒç”¨ä¸€æ¬¡ fsyncï¼Œå°†å¤šæ¡å‘½ä»¤ä¸€æ¬¡æ€§åŒæ­¥åˆ°ç£ç›˜ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œæ•°æ®ä¸¢å¤±çš„æ—¶é—´çª—å£ä¸º 1 ç§’ã€‚</li><li>noï¼šä¸ä¸»åŠ¨è°ƒç”¨ fsyncï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šï¼Œæ€§èƒ½æœ€å¥½ï¼Œä½†æ•°æ®ä¸¢å¤±çš„æ—¶é—´çª—å£ä¸ç¡®å®šï¼Œä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ç¼“å­˜ç­–ç•¥ï¼Œå¯èƒ½ä¼šä¸¢å¤±å¤§é‡æ•°æ®ã€‚</li></ul><p>å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ appendfsync å‚æ•°è¿›è¡Œè®¾ç½®ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendfsync</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> everysec</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # æ¯ç§’ fsync ä¸€æ¬¡</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="è¯´è¯´aofçš„é‡å†™æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#è¯´è¯´aofçš„é‡å†™æœºåˆ¶"><span>è¯´è¯´AOFçš„é‡å†™æœºåˆ¶ï¼Ÿ</span></a></h4><p>ç”±äº AOF æ–‡ä»¶ä¼šéšç€å†™æ“ä½œçš„å¢åŠ è€Œä¸æ–­å¢é•¿ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ Redis æä¾›äº†é‡å†™æœºåˆ¶æ¥å¯¹ AOF æ–‡ä»¶è¿›è¡Œå‹ç¼©å’Œä¼˜åŒ–ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504115144.png" alt="pdai.techï¼šAOF æ–‡ä»¶ç˜¦èº«" tabindex="0" loading="lazy"><figcaption>pdai.techï¼šAOF æ–‡ä»¶ç˜¦èº«</figcaption></figure><p>AOF é‡å†™å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è§¦å‘ï¼Œç¬¬ä¸€ç§æ˜¯æ‰‹åŠ¨æ‰§è¡Œ <code>BGREWRITEAOF</code> å‘½ä»¤ï¼Œé€‚ç”¨äºéœ€è¦ç«‹å³å‡å°AOFæ–‡ä»¶å¤§å°çš„åœºæ™¯ã€‚</p><p>ç¬¬äºŒç§æ˜¯åœ¨ Redis é…ç½®æ–‡ä»¶ä¸­è®¾ç½®è‡ªåŠ¨é‡å†™å‚æ•°ï¼Œæ¯”å¦‚è¯´ <code>auto-aof-rewrite-percentage</code> å’Œ <code>auto-aof-rewrite-min-size</code>ï¼Œè¡¨ç¤ºå½“ AOF æ–‡ä»¶å¤§å°è¶…è¿‡æŒ‡å®šå€¼æ—¶ï¼Œè‡ªåŠ¨è§¦å‘é‡å†™ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">auto-aof-rewrite-percentage</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # é»˜è®¤å€¼100ï¼Œè¡¨ç¤ºå½“å‰AOFæ–‡ä»¶å¤§å°ç›¸æ¯”ä¸Šæ¬¡é‡å†™åå¤§å°å¢é•¿äº†å¤šå°‘ç™¾åˆ†æ¯”æ—¶è§¦å‘é‡å†™</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">auto-aof-rewrite-min-size</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 64mb</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # é»˜è®¤å€¼64MBï¼Œè¡¨ç¤ºAOFæ–‡ä»¶è‡³å°‘è¦è¾¾åˆ°è¿™ä¸ªå¤§å°æ‰ä¼šè€ƒè™‘é‡å†™</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="aof-é‡å†™çš„å…·ä½“è¿‡ç¨‹æ˜¯æ€æ ·çš„" tabindex="-1"><a class="header-anchor" href="#aof-é‡å†™çš„å…·ä½“è¿‡ç¨‹æ˜¯æ€æ ·çš„"><span>AOF é‡å†™çš„å…·ä½“è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ</span></a></h4><p>Redis åœ¨æ”¶åˆ°é‡å†™æŒ‡ä»¤åï¼Œä¼šåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶ fork ä¸€ä»½ä¸çˆ¶è¿›ç¨‹å®Œå…¨ç›¸åŒçš„æ•°æ®å‰¯æœ¬ï¼Œç„¶åéå†å†…å­˜ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œç”Ÿæˆé‡å»ºå®ƒä»¬æ‰€éœ€çš„æœ€å°‘å‘½ä»¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504114626.png" alt="äº‘çƒŸæˆé›¨ï¼šRedis çš„ AOF é‡å†™æœºåˆ¶" tabindex="0" loading="lazy"><figcaption>äº‘çƒŸæˆé›¨ï¼šRedis çš„ AOF é‡å†™æœºåˆ¶</figcaption></figure><p>æ¯”å¦‚è¯´å¤šä¸ª RPUSH å‘½ä»¤å¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ªå¸¦æœ‰å¤šä¸ªå‚æ•°çš„ RPUSHï¼›</p><p>æ¯”å¦‚è¯´ä¸€ä¸ªé”®è¢«è®¾ç½®ååˆè¢«åˆ é™¤ï¼Œè¿™ä¸ªé”®çš„æ‰€æœ‰æ“ä½œéƒ½ä¸ä¼šè¢«å†™å…¥æ–° AOFã€‚</p><p>æ¯”å¦‚è¯´ä½¿ç”¨ <code>SADD key member1 member2 member3</code> ä»£æ›¿å¤šä¸ªå•ç‹¬çš„ <code>SADD key memberX</code>ã€‚</p><p>å­è¿›ç¨‹åœ¨æ‰§è¡Œ AOF é‡å†™çš„åŒæ—¶ï¼Œä¸»è¿›ç¨‹å¯ä»¥ç»§ç»­å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚</p><p>ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼ŒRedis ä½¿ç”¨äº† AOF é‡å†™ç¼“å†²åŒºæœºåˆ¶ï¼Œä¸»è¿›ç¨‹åœ¨æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šå°†å‘½ä»¤åŒæ—¶å†™å…¥æ—§çš„ AOF æ–‡ä»¶å’Œé‡å†™ç¼“å†²åŒºã€‚</p><p>ç­‰å­è¿›ç¨‹å®Œæˆé‡å†™åï¼Œä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œä¸»è¿›ç¨‹æ”¶åˆ°åå°†é‡å†™ç¼“å†²åŒºä¸­çš„å‘½ä»¤è¿½åŠ åˆ°æ–°çš„ AOF æ–‡ä»¶ä¸­ï¼Œç„¶åè°ƒç”¨æ“ä½œç³»ç»Ÿçš„ renameï¼Œå°†æ—§çš„ AOF æ–‡ä»¶æ›¿æ¢ä¸ºæ–°çš„ AOF æ–‡ä»¶ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>ä¸»è¿›ç¨‹ï¼ˆforkï¼‰  </span></span>
<span class="line"><span>   â”‚  </span></span>
<span class="line"><span>   â”œâ”€â†’ å­è¿›ç¨‹ï¼ˆç”Ÿæˆæ–°çš„ AOF æ–‡ä»¶ï¼‰  </span></span>
<span class="line"><span>   â”‚       â”‚  </span></span>
<span class="line"><span>   â”‚       â”œâ”€â†’ å†…å­˜å¿«ç…§  </span></span>
<span class="line"><span>   â”‚       â”œâ”€â†’ å†™å…¥ä¸´æ—¶ AOF æ–‡ä»¶  </span></span>
<span class="line"><span>   â”‚       â”œâ”€â†’ é€šçŸ¥ä¸»è¿›ç¨‹å®Œæˆ  </span></span>
<span class="line"><span>   â”‚  </span></span>
<span class="line"><span>   â”œâ”€â†’ ä¸»è¿›ç¨‹ï¼ˆè¿½åŠ ç¼“å†²åŒºåˆ°æ–° AOF æ–‡ä»¶ï¼‰  </span></span>
<span class="line"><span>   â”œâ”€â†’ æ›¿æ¢æ—§ AOF æ–‡ä»¶  </span></span>
<span class="line"><span>   â”œâ”€â†’ é‡å†™å®Œæˆ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AOF é‡å†™æœŸé—´ï¼ŒRedis æœåŠ¡å™¨ä¼šå¤„äºç‰¹æ®ŠçŠ¶æ€ï¼š</p><ul><li>aof_child_pid ä¸ä¸º 0ï¼Œè¡¨ç¤ºæœ‰å­è¿›ç¨‹åœ¨æ‰§è¡Œ AOF é‡å†™</li><li>aof_rewrite_buf_blocks é“¾è¡¨ä¸ä¸ºç©ºï¼Œå­˜å‚¨ AOF é‡å†™ç¼“å†²åŒºå†…å®¹</li></ul><p>å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® no-appendfsync-on-rewrite ä¸º yesï¼Œé‚£ä¹ˆé‡å†™æœŸé—´å¯èƒ½ä¼šæš‚åœ AOF æ–‡ä»¶çš„ fsync æ“ä½œã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                # å¼€å¯AOF</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendfilename</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;appendonly.aof&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # AOFæ–‡ä»¶å</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendfsync</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> everysec</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">          # å†™å…¥ç£ç›˜ç­–ç•¥</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">no-appendfsync-on-rewrite</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> no</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # é‡å†™æœŸé—´æ˜¯å¦ä¸´æ—¶å…³é—­fsync</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">auto-aof-rewrite-percentage</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   # AOFæ–‡ä»¶å¢é•¿åˆ°åŸæ¥å¤šå°‘ç™¾åˆ†æ¯”æ—¶è§¦å‘é‡å†™</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">auto-aof-rewrite-min-size</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 64mb</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    # AOFæ–‡ä»¶æœ€å°å¤šå¤§æ—¶æ‰å…è®¸é‡å†™</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="aof-æ–‡ä»¶å­˜å‚¨çš„æ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®" tabindex="-1"><a class="header-anchor" href="#aof-æ–‡ä»¶å­˜å‚¨çš„æ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®"><span>AOF æ–‡ä»¶å­˜å‚¨çš„æ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®ï¼Ÿ</span></a></h4><p>AOF æ–‡ä»¶å­˜å‚¨çš„æ˜¯ Redis æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å†™å‘½ä»¤æ•°æ®ï¼Œä»¥ Redis åè®®æ ¼å¼ä¿å­˜ã€‚</p><p>è¿™ç§æ ¼å¼çš„ç‰¹ç‚¹æ˜¯ï¼Œæ¯ä¸ªå‘½ä»¤ä»¥*å¼€å¤´ï¼Œåè·Ÿå‚æ•°çš„æ•°é‡ï¼Œæ¯ä¸ªå‚æ•°å‰ç”¨<code>$</code>ç¬¦å·ï¼Œåè·Ÿå‚æ•°å­—èŠ‚é•¿åº¦ï¼Œç„¶åæ˜¯å‚æ•°çš„å®é™…å†…å®¹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20241208204853.png" alt="äºŒå“¥çš„Java è¿›é˜¶ä¹‹è·¯ï¼šAOFæ–‡ä»¶å†…å®¹æ ¼å¼" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„Java è¿›é˜¶ä¹‹è·¯ï¼šAOFæ–‡ä»¶å†…å®¹æ ¼å¼</figcaption></figure><h4 id="aofé‡å†™æœŸé—´å‘½ä»¤å¯èƒ½ä¼šå†™å…¥ä¸¤æ¬¡-ä¼šé€ æˆä»€ä¹ˆå½±å“" tabindex="-1"><a class="header-anchor" href="#aofé‡å†™æœŸé—´å‘½ä»¤å¯èƒ½ä¼šå†™å…¥ä¸¤æ¬¡-ä¼šé€ æˆä»€ä¹ˆå½±å“"><span>AOFé‡å†™æœŸé—´å‘½ä»¤å¯èƒ½ä¼šå†™å…¥ä¸¤æ¬¡ï¼Œä¼šé€ æˆä»€ä¹ˆå½±å“ï¼Ÿ</span></a></h4><p>AOF é‡å†™æœŸé—´å‘½ä»¤ä¼šåŒæ—¶å†™å…¥ç°æœ‰AOFæ–‡ä»¶å’Œé‡å†™ç¼“å†²åŒºï¼Œè¿™ç§æœºåˆ¶æ˜¯æœ‰æ„è®¾è®¡çš„ï¼Œå¹¶ä¸ä¼šå¯¼è‡´æ•°æ®é‡å¤æˆ–ä¸ä¸€è‡´é—®é¢˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250504121938.png" alt="UStarGaoï¼šAOF åŒå†™æœºåˆ¶" tabindex="0" loading="lazy"><figcaption>UStarGaoï¼šAOF åŒå†™æœºåˆ¶</figcaption></figure><p>å› ä¸ºæ–°æ—§æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œç°æœ‰å‘½ä»¤å†™å…¥å½“å‰ AOF æ–‡ä»¶ï¼Œé‡å†™ç¼“å†²åŒºçš„å‘½ä»¤æœ€ç»ˆå†™å…¥æ–°çš„ AOF æ–‡ä»¶ï¼Œå®Œæˆåï¼Œæ–°æ–‡ä»¶é€šè¿‡åŸå­æ€§çš„ rename æ“ä½œæ›¿æ¢æ—§æ–‡ä»¶ã€‚ä¸¤ä¸ªæ–‡ä»¶æ˜¯å®Œå…¨åˆ†ç¦»çš„ï¼Œä¸ä¼šå¯¼è‡´åŒä¸€ä¸ª AOF æ–‡ä»¶ä¸­å‡ºç°é‡å¤å‘½ä»¤ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆ redis å¿«ï¼Œæ·˜æ±°ç­–ç•¥ æŒä¹…åŒ–</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 7 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´ä¸€ä¸‹ Redis çš„æŒä¹…åŒ–æ–¹å¼</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°å…¬å¸é¢ç»åˆé›†åŒå­¦ 1 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis çš„æŒä¹…åŒ–æ–¹å¼ï¼ŸRDB å’Œ AOF çš„åŒºåˆ«ï¼ŸRedis å®•æœºå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 18 æˆéƒ½åˆ°å®¶é¢è¯•åŸé¢˜ï¼šredis æŒä¹…åŒ–</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ä½œä¸šå¸®é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šredisæŒä¹…åŒ–æœºåˆ¶</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ OPPO é¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRedisæŒä¹…åŒ–æ–¹æ¡ˆ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 9 é¢è¯•é¢˜ç›®åŸé¢˜ï¼šRedisçš„åŸºæœ¬æ•°æ®ç±»å‹ï¼ŸRedisçš„æŒä¹…åŒ–å‘¢ï¼Ÿæœ‰ä½•ä¼˜ç¼ºç‚¹ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æ»´æ»´é¢ç»åŒå­¦ 3 ç½‘çº¦è½¦åç«¯å¼€å‘ä¸€é¢åŸé¢˜ï¼šRedisæŒä¹…åŒ–</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 1 éƒ¨é—¨ä¸»ç«™æŠ€æœ¯éƒ¨é¢è¯•åŸé¢˜ï¼šRedisæ•°æ®çš„å¯é æ€§æ€ä¹ˆä¿è¯ï¼ŸAOFé‡å†™æœŸé—´å‘½ä»¤å¯èƒ½ä¼šå†™å…¥ä¸¤æ¬¡ï¼Œä¼šé€ æˆä»€ä¹ˆå½±å“ï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 4 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘ä¿¡æ¯</a>è¯´æŠŠå¹¶å‘ç¼–ç¨‹å’Œ JVM çš„é¢æ¸£é€†è¢­éƒ½æ‰“å°æˆçº¸è´¨ç‰ˆäº†ï¼Œè¯´å®è¯ï¼Œè¿™ä¸ªå°é¢çš„é¢œå€¼æˆ‘ä¹Ÿå¾ˆå–œæ¬¢ï¼Œå“ˆå“ˆã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-è¿˜æ˜¯çœ‹çº¸è´¨ç‰ˆå¿ƒé‡Œè¸å®.jpg" alt="é¢æ¸£é€†è¢­æ‰“å°æˆçº¸è´¨ç‰ˆäº†" tabindex="0" loading="lazy"><figcaption>é¢æ¸£é€†è¢­æ‰“å°æˆçº¸è´¨ç‰ˆäº†</figcaption></figure><h3 id="_11-rdb-å’Œ-aof-å„è‡ªæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹" tabindex="-1"><a class="header-anchor" href="#_11-rdb-å’Œ-aof-å„è‡ªæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹"><span>11.RDB å’Œ AOF å„è‡ªæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ</span></a></h3><p>RDB é€šè¿‡ fork å­è¿›ç¨‹åœ¨ç‰¹å®šæ—¶é—´ç‚¹å¯¹å†…å­˜æ•°æ®è¿›è¡Œå…¨é‡å¤‡ä»½ï¼Œç”ŸæˆäºŒè¿›åˆ¶æ ¼å¼çš„å¿«ç…§æ–‡ä»¶ã€‚å…¶æœ€å¤§ä¼˜åŠ¿åœ¨äºå¤‡ä»½æ¢å¤æ•ˆç‡é«˜ï¼Œæ–‡ä»¶ç´§å‡‘ï¼Œæ¢å¤é€Ÿåº¦å¿«ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®çš„å¤‡ä»½å’Œè¿ç§»åœºæ™¯ã€‚</p><p>ç¼ºç‚¹æ˜¯å¯èƒ½ä¸¢å¤±ä¸¤æ¬¡å¿«ç…§æœŸé—´çš„æ‰€æœ‰æ•°æ®å˜æ›´ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250505092638.png" alt="dfordebuggingï¼šrdb vs aof" tabindex="0" loading="lazy"><figcaption>dfordebuggingï¼šrdb vs aof</figcaption></figure><p>AOF ä¼šè®°å½•æ¯ä¸€æ¡ä¿®æ”¹æ•°æ®çš„å†™å‘½ä»¤ã€‚è¿™ç§æ—¥å¿—è¿½åŠ çš„æ–¹å¼è®© AOF èƒ½å¤Ÿæä¾›æ¥è¿‘å®æ—¶çš„æ•°æ®å¤‡ä»½ï¼Œæ•°æ®ä¸¢å¤±é£é™©å¯ä»¥æ§åˆ¶åœ¨ 1 ç§’å†…ç”šè‡³å®Œå…¨é¿å…ã€‚</p><p>ç¼ºç‚¹æ˜¯æ–‡ä»¶ä½“ç§¯è¾ƒå¤§ï¼Œæ¢å¤é€Ÿåº¦æ…¢ã€‚</p><p>æ¥ä¸ªè¡¨æ ¼å¯¹æ¯”ä¸€ä¸‹ï¼š</p><table><thead><tr><th>å¯¹æ¯”é¡¹</th><th>RDBï¼ˆå¿«ç…§ï¼‰</th><th>AOFï¼ˆå‘½ä»¤æ—¥å¿—ï¼‰</th></tr></thead><tbody><tr><td>æ•°æ®å®Œæ•´æ€§</td><td>âŒ å¯èƒ½ä¸¢å¤±å‡ åˆ†é’Ÿæ•°æ®</td><td>âœ… æœ€å¤šä¸¢ 1 ç§’æ•°æ®</td></tr><tr><td>æ¢å¤é€Ÿåº¦</td><td>âœ… å¿«ï¼ˆç›´æ¥åŠ è½½äºŒè¿›åˆ¶å¿«ç…§ï¼‰</td><td>âŒ æ…¢ï¼ˆé€æ¡ replayï¼‰</td></tr><tr><td>æ–‡ä»¶å¤§å°</td><td>âœ… å°ï¼ˆå‹ç¼©åï¼‰</td><td>âŒ å¤§ï¼ˆå‘½ä»¤è¿½åŠ ï¼‰</td></tr><tr><td>æ€§èƒ½å½±å“</td><td>âœ… ä½ï¼ˆfork åä¿å­˜ï¼‰</td><td>âŒ è¾ƒé«˜ï¼ˆæ¯æ¬¡å†™éƒ½è®°å½•ï¼‰</td></tr><tr><td>å†™å…¥æ–¹å¼</td><td>å®šæœŸå…¨é‡å†™</td><td>æ¯æ¬¡å†™å‘½ä»¤å°±è®°å½•</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å†·å¤‡ä»½ï¼Œç¾éš¾æ¢å¤</td><td>å®æ—¶æŒä¹…åŒ–ï¼Œæ•°æ®å®‰å…¨</td></tr><tr><td>é»˜è®¤çŠ¶æ€</td><td>é»˜è®¤å¯ç”¨</td><td>Redis 7 é»˜è®¤ä¹Ÿå¯ç”¨</td></tr><tr><td>é‡å†™æœºåˆ¶</td><td>æ— </td><td>æœ‰ï¼ˆBGREWRITEAOFï¼‰</td></tr><tr><td>æ··åˆæ”¯æŒ</td><td>Redis 4.0 åæ”¯æŒç»“åˆä½¿ç”¨ï¼ˆaof-use-rdb-preambleï¼‰</td><td></td></tr></tbody></table><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°å…¬å¸é¢ç»åˆé›†åŒå­¦ 1 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis çš„æŒä¹…åŒ–æ–¹å¼ï¼ŸRDB å’Œ AOF çš„åŒºåˆ«ï¼ŸRedis å®•æœºå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«ï¼Ÿ</li></ol></blockquote><h3 id="_12-rdb-å’Œ-aof-å¦‚ä½•é€‰æ‹©" tabindex="-1"><a class="header-anchor" href="#_12-rdb-å’Œ-aof-å¦‚ä½•é€‰æ‹©"><span>12.RDB å’Œ AOF å¦‚ä½•é€‰æ‹©ï¼Ÿ</span></a></h3><p>åœ¨é€‰æ‹© Redis æŒä¹…åŒ–æ–¹æ¡ˆæ—¶ï¼Œæˆ‘ä¼šä»ä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯ç‰¹æ€§ä¸¤ä¸ªç»´åº¦æ¥è€ƒè™‘ã€‚</p><p>å¦‚æœæ˜¯ç¼“å­˜åœºæ™¯ï¼Œå¯ä»¥æ¥å—ä¸€å®šç¨‹åº¦çš„æ•°æ®ä¸¢å¤±ï¼Œæˆ‘ä¼šå€¾å‘äºé€‰æ‹© RDB æˆ–è€…å®Œå…¨ä¸ä½¿ç”¨æŒä¹…åŒ–ã€‚RDB çš„å¿«ç…§æ–¹å¼å¯¹æ€§èƒ½å½±å“å°ï¼Œè€Œä¸”æ¢å¤é€Ÿåº¦å¿«ï¼Œéå¸¸é€‚åˆè¿™ç±»åœºæ™¯ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250505094156.png" alt="æ´’è„±çš„è€¿ï¼šRedis åšç¼“å­˜" tabindex="0" loading="lazy"><figcaption>æ´’è„±çš„è€¿ï¼šRedis åšç¼“å­˜</figcaption></figure><p>ä½†å¦‚æœæ˜¯å¤„ç†è®¢å•æˆ–è€…æ”¯ä»˜è¿™æ ·çš„æ ¸å¿ƒä¸šåŠ¡ï¼Œæ•°æ®ä¸¢å¤±å°†é€ æˆä¸¥é‡åæœï¼Œé‚£ä¹ˆ AOF å°±æˆä¸ºå¿…ç„¶é€‰æ‹©ã€‚é€šè¿‡é…ç½®æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œå¯ä»¥å°†æ½œåœ¨çš„æ•°æ®ä¸¢å¤±é£é™©é™åˆ¶åœ¨å¯æ¥å—èŒƒå›´å†…ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250505095347.png" alt="æå®¢æ—¶é—´ï¼šreids åœ¨ç§’æ€ä¸­çš„åº”ç”¨" tabindex="0" loading="lazy"><figcaption>æå®¢æ—¶é—´ï¼šreids åœ¨ç§’æ€ä¸­çš„åº”ç”¨</figcaption></figure><p>åœ¨å®é™…çš„é¡¹ç›®å½“ä¸­ï¼Œæˆ‘æ›´åå‘äºä½¿ç”¨ RDB + AOF çš„æ··åˆæ¨¡å¼ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> # å¼€å¯ AOF</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendfsync</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> everysec</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> # æ¯ç§’åˆ·ç›˜ä¸€æ¬¡</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">aof-use-rdb-preamble</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> # å¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‡å¯æ—¶ä¼˜å…ˆåŠ è½½ RDBï¼ŒRDB ä½œä¸ºå†·å¤‡ï¼ŒAOF ä½œä¸ºå®æ—¶åŒæ­¥</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 18 æˆéƒ½åˆ°å®¶é¢è¯•åŸé¢˜ï¼šä»€ä¹ˆæ—¶å€™ç”¨ rdb ä»€ä¹ˆæ—¶å€™ç”¨ aof</li></ol></blockquote><h3 id="_13-rediså¦‚ä½•æ¢å¤æ•°æ®" tabindex="-1"><a class="header-anchor" href="#_13-rediså¦‚ä½•æ¢å¤æ•°æ®"><span>13.Rediså¦‚ä½•æ¢å¤æ•°æ®ï¼Ÿ</span></a></h3><p>å½“ Redis æœåŠ¡é‡å¯æ—¶ï¼Œå®ƒä¼šä¼˜å…ˆæŸ¥æ‰¾ AOF æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨å°±é€šè¿‡é‡æ”¾å…¶ä¸­çš„å‘½ä»¤æ¥æ¢å¤æ•°æ®ï¼›å¦‚æœä¸å­˜åœ¨æˆ–æœªå¯ç”¨ AOFï¼Œåˆ™ä¼šå°è¯•åŠ è½½ RDB æ–‡ä»¶ï¼Œç›´æ¥å°†äºŒè¿›åˆ¶æ•°æ®è½½å…¥å†…å­˜æ¥æ¢å¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-f9aab5e9-a875-4316-9ec9-0c5650afe5c1.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRediså¯åŠ¨åŠ è½½æ•°æ®" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRediså¯åŠ¨åŠ è½½æ•°æ®</figcaption></figure><p>å¦‚æœ AOF æ–‡ä»¶æŸåçš„è¯ï¼ŒRedis ä¼šå°è¯•é€šè¿‡ <code>redis-check-aof</code> å·¥å…·æ¥ä¿®å¤ AOF æ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ <code>--repair</code> å‚æ•°æ¥ä¿®å¤ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-check-aof</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --repair</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> appendonly.aof</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è™½ç„¶ Redis è¿˜æä¾›äº† <code>redis-check-rdb</code> å·¥å…·æ¥æ£€æŸ¥ RDB æ–‡ä»¶çš„å®Œæ•´æ€§ï¼Œä½†å®ƒå¹¶ä¸æ”¯æŒä¿®å¤ RDB æ–‡ä»¶ï¼Œåªèƒ½ç”¨æ¥éªŒè¯æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-check-rdb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dump.rdb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 4 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis å†…å­˜ä¸­æ•°æ®ä¸¢å¤±æ€ä¹ˆè§£å†³</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 5 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©ç»™<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">çƒå‹ä¿®æ”¹ç®€å†</a>æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªåç§‘æœ¬ç¡•çš„çƒå‹ï¼Œ985 é«˜æ ¡åˆ+1ï¼Œç›®å‰å›½å†…çš„ 985 é«˜æ ¡æœ‰ 39 æ‰€ï¼Œå¸Œæœ›ä¸ä¹…çš„å°†æ¥ï¼Œèƒ½å…¨éƒ¨é›†é½ã€‚ğŸ˜„</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250505101045.png" alt="åä¸­ç§‘æŠ€å¤§å­¦çš„çƒå‹+1" tabindex="0" loading="lazy"><figcaption>åä¸­ç§‘æŠ€å¤§å­¦çš„çƒå‹+1</figcaption></figure><h3 id="_14-ğŸŒŸredis-4-0-çš„æ··åˆæŒä¹…åŒ–äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#_14-ğŸŒŸredis-4-0-çš„æ··åˆæŒä¹…åŒ–äº†è§£å—"><span>14.ğŸŒŸRedis 4.0 çš„æ··åˆæŒä¹…åŒ–äº†è§£å—ï¼Ÿ</span></a></h3><p>æ˜¯çš„ã€‚</p><p>æ··åˆæŒä¹…åŒ–ç»“åˆäº† RDB å’Œ AOF ä¸¤ç§æ–¹å¼çš„ä¼˜ç‚¹ï¼Œè§£å†³äº†å®ƒä»¬å„è‡ªçš„ä¸è¶³ã€‚åœ¨ Redis 4.0 ä¹‹å‰ï¼Œæˆ‘ä»¬è¦ä¹ˆé¢ä¸´ RDB å¯èƒ½ä¸¢å¤±æ•°æ®çš„é£é™©ï¼Œè¦ä¹ˆæ‰¿å— AOF æ¢å¤æ…¢çš„é—®é¢˜ï¼Œå¾ˆéš¾ä¸¤å…¨å…¶ç¾ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250506103814.png" alt="Animesh Gaitondeï¼šaof-use-rdb-preamble" tabindex="0" loading="lazy"><figcaption>Animesh Gaitondeï¼šaof-use-rdb-preamble</figcaption></figure><p>æ··åˆæŒä¹…åŒ–çš„å·¥ä½œåŸç†éå¸¸å·§å¦™ï¼šåœ¨ AOF é‡å†™æœŸé—´ï¼Œå…ˆä»¥ RDB æ ¼å¼å°†å†…å­˜ä¸­çš„æ•°æ®å¿«ç…§ä¿å­˜åˆ° AOF æ–‡ä»¶çš„å¼€å¤´ï¼Œå†å°†é‡å†™æœŸé—´çš„å‘½ä»¤ä»¥ AOF æ ¼å¼è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-19c531e5-da95-495a-a4c4-d63a0b8bba95.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ··åˆæŒä¹…åŒ–" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ··åˆæŒä¹…åŒ–</figcaption></figure><p>è¿™æ ·ï¼Œå½“éœ€è¦æ¢å¤æ•°æ®æ—¶ï¼ŒRedis å…ˆåŠ è½½ RDB æ ¼å¼çš„æ•°æ®æ¥å¿«é€Ÿæ¢å¤å¤§éƒ¨åˆ†çš„æ•°æ®ï¼Œç„¶åé€šè¿‡é‡æ”¾å‘½ä»¤æ¢å¤æœ€è¿‘çš„æ•°æ®ï¼Œè¿™æ ·å°±èƒ½åœ¨ä¿è¯æ•°æ®å®Œæ•´æ€§çš„åŒæ—¶ï¼Œæå‡æ¢å¤é€Ÿåº¦ã€‚</p><h4 id="å¦‚ä½•è®¾ç½®æŒä¹…åŒ–æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•è®¾ç½®æŒä¹…åŒ–æ¨¡å¼"><span>å¦‚ä½•è®¾ç½®æŒä¹…åŒ–æ¨¡å¼ï¼Ÿ</span></a></h4><p>å¯ç”¨æ··åˆæŒä¹…åŒ–çš„æ–¹å¼éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® <code>aof-use-rdb-preamble yes</code> å°±å¯ä»¥äº†ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">aof-use-rdb-preamble</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="ä½ åœ¨å¼€å‘ä¸­æ˜¯æ€ä¹ˆé…ç½®-rdb-å’Œ-aof-çš„" tabindex="-1"><a class="header-anchor" href="#ä½ åœ¨å¼€å‘ä¸­æ˜¯æ€ä¹ˆé…ç½®-rdb-å’Œ-aof-çš„"><span>ä½ åœ¨å¼€å‘ä¸­æ˜¯æ€ä¹ˆé…ç½® RDB å’Œ AOF çš„ï¼Ÿ</span></a></h4><p>å¯¹äºå¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒï¼Œæˆ‘å€¾å‘äºä½¿ç”¨æ··åˆæŒä¹…åŒ–æ–¹å¼ï¼Œç»“åˆ RDB å’Œ AOF çš„ä¼˜ç‚¹ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># å¯ç”¨AOF</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># ä½¿ç”¨æ··åˆæŒä¹…åŒ–</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">aof-use-rdb-preamble</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># æ¯ç§’åŒæ­¥ä¸€æ¬¡AOFï¼Œå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendfsync</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> everysec</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># AOFé‡å†™è§¦å‘æ¡ä»¶ï¼šæ–‡ä»¶å¢é•¿100%ä¸”è‡³å°‘è¾¾åˆ°64MB</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">auto-aof-rewrite-percentage</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">auto-aof-rewrite-min-size</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 64mb</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># RDBå¤‡ä»½ç­–ç•¥</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 900</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    # 15åˆ†é’Ÿå†…æœ‰1ä¸ªä¿®æ”¹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 300</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   # 5åˆ†é’Ÿå†…æœ‰10ä¸ªä¿®æ”¹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10000</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> # 1åˆ†é’Ÿå†…æœ‰10000ä¸ªä¿®æ”¹</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºå•çº¯çš„ç¼“å­˜åœºæ™¯ï¼Œæˆ–è€…æœ¬åœ°å¼€å‘ï¼Œæˆ‘ä¼šåªå¯ç”¨ RDBï¼Œå…³é—­ AOFï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># ç¦ç”¨AOF</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> no</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># è¾ƒå®½æ¾çš„RDBç­–ç•¥</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3600</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    # 1å°æ—¶å†…æœ‰1ä¸ªä¿®æ”¹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 300</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   # 5åˆ†é’Ÿå†…æœ‰100ä¸ªä¿®æ”¹</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è€Œå¯¹äºé‡‘èç±»ç­‰é«˜ä¸€è‡´æ€§çš„ç³»ç»Ÿï¼Œæˆ‘é€šå¸¸ä¼šåœ¨å…³é”®æ—¶é—´çª—å£åŠ¨æ€å°† <code>appendfsync</code> è®¾ç½®ä¸º <code>always</code>ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># å¯ç”¨AOF</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># ä½¿ç”¨æ··åˆæŒä¹…åŒ–</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">aof-use-rdb-preamble</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># æ¯ä¸ªå‘½ä»¤éƒ½åŒæ­¥ï¼ˆè°¨æ…ä½¿ç”¨ï¼Œæ€§èƒ½å½±å“å¤§ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># é€šå¸¸æˆ‘ä¼šåœ¨å…³é”®æ—¶é—´çª—å£åŠ¨æ€ä¿®æ”¹ä¸ºalways</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendfsync</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> always</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># æ›´é¢‘ç¹çš„RDBå¿«ç…§</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 300</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     # 5åˆ†é’Ÿå†…æœ‰1ä¸ªä¿®æ”¹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">save</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    # 1åˆ†é’Ÿå†…æœ‰100ä¸ªä¿®æ”¹</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦å¤–ï¼Œå¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œåº”è¯¥è®¾ç½®<code>no-appendfsync-on-rewrite yes</code>ï¼Œé¿å… AOF é‡å†™å½±å“ä¸»è¿›ç¨‹æ€§èƒ½ï¼›å¯¹äºå¤§å‹å®ä¾‹ï¼Œä¹Ÿåº”è¯¥è®¾ç½® <code>rdb-save-incremental-fsync yes</code> æ¥å‡å°‘å¤§å‹ RDB ä¿å­˜å¯¹æ€§èƒ½çš„å½±å“ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># AOFé‡å†™æœŸé—´ä¸fsyncï¼ŒAOF é‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹ä¸ä¼šå¯¹æ–°å†™å…¥çš„ AOF ç¼“å†²åŒºæ‰§è¡Œ fsync æ“ä½œï¼ˆå³ä¸å¼ºåˆ¶åˆ·ç›˜ï¼‰ï¼Œè€Œæ˜¯ç­‰é‡å†™ç»“æŸåå†ç»Ÿä¸€åˆ·ç›˜ã€‚</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">no-appendfsync-on-rewrite</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># RDB å¿«ç…§ä¿å­˜æ—¶é‡‡ç”¨å¢é‡ fsyncï¼Œå³æ¯å†™å…¥ä¸€å®šé‡çš„æ•°æ®å°±æ‰§è¡Œä¸€æ¬¡ fsyncï¼Œå°†æ•°æ®åˆ†æ‰¹åŒæ­¥åˆ°ç£ç›˜ã€‚</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rdb-save-incremental-fsync</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„æŒä¹…åŒ–æœºåˆ¶ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°å…¬å¸é¢ç»åˆé›†åŒå­¦ 1 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis å®•æœºå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 18 æˆéƒ½åˆ°å®¶é¢è¯•åŸé¢˜ï¼šå¦‚ä½•è®¾ç½®æŒä¹…åŒ–æ¨¡å¼</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 4 ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸šç•Œä½¿ç”¨å“ªä¸€ç§æ•°æ®æŒä¹…åŒ–ï¼Œä¸¤ç§æŒä¹…åŒ–æ–¹æ³•çš„ä¼˜ç¼ºç‚¹</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ä½œä¸šå¸®é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸¤ç§ RedisæŒä¹…åŒ–æœºåˆ¶å¯ä»¥æ··åˆä½¿ç”¨å—</li></ol></blockquote><div style="border:1px solid #096dd9;padding:20px;border-radius:15px;background-color:#f0f8ff;max-width:800px;margin:0 auto;box-shadow:0 4px 8px rgba(0, 0, 0, 0.1);"><p>å—¨å—¨å—¨ï¼Œæ—¶éš”ä¸¤å¹´ï¼Œé¢æ¸£é€†è¢­<a href="https://javabetter.cn/sidebar/sanfene/nixi.html" style="color:#096dd9;text-decoration:none;font-weight:bold;">ç¬¬äºŒç‰ˆ PDF ç»ˆäºå¯ä»¥ä¸‹è½½äº†</a>ã€‚æˆ‘ä»¬åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼š</p><ol style="margin-left:20px;"><li><strong><span style="color:#d32f2f;">å¯¹äºé«˜é¢‘é¢˜</span></strong>ï¼šä¼šæ ‡æ³¨åœ¨ã€Š<a href="https://javabetter.cn/zhishixingqiu/mianshi.html" style="color:#096dd9;">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>ä¸­å‡ºç°çš„ä½ç½®ï¼Œå“ªå®¶å…¬å¸ï¼ŒåŸé¢˜æ˜¯ä»€ä¹ˆï¼›å¦‚æœä½ æƒ³èŠ‚çœæ—¶é—´çš„è¯ï¼Œå¯ä»¥ä¼˜å…ˆèƒŒè¯µè¿™äº›é¢˜ç›®ï¼Œå°½å¿«åšåˆ°çŸ¥å½¼çŸ¥å·±ï¼Œç™¾æˆ˜ä¸æ®†ã€‚</li><li><strong><span style="color:#d32f2f;">ç»“åˆé¡¹ç›®</span></strong>ï¼šåŒ…æ‹¬<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" style="color:#096dd9;">æŠ€æœ¯æ´¾</a>ã€<a href="https://t.zsxq.com/0bhcI0Gs6" style="color:#096dd9;">mydb</a>ã€<a href="https://javabetter.cn/zhishixingqiu/pmhub.html" style="color:#096dd9;">pmhub</a>æ¥ç»„ç»‡è¯­è¨€ï¼Œè®©é¢è¯•å®˜æœ€å¤§ç¨‹åº¦æ„Ÿå—åˆ°ä½ çš„è¯šæ„ï¼Œè€Œä¸æ˜¯æœºæ¢°åŒ–çš„èƒŒè¯µã€‚</li><li><strong><span style="color:#d32f2f;">ä¿®å¤é—®é¢˜</span></strong>ï¼šç¬¬ä¸€ç‰ˆä¸­å‡ºç°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬çƒå‹ä»¬çš„ç§ä¿¡åé¦ˆï¼Œç½‘ç«™ç•™è¨€åŒºçš„è¯„è®ºï¼Œä»¥åŠ<a href="https://github.com/itwanger/toBeBetterJavaer/issues" style="color:#096dd9;"> GitHub ä»“åº“ä¸­çš„ issue</a>ï¼Œè®©è¿™ä»½é¢è¯•æŒ‡å—æ›´åŠ å®Œå–„ã€‚</li><li><strong><span style="color:#d32f2f;">ä¼˜åŒ–æ’ç‰ˆ</span></strong>ï¼šå¢åŠ æ‰‹ç»˜å›¾ï¼Œé‡æ–°ç»„ç»‡ç­”æ¡ˆï¼Œä½¿å…¶æ›´åŠ å£è¯­åŒ–ï¼Œä»è€Œæ›´è´´è¿‘é¢è¯•å®˜çš„é¢„æœŸã€‚</li></ol><p>ä½ å¯ä»¥æ‰«ä¸‹é¢çš„äºŒç»´ç ï¼ˆæˆ–è€…é•¿æŒ‰è‡ªåŠ¨è¯†åˆ«ï¼‰å…³æ³¨ã€<b>æ²‰é»˜ç‹äºŒ</b>ã€‘å…¬ä¼—å·ï¼Œå‘é€å…³é”®å­— <b>222</b> æ¥è·å– PDF ç‰ˆæœ¬ï¼Œå¦‚æœé¢æ¸£é€†è¢­çœŸçš„å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¸Œæœ›èƒ½ç»™äºŒå“¥çš„å…¬ä¼—å·åŠ ä¸€ä¸ªæ˜Ÿæ ‡ï¼Œæ»¡è¶³æˆ‘é‚£ä¸€ä¸ç‚¹è™šè£å¿ƒï¼Œè¿™å°†æ˜¯æˆ‘æ›´æ–°ä¸‹å»çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p><div style="text-align:center;margin:20px 0;"><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width:100%;height:auto;border-radius:10px;"></div><p>é¢æ¸£é€†è¢­çš„æ•´ç†å·¥ä½œçœŸçš„å¤ªä¸å®¹æ˜“äº†ï¼ŒèŠ±äº†æˆ‘å¥½å¤šå¥½å¤šçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œå†…å®¹å®Œå…¨å…è´¹ï¼Œä½†è´¨é‡å´æœ‰å£çš†ç¢‘ï¼Œå°±æ˜¯ä¸ºäº†åšä¸€ç‚¹çœŸæ­£æœ‰æ„ä¹‰çš„ã€çº¯ç²¹çš„äº‹æƒ…ã€‚</p></div><p>memoï¼š2025 å¹´ 5 æœˆ 6 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">çƒå‹ç®€å†</a>æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªä¸œåŒ—å¤§å­¦ç¡•åˆè‚¥å·¥ä¸šå¤§å­¦æœ¬çš„çƒå‹ï¼ŒçœŸçš„éå¸¸ä¼˜ç§€ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶èƒ½å¤Ÿé€šè¿‡æ˜Ÿçƒè¿™ä¸ªå¹³å°å½¼æ­¤æ¿€åŠ±ï¼Œå…±åŒè¿›æ­¥ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250506105448.png" alt="ä¸œåŒ—å¤§å­¦çš„çƒå‹+1" tabindex="0" loading="lazy"><figcaption>ä¸œåŒ—å¤§å­¦çš„çƒå‹+1</figcaption></figure><h2 id="é«˜å¯ç”¨" tabindex="-1"><a class="header-anchor" href="#é«˜å¯ç”¨"><span>é«˜å¯ç”¨</span></a></h2><h3 id="_15-ä¸»ä»å¤åˆ¶äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#_15-ä¸»ä»å¤åˆ¶äº†è§£å—"><span>15.ä¸»ä»å¤åˆ¶äº†è§£å—ï¼Ÿ</span></a></h3><p>ä¸»ä»å¤åˆ¶å…è®¸ä»èŠ‚ç‚¹ç»´æŠ¤ä¸»èŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸»èŠ‚ç‚¹å¯ä»¥è¿æ¥å¤šä¸ªä»èŠ‚ç‚¹ï¼Œä»è€Œå½¢æˆä¸€ä¸»å¤šä»çš„ç»“æ„ã€‚ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†å†™æ“ä½œï¼Œä»èŠ‚ç‚¹è‡ªåŠ¨åŒæ­¥ä¸»èŠ‚ç‚¹çš„æ•°æ®å˜æ›´ï¼Œå¹¶å¤„ç†è¯»è¯·æ±‚ï¼Œä»è€Œå®ç°è¯»å†™åˆ†ç¦»ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-60497f1e-8afb-44b3-bb7a-d4c29e5ac484.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisä¸»ä»å¤åˆ¶ç®€å›¾" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisä¸»ä»å¤åˆ¶ç®€å›¾</figcaption></figure><h4 id="ä¸»ä»å¤åˆ¶çš„ä¸»è¦ä½œç”¨æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»å¤åˆ¶çš„ä¸»è¦ä½œç”¨æ˜¯ä»€ä¹ˆ"><span>ä¸»ä»å¤åˆ¶çš„ä¸»è¦ä½œç”¨æ˜¯ä»€ä¹ˆ?</span></a></h4><p>ç¬¬ä¸€ï¼Œä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†å†™è¯·æ±‚ï¼Œä»èŠ‚ç‚¹è´Ÿè´£å¤„ç†è¯»è¯·æ±‚ï¼Œä»è€Œå®ç°è¯»å†™åˆ†ç¦»ï¼Œå‡è½»ä¸»èŠ‚ç‚¹å‹åŠ›çš„åŒæ—¶æå‡ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250507142235.png" alt="pdai.techï¼šä¸»ä»å¤åˆ¶çš„è¯»å†™åˆ†ç¦»" tabindex="0" loading="lazy"><figcaption>pdai.techï¼šä¸»ä»å¤åˆ¶çš„è¯»å†™åˆ†ç¦»</figcaption></figure><p>ç¬¬äºŒï¼Œä»èŠ‚ç‚¹å¯ä»¥ä½œä¸ºä¸»èŠ‚ç‚¹çš„æ•°æ®å¤‡ä»½ï¼Œå½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œå¯ä»¥å¿«é€Ÿå°†ä»èŠ‚ç‚¹æå‡ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250507142500.png" alt="ç³»ç»Ÿè¿ç»´ï¼šRedisä¸»ä»+Sentinelé›†ç¾¤" tabindex="0" loading="lazy"><figcaption>ç³»ç»Ÿè¿ç»´ï¼šRedisä¸»ä»+Sentinelé›†ç¾¤</figcaption></figure><h4 id="ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°ä¸»ä»å¤åˆ¶æ•°æ®ä¸ä¸€è‡´" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°ä¸»ä»å¤åˆ¶æ•°æ®ä¸ä¸€è‡´"><span>ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°ä¸»ä»å¤åˆ¶æ•°æ®ä¸ä¸€è‡´ï¼Ÿ</span></a></h4><p>Redis çš„ä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œå› æ­¤åœ¨ä¸»èŠ‚ç‚¹å®•æœºã€ç½‘ç»œæ³¢åŠ¨æˆ–å¤åˆ¶å»¶è¿Ÿè¾ƒé«˜æ—¶ä¼šå‡ºç°ä»èŠ‚ç‚¹æ•°æ®ä¸åŒæ­¥çš„æƒ…å†µã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250507143956.png" alt="ningg.topï¼šä¸»ä»å¤åˆ¶å¼‚æ­¥è¿›è¡Œ" tabindex="0" loading="lazy"><figcaption>ningg.topï¼šä¸»ä»å¤åˆ¶å¼‚æ­¥è¿›è¡Œ</figcaption></figure><p>æ¯”å¦‚ä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®åå®•æœºï¼Œä½†ä»èŠ‚ç‚¹è¿˜æœªæ¥å¾—åŠå¤åˆ¶ï¼Œå°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>æ—¶é—´çº¿ï¼šâ†’</span></span>
<span class="line"><span></span></span>
<span class="line"><span>å®¢æˆ·ç«¯  â†’  å‘ä¸»èŠ‚ç‚¹ SET user:1 äºŒå“¥     â†’  ä¸»èŠ‚ç‚¹å¤„ç†æˆåŠŸ âœ…</span></span>
<span class="line"><span>                            â†“</span></span>
<span class="line"><span>                          æ­£å‡†å¤‡æ¨é€ç»™ä»èŠ‚ç‚¹ï¼ˆå¼‚æ­¥å¤åˆ¶ï¼‰... ä½†è¿˜æ²¡æ¨é€å®Œ âŒ</span></span>
<span class="line"><span>                            â†“</span></span>
<span class="line"><span>                  â€”â€” çªç„¶ä¸»èŠ‚ç‚¹å®•æœºï¼ˆæœºå™¨æ­»æœºã€æ–­ç½‘ï¼‰ ğŸ’¥ â€”â€”</span></span>
<span class="line"><span>                            â†“</span></span>
<span class="line"><span>          Sentinel ç›‘æµ‹åˆ°æ•…éšœï¼Œfailoverï¼šå°†ä»èŠ‚ç‚¹æå‡ä¸ºæ–°ä¸»èŠ‚ç‚¹ ğŸ§ </span></span>
<span class="line"><span>                            â†“</span></span>
<span class="line"><span>å®¢æˆ·ç«¯ç»§ç»­è¯·æ±‚ï¼šGET user:1 â“â†’ ä»èŠ‚ç‚¹è¿”å›ï¼šç©º âŒï¼ˆæ•°æ®æ²¡åŒæ­¥è¿‡æ¥ï¼‰</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦ä¸€ä¸ªå®¹æ˜“è¢«å¿½è§†çš„å› ç´ æ˜¯ä¸»èŠ‚ç‚¹å†…å­˜å‹åŠ›ã€‚å½“ä¸»èŠ‚ç‚¹å†…å­˜æ¥è¿‘ä¸Šé™å¹¶å¯ç”¨äº†æ·˜æ±°ç­–ç•¥æ—¶ï¼ŒæŸäº›é”®å¯èƒ½è¢«è‡ªåŠ¨åˆ é™¤ï¼Œè€Œè¿™äº›åˆ é™¤æ“ä½œå¦‚æœæœªèƒ½åŠæ—¶åŒæ­¥ï¼Œå°±ä¼šé€ æˆä»èŠ‚ç‚¹ä¿ç•™äº†ä¸»èŠ‚ç‚¹å·²ç»ä¸å­˜åœ¨çš„æ•°æ®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250507162724.png" alt="å›¾ç‰‡æ¥æºäºç½‘ç»œï¼šä¸»ä»ä¸ä¸€è‡´" tabindex="0" loading="lazy"><figcaption>å›¾ç‰‡æ¥æºäºç½‘ç»œï¼šä¸»ä»ä¸ä¸€è‡´</figcaption></figure><h4 id="ä¸»ä»å¤åˆ¶æ•°æ®ä¸ä¸€è‡´çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»å¤åˆ¶æ•°æ®ä¸ä¸€è‡´çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›"><span>ä¸»ä»å¤åˆ¶æ•°æ®ä¸ä¸€è‡´çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</span></a></h4><p>é¦–å…ˆæ˜¯ç½‘ç»œå±‚é¢çš„ä¼˜åŒ–ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œä¸»ä»èŠ‚ç‚¹åº”è¯¥éƒ¨ç½²åœ¨åŒä¸€ä¸ªç½‘ç»œåŒºåŸŸå†…ï¼Œé¿å…è·¨åŒºåŸŸçš„ç½‘ç»œå»¶è¿Ÿã€‚</p><p>å…¶æ¬¡æ˜¯é…ç½®å±‚é¢çš„è°ƒæ•´ï¼Œæ¯”å¦‚è¯´é€‚å½“å¢å¤§å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°å’Œå­˜æ´»æ—¶é—´ï¼Œä»¥ä¾¿ä»èŠ‚ç‚¹é‡è¿åè¿›è¡Œå¢é‡åŒæ­¥è€Œä¸æ˜¯å…¨é‡åŒæ­¥ï¼Œä»¥æœ€å¤§ç¨‹åº¦å‡å°‘ä¸»ä»åŒæ­¥çš„å»¶è¿Ÿã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">repl-backlog-size</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1mb</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # é»˜è®¤å€¼ 1MBï¼Œè¡¨ç¤ºä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºå¤§å°</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">repl-backlog-ttl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3600</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # é»˜è®¤å€¼ 3600 ç§’ï¼Œè¡¨ç¤ºä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºå­˜æ´»æ—¶é—´</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬ä¸‰æ˜¯å¼•å…¥ç›‘æ§å’Œè‡ªåŠ¨ä¿®å¤æœºåˆ¶ï¼Œå®šæœŸæ£€æŸ¥ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p><p>æ¯”å¦‚è¯´é€šè¿‡æ¯”è¾ƒä¸»ä»çš„ offset å·®å€¼åˆ¤æ–­ä»åº“æ˜¯å¦è½åã€‚ä¸€æ—¦è¶…è¿‡è®¾å®šé˜ˆå€¼ï¼Œå°±å°†ä»èŠ‚ç‚¹å‰”é™¤ï¼Œå¹¶é‡æ–°è¿›è¡Œå…¨é‡åŒæ­¥ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240709135618.png" alt="æå®¢æ—¶é—´ï¼šRedis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜" tabindex="0" loading="lazy"><figcaption>æå®¢æ—¶é—´ï¼šRedis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜</figcaption></figure><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRedis åˆ†å¸ƒå¼ï¼Œä¸»ä»ï¼Œä¸€ä¸ªèŠ‚ç‚¹æŒ‚æ‰æ€ä¹ˆåŠ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³é¢ç»åŒå­¦ F é¢è¯•åŸé¢˜ï¼šredis çš„ä¸»ä»æ¶æ„å’Œä¸»ä»å“¨å…µåŒºåˆ«</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æ”¶é’±å§é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedisè§£å†³å•ç‚¹æ•…éšœä¸»è¦é ä»€ä¹ˆï¼Ÿä¸»ä»æ¨¡å¼ç”¨çš„æ˜¯å¼‚æ­¥è¿˜æ˜¯åŒæ­¥ï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 7 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">çƒå‹ç®€å†</a>æ—¶ï¼Œæ”¶åˆ°äº†çƒå‹å¯¹ç®€å†ä¿®æ”¹çš„è®¤å¯ï¼šâ€œç°åœ¨è¿™ä»½ç®€å†åº”è¯¥æ¯”è¾ƒå®Œç¾äº†â€ï¼Œå®Œç¾è¿™ä¸ªè¯æˆ‘è§‰å¾—è¤’å¥–çš„æœ‰ç‚¹å¤šäº†ï¼Œå“ˆå“ˆï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯å¾ˆå¼€å¿ƒçš„ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250508104145.png" alt="çƒå‹å¯¹ç®€å†çš„è®¤å¯" tabindex="0" loading="lazy"><figcaption>çƒå‹å¯¹ç®€å†çš„è®¤å¯</figcaption></figure><h3 id="_16-redisä¸»ä»æœ‰å‡ ç§å¸¸è§çš„æ‹“æ‰‘ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_16-redisä¸»ä»æœ‰å‡ ç§å¸¸è§çš„æ‹“æ‰‘ç»“æ„"><span>16.Redisä¸»ä»æœ‰å‡ ç§å¸¸è§çš„æ‹“æ‰‘ç»“æ„ï¼Ÿ</span></a></h3><p>ä¸»è¦æœ‰ä¸‰ç§ã€‚</p><p>æœ€åŸºç¡€çš„æ˜¯ä¸€ä¸»ä¸€ä»ï¼Œè¿™ç§æ¨¡å¼é€‚åˆå°å‹é¡¹ç›®ã€‚ä¸€ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£å†™å…¥ï¼Œä¸€ä¸ªä»èŠ‚ç‚¹è´Ÿè´£è¯»å’Œæ•°æ®å¤‡ä»½ã€‚è¿™ç§ç»“æ„è™½ç„¶ç®€å•ï¼Œä½†ç»´æŠ¤æˆæœ¬ä½ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5d91a67c-dbff-4a8d-bf9d-1fe7602d5a27.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸€ä¸»ä¸€ä»" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸€ä¸»ä¸€ä»</figcaption></figure><p>éšç€ä¸šåŠ¡å¢é•¿ï¼Œè¯»è¯·æ±‚å¢å¤šï¼Œå¯ä»¥è€ƒè™‘æ‰©å±•ä¸ºä¸€ä¸»å¤šä»ç»“æ„ã€‚ä¸»èŠ‚ç‚¹è´Ÿè´£å†™å…¥ï¼Œå¤šä¸ªä»èŠ‚ç‚¹è¿˜å¯ä»¥åˆ†æ‘Šå‹åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-71074254-699a-480b-bbb0-c68f364a380b.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸€ä¸»å¤šä»ç»“æ„" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸€ä¸»å¤šä»ç»“æ„</figcaption></figure><p>åœ¨è·¨åœ°åŸŸéƒ¨ç½²åœºæ™¯ä¸­ï¼Œæ ‘çŠ¶ä¸»ä»ç»“æ„å¯ä»¥æœ‰æ•ˆé™ä½ä¸»èŠ‚ç‚¹è´Ÿè½½å’Œéœ€è¦ä¼ é€ç»™ä»èŠ‚ç‚¹çš„æ•°æ®é‡ã€‚é€šè¿‡å¼•å…¥å¤åˆ¶ä¸­é—´å±‚ï¼Œä»èŠ‚ç‚¹ä¸ä»…å¯ä»¥å¤åˆ¶ä¸»èŠ‚ç‚¹æ•°æ®ï¼ŒåŒæ—¶å¯ä»¥ä½œä¸ºå…¶ä»–ä»èŠ‚ç‚¹çš„ä¸»èŠ‚ç‚¹ç»§ç»­å‘ä¸‹å±‚å¤åˆ¶ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-dff14203-5e01-4d1b-a775-10ee444ada54.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ ‘çŠ¶ä¸»ä»ç»“æ„" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ ‘çŠ¶ä¸»ä»ç»“æ„</figcaption></figure><h3 id="_17-redisçš„ä¸»ä»å¤åˆ¶åŸç†äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#_17-redisçš„ä¸»ä»å¤åˆ¶åŸç†äº†è§£å—"><span>17.Redisçš„ä¸»ä»å¤åˆ¶åŸç†äº†è§£å—ï¼Ÿ</span></a></h3><p>äº†è§£ã€‚</p><p>Redis çš„ä¸»ä»å¤åˆ¶æ˜¯æŒ‡é€šè¿‡å¼‚æ­¥å¤åˆ¶å°†ä¸»èŠ‚ç‚¹çš„æ•°æ®å˜æ›´åŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œä»è€Œå®ç°æ•°æ®å¤‡ä»½å’Œè¯»å†™åˆ†ç¦»ã€‚è¿™ä¸ªè¿‡ç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šå»ºç«‹è¿æ¥ã€åŒæ­¥æ•°æ®å’Œä¼ æ’­å‘½ä»¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250508105718.png" alt="pdai.techï¼šRedisä¸»ä»å¤åˆ¶åŸç†" tabindex="0" loading="lazy"><figcaption>pdai.techï¼šRedisä¸»ä»å¤åˆ¶åŸç†</figcaption></figure><p>åœ¨å»ºç«‹è¿æ¥é˜¶æ®µï¼Œä»èŠ‚ç‚¹é€šè¿‡æ‰§è¡Œ <code>replicaof</code> å‘½ä»¤è¿æ¥åˆ°ä¸»èŠ‚ç‚¹ã€‚è¿æ¥å»ºç«‹åï¼Œä»èŠ‚ç‚¹å‘ä¸»èŠ‚ç‚¹å‘é€ <code>psync</code> å‘½ä»¤ï¼Œè¯·æ±‚æ•°æ®åŒæ­¥ã€‚è¿™æ—¶ä¸»èŠ‚ç‚¹ä¼šä¸ºè¯¥ä»èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªè¿æ¥å’Œå¤åˆ¶ç¼“å†²åŒºã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250508110132.png" alt="MainWoodsï¼šå¤åˆ¶ç¼“å†²åŒº" tabindex="0" loading="lazy"><figcaption>MainWoodsï¼šå¤åˆ¶ç¼“å†²åŒº</figcaption></figure><p>åŒæ­¥æ•°æ®é˜¶æ®µåˆ†ä¸ºå…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥ã€‚å½“ä»èŠ‚ç‚¹é¦–æ¬¡è¿æ¥ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¼šè§¦å‘å…¨é‡åŒæ­¥ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250508143059.png" alt="ningGï¼šå¢é‡åŒæ­¥å’Œå…¨é‡åŒæ­¥" tabindex="0" loading="lazy"><figcaption>ningGï¼šå¢é‡åŒæ­¥å’Œå…¨é‡åŒæ­¥</figcaption></figure><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¼š fork ä¸€ä¸ªå­è¿›ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼ŒåŒæ—¶å°†æ–‡ä»¶ç”ŸæˆæœŸé—´æ”¶åˆ°çš„å†™å‘½ä»¤ç¼“å­˜åˆ°å¤åˆ¶ç¼“å†²åŒºã€‚ç„¶åå°† RDB æ–‡ä»¶å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¸…ç©ºè‡ªå·±çš„æ•°æ®å¹¶åŠ è½½è¿™ä¸ª RDB æ–‡ä»¶ã€‚ç­‰ RDB ä¼ è¾“å®Œæˆåï¼Œä¸»èŠ‚ç‚¹å†å°†ç¼“å­˜çš„å†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹æ‰§è¡Œï¼Œç¡®ä¿æ•°æ®å®Œå…¨ä¸€è‡´ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250508143956.png" alt="åšå®¢å›­å¤šå°‘å¹…åº¦ï¼šä¸»ä»æ•°æ®å¤åˆ¶è¿‡ç¨‹" tabindex="0" loading="lazy"><figcaption>åšå®¢å›­å¤šå°‘å¹…åº¦ï¼šä¸»ä»æ•°æ®å¤åˆ¶è¿‡ç¨‹</figcaption></figure><p>ä¸»ä»å®Œæˆå…¨é‡åŒæ­¥åï¼Œä¸»è¦ä¾é ä¼ æ’­å‘½ä»¤é˜¶æ®µæ¥ä¿æŒæ•°æ®çš„å¢é‡åŒæ­¥ã€‚ä¸»èŠ‚ç‚¹ä¼šå°†æ¯æ¬¡æ‰§è¡Œçš„å†™å‘½ä»¤å®æ—¶å‘é€ç»™æ‰€æœ‰ä»èŠ‚ç‚¹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250508145116.png" alt="ningGï¼šå‘½ä»¤ä¼ æ’­" tabindex="0" loading="lazy"><figcaption>ningGï¼šå‘½ä»¤ä¼ æ’­</figcaption></figure><p>Redis 2.8 ç‰ˆæœ¬åï¼Œä¸»èŠ‚ç‚¹ä¼šä¸ºæ¯ä¸ªä»èŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨æœ€è¿‘çš„å†™å‘½ä»¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250508144622.png" alt="MainWoodsï¼šå¤åˆ¶ç§¯å‹ç¼“å†²åŒº" tabindex="0" loading="lazy"><figcaption>MainWoodsï¼šå¤åˆ¶ç§¯å‹ç¼“å†²åŒº</figcaption></figure><p>å¢é‡å¤åˆ¶æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šæŠŠè¦åŒæ­¥çš„å†™å‘½ä»¤æš‚å­˜ä¸€ä»½åˆ°å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚è¿™æ ·å½“ä»èŠ‚ç‚¹å’Œä¸»èŠ‚ç‚¹å‘ç”Ÿç½‘ç»œæ–­è¿ï¼Œä»èŠ‚ç‚¹é‡æ–°è¿æ¥åï¼Œå¯ä»¥ä»å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­å¤åˆ¶å°šæœªåŒæ­¥çš„å†™å‘½ä»¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250508151116.png" alt="ä»æ‰¬ï¼šå¢é‡åŒæ­¥" tabindex="0" loading="lazy"><figcaption>ä»æ‰¬ï¼šå¢é‡åŒæ­¥</figcaption></figure><p>memoï¼š2025 å¹´ 5 æœˆ 8 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©æœ‰çƒå‹åœ¨<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æ˜Ÿçƒé‡Œå‘å¸–è¯´æ‹¿åˆ°äº†è…¾è®¯çš„å®ä¹  offer</a>ï¼ŒçœŸçš„è¦æ­å–œäº†ã€‚é¢ç»ï¼Œæˆ‘çœ‹é¢˜ç›®ä¸»è¦é›†ä¸­åœ¨æŠ€æœ¯æ´¾é¡¹ç›®å’ŒMySQLã€è®¡ç®—æœºç½‘ç»œçš„å…«è‚¡ä¸Šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250509114339.png" alt="çƒå‹æ‹¿åˆ°è…¾è®¯æš‘æœŸå®ä¹  offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°è…¾è®¯æš‘æœŸå®ä¹  offer</figcaption></figure><h3 id="_18-è¯¦ç»†è¯´è¯´å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥" tabindex="-1"><a class="header-anchor" href="#_18-è¯¦ç»†è¯´è¯´å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥"><span>18.è¯¦ç»†è¯´è¯´å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥ï¼Ÿ</span></a></h3><p>å…¨é‡åŒæ­¥ä¼šå°†ä¸»èŠ‚ç‚¹çš„å®Œæ•´æ•°æ®é›†ä¼ è¾“ç»™ä»èŠ‚ç‚¹ï¼Œé€šå¸¸å‘ç”Ÿåœ¨ä»èŠ‚ç‚¹é¦–æ¬¡è¿æ¥ä¸»èŠ‚ç‚¹æ—¶ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-aa8d2960-b341-49cc-b04c-201241fd15de.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå…¨é‡åŒæ­¥" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå…¨é‡åŒæ­¥</figcaption></figure><p>æ­¤æ—¶ï¼Œä»èŠ‚ç‚¹å‘é€ <code>psync ? -1</code> å‘½ä»¤è¯·æ±‚åŒæ­¥ã€‚<code>?</code> è¡¨ç¤ºä»èŠ‚ç‚¹æ²¡æœ‰ä¸»èŠ‚ç‚¹ IDï¼Œ<code>-1</code> è¡¨ç¤ºæ²¡æœ‰åç§»é‡ã€‚ä¸»èŠ‚ç‚¹æ”¶åˆ°åä¼šå›å¤ <code>FULLRESYNC</code>å“åº”ä»èŠ‚ç‚¹ã€‚åŒæ—¶ä¹Ÿä¼šåŒ…å«ä¸»åº“ runid å’Œå¤åˆ¶åç§»é‡ offset ä¸¤ä¸ªå‚æ•°ã€‚</p><p>ç„¶å fork ä¸€ä¸ªå­è¿›ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œå¹¶å°†æ–°çš„å†™å‘½ä»¤å­˜å…¥å¤åˆ¶ç¼“å†²åŒºã€‚</p><p>ä»åº“æ”¶åˆ° RDB æ–‡ä»¶åï¼Œæ¸…ç©ºæ—§æ•°æ®å¹¶åŠ è½½æ–°çš„ RDB æ–‡ä»¶ã€‚åŠ è½½å®Œæˆåï¼Œä»èŠ‚ç‚¹ä¼šå‘ä¸»èŠ‚ç‚¹å›å¤ç¡®è®¤æ¶ˆæ¯ï¼Œä¸»èŠ‚ç‚¹å†å°†å¤åˆ¶ç¼“å†²åŒºä¸­çš„æ•°æ®å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œç¡®ä¿ä»èŠ‚ç‚¹çš„æ•°æ®ä¸ä¸»èŠ‚ç‚¹ä¸€è‡´ã€‚</p><p>å…¨é‡åŒæ­¥çš„ä»£ä»·å¾ˆé«˜ï¼Œå› ä¸ºå®Œæ•´çš„ RDB æ–‡ä»¶åœ¨ç”Ÿæˆæ—¶ä¼šå ç”¨å¤§é‡çš„ CPU å’Œç£ç›˜ IOï¼›åœ¨ç½‘ç»œä¼ è¾“æ—¶è¿˜ä¼šæ¶ˆè€—æ‰ä¸å°‘å¸¦å®½ã€‚</p><p>äºæ˜¯ Redis åœ¨ 2.8 ç‰ˆæœ¬åå¼•å…¥äº†å¢é‡åŒæ­¥çš„æ¦‚å¿µï¼Œç›®çš„æ˜¯åœ¨æ–­çº¿é‡è¿åé¿å…å…¨é‡åŒæ­¥ã€‚</p><p>å¢é‡ä¾èµ–ä¸‰ä¸ªå…³é”®è¦ç´ ï¼š</p><p>â‘ ã€å¤åˆ¶åç§»é‡ï¼šä¸»ä»èŠ‚ç‚¹åˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡ï¼Œè®°å½•ä¼ è¾“çš„å­—èŠ‚æ•°ã€‚ä¸»èŠ‚ç‚¹æ¯ä¼ è¾“ N ä¸ªå­—èŠ‚æ•°æ®ï¼Œè‡ªèº«çš„å¤åˆ¶åç§»é‡å°±ä¼šå¢åŠ  Nï¼›ä»èŠ‚ç‚¹æ¯æ”¶åˆ° N ä¸ªå­—èŠ‚æ•°æ®ï¼Œä¹Ÿä¼šç›¸åº”å¢åŠ è‡ªå·±çš„åç§»é‡ã€‚</p><p>â‘¡ã€ä¸»èŠ‚ç‚¹ IDï¼šæ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€ IDï¼Œå³å¤åˆ¶ IDï¼Œç”¨äºæ ‡è¯†ä¸»èŠ‚ç‚¹çš„æ•°æ®ç‰ˆæœ¬ã€‚å½“ä¸»èŠ‚ç‚¹å‘ç”Ÿé‡å¯æˆ–è€…è§’è‰²å˜åŒ–æ—¶ï¼ŒID ä¼šæ”¹å˜ã€‚</p><p>â‘¢ã€å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼šä¸»èŠ‚ç‚¹ç»´æŠ¤çš„ä¸€ä¸ªå›ºå®šé•¿åº¦çš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º 1Mã€‚ä¸»èŠ‚ç‚¹åœ¨å‘ä»èŠ‚ç‚¹å‘é€å‘½ä»¤çš„åŒæ—¶ï¼Œä¹Ÿä¼šå°†å‘½ä»¤å†™å…¥è¿™ä¸ªç¼“å†²åŒºã€‚</p><p>å½“ä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹æ–­å¼€é‡è¿åï¼Œä¼šå‘é€ <code>psync{runId}{offset}</code> å‘½ä»¤ï¼Œå¸¦ä¸Šä¹‹å‰è®°å½•çš„ä¸»èŠ‚ç‚¹ ID å’Œå¤åˆ¶åç§»é‡ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-87600c72-cc6a-4656-81b2-e71864c97f23.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå¢é‡åŒæ­¥" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå¢é‡åŒæ­¥</figcaption></figure><p>ä¸»èŠ‚ç‚¹æ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œä¼šæ£€æŸ¥ runId å’Œ offsetï¼š</p><p>å¦‚æœä¸»èŠ‚ç‚¹ ID ä¸ä»èŠ‚ç‚¹æä¾›çš„ runId ä¸åŒ¹é…ï¼Œè¯´æ˜ä¸»èŠ‚ç‚¹å·²ç»å˜åŒ–ï¼Œå¿…é¡»è¿›è¡Œå…¨é‡åŒæ­¥ã€‚</p><p>å¦‚æœ ID åŒ¹é…ï¼Œä¸»èŠ‚ç‚¹ä¼šæŸ¥æ‰¾ä»èŠ‚ç‚¹è¯·æ±‚çš„åç§»é‡ä¹‹åçš„æ•°æ®æ˜¯å¦è¿˜åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚</p><p>å¦‚æœåœ¨ï¼Œåªå‘é€ä»è¯¥åç§»é‡å¼€å§‹çš„å¢é‡æ•°æ®ï¼Œè¿™å°±æ˜¯å¢é‡åŒæ­¥ï¼›å¦åˆ™è¯´æ˜æ–­çº¿æ—¶é—´å¤ªé•¿ï¼Œç§¯å‹ç¼“å†²åŒºå·²ç»è¦†ç›–äº†è¿™éƒ¨åˆ†æ•°æ®ï¼Œéœ€è¦å…¨é‡åŒæ­¥ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250509154335.png" alt="ç å“¥å­—èŠ‚ï¼šå¤åˆ¶ç§¯å‹ç¼“å†²åŒº" tabindex="0" loading="lazy"><figcaption>ç å“¥å­—èŠ‚ï¼šå¤åˆ¶ç§¯å‹ç¼“å†²åŒº</figcaption></figure><p>å¢é‡åŒæ­¥çš„ä¼˜åŠ¿æ˜¾è€Œæ˜“è§ï¼šåªä¼ è¾“æ–­çº¿æœŸé—´çš„å‘½ä»¤æ•°æ®ï¼Œå¤§å¤§å‡å°‘äº†ç½‘ç»œä¼ è¾“é‡å’Œä¸»ä»èŠ‚ç‚¹çš„è´Ÿè½½ï¼Œä»èŠ‚ç‚¹ä¹Ÿä¸éœ€è¦æ¸…ç©ºé‡è½½æ•°æ®ï¼Œèƒ½æ›´å¿«åœ°è·Ÿä¸Šä¸»èŠ‚ç‚¹çŠ¶æ€ã€‚</p><p>å¯¹äºå†™å…¥é¢‘ç¹æˆ–ç½‘ç»œä¸ç¨³å®šçš„ç¯å¢ƒï¼Œåº”è¯¥å¢å¤§å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°ï¼Œç¡®ä¿çŸ­æ—¶é—´æ–­çº¿åèƒ½è¿›è¡Œå¢é‡åŒæ­¥è€Œä¸æ˜¯å…¨é‡åŒæ­¥ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">repl-backlog-size</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1mb</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # é»˜è®¤å€¼ 1MBï¼Œè¡¨ç¤ºä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºå¤§å°</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">repl-backlog-ttl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3600</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  # é»˜è®¤å€¼ 3600 ç§’ï¼Œè¡¨ç¤ºä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºå­˜æ´»æ—¶é—´</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>memoï¼š2025 å¹´ 5 æœˆ 9 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">çƒå‹ç®€å†</a>æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªæ²³åŒ—å¤§å­¦ç¡•ä¸œåç†å·¥å¤§å­¦æœ¬çš„çƒå‹ï¼Œå¸Œæœ›è¿™ä¸ªå¤§å®¶åº­èƒ½ç»™å¤§å®¶å¸¦æ¥æ›´å¤šçš„å¸®åŠ©å’Œæ”¯æŒã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250509154541.png" alt="æ²³åŒ—å¤§å­¦çš„çƒå‹" tabindex="0" loading="lazy"><figcaption>æ²³åŒ—å¤§å­¦çš„çƒå‹</figcaption></figure><h3 id="_19-ä¸»ä»å¤åˆ¶å­˜åœ¨å“ªäº›é—®é¢˜å‘¢" tabindex="-1"><a class="header-anchor" href="#_19-ä¸»ä»å¤åˆ¶å­˜åœ¨å“ªäº›é—®é¢˜å‘¢"><span>19.ä¸»ä»å¤åˆ¶å­˜åœ¨å“ªäº›é—®é¢˜å‘¢ï¼Ÿ</span></a></h3><p>Redis ä¸»ä»å¤åˆ¶çš„æœ€å¤§æŒ‘æˆ˜æ¥è‡ªäºå®ƒçš„å¼‚æ­¥ç‰¹æ€§ï¼Œä¸»èŠ‚ç‚¹å¤„ç†å®Œå†™å‘½ä»¤åä¼šç«‹å³å“åº”å®¢æˆ·ç«¯ï¼Œè€Œä¸ä¼šç­‰å¾…ä»èŠ‚ç‚¹ç¡®è®¤ï¼Œè¿™å°±å¯¼è‡´åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250510110627.png" alt="leonshï¼šä¸»ä»åŒæ­¥" tabindex="0" loading="lazy"><figcaption>leonshï¼šä¸»ä»åŒæ­¥</figcaption></figure><p>å¦ä¸€ä¸ªå¸¸è§é—®é¢˜æ˜¯å…¨é‡åŒæ­¥å¯¹ç³»ç»Ÿçš„å†²å‡»ã€‚å…¨é‡åŒæ­¥ä¼šå ç”¨å¤§é‡çš„ CPU å’Œ IO èµ„æºï¼Œå°¤å…¶æ˜¯åœ¨å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œä¼šå¯¼è‡´ä¸»èŠ‚ç‚¹çš„æ€§èƒ½ä¸‹é™ã€‚</p><h4 id="è„‘è£‚é—®é¢˜äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#è„‘è£‚é—®é¢˜äº†è§£å—"><span>è„‘è£‚é—®é¢˜äº†è§£å—ï¼Ÿ</span></a></h4><p>åœ¨ Redis çš„å“¨å…µæ¶æ„ä¸­ï¼Œè„‘è£‚çš„å…¸å‹è¡¨ç°ä¸ºï¼šä¸»èŠ‚ç‚¹ä¸å“¨å…µã€ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œå‘ç”Ÿæ•…éšœäº†ï¼Œä½†ä¸å®¢æˆ·ç«¯çš„è¿æ¥æ˜¯æ­£å¸¸çš„ï¼Œå°±ä¼šå‡ºç°ä¸¤ä¸ªâ€œä¸»èŠ‚ç‚¹â€åŒæ—¶å¯¹å¤–æä¾›æœåŠ¡ã€‚</p><p>å“¨å…µè®¤ä¸ºä¸»èŠ‚ç‚¹å·²ç»ä¸‹çº¿äº†ï¼Œäºæ˜¯ä¼šå°†ä¸€ä¸ªä»èŠ‚ç‚¹é€‰ä¸¾ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚ä½†åŸä¸»èŠ‚ç‚¹å¹¶ä¸çŸ¥æƒ…ï¼Œä»ç„¶åœ¨ç»§ç»­å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250510112217.png" alt="æ©¡ çš® äººï¼šè„‘è£‚é—®é¢˜" tabindex="0" loading="lazy"><figcaption>æ©¡ çš® äººï¼šè„‘è£‚é—®é¢˜</figcaption></figure><p>ç­‰ä¸»èŠ‚ç‚¹ç½‘ç»œæ¢å¤æ­£å¸¸äº†ï¼Œå‘ç°å·²ç»æœ‰æ–°çš„ä¸»èŠ‚ç‚¹äº†ï¼Œäºæ˜¯åŸä¸»èŠ‚ç‚¹ä¼šè‡ªåŠ¨é™çº§ä¸ºä»èŠ‚ç‚¹ã€‚åœ¨é™çº§è¿‡ç¨‹ä¸­ï¼Œå®ƒéœ€è¦ä¸æ–°ä¸»èŠ‚ç‚¹è¿›è¡Œå…¨é‡åŒæ­¥ï¼Œæ­¤æ—¶åŸä¸»èŠ‚ç‚¹çš„æ•°æ®ä¼šè¢«æ¸…ç©ºã€‚å¯¼è‡´å®¢æˆ·ç«¯åœ¨åŸä¸»èŠ‚ç‚¹æ•…éšœæœŸé—´å†™å…¥çš„æ•°æ®å…¨éƒ¨ä¸¢å¤±ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250510114037.png" alt="æå®¢æ—¶é—´ï¼šè„‘è£‚é—®é¢˜å¯¼è‡´æ•°æ®ä¸¢å¤±" tabindex="0" loading="lazy"><figcaption>æå®¢æ—¶é—´ï¼šè„‘è£‚é—®é¢˜å¯¼è‡´æ•°æ®ä¸¢å¤±</figcaption></figure><p>ä¸ºäº†é˜²æ­¢è¿™ç§æ•°æ®ä¸¢å¤±ï¼ŒRedis æä¾›äº† min-slaves-to-write å’Œ min-slaves-max-lag å‚æ•°ã€‚</p><p>è¿™ä¸¤ä¸ªå‚æ•°å¯ä»¥è®¾ç½®æœ€å°‘éœ€è¦å¤šå°‘ä¸ªä»èŠ‚ç‚¹åœ¨çº¿ï¼Œä»¥åŠä»èŠ‚ç‚¹çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># è®¾ç½®ä¸»èŠ‚ç‚¹èƒ½è¿›è¡Œæ•°æ®åŒæ­¥çš„æœ€å°‘ä»èŠ‚ç‚¹æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">min-slaves-to-write</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># è®¾ç½®ä¸»ä»èŠ‚ç‚¹é—´è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œä»èŠ‚ç‚¹ç»™ä¸»èŠ‚ç‚¹å‘é€ ACK æ¶ˆæ¯çš„æœ€å¤§å»¶è¿Ÿï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">min-slaves-max-lag</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è®¾ç½®è¿™ä¸¤ä¸ªå‚æ•°åï¼Œå¦‚æœä¸»èŠ‚ç‚¹è¿æ¥ä¸åˆ°æŒ‡å®šæ•°é‡çš„ä»èŠ‚ç‚¹ï¼Œæˆ–è€…ä»èŠ‚ç‚¹å“åº”è¶…æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šæ‹’ç»å†™å…¥è¯·æ±‚ï¼Œä»è€Œé¿å…è„‘è£‚æœŸé—´çš„æ•°æ®å†²çªã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå½“ç½‘ç»œåˆ†åŒºå‘ç”Ÿï¼Œä¸»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹ã€å“¨å…µä¹‹é—´çš„è¿æ¥æ–­å¼€ï¼Œä½†ä¸»èŠ‚ç‚¹ä¸å®¢æˆ·ç«¯çš„è¿æ¥æ­£å¸¸æ—¶ï¼Œç”±äºä¸»èŠ‚ç‚¹æ— æ³•å†è¿æ¥åˆ°ä»»ä½•ä»èŠ‚ç‚¹ï¼Œæˆ–è€…å»¶è¿Ÿè¶…è¿‡äº†è®¾å®šå€¼ï¼Œæ¯”å¦‚è¯´é…ç½®äº†<code>min-slaves-to-write 1</code>ï¼Œä¸»èŠ‚ç‚¹å°±ä¼šè‡ªåŠ¨æ‹’ç»æ‰€æœ‰å†™è¯·æ±‚ã€‚</p><p>åŒæ—¶åœ¨ç½‘ç»œçš„å¦ä¸€ä¾§ï¼Œå“¨å…µä¼šæ£€æµ‹åˆ°ä¸»èŠ‚ç‚¹&quot;ä¸‹çº¿&quot;ï¼Œé€‰ä¸¾ä¸€ä¸ªä»èŠ‚ç‚¹æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚ç”±äºåŸä¸»èŠ‚ç‚¹å·²ç»åœæ­¢æ¥å—å†™å…¥ï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿæ–°çš„æ•°æ®å˜æ›´ï¼Œç­‰ç½‘ç»œæ¢å¤åï¼Œå³ä½¿åŸä¸»èŠ‚ç‚¹é™çº§ä¸ºä»èŠ‚ç‚¹å¹¶è¿›è¡Œå…¨é‡åŒæ­¥ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±ç½‘ç»œåˆ†åŒºæœŸé—´çš„å†™å…¥æ•°æ®ï¼Œå› ä¸ºæ ¹æœ¬å°±æ²¡æœ‰æ–°çš„å†™å…¥å‘ç”Ÿã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šä¸»ä»å¤åˆ¶æœ‰ä»€ä¹ˆç¼ºç‚¹å‘¢ï¼Ÿredisçš„è„‘è£‚é—®é¢˜</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 10 æ—¥ä»Šå¤©æŠŠæ–°é¡¹ç›®çš„å‰ç½®ç¯å¢ƒä¹Ÿé…çš„ä¸ƒä¸ƒå…«å…«äº†ï¼Œè¿˜å·®ä¸€ä¸ª Kafka çš„å®‰è£…æ•™ç¨‹ã€‚æ—¥æ‹±ä¸€å’ï¼Œäº‰å–<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">ç§‹æ‹›å‰ç»™å¤§å®¶çƒå‹ä»¬è§é¢</a>ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250510220656.png" alt="æ˜Ÿçƒæ–°é¡¹ç›®çš„è¿›åº¦ï¼šå‰ç½®ç¯å¢ƒçš„æ•™ç¨‹" tabindex="0" loading="lazy"><figcaption>æ˜Ÿçƒæ–°é¡¹ç›®çš„è¿›åº¦ï¼šå‰ç½®ç¯å¢ƒçš„æ•™ç¨‹</figcaption></figure><h3 id="_20-rediså“¨å…µæœºåˆ¶äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#_20-rediså“¨å…µæœºåˆ¶äº†è§£å—"><span>20.Rediså“¨å…µæœºåˆ¶äº†è§£å—ï¼Ÿ</span></a></h3><p>Redis ä¸­çš„å“¨å…µç”¨äºç›‘æ§ä¸»ä»é›†ç¾¤çš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åœ¨ä¸»èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-8b1a055c-f077-49ff-9432-c194d4fc3639.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis Sentinel" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis Sentinel</figcaption></figure><p>æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ç›‘æ§ã€é€šçŸ¥å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚å“¨å…µä¼šå®šæœŸæ£€æŸ¥ä¸»ä»èŠ‚ç‚¹æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œï¼Œå½“æ£€æµ‹åˆ°ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œå°±åœ¨ä»èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶é€šçŸ¥å®¢æˆ·ç«¯è¿æ¥åˆ°æ–°çš„ä¸»èŠ‚ç‚¹ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># ç›‘æ§çš„ä¸»èŠ‚ç‚¹ä¿¡æ¯ + å¤šå°‘ä¸ªå“¨å…µåŒæ„æ‰ç®—å®•æœº</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> monitor</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 127.0.0.1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6379</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># å¤šä¹…ä¸å“åº”å°±æ ‡è®°ä¸ºâ€œä¸»è§‚ä¸‹çº¿â€</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> down-after-milliseconds</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> failover-timeout</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60000</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># åŒæ—¶å…è®¸å¤šå°‘ä¸ªä»èŠ‚ç‚¹åŒæ­¥æ–°ä¸»èŠ‚ç‚¹æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sentinel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parallel-syncs</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mymaster</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æ¯”äºšè¿ªé¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRedis çš„å“¨å…µæœºåˆ¶äº†è§£å—ï¼Ÿ</li></ol></blockquote><h3 id="_21-rediså“¨å…µçš„å·¥ä½œåŸç†çŸ¥é“å—" tabindex="-1"><a class="header-anchor" href="#_21-rediså“¨å…µçš„å·¥ä½œåŸç†çŸ¥é“å—"><span>21.Rediså“¨å…µçš„å·¥ä½œåŸç†çŸ¥é“å—ï¼Ÿ</span></a></h3><p>å“¨å…µçš„å·¥ä½œåŸç†å¯ä»¥æ¦‚æ‹¬ä¸º 4 ä¸ªå…³é”®æ­¥éª¤ï¼šå®šæ—¶ç›‘æ§ã€ä¸»è§‚ä¸‹çº¿ã€é¢†å¯¼è€…é€‰ä¸¾å’Œæ•…éšœè½¬ç§»ã€‚</p><p>é¦–å…ˆï¼Œå“¨å…µä¼šå®šæœŸå‘æ‰€æœ‰ Redis èŠ‚ç‚¹å‘é€ PING å‘½ä»¤æ¥æ£€æµ‹å®ƒä»¬æ˜¯å¦å¯è¾¾ã€‚å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œå“¨å…µä¼šå°†è¯¥èŠ‚ç‚¹æ ‡è®°ä¸ºâ€œä¸»è§‚ä¸‹çº¿â€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250511135906.png" alt="åŸé‡æ¼«æ­¥ï¼šsentinel" tabindex="0" loading="lazy"><figcaption>åŸé‡æ¼«æ­¥ï¼šsentinel</figcaption></figure><p>å½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿åï¼Œä¼šè¯¢é—®å…¶ä»–å“¨å…µçš„æ„è§ï¼Œå¦‚æœè¾¾åˆ°é…ç½®çš„æ³•å®šäººæ•°ï¼Œä¸»èŠ‚ç‚¹ä¼šè¢«æ ‡è®°ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-11839a24-9249-48a5-8c9d-888aa80d91dc.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿</figcaption></figure><p>ç„¶åå¼€å§‹æ•…éšœè½¬ç§»ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå“¨å…µä¼šå…ˆé€‰ä¸¾å‡ºä¸€ä¸ªé¢†å¯¼è€…ï¼Œé¢†å¯¼è€…å†ä»ä»èŠ‚ç‚¹ä¸­é€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆçš„èŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œé€‰æ‹©æ ‡å‡†åŒ…æ‹¬å¤åˆ¶åç§»é‡ã€ä¼˜å…ˆçº§ç­‰å› ç´ ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250511141612.png" alt="å›´é¾™å°å­ï¼šé¢†å¯¼è€…é€‰ä¸¾" tabindex="0" loading="lazy"><figcaption>å›´é¾™å°å­ï¼šé¢†å¯¼è€…é€‰ä¸¾</figcaption></figure><p>ç¡®å®šæ–°ä¸»èŠ‚ç‚¹åï¼Œå“¨å…µä¼šå‘å…¶å‘é€ <code>SLAVEOF NO ONE</code> å‘½ä»¤ä½¿å…¶å‡çº§ä¸ºä¸»èŠ‚ç‚¹ï¼Œç„¶åå‘å…¶ä»–ä»èŠ‚ç‚¹å‘é€ SLAVEOF å‘½ä»¤æŒ‡å‘æ–°ä¸»èŠ‚ç‚¹ï¼Œæœ€åé€šè¿‡å‘å¸ƒ/è®¢é˜…æœºåˆ¶é€šçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹å·²ç»å‘ç”Ÿå˜åŒ–ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250511141103.png" alt="ä¸€æ³½æ¶Ÿæ¼ªï¼šRedis Sentinelæ•…éšœè½¬ç§»" tabindex="0" loading="lazy"><figcaption>ä¸€æ³½æ¶Ÿæ¼ªï¼šRedis Sentinelæ•…éšœè½¬ç§»</figcaption></figure><p>åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œä¸ºäº†ä¿è¯å“¨å…µæœºåˆ¶çš„å¯é æ€§ï¼Œé€šå¸¸å»ºè®®è‡³å°‘éƒ¨ç½²ä¸‰ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œå¹¶ä¸”è¿™äº›èŠ‚ç‚¹åº”åˆ†å¸ƒåœ¨ä¸åŒçš„ç‰©ç†æœºå™¨ä¸Šï¼Œé™ä½å•ç‚¹æ•…éšœé£é™©ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250512171147.png" alt="å®ˆæ ªé˜ï¼šå“¨å…µæ•…éšœè½¬ç§»" tabindex="0" loading="lazy"><figcaption>å®ˆæ ªé˜ï¼šå“¨å…µæ•…éšœè½¬ç§»</figcaption></figure><p>åŒæ—¶ï¼Œæ³•å®šäººæ•°çš„è®¾ç½®ä¹Ÿéå¸¸å…³é”®ï¼Œä¸€èˆ¬å»ºè®®è®¾ç½®ä¸ºå“¨å…µæ•°é‡çš„ä¸€åŠåŠ ä¸€ï¼Œæ—¢èƒ½ç¡®ä¿åœ¨å°‘æ•°å“¨å…µæ•…éšœæ—¶ç³»ç»Ÿä»èƒ½æ­£å¸¸å·¥ä½œï¼Œåˆèƒ½é¿å…ç½‘ç»œåˆ†åŒºå¯¼è‡´çš„è„‘è£‚é—®é¢˜ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ OPPO é¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRedisçš„Sentinelå’ŒClusteræ€ä¹ˆç†è§£ï¼Ÿè¯´ä¸€ä¸‹å¤§æ¦‚åŸç†</li></ol></blockquote><p>memoï¼šè´´ä¸€ä¸ªè¯»è€…å¯¹ Java è¿›é˜¶ä¹‹è·¯çš„ç¾èµå§ï¼Œæˆ‘ä¹Ÿæ˜¯äººï¼Œä¹Ÿéœ€è¦å¤§å®¶çš„æƒ…ç»ªå…±é¸£ï¼Œå“ˆå“ˆï¼Œå°±è®©èµç¾å¤šä¸€ç‚¹å§ğŸ˜„</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250511142127.png" alt="è¯»è€…å¯¹ Java è¿›é˜¶ä¹‹è·¯çš„ç¾èµ" tabindex="0" loading="lazy"><figcaption>è¯»è€…å¯¹ Java è¿›é˜¶ä¹‹è·¯çš„ç¾èµ</figcaption></figure><h3 id="_22-redisé¢†å¯¼è€…é€‰ä¸¾äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#_22-redisé¢†å¯¼è€…é€‰ä¸¾äº†è§£å—"><span>22.Redisé¢†å¯¼è€…é€‰ä¸¾äº†è§£å—ï¼Ÿ</span></a></h3><p>Redis ä½¿ç”¨ Raft ç®—æ³•å®ç°é¢†å¯¼è€…é€‰ä¸¾ï¼Œç›®çš„æ˜¯åœ¨ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œé€‰å‡ºä¸€ä¸ªå“¨å…µæ¥è´Ÿè´£æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240819112712.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šé¢†å¯¼è€…é€‰ä¸¾" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šé¢†å¯¼è€…é€‰ä¸¾</figcaption></figure><p>é€‰ä¸¾è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p>â‘ ã€å½“ä¸€ä¸ªå“¨å…µç¡®è®¤ä¸»èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿åï¼Œä¼šå‘å…¶ä»–å“¨å…µèŠ‚ç‚¹å‘é€è¯·æ±‚ï¼Œè¡¨æ˜å¸Œæœ›ç”±è‡ªå·±æ¥æ‰§è¡Œä¸»ä»åˆ‡æ¢ï¼Œå¹¶è®©æ‰€æœ‰å…¶ä»–å“¨å…µè¿›è¡ŒæŠ•ç¥¨ã€‚å€™é€‰è€…ä¼šå…ˆç»™è‡ªå·±å…ˆæŠ• 1 ç¥¨ï¼Œç„¶åç­‰å¾…å…¶ä»–å“¨å…µèŠ‚ç‚¹çš„æŠ•ç¥¨ç»“æœã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// sentinel.cä¸­çš„sentinelAskMasterStateToOtherSentinelså‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sentinelAskMasterStateToOtherSentinels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    dictIterator </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">di;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    dictEntry </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">de;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    di </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> dictGetIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">sentinels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((de </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> dictNext</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(di)) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">sentinel </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> dictGetVal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(de);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> retval;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // åªæœ‰åœ¨è¿›å…¥é¢†å¯¼è€…é€‰ä¸¾é˜¶æ®µæ‰å‘é€æŠ•ç¥¨è¯·æ±‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">failover_state</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SENTINEL_FAILOVER_STATE_SELECT_LEADER) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // å‘é€ç‰¹æ®Šçš„is-master-down-by-addrå‘½ä»¤è¯·æ±‚æŠ•ç¥¨</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            retval </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> redisAsyncCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                sentinelReceiveVoteFromSentinel, sentinel,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                &quot;SENTINEL is-master-down-by-addr </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%s</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> %d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> %llu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> %s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">failover_epoch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // è¿™é‡Œå‘é€è‡ªå·±çš„runidè¯·æ±‚æŠ•ç¥¨</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                sentinelGetMyRunID</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // å¦åˆ™åªè¯¢é—®ä¸»èŠ‚ç‚¹çŠ¶æ€ï¼Œä¸è¯·æ±‚æŠ•ç¥¨</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            retval </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> redisAsyncCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                sentinelReceiveIsMasterDownReply, sentinel,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                &quot;SENTINEL is-master-down-by-addr </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%s</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> %d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> %llu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> *&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    dictReleaseIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(di);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘¡ã€æ”¶åˆ°è¯·æ±‚çš„å“¨å…µèŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå€™é€‰è€…çš„æ—¥å¿—å’Œè‡ªå·±çš„ä¸€æ ·æ–°ï¼Œä»»æœŸå·ä¹Ÿå°äºè‡ªå·±ï¼Œä¸”ä¹‹å‰æ²¡æœ‰æŠ•ç¥¨è¿‡ï¼Œå°±ä¼šæŠ•åŒæ„ç¥¨ Yã€‚å¦åˆ™å›å¤ Nã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// sentinel.cä¸­çš„sentinelCommandå‡½æ•°éƒ¨åˆ†(å¤„ç†SENTINELå‘½ä»¤)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å¤„ç†is-master-down-by-addrå‘½ä»¤</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">strcasecmp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">c</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">argv</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">]</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;is-master-down-by-addr&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /* SENTINEL IS-MASTER-DOWN-BY-ADDR &lt;ip&gt; &lt;port&gt; &lt;current-epoch&gt; &lt;runid&gt; */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ri;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">master_ip </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">argv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> master_port </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> atoi</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">argv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    long</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> req_epoch </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> strtoull</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">argv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">req_runid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">argv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isdown </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">leader </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;*&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    long</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> leader_epoch </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ri </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sentinelGetMasterByAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(master_ip, master_port);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (ri) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        isdown </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ri</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">flags</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SRI_S_DOWN;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // åˆ¤æ–­æ˜¯å¦æ˜¯æŠ•ç¥¨è¯·æ±‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">req_runid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;*&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å½“å‰é…ç½®çºªå…ƒä¸­æŠ•è¿‡ç¥¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (req_epoch </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">current_epoch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // æ›´æ–°è‡ªå·±çš„é…ç½®çºªå…ƒ</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">current_epoch</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> req_epoch;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // å¦‚æœæˆ‘ä»¬è§‰å¾—ä¸»èŠ‚ç‚¹ä¸‹çº¿äº†ï¼Œä¸”åœ¨è¿™ä¸ªepochè¿˜æ²¡æŠ•è¿‡ç¥¨ï¼Œåˆ™æŠ•ç¥¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (isdown </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">current_epoch</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> req_epoch </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">leader_epoch</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> req_epoch)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // è®°å½•æŠ•ç¥¨ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">leader_epoch</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> req_epoch;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">leader</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sdsnew</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(req_runid);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                leader </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> req_runid;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                leader_epoch </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> req_epoch;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // è¿”å›æŠ•ç¥¨ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    addReplyMultiBulkLen</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(c,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    addReplyLongLong</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(c, isdown);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    addReplyBulkCString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(c, leader);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    addReplyLongLong</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(c, leader_epoch);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘¢ã€å€™é€‰è€…æ”¶åˆ°æŠ•ç¥¨åä¼šç»Ÿè®¡è‡ªå·±çš„å¾—ç¥¨æ•°ï¼Œå¦‚æœè·å¾—äº†é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°èŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œå®ƒå°±ä¼šå½“é€‰ä¸ºé¢†å¯¼è€…ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// sentinel.cä¸­çš„sentinelReceiveVoteFromSentinelå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sentinelReceiveVoteFromSentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">redisAsyncContext </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">privdata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">sentinel </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> privdata;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">master </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    redisReply </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">r </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> reply;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">leader </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å¤„ç†å›å¤</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">r</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">type</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> REDIS_REPLY_ARRAY </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> r</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">elements</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // è§£æå›å¤ä¸­çš„leaderä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">r</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">element</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">type</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> REDIS_REPLY_STRING)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            leader </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> r</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">element</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">str</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ£€æŸ¥æ˜¯å¦æŠ•ç»™äº†æˆ‘ä»¬</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (leader </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> strcmp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(leader, </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sentinelGetMyRunID</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // è®°å½•è·å¾—ä¸€ç¥¨</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            dictAdd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">sentinels_voted</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sdsnew</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">runid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">), sentinel);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ£€æŸ¥æ˜¯å¦è·å¾—å¤šæ•°ç¥¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">failover_state</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SENTINEL_FAILOVER_STATE_SELECT_LEADER) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> voters </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> dictSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">sentinels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // +1æ˜¯å› ä¸ºåŒ…æ‹¬è‡ªå·±</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> votes </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> dictSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">sentinels_voted</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // è‡ªå·±ä¹Ÿç®—ä¸€ç¥¨</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å¦‚æœè·å¾—å¤šæ•°ç¥¨(å¤§äºä¸€åŠ)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (votes </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> voters</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // æˆä¸ºé¢†å¯¼è€…ï¼Œå¼€å§‹æ‰§è¡Œæ•…éšœè½¬ç§»</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            sentinelEvent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(LL_WARNING, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;+elected-leader&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, master, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">@&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">failover_state</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SENTINEL_FAILOVER_STATE_FAILOVER_IN_PROGRESS;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            sentinelFailoverSelectSlave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(master);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘£ã€å¦‚æœæ²¡æœ‰å“¨å…µåœ¨è¿™ä¸€è½®æŠ•ç¥¨ä¸­è·å¾—è¶…è¿‡åŠæ•°çš„é€‰ç¥¨ï¼Œè¿™æ¬¡é€‰ä¸¾å°±ä¼šå¤±è´¥ï¼Œç„¶åè¿›è¡Œä¸‹ä¸€è½®çš„é€‰ä¸¾ã€‚ä¸ºäº†é˜²æ­¢æ— é™åˆ¶çš„é€‰ä¸¾å¤±è´¥ï¼Œæ¯ä¸ªå“¨å…µéƒ½ä¼šæœ‰ä¸€ä¸ªé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œä¸”æ˜¯éšæœºçš„ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// sentinel.cä¸­çš„sentinelFailoverSelectLeaderå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sentinelFailoverSelectLeader</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ£€æŸ¥é€‰ä¸¾æ˜¯å¦è¶…æ—¶</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">    mstime_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> election_timeout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SENTINEL_ELECTION_TIMEOUT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mstime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">failover_start_time</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> election_timeout) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // é€‰ä¸¾è¶…æ—¶ï¼Œé‡ç½®çŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        sentinelEvent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(LL_WARNING, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;-failover-abort-timeout&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, master, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">@&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        sentinelAbortFailover</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(master);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ... å…¶ä»–é€‰ä¸¾é€»è¾‘ ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å¦‚æœæ²¡æœ‰è¶³å¤Ÿç¥¨æ•°ä¸”æœªè¶…æ—¶ï¼Œåˆ™ç»§ç»­ç­‰å¾…</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œ SENTINEL_ELECTION_TIMEOUT_MIN é€šå¸¸ä¸º 0ï¼ŒSENTINEL_ELECTION_TIMEOUT_MAX é€šå¸¸ä¸º 2000 æ¯«ç§’ã€‚è¿™æ ·æ¯ä¸ªå“¨å…µä¼šåœ¨ 0-2 ç§’çš„éšæœºæ—¶é—´åå¼€å§‹é€‰ä¸¾ï¼Œå‡å°‘é€‰ä¸¾å†²çªã€‚</p><p>æ¨èé˜…è¯»ï¼š<a href="https://hoverzheng.github.io/post/technology-blog/blockchain/raft%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A33--%E9%80%89%E4%B8%BB/" target="_blank" rel="noopener noreferrer">Raftç®—æ³•çš„é€‰ä¸»è¿‡ç¨‹è¯¦è§£</a></p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„8 åç«¯å¼€å‘ç§‹æ‹›ä¸€é¢é¢è¯•åŸé¢˜ï¼šraftä¸»èŠ‚ç‚¹æŒ‚äº†æ€ä¹ˆé€‰ä»èŠ‚ç‚¹</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 12 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘å¾®ä¿¡</a>è¯´æ‹¿åˆ°äº†ä¸‰ä¸ªå¤§å‚çš„ offerï¼Œåˆ†åˆ«æ˜¯èš‚èšã€ç¾å›¢å’Œè…¾è®¯ï¼ŒçœŸçš„æ˜¯å¤ªä¼˜ç§€äº†å‘€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250512174725.png" alt="çƒå‹æ‹¿åˆ°äº†èš‚èšã€ç¾å›¢å’Œè…¾è®¯çš„ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†èš‚èšã€ç¾å›¢å’Œè…¾è®¯çš„ offer</figcaption></figure><h3 id="_23-æ–°çš„ä¸»èŠ‚ç‚¹æ˜¯æ€æ ·è¢«æŒ‘é€‰å‡ºæ¥çš„" tabindex="-1"><a class="header-anchor" href="#_23-æ–°çš„ä¸»èŠ‚ç‚¹æ˜¯æ€æ ·è¢«æŒ‘é€‰å‡ºæ¥çš„"><span>23.æ–°çš„ä¸»èŠ‚ç‚¹æ˜¯æ€æ ·è¢«æŒ‘é€‰å‡ºæ¥çš„ï¼Ÿ</span></a></h3><p>å“¨å…µåœ¨æŒ‘é€‰æ–°çš„ä¸»èŠ‚ç‚¹æ—¶ï¼Œéå¸¸ç²¾ç»†åŒ–ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-03976d35-20b6-4efe-aa9c-7d3759460d34.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ–°ä¸»èŠ‚ç‚¹çš„æŒ‘é€‰è¿‡ç¨‹" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ–°ä¸»èŠ‚ç‚¹çš„æŒ‘é€‰è¿‡ç¨‹</figcaption></figure><p>é¦–å…ˆï¼Œå“¨å…µä¼šå¯¹æ‰€æœ‰ä»èŠ‚ç‚¹è¿›è¡Œä¸€è½®åŸºç¡€ç­›é€‰ï¼Œæ’é™¤é‚£äº›ä¸æ»¡è¶³åŸºæœ¬æ¡ä»¶çš„èŠ‚ç‚¹ã€‚æ¯”å¦‚è¯´å·²ä¸‹çº¿çš„èŠ‚ç‚¹ã€ç½‘ç»œè¿æ¥ä¸ç¨³å®šçš„èŠ‚ç‚¹ï¼Œä»¥åŠä¼˜å…ˆçº§è®¾ä¸º 0 æ˜ç¡®ä¸å‚ä¸æŒ‘é€‰çš„èŠ‚ç‚¹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ç¬¬ä¸€è½®ç­›é€‰ï¼šæ’é™¤ä¸æ»¡è¶³åŸºæœ¬æ¡ä»¶çš„ä»èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> numslaves; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">slave </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> slaves</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ’é™¤å·²ä¸‹çº¿çš„ä»èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">slave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">flags</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (SRI_S_DOWN</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SRI_O_DOWN)) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ’é™¤æ–­å¼€è¿æ¥çš„ä»èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">slave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">link</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">disconnected</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ’é™¤è¿‘æœŸï¼ˆ5ç§’å†…ï¼‰æ–­è¿‡è¿çš„ä»èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mstime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> slave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">link</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">last_avail_time</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ’é™¤æœªå»ºç«‹ä¸»ä»å¤åˆ¶çš„èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">slave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">slave_priority</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ä»èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    selected </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œå“¨å…µä¼šå¯¹å‰©ä¸‹çš„ä»èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œé€‰å‡ºæœ€åˆé€‚çš„ä¸»èŠ‚ç‚¹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// sentinel.cä¸­çš„compareSlaveså‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> compareSlaves</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // 1. é¦–å…ˆæ¯”è¾ƒç”¨æˆ·è®¾ç½®çš„ä¼˜å…ˆçº§ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">slave_priority</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">slave_priority</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">slave_priority</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">slave_priority</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // 2. å¦‚æœä¼˜å…ˆçº§ç›¸åŒï¼Œæ¯”è¾ƒå¤åˆ¶åç§»é‡ï¼Œåç§»é‡è¶Šå¤§æ•°æ®è¶Šæ–°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">slave_repl_offset</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">slave_repl_offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">slave_repl_offset</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">slave_repl_offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // 3. å¦‚æœå¤åˆ¶åç§»é‡ä¹Ÿç›¸åŒï¼Œæ¯”è¾ƒè¿è¡ŒIDçš„å­—å…¸åº</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">strcmp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">runid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">runid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ’åºçš„æ ‡å‡†æœ‰ä¸‰ä¸ªï¼š</p><p>â‘ ã€<strong>ä»èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼š</strong> slave-priority çš„å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œä¼˜å…ˆçº§ä¸º 0 çš„ä»èŠ‚ç‚¹ä¸ä¼šè¢«é€‰ä¸­ã€‚</p><p>â‘¡ã€<strong>å¤åˆ¶åç§»é‡ï¼š</strong> åç§»é‡è¶Šå¤§æ„å‘³ç€ä»èŠ‚ç‚¹çš„æ•°æ®è¶Šæ–°ï¼Œå¤åˆ¶çš„è¶Šå®Œæ•´ã€‚</p><p>â‘¢ã€<strong>è¿è¡Œ IDï¼š</strong> å¦‚æœä¼˜å…ˆçº§å’Œåç§»é‡éƒ½ç›¸åŒï¼Œå°±æ¯”è¾ƒè¿è¡Œ ID çš„å­—å…¸åºï¼Œå­—å…¸åºå°çš„ä¼˜å…ˆã€‚</p><p>é€‰å‡ºæ–°ä¸»èŠ‚ç‚¹åï¼Œå“¨å…µä¼šå‘å…¶å‘é€ <code>SLAVEOF NO ONE</code> å‘½ä»¤å°†å…¶æå‡ä¸ºä¸»èŠ‚ç‚¹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// sentinel.cä¸­çš„sentinelFailoverPromoteSlaveå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sentinelFailoverPromoteSlave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sentinelRedisInstance </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ... é€‰æ‹©æœ€ä½³ä»èŠ‚ç‚¹çš„é€»è¾‘ ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å‘é€‰ä¸­çš„ä»èŠ‚ç‚¹å‘é€SLAVEOF NO ONEå‘½ä»¤ï¼Œä½¿å…¶æˆä¸ºä¸»èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    retval </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> redisAsyncCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">slave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">link</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        sentinelReceivePromotionResponseFromSlave, master,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;SLAVEOF NO ONE&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ›´æ–°çŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">promoted_slave</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> slave;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    slave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">flags</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> |=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SRI_PROMOTED;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // è®°å½•æ—¥å¿—</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    sentinelEvent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(LL_WARNING, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;+promoted-slave&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, slave, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">@&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    sentinelEvent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(LL_WARNING, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;+failover-state-wait-promotion&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, master, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">@&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹åï¼Œå“¨å…µä¼šç­‰å¾…æ–°ä¸»èŠ‚ç‚¹çš„è§’è‰²è½¬æ¢å®Œæˆï¼Œé€šè¿‡å‘é€ INFO å‘½ä»¤æ£€æŸ¥å…¶è§’è‰²æ˜¯å¦å·²å˜ä¸º master æ¥ç¡®è®¤ã€‚ç¡®è®¤æˆåŠŸåï¼Œä¼šæ›´æ–°æ‰€æœ‰ä»èŠ‚ç‚¹çš„å¤åˆ¶ç›®æ ‡ï¼ŒæŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SLAVEOF</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> new-master-ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> new-master-port</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>memoï¼š2025 å¹´ 5 æœˆ 13 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘å¾®ä¿¡</a>è¯´æ‹¿åˆ°äº†æºç¨‹çš„ offerï¼Œæºç¨‹ç°åœ¨ä¹Ÿæ˜¯ç¬¬äºŒæ¢¯é˜Ÿçš„äº’è”ç½‘å¤§å‚äº†ï¼Œå€¼å¾—ä¸€æ‰‹æ­å–œå•Šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-è¿™ä¸ç”¨é€‰ï¼Œè‚¯å®šæœ‰é™æºç¨‹å•Š.png" alt="çƒå‹æ‹¿åˆ°äº†æºç¨‹çš„å®ä¹  offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†æºç¨‹çš„å®ä¹  offer</figcaption></figure><h3 id="_24-redisé›†ç¾¤äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#_24-redisé›†ç¾¤äº†è§£å—"><span>24.Redisé›†ç¾¤äº†è§£å—ï¼Ÿ</span></a></h3><p>ä¸»ä»å¤åˆ¶å®ç°äº†è¯»å†™åˆ†ç¦»å’Œæ•°æ®å¤‡ä»½ï¼Œå“¨å…µæœºåˆ¶å®ç°äº†ä¸»èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5cbc6009-251e-4d5b-8f22-8d543938eccb.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisé›†ç¾¤ç¤ºæ„å›¾" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisé›†ç¾¤ç¤ºæ„å›¾</figcaption></figure><p>é›†ç¾¤æ¶æ„æ˜¯å¯¹å‰ä¸¤ç§æ–¹æ¡ˆçš„è¿›ä¸€æ­¥æ‰©å±•å’Œå®Œå–„ï¼Œé€šè¿‡æ•°æ®åˆ†ç‰‡è§£å†³ Redis å•æœºå†…å­˜å¤§å°çš„é™åˆ¶ï¼Œå½“ç”¨æˆ·åŸºæ•°ä»ç™¾ä¸‡å¢é•¿åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼Œæˆ‘ä»¬åªéœ€ç®€å•åœ°å‘é›†ç¾¤ä¸­æ·»åŠ èŠ‚ç‚¹ï¼Œå°±èƒ½è½»æ¾åº”å¯¹ä¸æ–­å¢é•¿çš„æ•°æ®é‡å’Œè®¿é—®å‹åŠ›ã€‚</p><p>æ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥å°†å•å®ä¾‹æ¨¡å¼ä¸‹çš„æ•°æ®å¹³å‡åˆ†ä¸º 5 ä»½ï¼Œç„¶åå¯åŠ¨ 5 ä¸ª Redis å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹ä¿å­˜ 5G çš„æ•°æ®ï¼Œä»è€Œå®ç°é›†ç¾¤åŒ–ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240408104101.png" alt="æå®¢æ—¶é—´ï¼šåˆ‡ç‰‡é›†ç¾¤æ¶æ„å›¾" tabindex="0" loading="lazy"><figcaption>æå®¢æ—¶é—´ï¼šåˆ‡ç‰‡é›†ç¾¤æ¶æ„å›¾</figcaption></figure><h3 id="_25-è¯·è¯¦ç»†è¯´ä¸€è¯´redis-cluster-è¡¥å……" tabindex="-1"><a class="header-anchor" href="#_25-è¯·è¯¦ç»†è¯´ä¸€è¯´redis-cluster-è¡¥å……"><span>25.è¯·è¯¦ç»†è¯´ä¸€è¯´Redis Clusterï¼Ÿï¼ˆè¡¥å……ï¼‰</span></a></h3><blockquote><p>2024 å¹´ 04 æœˆ 26 æ—¥æ–°å¢</p></blockquote><p>Redis Cluster æ˜¯ Redis å®˜æ–¹æä¾›çš„ä¸€ç§åˆ†å¸ƒå¼é›†ç¾¤è§£å†³æ–¹æ¡ˆã€‚å…¶æ ¸å¿ƒç†å¿µæ˜¯å»ä¸­å¿ƒåŒ–ï¼Œé‡‡ç”¨ P2P æ¨¡å¼ï¼Œæ²¡æœ‰ä¸­å¿ƒèŠ‚ç‚¹çš„æ¦‚å¿µã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ç€æ•°æ®å’Œæ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šè¿‡ gossip åè®®äº¤æ¢ä¿¡æ¯ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250514144353.png" alt="Rajat Pachauriï¼šRedis Cluster" tabindex="0" loading="lazy"><figcaption>Rajat Pachauriï¼šRedis Cluster</figcaption></figure><p>åœ¨æ•°æ®åˆ†ç‰‡æ–¹é¢ï¼ŒRedis Cluster ä½¿ç”¨å“ˆå¸Œæ§½æœºåˆ¶å°†æ•´ä¸ªé›†ç¾¤åˆ’åˆ†ä¸º 16384 ä¸ªå•å…ƒã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250514150007.png" alt="aditya goelï¼šå“ˆå¸Œæ§½åˆ†ç‰‡" tabindex="0" loading="lazy"><figcaption>aditya goelï¼šå“ˆå¸Œæ§½åˆ†ç‰‡</figcaption></figure><p>ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ 4 ä¸ª Redis å®ä¾‹ï¼Œé‚£ä¹ˆæ¯ä¸ªå®ä¾‹ä¼šè´Ÿè´£ 4000 å¤šä¸ªå“ˆå¸Œæ§½ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250514144913.png" alt="Rajat Pachauriï¼šåˆ†ç‰‡ç»“æœ" tabindex="0" loading="lazy"><figcaption>Rajat Pachauriï¼šåˆ†ç‰‡ç»“æœ</figcaption></figure><p>åœ¨è®¡ç®—å“ˆå¸Œæ§½ç¼–å·æ—¶ï¼ŒRedis Cluster ä¼šé€šè¿‡ CRC16 ç®—æ³•å…ˆè®¡ç®—å‡ºé”®çš„å“ˆå¸Œå€¼ï¼Œå†å¯¹è¿™ä¸ªå“ˆå¸Œå€¼è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ª 0 åˆ° 16383 ä¹‹é—´çš„æ•´æ•°ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>slot = CRC16(key) mod 16384</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è¿™ç§æ–¹å¼å¯ä»¥å°†æ•°æ®å‡åŒ€åœ°åˆ†å¸ƒåˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œé¿å…æ•°æ®å€¾æ–œçš„é—®é¢˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e0ed9d62-3406-40db-8b01-c931f1020612.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ§½" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ§½</figcaption></figure><p>å½“éœ€è¦å­˜å‚¨æˆ–æŸ¥è¯¢ä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼ŒRedis Cluster ä¼šå…ˆè®¡ç®—è¿™ä¸ªé”®çš„å“ˆå¸Œæ§½ç¼–å·ï¼Œç„¶åæ ¹æ®å“ˆå¸Œæ§½ç¼–å·æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚</p><p>æ¨èé˜…è¯»ï¼š<a href="https://adityagoel123.medium.com/scalability-ha-with-redis-cluster-3d6499084550" target="_blank" rel="noopener noreferrer">Redis Cluster</a></p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis åˆ‡ç‰‡é›†ç¾¤ï¼Ÿæ•°æ®å’Œå®ä¾‹ä¹‹é—´çš„å¦‚ä½•è¿›è¡Œæ˜ å°„ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 1 éƒ¨é—¨ä¸»ç«™æŠ€æœ¯éƒ¨é¢è¯•åŸé¢˜ï¼šRedis çš„ cluster é›†ç¾¤å¦‚ä½•å®ç°ï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 14 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘å¾®ä¿¡</a>è¯´æ‹¿åˆ°äº†ç™¾åº¦å’Œç¾å›¢çš„æš‘æœŸå®ä¹  offerï¼Œæœç„¶äº”æœˆä¹Ÿæ˜¯ä¸€ä¸ªå¼€èŠ±ç»“æœçš„å­£èŠ‚ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250514151059.png" alt="çƒå‹æ‹¿åˆ°äº†ç¾å›¢å’Œç™¾åº¦çš„æš‘æœŸå®ä¹  offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†ç¾å›¢å’Œç™¾åº¦çš„æš‘æœŸå®ä¹  offer</figcaption></figure><h3 id="_26-é›†ç¾¤ä¸­æ•°æ®å¦‚ä½•åˆ†åŒº" tabindex="-1"><a class="header-anchor" href="#_26-é›†ç¾¤ä¸­æ•°æ®å¦‚ä½•åˆ†åŒº"><span>26.é›†ç¾¤ä¸­æ•°æ®å¦‚ä½•åˆ†åŒºï¼Ÿ</span></a></h3><p>å¸¸è§çš„æ•°æ®åˆ†åŒºæœ‰ä¸‰ç§ï¼šèŠ‚ç‚¹å–ä½™ã€ä¸€è‡´æ€§å“ˆå¸Œå’Œå“ˆå¸Œæ§½ã€‚</p><p>èŠ‚ç‚¹å–ä½™åˆ†åŒºç®€å•æ˜äº†ï¼Œé€šè¿‡è®¡ç®—é”®çš„å“ˆå¸Œå€¼ï¼Œç„¶åå¯¹èŠ‚ç‚¹æ•°é‡å–ä½™ï¼Œç»“æœå°±æ˜¯ç›®æ ‡èŠ‚ç‚¹çš„ç´¢å¼•ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>target_node = hash(key) % N  // Nä¸ºèŠ‚ç‚¹æ•°é‡</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-8b1fcaec-37e6-420a-9ca2-03615232af17.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šèŠ‚ç‚¹å–ä½™åˆ†åŒº" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šèŠ‚ç‚¹å–ä½™åˆ†åŒº</figcaption></figure><p>ç¼ºç‚¹æ˜¯å¢åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹åï¼ŒèŠ‚ç‚¹æ•°é‡ä» N å˜ä¸º N+1ï¼Œå‡ ä¹æ‰€æœ‰çš„å–ä½™ç»“æœéƒ½ä¼šæ”¹å˜ï¼Œå¯¼è‡´å¤§éƒ¨åˆ†ç¼“å­˜å¤±æ•ˆã€‚</p><p>ä¸ºäº†è§£å†³èŠ‚ç‚¹å˜åŒ–å¯¼è‡´çš„å¤§è§„æ¨¡æ•°æ®è¿ç§»é—®é¢˜ï¼Œä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºå‡ºç°äº†ï¼šå®ƒå°†æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´æƒ³è±¡æˆä¸€ä¸ªç¯ï¼ŒèŠ‚ç‚¹å’Œæ•°æ®éƒ½æ˜ å°„åˆ°è¿™ä¸ªç¯ä¸Šã€‚æ•°æ®è¢«åˆ†é…åˆ°é¡ºæ—¶é’ˆæ–¹å‘ä¸Šé‡åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-89bd1c1c-251c-4f53-bba3-fe945b2ae9e2.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒº" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒº</figcaption></figure><p>è¿™ç§è®¾è®¡çš„å·§å¦™ä¹‹å¤„åœ¨äºï¼Œå½“èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶ï¼Œåªæœ‰éƒ¨åˆ†æ•°æ®éœ€è¦é‡æ–°åˆ†é…ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬ä» 5 ä¸ªèŠ‚ç‚¹æ‰©å®¹åˆ° 8 ä¸ªèŠ‚ç‚¹ï¼Œç†è®ºä¸Šåªæœ‰çº¦ 3/8 çš„æ•°æ®éœ€è¦è¿ç§»ï¼Œå¤§å¤§å‡è½»äº†æ‰©å®¹æ—¶çš„ç³»ç»Ÿå‹åŠ›ã€‚</p><p>ä½†ä¸€è‡´æ€§å“ˆå¸Œä»ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæ•°æ®åˆ†å¸ƒä¸å‡åŒ€ã€‚æ¯”å¦‚è¯´åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒèŠ‚ç‚¹ 1 å’ŒèŠ‚ç‚¹ 2 çš„æ•°æ®é‡å·®ä¸å¤šï¼Œä½†èŠ‚ç‚¹ 3 çš„æ•°æ®é‡å´è¿œè¿œå°äºå®ƒä»¬ã€‚</p><p>Redis Cluster çš„å“ˆå¸Œæ§½åˆ†åŒºåœ¨ä¸€è‡´æ€§å“ˆå¸Œå’ŒèŠ‚ç‚¹å–ä½™çš„åŸºç¡€ä¸Šï¼Œåšäº†ä¸€äº›æ”¹è¿›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250515104833.png" alt="Dan Palmerï¼šå“ˆå¸Œæ§½" tabindex="0" loading="lazy"><figcaption>Dan Palmerï¼šå“ˆå¸Œæ§½</figcaption></figure><p>å®ƒå°†æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´åˆ’åˆ†ä¸º 16384 ä¸ªæ§½ä½ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ï¼Œæ•°æ®é€šè¿‡ CRC16 ç®—æ³•è®¡ç®—åå¯¹ 16384 å–æ¨¡ï¼Œç¡®å®šå®ƒå±äºå“ªä¸ªæ§½ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>slot = CRC16(key) % 16384</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250515104933.png" alt="Dan Palmerï¼šç¡®å®šæ§½" tabindex="0" loading="lazy"><figcaption>Dan Palmerï¼šç¡®å®šæ§½</figcaption></figure><p>å‡è®¾ç³»ç»Ÿä¸­æœ‰ 4 ä¸ªèŠ‚ç‚¹ï¼Œä¸ºå…¶åˆ†é…äº† 16 ä¸ªæ§½(0-15)ï¼›</p><ul><li>æ§½ 0-3 ä½äºèŠ‚ç‚¹ node1ï¼›</li><li>æ§½ 4-7 ä½äºèŠ‚ç‚¹ node2ï¼›</li><li>æ§½ 8-11 ä½äºèŠ‚ç‚¹ node3ï¼›</li><li>æ§½ 12-15 ä½äºèŠ‚ç‚¹ node4ã€‚</li></ul><p>å¦‚æœæ­¤æ—¶åˆ é™¤ <code>node2</code>ï¼Œåªéœ€è¦å°†æ§½ 4-7 é‡æ–°åˆ†é…å³å¯ï¼Œä¾‹å¦‚å°†æ§½ 4-5 åˆ†é…ç»™ <code>node1</code>ï¼Œæ§½ 6 åˆ†é…ç»™ <code>node3</code>ï¼Œæ§½ 7 åˆ†é…ç»™ <code>node4</code>ï¼Œæ•°æ®åœ¨èŠ‚ç‚¹ä¸Šçš„åˆ†å¸ƒä»ç„¶è¾ƒä¸ºå‡è¡¡ã€‚</p><p>å¦‚æœæ­¤æ—¶å¢åŠ  node5ï¼Œä¹Ÿåªéœ€è¦å°†ä¸€éƒ¨åˆ†æ§½åˆ†é…ç»™ node5 å³å¯ï¼Œæ¯”å¦‚è¯´å°†æ§½ 3ã€æ§½ 7ã€æ§½ 11ã€æ§½ 15 è¿ç§»ç»™ node5ï¼ŒèŠ‚ç‚¹ä¸Šçš„å…¶ä»–æ§½ä½ä¿ç•™ã€‚</p><p>å› ä¸ºæ§½çš„ä¸ªæ•°åˆšå¥½æ˜¯ 2 çš„ 14 æ¬¡æ–¹ï¼Œå’Œ HashMap ä¸­æ•°ç»„çš„é•¿åº¦å¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹æœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚å®ƒèƒ½ä¿è¯æ‰©å®¹åï¼Œå¤§éƒ¨åˆ†æ•°æ®åœç•™åœ¨æ‰©å®¹å‰çš„ä½ç½®ï¼Œåªæœ‰å°‘éƒ¨åˆ†æ•°æ®éœ€è¦è¿ç§»åˆ°æ–°çš„æ§½ä¸Šã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³æš‘æœŸå®ä¹ åŒå­¦ E ä¸€é¢é¢è¯•åŸé¢˜ï¼šä½ çŸ¥é“ Redis çš„ä¸€è‡´æ€§ hash å—</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis æ‰©å®¹ä¹‹åï¼Œå“ˆå¸Œæ§½çš„ä½ç½®æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 8 Java åç«¯å®ä¹ ä¸€é¢é¢è¯•åŸé¢˜ï¼šredis åˆ†ç‰‡é›†ç¾¤ï¼Œå¦‚ä½•åˆ†ç‰‡çš„ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 15 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘å¾®ä¿¡</a>è¯´åŠ äº†æ˜Ÿçƒåï¼Œç®—ä¸€ç®—ï¼Œè¸©ç€ç‚¹æ‹¿åˆ°äº†æ»´æ»´çš„å®ä¹  offerï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹æ—¶é—´çº¿ï¼Œä¹Ÿå°±ä¸€ä¸ªæœˆæ—¶é—´ä¸åˆ°ï¼ŒçœŸçš„å¤ªå¼ºäº†ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-çœ‹çœ‹ï¼Œæ˜Ÿçƒç¼–å·æ˜¯.jpg" alt="çƒå‹æ‹¿åˆ°äº†æ»´æ»´çš„ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†æ»´æ»´çš„ offer</figcaption></figure><h3 id="_27-èƒ½è¯´è¯´-redis-é›†ç¾¤çš„åŸç†å—" tabindex="-1"><a class="header-anchor" href="#_27-èƒ½è¯´è¯´-redis-é›†ç¾¤çš„åŸç†å—"><span>27.èƒ½è¯´è¯´ Redis é›†ç¾¤çš„åŸç†å—ï¼Ÿ</span></a></h3><p>Redis é›†ç¾¤çš„æ­å»ºå§‹äºèŠ‚ç‚¹çš„æ·»åŠ å’Œæ¡æ‰‹ã€‚æ¯ä¸ªèŠ‚ç‚¹é€šè¿‡è®¾ç½® <code>cluster-enabled yes</code> æ¥å¼€å¯é›†ç¾¤æ¨¡å¼ã€‚ç„¶åé€šè¿‡ <code>CLUSTER MEET</code> è¿›è¡Œæ¡æ‰‹ï¼Œå°†å¯¹æ–¹æ·»åŠ åˆ°å„è‡ªçš„èŠ‚ç‚¹åˆ—è¡¨ä¸­ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e6064ba6-fd6f-4270-92f9-68c0bb98fd4b.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šèŠ‚ç‚¹å’Œæ¡æ‰‹" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šèŠ‚ç‚¹å’Œæ¡æ‰‹</figcaption></figure><p>è¿™ä¸ªè¿‡ç¨‹è®¾è®¡çš„éå¸¸ç²¾å·§ï¼šèŠ‚ç‚¹ A å‘é€ MEET æ¶ˆæ¯ï¼ŒèŠ‚ç‚¹ B å›å¤ PONG å¹¶å‘é€ PINGï¼ŒèŠ‚ç‚¹ A å›å¤ PONGï¼Œäºæ˜¯åŒå‘çš„é€šä¿¡é“¾è·¯å°±å»ºç«‹å®Œæˆäº†ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250516093632.png" alt="happenï¼šcluster meet" tabindex="0" loading="lazy"><figcaption>happenï¼šcluster meet</figcaption></figure><p>æœ‰è¶£çš„æ˜¯ï¼Œç”±äºé‡‡ç”¨äº† Gossip åè®®ï¼Œæˆ‘ä»¬ä¸éœ€è¦è®©æ¯å¯¹èŠ‚ç‚¹éƒ½æ‰§è¡Œæ¡æ‰‹ã€‚åœ¨ä¸€ä¸ªå¤šèŠ‚ç‚¹é›†ç¾¤çš„éƒ¨ç½²ä¸­ï¼Œä»…éœ€è¦è®©ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸å…¶ä»–èŠ‚ç‚¹æ¡æ‰‹ï¼Œå…¶ä½™èŠ‚ç‚¹å°±èƒ½é€šè¿‡ä¿¡æ¯ä¼ æ’­è‡ªåŠ¨å‘ç°å¹¶è¿æ¥å½¼æ­¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250516093948.png" alt="ç¨‹åºå‘˜å†å°å†°ï¼šGossip" tabindex="0" loading="lazy"><figcaption>ç¨‹åºå‘˜å†å°å†°ï¼šGossip</figcaption></figure><p>æ¡æ‰‹å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ <code>CLUSTER ADDSLOTS</code> å‘½ä»¤ä¸ºä¸»èŠ‚ç‚¹åˆ†é…å“ˆå¸Œæ§½ã€‚å½“ 16384 ä¸ªæ§½å…¨éƒ¨åˆ†é…å®Œæ¯•ï¼Œé›†ç¾¤æ­£å¼è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-15341792-e7a6-428c-a109-22827e02be5f.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šåˆ†é…æ§½" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šåˆ†é…æ§½</figcaption></figure><p>æ•…éšœæ£€æµ‹å’Œæ¢å¤æ˜¯ä¿éšœ Redis é›†ç¾¤é«˜å¯ç”¨çš„å…³é”®ã€‚æ¯ç§’é’Ÿï¼ŒèŠ‚ç‚¹ä¼šå‘ä¸€å®šæ•°é‡çš„éšæœºèŠ‚ç‚¹å‘é€ PING æ¶ˆæ¯ï¼Œå½“å‘ç°æŸä¸ªèŠ‚ç‚¹é•¿æ—¶é—´æœªå“åº” PING æ¶ˆæ¯ï¼Œå°±ä¼šå°†å…¶æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-84a2a89e-f9ea-4681-b748-1a4f1dee172b.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸»è§‚ä¸‹çº¿" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸»è§‚ä¸‹çº¿</figcaption></figure><p>å½“åŠæ•°ä»¥ä¸Šçš„ä¸»èŠ‚ç‚¹éƒ½è®¤ä¸ºæŸèŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿æ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¢«æ ‡è®°ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b61a6109-7aea-45ab-a53c-267eebb9180a.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿</figcaption></figure><p>å¦‚æœä¸‹çº¿çš„æ˜¯ä¸»èŠ‚ç‚¹ï¼Œå®ƒçš„ä»èŠ‚ç‚¹ä¹‹ä¸€å°†è¢«é€‰ä¸¾ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œæ¥ç®¡åŸä¸»èŠ‚ç‚¹è´Ÿè´£çš„å“ˆå¸Œæ§½ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d0e16ea3-6683-43f4-82a3-80478703ae06.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé€‰ä¸¾æŠ•ç¥¨" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé€‰ä¸¾æŠ•ç¥¨</figcaption></figure><h4 id="éƒ¨ç½²-redis-é›†ç¾¤è‡³å°‘éœ€è¦å‡ ä¸ªç‰©ç†èŠ‚ç‚¹" tabindex="-1"><a class="header-anchor" href="#éƒ¨ç½²-redis-é›†ç¾¤è‡³å°‘éœ€è¦å‡ ä¸ªç‰©ç†èŠ‚ç‚¹"><span>éƒ¨ç½² Redis é›†ç¾¤è‡³å°‘éœ€è¦å‡ ä¸ªç‰©ç†èŠ‚ç‚¹ï¼Ÿ</span></a></h4><p>éƒ¨ç½²ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒå¯ç”¨çš„ Redis é›†ç¾¤ï¼Œä»æŠ€æœ¯è§’åº¦æ¥è¯´ï¼Œè‡³å°‘éœ€è¦ 3 ä¸ªç‰©ç†èŠ‚ç‚¹ã€‚</p><p>è¿™ä¸ªæœ€å°èŠ‚ç‚¹æ•°çš„è®¾å®šå¹¶é Redis æŠ€æœ¯ä¸Šçš„ç¡¬æ€§è¦æ±‚ï¼Œè€Œæ˜¯åŸºäºé«˜å¯ç”¨åŸåˆ™çš„å®è·µè€ƒé‡ã€‚</p><p>ä»å®è·µè§’åº¦çœ‹ï¼Œæœ€ç»å…¸çš„ Redis é›†ç¾¤é…ç½®æ˜¯ 3 ä¸» 3 ä»ï¼Œå…± 6 ä¸ª Redis å®ä¾‹ã€‚è€ƒè™‘åˆ°éœ€è¦ 3 ä¸ªä¸»èŠ‚ç‚¹å’Œ 3 ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯å¯¹ä¸»ä»ä¸èƒ½åœ¨åŒä¸€ç‰©ç†æœºä¸Šï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦ 3 ä¸ªç‰©ç†èŠ‚ç‚¹ï¼Œæ¯ä¸ªç‰©ç†èŠ‚ç‚¹ä¸Šè¿è¡Œ 1 ä¸ªä¸»èŠ‚ç‚¹å’Œå¦ä¸€ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚</p><ul><li>ç‰©ç†èŠ‚ç‚¹1ï¼šä¸»èŠ‚ç‚¹A + ä»èŠ‚ç‚¹B&#39;</li><li>ç‰©ç†èŠ‚ç‚¹2ï¼šä¸»èŠ‚ç‚¹B + ä»èŠ‚ç‚¹C&#39;</li><li>ç‰©ç†èŠ‚ç‚¹3ï¼šä¸»èŠ‚ç‚¹C + ä»èŠ‚ç‚¹A&#39;</li></ul><p>è¿™ç§äº¤é”™éƒ¨ç½²æ–¹å¼å¯ä»¥ç¡®ä¿ä»»ä½•ä¸€ä¸ªç‰©ç†èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œæœ€å¤šåªå½±å“ä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œä¸€ä¸ªä¸åŒä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚</p><p>memoï¼š2025 å¹´ 5 æœˆ 16 æ—¥ï¼Œä»Šå¤©åœ¨<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">ä¿®æ”¹ç®€å†</a>çš„æ—¶å€™ï¼Œç¢°åˆ°ä¸€ä¸ªæ²³å—ç†å·¥æœ¬ç§‘ï¼Œéƒ‘å·å¤§å­¦ç¡•å£«çš„çƒå‹ï¼Œä¹Ÿæ˜¯å¸Œæœ›è¿™ä¸ªç¤¾ç¾¤èƒ½å¤Ÿå¸®åŠ©åˆ°æ›´å¤šçš„åŒå­¦ï¼Œæ— è®ºæ¥è‡ªå“ªé‡Œï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾å›é‚£ä¸ªæ¸´æœ›è¿›æ­¥ï¼Œæ¸´æœ›æ‹¿åˆ°ä¼˜è´¨ offer çš„è‡ªå·±ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250516100305.png" alt="æ²³å—ç†å·¥å¤§å­¦æœ¬ã€éƒ‘å·å¤§å­¦ç¡•çš„çƒå‹" tabindex="0" loading="lazy"><figcaption>æ²³å—ç†å·¥å¤§å­¦æœ¬ã€éƒ‘å·å¤§å­¦ç¡•çš„çƒå‹</figcaption></figure><h3 id="_28-è¯´è¯´redisé›†ç¾¤çš„åŠ¨æ€ä¼¸ç¼©" tabindex="-1"><a class="header-anchor" href="#_28-è¯´è¯´redisé›†ç¾¤çš„åŠ¨æ€ä¼¸ç¼©"><span>28.è¯´è¯´Redisé›†ç¾¤çš„åŠ¨æ€ä¼¸ç¼©ï¼Ÿ</span></a></h3><p>Redis é›†ç¾¤åŠ¨æ€ä¼¸ç¼©çš„æ ¸å¿ƒæœºåˆ¶æ˜¯é€šè¿‡é‡æ–°åˆ†é…å“ˆå¸Œæ§½å®ç°çš„ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-dd3e9494-eddb-4861-85f7-2646018d93f6.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé›†ç¾¤çš„ä¼¸ç¼©" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé›†ç¾¤çš„ä¼¸ç¼©</figcaption></figure><p>å½“éœ€è¦æ‰©å®¹æ—¶ï¼Œé¦–å…ˆé€šè¿‡ <code>CLUSTER MEET</code> å‘½ä»¤å°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼›ç„¶åä½¿ç”¨ reshard å‘½ä»¤å°†éƒ¨åˆ†å“ˆå¸Œæ§½é‡æ–°åˆ†é…ç»™æ–°èŠ‚ç‚¹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-1d24bb63-2b05-4db9-bd6b-983f16a4830e.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ‰©å®¹å®ä¾‹" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ‰©å®¹å®ä¾‹</figcaption></figure><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒstart----</p><p>å‡†å¤‡æ–°çš„èŠ‚ç‚¹ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># redis.conf</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">port</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6382</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cluster-enabled</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cluster-config-file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nodes-6382.conf</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cluster-node-timeout</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åå¯åŠ¨æ–°çš„èŠ‚ç‚¹ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /path/to/redis-6382.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ <code>CLUSTER MEET</code> å‘½ä»¤å°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6379</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cluster</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> meet</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 127.0.0.1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6382</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ£€æŸ¥æ–°èŠ‚ç‚¹æ˜¯å¦åŠ å…¥ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6379</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cluster</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nodes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ç„¶åï¼Œé‡æ–°åˆ†é…å“ˆå¸Œæ§½ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --cluster</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reshard</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 127.0.0.1:6379</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>åœ¨æç¤ºä¸­è¾“å…¥è¦è¿ç§»çš„å“ˆå¸Œæ§½èŒƒå›´ã€‚</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># è¾“å…¥è¦è¿ç§»çš„æ§½æ•°é‡ï¼Œæ¯”å¦‚ 4096ï¼ˆå¹³å‡åˆ†é…çš„è¯ï¼Œ16384/4=4096ï¼‰ã€‚</span></span>
<span class="line"><span>How many slots do you want to move (from 16384 total slots)? 4096</span></span>
<span class="line"><span># è¾“å…¥ 6382 èŠ‚ç‚¹çš„ IDï¼ˆå¯é€šè¿‡ cluster nodes å‘½ä»¤æŸ¥åˆ°ï¼‰ã€‚</span></span>
<span class="line"><span>What is the receiving node ID? &lt;6382çš„èŠ‚ç‚¹ID&gt;</span></span>
<span class="line"><span># è¾“å…¥ allï¼ˆè¡¨ç¤ºä»æ‰€æœ‰èŠ‚ç‚¹å¹³å‡è¿ç§»ï¼‰ã€‚</span></span>
<span class="line"><span>Source node IDs? all</span></span>
<span class="line"><span># è¾“å…¥ yesï¼ˆè¡¨ç¤ºç¡®è®¤è¿ç§»ï¼‰ã€‚</span></span>
<span class="line"><span>Do you want to proceed with the proposed reshard plan (yes/no)? yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ£€æŸ¥æ£€æŸ¥æ§½åˆ†é…æƒ…å†µï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6379</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cluster</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> slots</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>éªŒè¯é›†ç¾¤çš„çŠ¶æ€ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6382</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cluster</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> info</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ä¹Ÿå¯ä»¥ç›´æ¥ä¸€æ­¥åˆ°ä½ï¼š</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --cluster</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reshard</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 127.0.0.1:6379</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --cluster-from</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> all</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --cluster-to</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">6382çš„èŠ‚ç‚¹I</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">D&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">--cluster-slots</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4096</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --cluster-yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒend----</p><p>ç¼©å®¹åˆ™æ˜¯åå‘æ“ä½œï¼šå…ˆå°†è¦ä¸‹çº¿èŠ‚ç‚¹è´Ÿè´£çš„æ‰€æœ‰æ§½è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œå†é€šè¿‡ <code>CLUSTER FORGET</code> å‘½ä»¤å°†èŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤ã€‚</p><p>æ•´ä¸ªä¼¸ç¼©è¿‡ç¨‹æ”¯æŒåœ¨çº¿æ“ä½œï¼Œæ— éœ€åœæœºï¼Œå¾—ç›Šäº Redis é›†ç¾¤çš„ MOVED å’Œ ASK é‡å®šå‘æœºåˆ¶ã€‚å½“å®¢æˆ·ç«¯è®¿é—®çš„é”®ä¸åœ¨å½“å‰èŠ‚ç‚¹æ—¶ï¼Œä¼šæ”¶åˆ°é‡å®šå‘å“åº”ï¼ŒæŒ‡å¼•å®ƒè¿æ¥åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ã€‚</p><h4 id="moved-å’Œ-ask-é‡å®šå‘çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#moved-å’Œ-ask-é‡å®šå‘çš„åŒºåˆ«"><span>MOVED å’Œ ASK é‡å®šå‘çš„åŒºåˆ«ï¼Ÿ</span></a></h4><p>MOVED é‡å®šå‘åæ˜ çš„æ˜¯å“ˆå¸Œæ§½çš„æ°¸ä¹…æ€§å˜æ›´ã€‚å½“å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªé”®ï¼Œä½†é”®æ‰€åœ¨çš„æ§½ä¸åœ¨å½“å‰èŠ‚ç‚¹æ—¶ï¼ŒèŠ‚ç‚¹ä¼šè¿”å› MOVED å“åº”ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯è¿™ä¸ªæ§½ç°åœ¨å½’å±äºå“ªä¸ªèŠ‚ç‚¹ã€‚é€šå¸¸å‘ç”Ÿåœ¨é›†ç¾¤å®Œæˆé‡æ–°åˆ†ç‰‡åï¼Œæ§½çš„åˆ†é…å…³ç³»å·²ç»ç¨³å®šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250517100408.png" alt="Aaron Zhuï¼šMOVED é‡å®šå‘" tabindex="0" loading="lazy"><figcaption>Aaron Zhuï¼šMOVED é‡å®šå‘</figcaption></figure><p>æ¯”å¦‚è¯´æŸä¸ªæ§½ä»èŠ‚ç‚¹ A ç§»åŠ¨åˆ°èŠ‚ç‚¹ B åï¼Œå¦‚æœå®¢æˆ·ç«¯ä»å‘èŠ‚ç‚¹ A è¯·æ±‚è¯¥æ§½ä¸­çš„é”®ï¼Œä¼šæ”¶åˆ° MOVED å“åº”ï¼Œæç¤ºåº”è¯¥è¿æ¥èŠ‚ç‚¹ Bã€‚</p><p>ASK é‡å®šå‘å‡ºç°åœ¨æ§½è¿ç§»è¿‡ç¨‹ä¸­ï¼Œè¡¨ç¤ºè¯·æ±‚çš„é”®å¯èƒ½å·²ç»ä»æºèŠ‚ç‚¹è¿ç§»åˆ°äº†ç›®æ ‡èŠ‚ç‚¹ï¼Œä½†è¿ç§»å°šæœªå®Œæˆã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250517100517.png" alt="Aaron Zhuï¼šASK é‡å®šå‘" tabindex="0" loading="lazy"><figcaption>Aaron Zhuï¼šASK é‡å®šå‘</figcaption></figure><div style="border:1px solid #096dd9;padding:20px;border-radius:15px;background-color:#f0f8ff;max-width:800px;margin:0 auto;box-shadow:0 4px 8px rgba(0, 0, 0, 0.1);"><p>å—¨å—¨å—¨ï¼Œæ—¶éš”ä¸¤å¹´ï¼Œé¢æ¸£é€†è¢­<a href="https://javabetter.cn/sidebar/sanfene/nixi.html" style="color:#096dd9;text-decoration:none;font-weight:bold;">ç¬¬äºŒç‰ˆ PDF ç»ˆäºå¯ä»¥ä¸‹è½½äº†</a>ã€‚æˆ‘ä»¬åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼š</p><ol style="margin-left:20px;"><li><strong><span style="color:#d32f2f;">å¯¹äºé«˜é¢‘é¢˜</span></strong>ï¼šä¼šæ ‡æ³¨åœ¨ã€Š<a href="https://javabetter.cn/zhishixingqiu/mianshi.html" style="color:#096dd9;">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>ä¸­å‡ºç°çš„ä½ç½®ï¼Œå“ªå®¶å…¬å¸ï¼ŒåŸé¢˜æ˜¯ä»€ä¹ˆï¼›å¦‚æœä½ æƒ³èŠ‚çœæ—¶é—´çš„è¯ï¼Œå¯ä»¥ä¼˜å…ˆèƒŒè¯µè¿™äº›é¢˜ç›®ï¼Œå°½å¿«åšåˆ°çŸ¥å½¼çŸ¥å·±ï¼Œç™¾æˆ˜ä¸æ®†ã€‚</li><li><strong><span style="color:#d32f2f;">ç»“åˆé¡¹ç›®</span></strong>ï¼šåŒ…æ‹¬<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" style="color:#096dd9;">æŠ€æœ¯æ´¾</a>ã€<a href="https://t.zsxq.com/0bhcI0Gs6" style="color:#096dd9;">mydb</a>ã€<a href="https://javabetter.cn/zhishixingqiu/pmhub.html" style="color:#096dd9;">pmhub</a>æ¥ç»„ç»‡è¯­è¨€ï¼Œè®©é¢è¯•å®˜æœ€å¤§ç¨‹åº¦æ„Ÿå—åˆ°ä½ çš„è¯šæ„ï¼Œè€Œä¸æ˜¯æœºæ¢°åŒ–çš„èƒŒè¯µã€‚</li><li><strong><span style="color:#d32f2f;">ä¿®å¤é—®é¢˜</span></strong>ï¼šç¬¬ä¸€ç‰ˆä¸­å‡ºç°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬çƒå‹ä»¬çš„ç§ä¿¡åé¦ˆï¼Œç½‘ç«™ç•™è¨€åŒºçš„è¯„è®ºï¼Œä»¥åŠ<a href="https://github.com/itwanger/toBeBetterJavaer/issues" style="color:#096dd9;"> GitHub ä»“åº“ä¸­çš„ issue</a>ï¼Œè®©è¿™ä»½é¢è¯•æŒ‡å—æ›´åŠ å®Œå–„ã€‚</li><li><strong><span style="color:#d32f2f;">ä¼˜åŒ–æ’ç‰ˆ</span></strong>ï¼šå¢åŠ æ‰‹ç»˜å›¾ï¼Œé‡æ–°ç»„ç»‡ç­”æ¡ˆï¼Œä½¿å…¶æ›´åŠ å£è¯­åŒ–ï¼Œä»è€Œæ›´è´´è¿‘é¢è¯•å®˜çš„é¢„æœŸã€‚</li></ol><p>ä½ å¯ä»¥æ‰«ä¸‹é¢çš„äºŒç»´ç ï¼ˆæˆ–è€…é•¿æŒ‰è‡ªåŠ¨è¯†åˆ«ï¼‰å…³æ³¨ã€<b>æ²‰é»˜ç‹äºŒ</b>ã€‘å…¬ä¼—å·ï¼Œå‘é€å…³é”®å­— <b>222</b> æ¥è·å– PDF ç‰ˆæœ¬ï¼Œå¦‚æœé¢æ¸£é€†è¢­çœŸçš„å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¸Œæœ›èƒ½ç»™äºŒå“¥çš„å…¬ä¼—å·åŠ ä¸€ä¸ªæ˜Ÿæ ‡ï¼Œæ»¡è¶³æˆ‘é‚£ä¸€ä¸ç‚¹è™šè£å¿ƒï¼Œè¿™å°†æ˜¯æˆ‘æ›´æ–°ä¸‹å»çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p><div style="text-align:center;margin:20px 0;"><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width:100%;height:auto;border-radius:10px;"></div><p>é¢æ¸£é€†è¢­çš„æ•´ç†å·¥ä½œçœŸçš„å¤ªä¸å®¹æ˜“äº†ï¼ŒèŠ±äº†æˆ‘å¥½å¤šå¥½å¤šçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œå†…å®¹å®Œå…¨å…è´¹ï¼Œä½†è´¨é‡å´æœ‰å£çš†ç¢‘ï¼Œå°±æ˜¯ä¸ºäº†åšä¸€ç‚¹çœŸæ­£æœ‰æ„ä¹‰çš„ã€çº¯ç²¹çš„äº‹æƒ…ã€‚</p></div><p>memoï¼š2025 å¹´ 5 æœˆ 17 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘å¾®ä¿¡</a>è¯´æ‹¿åˆ°äº†ä¸€ä¸ªå›½ä¼å­å…¬å¸çš„ Java åç«¯å¼€å‘å’Œä¸€ä¸ªå°ç±³å®‰å“çš„ offerï¼Œé—®æˆ‘è¯¥æ€ä¹ˆé€‰æ‹©ï¼Ÿ</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250517101545.png" alt="çƒå‹æ‹¿åˆ°äº†ä¸€ä¸ªå›½ä¼å­å…¬å¸å’Œå°ç±³çš„ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†ä¸€ä¸ªå›½ä¼å­å…¬å¸å’Œå°ç±³çš„ offer</figcaption></figure><h2 id="ç¼“å­˜è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜è®¾è®¡"><span>ç¼“å­˜è®¾è®¡</span></a></h2><h3 id="_29-ğŸŒŸä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿" tabindex="-1"><a class="header-anchor" href="#_29-ğŸŒŸä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿"><span>29.ğŸŒŸä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿ</span></a></h3><p>ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡æŸä¸ªçƒ­ç‚¹æ•°æ®ç¼“å­˜è¿‡æœŸæ—¶ï¼Œå¤§é‡è¯·æ±‚å°±ä¼šç©¿é€ç¼“å­˜ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“ç¬é—´æ‰¿å—çš„å‹åŠ›å·¨å¤§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250518092219.png" alt="fengkui.netï¼šç¼“å­˜å‡»ç©¿" tabindex="0" loading="lazy"><figcaption>fengkui.netï¼šç¼“å­˜å‡»ç©¿</figcaption></figure><p>è§£å†³ç¼“å­˜å‡»ç©¿æœ‰ä¸¤ç§å¸¸ç”¨çš„ç­–ç•¥ï¼š</p><p>ç¬¬ä¸€ç§æ˜¯åŠ äº’æ–¥é”ã€‚å½“ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œç¬¬ä¸€ä¸ªè®¿é—®çš„çº¿ç¨‹å…ˆè·å–é”å¹¶è´Ÿè´£é‡å»ºç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…æˆ–é‡è¯•ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-cf63911a-8501-493e-a375-8b47a9f33358.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šåŠ é”æ›´æ–°" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šåŠ é”æ›´æ–°</figcaption></figure><p>è¿™ç§ç­–ç•¥è™½ç„¶ä¼šå¯¼è‡´éƒ¨åˆ†è¯·æ±‚å»¶è¿Ÿï¼Œä½†å®ç°èµ·æ¥ç›¸å¯¹ç®€å•ã€‚åœ¨<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" target="_blank" rel="noopener noreferrer">æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®</a>ä¸­ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨äº† Redisson çš„åˆ†å¸ƒå¼é”æ¥ç¡®ä¿åªæœ‰ä¸€ä¸ªæœåŠ¡å®ä¾‹èƒ½æ›´æ–°ç¼“å­˜ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cacheKey </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;product::&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> productId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RLock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redissonClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;lock::&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> productId);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(cacheKey);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">queryProductById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(productId);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(cacheKey, result, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">60</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // è®¾ç½®ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒç§æ˜¯æ°¸ä¸è¿‡æœŸç­–ç•¥ã€‚ç¼“å­˜é¡¹æœ¬èº«ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯æ°¸ä¸è¿‡æœŸï¼Œä½†åœ¨ç¼“å­˜å€¼ä¸­ç»´æŠ¤ä¸€ä¸ªé€»è¾‘è¿‡æœŸæ—¶é—´ã€‚å½“ç¼“å­˜é€»è¾‘ä¸Šè¿‡æœŸæ—¶ï¼Œè¿”å›æ—§å€¼çš„åŒæ—¶ï¼Œå¼‚æ­¥å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ›´æ–°ç¼“å­˜ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getData</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    CacheItem</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (item </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ç¼“å­˜ä¸å­˜åœ¨ï¼ŒåŒæ­¥åŠ è½½</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> data </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">query</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CacheItem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(data, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentTimeMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> expireTime));</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">isLogicalExpired</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // é€»è¾‘è¿‡æœŸï¼Œå¼‚æ­¥åˆ·æ–°</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        asyncRefresh</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(key)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // è¿”å›æ—§æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å¼‚æ­¥åˆ·æ–°ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> asyncRefresh</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    threadPool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // é‡æ–°æŸ¥è¯¢æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> newData</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">query</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ›´æ–°ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CacheItem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(newData, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentTimeMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> expireTime));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>memoï¼š2025 å¹´ 5 æœˆ 18 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©ç»™<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">çƒå‹æ”¹ç®€å†æ—¶</a>ï¼Œç¢°åˆ°ä¸€ä¸ªè¥¿åŒ—å·¥ä¸šå¤§å­¦çš„çƒå‹ï¼Œè¿™åˆæ˜¯ä¸€æ‰€ 985 é™¢æ ¡ï¼Œå¸Œæœ›è¿™ä¸ªç¤¾ç¾¤èƒ½æŠŠæ‰€æœ‰çš„ 985 é™¢æ ¡é›†é½ï¼Œä¹Ÿå¸Œæœ›å»å¸®åŠ©åˆ°æ›´å¤šé™¢æ ¡çš„åŒå­¦ï¼Œå¸Œæœ›å¤§å®¶éƒ½èƒ½æ‹¿åˆ°ä¸€ä¸ªæ»¡æ„çš„ offerã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250518093130.png" alt="è¥¿åŒ—å·¥ä¸šå¤§å­¦çš„çƒå‹" tabindex="0" loading="lazy"><figcaption>è¥¿åŒ—å·¥ä¸šå¤§å­¦çš„çƒå‹</figcaption></figure><h4 id="ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€"><span>ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿ</span></a></h4><p>ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢çš„æ•°æ®åœ¨ç¼“å­˜ä¸­æ²¡æœ‰å‘½ä¸­ï¼Œå› ä¸ºæ•°æ®å‹æ ¹ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è¯·æ±‚ä¼šç›´æ¥è½åˆ°æ•°æ®åº“ä¸Šã€‚å¦‚æœè¿™ç§æŸ¥è¯¢éå¸¸é¢‘ç¹ï¼Œå°±ä¼šç»™æ•°æ®åº“é€ æˆå¾ˆå¤§çš„å‹åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250519082725.png" alt="fengkui.netï¼šç¼“å­˜ç©¿é€" tabindex="0" loading="lazy"><figcaption>fengkui.netï¼šç¼“å­˜ç©¿é€</figcaption></figure><p>ç¼“å­˜å‡»ç©¿æ˜¯å› ä¸ºå•ä¸ªçƒ­ç‚¹æ•°æ®ç¼“å­˜å¤±æ•ˆå¯¼è‡´çš„ï¼Œè€Œç¼“å­˜ç©¿é€æ˜¯å› ä¸ºæŸ¥è¯¢çš„æ•°æ®ä¸å­˜åœ¨ï¼ŒåŸå› å¯èƒ½æ˜¯è‡ªèº«çš„ä¸šåŠ¡ä»£ç æœ‰é—®é¢˜ï¼Œæˆ–è€…æ˜¯æ¶æ„æ”»å‡»é€ æˆçš„ï¼Œæ¯”å¦‚çˆ¬è™«ã€‚</p><p>å¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼šç¬¬ä¸€ç§æ˜¯å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®ƒæ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡å¾ˆé«˜çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼ŒæŸ¥è¯¢æ—¶å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è®¤ä¸ºè¯¥æ•°æ®ä¸å­˜åœ¨ï¼Œå°±ç›´æ¥è¿”å›ç©ºï¼›å¦åˆ™å†å»æŸ¥è¯¢ç¼“å­˜ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ— æ•ˆçš„ç¼“å­˜æŸ¥è¯¢ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250519085312.png" alt="é…’å‰‘ä»™ï¼šå¸ƒéš†è¿‡æ»¤å™¨è§£å†³ç¼“å­˜ç©¿é€" tabindex="0" loading="lazy"><figcaption>é…’å‰‘ä»™ï¼šå¸ƒéš†è¿‡æ»¤å™¨è§£å†³ç¼“å­˜ç©¿é€</figcaption></figure><p>ä»£ç ç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getData</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç¼“å­˜ä¸­ä¸å­˜åœ¨è¯¥key</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cacheResult </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (cacheResult </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> cacheResult</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­keyæ˜¯å¦å¯èƒ½å­˜åœ¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">bloomFilter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mightContain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key)</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å¯èƒ½å­˜åœ¨ï¼ŒæŸ¥è¯¢æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> dbResult </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">query</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å°†ç»“æœæ”¾å…¥ç¼“å­˜ï¼ŒåŒ…æ‹¬ç©ºå€¼</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, dbResult </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dbResult </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, expireTime);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> dbResult</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤ï¼Œå³å¯èƒ½ä¼šè®¤ä¸ºæŸä¸ªæ•°æ®å­˜åœ¨ï¼Œä½†å®é™…ä¸Šå¹¶ä¸å­˜åœ¨ã€‚ä½†ç»ä¸ä¼šæ¼åˆ¤ï¼Œå³å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è®¤ä¸ºæŸä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œé‚£å®ƒä¸€å®šä¸å­˜åœ¨ã€‚å› æ­¤å®ƒå¯ä»¥æœ‰æ•ˆæ‹¦æˆªä¸å­˜åœ¨çš„æ•°æ®æŸ¥è¯¢ï¼Œå‡è½»æ•°æ®åº“å‹åŠ›ã€‚</p><p>ç¬¬äºŒç§æ˜¯ç¼“å­˜ç©ºå€¼ã€‚å¯¹äºä¸å­˜åœ¨çš„æ•°æ®ï¼Œæˆ‘ä»¬å°†ç©ºå€¼å†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ã€‚è¿™æ ·ä¸‹æ¬¡ç›¸åŒçš„æŸ¥è¯¢å°±èƒ½ç›´æ¥ä»ç¼“å­˜è¿”å›ï¼Œè€Œä¸å†è®¿é—®æ•°æ®åº“ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-288af5a2-ae5a-427a-95e9-b4a658b01386.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šç¼“å­˜ç©ºå€¼/é»˜è®¤å€¼" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šç¼“å­˜ç©ºå€¼/é»˜è®¤å€¼</figcaption></figure><p>ä»£ç ç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getData</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cacheResult </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç¼“å­˜å‘½ä¸­ï¼ŒåŒ…æ‹¬ç©ºå€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (cacheResult </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ç‰¹æ®Šå€¼è¡¨ç¤ºç©ºç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">cacheResult</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">equals</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> cacheResult</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> dbResult </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">query</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å†™å…¥ç¼“å­˜ï¼Œç©ºå€¼ä¹Ÿç¼“å­˜ï¼Œä½†è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> expireTime </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> dbResult </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ?</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> EMPTY_EXPIRE_TIME </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> NORMAL_EXPIRE_TIME</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, dbResult </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dbResult </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, expireTime);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> dbResult</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¼“å­˜ç©ºå€¼çš„æ–¹æ³•å®ç°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†éœ€è¦ç»™ç©ºå€¼è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œä»¥å…æ•°æ®åº“ä¸­æ–°å¢äº†è¿™äº›æ•°æ®åï¼Œç¼“å­˜ä»ç„¶è¿”å›ç©ºå€¼ã€‚</p><p>åœ¨å®é™…çš„é¡¹ç›®å½“ä¸­ï¼Œè¿˜éœ€è¦åœ¨æ¥å£å±‚é¢åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚è¯´å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒï¼Œæ‹¦æˆªæ˜æ˜¾ä¸åˆç†çš„è¯·æ±‚ï¼›æˆ–è€…å¯¹ç–‘ä¼¼æ”»å‡»çš„ IP è¿›è¡Œé™æµå’Œå°ç¦ã€‚</p><p>memoï¼š2025 å¹´ 5 æœˆ 19 æ—¥ï¼Œä»Šå¤©<a href="https://javabetterjavaer.com/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘å¾®ä¿¡</a>è¯´æ‹¿åˆ°äº†æ»´æ»´çš„æµ‹å¼€å®ä¹  offerï¼Œç›®å‰è¿˜æƒ³ç»§ç»­æ‰¾ï¼Œé—®æˆ‘è¯¥ç»§ç»­å­¦ç‚¹ä»€ä¹ˆï¼Œæˆ‘çš„å›å¤è¯´ï¼Œæš‘æœŸèƒ½æ‹¿åˆ° offerï¼Œç§‹æ‹›ç»§ç»­å°±è¡Œäº†ï¼ŒåŠ ä¸Šæ»´æ»´çš„å®ä¹ ç»å†å°±å¾ˆç¡¬æ ¸äº†ã€‚å¤§å®¶åœ¨å‡†å¤‡æš‘æœŸå’Œç§‹æ‹›çš„æ—¶å€™ï¼Œä¹Ÿä¸è¦å¤ªç„¦è™‘ï¼Œä¿æŒä¸€ä¸ªå¥½çš„å­¦ä¹ ä¹ æƒ¯ï¼Œç§‹æ‹›æ²¡é—®é¢˜çš„ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250520092547.png" alt="æ»´æ»´çš„æµ‹å¼€offer" tabindex="0" loading="lazy"><figcaption>æ»´æ»´çš„æµ‹å¼€offer</figcaption></figure><h4 id="ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©"><span>ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ</span></a></h4><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨æŸä¸€æ—¶é—´æ®µï¼Œå¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆæˆ–è€…ç¼“å­˜æœåŠ¡çªç„¶å®•æœºäº†ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚ç›´æ¥æ¶Œå‘æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›å‰§å¢ï¼Œç”šè‡³å¼•å‘ç³»ç»Ÿå´©æºƒçš„ç°è±¡ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-1464fe22-c463-4850-8989-b899510cb10e.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šç¼“å­˜é›ªå´©" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šç¼“å­˜é›ªå´©</figcaption></figure><p>ç¼“å­˜å‡»ç©¿æ˜¯å•ä¸ªçƒ­ç‚¹æ•°æ®å¤±æ•ˆå¯¼è‡´çš„ï¼Œç¼“å­˜ç©¿é€æ˜¯å› ä¸ºè¯·æ±‚ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè€Œç¼“å­˜é›ªå´©æ˜¯å› ä¸ºå¤§èŒƒå›´çš„ç¼“å­˜å¤±æ•ˆã€‚</p><p>ç¼“å­˜é›ªå´©ä¸»è¦æœ‰ä¸‰ç§æˆå› å’Œåº”å¯¹ç­–ç•¥ã€‚</p><p>ç¬¬ä¸€ç§ï¼Œå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œè§£å†³æ–¹æ³•æ˜¯æ·»åŠ éšæœºè¿‡æœŸæ—¶é—´ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> setCache</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> value) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // åŸºç¡€è¿‡æœŸæ—¶é—´ï¼Œä¾‹å¦‚30åˆ†é’Ÿ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> baseExpireSeconds </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1800</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å¢åŠ éšæœºè¿‡æœŸæ—¶é—´ï¼ŒèŒƒå›´0-300ç§’</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> randomSeconds </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Random</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nextInt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">300</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æœ€ç»ˆè¿‡æœŸæ—¶é—´ä¸ºåŸºç¡€æ—¶é—´åŠ éšæœºæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, value, baseExpireSeconds </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> randomSeconds);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒç§ï¼Œç¼“å­˜æœåŠ¡å´©æºƒï¼Œè§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨é«˜å¯ç”¨çš„ç¼“å­˜é›†ç¾¤ã€‚</p><p>æ¯”å¦‚è¯´ä½¿ç”¨ Redis Cluster æ„å»ºå¤šèŠ‚ç‚¹é›†ç¾¤ï¼Œç¡®ä¿æ•°æ®åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šæœ‰å¤‡ä»½ï¼Œå¹¶ä¸”æ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240326220634.png" alt="Rajat Pachauriï¼šRedis Cluster" tabindex="0" loading="lazy"><figcaption>Rajat Pachauriï¼šRedis Cluster</figcaption></figure><p>å¯¹äºä¸€äº›é«˜é¢‘å…³é”®æ•°æ®ï¼Œå¯ä»¥é…ç½®æœ¬åœ°ç¼“å­˜ä½œä¸ºäºŒçº§ç¼“å­˜ï¼Œç¼“è§£ Redis çš„å‹åŠ›ã€‚åœ¨<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" target="_blank" rel="noopener noreferrer">æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®</a>ä¸­ï¼Œæˆ‘ä»¬å°±é‡‡ç”¨äº†å¤šçº§ç¼“å­˜çš„ç­–ç•¥ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ä½¿ç”¨æœ¬åœ°ç¼“å­˜ Caffeine æ¥ä½œä¸ºäºŒçº§ç¼“å­˜ï¼Œå½“ Redis å‡ºç°é—®é¢˜æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°ç¼“å­˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240421105333.png" alt="æŠ€æœ¯æ´¾æ•™ç¨‹ï¼šCaffeineæœ¬åœ°ç¼“å­˜" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾æ•™ç¨‹ï¼šCaffeineæœ¬åœ°ç¼“å­˜</figcaption></figure><p>è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºâ€œç¼“å­˜é™çº§â€ï¼Œä¿è¯ Redis å‘ç”Ÿæ•…éšœæ—¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿç»§ç»­æä¾›æœåŠ¡ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">LoadingCache</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UserPermissions</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> permissionsCache </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Caffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">newBuilder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">maximumSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">expireAfterWrite</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MINUTES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">::</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">loadPermissionsFromRedis);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UserPermissions</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> loadPermissionsFromRedis</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> userId) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getPermissions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> ex</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // Redis å¼‚å¸¸å¤„ç†ï¼Œå°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> permissionsCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getIfPresent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬ä¸‰ç§ï¼Œç¼“å­˜æœåŠ¡æ­£å¸¸ä½†å¹¶å‘è¯·æ±‚é‡è¶…è¿‡äº†ç¼“å­˜æœåŠ¡çš„æ‰¿è½½èƒ½åŠ›ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥é‡‡ç”¨é™æµå’Œé™çº§æªæ–½ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getData</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å°è¯•ä»ç¼“å­˜è·å–æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ç¼“å­˜æœåŠ¡å¼‚å¸¸ï¼Œè§¦å‘ç†”æ–­</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">circuitBreaker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">shouldTrip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // ç›´æ¥ä»æ•°æ®åº“è·å–ï¼Œå¹¶è¿›å…¥é™çº§æ¨¡å¼</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            circuitBreaker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">trip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getFromDbDirectly</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(key)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        throw</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getFromDbDirectly</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å®æ–½é™æµä¿æŠ¤</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">rateLimit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // è¶…è¿‡é™æµé˜ˆå€¼ï¼Œè¿”å›å…œåº•æ•°æ®æˆ–é»˜è®¤å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getDefaultValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(key)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // é™æµé€šè¿‡ï¼Œä»æ•°æ®åº“æŸ¥è¯¢</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">query</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 22 æš‘æœŸå®ä¹ ä¸€é¢é¢è¯•åŸé¢˜ï¼šç¼“å­˜é›ªå´©ï¼Œå¦‚ä½•è§£å†³</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 7 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´ä¸€ä¸‹ ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šRedis å®•æœºä¼šä¸ä¼šå¯¹æƒé™ç³»ç»Ÿæœ‰å½±å“ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šè¯´ä¸€ä¸‹ Redis é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ç­‰åœºæ™¯çš„è§£å†³æ–¹æ¡ˆ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³åŒå­¦ F é¢è¯•åŸé¢˜ï¼šç¼“å­˜å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼ˆå¼•ç”³åˆ°å¤šçº§ç¼“å­˜ï¼‰ï¼Œå¤šçº§ç¼“å­˜ï¼ˆredisï¼Œnginxï¼Œæœ¬åœ°ç¼“å­˜ï¼‰çš„å®ç°æ€è·¯</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„TPè”æ´²åŒå­¦ 5 Java åç«¯ä¸€é¢çš„åŸé¢˜ï¼šå¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç†æƒ³æ±½è½¦é¢ç»åŒå­¦ 2 ä¸€é¢é¢è¯•åŸé¢˜ï¼šå¦‚ä½•ç†è§£ç¼“å­˜é›ªå´©ã€ç¼“å­˜å‡»ç©¿å’Œç¼“å­˜ç©¿é€ï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 20 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘å¾®ä¿¡</a>è¯´é¡¹ç›®ç”¨çš„æŠ€æœ¯æ´¾ï¼Œå…«è‚¡èƒŒçš„é¢æ¸£ï¼Œæ˜¥æ‹›æ‹¿åˆ°äº†å››ä¸ª offerï¼Œå…¶ä¸­åŒ…æ‹¬æ³°éš†é“¶è¡Œå’Œäº¤é€šé“¶è¡Œï¼Œé—®æˆ‘è¯¥æ€ä¹ˆé€‰æ‹©ï¼Œè¯´å®è¯æˆ‘çœ‹å®Œåè§‰å¾—æŒºéš¾é€‰çš„ï¼ŒğŸ˜„ä¸è¿‡è¿˜æ˜¯å€¼å¾—æ­å–œä¸€æ‰‹ã€‚å¤§å®¶åœ¨å‡†å¤‡æ˜¥æ‹›çš„æ—¶å€™ä¹Ÿä¸è¦ç€æ€¥ï¼Œä»˜å‡ºæ€»ä¼šæœ‰å›æŠ¥çš„ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250520094922.png" alt="çƒå‹æ˜¥æ‹›æ‹¿åˆ°äº†å››ä¸ª offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ˜¥æ‹›æ‹¿åˆ°äº†å››ä¸ª offer</figcaption></figure><h3 id="_30-ğŸŒŸèƒ½è¯´è¯´å¸ƒéš†è¿‡æ»¤å™¨å—" tabindex="-1"><a class="header-anchor" href="#_30-ğŸŒŸèƒ½è¯´è¯´å¸ƒéš†è¿‡æ»¤å™¨å—"><span>30.ğŸŒŸèƒ½è¯´è¯´å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ</span></a></h3><p>å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡æé«˜çš„æ¦‚ç‡æ€§æ•°æ®ç»“æ„ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿä»¥æå°çš„å†…å­˜æ¶ˆè€—ï¼Œåˆ¤æ–­ä¸€ä¸ªå…ƒç´ â€œä¸€å®šä¸åœ¨é›†åˆä¸­â€æˆ–â€œå¯èƒ½åœ¨é›†åˆä¸­â€ï¼Œå¸¸ç”¨æ¥è§£å†³ Redis ç¼“å­˜ç©¿é€çš„é—®é¢˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d0b8d85c-85dc-4843-b4be-d5d48338a44e.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå¸ƒéš†è¿‡æ»¤å™¨" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå¸ƒéš†è¿‡æ»¤å™¨</figcaption></figure><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒstart----</p><p>å¸ƒéš†è¿‡æ»¤å™¨çš„æ ¸å¿ƒç”±ä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶å‘é‡å’Œä¸€ç³»åˆ—å“ˆå¸Œå‡½æ•°ç»„æˆã€‚</p><ul><li>åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º m çš„ä½æ•°ç»„ï¼Œåˆå§‹å€¼å…¨ä¸º 0ï¼ŒåŒæ—¶é€‰æ‹© k ä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°</li><li>å½“æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œç”¨ k ä¸ªå“ˆå¸Œå‡½æ•°è®¡ç®—å‡º k ä¸ªå“ˆå¸Œå€¼ï¼Œç„¶åå¯¹ m å–æ¨¡ï¼Œå¾—åˆ° k ä¸ªä½ç½®ï¼Œå°†è¿™äº›ä½ç½®çš„äºŒè¿›åˆ¶ä½éƒ½è®¾ä¸º 1</li><li>å½“éœ€è¦åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­æ—¶ï¼ŒåŒæ ·ç”¨ k ä¸ªå“ˆå¸Œå‡½æ•°è®¡ç®—å‡º k ä¸ªä½ç½®ï¼Œå¦‚æœè¿™äº›ä½ç½®çš„äºŒè¿›åˆ¶ä½æœ‰ä»»ä½•ä¸€ä¸ªä¸º 0ï¼Œè¯¥å…ƒç´ ä¸€å®šä¸åœ¨é›†åˆä¸­ï¼›å¦‚æœå…¨éƒ¨ä¸º 1ï¼Œåˆ™è¯¥å…ƒç´ å¯èƒ½åœ¨é›†åˆä¸­</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BloomFilter</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BitSet</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> bitSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> bitSetSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> numberOfHashFunctions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> BloomFilter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> falsePositiveProbability</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> expectedNumberOfElements</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ ¹æ®é¢„æœŸå…ƒç´ æ•°é‡å’ŒæœŸæœ›çš„è¯¯åˆ¤ç‡ï¼Œè®¡ç®—æœ€ä¼˜çš„ä½æ•°ç»„å¤§å°å’Œå“ˆå¸Œå‡½æ•°ä¸ªæ•°</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">bitSetSize</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> calculateOptimalBitSetSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(expectedNumberOfElements, falsePositiveProbability);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">numberOfHashFunctions</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> calculateOptimalNumberOfHashFunctions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(expectedNumberOfElements, bitSetSize);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">bitSet</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> BitSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(bitSetSize);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> element</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">hashes</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> createHashes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(element);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hash</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> hashes) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            bitSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Math</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">abs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(hash </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> bitSetSize), </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> mightContain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> element</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">hashes</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> createHashes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(element);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hash</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> hashes) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">bitSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Math</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">abs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(hash </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> bitSetSize))) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å¦‚æœä»»ä½•ä¸€ä½ä¸º0ï¼Œå…ƒç´ ä¸€å®šä¸å­˜åœ¨</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ‰€æœ‰ä½éƒ½ä¸º1ï¼Œå…ƒç´ å¯èƒ½å­˜åœ¨</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å…¶ä»–è¾…åŠ©æ–¹æ³•ï¼Œå¦‚è®¡ç®—å“ˆå¸Œå€¼ï¼Œè®¡ç®—æœ€ä¼˜å‚æ•°ç­‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒend----</p><h4 id="å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤å—" tabindex="-1"><a class="header-anchor" href="#å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤å—"><span>å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤å—ï¼Ÿ</span></a></h4><p>æ˜¯çš„ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤ã€‚å®ƒå¯èƒ½ä¼šé”™è¯¯åœ°è®¤ä¸ºæŸä¸ªå…ƒç´ åœ¨é›†åˆä¸­ï¼Œè€Œå…ƒç´ å®é™…ä¸Šå¹¶ä¸åœ¨é›†åˆä¸­ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20241019191741.png" alt="å‹‡å“¥ï¼šå¸ƒéš†è¿‡æ»¤å™¨" tabindex="0" loading="lazy"><figcaption>å‹‡å“¥ï¼šå¸ƒéš†è¿‡æ»¤å™¨</figcaption></figure><p>ä½†å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è®¤ä¸ºæŸä¸ªå…ƒç´ ä¸å­˜åœ¨äºé›†åˆä¸­ï¼Œé‚£ä¹ˆå®ƒä¸€å®šä¸å­˜åœ¨ã€‚</p><p>è¯¯åˆ¤äº§ç”Ÿçš„åŸå› æ˜¯å› ä¸ºå“ˆå¸Œå†²çªã€‚åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¤šä¸ªä¸åŒçš„å…ƒç´ å¯èƒ½æ˜ å°„åˆ°ç›¸åŒçš„ä½ç½®ã€‚éšç€å‘å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ·»åŠ çš„å…ƒç´ è¶Šæ¥è¶Šå¤šï¼Œä½æ•°ç»„ä¸­çš„ 1 ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œå‘ç”Ÿå“ˆå¸Œå†²çªçš„æ¦‚ç‡éšä¹‹å¢åŠ ï¼Œè¯¯åˆ¤ç‡ä¹Ÿå°±éšä¹‹ä¸Šå‡ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20241019192648.png" alt="å‹‡å“¥ï¼šå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤" tabindex="0" loading="lazy"><figcaption>å‹‡å“¥ï¼šå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤</figcaption></figure><p>è¯¯åˆ¤ç‡å–å†³äºä»¥ä¸‹ 3 ä¸ªå› ç´ ï¼š</p><ol><li>ä½æ•°ç»„çš„å¤§å°ï¼ˆmï¼‰ï¼šm å†³å®šäº†å¯ä»¥å­˜å‚¨çš„æ ‡å¿—ä½æ•°é‡ã€‚å¦‚æœä½æ•°ç»„è¿‡å°ï¼Œé‚£ä¹ˆå“ˆå¸Œç¢°æ’çš„å‡ ç‡å°±ä¼šå¢åŠ ï¼Œä»è€Œå¯¼è‡´æ›´é«˜çš„è¯¯åˆ¤ç‡ã€‚</li><li>å“ˆå¸Œå‡½æ•°çš„æ•°é‡ï¼ˆkï¼‰ï¼šk å†³å®šäº†æ¯ä¸ªå…ƒç´ åœ¨ä½æ•°ç»„ä¸­æ ‡è®°çš„ä½æ•°ã€‚å“ˆå¸Œå‡½æ•°è¶Šå¤šï¼Œç¢°æ’çš„æ¦‚ç‡ä¹Ÿä¼šç›¸åº”å˜åŒ–ã€‚å¦‚æœå“ˆå¸Œå‡½æ•°å¤ªå°‘ï¼Œè¿‡æ»¤å™¨å¾ˆå¿«ä¼šå˜å¾—ä¸ç²¾ç¡®ï¼›å¦‚æœå¤ªå¤šï¼Œè¯¯åˆ¤ç‡ä¹Ÿä¼šå‡é«˜ï¼Œæ•ˆç‡ä¸‹é™ã€‚</li><li>å­˜å…¥çš„å…ƒç´ æ•°é‡ï¼ˆnï¼‰ï¼šn è¶Šå¤šï¼Œå“ˆå¸Œç¢°æ’çš„å‡ ç‡è¶Šå¤§ï¼Œä»è€Œå¯¼è‡´æ›´é«˜çš„è¯¯åˆ¤ç‡ã€‚</li></ol><mjx-container class="MathJax" jax="SVG" display="true" style="position:relative;"><svg style="vertical-align:-1.469ex;" xmlns="http://www.w3.org/2000/svg" width="19.279ex" height="4.563ex" role="img" focusable="false" viewBox="0 -1367.3 8521.2 2016.8" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g><g data-mml-node="mo" transform="translate(550,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(939,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(1460,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(2126.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msup" transform="translate(3182.6,0)"><g data-mml-node="mrow"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M180 96T180 250T205 541T266 770T353 944T444 1069T527 1150H555Q561 1144 561 1141Q561 1137 545 1120T504 1072T447 995T386 878T330 721T288 513T272 251Q272 133 280 56Q293 -87 326 -209T399 -405T475 -531T536 -609T561 -640Q561 -643 555 -649H527Q483 -612 443 -568T353 -443T266 -270T205 -41Z"></path></g><g data-mml-node="mn" transform="translate(597,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1319.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="msup" transform="translate(2319.4,0)"><g data-mml-node="mi"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="TeXAtom" transform="translate(499,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(778,0)"><g data-mml-node="mrow" transform="translate(220,394) scale(0.707)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(521,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="mi" transform="translate(305.9,-345) scale(0.707)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><rect width="992.7" height="60" x="120" y="220"></rect></g></g></g><g data-mml-node="mo" transform="translate(4290.2,0) translate(0 -0.5)"><path data-c="29" d="M35 1138Q35 1150 51 1150H56H69Q113 1113 153 1069T243 944T330 771T391 541T416 250T391 -40T330 -270T243 -443T152 -568T69 -649H56Q43 -649 39 -647T35 -637Q65 -607 110 -548Q283 -316 316 56Q324 133 324 251Q324 368 316 445Q278 877 48 1123Q36 1137 35 1138Z"></path></g></g><g data-mml-node="mi" transform="translate(4920.2,876.6) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mrow data-mjx-texclass="INNER"><mo data-mjx-texclass="OPEN">(</mo><mn>1</mn><mo>âˆ’</mo><msup><mi>e</mi><mrow data-mjx-texclass="ORD"><mo>âˆ’</mo><mfrac><mrow><mi>k</mi><mi>n</mi></mrow><mi>m</mi></mfrac></mrow></msup><mo data-mjx-texclass="CLOSE">)</mo></mrow><mi>k</mi></msup></math></mjx-assistive-mml></mjx-container><p>è¦é™ä½è¯¯åˆ¤ç‡ï¼Œå¯ä»¥å¢åŠ ä½æ•°ç»„çš„å¤§å°æˆ–è€…å‡å°‘æ’å…¥çš„å…ƒç´ æ•°é‡ã€‚</p><p>è¦å½»åº•è§£å†³å¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤é—®é¢˜ï¼Œå¯ä»¥åœ¨å¸ƒéš†è¿‡æ»¤å™¨è¿”å›&quot;å¯èƒ½å­˜åœ¨&quot;æ—¶ï¼Œå†é€šè¿‡æ•°æ®åº“è¿›è¡ŒäºŒæ¬¡ç¡®è®¤ã€‚</p><h4 id="å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒåˆ é™¤å—" tabindex="-1"><a class="header-anchor" href="#å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒåˆ é™¤å—"><span>å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒåˆ é™¤å—ï¼Ÿ</span></a></h4><p>å¸ƒéš†è¿‡æ»¤å™¨å¹¶ä¸æ”¯æŒåˆ é™¤æ“ä½œï¼Œè¿™æ˜¯å®ƒçš„ä¸€ä¸ªé‡è¦é™åˆ¶ã€‚</p><p>å½“æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šå°†ä½æ•°ç»„ä¸­çš„ k ä¸ªä½ç½®è®¾ç½®ä¸º 1ã€‚ç”±äºå¤šä¸ªä¸åŒå…ƒç´ å¯èƒ½å…±äº«ç›¸åŒçš„ä½ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå°†å…¶å¯¹åº”çš„ k ä¸ªä½é‡ç½®ä¸º 0ï¼Œå¯èƒ½ä¼šé”™è¯¯åœ°å½±å“åˆ°å…¶ä»–å…ƒç´ çš„åˆ¤æ–­ç»“æœã€‚</p><p>ä¾‹å¦‚ï¼Œå…ƒç´  A å’Œå…ƒç´  B éƒ½å°†ä½ç½® 5 è®¾ä¸º 1ï¼Œå¦‚æœåˆ é™¤å…ƒç´  A æ—¶å°†ä½ç½® 5 é‡ç½®ä¸º 0ï¼Œé‚£ä¹ˆå¯¹å…ƒç´  B çš„æŸ¥è¯¢å°±ä¼šäº§ç”Ÿé”™è¯¯çš„&quot;ä¸å­˜åœ¨&quot;ç»“æœï¼Œè¿™è¿èƒŒäº†å¸ƒéš†è¿‡æ»¤å™¨çš„åŸºæœ¬ç‰¹æ€§ã€‚</p><p>å¦‚æœæƒ³è¦å®ç°åˆ é™¤æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®ƒåœ¨æ¯ä¸ªä½ç½®ä¸Šå­˜å‚¨ä¸€ä¸ªè®¡æ•°å™¨è€Œä¸æ˜¯å•ä¸€çš„ä½ã€‚è¿™æ ·å¯ä»¥é€šè¿‡å‡å°‘è®¡æ•°å™¨çš„å€¼æ¥å®ç°åˆ é™¤æ“ä½œï¼Œä½†ä¼šå¢åŠ å†…å­˜å¼€é”€ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CountingBloomFilter</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">[] counters</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hashFunctions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CountingBloomFilter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> hashFunctions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> size;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">hashFunctions</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> hashFunctions;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">counters</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[size];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> element</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">positions</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getHashPositions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(element);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> position</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> positions) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            counters[position]++;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> remove</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> element</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">positions</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getHashPositions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(element);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> position</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> positions) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (counters[position] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                counters[position]--;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> mightContain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> element</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">positions</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getHashPositions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(element);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> position</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> positions) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (counters[position] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">[] </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getHashPositions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> element</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // è®¡ç®—å“ˆå¸Œä½ç½®çš„ä»£ç </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸ºä»€ä¹ˆä¸èƒ½ç”¨å“ˆå¸Œè¡¨è€Œæ˜¯ç”¨å¸ƒéš†è¿‡æ»¤å™¨" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆä¸èƒ½ç”¨å“ˆå¸Œè¡¨è€Œæ˜¯ç”¨å¸ƒéš†è¿‡æ»¤å™¨"><span>ä¸ºä»€ä¹ˆä¸èƒ½ç”¨å“ˆå¸Œè¡¨è€Œæ˜¯ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿ</span></a></h4><p>å¸ƒéš†è¿‡æ»¤å™¨æœ€çªå‡ºçš„ä¼˜åŠ¿æ˜¯å†…å­˜æ•ˆç‡ã€‚</p><p>å‡å¦‚æˆ‘ä»¬è¦åˆ¤æ–­ 10 äº¿ä¸ªç”¨æˆ· ID æ˜¯å¦æ›¾ç»è®¿é—®è¿‡ç‰¹å®šé¡µé¢ï¼Œä½¿ç”¨å“ˆå¸Œè¡¨è‡³å°‘éœ€è¦ 10G å†…å­˜ï¼ˆæ¯ä¸ª ID è‡³å°‘éœ€è¦8å­—èŠ‚ï¼‰ï¼Œè€Œä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨åªéœ€è¦ 1.2G å†…å­˜ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>m â‰ˆ -n*ln(p)/ln(2)Â² â‰ˆ -10â¹*ln(0.01)/ln(2)Â² â‰ˆ 9.6 billion bits â‰ˆ 1.2GB</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šæœ‰äº†è§£è¿‡å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„TPè”æ´²åŒå­¦ 5 Java åç«¯ä¸€é¢çš„åŸé¢˜ï¼šå¸ƒéš†è¿‡æ»¤å™¨åŸç†ï¼Œè¿™ç§æ–¹å¼ä¸‹5%çš„é”™è¯¯ç‡å¯æ¥å—ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢åŒå­¦ 9 ä¸€é¢é¢è¯•åŸé¢˜ï¼šå¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿå¸ƒéš†è¿‡æ»¤å™¨ä¼˜ç‚¹ï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½ç”¨å“ˆå¸Œè¡¨è¦ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç†æƒ³æ±½è½¦é¢ç»åŒå­¦ 2 ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¿½é—®ï¼šè¯´æ˜ä¸€ä¸‹å¸ƒéš†è¿‡æ»¤å™¨</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 20 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘è´´</a>è¯´æ‹¿åˆ°äº†æ»´æ»´çš„æš‘æœŸ offerï¼Œç‰¹æ„æ¥æ„Ÿè°¢äº†ä¸€ä¸‹é¢æ¸£é€†è¢­ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250521151850.png" alt="æ‹¿åˆ°äº†æ»´æ»´çš„ offer" tabindex="0" loading="lazy"><figcaption>æ‹¿åˆ°äº†æ»´æ»´çš„ offer</figcaption></figure><h3 id="_31-ğŸŒŸå¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§" tabindex="-1"><a class="header-anchor" href="#_31-ğŸŒŸå¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§"><span>31.ğŸŒŸå¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®â¼€è‡´æ€§ï¼Ÿ</span></a></h3><p>åœ¨<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" target="_blank" rel="noopener noreferrer">æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®</a>ä¸­ï¼Œå¯¹äºæ–‡ç« æ ‡ç­¾è¿™ç§å…è®¸çŸ­æš‚ä¸ä¸€è‡´çš„æ•°æ®ï¼Œæˆ‘ä¼šé‡‡ç”¨ <a href="https://coolshell.cn/articles/17416.html" target="_blank" rel="noopener noreferrer">Cache Aside</a> + TTL è¿‡æœŸæœºåˆ¶æ¥ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240325221330.png" alt="æŠ€æœ¯æ´¾æ•™ç¨‹ï¼šMySQL å’Œ Redis ä¸€è‡´æ€§" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾æ•™ç¨‹ï¼šMySQL å’Œ Redis ä¸€è‡´æ€§</figcaption></figure><p>å…·ä½“åšæ³•æ˜¯è¯»å–æ—¶å…ˆæŸ¥ Redisï¼Œæœªå‘½ä¸­å†æŸ¥ MySQLï¼ŒåŒæ—¶ä¸ºç¼“å­˜è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ï¼›æ›´æ–°æ—¶å…ˆæ›´æ–° MySQLï¼Œå†åˆ é™¤ Redisã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è¯»å–é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UserInfo</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getUser</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> userId) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å…ˆæŸ¥ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    UserInfo</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> user </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> userId);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (user </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    user </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">selectUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (user </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ”¾å…¥ç¼“å­˜ï¼Œè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> userId, user, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3600</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ›´æ–°é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> updateUser</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">UserInfo</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> user) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å…ˆæ›´æ–°æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">updateUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(user);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // åˆ é™¤ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">delete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§æ–¹å¼ç®€å•æœ‰æ•ˆï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚TTL è¿‡æœŸæ—¶é—´ä¹Ÿèƒ½å¤Ÿä¿è¯å³ä½¿æ›´æ–°æ“ä½œå¤±è´¥ï¼Œæœªèƒ½åŠæ—¶åˆ é™¤ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—´ä¹Ÿèƒ½ç¡®ä¿æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚</p><h4 id="é‚£å†æ¥è¯´è¯´ä¸ºä»€ä¹ˆè¦åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#é‚£å†æ¥è¯´è¯´ä¸ºä»€ä¹ˆè¦åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜"><span>é‚£å†æ¥è¯´è¯´ä¸ºä»€ä¹ˆè¦åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ</span></a></h4><p>æœ€åˆè®¾è®¡ç¼“å­˜ç­–ç•¥æ—¶ï¼Œæˆ‘ä¹Ÿè€ƒè™‘è¿‡ç›´æ¥æ›´æ–°ç¼“å­˜ï¼Œä½†é€šè¿‡å®è·µå‘ç°ï¼Œåˆ é™¤ç¼“å­˜æ˜¯æ›´ä¼˜çš„é€‰æ‹©ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250522100735.png" alt="æŠ€æœ¯æ´¾ï¼šæ›´æ–° Redis è€Œä¸æ˜¯åˆ é™¤ Redis" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾ï¼šæ›´æ–° Redis è€Œä¸æ˜¯åˆ é™¤ Redis</figcaption></figure><p>æœ€ä¸»è¦çš„åŸå› æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå¹¶å‘çš„æ›´æ–°æ“ä½œï¼Œå¦‚æœé‡‡ç”¨æ›´æ–°ç¼“å­˜çš„ç­–ç•¥ï¼Œå°±å¯èƒ½å‡ºç°è¿™æ ·çš„æ—¶åºé—®é¢˜ï¼š</p><ul><li>æ“ä½œ A å’Œæ“ä½œ B åŒæ—¶å‘ç”Ÿï¼ŒA å…ˆæ›´æ–° MySQL å°†å€¼æ”¹ä¸º 10ï¼ŒB åæ›´æ–° MySQL å°†å€¼æ”¹ä¸º 11ã€‚ä½†åœ¨ç¼“å­˜æ›´æ–°æ—¶ï¼Œå¯èƒ½ B å…ˆæ‰§è¡Œå°†ç¼“å­˜è®¾ä¸º 11ï¼Œç„¶å A æ‰æ‰§è¡Œå°†ç¼“å­˜è®¾ä¸º10ã€‚è¿™æ ·å°±ä¼šé€ æˆ MySQL æ˜¯ 11 ä½† Redis æ˜¯ 10 çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚</li></ul><p>è€Œé‡‡ç”¨åˆ é™¤ç­–ç•¥ï¼Œæ— è®º A å’Œ B è°å…ˆåˆ é™¤ç¼“å­˜ï¼Œåç»­çš„è¯»å–æ“ä½œéƒ½ä¼šä» MySQL è·å–æœ€æ–°å€¼ã€‚</p><p>å¦å¤–ï¼Œç›¸å¯¹è€Œè¨€ï¼Œåˆ é™¤ç¼“å­˜çš„é€Ÿåº¦æ¯”æ›´æ–°ç¼“å­˜çš„é€Ÿåº¦å¿«å¾—å¤šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-ebad0a67-3012-4466-a4dc-e834104c48f8.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šåˆ é™¤ç¼“å­˜å’Œæ›´æ–°ç¼“å­˜" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šåˆ é™¤ç¼“å­˜å’Œæ›´æ–°ç¼“å­˜</figcaption></figure><p>å› ä¸ºåˆ é™¤æ“ä½œåªæ˜¯ç®€å•çš„ DEL å‘½ä»¤ï¼Œè€Œæ›´æ–°å¯èƒ½éœ€è¦é‡æ–°åºåˆ—åŒ–æ•´ä¸ªå¯¹è±¡å†å†™å…¥ç¼“å­˜ã€‚</p><h4 id="é‚£å†è¯´è¯´ä¸ºä»€ä¹ˆè¦å…ˆæ›´æ–°æ•°æ®åº“-å†åˆ é™¤ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#é‚£å†è¯´è¯´ä¸ºä»€ä¹ˆè¦å…ˆæ›´æ–°æ•°æ®åº“-å†åˆ é™¤ç¼“å­˜"><span>é‚£å†è¯´è¯´ä¸ºä»€ä¹ˆè¦å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼Ÿ</span></a></h4><p>è¿™ä¸ªæ“ä½œé¡ºåºçš„é€‰æ‹©ä¹Ÿæ˜¯æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­è¸©è¿‡å‘æ‰æ·±åˆ»ç†è§£çš„ã€‚å‡è®¾æˆ‘ä»¬é‡‡ç”¨å…ˆåˆ ç¼“å­˜å†æ›´æ–°æ•°æ®åº“çš„ç­–ç•¥ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å°±å¯èƒ½å‡ºç°è¿™æ ·çš„é—®é¢˜ï¼š</p><ul><li>çº¿ç¨‹ A è¦æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œå…ˆåˆ é™¤äº†ç¼“å­˜</li><li>çº¿ç¨‹ B æ°å¥½æ­¤æ—¶è¦è¯»å–è¯¥ç”¨æˆ·ä¿¡æ¯ï¼Œå‘ç°ç¼“å­˜ä¸ºç©ºï¼Œäºæ˜¯æŸ¥è¯¢æ•°æ®åº“ï¼Œæ­¤æ—¶è¿˜æ˜¯æ—§å€¼</li><li>çº¿ç¨‹ B å°†æŸ¥åˆ°çš„æ—§å€¼é‡æ–°æ”¾å…¥ç¼“å­˜</li><li>çº¿ç¨‹ A å®Œæˆæ•°æ®åº“æ›´æ–°</li></ul><p>ç»“æœå°±æ˜¯æ•°æ®åº“æ˜¯æ–°çš„å€¼ï¼Œä½†ç¼“å­˜ä¸­è¿˜æ˜¯æ—§å€¼ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250522102052.png" alt="æŠ€æœ¯æ´¾ï¼šå…ˆåˆ  Redis å†æ›´æ–° MySQL" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾ï¼šå…ˆåˆ  Redis å†æ›´æ–° MySQL</figcaption></figure><p>è€Œé‡‡ç”¨å…ˆæ›´æ–°æ•°æ®åº“å†åˆ ç¼“å­˜çš„ç­–ç•¥ï¼Œå³ä½¿å‡ºç°ç±»ä¼¼çš„å¹¶å‘æƒ…å†µï¼Œæœ€åçš„æƒ…å†µä¹Ÿåªæ˜¯çŸ­æš‚åœ°ä»ç¼“å­˜ä¸­è¯»å–åˆ°äº†æ—§å€¼ï¼Œä½†ç¼“å­˜åˆ é™¤åçš„è¯·æ±‚ä¼šç›´æ¥ä»æ•°æ®åº“ä¸­è·å–æœ€æ–°å€¼ã€‚</p><p>å¦å¤–ï¼Œå¦‚æœå…ˆåˆ ç¼“å­˜å†æ›´æ–°æ•°æ®åº“ï¼Œå½“æ•°æ®åº“æ›´æ–°å¤±è´¥æ—¶ï¼Œç¼“å­˜å·²ç»è¢«åˆ é™¤äº†ã€‚è¿™ä¼šå¯¼è‡´çŸ­æœŸå†…æ‰€æœ‰è¯»è¯·æ±‚éƒ½ä¼šç©¿é€åˆ°æ•°æ®åº“ï¼Œå¯¹æ•°æ®åº“é€ æˆé¢å¤–çš„å‹åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5c929a9e-a723-43b3-8f3c-f22c83765f9d.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå…ˆæ›´æ•°æ®åº“è¿˜æ˜¯å…ˆåˆ ç¼“å­˜" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå…ˆæ›´æ•°æ®åº“è¿˜æ˜¯å…ˆåˆ ç¼“å­˜</figcaption></figure><p>è€Œå…ˆæ›´æ–°æ•°æ®åº“å†åˆ ç¼“å­˜ï¼Œå¦‚æœæ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œç¼“å­˜ä¿æŒåŸçŠ¶ï¼Œç³»ç»Ÿä»ç„¶èƒ½ç»§ç»­æ­£å¸¸æä¾›æœåŠ¡ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> updateUser</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">User</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> user) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å…ˆæ›´æ–°æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">updateUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(user);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å†åˆ é™¤ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">delete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">DatabaseException</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œç¼“å­˜ä¿æŒåŸçŠ¶ï¼Œç³»ç»Ÿä»å¯æ­£å¸¸æä¾›æœåŠ¡</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Database update failed&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, e);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        throw</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CacheException</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ç¼“å­˜åˆ é™¤å¤±è´¥ï¼Œæ•°æ®åº“å·²æ›´æ–°ï¼Œæ•°æ®ä¼šåœ¨TTLåè‡ªåŠ¨ä¸€è‡´</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">warn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Cache deletion failed, will be eventually consistent&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, e);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å¯ä»¥é€‰æ‹©ä¸æŠ›å¼‚å¸¸ï¼Œå› ä¸ºæœ‰TTLå…œåº•</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>memoï¼š2025 å¹´ 5 æœˆ 22 æ—¥ï¼Œä»Šå¤©ç»™çƒå‹<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">ä¿®æ”¹ç®€å†</a>æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªè¥¿åŒ—å·¥ä¸šå¤§å­¦æœ¬ã€ç”µå­ç§‘æŠ€å¤§å­¦ç¡•çš„çƒå‹ï¼Œä¸€ä¸‹å­ 985 é«˜æ ¡åˆé›†é½äº†ä¸¤æ‰€ã€‚å¦‚æœçƒå‹ä»¬åœ¨æ˜Ÿçƒé‡Œæœ‰æ‰€æ”¶è·ï¼Œä¹Ÿè¯·ç»™å­¦å¼Ÿå­¦å¦¹ä»¬ä¸€ä¸ªå£ç¢‘ï¼Œè®©å¤§å®¶éƒ½èƒ½å› æ­¤å—ç›Šï¼Œæ‹¿åˆ°æ›´å¥½çš„ offerã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250522102954.png" alt="è¥¿åŒ—å·¥ä¸šå¤§å­¦æœ¬ã€ç”µå­ç§‘æŠ€å¤§å­¦ç¡•çš„çƒå‹" tabindex="0" loading="lazy"><figcaption>è¥¿åŒ—å·¥ä¸šå¤§å­¦æœ¬ã€ç”µå­ç§‘æŠ€å¤§å­¦ç¡•çš„çƒå‹</figcaption></figure><h4 id="é‚£å‡å¦‚å¯¹ç¼“å­˜æ•°æ®åº“ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜-è¯¥æ€ä¹ˆåŠå‘¢" tabindex="-1"><a class="header-anchor" href="#é‚£å‡å¦‚å¯¹ç¼“å­˜æ•°æ®åº“ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜-è¯¥æ€ä¹ˆåŠå‘¢"><span>é‚£å‡å¦‚å¯¹ç¼“å­˜æ•°æ®åº“ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</span></a></h4><p>å½“ä¸šåŠ¡å¯¹ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜æ—¶ï¼Œæ¯”å¦‚æ”¯ä»˜ç³»ç»Ÿã€åº“å­˜ç®¡ç†ç­‰åœºæ™¯ï¼Œæˆ‘ä¼šé‡‡ç”¨å¤šç§ç­–ç•¥æ¥ä¿è¯å¼ºä¸€è‡´æ€§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240325225250.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šç¼“å­˜å¼ºä¸€è‡´æ€§" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šç¼“å­˜å¼ºä¸€è‡´æ€§</figcaption></figure><p>ç¬¬ä¸€ç§ï¼Œå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—æ¥ä¿è¯ç¼“å­˜æœ€ç»ˆè¢«åˆ é™¤ï¼Œæ¯”å¦‚è¯´åœ¨æ•°æ®åº“æ›´æ–°çš„äº‹åŠ¡ä¸­æ’å…¥ä¸€æ¡æœ¬åœ°æ¶ˆæ¯è®°å½•ï¼Œäº‹åŠ¡æäº¤åå¼‚æ­¥å‘é€ç»™ MQ è¿›è¡Œç¼“å­˜åˆ é™¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e4a61193-515a-409f-a436-2733abc3a86e.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¿è¯keyè¢«åˆ é™¤" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¿è¯keyè¢«åˆ é™¤</figcaption></figure><p>å³ä½¿ç¼“å­˜åˆ é™¤å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„é‡è¯•æœºåˆ¶ä¹Ÿèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> updateUser</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">UserInfo</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> user) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // åœ¨äº‹åŠ¡ä¸­æ›´æ–°æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">updateUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(user);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // åœ¨åŒä¸€äº‹åŠ¡ä¸­è®°å½•éœ€è¦åˆ é™¤çš„ç¼“å­˜ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    LocalMessage</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> message </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> LocalMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;CACHE_DELETE&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">insertLocalMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(message);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ˜¾å¼å‘å¸ƒäº‹ä»¶ï¼Œä¾›ç›‘å¬å™¨æ•è·</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    eventPublisher</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">publishEvent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> UserUpdateEvent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// äº‹åŠ¡æäº¤åå‘é€MQæ¶ˆæ¯</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">TransactionalEventListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">phase</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> TransactionPhase</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">AFTER_COMMIT</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sendCacheDeleteMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">UserUpdateEvent</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> event) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    messageQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">send</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cache-delete-topic&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">event</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getCacheKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒç§ï¼Œä½¿ç”¨ <a href="https://github.com/alibaba/canal" target="_blank" rel="noopener noreferrer">Canal</a> ç›‘å¬ MySQL çš„ binlogï¼Œåœ¨æ•°æ®æ›´æ–°æ—¶ï¼Œå°†æ•°æ®å˜æ›´è®°å½•åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…æ¶ˆæ¯ç›‘å¬åˆ°å˜æ›´åå»åˆ é™¤ç¼“å­˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-37c07418-9cd8-43d9-90e7-0cb43b329025.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ•°æ®åº“è®¢é˜…+æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯keyè¢«åˆ é™¤" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ•°æ®åº“è®¢é˜…+æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯keyè¢«åˆ é™¤</figcaption></figure><p>è¿™ç§æ–¹æ¡ˆçš„ä¼˜åŠ¿æ˜¯å®Œå…¨è§£è€¦äº†ä¸šåŠ¡ä»£ç å’Œç¼“å­˜ç»´æŠ¤é€»è¾‘ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">CanalListener</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CacheUpdateListener</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">EventHandler</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> handleUserUpdate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">UserUpdateEvent</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> event</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ä»binlogäº‹ä»¶ä¸­æå–å˜æ›´ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> userId</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> event</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getUserId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å‘é€ç¼“å­˜åˆ é™¤æ¶ˆæ¯</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        CacheDeleteMessage</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> message</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CacheDeleteMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setCacheKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> userId);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        messageQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">send</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cache-delete-topic&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">KafkaListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">topics</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;cache-delete-topic&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> handleCacheDeleteMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CacheDeleteMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> message) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // åˆ é™¤ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">delete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getCacheKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç„¶äº†ï¼Œå¦‚æœè¯´ä¸šåŠ¡æ¯”è¾ƒç®€å•ï¼Œä¸éœ€è¦ä¸Šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥é€šè¿‡å»¶è¿ŸåŒåˆ ç­–ç•¥é™ä½ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´çš„æ—¶é—´çª—å£ï¼Œåœ¨ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ä¹‹åï¼Œè¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå†æ¬¡å°è¯•åˆ é™¤ç¼“å­˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-fab24753-9c53-4432-9413-5feba07ae1e3.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå»¶æ—¶åŒåˆ " tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå»¶æ—¶åŒåˆ </figcaption></figure><p>è¿™ç§æ–¹å¼ä¸»è¦é’ˆå¯¹ç¼“å­˜ä¸å­˜åœ¨ï¼Œä½†å†™å…¥äº†è„æ•°æ®çš„æƒ…å†µã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> updateUser</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">UserInfo</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> user) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ï¼Œå‡å°‘ä¸ä¸€è‡´æ—¶é—´çª—å£</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">delete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ›´æ–°æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">updateUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(user);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç«‹å³åˆ é™¤ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">delete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å»¶æ—¶åˆ é™¤ï¼Œåº”å¯¹å¯èƒ½çš„å¹¶å‘è¯»å–</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    CompletableFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">runAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">); </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å»¶æ—¶æ—¶é—´æ ¹æ®ä¸»ä»åŒæ­¥å»¶è¿Ÿè°ƒæ•´</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">delete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">InterruptedException</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">interrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åï¼Œæ— è®ºé‡‡ç”¨å“ªç§ç­–ç•¥ï¼Œæœ€å¥½ä¸ºç¼“å­˜è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ä½œä¸ºæœ€åçš„ä¿éšœã€‚å³ä½¿æ‰€æœ‰çš„ä¸»åŠ¨åˆ é™¤æœºåˆ¶éƒ½å¤±è´¥äº†ï¼ŒTTL ä¹Ÿèƒ½ç¡®ä¿æ•°æ®æœ€ç»ˆè¾¾åˆ°ä¸€è‡´ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ ¹æ®æ•°æ®çš„é‡è¦ç¨‹åº¦è®¾ç½®ä¸åŒçš„TTL</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> setCache</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DataImportance</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> importance) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ttl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    switch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (importance) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        case</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> HIGH</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">      // å…³é”®æ•°æ®ï¼ŒçŸ­TTL</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            ttl </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 300</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // 5åˆ†é’Ÿ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        case</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> MEDIUM</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ä¸€èˆ¬æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            ttl </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1800</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // 30åˆ†é’Ÿ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        case</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> LOW</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       // ä¸å¤ªé‡è¦çš„æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            ttl </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3600</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // 1å°æ—¶</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setWithTTL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, value, ttl);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§æ–¹å¼è™½ç„¶ç®€å•ï¼Œä½†èƒ½ç¡®ä¿å³ä½¿å‡ºç°æç«¯æƒ…å†µï¼Œæ•°æ®ä¸ä¸€è‡´çš„å½±å“ä¹Ÿæ˜¯å¯æ§çš„ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åä¸ºé¢ç»åŒå­¦ 8 æŠ€æœ¯äºŒé¢é¢è¯•åŸé¢˜ï¼šæ€æ ·ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 23 QQ åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šæ•°æ®ä¸€è‡´æ€§é—®é¢˜</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¾®ä¼—é“¶è¡ŒåŒå­¦ 1 Java åç«¯ä¸€é¢çš„åŸé¢˜ï¼šMySQL å’Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜äº†è§£å—ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 3 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šå¦‚ä½•ä¿è¯ redis ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æ¯”äºšè¿ªé¢ç»åŒå­¦ 12 Java æŠ€æœ¯é¢è¯•åŸé¢˜ï¼šæ€ä¹ˆè§£å†³rediså’Œmysqlçš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 17 åç«¯æŠ€æœ¯é¢è¯•åŸé¢˜ï¼šåŒå†™ä¸€è‡´æ€§æ€ä¹ˆè§£å†³çš„</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 9 é¢è¯•åŸé¢˜ï¼šredisçš„æ•°æ®å’Œç¼“å­˜ä¸ä¸€è‡´åº”è¯¥å¤„ç†</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 23 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">çƒå‹ç®€å†</a>æ—¶ï¼Œçœ‹åˆ°ä¸€æ¡éå¸¸æ¸©æš–çš„æ„Ÿè°¢ä¿¡ï¼Œçƒå‹è¯´æ”¹å®Œåçš„ç®€å†ï¼Œæ¯ä¸€å¥éƒ½æ¯”ä¹‹å‰çš„å¥½å¾ˆå¤šï¼ŒçœŸçš„å¾ˆæ¬£æ…°ï¼Œæ„Ÿè§‰è‡ªå·±çš„ä»˜å‡ºå¾—åˆ°äº†å›æŠ¥ã€‚ğŸ˜„</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-æ„Ÿè°¢äºŒå“¥çš„æŒ‡æ­£ï¼Œæ¯ä¸€å¥éƒ½æ„Ÿè§‰æ¯”æˆ‘çš„å¥½å¾ˆå¤šï¼Œæ”¹å®Œä¹‹åç®€å†è´¨é‡é ­é—´æ¶¨äº†ä¸å°‘ï¼Œå¤ªæ„Ÿè°¢äº†.png" alt="çƒå‹å¯¹ç®€å†ä¿®æ”¹çš„è®¤å¯" tabindex="0" loading="lazy"><figcaption>çƒå‹å¯¹ç®€å†ä¿®æ”¹çš„è®¤å¯</figcaption></figure><h3 id="_32-å¦‚ä½•ä¿è¯æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜çš„ä¸€è‡´" tabindex="-1"><a class="header-anchor" href="#_32-å¦‚ä½•ä¿è¯æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜çš„ä¸€è‡´"><span>32.å¦‚ä½•ä¿è¯æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜çš„ä¸€è‡´ï¼Ÿ</span></a></h3><p>åœ¨<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" target="_blank" rel="noopener noreferrer">æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®</a>ä¸­ï¼Œä¸ºäº†å‡è½» Redis çš„è´Ÿè½½å‹åŠ›ï¼Œæˆ‘åˆè¿½åŠ äº†ä¸€å±‚æœ¬åœ°ç¼“å­˜ Caffeineã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-6d4ab7e6-8337-4576-bbf0-79202a1c3331.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæœ¬åœ°ç¼“å­˜+åˆ†å¸ƒå¼ç¼“å­˜" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæœ¬åœ°ç¼“å­˜+åˆ†å¸ƒå¼ç¼“å­˜</figcaption></figure><p>ä¸ºäº†ä¿è¯ Caffeine å’Œ Redis ç¼“å­˜çš„ä¸€è‡´æ€§ï¼Œæˆ‘é‡‡ç”¨çš„ç­–ç•¥æ˜¯å½“æ•°æ®æ›´æ–°æ—¶ï¼Œé€šè¿‡ Redis çš„ pub/sub æœºåˆ¶å‘æ‰€æœ‰åº”ç”¨å®ä¾‹å‘é€ç¼“å­˜æ›´æ–°é€šçŸ¥ï¼Œæ”¶åˆ°é€šçŸ¥åçš„å®ä¾‹ç«‹å³æ›´æ–°æˆ–è€…åˆ é™¤æœ¬åœ°ç¼“å­˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-20c15f0d-fb3c-4922-94b1-edcd856658be.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæœ¬åœ°ç¼“å­˜/åˆ†å¸ƒå¼ç¼“å­˜ä¿æŒä¸€è‡´" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæœ¬åœ°ç¼“å­˜/åˆ†å¸ƒå¼ç¼“å­˜ä¿æŒä¸€è‡´</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Service</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CacheService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CaffeineCache</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> updateData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ›´æ–°æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, value);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ›´æ–°åˆ†å¸ƒå¼ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, value, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">30</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MINUTES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å‘é€ç¼“å­˜æ›´æ–°é€šçŸ¥</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        CacheUpdateMessage</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> message</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CacheUpdateMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;UPDATE&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, value);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">convertAndSend</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cache-update-channel&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">EventListener</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> handleCacheUpdate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CacheUpdateMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;UPDATE&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">equals</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">())) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;DELETE&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">equals</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">())) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">invalidate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è€ƒè™‘åˆ°æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼Œæˆ‘è¿˜ä¼šå¼•å…¥ç‰ˆæœ¬å·æœºåˆ¶ä½œä¸ºè¡¥å……ã€‚æ¯æ¬¡ä» Redis è·å–æ•°æ®æ—¶æ·»åŠ ä¸€ä¸ªæœ€æ–°çš„ç‰ˆæœ¬å·ã€‚ä»æœ¬åœ°ç¼“å­˜è·å–æ•°æ®å‰ï¼Œå…ˆæ£€æŸ¥è‡ªå·±çš„ç‰ˆæœ¬å·æ˜¯å¦æ˜¯æœ€æ–°çš„ï¼Œå¦‚æœå‘ç°ç‰ˆæœ¬è½åï¼Œå°±ä¸»åŠ¨ä» Redis ä¸­è·å–æœ€æ–°æ•°æ®ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Component</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> VersionBasedCacheManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> StringRedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ä½¿ç”¨ Caffeine æ„å»ºæœ¬åœ°ç¼“å­˜ï¼šæœ€å¤š 1000 é¡¹ï¼Œå†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Cache</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> VersionedData</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> localCache </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Caffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">newBuilder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">maximumSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">expireAfterWrite</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MINUTES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * è·å–ç¼“å­˜æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œå¿…è¦æ—¶ä» Redis åŠ è½½</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        VersionedData</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cached</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getIfPresent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key); </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ä»æœ¬åœ°ç¼“å­˜å–å‡º</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ä» Redis è·å–ç‰ˆæœ¬å·</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> versionStr</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;:version&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å¦‚æœ Redis ä¸­æ²¡æ‰¾åˆ°ç‰ˆæœ¬å·ï¼Œè¯´æ˜å¯èƒ½æ•°æ®å·²å¤±æ•ˆï¼Œå¼ºåˆ¶åˆ·æ–°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (versionStr </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> loadAndCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> remoteVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">parseLong</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(versionStr);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å¦‚æœæœ¬åœ°æ²¡æœ‰ç¼“å­˜ï¼Œæˆ–ç‰ˆæœ¬è½åäº Redisï¼Œå¼ºåˆ¶åˆ·æ–°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (cached </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cached</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> remoteVersion) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> loadAndCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å‘½ä¸­æœ¬åœ°ç¼“å­˜ä¸”ç‰ˆæœ¬æœ€æ–°ï¼Œç›´æ¥è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cached</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * ä» Redis åŠ è½½æ•°æ®å’Œç‰ˆæœ¬ï¼Œå¹¶å†™å…¥æœ¬åœ°ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> loadAndCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> versionStr</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;:version&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (data </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> versionStr </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> version</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">parseLong</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(versionStr);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> VersionedData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(data, version));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> data;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¦‚æœåœ¨é¡¹ç›®ä¸­å¤šä¸ªåœ°æ–¹éƒ½è¦ä½¿ç”¨åˆ°äºŒçº§ç¼“å­˜çš„é€»è¾‘-å¦‚ä½•è®¾è®¡è¿™ä¸€å—" tabindex="-1"><a class="header-anchor" href="#å¦‚æœåœ¨é¡¹ç›®ä¸­å¤šä¸ªåœ°æ–¹éƒ½è¦ä½¿ç”¨åˆ°äºŒçº§ç¼“å­˜çš„é€»è¾‘-å¦‚ä½•è®¾è®¡è¿™ä¸€å—"><span>å¦‚æœåœ¨é¡¹ç›®ä¸­å¤šä¸ªåœ°æ–¹éƒ½è¦ä½¿ç”¨åˆ°äºŒçº§ç¼“å­˜çš„é€»è¾‘ï¼Œå¦‚ä½•è®¾è®¡è¿™ä¸€å—ï¼Ÿ</span></a></h4><p>æˆ‘çš„æ€è·¯æ˜¯å°†äºŒçº§ç¼“å­˜æŠ½è±¡æˆä¸€ä¸ªç»Ÿä¸€çš„ç»„ä»¶ã€‚è®¾è®¡ä¸€ä¸ª CacheManager ä½œä¸ºæ ¸å¿ƒå…¥å£ï¼Œæä¾› getã€putã€evict ç­‰åŸºæœ¬æ“ä½œï¼Œæ‰§è¡Œå…ˆæŸ¥æœ¬åœ°ç¼“å­˜ï¼Œå†æŸ¥åˆ†å¸ƒå¼ç¼“å­˜ï¼Œæœ€åæŸ¥æ•°æ®åº“çš„å®Œæ•´æµç¨‹ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CacheManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> LocalCache</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisCache</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Database</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CacheManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">LocalCache</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RedisCache</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> redisCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Database</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> localCache;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redisCache</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> redisCache;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">database</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> database;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å…ˆæŸ¥æœ¬åœ°ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (value </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å†æŸ¥åˆ†å¸ƒå¼ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        value </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (value </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // æ›´æ–°æœ¬åœ°ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, value);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æœ€åæŸ¥æ•°æ®åº“</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        value </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (value </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // æ›´æ–°åˆ†å¸ƒå¼ç¼“å­˜å’Œæœ¬åœ°ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            redisCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, value);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            localCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, value);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æœ¬åœ°ç¼“å­˜å’Œ-redis-çš„åŒºåˆ«äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#æœ¬åœ°ç¼“å­˜å’Œ-redis-çš„åŒºåˆ«äº†è§£å—"><span>æœ¬åœ°ç¼“å­˜å’Œ Redis çš„åŒºåˆ«äº†è§£å—ï¼Ÿ</span></a></h4><p>Redis å¯ä»¥éƒ¨ç½²åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ”¯æŒæ•°æ®åˆ†ç‰‡ã€ä¸»ä»å¤åˆ¶å’Œé›†ç¾¤ã€‚è€Œæœ¬åœ°ç¼“å­˜åªèƒ½åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šä½¿ç”¨ã€‚</p><p>å¯¹äºè¯»å–é¢‘ç‡æé«˜ã€æ•°æ®ç›¸å¯¹ç¨³å®šã€å…è®¸çŸ­æš‚ä¸ä¸€è‡´çš„æ•°æ®ï¼Œæˆ‘ä¼˜å…ˆé€‰æ‹©æœ¬åœ°ç¼“å­˜ã€‚æ¯”å¦‚ç³»ç»Ÿé…ç½®ä¿¡æ¯ã€ç”¨æˆ·æƒé™æ•°æ®ã€å•†å“åˆ†ç±»ä¿¡æ¯ç­‰ã€‚</p><p>è€Œå¯¹äºéœ€è¦å®æ—¶åŒæ­¥ã€æ•°æ®å˜åŒ–é¢‘ç¹ã€å¤šä¸ªæœåŠ¡éœ€è¦å…±äº«çš„æ•°æ®ï¼Œæˆ‘ä¼šé€‰æ‹© Redisã€‚æ¯”å¦‚ç”¨æˆ·ä¼šè¯ä¿¡æ¯ã€è´­ç‰©è½¦æ•°æ®ã€å®æ—¶ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šæ€ä¹ˆä¿è¯äºŒçº§ç¼“å­˜å’Œ Redis ç¼“å­˜çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åä¸ºé¢ç»åŒå­¦ 11 é¢è¯•åŸé¢˜ï¼šä½¿ç”¨çš„ guava cache å’Œ redis æ˜¯å¦‚ä½•ç»„åˆä½¿ç”¨çš„ï¼Ÿå¦‚æœåœ¨é¡¹ç›®ä¸­å¤šä¸ªåœ°æ–¹éƒ½è¦ä½¿ç”¨åˆ°äºŒçº§ç¼“å­˜çš„é€»è¾‘ï¼Œå¦‚ä½•è®¾è®¡è¿™ä¸€å—ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å»å“ªå„¿åŒå­¦ 1 æŠ€æœ¯äºŒé¢çš„åŸé¢˜ï¼šredis å’Œæœ¬åœ°ç¼“å­˜çš„åŒºåˆ«ï¼Œå“ªä¸ªæ•ˆç‡é«˜</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æ‹¼å¤šå¤šé¢ç»åŒå­¦ 8 ä¸€é¢é¢è¯•åŸé¢˜ï¼šç¼“å­˜ä¸€è‡´æ€§å¦‚ä½•ä¿è¯</li></ol></blockquote><h3 id="_33-ä»€ä¹ˆæ˜¯çƒ­key" tabindex="-1"><a class="header-anchor" href="#_33-ä»€ä¹ˆæ˜¯çƒ­key"><span>33.ä»€ä¹ˆæ˜¯çƒ­Keyï¼Ÿ</span></a></h3><p>æ‰€è°“çš„çƒ­ Keyï¼Œå°±æ˜¯æŒ‡åœ¨å¾ˆçŸ­æ—¶é—´å†…è¢«é¢‘ç¹è®¿é—®çš„é”®ã€‚æ¯”å¦‚ç”µå•†å¤§ä¿ƒæœŸé—´çˆ†æ¬¾å•†å“çš„è¯¦æƒ…ä¿¡æ¯ï¼Œæµé‡æ˜æ˜Ÿçˆ†ç“œæ—¶çš„ä¸ªäººèµ„æ–™ã€çƒ­é—¨è¯é¢˜ç­‰ï¼Œéƒ½å¯èƒ½æˆä¸ºçƒ­Keyã€‚</p><p>ç”±äº Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œå¤§é‡è¯·æ±‚é›†ä¸­åˆ°åŒä¸€ä¸ªé”®ä¼šå¯¼è‡´è¯¥ Redis èŠ‚ç‚¹çš„ CPU ä½¿ç”¨ç‡é£™å‡ï¼Œå“åº”æ—¶é—´å˜é•¿ã€‚</p><p>åœ¨ Redis é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œçƒ­Key è¿˜ä¼šå¯¼è‡´æ•°æ®åˆ†å¸ƒä¸å‡è¡¡ï¼ŒæŸä¸ªèŠ‚ç‚¹æ‰¿å—çš„å‹åŠ›è¿‡å¤§è€Œå…¶ä»–èŠ‚ç‚¹ç›¸å¯¹ç©ºé—²ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250524105015.png" alt="é£çŒªå¼€æ”¾å¹³å°ï¼šçƒ­ Key é€ æˆç¼“å­˜å‡»ç©¿" tabindex="0" loading="lazy"><figcaption>é£çŒªå¼€æ”¾å¹³å°ï¼šçƒ­ Key é€ æˆç¼“å­˜å‡»ç©¿</figcaption></figure><p>æ›´ä¸¥é‡çš„æƒ…å†µæ˜¯ï¼Œå½“çƒ­Key è¿‡æœŸæˆ–è¢«è¯¯åˆ æ—¶ï¼Œä¼šå¼•å‘ç¼“å­˜å‡»ç©¿é—®é¢˜ã€‚</p><h4 id="é‚£æ€ä¹ˆç›‘æ§çƒ­key-å‘¢" tabindex="-1"><a class="header-anchor" href="#é‚£æ€ä¹ˆç›‘æ§çƒ­key-å‘¢"><span>é‚£æ€ä¹ˆç›‘æ§çƒ­Key å‘¢ï¼Ÿ</span></a></h4><p>ä¸´æ—¶çš„æ–¹æ¡ˆå¯ä»¥ä½¿ç”¨ <code>redis-cli --hotkeys</code> å‘½ä»¤æ¥ç›‘æ§ Redis ä¸­çš„çƒ­ Keyã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>redis-cli -h &lt;address&gt; -p &lt;port&gt; -a&lt;password&gt; â€” hotkey</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250524110756.png" alt="é£çŒªå¼€æ”¾å¹³å°ï¼šå‘ç°çƒ­ç‚¹æ•°æ®" tabindex="0" loading="lazy"><figcaption>é£çŒªå¼€æ”¾å¹³å°ï¼šå‘ç°çƒ­ç‚¹æ•°æ®</figcaption></figure><p>æˆ–è€…åœ¨è®¿é—®ç¼“å­˜æ—¶ï¼Œåœ¨æœ¬åœ°ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“æŸä¸ªé”®çš„è®¿é—®æ¬¡æ•°åœ¨ä¸€åˆ†é’Ÿå†…è¶…è¿‡è®¾å®šé˜ˆå€¼ï¼Œå°±å°†å…¶æ ‡è®°ä¸ºçƒ­Keyã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Component</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> HotKeyDetector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ConcurrentHashMap</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AtomicLong</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> accessCounter </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ConcurrentHashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> HOT_KEY_THRESHOLD </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> isHotKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> count</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> accessCounter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">computeIfAbsent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, k </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> AtomicLong</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                  .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">incrementAndGet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> count </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> HOT_KEY_THRESHOLD;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_34-é‚£æ€ä¹ˆå¤„ç†çƒ­key-å‘¢" tabindex="-1"><a class="header-anchor" href="#_34-é‚£æ€ä¹ˆå¤„ç†çƒ­key-å‘¢"><span>34.é‚£æ€ä¹ˆå¤„ç†çƒ­Key å‘¢ï¼Ÿ</span></a></h3><p>æœ€æœ‰æ•ˆçš„è§£å†³æ–¹æ³•æ˜¯å¢åŠ æœ¬åœ°ç¼“å­˜ï¼Œå°†çƒ­ Key ç¼“å­˜åˆ°æœ¬åœ°å†…å­˜ä¸­ï¼Œè¿™æ ·è¯·æ±‚å°±ä¸éœ€è¦è®¿é—® Redis äº†ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-6fa972ec-5531-48f2-a608-4465d79d4518.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šçƒ­keyå¤„ç†" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šçƒ­keyå¤„ç†</figcaption></figure><p>å¯¹äºä¸€äº›ç‰¹åˆ«çƒ­çš„ Keyï¼Œå¯ä»¥å°†å…¶æ‹†åˆ†æˆå¤šä¸ªå­ Keyï¼Œç„¶åéšæœºåˆ†å¸ƒåˆ°ä¸åŒçš„ Redis èŠ‚ç‚¹ä¸Šã€‚æ¯”å¦‚å°† <code>hot_product:12345</code> æ‹†åˆ†æˆ <code>hot_product:12345:1</code>ã€<code>hot_product:12345:2</code> ç­‰å¤šä¸ªå‰¯æœ¬ï¼Œè¯»å–æ—¶éšæœºé€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250524111114.png" alt="Jerryâ€™s Notesï¼šå¤„ç†çƒ­ Key" tabindex="0" loading="lazy"><figcaption>Jerryâ€™s Notesï¼šå¤„ç†çƒ­ Key</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getHotData</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">isHotKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(key)) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // éšæœºé€‰æ‹©ä¸€ä¸ªå‰¯æœ¬</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> replica </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ThreadLocalRandom</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">current</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nextInt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(HOT_KEY_REPLICAS);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> replica);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_35-æ€ä¹ˆå¤„ç†å¤§-key-å‘¢" tabindex="-1"><a class="header-anchor" href="#_35-æ€ä¹ˆå¤„ç†å¤§-key-å‘¢"><span>35.æ€ä¹ˆå¤„ç†å¤§ Key å‘¢ï¼Ÿ</span></a></h3><p>å¤§Key æ˜¯æŒ‡å ç”¨å†…å­˜ç©ºé—´è¾ƒå¤§çš„ç¼“å­˜é”®ï¼Œæ¯”å¦‚è¶…è¿‡ 10M çš„é”®å€¼å¯¹ã€‚å¸¸è§çš„å¤§Key ç±»å‹åŒ…æ‹¬ï¼šåŒ…å«å¤§é‡å…ƒç´ çš„ Listã€Setã€Hash ç»“æ„ï¼Œå­˜å‚¨å¤§æ–‡ä»¶çš„ String ç±»å‹ï¼Œä»¥åŠåŒ…å«å¤æ‚åµŒå¥—å¯¹è±¡çš„ JSON æ•°æ®ç­‰ã€‚</p><p>åœ¨å†…å­˜æœ‰é™çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¯¼è‡´ Redis å†…å­˜ä¸è¶³ã€‚å¦å¤–ï¼Œå¤§Key è¿˜ä¼šå¯¼è‡´ä¸»ä»å¤åˆ¶åŒæ­¥å»¶è¿Ÿï¼Œç”šè‡³å¼•å‘ç½‘ç»œæ‹¥å¡ã€‚</p><p>å¯ä»¥é€šè¿‡ <code>redis-cli --bigkeys</code> å‘½ä»¤æ¥ç›‘æ§ Redis ä¸­çš„å¤§ Keyã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240309090340.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šbigkeys" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šbigkeys</figcaption></figure><p>æˆ–è€…ç¼–å†™è„šæœ¬è¿›è¡Œå…¨é‡æ‰«æï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Component</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BigKeyScanner</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> BIG_KEY_THRESHOLD </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1024</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1024</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // 1MB</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BigKeyInfo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> scanBigKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BigKeyInfo</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bigKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ArrayList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ä½¿ç”¨SCANå‘½ä»¤éå†æ‰€æœ‰é”®</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        ScanOptions</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> options</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ScanOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">scanOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Cursor</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">byte</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">[]&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cursor</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">executeWithStickyConnection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            connection </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> connection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">scan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(options)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        );</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">cursor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hasNext</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">cursor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> memory</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getKeyMemoryUsage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (memory </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> BIG_KEY_THRESHOLD) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                bigKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> BigKeyInfo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, memory, </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getKeyType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key)));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> bigKeys;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getKeyMemoryUsage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ä½¿ç”¨MEMORY USAGEå‘½ä»¤è·å–é”®çš„å†…å­˜å ç”¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RedisCallback</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) connection </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            connection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">memoryUsage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">())</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        );</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºå¤§ Key é—®é¢˜ï¼Œæœ€æ ¹æœ¬çš„è§£å†³æ–¹æ¡ˆæ˜¯æ‹†åˆ†å¤§ Keyï¼Œå°†å…¶æ‹†åˆ†æˆå¤šä¸ªå° Key å­˜å‚¨ã€‚æ¯”å¦‚å°†ä¸€ä¸ªåŒ…å«å¤§é‡ç”¨æˆ·ä¿¡æ¯çš„ Hash æ‹†åˆ†æˆå¤šä¸ªå° Hashã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e4aaafda-fce1-47f0-8b2b-7261d47b720b.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå¤§keyå¤„ç†" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå¤§keyå¤„ç†</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> splitBigKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> bigKey) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> bigData </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForHash</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(bigKey);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å°†å¤§ Key æ‹†åˆ†æˆå¤šä¸ªå° Key</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Entry</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> entry </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> bigData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">entrySet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> smallKey </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> bigKey </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> entry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(smallKey, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">entry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // åˆ é™¤åŸå§‹å¤§ Key</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">delete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(bigKey);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦å¤–ï¼Œå¯¹äº JSON æ•°æ®ï¼Œå¯ä»¥è¿›è¡Œ Gzip å‹ç¼©åå†å­˜å‚¨ï¼Œè™½ç„¶ä¼šå¢åŠ ä¸€äº› CPU å¼€é”€ï¼Œä½†åœ¨å†…å­˜æ•æ„Ÿçš„åœºæ™¯åœ¨æ˜¯å€¼å¾—çš„ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> setCompressedData</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> data) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> json </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> objectMapper</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">writeValueAsString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(data);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">        byte</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">[] compressed </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> compress</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">json</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, compressed);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Failed to compress data&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;"> byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">[] </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compress</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">[] data) throws IOException {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    ByteArrayOutputStream</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> out </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ByteArrayOutputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">GZIPOutputStream</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gzip </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GZIPOutputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(out)) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        gzip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">write</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(data);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toByteArray</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¨èé˜…è¯»ï¼š</p><ul><li><a href="https://help.aliyun.com/zh/redis/user-guide/identify-and-handle-large-keys-and-hotkeys" target="_blank" rel="noopener noreferrer">é˜¿é‡Œï¼šå‘ç°å¹¶å¤„ç† Redis çš„å¤§ Key å’Œçƒ­ Key</a></li><li><a href="https://dongzl.github.io/2021/01/14/03-Redis-Hot-Key/index.html" target="_blank" rel="noopener noreferrer">è‘£å®—ç£Šï¼šRedis çƒ­ Key å‘ç°ä»¥åŠè§£å†³åŠæ³•</a></li></ul><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åä¸º OD çš„é¢è¯•ä¸­å‡ºç°è¿‡è¯¥é¢˜ï¼šè®²ä¸€è®² Redis çš„çƒ­ Key å’Œå¤§ Key</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 24 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">çƒå‹å‘ç§ä¿¡è¯´</a>ï¼Œæ‹¿åˆ°äº†è£è€€é€šè½¯çš„å®ä¹  offerï¼Œæ­å–œä»–ï¼ğŸ‰</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250524112308.png" alt="è£è€€é€šè½¯çš„å®ä¹  offer" tabindex="0" loading="lazy"><figcaption>è£è€€é€šè½¯çš„å®ä¹  offer</figcaption></figure><h3 id="_36-ç¼“å­˜é¢„çƒ­æ€ä¹ˆåšå‘¢" tabindex="-1"><a class="header-anchor" href="#_36-ç¼“å­˜é¢„çƒ­æ€ä¹ˆåšå‘¢"><span>36.ç¼“å­˜é¢„çƒ­æ€ä¹ˆåšå‘¢ï¼Ÿ</span></a></h3><p>ç¼“å­˜é¢„çƒ­æ˜¯æŒ‡åœ¨ç³»ç»Ÿå¯åŠ¨æˆ–è€…ç‰¹å®šæ—¶é—´ç‚¹ï¼Œæå‰å°†çƒ­ç‚¹æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œé¿å…å†·å¯åŠ¨æ—¶å¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250525071018.png" alt="geeksforgeeks.orgï¼šç¼“å­˜é¢„çƒ­" tabindex="0" loading="lazy"><figcaption>geeksforgeeks.orgï¼šç¼“å­˜é¢„çƒ­</figcaption></figure><p>ç¼“å­˜é¢„çƒ­çš„æ–¹æ³•æœ‰å¤šç§ï¼Œåœ¨<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" target="_blank" rel="noopener noreferrer">æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®</a>ä¸­ï¼Œæˆ‘ä¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶å°†çƒ­é—¨æ–‡ç« æå‰åŠ è½½åˆ° Redis ä¸­ï¼Œåœ¨æ¯å¤©å‡Œæ™¨å®šæ—¶å°†æœ€æ–°çš„ç«™ç‚¹åœ°å›¾æ›´æ–°åˆ° Redisä¸­ï¼Œä»¥ç¡®ä¿ç”¨æˆ·åœ¨ç¬¬ä¸€æ¬¡è®¿é—®æ—¶å°±èƒ½è·å–åˆ°ç¼“å­˜æ•°æ®ï¼Œä»è€Œå‡è½»æ•°æ®åº“çš„å‹åŠ›ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * é‡‡ç”¨å®šæ—¶å™¨æ–¹æ¡ˆï¼Œæ¯å¤©5:15åˆ†åˆ·æ–°ç«™ç‚¹åœ°å›¾ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Scheduled</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">cron</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;0 15 5 * * ?&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> autoRefreshCache</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">info</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;å¼€å§‹åˆ·æ–°sitemap.xmlçš„urlåœ°å€ï¼Œé¿å…å‡ºç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜!&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    refreshSitemap</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">info</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;åˆ·æ–°å®Œæˆï¼&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> refreshSitemap</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    initSiteMap</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> synchronized</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> initSiteMap</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lastId </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0L</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    RedisClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">del</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(SITE_MAP_CACHE_KEY);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    while</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">SimpleArticleDTO</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> list </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> articleDao</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getBaseMapper</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">listArticlesOrderById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(lastId, SCAN_SIZE);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // åˆ·æ–°ç«™ç‚¹åœ°å›¾ä¿¡æ¯ï¼Œæ”¾åˆ° Redis å½“ä¸­</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Long</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> map </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">stream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">collect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Collectors</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">valueOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()), s </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getCreateTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), (a, b) </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a));</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        RedisClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hMSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(SITE_MAP_CACHE_KEY, map);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> SCAN_SIZE) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        lastId </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 æŠ€æœ¯äºŒé¢é¢è¯•åŸé¢˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜é¢„çƒ­ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ</li></ol></blockquote><h3 id="_37-æ— åº•æ´é—®é¢˜å¬è¯´è¿‡å—-å¦‚ä½•è§£å†³" tabindex="-1"><a class="header-anchor" href="#_37-æ— åº•æ´é—®é¢˜å¬è¯´è¿‡å—-å¦‚ä½•è§£å†³"><span>37.æ— åº•æ´é—®é¢˜å¬è¯´è¿‡å—ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ</span></a></h3><p>æ— åº•æ´é—®é¢˜çš„æ ¸å¿ƒåœ¨äºï¼Œéšç€ç¼“å­˜èŠ‚ç‚¹æ•°é‡çš„å¢åŠ ï¼Œè™½ç„¶æ€»çš„å­˜å‚¨å®¹é‡å’Œç†è®ºååé‡éƒ½åœ¨å¢é•¿ï¼Œä½†æ˜¯å•ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´åè€Œå˜é•¿äº†ã€‚</p><p>è¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ç½‘ç»œé€šä¿¡å¼€é”€çš„å¢åŠ ã€‚å½“èŠ‚ç‚¹æ•°é‡ä»å‡ åä¸ªå¢é•¿åˆ°å‡ åƒä¸ªæ—¶ï¼Œå®¢æˆ·ç«¯éœ€è¦ä¸æ›´å¤šçš„èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ã€‚</p><p>å…¶æ¬¡å°±æ˜¯æ•°æ®åˆ†å¸ƒçš„ç¢ç‰‡åŒ–ã€‚éšç€èŠ‚ç‚¹å¢å¤šï¼Œæ•°æ®åˆ†æ•£å¾—æ›´åŠ ç»†ç¢ï¼ŒåŸæœ¬å¯ä»¥åœ¨ä¸€ä¸ªèŠ‚ç‚¹è·å–çš„ç›¸å…³æ•°æ®ï¼Œç°åœ¨å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šã€‚</p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹å‡ ç§è§£å†³æ–¹æ¡ˆï¼š</p><p>ç¬¬ä¸€ï¼Œå¯ä»¥å°†åŒä¸€èŠ‚ç‚¹çš„å¤šä¸ªè¯·æ±‚åˆå¹¶æˆä¸€ä¸ªæ‰¹é‡è¯·æ±‚ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Map</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> Object</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> batchGet</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> keys) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æŒ‰èŠ‚ç‚¹åˆ†ç»„keys</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> nodeKeysMap </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> groupKeysByNode</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(keys)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> results </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ConcurrentHashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å¹¶å‘è®¿é—®å„ä¸ªèŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CompletableFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Void</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> futures </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> nodeKeysMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">entrySet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">stream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(entry </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> CompletableFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">runAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> entry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nodeKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> entry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // æ‰¹é‡è·å–è¯¥èŠ‚ç‚¹çš„æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            Map</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nodeResults</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getFromNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node, nodeKeys);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            results</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">putAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nodeResults);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">collect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Collectors</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    CompletableFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">allOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">futures</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toArray</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CompletableFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">join</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> results</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒï¼Œå¯ä»¥ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ¥ä¼˜åŒ–æ•°æ®åˆ†å¸ƒï¼Œå‡å°‘æ•°æ®è¿ç§»å’Œé‡åˆ†å¸ƒçš„å¼€é”€ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> LocalityAwareSharding</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getNodeForKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> category</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ç›¸åŒç±»åˆ«çš„æ•°æ®å°½é‡åˆ†é…åˆ°ç›¸åŒèŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> shardKey</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> category </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hashCode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SHARDS_PER_CATEGORY);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> consistentHash</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(shardKey);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç”¨æˆ·ç›¸å…³æ•°æ®å°½é‡åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getUserDataNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> userId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;user_cluster_&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">userId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hashCode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> USER_CLUSTERS);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div style="border:1px solid #096dd9;padding:20px;border-radius:15px;background-color:#f0f8ff;max-width:800px;margin:0 auto;box-shadow:0 4px 8px rgba(0, 0, 0, 0.1);"><p>å—¨å—¨å—¨ï¼Œæ—¶éš”ä¸¤å¹´ï¼Œé¢æ¸£é€†è¢­<a href="https://javabetter.cn/sidebar/sanfene/nixi.html" style="color:#096dd9;text-decoration:none;font-weight:bold;">ç¬¬äºŒç‰ˆ PDF ç»ˆäºå¯ä»¥ä¸‹è½½äº†</a>ã€‚æˆ‘ä»¬åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼š</p><ol style="margin-left:20px;"><li><strong><span style="color:#d32f2f;">å¯¹äºé«˜é¢‘é¢˜</span></strong>ï¼šä¼šæ ‡æ³¨åœ¨ã€Š<a href="https://javabetter.cn/zhishixingqiu/mianshi.html" style="color:#096dd9;">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>ä¸­å‡ºç°çš„ä½ç½®ï¼Œå“ªå®¶å…¬å¸ï¼ŒåŸé¢˜æ˜¯ä»€ä¹ˆï¼›å¦‚æœä½ æƒ³èŠ‚çœæ—¶é—´çš„è¯ï¼Œå¯ä»¥ä¼˜å…ˆèƒŒè¯µè¿™äº›é¢˜ç›®ï¼Œå°½å¿«åšåˆ°çŸ¥å½¼çŸ¥å·±ï¼Œç™¾æˆ˜ä¸æ®†ã€‚</li><li><strong><span style="color:#d32f2f;">ç»“åˆé¡¹ç›®</span></strong>ï¼šåŒ…æ‹¬<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" style="color:#096dd9;">æŠ€æœ¯æ´¾</a>ã€<a href="https://t.zsxq.com/0bhcI0Gs6" style="color:#096dd9;">mydb</a>ã€<a href="https://javabetter.cn/zhishixingqiu/pmhub.html" style="color:#096dd9;">pmhub</a>æ¥ç»„ç»‡è¯­è¨€ï¼Œè®©é¢è¯•å®˜æœ€å¤§ç¨‹åº¦æ„Ÿå—åˆ°ä½ çš„è¯šæ„ï¼Œè€Œä¸æ˜¯æœºæ¢°åŒ–çš„èƒŒè¯µã€‚</li><li><strong><span style="color:#d32f2f;">ä¿®å¤é—®é¢˜</span></strong>ï¼šç¬¬ä¸€ç‰ˆä¸­å‡ºç°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬çƒå‹ä»¬çš„ç§ä¿¡åé¦ˆï¼Œç½‘ç«™ç•™è¨€åŒºçš„è¯„è®ºï¼Œä»¥åŠ<a href="https://github.com/itwanger/toBeBetterJavaer/issues" style="color:#096dd9;"> GitHub ä»“åº“ä¸­çš„ issue</a>ï¼Œè®©è¿™ä»½é¢è¯•æŒ‡å—æ›´åŠ å®Œå–„ã€‚</li><li><strong><span style="color:#d32f2f;">ä¼˜åŒ–æ’ç‰ˆ</span></strong>ï¼šå¢åŠ æ‰‹ç»˜å›¾ï¼Œé‡æ–°ç»„ç»‡ç­”æ¡ˆï¼Œä½¿å…¶æ›´åŠ å£è¯­åŒ–ï¼Œä»è€Œæ›´è´´è¿‘é¢è¯•å®˜çš„é¢„æœŸã€‚</li></ol><p>ä½ å¯ä»¥æ‰«ä¸‹é¢çš„äºŒç»´ç ï¼ˆæˆ–è€…é•¿æŒ‰è‡ªåŠ¨è¯†åˆ«ï¼‰å…³æ³¨ã€<b>æ²‰é»˜ç‹äºŒ</b>ã€‘å…¬ä¼—å·ï¼Œå‘é€å…³é”®å­— <b>222</b> æ¥è·å– PDF ç‰ˆæœ¬ï¼Œå¦‚æœé¢æ¸£é€†è¢­çœŸçš„å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¸Œæœ›èƒ½ç»™äºŒå“¥çš„å…¬ä¼—å·åŠ ä¸€ä¸ªæ˜Ÿæ ‡ï¼Œæ»¡è¶³æˆ‘é‚£ä¸€ä¸ç‚¹è™šè£å¿ƒï¼Œè¿™å°†æ˜¯æˆ‘æ›´æ–°ä¸‹å»çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p><div style="text-align:center;margin:20px 0;"><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width:100%;height:auto;border-radius:10px;"></div><p>é¢æ¸£é€†è¢­çš„æ•´ç†å·¥ä½œçœŸçš„å¤ªä¸å®¹æ˜“äº†ï¼ŒèŠ±äº†æˆ‘å¥½å¤šå¥½å¤šçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œå†…å®¹å®Œå…¨å…è´¹ï¼Œä½†è´¨é‡å´æœ‰å£çš†ç¢‘ï¼Œå°±æ˜¯ä¸ºäº†åšä¸€ç‚¹çœŸæ­£æœ‰æ„ä¹‰çš„ã€çº¯ç²¹çš„äº‹æƒ…ã€‚</p></div><h2 id="redis-è¿ç»´" tabindex="-1"><a class="header-anchor" href="#redis-è¿ç»´"><span>Redis è¿ç»´</span></a></h2><h3 id="_38-redis-æŠ¥å†…å­˜ä¸è¶³æ€ä¹ˆå¤„ç†" tabindex="-1"><a class="header-anchor" href="#_38-redis-æŠ¥å†…å­˜ä¸è¶³æ€ä¹ˆå¤„ç†"><span>38.Redis æŠ¥å†…å­˜ä¸è¶³æ€ä¹ˆå¤„ç†ï¼Ÿ</span></a></h3><p>Redis æŠ¥å†…å­˜ä¸è¶³æ—¶ï¼Œé€šå¸¸æ˜¯å› ä¸º Redis å ç”¨çš„ç‰©ç†å†…å­˜å·²ç»æ¥è¿‘æˆ–è€…è¶…è¿‡äº†é…ç½®çš„æœ€å¤§å†…å­˜é™åˆ¶ã€‚è¿™æ—¶å¯ä»¥é‡‡å–ä»¥ä¸‹å‡ ç§æ­¥éª¤æ¥å¤„ç†ï¼š</p><p>ç¬¬ä¸€ï¼Œä½¿ç”¨ <code>INFO memory</code> å‘½ä»¤æŸ¥çœ‹ Redis çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œçœ‹çœ‹æ˜¯å¦çœŸçš„è¾¾åˆ°äº†æœ€å¤§å†…å­˜é™åˆ¶ã€‚</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> INFO</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> memory</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250525074224.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šINFO memory" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šINFO memory</figcaption></figure><p>ç¬¬äºŒï¼Œå¦‚æœæœåŠ¡å™¨è¿˜æœ‰å¯ç”¨å†…å­˜çš„è¯ï¼Œä¿®æ”¹ <code>redis.conf</code> ä¸­çš„ <code>maxmemory</code> å‚æ•°ï¼Œå¢åŠ  Redis çš„æœ€å¤§å†…å­˜é™åˆ¶ã€‚æ¯”å¦‚å°†æœ€å¤§å†…å­˜è®¾ç½®ä¸º 8GBï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">maxmemory</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 8gb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ç¬¬ä¸‰ï¼Œä¿®æ”¹ <code>maxmemory-policy</code> å‚æ•°æ¥è°ƒæ•´å†…å­˜æ·˜æ±°ç­–ç•¥ã€‚æ¯”å¦‚å¯ä»¥é€‰æ‹© <code>allkeys-lru</code> ç­–ç•¥ï¼Œè®© Redis è‡ªåŠ¨åˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é”®ã€‚</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">maxmemory-policy</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> allkeys-lru</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>memoï¼š2025 å¹´ 5 æœˆ 25 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">çƒå‹ç®€å†</a>æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªè¥¿å®‰äº¤é€šå¤§å­¦æœ¬ã€ä¸Šæµ·äº¤é€šå¤§å­¦ç¡•çš„çƒå‹ï¼Œ985 æœ¬ç¡•å­¦å†çœŸçš„éå¸¸é¡¶äº†ï¼Œæˆ‘ä¼šç«­å°½æ‰€èƒ½å»å¸®åŠ©ä»–ï¼Œåœ¨ç§‹æ‹›ä¸­æ–©è·ä¸€ä¸ª SSP offerï¼Œå†²ï¼</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250525075244.png" alt="è¥¿å®‰äº¤é€šå¤§å­¦æœ¬ã€ä¸Šæµ·äº¤é€šå¤§å­¦ç¡•" tabindex="0" loading="lazy"><figcaption>è¥¿å®‰äº¤é€šå¤§å­¦æœ¬ã€ä¸Šæµ·äº¤é€šå¤§å­¦ç¡•</figcaption></figure><h3 id="_39-redis-keyè¿‡æœŸç­–ç•¥æœ‰å“ªäº›" tabindex="-1"><a class="header-anchor" href="#_39-redis-keyè¿‡æœŸç­–ç•¥æœ‰å“ªäº›"><span>39.Redis keyè¿‡æœŸç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</span></a></h3><p>Redis ä¸»è¦é‡‡ç”¨äº†ä¸¤ç§è¿‡æœŸåˆ é™¤ç­–ç•¥æ¥ä¿è¯è¿‡æœŸçš„ key èƒ½å¤Ÿè¢«åŠæ—¶åˆ é™¤ï¼ŒåŒ…æ‹¬æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240326214119.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis çš„è¿‡æœŸæ·˜æ±°ç­–ç•¥" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis çš„è¿‡æœŸæ·˜æ±°ç­–ç•¥</figcaption></figure><p>æƒ°æ€§åˆ é™¤æ˜¯æœ€åŸºæœ¬çš„ç­–ç•¥ï¼Œå½“å®¢æˆ·ç«¯è®¿é—®ä¸€ä¸ª key æ—¶ï¼ŒRedis ä¼šæ£€æŸ¥è¯¥ key æ˜¯å¦å·²è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±ä¼šç«‹å³åˆ é™¤å¹¶è¿”å› nilã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ¨¡æ‹Ÿæƒ°æ€§åˆ é™¤çš„é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> get</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    RedisKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisKey </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getKeyFromMemory</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(key)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (redisKey </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> isExpired</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(redisKey)) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // keyå·²è¿‡æœŸï¼Œåˆ é™¤å¹¶è¿”å›null</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        deleteKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(key)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> redisKey </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ?</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§ç­–ç•¥çš„ä¼˜ç‚¹æ˜¯ä¸ä¼šæœ‰é¢å¤–çš„ CPU å¼€é”€ï¼Œåªåœ¨è®¿é—® key æ—¶æ‰æ£€æŸ¥ã€‚ä½†é—®é¢˜æ˜¯å¦‚æœä¸€ä¸ªè¿‡æœŸçš„ key æ°¸è¿œä¸è¢«è®¿é—®ï¼Œå®ƒå°±ä¼šä¸€ç›´å ç”¨å†…å­˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250527111551.png" alt="javaæŠ€æœ¯å°é¦†ï¼škey è¿‡æœŸç­–ç•¥" tabindex="0" loading="lazy"><figcaption>javaæŠ€æœ¯å°é¦†ï¼škey è¿‡æœŸç­–ç•¥</figcaption></figure><p>äºæ˜¯å°±æœ‰äº†å®šæœŸåˆ é™¤ç­–ç•¥ï¼ŒRedis ä¼šå®šæœŸéšæœºé€‰æ‹©ä¸€äº›è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key è¿›è¡Œæ£€æŸ¥ï¼Œåˆ é™¤å…¶ä¸­å·²è¿‡æœŸçš„ keyã€‚è¿™ä¸ªè¿‡ç¨‹é»˜è®¤æ¯ç§’æ‰§è¡Œ 10 æ¬¡ï¼Œæ¯æ¬¡éšæœºé€‰æ‹© 20 ä¸ª key è¿›è¡Œæ£€æŸ¥ã€‚</p><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒ start----</p><p>å¯ä»¥é€šè¿‡ <code>config get hz</code> å‘½ä»¤æŸ¥çœ‹ Redis å†…éƒ¨å®šæ—¶ä»»åŠ¡çš„é¢‘ç‡ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240326214800.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šconfig get hz" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šconfig get hz</figcaption></figure><p>hz çš„å€¼ä¸ºâ€œ10â€æ„å‘³ç€ Redis æ¯ç§’æ‰§è¡Œ 10 æ¬¡å®šæ—¶ä»»åŠ¡ ã€‚å¯ä»¥é€šè¿‡ <code>CONFIG SET hz 20</code> è¿›è¡Œè°ƒæ•´ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240326215240.png" alt="äºŒå“¥æœ¬åœ° Redis çš„é…ç½®æ–‡ä»¶è·¯å¾„å’Œ hz çš„é»˜è®¤å€¼" tabindex="0" loading="lazy"><figcaption>äºŒå“¥æœ¬åœ° Redis çš„é…ç½®æ–‡ä»¶è·¯å¾„å’Œ hz çš„é»˜è®¤å€¼</figcaption></figure><p>----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒ end----</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 22 æš‘æœŸå®ä¹ ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis key åˆ é™¤ç­–ç•¥</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å»å“ªå„¿é¢ç»åŒå­¦ 1 æŠ€æœ¯ 2 é¢é¢è¯•åŸé¢˜ï¼šredis å†…å­˜æ·˜æ±°å’Œè¿‡æœŸç­–ç•¥</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 5 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šredis keyè¿‡æœŸç­–ç•¥</li></ol></blockquote><h3 id="_40-ğŸŒŸredisæœ‰å“ªäº›å†…å­˜æ·˜æ±°ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#_40-ğŸŒŸredisæœ‰å“ªäº›å†…å­˜æ·˜æ±°ç­–ç•¥"><span>40.ğŸŒŸRedisæœ‰å“ªäº›å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Ÿ</span></a></h3><p>å½“å†…å­˜ä½¿ç”¨æ¥è¿‘ maxmemory é™åˆ¶æ—¶ï¼ŒRedis ä¼šä¾æ®å†…å­˜æ·˜æ±°ç­–ç•¥æ¥å†³å®šåˆ é™¤å“ªäº› key ä»¥ç¼“è§£å†…å­˜å‹åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250527115004.png" alt="ç å“¥å­—èŠ‚ï¼šå†…å­˜æ·˜æ±°ç­–ç•¥" tabindex="0" loading="lazy"><figcaption>ç å“¥å­—èŠ‚ï¼šå†…å­˜æ·˜æ±°ç­–ç•¥</figcaption></figure><p>å¸¸ç”¨çš„å†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å…«ç§ï¼Œåˆ†åˆ«æ˜¯é»˜è®¤çš„ noevictionï¼Œå†…å­˜ä¸è¶³æ—¶ä¸ä¼šåˆ é™¤ä»»ä½• keyï¼Œç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹åŸºæœ¬ä¸Šä¸ä¼šä½¿ç”¨ã€‚</p><p>ç„¶åæ˜¯é’ˆå¯¹æ‰€æœ‰ key çš„ allkeys-lruã€allkeys-lfu å’Œ allkeys-randomã€‚lru ä¼šåˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyï¼Œåœ¨çº¯ç¼“å­˜åœºæ™¯ä¸­æœ€å¸¸ç”¨ï¼Œèƒ½è‡ªåŠ¨ä¿ç•™çƒ­ç‚¹æ•°æ®ï¼›lfu ä¼šåˆ é™¤è®¿é—®é¢‘ç‡æœ€ä½çš„ keyï¼Œæ›´é€‚åˆé•¿æœŸè¿è¡Œçš„ç³»ç»Ÿï¼›random ä¼šéšæœºåˆ é™¤ä¸€äº› keyï¼Œä¸€èˆ¬ä¸æ¨èä½¿ç”¨ã€‚</p><p>å…¶æ¬¡æ˜¯é’ˆå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ keyï¼Œæœ‰ volatile-lruã€volatile-lfuã€volatile-ttl å’Œ volatile-randomã€‚</p><p>lru åœ¨æ··åˆå­˜å‚¨åœºæ™¯ä¸­ç»å¸¸ä½¿ç”¨ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Service</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> HybridStorageService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // é‡è¦æ•°æ®ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¸´æ—¶æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> storeData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">DataImportance</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> importance</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (importance </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> DataImportance</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">HIGH</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // é‡è¦æ•°æ®ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œåœ¨volatile-*ç­–ç•¥ä¸‹ä¸ä¼šè¢«æ·˜æ±°</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, data);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // ä¸´æ—¶æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¯ä»¥è¢«volatile-*ç­–ç•¥æ·˜æ±°</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, data, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Duration</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ofHours</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>lfu é€‚åˆéœ€è¦ä¿æŠ¤æŸäº›é‡è¦æ•°æ®ä¸è¢«æ·˜æ±°çš„åœºæ™¯ï¼›ttl ä¼˜å…ˆåˆ é™¤å³å°†è¿‡æœŸçš„ keyï¼Œåœ¨ç”¨æˆ·ä¼šè¯ç®¡ç†ç³»ç»Ÿä¸­æ¨èä½¿ç”¨ï¼›random ä»ç„¶å¾ˆå°‘ç”¨ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆ redis å¿«ï¼Œæ·˜æ±°ç­–ç•¥ æŒä¹…åŒ–</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å»å“ªå„¿é¢ç»åŒå­¦ 1 æŠ€æœ¯ 2 é¢é¢è¯•åŸé¢˜ï¼šredis å†…å­˜æ·˜æ±°å’Œè¿‡æœŸç­–ç•¥</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ä½œä¸šå¸®é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šrediså†…å­˜æ·˜æ±°ç­–ç•¥</li></ol></blockquote><h3 id="_41-lru-å’Œ-lfu-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_41-lru-å’Œ-lfu-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"><span>41.LRU å’Œ LFU çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><p>LRU æ˜¯ Least Recently Used çš„ç¼©å†™ï¼ŒåŸºäºæ—¶é—´ç»´åº¦ï¼Œæ·˜æ±°æœ€è¿‘æœ€å°‘è®¿é—®çš„é”®ã€‚</p><p>LFU æ˜¯ Least Frequently Used çš„ç¼©å†™ï¼ŒåŸºäºæ¬¡æ•°ç»´åº¦ï¼Œæ·˜æ±°è®¿é—®é¢‘ç‡æœ€ä½çš„é”®ã€‚</p><p>å‡è®¾ç¼“å­˜ä¸­æœ‰ä¸‰ä¸ªæ•°æ® Aã€Bã€Cï¼Œåœ¨ LRU åœºæ™¯ä¸‹ï¼Œå¦‚æœè®¿é—®é¡ºåºæ˜¯ Aâ†’Bâ†’Câ†’Aï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ LRU é¡ºåºæ˜¯Bâ†’Câ†’Aï¼Œå¦‚æœéœ€è¦æ·˜æ±°ï¼Œä¼šå…ˆåˆ é™¤ Bã€‚</p><p>ä½†åœ¨ LFU åœºæ™¯ä¸‹ï¼Œå¦‚æœ A è¢«è®¿é—®äº† 5 æ¬¡ï¼ŒB è¢«è®¿é—®äº† 2 æ¬¡ï¼ŒC è¢«è®¿é—®äº† 1 æ¬¡ï¼Œé‚£ä¹ˆæ— è®ºæœ€è¿‘çš„è®¿é—®é¡ºåºå¦‚ä½•ï¼Œéƒ½ä¼šä¼˜å…ˆæ·˜æ±° Cï¼Œå› ä¸ºå®ƒçš„è®¿é—®é¢‘ç‡æœ€ä½ã€‚</p><p>LRU æ›´é€‚åˆæœ‰æ˜æ˜¾æ—¶é—´å±€éƒ¨æ€§çš„åœºæ™¯ï¼Œæ¯”å¦‚åœ¨æ–°é—»ç½‘ç«™ä¸­ï¼Œç”¨æˆ·æ›´å…³å¿ƒæœ€æ–°çš„æ–°é—»ï¼Œè€Œæ˜¨å¤©çš„æ–°é—»è®¿é—®é‡ä¼šæ€¥å‰§ä¸‹é™ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒLRU èƒ½å¾ˆå¥½åœ°ä¿ç•™ç”¨æˆ·å½“å‰å…³å¿ƒçš„çƒ­ç‚¹å†…å®¹ã€‚</p><p>LFU åˆ™æ›´é€‚åˆæœ‰é•¿æœŸè®¿é—®æ¨¡å¼çš„åœºæ™¯ï¼Œæ›´å¼ºè°ƒâ€œçƒ­åº¦â€ï¼Œæ¯”å¦‚åœ¨ç”µå•†å¹³å°ä¸­ï¼ŒæŸäº›å•†å“å¯èƒ½é•¿æœŸä¿æŒçƒ­é”€çŠ¶æ€ï¼Œå³ä½¿å®ƒä»¬çš„è®¿é—®æ—¶é—´é—´éš”è¾ƒé•¿ï¼Œä½†ç”±äºè®¿é—®é¢‘ç‡é«˜ï¼ŒLFU ä¼šä¼˜å…ˆä¿ç•™è¿™äº›å•†å“çš„ä¿¡æ¯ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„é˜¿é‡Œç³»é¢ç»åŒå­¦ 19 é¥¿äº†ä¹ˆé¢è¯•åŸé¢˜ï¼šrediså†…å­˜æ·˜æ±°æœºåˆ¶ å»¶ä¼¸åˆ°LRU LFU</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 27 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">çƒå‹å‘ç§ä¿¡è¯´</a>ï¼Œæ‹¿åˆ°äº†å“ˆå•°å’Œå¾—ç‰©çš„å®ä¹  offerï¼Œæ­å–œä»–ï¼ğŸ‰ è¿˜ç‰¹æ„æ„Ÿè°¢äº†ä¸€ä¸‹ä¹‹å‰å¯¹ä»–ç®€å†çš„ä¿®æ”¹å’Œå­¦ä¹ ä¸Šçš„å»ºè®®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250527120727.png" alt="çƒå‹æ‹¿åˆ°äº†å¾—ç‰©å’Œå“ˆå•°çš„ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†å¾—ç‰©å’Œå“ˆå•°çš„ offer</figcaption></figure><h3 id="_42-rediså‘ç”Ÿé˜»å¡äº†æ€ä¹ˆè§£å†³" tabindex="-1"><a class="header-anchor" href="#_42-rediså‘ç”Ÿé˜»å¡äº†æ€ä¹ˆè§£å†³"><span>42.Rediså‘ç”Ÿé˜»å¡äº†æ€ä¹ˆè§£å†³ï¼Ÿ</span></a></h3><p>Redis å‘ç”Ÿé˜»å¡åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯æ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼Œå½“å‘ç° Redis å˜æ…¢æ—¶ï¼Œæˆ‘ä¼šå…ˆé€šè¿‡ monitor å‘½ä»¤æŸ¥çœ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤ï¼Œæˆ–è€…ä½¿ç”¨ slowlog å‘½ä»¤æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># æŸ¥çœ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> MONITOR</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> SLOWLOG</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> GET</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># æ£€æŸ¥å®¢æˆ·ç«¯è¿æ¥çŠ¶å†µ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> CLIENT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> LIST</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå¤§Key æ˜¯å¯¼è‡´ Redis é˜»å¡çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚æ¯”å¦‚è¯´ç›´æ¥ DEL ä¸€ä¸ªåŒ…å«å‡ ç™¾ä¸‡ä¸ªå…ƒç´ çš„ Setï¼Œå°±ä¼šå¯¼è‡´ Redis é˜»å¡å‡ ç§’é’Ÿç”šè‡³æ›´ä¹…ã€‚</p><p>è¿™æ—¶å€™å¯ä»¥ç”¨ UNLINK å‘½ä»¤æ›¿ä»£ DEL æ¥å¼‚æ­¥åˆ é™¤ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># ä½¿ç”¨ UNLINK å¼‚æ­¥åˆ é™¤å¤§ Key</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-cli</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UNLINK</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> big_key</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºéå¸¸å¤§çš„é›†åˆï¼Œå¯ä»¥ä½¿ç”¨ SCAN å‘½ä»¤åˆ†æ‰¹åˆ é™¤ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> safeBatchProcess</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> key) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    ScanOptions</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> options </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ScanOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">scanOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    Cursor</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cursor </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">scan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, options);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    while</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">cursor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hasNext</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> member </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cursor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…é˜»å¡</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        processElement</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(member)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦å¤–ï¼Œå½“ Redis ä½¿ç”¨çš„å†…å­˜è¶…è¿‡ç‰©ç†å†…å­˜æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†éƒ¨åˆ†å†…å­˜äº¤æ¢åˆ°ç£ç›˜ï¼Œè¿™æ—¶å€™ä¼šå¯¼è‡´ Redis å“åº”å˜æ…¢ã€‚æˆ‘çš„å¤„ç†æ–¹å¼æ˜¯ï¼š</p><p>ä½¿ç”¨ <code>free -h</code> æ£€æŸ¥å†…å­˜çš„ä½¿ç”¨æƒ…å†µ ï¼›ç¡®è®¤ Redis çš„ maxmemory è®¾ç½®æ˜¯å¦åˆç†ï¼›å¦‚æœå‘ç”Ÿäº†å†…å­˜äº¤æ¢ï¼Œç«‹å³è°ƒæ•´ maxmemory å¹¶æ¸…ç†ä¸€äº›ä¸é‡è¦çš„æ•°æ®ã€‚</p><p>å¤§é‡çš„å®¢æˆ·ç«¯è¿æ¥ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´é˜»å¡ï¼Œè¿™æ—¶å€™æœ€å¥½æ£€æŸ¥ä¸€ä¸‹è¿æ¥æ± çš„é…ç½®ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Configuration</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisConnectionConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Bean</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> JedisConnectionFactory</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> jedisConnectionFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        JedisPoolConfig</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> poolConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> JedisPoolConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        poolConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setMaxTotal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">200</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);        </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æœ€å¤§è¿æ¥æ•°</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        poolConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setMaxIdle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);          </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æœ€å¤§ç©ºé—²è¿æ¥</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        poolConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setMinIdle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);          </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æœ€å°ç©ºé—²è¿æ¥</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        poolConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setMaxWaitMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);  </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è·å–è¿æ¥æœ€å¤§ç­‰å¾…æ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        poolConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setTestOnBorrow</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);   </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è·å–è¿æ¥æ—¶æ£€æµ‹æœ‰æ•ˆæ€§</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> JedisConnectionFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(poolConfig);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div style="border:1px solid #096dd9;padding:20px;border-radius:15px;background-color:#f0f8ff;max-width:800px;margin:0 auto;box-shadow:0 4px 8px rgba(0, 0, 0, 0.1);"><p>å—¨å—¨å—¨ï¼Œæ—¶éš”ä¸¤å¹´ï¼Œé¢æ¸£é€†è¢­<a href="https://javabetter.cn/sidebar/sanfene/nixi.html" style="color:#096dd9;text-decoration:none;font-weight:bold;">ç¬¬äºŒç‰ˆ PDF ç»ˆäºå¯ä»¥ä¸‹è½½äº†</a>ã€‚æˆ‘ä»¬åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼š</p><ol style="margin-left:20px;"><li><strong><span style="color:#d32f2f;">å¯¹äºé«˜é¢‘é¢˜</span></strong>ï¼šä¼šæ ‡æ³¨åœ¨ã€Š<a href="https://javabetter.cn/zhishixingqiu/mianshi.html" style="color:#096dd9;">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>ä¸­å‡ºç°çš„ä½ç½®ï¼Œå“ªå®¶å…¬å¸ï¼ŒåŸé¢˜æ˜¯ä»€ä¹ˆï¼›å¦‚æœä½ æƒ³èŠ‚çœæ—¶é—´çš„è¯ï¼Œå¯ä»¥ä¼˜å…ˆèƒŒè¯µè¿™äº›é¢˜ç›®ï¼Œå°½å¿«åšåˆ°çŸ¥å½¼çŸ¥å·±ï¼Œç™¾æˆ˜ä¸æ®†ã€‚</li><li><strong><span style="color:#d32f2f;">ç»“åˆé¡¹ç›®</span></strong>ï¼šåŒ…æ‹¬<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" style="color:#096dd9;">æŠ€æœ¯æ´¾</a>ã€<a href="https://t.zsxq.com/0bhcI0Gs6" style="color:#096dd9;">mydb</a>ã€<a href="https://javabetter.cn/zhishixingqiu/pmhub.html" style="color:#096dd9;">pmhub</a>æ¥ç»„ç»‡è¯­è¨€ï¼Œè®©é¢è¯•å®˜æœ€å¤§ç¨‹åº¦æ„Ÿå—åˆ°ä½ çš„è¯šæ„ï¼Œè€Œä¸æ˜¯æœºæ¢°åŒ–çš„èƒŒè¯µã€‚</li><li><strong><span style="color:#d32f2f;">ä¿®å¤é—®é¢˜</span></strong>ï¼šç¬¬ä¸€ç‰ˆä¸­å‡ºç°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬çƒå‹ä»¬çš„ç§ä¿¡åé¦ˆï¼Œç½‘ç«™ç•™è¨€åŒºçš„è¯„è®ºï¼Œä»¥åŠ<a href="https://github.com/itwanger/toBeBetterJavaer/issues" style="color:#096dd9;"> GitHub ä»“åº“ä¸­çš„ issue</a>ï¼Œè®©è¿™ä»½é¢è¯•æŒ‡å—æ›´åŠ å®Œå–„ã€‚</li><li><strong><span style="color:#d32f2f;">ä¼˜åŒ–æ’ç‰ˆ</span></strong>ï¼šå¢åŠ æ‰‹ç»˜å›¾ï¼Œé‡æ–°ç»„ç»‡ç­”æ¡ˆï¼Œä½¿å…¶æ›´åŠ å£è¯­åŒ–ï¼Œä»è€Œæ›´è´´è¿‘é¢è¯•å®˜çš„é¢„æœŸã€‚</li></ol><p>ä½ å¯ä»¥æ‰«ä¸‹é¢çš„äºŒç»´ç ï¼ˆæˆ–è€…é•¿æŒ‰è‡ªåŠ¨è¯†åˆ«ï¼‰å…³æ³¨ã€<b>æ²‰é»˜ç‹äºŒ</b>ã€‘å…¬ä¼—å·ï¼Œå‘é€å…³é”®å­— <b>222</b> æ¥è·å– PDF ç‰ˆæœ¬ï¼Œå¦‚æœé¢æ¸£é€†è¢­çœŸçš„å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¸Œæœ›èƒ½ç»™äºŒå“¥çš„å…¬ä¼—å·åŠ ä¸€ä¸ªæ˜Ÿæ ‡ï¼Œæ»¡è¶³æˆ‘é‚£ä¸€ä¸ç‚¹è™šè£å¿ƒï¼Œè¿™å°†æ˜¯æˆ‘æ›´æ–°ä¸‹å»çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p><div style="text-align:center;margin:20px 0;"><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width:100%;height:auto;border-radius:10px;"></div><p>é¢æ¸£é€†è¢­çš„æ•´ç†å·¥ä½œçœŸçš„å¤ªä¸å®¹æ˜“äº†ï¼ŒèŠ±äº†æˆ‘å¥½å¤šå¥½å¤šçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œå†…å®¹å®Œå…¨å…è´¹ï¼Œä½†è´¨é‡å´æœ‰å£çš†ç¢‘ï¼Œå°±æ˜¯ä¸ºäº†åšä¸€ç‚¹çœŸæ­£æœ‰æ„ä¹‰çš„ã€çº¯ç²¹çš„äº‹æƒ…ã€‚</p></div><h2 id="redis-åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#redis-åº”ç”¨"><span>Redis åº”ç”¨</span></a></h2><h3 id="_43-rediså¦‚ä½•å®ç°å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#_43-rediså¦‚ä½•å®ç°å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—"><span>43.Rediså¦‚ä½•å®ç°å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ</span></a></h3><p>Redis å®ç°å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå¾ˆå®ç”¨çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œæœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ List é…åˆ LPUSH å’Œ RPOP å‘½ä»¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e4b192a1-3ba7-4f4e-98de-e93f437cff7c.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šlistä½œä¸ºé˜Ÿåˆ—" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šlistä½œä¸ºé˜Ÿåˆ—</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Service</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> SimpleRedisQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ç”Ÿäº§è€…ï¼šå‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sendMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> queueName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">leftPush</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(queueName, message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ¶ˆè´¹è€…ï¼šä»é˜Ÿåˆ—è·å–æ¶ˆæ¯</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> receiveMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> queueName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rightPop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(queueName);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // é˜»å¡å¼æ¶ˆè´¹ï¼Œé¿å…è½®è¯¢</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> blockingReceive</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> queueName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> timeoutSeconds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">result</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rightPop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(queueName, timeoutSeconds, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">isEmpty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦å¤–å°±æ˜¯ç”¨ Redis çš„ Pub/Sub æ¥å®ç°ç®€å•çš„æ¶ˆæ¯å¹¿æ’­å’Œè®¢é˜…ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Service</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisPubSubService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å‘å¸ƒæ¶ˆæ¯åˆ°æŒ‡å®šé¢‘é“</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> publish</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> channel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">convertAndSend</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(channel, message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // è®¢é˜…é¢‘é“</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">PostConstruct</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> subscribe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setMessageListener</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((message, pattern) </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Received message: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        });</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getConnectionFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getConnection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">subscribe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ChannelTopic</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;myChannel&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getTopic</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        );</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‘å¸ƒè€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°æŒ‡å®šçš„é¢‘é“ï¼Œè®¢é˜…è¯¥é¢‘é“çš„å®¢æˆ·ç«¯å°±èƒ½æ”¶åˆ°æ¶ˆæ¯ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-bc6d05be-3701-4e23-b4ca-6330c949f020.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼špub/sub" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼špub/sub</figcaption></figure><p>ä½†æ˜¯è¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯ä¸å¯é çš„ï¼Œå› ä¸ºæ²¡æœ‰ ACK æœºåˆ¶æ‰€ä»¥ä¸èƒ½ä¿è¯è®¢é˜…è€…ä¸€å®šèƒ½æ”¶åˆ°æ¶ˆæ¯ï¼Œä¹Ÿä¸æ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ã€‚</p><h3 id="_44-rediså¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#_44-rediså¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—"><span>44.Rediså¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—?</span></a></h3><p>å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—åœ¨å®é™…ä¸šåŠ¡ä¸­å¾ˆå¸¸è§ï¼Œæ¯”å¦‚è®¢å•è¶…æ—¶å–æ¶ˆã€å®šæ—¶æé†’ç­‰åœºæ™¯ã€‚Redis è™½ç„¶ä¸æ˜¯ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†å¯ä»¥å¾ˆå¥½åœ°å®ç°å»¶æ—¶é˜Ÿåˆ—åŠŸèƒ½ã€‚</p><p>æ ¸å¿ƒæ€è·¯æ˜¯åˆ©ç”¨ ZSet çš„æœ‰åºç‰¹æ€§ï¼Œå°†æ¶ˆæ¯ä½œä¸º memberï¼ŒæŠŠæ¶ˆæ¯çš„æ‰§è¡Œæ—¶é—´ä½œä¸º scoreã€‚è¿™æ ·æ¶ˆæ¯å°±ä¼šæŒ‰ç…§æ‰§è¡Œæ—¶é—´è‡ªåŠ¨æ’åºï¼Œæˆ‘ä»¬åªéœ€è¦å®šæœŸæ‰«æå½“å‰æ—¶é—´ä¹‹å‰çš„æ¶ˆæ¯è¿›è¡Œå¤„ç†å°±å¯ä»¥äº†ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-54bbcc36-0b00-4142-a6eb-bf2ef48c2213.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šzsetå®ç°å»¶æ—¶é˜Ÿåˆ—" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šzsetå®ç°å»¶æ—¶é˜Ÿåˆ—</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Service</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DelayedMessageQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å‘é€å»¶æ—¶æ¶ˆæ¯</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> sendDelayedMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> queueName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> delaySeconds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // è®¡ç®—æ¶ˆæ¯çš„æ‰§è¡Œæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> executeTime</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentTimeMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (delaySeconds </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å°†æ¶ˆæ¯åŠ å…¥ZSetï¼Œä»¥æ‰§è¡Œæ—¶é—´ä½œä¸ºscore</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForZSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(queueName, message, executeTime);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">info</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;å‘é€å»¶æ—¶æ¶ˆæ¯: {}, å»¶æ—¶: {}ç§’&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, message, delaySeconds);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ¶ˆè´¹å»¶æ—¶æ¶ˆæ¯</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Scheduled</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">fixedDelay</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ¯ç§’æ‰«æä¸€æ¬¡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> consumeDelayedMessages</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> queueName</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;delayed:queue&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> currentTime</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentTimeMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // è·å–å·²åˆ°æœŸçš„æ¶ˆæ¯ï¼ˆscore &lt;= å½“å‰æ—¶é—´ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Set</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">messages</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForZSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rangeByScore</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(queueName, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, currentTime);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> message</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> messages) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // å¤„ç†æ¶ˆæ¯</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                processMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // å¤„ç†æˆåŠŸåä»é˜Ÿåˆ—ä¸­ç§»é™¤</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForZSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">remove</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(queueName, message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">info</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;å¤„ç†å»¶æ—¶æ¶ˆæ¯æˆåŠŸ: {}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;å¤„ç†å»¶æ—¶æ¶ˆæ¯å¤±è´¥: {}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, message, e);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // å¯ä»¥å®ç°é‡è¯•æœºåˆ¶</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                handleFailedMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(queueName, message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…·ä½“å®ç°ä¸Šï¼Œæˆ‘ä¼šåœ¨ç”Ÿäº§è€…å‘é€å»¶æ—¶æ¶ˆæ¯æ—¶ï¼Œè®¡ç®—æ¶ˆæ¯åº”è¯¥æ‰§è¡Œçš„æ—¶é—´æˆ³ï¼Œç„¶åç”¨ ZADD å‘½ä»¤å°†æ¶ˆæ¯æ·»åŠ åˆ° ZSet ä¸­ã€‚</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ZADD</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> delay_queue</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1617024000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> task1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ¶ˆè´¹è€…é€šè¿‡å®šæ—¶ä»»åŠ¡ï¼Œä½¿ç”¨ ZRANGEBYSCORE å‘½ä»¤è·å–å½“å‰æ—¶é—´ä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯ã€‚</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ZREMRANGEBYSCORE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> delay_queue</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -inf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1617024000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å¤„ç†å®Œæˆåå†ç”¨ ZREM åˆ é™¤æ¶ˆæ¯ã€‚</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ZREM</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> delay_queue</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> task1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>åœ¨<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" target="_blank" rel="noopener noreferrer">æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®</a>ä¸­ï¼Œæˆ‘å°±ç”¨è¿™ç§æ–¹å¼å®ç°äº†æ–‡ç« å®šæ—¶å‘å¸ƒçš„åŠŸèƒ½ã€‚ä½œè€…åœ¨å‘å¸ƒæ–‡ç« æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªæœªæ¥çš„æ—¶é—´èŠ‚ç‚¹ï¼Œæ¯”å¦‚è¯´ 30 åˆ†é’Ÿåï¼Œç³»ç»Ÿå°±ä¼šå‘å»¶æ—¶é˜Ÿåˆ—å‘é€ä¸€æ¡å»¶æ—¶æ¶ˆæ¯ï¼Œç„¶åå®šæ—¶ä»»åŠ¡å°±ä¼šåœ¨ 30 åˆ†é’Ÿåå°†è¿™æ¡æ¶ˆæ¯ä»å»¶æ—¶é˜Ÿåˆ—ä¸­å–å‡ºå¹¶å‘å¸ƒæ–‡ç« ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 23 QQ åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis å®ç°å»¶è¿Ÿé˜Ÿåˆ—</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 8 Java åç«¯å®ä¹ ä¸€é¢é¢è¯•åŸé¢˜ï¼šredis æ•°æ®ç»“æ„ï¼Œç”¨ä»€ä¹ˆç»“æ„å®ç°å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 28 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹åœ¨ VIPç¾¤é‡Œ</a>å‘æ¶ˆæ¯è¯´æ‹¿åˆ°äº†è£è€€çš„æš‘æœŸå®ä¹  offerï¼Œè™½ç„¶æ—¶é—´èŠ‚ç‚¹å·²ç»ä¸æ—©äº†ï¼Œä½†è¶Šæ˜¯åˆ°è¿™ä¸ªæ—¶å€™ï¼Œç¡®å®å®¹æ˜“æ¡æ¼ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250528203451.png" alt="çƒå‹çš„è£è€€å®ä¹  OCäº†" tabindex="0" loading="lazy"><figcaption>çƒå‹çš„è£è€€å®ä¹  OCäº†</figcaption></figure><h3 id="_45-ğŸŒŸredisæ”¯æŒäº‹åŠ¡å—" tabindex="-1"><a class="header-anchor" href="#_45-ğŸŒŸredisæ”¯æŒäº‹åŠ¡å—"><span>45.ğŸŒŸRedisæ”¯æŒäº‹åŠ¡å—ï¼Ÿ</span></a></h3><p>æ˜¯çš„ï¼ŒRedis æ”¯æŒç®€å•çš„äº‹åŠ¡ï¼Œå¯ä»¥å°† multiã€execã€discard å’Œ watch å‘½ä»¤æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§çš„æŒ‰é¡ºåºæ‰§è¡Œã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529063154.png" alt="Redisè®¾è®¡ä¸å®ç°ï¼šäº‹åŠ¡" tabindex="0" loading="lazy"><figcaption>Redisè®¾è®¡ä¸å®ç°ï¼šäº‹åŠ¡</figcaption></figure><p>åŸºæœ¬æµç¨‹æ˜¯ç”¨ multi å¼€å¯äº‹åŠ¡ï¼Œç„¶åæ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤ï¼Œæœ€åç”¨ exec æäº¤ã€‚è¿™äº›å‘½ä»¤ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—ï¼Œåœ¨ exec æ—¶æ‰¹é‡æ‰§è¡Œã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240314101439.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis äº‹åŠ¡" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis äº‹åŠ¡</figcaption></figure><p>å½“å®¢æˆ·ç«¯å¤„äºéäº‹åŠ¡çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰å‘é€ç»™ Redis æœåŠ¡çš„å‘½ä»¤éƒ½ä¼šç«‹å³æ‰§è¡Œï¼›ä½†å½“å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹åï¼Œè¿™äº›å‘½ä»¤ä¼šè¢«æ”¾å…¥ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åç«‹å³è¿”å› QUEUEDï¼Œè¡¨ç¤ºå‘½ä»¤å·²å…¥é˜Ÿã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529063910.png" alt="Redisè®¾è®¡ä¸å®ç°ï¼šäº‹åŠ¡å’Œéäº‹åŠ¡çš„åŒºåˆ«" tabindex="0" loading="lazy"><figcaption>Redisè®¾è®¡ä¸å®ç°ï¼šäº‹åŠ¡å’Œéäº‹åŠ¡çš„åŒºåˆ«</figcaption></figure><p>å½“ exec å‘½ä»¤æ‰§è¡Œæ—¶ï¼ŒRedis ä¼šå°†äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤æŒ‰å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œã€‚å½“äº‹åŠ¡é˜Ÿåˆ—é‡Œçš„å‘½ä»¤å…¨éƒ¨æ‰§è¡Œå®Œæ¯•åï¼ŒRedis ä¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«æ¯ä¸ªå‘½ä»¤çš„æ‰§è¡Œç»“æœã€‚</p><p>discard å‘½ä»¤ç”¨äºå–æ¶ˆä¸€ä¸ªäº‹åŠ¡ï¼Œå®ƒä¼šæ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—å¹¶é€€å‡ºäº‹åŠ¡çŠ¶æ€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529065426.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šdiscard" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šdiscard</figcaption></figure><p>watch å‘½ä»¤ç”¨äºç›‘è§†ä¸€ä¸ªæˆ–è€…å¤šä¸ª keyï¼Œå¦‚æœè¿™ä¸ª key åœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰ è¢«å…¶ä»–å‘½ä»¤æ”¹åŠ¨ï¼Œé‚£ä¹ˆäº‹åŠ¡å°†ä¼šè¢«æ‰“æ–­ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529065131.png" alt="ç å“¥å­—èŠ‚ï¼šwatch" tabindex="0" loading="lazy"><figcaption>ç å“¥å­—èŠ‚ï¼šwatch</figcaption></figure><p>ä½† Redis çš„äº‹åŠ¡ä¸ MySQL çš„æœ‰å¾ˆå¤§ä¸åŒï¼Œå®ƒå¹¶ä¸æ”¯æŒå›æ»šï¼Œä¹Ÿä¸æ”¯æŒéš”ç¦»çº§åˆ«ã€‚</p><h4 id="è¯´ä¸€ä¸‹-redis-äº‹åŠ¡çš„åŸç†" tabindex="-1"><a class="header-anchor" href="#è¯´ä¸€ä¸‹-redis-äº‹åŠ¡çš„åŸç†"><span>è¯´ä¸€ä¸‹ Redis äº‹åŠ¡çš„åŸç†ï¼Ÿ</span></a></h4><p>Redis äº‹åŠ¡çš„åŸç†å¹¶ä¸å¤æ‚ï¼Œæ ¸å¿ƒå°±æ˜¯ä¸€ä¸ª&quot;å…ˆæ’é˜Ÿï¼Œåæ‰§è¡Œ&quot;çš„æœºåˆ¶ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529082025.png" alt="å°ç”Ÿå‡¡ä¸€ï¼šRedisäº‹åŠ¡" tabindex="0" loading="lazy"><figcaption>å°ç”Ÿå‡¡ä¸€ï¼šRedisäº‹åŠ¡</figcaption></figure><p>å½“æ‰§è¡Œ MULTI å‘½ä»¤æ—¶ï¼ŒRedis ä¼šç»™è¿™ä¸ªå®¢æˆ·ç«¯æ‰“ä¸€ä¸ªäº‹åŠ¡çš„æ ‡è®°ï¼Œè¡¨ç¤ºè¿™ä¸ªå®¢æˆ·ç«¯åé¢å‘é€çš„å‘½ä»¤ä¸ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¢«æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œæ’é˜Ÿç­‰ç€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529082120.png" alt="å°ç”Ÿå‡¡ä¸€ï¼šMULTI" tabindex="0" loading="lazy"><figcaption>å°ç”Ÿå‡¡ä¸€ï¼šMULTI</figcaption></figure><p>å½“ Redis æ”¶åˆ° EXEC å‘½ä»¤æ—¶ï¼Œå®ƒä¼šæŠŠé˜Ÿåˆ—é‡Œçš„å‘½ä»¤ä¸€ä¸ªä¸ªæ‹¿å‡ºæ¥æ‰§è¡Œã€‚å› ä¸º Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥è¿™ä¸ªè¿‡ç¨‹ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ‰“æ–­ï¼Œè¿™å°±ä¿è¯äº†Redis äº‹åŠ¡çš„åŸå­æ€§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529082216.png" alt="å°ç”Ÿå‡¡ä¸€ï¼šWATCH" tabindex="0" loading="lazy"><figcaption>å°ç”Ÿå‡¡ä¸€ï¼šWATCH</figcaption></figure><p>å½“æ‰§è¡Œ WATCH å‘½ä»¤æ—¶ï¼ŒRedis ä¼šå°† key æ·»åŠ åˆ°å…¨å±€ç›‘è§†å­—å…¸ä¸­ï¼›åªè¦è¿™äº› key åœ¨ EXEC å‰è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹ï¼ŒRedis å°±ä¼šç»™ç›¸å…³å®¢æˆ·ç«¯æ‰“ä¸Šè„æ ‡è®°ï¼ŒEXEC æ—¶å‘ç°äº‹åŠ¡å·²è¢«å¹²æ‰°å°±ä¼šç›´æ¥å–æ¶ˆæ•´ä¸ªäº‹åŠ¡ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å…¨å±€ç›‘è§†å­—å…¸</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">dict </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">watched_keys;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> watchedKey {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    robj </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">key;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    redisDb </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">db;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} watchedKey;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>DISCARD åšçš„äº‹æƒ…å¾ˆç®€å•ç›´æ¥ï¼Œé¦–å…ˆæ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦çœŸçš„åœ¨äº‹åŠ¡çŠ¶æ€ï¼Œå¦‚æœä¸åœ¨å°±æŠ¥é”™ï¼›å¦‚æœåœ¨äº‹åŠ¡çŠ¶æ€ï¼Œå°±æ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—å¹¶é€€å‡ºäº‹åŠ¡çŠ¶æ€ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> discardCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">client </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">flags</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> CLIENT_MULTI)) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        addReplyError</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(c,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;DISCARD without MULTI&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    discardTransaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(c);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    addReply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(c,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">shared</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="redis-äº‹åŠ¡æœ‰å“ªäº›æ³¨æ„ç‚¹" tabindex="-1"><a class="header-anchor" href="#redis-äº‹åŠ¡æœ‰å“ªäº›æ³¨æ„ç‚¹"><span>Redis äº‹åŠ¡æœ‰å“ªäº›æ³¨æ„ç‚¹ï¼Ÿ</span></a></h4><p>æœ€é‡è¦çš„çš„ä¸€ç‚¹æ˜¯ï¼ŒRedis äº‹åŠ¡ä¸æ”¯æŒå›æ»šï¼Œä¸€æ—¦ EXEC å‘½ä»¤è¢«è°ƒç”¨ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå³ä½¿æœ‰äº›å‘½ä»¤å¯èƒ½æ‰§è¡Œå¤±è´¥ã€‚</p><h4 id="redisäº‹åŠ¡ä¸ºä»€ä¹ˆä¸æ”¯æŒå›æ»š" tabindex="-1"><a class="header-anchor" href="#redisäº‹åŠ¡ä¸ºä»€ä¹ˆä¸æ”¯æŒå›æ»š"><span>Redisäº‹åŠ¡ä¸ºä»€ä¹ˆä¸æ”¯æŒå›æ»šï¼Ÿ</span></a></h4><p>Redis çš„æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯ç®€å•ã€é«˜æ•ˆï¼Œè€Œä¸æ˜¯å®Œæ•´çš„ ACID ç‰¹æ€§ã€‚è€Œå®ç°å›æ»šéœ€è¦åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿å­˜å¤§é‡çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶åœ¨å‘ç”Ÿé”™è¯¯æ—¶é€†å‘æ‰§è¡Œå‘½ä»¤ä»¥æ¢å¤åŸå§‹çŠ¶æ€ã€‚è¿™ä¼šå¢åŠ  Redis çš„å¤æ‚æ€§å’Œæ€§èƒ½å¼€é”€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529082551.png" alt="redis.ioï¼šä¸æ”¯æŒäº‹åŠ¡å›æ»š" tabindex="0" loading="lazy"><figcaption>redis.ioï¼šä¸æ”¯æŒäº‹åŠ¡å›æ»š</figcaption></figure><h4 id="redisäº‹åŠ¡æ»¡è¶³åŸå­æ€§å—-è¦æ€ä¹ˆæ”¹è¿›" tabindex="-1"><a class="header-anchor" href="#redisäº‹åŠ¡æ»¡è¶³åŸå­æ€§å—-è¦æ€ä¹ˆæ”¹è¿›"><span>Redisäº‹åŠ¡æ»¡è¶³åŸå­æ€§å—ï¼Ÿè¦æ€ä¹ˆæ”¹è¿›ï¼Ÿ</span></a></h4><p>Redis çš„äº‹åŠ¡ä¸èƒ½æ»¡è¶³æ ‡å‡†çš„åŸå­æ€§ï¼Œå› ä¸ºå®ƒä¸æ”¯æŒäº‹åŠ¡å›æ»šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚æŸä¸ªå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡å¹¶ä¸ä¼šè‡ªåŠ¨å›æ»šåˆ°åˆå§‹çŠ¶æ€ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ä¸€ä¸ªè½¬è´¦äº‹åŠ¡</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">multi</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decrement</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:1:balance&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // æˆåŠŸ</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">leftPush</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:1:balance&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;log&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // ç±»å‹é”™è¯¯ï¼Œå¤±è´¥</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">increment</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:2:balance&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // è¿˜æ˜¯ä¼šæ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> results </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">exec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ç»“æœï¼šç”¨æˆ·1è¢«æ‰£äº†é’±ï¼Œç”¨æˆ·2ä¹Ÿæ”¶åˆ°äº†é’±ï¼Œä½†ä¸­é—´çš„æ—¥å¿—æ“ä½œå¤±è´¥äº†</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è¿™ç¬¦åˆRedisçš„åŸå­æ€§å®šä¹‰ï¼Œä½†ä¸ç¬¦åˆä¸šåŠ¡æœŸæœ›</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥ä½¿ç”¨ Lua è„šæœ¬æ¥æ›¿ä»£äº‹åŠ¡ï¼Œè„šæœ¬è¿è¡ŒæœŸé—´ï¼ŒRedis ä¸ä¼šå¤„ç†å…¶ä»–å‘½ä»¤ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥åœ¨è„šæœ¬ä¸­å¤„ç†æ•´ä¸ªä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬æ¡ä»¶æ£€æŸ¥å’Œé”™è¯¯å¤„ç†ï¼Œä¿è¯è¦ä¹ˆæ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆä¿æŒæœ€åˆçš„çŠ¶æ€ï¼Œä¸ä¼šå‡ºç°ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå¤±è´¥ã€å…¶ä»–å‘½ä»¤æ‰§è¡ŒæˆåŠŸçš„æƒ…å†µã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Service</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ImprovedTransactionService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> atomicTransfer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> fromUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> toUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> amount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> luaScript</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;local from_key = KEYS[1] &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;local to_key = KEYS[2] &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;local amount = tonumber(ARGV[1]) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // æ£€æŸ¥è½¬å‡ºè´¦æˆ·ä½™é¢</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;local from_balance = redis.call(&#39;GET&#39;, from_key) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;if not from_balance then return -1 end &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;from_balance = tonumber(from_balance) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;if from_balance &lt; amount then return -2 end &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // æ£€æŸ¥è½¬å…¥è´¦æˆ·æ˜¯å¦å­˜åœ¨</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;if redis.call(&#39;EXISTS&#39;, to_key) == 0 then return -3 end &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œæ‰§è¡Œè½¬è´¦</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;redis.call(&#39;DECRBY&#39;, from_key, amount) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;redis.call(&#39;INCRBY&#39;, to_key, amount) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // è®°å½•è½¬è´¦æ—¥å¿—</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;local log = from_key .. &#39;:&#39; .. to_key .. &#39;:&#39; .. amount &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;redis.call(&#39;LPUSH&#39;, &#39;transfer:log&#39;, log) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;return 1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        DefaultRedisScript</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">script</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DefaultRedisScript</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        script</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setScriptText</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(luaScript);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        script</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setResultType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> result</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(script, </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            Arrays</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">asList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> fromUser </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;:balance&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> toUser </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;:balance&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            amount);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="redis-äº‹åŠ¡çš„-acid-ç‰¹æ€§å¦‚ä½•ä½“ç°" tabindex="-1"><a class="header-anchor" href="#redis-äº‹åŠ¡çš„-acid-ç‰¹æ€§å¦‚ä½•ä½“ç°"><span>Redis äº‹åŠ¡çš„ ACID ç‰¹æ€§å¦‚ä½•ä½“ç°ï¼Ÿ</span></a></h4><p>å•ä¸ª Redis å‘½ä»¤çš„æ‰§è¡Œæ˜¯åŸå­æ€§çš„ï¼Œä½† Redis æ²¡æœ‰åœ¨äº‹åŠ¡ä¸Šå¢åŠ ä»»ä½•ç»´æŒåŸå­æ€§çš„æœºåˆ¶ï¼Œæ‰€ä»¥ Redis äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœæŸä¸ªå‘½ä»¤å¤±è´¥äº†ï¼Œå…¶ä»–å‘½ä»¤è¿˜æ˜¯ä¼šç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šå›æ»šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529085332.png" alt="å°ç”Ÿå‡¡ä¸€ï¼šRedis äº‹åŠ¡çš„åŸå­æ€§" tabindex="0" loading="lazy"><figcaption>å°ç”Ÿå‡¡ä¸€ï¼šRedis äº‹åŠ¡çš„åŸå­æ€§</figcaption></figure><p>ä¸€è‡´æ€§æŒ‡çš„æ˜¯ï¼Œå¦‚æœæ•°æ®åœ¨æ‰§è¡Œäº‹åŠ¡ä¹‹å‰æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œæ•°æ®ä¹Ÿåº”è¯¥æ˜¯ä¸€è‡´çš„ã€‚ä½† Redis äº‹åŠ¡å¹¶ä¸ä¿è¯ä¸€è‡´æ€§ï¼Œå› ä¸ºå¦‚æœäº‹åŠ¡ä¸­çš„æŸä¸ªå‘½ä»¤å¤±è´¥äº†ï¼Œå…¶ä»–å‘½ä»¤ä»ç„¶ä¼šæ‰§è¡Œï¼Œå°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><p>Redis æ˜¯å•çº¿ç¨‹æ‰§è¡Œäº‹åŠ¡çš„ï¼Œå¹¶ä¸”ä¸ä¼šä¸­æ–­ï¼Œç›´åˆ°æ‰§è¡Œå®Œæ‰€æœ‰äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ä¸ºæ­¢ã€‚å› æ­¤ï¼Œæˆ‘è®¤ä¸º Redis çš„äº‹åŠ¡å…·æœ‰éš”ç¦»æ€§çš„ç‰¹å¾ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529085959.png" alt="å°ç”Ÿå‡¡ä¸€ï¼šRedis äº‹åŠ¡çš„éš”ç¦»æ€§" tabindex="0" loading="lazy"><figcaption>å°ç”Ÿå‡¡ä¸€ï¼šRedis äº‹åŠ¡çš„éš”ç¦»æ€§</figcaption></figure><p>Redis äº‹åŠ¡çš„æŒä¹…æ€§å®Œå…¨ä¾èµ–äº Redis æœ¬èº«çš„æŒä¹…åŒ–æœºåˆ¶ï¼Œå¦‚æœå¼€å¯äº† AOFï¼Œé‚£ä¹ˆäº‹åŠ¡ä¸­çš„å‘½ä»¤ä¼šä½œä¸ºä¸€ä¸ªæ•´ä½“è®°å½•åˆ° AOF æ–‡ä»¶ä¸­ï¼Œå½“ç„¶ä¹Ÿè¦çœ‹ AOF çš„ fsync ç­–ç•¥ã€‚</p><p>å¦‚æœåªå¼€å¯äº† RDBï¼Œäº‹åŠ¡ä¸­çš„å‘½ä»¤å¯èƒ½ä¼šåœ¨ä¸‹æ¬¡å¿«ç…§å‰ä¸¢å¤±ã€‚å¦‚æœä¸¤ä¸ªéƒ½æ²¡æœ‰å¼€å¯ï¼Œè‚¯å®šæ˜¯ä¸æ»¡è¶³æŒä¹…æ€§çš„ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åä¸ºä¸€é¢åŸé¢˜ï¼šè¯´ä¸‹ Redis äº‹åŠ¡</li><li><a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">äºŒå“¥ç¼–ç¨‹æ˜Ÿçƒ</a>çƒå‹<a href="https://t.zsxq.com/BaHOh" target="_blank" rel="noopener noreferrer">æ•äº‘çœ ç¾å›¢ AI é¢è¯•åŸé¢˜</a>ï¼šä»€ä¹ˆæ˜¯ redis çš„äº‹åŠ¡ï¼Œå®ƒçš„ ACID å±æ€§å¦‚ä½•ä½“ç°</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¿«æ‰‹åŒå­¦ 4 ä¸€é¢åŸé¢˜ï¼šRedisäº‹åŠ¡æ»¡è¶³åŸå­æ€§å—ï¼Ÿè¦æ€ä¹ˆæ”¹è¿›ï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 5 æœˆ 29 æ—¥ï¼Œä»Šå¤©ç»™çƒå‹<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">ä¿®æ”¹ç®€å†</a>æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªä¸œå—å¤§å­¦æœ¬ç¡•åš 3 985 çš„çƒå‹ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘å·²çŸ¥ä¿¡æ¯ä¸­å­¦å†æœ€é«˜çš„çƒå‹äº†ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250529090547.png" alt="æ˜Ÿçƒæ¥äº†ä¸€ä¸ªä¸œå—å¤§å­¦æœ¬ç¡•åšçš„çƒå‹" tabindex="0" loading="lazy"><figcaption>æ˜Ÿçƒæ¥äº†ä¸€ä¸ªä¸œå—å¤§å­¦æœ¬ç¡•åšçš„çƒå‹</figcaption></figure><h3 id="_46-æœ‰luaè„šæœ¬æ“ä½œredisçš„ç»éªŒå—" tabindex="-1"><a class="header-anchor" href="#_46-æœ‰luaè„šæœ¬æ“ä½œredisçš„ç»éªŒå—"><span>46.æœ‰Luaè„šæœ¬æ“ä½œRedisçš„ç»éªŒå—ï¼Ÿ</span></a></h3><p>Lua è„šæœ¬æ˜¯å¤„ç† Redis å¤æ‚æ“ä½œçš„é¦–é€‰æ–¹æ¡ˆï¼Œæ¯”å¦‚è¯´åŸå­æ‰£å‡åº“å­˜ã€åˆ†å¸ƒå¼é”ã€é™æµç­‰ä¸šåŠ¡åœºæ™¯ï¼Œéƒ½å¯ä»¥é€šè¿‡ Lua è„šæœ¬æ¥å®ç°ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250530151227.png" alt="scalegrid.ioï¼šlua è„šæœ¬" tabindex="0" loading="lazy"><figcaption>scalegrid.ioï¼šlua è„šæœ¬</figcaption></figure><p>åœ¨ç§’æ€åœºæ™¯ä¸‹ï¼Œå¯ä»¥ç”¨ Lua è„šæœ¬æŠŠæ‰€æœ‰æ£€æŸ¥é€»è¾‘éƒ½å†™åœ¨ä¸€èµ·ï¼šå…ˆçœ‹åº“å­˜å¤Ÿä¸å¤Ÿï¼Œå†çœ‹ç”¨æˆ·æœ‰æ²¡æœ‰ä¹°è¿‡ï¼Œæ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³æ‰æ‰£å‡åº“å­˜ã€‚å› ä¸ºæ•´ä¸ªè„šæœ¬æ˜¯åŸå­æ‰§è¡Œçš„ï¼ŒRedis åœ¨æ‰§è¡ŒæœŸé—´ä¸ä¼šå¤„ç†å…¶ä»–å‘½ä»¤ï¼Œæ‰€ä»¥å¯ä»¥å½»åº•è§£å†³è¶…å–é—®é¢˜ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è¿™ä¸ªç§’æ€è„šæœ¬æ•‘äº†æˆ‘çš„å‘½</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> luaScript </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;local stock = redis.call(&#39;GET&#39;, KEYS[1]) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;if not stock or tonumber(stock) &lt; tonumber(ARGV[2]) then &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;    return -1 &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // åº“å­˜ä¸è¶³</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;end &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;if redis.call(&#39;SISMEMBER&#39;, KEYS[2], ARGV[1]) == 1 then &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;    return -2 &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // é‡å¤è´­ä¹°</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;end &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;redis.call(&#39;DECRBY&#39;, KEYS[1], ARGV[2]) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;redis.call(&#39;SADD&#39;, KEYS[2], ARGV[1]) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;return 1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨åˆ†å¸ƒå¼é”åœºæ™¯ä¸‹ï¼Œæˆ‘ä¸€å¼€å§‹ç”¨çš„ SETNX å‘½ä»¤æ¥å®ç°ï¼Œç»“æœå‘ç°å¦‚æœç¨‹åºå¼‚å¸¸é€€å‡ºï¼Œé”å°±æ­»æ‰äº†ã€‚åæ¥åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œä½†åˆå‘ç°å¯èƒ½è¯¯åˆ å…¶ä»–çº¿ç¨‹çš„é”ã€‚æœ€åè¿˜æ˜¯ç”¨ Lua è„šæœ¬å½»åº•è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œç¡®ä¿åªæœ‰é”çš„æŒæœ‰è€…æ‰èƒ½é‡Šæ”¾é”ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è§£é”è„šæœ¬ç‰¹åˆ«é‡è¦ï¼Œå¿…é¡»éªŒè¯æ˜¯è‡ªå·±çš„é”æ‰èƒ½åˆ </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> UNLOCK_SCRIPT </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;if redis.call(&#39;GET&#39;, KEYS[1]) == ARGV[1] then &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;    return redis.call(&#39;DEL&#39;, KEYS[1]) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;else &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;    return 0 &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;end&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”šè‡³è¿˜å¯ä»¥ç”¨ Luaè„šæœ¬å®ç°æ»‘åŠ¨çª—å£é™æµå™¨ï¼Œä¸€æ¬¡æ€§å®Œæˆè¿‡æœŸæ•°æ®æ¸…ç†ã€è®¡æ•°æ£€æŸ¥ã€æ–°è®°å½•æ·»åŠ ä¸‰ä¸ªæ“ä½œï¼Œè€Œä¸”å®Œå…¨åŸå­åŒ–ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ»‘åŠ¨çª—å£é™æµï¼Œé€»è¾‘æ¸…æ™°ï¼Œæ€§èƒ½è¿˜å¥½</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> luaScript </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;local key = KEYS[1] &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;local now = tonumber(ARGV[1]) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;local window = tonumber(ARGV[2]) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;local limit = tonumber(ARGV[3]) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å…ˆæ¸…ç†è¿‡æœŸè®°å½•</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;redis.call(&#39;ZREMRANGEBYSCORE&#39;, key, 0, now - window) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ£€æŸ¥å½“å‰è¯·æ±‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;local current = redis.call(&#39;ZCARD&#39;, key) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;if current &lt; limit then &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;    redis.call(&#39;ZADD&#39;, key, now, now) &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;    return 1 &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;else &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;    return 0 &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;end&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>memoï¼š2025 å¹´ 5 æœˆ 30 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹åœ¨æ˜Ÿçƒé‡Œ</a>å‘æ¶ˆæ¯è¯´æ‹¿åˆ°äº†é‡‘å±±åŠå…¬çš„ offerï¼Œé—®æˆ‘è¯¥é€‰ cpp è¿˜æ˜¯goï¼Œæˆ‘çš„å»ºè®®å¤§å®¶å¯ä»¥çœ‹çœ‹ç¬¦åˆæ˜¯å¦åˆç†ï¼Œä¸ç®¡å¦‚ä½•é€‰æ‹©ï¼ŒçœŸçš„æ­å–œçƒå‹ï¼</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250601080336.png" alt="çƒå‹æ‹¿åˆ°äº†é‡‘å±±åŠå…¬çš„è½¯ä»¶" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†é‡‘å±±åŠå…¬çš„è½¯ä»¶</figcaption></figure><h3 id="_47-redisçš„ç®¡é“pipelineäº†è§£å—" tabindex="-1"><a class="header-anchor" href="#_47-redisçš„ç®¡é“pipelineäº†è§£å—"><span>47.Redisçš„ç®¡é“Pipelineäº†è§£å—ï¼Ÿ</span></a></h3><p>äº†è§£ï¼ŒPipeline å…è®¸å®¢æˆ·ç«¯ä¸€æ¬¡æ€§å‘ Redis æœåŠ¡å™¨å‘é€å¤šä¸ªå‘½ä»¤ï¼Œè€Œä¸å¿…ç­‰å¾…ä¸€ä¸ªå‘½ä»¤å“åº”åæ‰èƒ½å‘é€ä¸‹ä¸€ä¸ªã€‚Redis æœåŠ¡å™¨ä¼šæŒ‰ç…§å‘½ä»¤çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œå¹¶å°†æ‰€æœ‰ç»“æœæ‰“åŒ…è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-38aee4c1-efd2-495e-8a6d-164d21a129b1.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šPipeliningç¤ºæ„å›¾" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šPipeliningç¤ºæ„å›¾</figcaption></figure><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¯æ‰§è¡Œä¸€ä¸ª Redis å‘½ä»¤éƒ½éœ€è¦ä¸€æ¬¡ç½‘ç»œå¾€è¿”ï¼šå‘é€å‘½ä»¤ -&gt; ç­‰å¾…å“åº” -&gt; å‘é€ä¸‹ä¸€ä¸ªå‘½ä»¤ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>å®¢æˆ·ç«¯                    RedisæœåŠ¡å™¨</span></span>
<span class="line"><span>  |                           |</span></span>
<span class="line"><span>  |------- SET key1 val1 ----&gt;|</span></span>
<span class="line"><span>  |&lt;------ OK ---------------|</span></span>
<span class="line"><span>  |------- SET key2 val2 ----&gt;|</span></span>
<span class="line"><span>  |&lt;------ OK ---------------|</span></span>
<span class="line"><span>  |------- GET key1 --------&gt;|</span></span>
<span class="line"><span>  |&lt;------ val1 -------------|</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœå¤§é‡è¯·æ±‚ä¾æ¬¡å‘é€ï¼Œç½‘ç»œå»¶è¿Ÿä¼šæ˜¾è‘—å¢åŠ è¯·æ±‚çš„æ€»æ‰§è¡Œæ—¶é—´ï¼Œå‡å¦‚ä¸€æ¬¡ RTT çš„æ—¶é—´æ˜¯ 1 æ¯«ç§’ï¼Œ3 ä¸ªå°±æ˜¯ 3 æ¯«ç§’ã€‚æœ‰äº† Pipeline åï¼Œå¯ä»¥ä¸€æ¬¡æ€§å‘é€ 3 ä¸ªå‘½ä»¤ï¼Œæ€»æ—¶é—´å°±åªéœ€è¦ 1 æ¯«ç§’ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Service</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisBatchService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> batchInsertUsers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">User</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">users</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ä¸ç”¨Pipelineçš„é”™è¯¯åšæ³• - å¾ˆæ…¢</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // for (User user : users) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        //     redisTemplate.opsForValue().set(&quot;user:&quot; + user.getId(), user);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ä½¿ç”¨Pipelineçš„æ­£ç¡®åšæ³•</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">executePipelined</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisCallback</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> doInRedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RedisConnection</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> connection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DataAccessException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">User</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> user</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                    String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">                    byte</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">keyBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">                    byte</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">valueBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> serialize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(user);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                    </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    connection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(keyBytes, valueBytes);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Pipelineä¸éœ€è¦è¿”å›å€¼</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç„¶äº†ï¼ŒPipeline ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå¤ªå¤§ä¼šå ç”¨è¿‡å¤šå†…å­˜ï¼Œé€šå¸¸å»ºè®®æ¯ä¸ª Pipeline åŒ…å« 1000 åˆ° 5000 ä¸ªå‘½ä»¤ã€‚å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> smartBatchInsert</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> data) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> batchSize </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // ç»éªŒå€¼ï¼Œæ ¹æ®æ•°æ®å¤§å°è°ƒæ•´</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> batchSize) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> batch </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">subList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Math</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">min</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> batchSize, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">executePipelined</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisCallback</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> doInRedis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RedisConnection</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> connection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DataAccessException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> batch) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    connection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä»€ä¹ˆåœºæ™¯ä¸‹é€‚åˆä½¿ç”¨-pipelineå‘¢" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆåœºæ™¯ä¸‹é€‚åˆä½¿ç”¨-pipelineå‘¢"><span>ä»€ä¹ˆåœºæ™¯ä¸‹é€‚åˆä½¿ç”¨ Pipelineå‘¢ï¼Ÿ</span></a></h4><p>éœ€è¦æ‰¹é‡æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤æ•°æ®ï¼Œæˆ–è€…éœ€è¦æ‰§è¡Œå¤§é‡ç›¸ä¼¼çš„å‘½ä»¤æ—¶ã€‚æ¯”å¦‚ï¼šç³»ç»Ÿå¯åŠ¨æ—¶çš„ç¼“å­˜é¢„çƒ­ -&gt; æ‰¹é‡åŠ è½½çƒ­ç‚¹æ•°æ®ï¼›æ¯”å¦‚ç»Ÿè®¡æ•°æ®çš„æ‰¹é‡æ›´æ–°ï¼›æ¯”å¦‚å¤§æ‰¹é‡æ•°æ®çš„å¯¼å…¥å¯¼å‡ºï¼›æ¯”å¦‚æ‰¹é‡åˆ é™¤è¿‡æœŸæˆ–æ— æ•ˆçš„ç¼“å­˜ã€‚</p><h4 id="æœ‰äº†è§£è¿‡-pipeline-çš„åº•å±‚åŸç†å—" tabindex="-1"><a class="header-anchor" href="#æœ‰äº†è§£è¿‡-pipeline-çš„åº•å±‚åŸç†å—"><span>æœ‰äº†è§£è¿‡ Pipeline çš„åº•å±‚åŸç†å—ï¼Ÿ</span></a></h4><p>æœ‰ï¼Œå…¶å®å°±æ˜¯ç¼“å†²çš„æ€æƒ³ã€‚åœ¨<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" target="_blank" rel="noopener noreferrer">æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®</a>ä¸­ï¼Œæˆ‘å°±åœ¨ RedisClient ç±»ä¸­å°è£…äº†ä¸€ä¸ª PipelineAction å†…éƒ¨ç±»ï¼Œç”¨æ¥ç¼“å­˜å‘½ä»¤ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250601092704.png" alt="æŠ€æœ¯æ´¾å®æˆ˜æºç ï¼šPipelineAction" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾å®æˆ˜æºç ï¼šPipelineAction</figcaption></figure><p>add æ–¹æ³•å°†å‘½ä»¤åŒ…è£…æˆ Runnable å¯¹è±¡ï¼Œæ”¾å…¥ List ä¸­ã€‚å½“æ‰§è¡Œ execute æ–¹æ³•æ—¶ï¼Œå†è°ƒç”¨ RedisTemplate çš„ executePipelined æ–¹æ³•å¼€å¯ç®¡é“æ¨¡å¼å°†å¤šä¸ªå‘½ä»¤å‘é€åˆ° Redis æœåŠ¡ç«¯ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250601094500.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedisTemplateçš„executePipelined" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedisTemplateçš„executePipelined</figcaption></figure><p>Redis æœåŠ¡ç«¯ä»è¾“å…¥ç¼“å†²åŒºè¯»åˆ°å‘½ä»¤åï¼Œä¼šæŒ‰ç…§ RESP åè®®è¿›è¡Œå‘½ä»¤æ‹†è§£ï¼Œå†ä¾æ¬¡æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚æ‰§è¡Œç»“æœä¼šå†™å…¥åˆ°è¾“å‡ºç¼“å†²åŒºï¼Œæœ€åå†å°†æ‰€æœ‰ç»“æœä¸€æ¬¡æ€§è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> client {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    sds querybuf;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           // è¾“å…¥ç¼“å†²åŒº</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    list </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">reply;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // è¾“å‡ºç¼“å†²åŒºé“¾è¡¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> reply_bytes;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // è¾“å‡ºç¼“å†²åŒºå¤§å°</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} client;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 8 é¢è¯•åŸé¢˜ï¼šå¯¹pipelineçš„ç†è§£ï¼Œä»€ä¹ˆåœºæ™¯é€‚åˆä½¿ç”¨pipelineï¼Ÿæœ‰äº†è§£è¿‡pipelineçš„åº•å±‚ï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 6 æœˆ 1 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹åœ¨æ˜Ÿçƒé‡Œ</a>å‘æ¶ˆæ¯è¯´æ‹¿åˆ°äº†ç™¾å¾—æ€ç»´çš„offerï¼Œä»–æ˜¯æ°‘åŠäºŒæœ¬ï¼Œå¯¹è¿™ä¸ªç»“æœå¾ˆæ»¡æ„ï¼Œä¹Ÿå¾ˆæ„Ÿè°¢é¢æ¸£é€†è¢­å’Œæ˜Ÿçƒçš„å®æˆ˜é¡¹ç›®ï¼Œè®©ä»–æ‘†è„±äº†æµ‘æµ‘å™©å™©çš„æ—¥å­ã€‚æ­å–œä»–ï¼</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250601082813.png" alt="çƒå‹æ‹¿åˆ°äº†ä¸€å®¶å°å‚çš„ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†ä¸€å®¶å°å‚çš„ offer</figcaption></figure><h3 id="_48-ğŸŒŸredisèƒ½å®ç°åˆ†å¸ƒå¼é”å—" tabindex="-1"><a class="header-anchor" href="#_48-ğŸŒŸredisèƒ½å®ç°åˆ†å¸ƒå¼é”å—"><span>48.ğŸŒŸRedisèƒ½å®ç°åˆ†å¸ƒå¼é”å—ï¼Ÿ</span></a></h3><p>åˆ†å¸ƒå¼é”æ˜¯ä¸€ç§ç”¨äºæ§åˆ¶å¤šä¸ªä¸åŒè¿›ç¨‹åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è®¿é—®å…±äº«èµ„æºçš„é”æœºåˆ¶ã€‚å®ƒèƒ½ç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å¯¹èµ„æºè¿›è¡Œè®¿é—®ï¼Œä»è€Œé¿å…åˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„å¹¶å‘é—®é¢˜ã€‚</p><p>å¯ä»¥ä½¿ç”¨ Redis çš„ SETNX å‘½ä»¤å®ç°ç®€å•çš„åˆ†å¸ƒå¼é”ã€‚æ¯”å¦‚ <code>SET key value NX PX 3000</code> å°±åˆ›å»ºäº†ä¸€ä¸ªé”åä¸º <code>key</code> çš„åˆ†å¸ƒå¼é”ï¼Œé”çš„æŒæœ‰è€…ä¸º <code>value</code>ã€‚NX ä¿è¯åªæœ‰åœ¨ key ä¸å­˜åœ¨æ—¶æ‰èƒ½åˆ›å»ºæˆåŠŸï¼ŒEX è®¾ç½®è¿‡æœŸæ—¶é—´ç”¨ä»¥é˜²æ­¢æ­»é”ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-710cdd19-98ea-4e96-b579-ff1ebb0d5de9.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šsetåŸå­å‘½ä»¤" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šsetåŸå­å‘½ä»¤</figcaption></figure><h4 id="rediså¦‚ä½•ä¿è¯-setnx-ä¸ä¼šå‘ç”Ÿå†²çª" tabindex="-1"><a class="header-anchor" href="#rediså¦‚ä½•ä¿è¯-setnx-ä¸ä¼šå‘ç”Ÿå†²çª"><span>Rediså¦‚ä½•ä¿è¯ SETNX ä¸ä¼šå‘ç”Ÿå†²çªï¼Ÿ</span></a></h4><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>SET key value NX EX 30</code> è¿™ä¸ªå‘½ä»¤è¿›è¡ŒåŠ é”æ—¶ï¼ŒRedis ä¼šæŠŠæ•´ä¸ªæ“ä½œå½“ä½œä¸€ä¸ªåŸå­æŒ‡ä»¤æ¥æ‰§è¡Œã€‚å› ä¸º Redis çš„å‘½ä»¤å¤„ç†æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥åœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå‘½ä»¤åœ¨æ‰§è¡Œã€‚</p><p>æ¯”å¦‚è¯´ä¸¤ä¸ªå®¢æˆ·ç«¯ A å’Œ B åŒæ—¶è¯·æ±‚åŒä¸€ä¸ªé”ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>å®¢æˆ·ç«¯A: SET lock_key uuid_a NX EX 30</span></span>
<span class="line"><span>å®¢æˆ·ç«¯B: SET lock_key uuid_b NX EX 30</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>è™½ç„¶è¿™ä¸¤ä¸ªè¯·æ±‚å¯èƒ½å‡ ä¹åŒæ—¶åˆ°è¾¾ Redis æœåŠ¡å™¨ï¼Œä½† Redis ä¼šä¸¥æ ¼æŒ‰ç…§åˆ°è¾¾çš„å…ˆåé¡ºåºæ¥å¤„ç†ã€‚å‡è®¾ A çš„è¯·æ±‚å…ˆåˆ°ï¼ŒRedis ä¼šå…ˆæ‰§è¡Œ A çš„ SET å‘½ä»¤ï¼Œè¿™æ—¶ lock_key è¢«è®¾ç½®ä¸º uuid_aã€‚</p><p>å½“å¤„ç† B çš„è¯·æ±‚æ—¶ï¼Œå› ä¸º lock_key å·²ç»å­˜åœ¨äº†ï¼ŒNX æ¡ä»¶ä¸æ»¡è¶³ï¼Œæ‰€ä»¥ B çš„ SET å‘½ä»¤ä¼šå¤±è´¥ï¼Œè¿”å› NULLã€‚è¿™æ ·å°±ä¿è¯äº†åªæœ‰ A èƒ½è·å–åˆ°é”ã€‚</p><p>å…³é”®ç‚¹åœ¨äº NX çš„è¯­ä¹‰ï¼š<code>NOT EXISTS</code>ï¼Œåªæœ‰åœ¨ key ä¸å­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®æˆåŠŸã€‚Redis åœ¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥ key æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨æ‰ä¼šè®¾ç½®å€¼ï¼Œè¿™æ•´ä¸ªè¿‡ç¨‹æ˜¯åŸå­çš„ï¼Œä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ‰“æ–­ã€‚</p><h4 id="setnxæœ‰ä»€ä¹ˆé—®é¢˜-å¦‚ä½•è§£å†³" tabindex="-1"><a class="header-anchor" href="#setnxæœ‰ä»€ä¹ˆé—®é¢˜-å¦‚ä½•è§£å†³"><span>SETNXæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ</span></a></h4><p>ä½¿ç”¨ SETNX åˆ›å»ºåˆ†å¸ƒå¼é”æ—¶ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡è®¾ç½®è¿‡æœŸæ—¶é—´æ¥é¿å…æ­»é”ï¼Œä½†ä¼šè¯¯åˆ é”ã€‚æ¯”å¦‚çº¿ç¨‹ A è·å–é”åï¼Œä¸šåŠ¡æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œé”è¿‡æœŸäº†ã€‚è¿™æ—¶çº¿ç¨‹ B è·å–åˆ°é”ï¼Œä½†çº¿ç¨‹ A æ‰§è¡Œå®Œä¸šåŠ¡é€»è¾‘åï¼Œä¼šå°è¯•åˆ é™¤é”ï¼Œè¿™æ—¶å€™åˆ æ‰çš„å…¶å®æ˜¯çº¿ç¨‹ B çš„é”ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20241122191044.png" alt="æŠ€æœ¯æ´¾ï¼šRedis é”" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾ï¼šRedis é”</figcaption></figure><p>å¯ä»¥é€šè¿‡é”çš„è‡ªåŠ¨ç»­æœŸæœºåˆ¶æ¥è§£å†³é”è¿‡æœŸçš„é—®é¢˜ï¼Œæ¯”å¦‚ Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ï¼Œåœ¨åå°å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±æ£€æŸ¥é”æ˜¯å¦è¿˜è¢«å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå¦‚æœæ˜¯å°±è‡ªåŠ¨å»¶é•¿è¿‡æœŸæ—¶é—´ã€‚è¿™æ ·æ—¢é¿å…äº†æ­»é”ï¼Œåˆé˜²æ­¢äº†é”è¢«æå‰é‡Šæ”¾ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20241122192038.png" alt="æŠ€æœ¯æ´¾ï¼šredisson çœ‹é—¨ç‹—" tabindex="0" loading="lazy"><figcaption>æŠ€æœ¯æ´¾ï¼šredisson çœ‹é—¨ç‹—</figcaption></figure><p>memoï¼š2025 å¹´ 6 æœˆ 2 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨å¸®ä¸€ä¸ªå­¦é™¢æœ¬çƒå‹åˆ†æ offer é€‰æ‹©åï¼Œä»–åˆå›å¤è¯´<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">å¤šäºäº†æ˜Ÿçƒæ‰èƒ½ä¸€è·¯èµ°åˆ°ç°åœ¨</a>ï¼Œå¾ˆæ»¡è¶³è¿™ä¸ªç»“æœã€‚çœ‹å¤šäº†æ‹¿å¤§å‚ offer çƒå‹çš„æ„Ÿè°¢ï¼Œçœ‹åˆ°å­¦é™¢æœ¬ä¹Ÿèƒ½å–å¾—æ»¡æ„çš„æˆç»©ï¼Œæˆ‘ä¹Ÿå¾ˆå¼€å¿ƒã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250602113225.png" alt="å­¦é™¢æœ¬æ‹¿åˆ°offer åå¯¹æ˜Ÿçƒçš„è®¤å¯" tabindex="0" loading="lazy"><figcaption>å­¦é™¢æœ¬æ‹¿åˆ°offer åå¯¹æ˜Ÿçƒçš„è®¤å¯</figcaption></figure><h4 id="redissonäº†è§£å¤šå°‘" tabindex="-1"><a class="header-anchor" href="#redissonäº†è§£å¤šå°‘"><span>Redissonäº†è§£å¤šå°‘ï¼Ÿ</span></a></h4><p>Redisson æ˜¯ä¸€ä¸ªåŸºäº Redis çš„ Java å®¢æˆ·ç«¯ï¼Œå®ƒä¸åªæ˜¯å¯¹ Redis çš„æ“ä½œè¿›è¡Œç®€å•åœ°å°è£…ï¼Œè¿˜æä¾›äº†å¾ˆå¤šåˆ†å¸ƒå¼çš„æ•°æ®ç»“æ„å’ŒæœåŠ¡ï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„åˆ†å¸ƒå¼é”ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RLock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;lock&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // do something</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redisson çš„åˆ†å¸ƒå¼é”æ¯” SETNX å®Œå–„çš„å¾—å¤šï¼Œå®ƒçš„çœ‹é—¨ç‹—æœºåˆ¶å¯ä»¥è®©æˆ‘ä»¬åœ¨è·å–é”çš„æ—¶å€™çœå»æ‰‹åŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ­¥éª¤ï¼Œå®ƒåœ¨å†…éƒ¨å°è£…äº†ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš” 10 ç§’ä¼šæ£€æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¿˜æŒæœ‰é”å°±è‡ªåŠ¨ç»­æœŸ 30 ç§’ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Long</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> waitTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> leaseTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> unit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> threadId) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> get</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryAcquireAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(waitTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> leaseTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> unit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> threadId))</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryAcquireAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> waitTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> leaseTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> unit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> threadId) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    RFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ttlRemainingFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (leaseTime </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ‰‹åŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        ttlRemainingFuture </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryLockInnerAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(waitTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> leaseTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> unit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> threadId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> RedisCommands</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">EVAL_LONG</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å¯ç”¨çœ‹é—¨ç‹—æœºåˆ¶ï¼Œä½¿ç”¨é»˜è®¤çš„30ç§’è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        ttlRemainingFuture </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryLockInnerAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(waitTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> internalLockLeaseTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MILLISECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> threadId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> RedisCommands</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">EVAL_LONG</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å¤„ç†è·å–é”æˆåŠŸçš„æƒ…å†µ</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    ttlRemainingFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">onComplete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((ttlRemaining, e) </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (e </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å¦‚æœè·å–é”æˆåŠŸä¸”å¯ç”¨çœ‹é—¨ç‹—æœºåˆ¶</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (ttlRemaining </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (leaseTime </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                internalLockLeaseTime </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> unit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(leaseTime);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                scheduleExpirationRenewal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(threadId); </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å¯åŠ¨çœ‹é—¨ç‹—</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    });</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> ttlRemainingFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦å¤–ï¼ŒRedisson è¿˜æä¾›äº†åˆ†å¸ƒå¼é™æµå™¨ RRateLimiterï¼ŒåŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°ï¼Œç”¨äºæ§åˆ¶åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„è®¿é—®é¢‘ç‡ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// API æ¥å£é™æµ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">RestController</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ApiController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedissonClient</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redissonClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">GetMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/api/data&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ResponseEntity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        RRateLimiter</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> limiter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redissonClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getRateLimiter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;api.data&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        limiter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">trySetRate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">RateType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">OVERALL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">RateIntervalUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MINUTES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">limiter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // å¤„ç†è¯·æ±‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ResponseEntity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">processData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // é™æµè§¦å‘</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ResponseEntity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">status</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">429</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">body</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Rate limit exceeded&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è¯¦ç»†è¯´è¯´redissonçš„çœ‹é—¨ç‹—æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#è¯¦ç»†è¯´è¯´redissonçš„çœ‹é—¨ç‹—æœºåˆ¶"><span>è¯¦ç»†è¯´è¯´Redissonçš„çœ‹é—¨ç‹—æœºåˆ¶ï¼Ÿ</span></a></h4><p>Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶æ˜¯ä¸€ç§è‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼Œç”¨äºè§£å†³åˆ†å¸ƒå¼é”çš„è¿‡æœŸé—®é¢˜ã€‚</p><p>åŸºæœ¬åŸç†æ˜¯è¿™æ ·çš„ï¼šå½“è°ƒç”¨ <code>lock()</code> æ–¹æ³•åŠ é”æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ˜¾å¼è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ŒRedisson ä¼šé»˜è®¤ç»™é”åŠ ä¸€ä¸ª 30 ç§’çš„è¿‡æœŸæ—¶é—´ï¼ŒåŒæ—¶å¯ç”¨ä¸€ä¸ªåä¸ºâ€œçœ‹é—¨ç‹—â€çš„å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš” 10 ç§’ï¼ˆé»˜è®¤æ˜¯è¿‡æœŸæ—¶é—´çš„ 1/3ï¼‰ï¼Œå»æ£€æŸ¥ä¸€æ¬¡é”æ˜¯å¦è¿˜è¢«å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå¦‚æœæ˜¯ï¼Œå°±è‡ªåŠ¨ç»­æœŸï¼Œå°†è¿‡æœŸæ—¶é—´å»¶é•¿åˆ° 30 ç§’ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240918110433.png" alt="éƒ­æ…•è£åšå®¢å›­ï¼šçœ‹é—¨ç‹—" tabindex="0" loading="lazy"><figcaption>éƒ­æ…•è£åšå®¢å›­ï¼šçœ‹é—¨ç‹—</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ä¼ªä»£ç å±•ç¤ºæ ¸å¿ƒé€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> renewExpiration</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    Timeout</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> task </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> commandExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getConnectionManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">newTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> TimerTask</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> run</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // ç”¨ Lua è„šæœ¬æ£€æŸ¥å¹¶ç»­æœŸ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;get&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, lockKey) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentThreadId) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;expire&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, lockKey, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">30</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                    // é€’å½’è°ƒç”¨ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡ç»­æœŸ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    renewExpiration</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»­æœŸçš„ Lua è„šæœ¬ä¼šæ£€æŸ¥é”çš„ value æ˜¯å¦åŒ¹é…å½“å‰çº¿ç¨‹ï¼Œå¦‚æœåŒ¹é…å°±å»¶é•¿è¿‡æœŸæ—¶é—´ã€‚è¿™æ ·å°±èƒ½ä¿è¯åªæœ‰é”çš„çœŸæ­£æŒæœ‰è€…æ‰èƒ½ç»­æœŸã€‚</p><p>å½“è°ƒç”¨ <code>unlock()</code> æ–¹æ³•æ—¶ï¼Œçœ‹é—¨ç‹—ä»»åŠ¡ä¼šè¢«å–æ¶ˆã€‚æˆ–è€…å¦‚æœä¸šåŠ¡é€»è¾‘æ‰§è¡Œå®Œä½†å¿˜è®° unlock äº†ï¼Œçœ‹é—¨ç‹—ä¹Ÿä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨æ£€æŸ¥é”ï¼Œå¦‚æœé”å·²ç»ä¸å±äºå½“å‰çº¿ç¨‹äº†ï¼Œä¹Ÿä¼šè‡ªåŠ¨åœæ­¢ç»­æœŸã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨æ‹…å¿ƒä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è¢«æå‰é‡Šæ”¾ï¼Œä¹Ÿé¿å…äº†æ‰‹åŠ¨ä¼°ç®—è¿‡æœŸæ—¶é—´çš„éº»çƒ¦ï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ­»é”é—®é¢˜ã€‚</p><h4 id="çœ‹é—¨ç‹—æœºåˆ¶ä¸­çš„æ£€æŸ¥é”è¿‡ç¨‹æ˜¯åŸå­æ“ä½œå—" tabindex="-1"><a class="header-anchor" href="#çœ‹é—¨ç‹—æœºåˆ¶ä¸­çš„æ£€æŸ¥é”è¿‡ç¨‹æ˜¯åŸå­æ“ä½œå—"><span>çœ‹é—¨ç‹—æœºåˆ¶ä¸­çš„æ£€æŸ¥é”è¿‡ç¨‹æ˜¯åŸå­æ“ä½œå—ï¼Ÿ</span></a></h4><p>æ˜¯çš„ï¼ŒRedisson ä½¿ç”¨äº† Lua è„šæœ¬æ¥ä¿è¯é”æ£€æŸ¥çš„åŸå­æ€§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250603092903.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šçœ‹é—¨ç‹— lua è„šæœ¬æ£€æŸ¥é”" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šçœ‹é—¨ç‹— lua è„šæœ¬æ£€æŸ¥é”</figcaption></figure><p>Redis åœ¨æ‰§è¡Œ Lua è„šæœ¬æ—¶ï¼Œä¼šæŠŠæ•´ä¸ªè„šæœ¬å½“ä½œä¸€ä¸ªå‘½ä»¤æ¥å¤„ç†ï¼ŒæœŸé—´ä¸ä¼šæ‰§è¡Œå…¶ä»–å‘½ä»¤ã€‚æ‰€ä»¥ hexists æ£€æŸ¥å’Œ expire ç»­æœŸæ˜¯åŸå­æ‰§è¡Œçš„ã€‚</p><h4 id="redlockä½ äº†è§£å¤šå°‘" tabindex="-1"><a class="header-anchor" href="#redlockä½ äº†è§£å¤šå°‘"><span>Redlockä½ äº†è§£å¤šå°‘ï¼Ÿ</span></a></h4><p>Redlock æ˜¯ Redis ä½œè€… antirez æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼é”ç®—æ³•ï¼Œç”¨äºè§£å†³å•ä¸ª Redis å®ä¾‹ä½œä¸ºåˆ†å¸ƒå¼é”æ—¶å­˜åœ¨çš„å•ç‚¹æ•…éšœé—®é¢˜ã€‚</p><p>Redlock çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡åœ¨å¤šä¸ªå®Œå…¨ç‹¬ç«‹çš„ Redis å®ä¾‹ä¸ŠåŒæ—¶è·å–é”æ¥å®ç°å®¹é”™ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240816113330.png" alt="äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedissonRedLock" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedissonRedLock</figcaption></figure><p>minLocksAmount æ–¹æ³•è¿”å›çš„ <code>locks.size()/2 + 1</code>ï¼Œæ­£æ˜¯ Redlock ç®—æ³•è¦æ±‚çš„å°‘æ•°æœä»å¤šæ•°åŸåˆ™ã€‚failedLocksLimit æ–¹æ³•ä¼šè®¡ç®—å…è®¸å¤±è´¥çš„é”æ•°é‡ï¼Œç¡®ä¿å³ä½¿éƒ¨åˆ†å®ä¾‹å¤±è´¥ï¼Œåªè¦æˆåŠŸçš„å®ä¾‹æ•°é‡è¶…è¿‡ä¸€åŠå°±è®¤ä¸ºè·å–é”æˆåŠŸã€‚</p><p>çº¢é”ä¼šå°è¯•ä¾æ¬¡å‘æ‰€æœ‰ Redis å®ä¾‹è·å–é”ï¼Œå¹¶è®°å½•æˆåŠŸè·å–çš„é”æ•°é‡ï¼Œå½“æ•°é‡è¾¾åˆ° minLocksAmount æ—¶å°±è®¤ä¸ºè·å–æˆåŠŸï¼Œå¦åˆ™é‡Šæ”¾å·²è·å–çš„é”å¹¶è¿”å›å¤±è´¥ã€‚</p><p>è™½ç„¶ Redlock å­˜åœ¨ä¸€äº›äº‰è®®ï¼Œæ¯”å¦‚è¯´æ—¶é’Ÿæ¼‚ç§»é—®é¢˜ã€ç½‘ç»œåˆ†åŒºå¯¼è‡´çš„è„‘è£‚é—®é¢˜ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸€ä¸ªç›¸å¯¹æˆç†Ÿçš„åˆ†å¸ƒå¼é”è§£å†³æ–¹æ¡ˆã€‚</p><h4 id="çº¢é”èƒ½ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾ä¸Šé”" tabindex="-1"><a class="header-anchor" href="#çº¢é”èƒ½ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾ä¸Šé”"><span>çº¢é”èƒ½ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾ä¸Šé”ï¼Ÿ</span></a></h4><p>ä¸èƒ½ï¼ŒRedlock æ— æ³•ä¿è¯ç™¾åˆ†ç™¾ä¸Šé”æˆåŠŸï¼Œè¿™æ˜¯ç”±åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœ¬è´¨ç‰¹æ€§å†³å®šçš„ã€‚</p><p>å½“æœ‰ç½‘ç»œåˆ†åŒºæ—¶ï¼Œå®¢æˆ·ç«¯å¯èƒ½æ— æ³•ä¸è¶³å¤Ÿæ•°é‡çš„ Redis å®ä¾‹é€šä¿¡ã€‚æ¯”å¦‚åœ¨ 5 ä¸ª Redis å®ä¾‹çš„éƒ¨ç½²ä¸­ï¼Œå¦‚æœç½‘ç»œåˆ†åŒºå¯¼è‡´å®¢æˆ·ç«¯åªèƒ½è®¿é—®åˆ° 2 ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆæ— è®ºå¦‚ä½•éƒ½æ— æ³•æ»¡è¶³çº¢é”è¦æ±‚çš„å°‘æ•°æœä»å¤šæ•°åŸåˆ™ï¼Œè·å–é”çš„æ—¶å€™å¿…ç„¶å¤±è´¥ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryLock</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> waitTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> leaseTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> unit) throws InterruptedException {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ListIterator</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RLock</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> iterator </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> locks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">listIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> iterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hasNext</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        RLock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> iterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lockAcquired</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            lockAcquired </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(awaitTime, newLeaseTime, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MILLISECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RedisResponseTimeoutException</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            lockAcquired </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // ç½‘ç»œè¶…æ—¶å¯¼è‡´å¤±è´¥</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            lockAcquired </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // å…¶ä»–å¼‚å¸¸å¯¼è‡´å¤±è´¥</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å¦‚æœå‰©ä½™å¯å°è¯•çš„å®ä¾‹æ•°é‡ä¸è¶³ä»¥è¾¾åˆ°å¤šæ•°æ´¾ï¼Œç›´æ¥é€€å‡º</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">locks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> acquiredLocks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> failedLocksLimit</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å¤šæ•°æ´¾è¦æ±‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">acquiredLocks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> minLocksAmount</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(locks)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        unlockInner</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(acquiredLocks)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // æœªè¾¾åˆ°å¤šæ•°æ´¾ï¼Œè·å–å¤±è´¥</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ—¶é’Ÿæ¼‚ç§»ä¹Ÿä¼šå½±å“æˆåŠŸç‡ã€‚å³ä½¿æ‰€æœ‰å®ä¾‹éƒ½å¯è¾¾ï¼Œå¦‚æœå„ä¸ª Redis å®ä¾‹ä¹‹é—´å­˜åœ¨æ˜æ˜¾çš„æ—¶é’Ÿæ¼‚ç§»ï¼Œæˆ–è€…å®¢æˆ·ç«¯åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­è€—æ—¶è¿‡é•¿ï¼Œæ¯”å¦‚ç½‘ç»œå»¶è¿Ÿã€GC åœé¡¿ç­‰ï¼Œéƒ½å¯èƒ½ä¼šå¯¼è‡´é”åœ¨è·å–å®Œæˆå‰å°±è¿‡æœŸï¼Œä»è€Œè·å–å¤±è´¥ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥é€šè¿‡é‡è¯•æœºåˆ¶æ¥æé«˜é”çš„æˆåŠŸç‡ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> maxRetries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(waitTime, leaseTime, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MILLISECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(retryDelay);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é¡¹ç›®ä¸­æœ‰ç”¨åˆ°åˆ†å¸ƒå¼é”å—" tabindex="-1"><a class="header-anchor" href="#é¡¹ç›®ä¸­æœ‰ç”¨åˆ°åˆ†å¸ƒå¼é”å—"><span>é¡¹ç›®ä¸­æœ‰ç”¨åˆ°åˆ†å¸ƒå¼é”å—ï¼Ÿ</span></a></h4><p>åœ¨<a href="https://javabetter.cn/zhishixingqiu/pmhub.html" target="_blank" rel="noopener noreferrer">PmHub</a>é¡¹ç›®ä¸­ï¼Œæˆ‘æœ‰ä½¿ç”¨ Redission çš„åˆ†å¸ƒå¼é”æ¥ç¡®ä¿æµç¨‹çŠ¶æ€çš„æ›´æ–°æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸”ä¸è¢«å…¶ä»–æµç¨‹æœåŠ¡å¹²æ‰°ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250602112537.png" alt="PmHubï¼šåˆ†å¸ƒå¼é”ä¿éšœæµç¨‹çŠ¶æ€æ›´æ–°" tabindex="0" loading="lazy"><figcaption>PmHubï¼šåˆ†å¸ƒå¼é”ä¿éšœæµç¨‹çŠ¶æ€æ›´æ–°</figcaption></figure><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯ Java åç«¯å®ä¹ ä¸€é¢åŸé¢˜ï¼šåˆ†å¸ƒå¼é”ç”¨äº† Redis çš„ä»€ä¹ˆæ•°æ®ç»“æ„</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°å…¬å¸é¢ç»åˆé›†åŒå­¦ 1 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedisson çš„åº•å±‚åŸç†ï¼Ÿä»¥åŠä¸ SETNX çš„åŒºåˆ«ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç™¾åº¦é¢ç»åŒå­¦ 1 æ–‡å¿ƒä¸€è¨€ 25 å®ä¹  Java åç«¯é¢è¯•åŸé¢˜ï¼šredis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ï¼Ÿsetnxï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³åŒå­¦ F é¢è¯•åŸé¢˜ï¼šè‡ªå·±å®ç° redis åˆ†å¸ƒå¼é”çš„å‘ï¼ˆä¸»åŠ¨æäº† Redissionï¼‰</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯äº‘æ™ºé¢ç»åŒå­¦ 20 äºŒé¢é¢è¯•åŸé¢˜ï¼šredission çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ setnx + lua è„šæœ¬ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æ”¶é’±å§é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šç³»ç»Ÿé‡Œé¢åˆ†å¸ƒå¼é”æ˜¯æ€ä¹ˆåšçš„ï¼Ÿä½ æåˆ°äº†redlockï¼Œé‚£å®ƒæœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿçº¢é”èƒ½ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾ä¸Šé”ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 21 æŠ–éŸ³å•†åŸä¸€é¢é¢è¯•åŸé¢˜ï¼šåŠ åˆ†å¸ƒå¼é”æ—¶rediså¦‚ä½•ä¿è¯ä¸ä¼šå‘ç”Ÿå†²çªï¼Ÿåˆ†å¸ƒå¼é”è¿‡æœŸæ€ä¹ˆåŠï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æ‹¼å¤šå¤šé¢ç»åŒå­¦ 8 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedisåˆ†å¸ƒå¼é”å¦‚ä½•å®ç°çš„</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç™¾åº¦åŒå­¦ 4 é¢è¯•åŸé¢˜ï¼šSetnx,çŸ¥é“å—? ç”¨è¿™ä¸ªåŠ é”æœ‰ä»€ä¹ˆé—®é¢˜å—?æ€ä¹ˆè§£å†³?</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„é˜¿é‡Œç³»é¢ç»åŒå­¦ 19 é¥¿äº†ä¹ˆé¢è¯•åŸé¢˜ï¼šåˆ†å¸ƒå¼é”ç”¨rediså®ç°æ€è·¯</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 9 é¢è¯•åŸé¢˜ï¼šredisçš„åˆ†å¸ƒå¼é”æœ‰äº†è§£è¿‡å—</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šredisé”æœ‰å‡ ç§å®ç°æ–¹å¼</li></ol></blockquote><div style="border:1px solid #096dd9;padding:20px;border-radius:15px;background-color:#f0f8ff;max-width:800px;margin:0 auto;box-shadow:0 4px 8px rgba(0, 0, 0, 0.1);"><p>å—¨å—¨å—¨ï¼Œæ—¶éš”ä¸¤å¹´ï¼Œé¢æ¸£é€†è¢­<a href="https://javabetter.cn/sidebar/sanfene/nixi.html" style="color:#096dd9;text-decoration:none;font-weight:bold;">ç¬¬äºŒç‰ˆ PDF ç»ˆäºå¯ä»¥ä¸‹è½½äº†</a>ã€‚æˆ‘ä»¬åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼š</p><ol style="margin-left:20px;"><li><strong><span style="color:#d32f2f;">å¯¹äºé«˜é¢‘é¢˜</span></strong>ï¼šä¼šæ ‡æ³¨åœ¨ã€Š<a href="https://javabetter.cn/zhishixingqiu/mianshi.html" style="color:#096dd9;">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>ä¸­å‡ºç°çš„ä½ç½®ï¼Œå“ªå®¶å…¬å¸ï¼ŒåŸé¢˜æ˜¯ä»€ä¹ˆï¼›å¦‚æœä½ æƒ³èŠ‚çœæ—¶é—´çš„è¯ï¼Œå¯ä»¥ä¼˜å…ˆèƒŒè¯µè¿™äº›é¢˜ç›®ï¼Œå°½å¿«åšåˆ°çŸ¥å½¼çŸ¥å·±ï¼Œç™¾æˆ˜ä¸æ®†ã€‚</li><li><strong><span style="color:#d32f2f;">ç»“åˆé¡¹ç›®</span></strong>ï¼šåŒ…æ‹¬<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" style="color:#096dd9;">æŠ€æœ¯æ´¾</a>ã€<a href="https://t.zsxq.com/0bhcI0Gs6" style="color:#096dd9;">mydb</a>ã€<a href="https://javabetter.cn/zhishixingqiu/pmhub.html" style="color:#096dd9;">pmhub</a>æ¥ç»„ç»‡è¯­è¨€ï¼Œè®©é¢è¯•å®˜æœ€å¤§ç¨‹åº¦æ„Ÿå—åˆ°ä½ çš„è¯šæ„ï¼Œè€Œä¸æ˜¯æœºæ¢°åŒ–çš„èƒŒè¯µã€‚</li><li><strong><span style="color:#d32f2f;">ä¿®å¤é—®é¢˜</span></strong>ï¼šç¬¬ä¸€ç‰ˆä¸­å‡ºç°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬çƒå‹ä»¬çš„ç§ä¿¡åé¦ˆï¼Œç½‘ç«™ç•™è¨€åŒºçš„è¯„è®ºï¼Œä»¥åŠ<a href="https://github.com/itwanger/toBeBetterJavaer/issues" style="color:#096dd9;"> GitHub ä»“åº“ä¸­çš„ issue</a>ï¼Œè®©è¿™ä»½é¢è¯•æŒ‡å—æ›´åŠ å®Œå–„ã€‚</li><li><strong><span style="color:#d32f2f;">ä¼˜åŒ–æ’ç‰ˆ</span></strong>ï¼šå¢åŠ æ‰‹ç»˜å›¾ï¼Œé‡æ–°ç»„ç»‡ç­”æ¡ˆï¼Œä½¿å…¶æ›´åŠ å£è¯­åŒ–ï¼Œä»è€Œæ›´è´´è¿‘é¢è¯•å®˜çš„é¢„æœŸã€‚</li></ol><p>ä½ å¯ä»¥æ‰«ä¸‹é¢çš„äºŒç»´ç ï¼ˆæˆ–è€…é•¿æŒ‰è‡ªåŠ¨è¯†åˆ«ï¼‰å…³æ³¨ã€<b>æ²‰é»˜ç‹äºŒ</b>ã€‘å…¬ä¼—å·ï¼Œå‘é€å…³é”®å­— <b>222</b> æ¥è·å– PDF ç‰ˆæœ¬ï¼Œå¦‚æœé¢æ¸£é€†è¢­çœŸçš„å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¸Œæœ›èƒ½ç»™äºŒå“¥çš„å…¬ä¼—å·åŠ ä¸€ä¸ªæ˜Ÿæ ‡ï¼Œæ»¡è¶³æˆ‘é‚£ä¸€ä¸ç‚¹è™šè£å¿ƒï¼Œè¿™å°†æ˜¯æˆ‘æ›´æ–°ä¸‹å»çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p><div style="text-align:center;margin:20px 0;"><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width:100%;height:auto;border-radius:10px;"></div><p>é¢æ¸£é€†è¢­çš„æ•´ç†å·¥ä½œçœŸçš„å¤ªä¸å®¹æ˜“äº†ï¼ŒèŠ±äº†æˆ‘å¥½å¤šå¥½å¤šçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œå†…å®¹å®Œå…¨å…è´¹ï¼Œä½†è´¨é‡å´æœ‰å£çš†ç¢‘ï¼Œå°±æ˜¯ä¸ºäº†åšä¸€ç‚¹çœŸæ­£æœ‰æ„ä¹‰çš„ã€çº¯ç²¹çš„äº‹æƒ…ã€‚</p></div><p>memoï¼š2025 å¹´ 6 æœˆ 3 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">çƒå‹çš„ç®€å†</a>æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ª 211 æœ¬ç§‘ã€åŒ—äº¬å¤§å­¦è½¯å¾®å­¦é™¢çš„çƒå‹ï¼Œæˆ‘åªèƒ½è¯´ï¼Œæ˜Ÿçƒçš„çƒå‹çœŸæ˜¯äººæ‰æµæµå•Šï¼ç¥å¤§å®¶éƒ½æœ‰ä¸€ä¸ªç¾å¥½çš„æœªæ¥ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250603100457.png" alt="åŒ—äº¬å¤§å­¦ç¡•çš„çƒå‹" tabindex="0" loading="lazy"><figcaption>åŒ—äº¬å¤§å­¦ç¡•çš„çƒå‹</figcaption></figure><h2 id="åº•å±‚ç»“æ„" tabindex="-1"><a class="header-anchor" href="#åº•å±‚ç»“æ„"><span>åº•å±‚ç»“æ„</span></a></h2><h3 id="_49-ğŸŒŸrediséƒ½æœ‰å“ªäº›åº•å±‚æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_49-ğŸŒŸrediséƒ½æœ‰å“ªäº›åº•å±‚æ•°æ®ç»“æ„"><span>49.ğŸŒŸRediséƒ½æœ‰å“ªäº›åº•å±‚æ•°æ®ç»“æ„ï¼Ÿ</span></a></h3><p>Redis ä¹‹æ‰€ä»¥å¿«ï¼Œé™¤äº†åŸºäºå†…å­˜è¯»å†™ä¹‹å¤–ï¼Œè¿˜æœ‰å¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯å®ƒç²¾å¿ƒè®¾è®¡çš„åº•å±‚æ•°æ®ç»“æ„ã€‚Redis æ€»å…±æœ‰ 8 ç§æ ¸å¿ƒçš„åº•å±‚æ•°æ®ç»“æ„ï¼Œæˆ‘æŒ‰ç…§é‡è¦ç¨‹åº¦æ¥è¯´ä¸€ä¸‹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-a1b2d2f9-6895-4749-9bda-9314f08bca68.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis Objectå¯¹åº”çš„æ˜ å°„" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis Objectå¯¹åº”çš„æ˜ å°„</figcaption></figure><p>é¦–å…ˆæ˜¯ SDSï¼Œè¿™æ˜¯ Redis è‡ªå·±å®ç°çš„åŠ¨æ€å­—ç¬¦ä¸²ï¼Œå®ƒä¿ç•™äº† C è¯­è¨€åŸç”Ÿçš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œæ‰€ä»¥è·å–é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦æ˜¯ <code>O(1)</code>ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿˜æ”¯æŒåŠ¨æ€æ‰©å®¹ï¼Œä»¥åŠå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-7c038f2c-b5ee-4229-9449-713fab3b1855.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šSDS" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šSDS</figcaption></figure><p>ç„¶åæ˜¯å­—å…¸ï¼Œæ›´åº•å±‚æ˜¯ç”¨æ•°ç»„+é“¾è¡¨å®ç°çš„å“ˆå¸Œè¡¨ã€‚å®ƒçš„è®¾è®¡å¾ˆå·§å¦™ï¼Œç”¨äº†ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œå¹³æ—¶ç”¨ç¬¬ä¸€ä¸ªï¼Œrehash çš„æ—¶å€™ç”¨ç¬¬äºŒä¸ªï¼Œè¿™æ ·å¯ä»¥æ¸è¿›å¼åœ°è¿›è¡Œæ‰©å®¹ï¼Œä¸ä¼šé˜»å¡å¤ªä¹…ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-9934b4a2-c253-4d42-acf4-c6c940840779.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå­—å…¸" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå­—å…¸</figcaption></figure><p>æ¥ä¸‹æ¥å‹ç¼©åˆ—è¡¨ ziplistï¼Œè¿™ä¸ªè®¾è®¡å¾ˆæœ‰æ„æ€ã€‚Redis ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œè®¾è®¡äº†è¿™ç§ç´§å‡‘å‹çš„æ•°æ®ç»“æ„ï¼ŒæŠŠæ‰€æœ‰å…ƒç´ è¿ç»­å­˜å‚¨åœ¨ä¸€å—å†…å­˜é‡Œã€‚ä½†æ˜¯å®ƒæœ‰ä¸ªè‡´å‘½é—®é¢˜å«&quot;è¿é”æ›´æ–°&quot;ï¼Œå°±æ˜¯å½“æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå¯¼è‡´åé¢æ‰€æœ‰çš„å…ƒç´ éƒ½è¦é‡æ–°ç¼–ç ï¼Œæ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250604112041.png" alt="Shubhi Jainï¼šZiplist" tabindex="0" loading="lazy"><figcaption>Shubhi Jainï¼šZiplist</figcaption></figure><p>ä¸ºäº†è§£å†³å‹ç¼©åˆ—è¡¨çš„é—®é¢˜ï¼ŒRedis åæ¥è®¾è®¡äº† quicklistã€‚è¿™ä¸ªè®¾è®¡æ€è·¯å¾ˆèªæ˜ï¼Œå®ƒæŠŠ ziplist æ‹†åˆ†æˆå°å—ï¼Œç„¶åç”¨åŒå‘é“¾è¡¨æŠŠè¿™äº›å°å—ä¸²èµ·æ¥ã€‚è¿™æ ·æ—¢ä¿æŒäº† ziplist èŠ‚çœå†…å­˜çš„ä¼˜åŠ¿ï¼Œåˆé¿å…äº†è¿é”æ›´æ–°çš„é—®é¢˜ï¼Œå› ä¸ºæ¯ä¸ªå°å—çš„ ziplist éƒ½ä¸ä¼šå¤ªå¤§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250604112357.png" alt="Mr.äºåšå®¢å›­ï¼šquicklist" tabindex="0" loading="lazy"><figcaption>Mr.äºåšå®¢å›­ï¼šquicklist</figcaption></figure><p>å†åæ¥ï¼ŒRedis åˆè®¾è®¡äº† listpackï¼Œè¿™ä¸ªå¯ä»¥è¯´æ˜¯ ziplist çš„å®Œç¾æ›¿ä»£å“ã€‚å®ƒæœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ¯ä¸ªå…ƒç´ åªè®°å½•è‡ªå·±çš„é•¿åº¦ï¼Œä¸è®°å½•å‰ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ï¼Œè¿™æ ·å°±å½»åº•è§£å†³äº†è¿é”æ›´æ–°çš„é—®é¢˜ã€‚Redis 5.0 å·²ç»ç”¨ listpack æ›¿æ¢äº† ziplistã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250604113025.png" alt="baseoncppï¼šlistpack" tabindex="0" loading="lazy"><figcaption>baseoncppï¼šlistpack</figcaption></figure><p>è·³è¡¨skiplist ä¸»è¦ç”¨åœ¨ ZSet ä¸­ã€‚å®ƒçš„è®¾è®¡å¾ˆå·§å¦™ï¼Œé€šè¿‡å¤šå±‚æŒ‡é’ˆæ¥å®ç°å¿«é€ŸæŸ¥æ‰¾ï¼Œå¹³å‡æ—¶é—´å¤æ‚åº¦æ˜¯ <code>O(log N)</code>ã€‚ç›¸æ¯”çº¢é»‘æ ‘ï¼Œè·³è¡¨çš„å®ç°æ›´ç®€å•ï¼Œè€Œä¸”æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œè¿™å¯¹ Redis çš„æœ‰åºé›†åˆæ¥è¯´å¾ˆé‡è¦ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-886ee2a8-fb02-4908-bbba-d4ad2a211094.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šè·³è¡¨" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šè·³è¡¨</figcaption></figure><p>è¿˜æœ‰æ•´æ•°é›†åˆintsetï¼Œå½“ Set ä¸­éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ æ•°é‡è¾ƒå°‘æ—¶ä½¿ç”¨ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ªæœ‰åºæ•°ç»„ï¼ŒæŸ¥æ‰¾ç”¨çš„äºŒåˆ†æ³•ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250604113520.png" alt="zhangtielei.comï¼šintset" tabindex="0" loading="lazy"><figcaption>zhangtielei.comï¼šintset</figcaption></figure><p>æœ€åæ˜¯åŒå‘é“¾è¡¨LinkedListï¼Œæ—©æœŸç‰ˆæœ¬çš„ Redis ä¼šåœ¨ List ä¸­ç”¨åˆ°ï¼Œä½† Redis 3.2 åå°±è¢« quicklist æ›¿ä»£äº†ï¼Œå› ä¸ºçº¯é“¾è¡¨çš„é—®é¢˜æ˜¯å†…å­˜ä¸è¿ç»­ï¼Œå½±å“ CPU ç¼“å­˜æ€§èƒ½ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250604114217.png" alt="pdaiï¼šRedis åº•å±‚æ•°æ®ç»“æ„å’Œæ•°æ®ç±»å‹å…³ç³»" tabindex="0" loading="lazy"><figcaption>pdaiï¼šRedis åº•å±‚æ•°æ®ç»“æ„å’Œæ•°æ®ç±»å‹å…³ç³»</figcaption></figure><p>memoï¼š2025 å¹´ 6 æœˆ 4 æ—¥ï¼Œ<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">ä»Šå¤©æœ‰çƒå‹</a>å‘å–œæŠ¥è¯´æ‹¿åˆ°äº†äº¬ä¸œé›¶å”®çš„å®ä¹  offerï¼Œå¹¶ä¸”éƒ¨é—¨å’Œä¸šåŠ¡è¿˜æ˜¯æŒºä¸é”™çš„ï¼Œæ­å–œä»–ï¼6 æœˆä»½è¿˜æœ‰æœºä¼šï¼Œå†²ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250604114432.png" alt="çƒå‹æ‹¿åˆ°äº†äº¬ä¸œçš„ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†äº¬ä¸œçš„ offer</figcaption></figure><h4 id="ç®€å•ä»‹ç»ä¸‹é“¾è¡¨" tabindex="-1"><a class="header-anchor" href="#ç®€å•ä»‹ç»ä¸‹é“¾è¡¨"><span>ç®€å•ä»‹ç»ä¸‹é“¾è¡¨ï¼Ÿ</span></a></h4><p>Redis çš„ linkedlist æ˜¯â¼€ä¸ªåŒå‘â½†ç¯é“¾è¡¨ç»“æ„ï¼Œå’Œ Java ä¸­çš„ <a href="https://javabetter.cn/collection/linkedlist.html" target="_blank" rel="noopener noreferrer">LinkedList</a> ç±»ä¼¼ã€‚</p><p>èŠ‚ç‚¹ç”± listNode è¡¨ç¤ºï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰æŒ‡å‘å…¶å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå¤´èŠ‚ç‚¹çš„å‰ç½®å’Œå°¾èŠ‚ç‚¹çš„åç½®å‡æŒ‡å‘ nullã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-1adef9c0-8feb-4836-8997-84bda96e2498.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé“¾è¡¨linkedlist" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé“¾è¡¨linkedlist</figcaption></figure><h4 id="å…³äºæ•´æ•°é›†åˆ-èƒ½å†è¯¦ç»†è¯´è¯´å—" tabindex="-1"><a class="header-anchor" href="#å…³äºæ•´æ•°é›†åˆ-èƒ½å†è¯¦ç»†è¯´è¯´å—"><span>å…³äºæ•´æ•°é›†åˆï¼Œèƒ½å†è¯¦ç»†è¯´è¯´å—ï¼Ÿ</span></a></h4><p>æ•´æ•°é›†åˆæ˜¯ Redis ä¸­ä¸€ä¸ªéå¸¸ç²¾å·§çš„æ•°æ®ç»“æ„ï¼Œå½“ä¸€ä¸ª Set åªåŒ…å«æ•´æ•°å…ƒç´ ï¼Œå¹¶ä¸”æ•°é‡ä¸å¤šæ—¶ï¼Œé»˜è®¤ä¸è¶…è¿‡ 512 ä¸ªï¼ŒRedis å°±ä¼šç”¨ intset æ¥å­˜å‚¨è¿™äº›æ•°æ®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-833dbfb2-7c79-4e7b-a143-8a4a2936cdd8.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ•´æ•°é›†åˆintset" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ•´æ•°é›†åˆintset</figcaption></figure><p>intset æœ€æœ‰æ„æ€çš„åœ°æ–¹æ˜¯ç±»å‹å‡çº§æœºåˆ¶ã€‚å®ƒæœ‰ä¸‰ç§ç¼–ç æ–¹å¼ï¼š16ä½ã€32ä½å’Œ 64ä½ï¼Œä¼šæ ¹æ®å­˜å‚¨çš„æ•´æ•°å¤§å°åŠ¨æ€è°ƒæ•´ã€‚æ¯”å¦‚åŸæ¥å­˜çš„éƒ½æ˜¯å°æ•´æ•°ï¼Œç”¨ 16 ä½ç¼–ç å°±å¤Ÿäº†ï¼Œä½†çªç„¶æ’å…¥äº†ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼Œè¶…å‡ºäº† 16 ä½çš„èŒƒå›´ï¼Œè¿™æ—¶æ•´ä¸ªæ•°ç»„ä¼šå‡çº§åˆ° 32 ä½ç¼–ç ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> intset {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> encoding;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   // ç¼–ç æ–¹å¼ï¼š16ä½ã€32ä½æˆ–64ä½</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> length;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     // å…ƒç´ æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int8_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> contents</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">[]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   // ä¿å­˜å…ƒç´ çš„æ•°ç»„</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} intset;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç„¶äº†ï¼Œè¿™ç§å‡çº§æ˜¯æœ‰ä»£ä»·çš„ï¼Œå› ä¸ºéœ€è¦é‡æ–°åˆ†é…å†…å­˜å¹¶å¤åˆ¶æ•°æ®ï¼Œå¹¶ä¸”æ˜¯ä¸å¯é€†çš„ï¼Œä½†å®ƒçš„å¥½å¤„æ˜¯å¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´ï¼Œç‰¹åˆ«æ˜¯åœ¨å­˜å‚¨å¤§é‡å°æ•´æ•°æ—¶ã€‚</p><p>å¦å¤–ï¼Œæ‰€æœ‰å…ƒç´ åœ¨æ•°ç»„ä¸­æŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºæ’åˆ—ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ¥å®šä½å…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º <code>O(log N)</code>ã€‚</p><h4 id="è¯´ä¸€ä¸‹zset-çš„åº•å±‚åŸç†" tabindex="-1"><a class="header-anchor" href="#è¯´ä¸€ä¸‹zset-çš„åº•å±‚åŸç†"><span>è¯´ä¸€ä¸‹zset çš„åº•å±‚åŸç†ï¼Ÿ</span></a></h4><p>ZSet æ˜¯ Redis æœ€å¤æ‚çš„æ•°æ®ç±»å‹ï¼Œå®ƒæœ‰ä¸¤ç§åº•å±‚å®ç°æ–¹å¼ï¼šå‹ç¼©åˆ—è¡¨å’Œè·³è¡¨ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250605132505.png" alt="0xcafebabeï¼šzset çš„åº•å±‚å®ç°" tabindex="0" loading="lazy"><figcaption>0xcafebabeï¼šzset çš„åº•å±‚å®ç°</figcaption></figure><p>å½“ä¿å­˜çš„å…ƒç´ æ•°é‡å°‘äº 128 ä¸ªï¼Œä¸”ä¿å­˜çš„æ‰€æœ‰å…ƒç´ å¤§å°éƒ½å°äº 64 å­—èŠ‚æ—¶ï¼ŒRedis ä¼šé‡‡ç”¨å‹ç¼©åˆ—è¡¨çš„ç¼–ç æ–¹å¼ï¼›å¦åˆ™å°±ç”¨è·³è¡¨ã€‚</p><p>å½“ç„¶ï¼Œè¿™ä¸¤ä¸ªæ¡ä»¶éƒ½å¯ä»¥é€šè¿‡å‚æ•°è¿›è¡Œè°ƒæ•´ã€‚</p><p>é€‰æ‹©å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°æ—¶ï¼Œæ¯ä¸ªå…ƒç´ ä¼šä½¿ç”¨ä¸¤ä¸ªç´§æŒ¨åœ¨ä¸€èµ·çš„èŠ‚ç‚¹æ¥ä¿å­˜ï¼šç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„æˆå‘˜ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„åˆ†å€¼ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250605134114.png" alt="0xcafebabeï¼šzset ä½¿ç”¨å‹ç¼©åˆ—è¡¨" tabindex="0" loading="lazy"><figcaption>0xcafebabeï¼šzset ä½¿ç”¨å‹ç¼©åˆ—è¡¨</figcaption></figure><p>æ‰€æœ‰å…ƒç´ æŒ‰åˆ†å€¼ä»å°åˆ°å¤§æœ‰åºæ’åˆ—ï¼Œå°çš„æ”¾åœ¨é è¿‘è¡¨å¤´çš„ä½ç½®ï¼Œå¤§çš„æ”¾åœ¨é è¿‘è¡¨å°¾çš„ä½ç½®ã€‚</p><p>ä½†è·³è¡¨çš„ç¼ºç‚¹æ˜¯æŸ¥æ‰¾åªèƒ½æŒ‰é¡ºåºè¿›è¡Œï¼Œæ—¶é—´å¤æ‚åº¦ä¸º <code>O(N)</code>ï¼Œè€Œä¸”åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œæ’å…¥å’Œåˆ é™¤æ“ä½œè¿˜å¯èƒ½ä¼šå¼•èµ·è¿é”æ›´æ–°ã€‚</p><p>å½“å…ƒç´ æ•°é‡è¾ƒå¤šæˆ–å…ƒç´ è¾ƒå¤§æ—¶ï¼ŒRedis ä¼šä½¿ç”¨ skiplist çš„ç¼–ç æ–¹å¼ï¼›è¿™ä¸ªè®¾è®¡éå¸¸çš„å·§å¦™ï¼ŒåŒæ—¶ä½¿ç”¨äº†ä¸¤ç§æ•°æ®ç»“æ„ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> zset {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    zskiplist </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">zsl;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // è·³è·ƒè¡¨</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    dict </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">dict;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">      // å­—å…¸</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} zset;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·³è¡¨æŒ‰åˆ†æ•°æœ‰åºä¿å­˜æ‰€æœ‰å…ƒç´ ï¼Œä¸”æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚ <code>ZRANGE</code>ã€<code>ZRANGEBYSCORE</code>ï¼‰ï¼Œå¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º <code>O(log N)</code>ã€‚è€Œå“ˆå¸Œè¡¨åˆ™ç”¨æ¥å­˜å‚¨æˆå‘˜å’Œåˆ†å€¼çš„æ˜ å°„å…³ç³»ï¼ŒæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ä¸º <code>O(1)</code>ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250605135850.png" alt="0xcafebabeï¼šzset ä½¿ç”¨è·³è¡¨" tabindex="0" loading="lazy"><figcaption>0xcafebabeï¼šzset ä½¿ç”¨è·³è¡¨</figcaption></figure><p>è™½ç„¶åŒæ—¶ä½¿ç”¨ä¸¤ç§ç»“æ„ï¼Œä½†å®ƒä»¬ä¼šé€šè¿‡æŒ‡é’ˆæ¥å…±äº«ç›¸åŒå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œå› æ­¤ä¸ä¼šæµªè´¹é¢å¤–çš„å†…å­˜ã€‚</p><h4 id="ä½ çŸ¥é“ä¸ºä»€ä¹ˆredis-7-0è¦ç”¨listpackæ¥æ›¿ä»£ziplistå—" tabindex="-1"><a class="header-anchor" href="#ä½ çŸ¥é“ä¸ºä»€ä¹ˆredis-7-0è¦ç”¨listpackæ¥æ›¿ä»£ziplistå—"><span>ä½ çŸ¥é“ä¸ºä»€ä¹ˆRedis 7.0è¦ç”¨listpackæ¥æ›¿ä»£ziplistå—ï¼Ÿ</span></a></h4><p>ç­”ï¼šä¸»è¦æ˜¯ä¸ºäº†è§£å†³å‹ç¼©åˆ—è¡¨çš„ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜â€”â€”è¿é”æ›´æ–°ã€‚åœ¨å‹ç¼©åˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦è®°å½•å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ä¿¡æ¯ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250607094736.png" alt="wenfh2020.comï¼šredis ziplist" tabindex="0" loading="lazy"><figcaption>wenfh2020.comï¼šredis ziplist</figcaption></figure><p>å½“æ’å…¥æˆ–åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœè¿™ä¸ªæ“ä½œå¯¼è‡´æŸä¸ªèŠ‚ç‚¹çš„é•¿åº¦å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆåç»­çš„èŠ‚ç‚¹å¯èƒ½éƒ½éœ€è¦æ›´æ–°å®ƒä»¬å­˜å‚¨çš„&quot;å‰ä¸€ä¸ªèŠ‚ç‚¹é•¿åº¦&quot;å­—æ®µã€‚æœ€åçš„æƒ…å†µä¸‹ï¼Œä¸€æ¬¡æ“ä½œå¯èƒ½è§¦å‘æ•´ä¸ªé“¾è¡¨çš„æ›´æ–°ï¼Œæ—¶é—´å¤æ‚åº¦ä¼šä» <code>O(1)</code>é€€åŒ–åˆ° <code>O(nÂ²)</code>ã€‚</p><p>è€Œ listpack çš„è®¾è®¡ç†å¿µå®Œå…¨ä¸åŒã€‚å®ƒè®©æ¯ä¸ªèŠ‚ç‚¹åªè®°å½•è‡ªå·±çš„é•¿åº¦ä¿¡æ¯ï¼Œä¸å†ä¾èµ–å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ã€‚è¿™æ ·å°±ä»æ ¹æœ¬ä¸Šé¿å…äº†è¿é”æ›´æ–°çš„é—®é¢˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240403105313.png" alt="æå®¢æ—¶é—´ï¼šlistpack" tabindex="0" loading="lazy"><figcaption>æå®¢æ—¶é—´ï¼šlistpack</figcaption></figure><p>listpack ä¸­çš„èŠ‚ç‚¹ä¸å†ä¿å­˜å…¶å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ï¼Œè€Œæ˜¯ä¿å­˜å½“å‰èŠ‚ç‚¹çš„ç¼–ç ç±»å‹ã€æ•°æ®å’Œé•¿åº¦ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240403105754.png" alt="æå®¢æ—¶é—´ï¼šlistpack çš„å…ƒç´ " tabindex="0" loading="lazy"><figcaption>æå®¢æ—¶é—´ï¼šlistpack çš„å…ƒç´ </figcaption></figure><h4 id="è¿é”æ›´æ–°æ˜¯æ€ä¹ˆå‘ç”Ÿçš„" tabindex="-1"><a class="header-anchor" href="#è¿é”æ›´æ–°æ˜¯æ€ä¹ˆå‘ç”Ÿçš„"><span>è¿é”æ›´æ–°æ˜¯æ€ä¹ˆå‘ç”Ÿçš„ï¼Ÿ</span></a></h4><p>æ¯”å¦‚è¯´æˆ‘ä»¬æœ‰ä¸€ä¸ªå‹ç¼©åˆ—è¡¨ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªèŠ‚ç‚¹çš„é•¿åº¦éƒ½æ˜¯ 253 ä¸ªå­—èŠ‚ã€‚åœ¨ ziplist çš„ç¼–ç ä¸­ï¼Œå¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦å°äº 254 å­—èŠ‚ï¼Œæˆ‘ä»¬åªéœ€è¦ 1 ä¸ªå­—èŠ‚æ¥å­˜å‚¨è¿™ä¸ªé•¿åº¦ä¿¡æ¯ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250607100252.png" alt="Hello Jellyï¼šè¿é”æ›´æ–°" tabindex="0" loading="lazy"><figcaption>Hello Jellyï¼šè¿é”æ›´æ–°</figcaption></figure><p>ä½†å¦‚æœåœ¨è¿™äº›èŠ‚ç‚¹å‰é¢æ’å…¥ä¸€ä¸ªé•¿åº¦ä¸º 254 å­—èŠ‚çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåŸæ¥åªéœ€è¦ 1 ä¸ªå­—èŠ‚å­˜å‚¨é•¿åº¦çš„èŠ‚ç‚¹ç°åœ¨éœ€è¦ 5 ä¸ªå­—èŠ‚æ¥å­˜å‚¨é•¿åº¦ä¿¡æ¯ã€‚è¿™å°±ä¼šå¯¼è‡´åç»­æ‰€æœ‰èŠ‚ç‚¹çš„é•¿åº¦ä¿¡æ¯éƒ½éœ€è¦æ›´æ–°ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨å•†ä¸šåŒ–ä¸€é¢çš„åŸé¢˜ï¼šè¯´è¯´ Redis çš„ zsetï¼Œä»€ä¹ˆæ˜¯è·³è¡¨ï¼Œæ’å…¥ä¸€ä¸ªèŠ‚ç‚¹è¦æ„å»ºå‡ å±‚ç´¢å¼•</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 9 é£ä¹¦åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„æ•°æ®ç±»å‹ï¼ŒZSet çš„å®ç°</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³æš‘æœŸå®ä¹ åŒå­¦ E ä¸€é¢é¢è¯•åŸé¢˜ï¼šä½ çŸ¥é“ Redis çš„ zset åº•å±‚å®ç°å—</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 23 QQ åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šzset çš„åº•å±‚åŸç†</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 7 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´ä¸€ä¸‹ ZSet åº•å±‚ç»“æ„</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢åŒå­¦ 9 ä¸€é¢é¢è¯•åŸé¢˜ï¼šredisçš„æ•°æ®ç»“æ„åº•å±‚åŸç†ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 27 äº‘åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šZsetçš„åº•å±‚å®ç°ï¼Ÿ</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 9 é¢è¯•é¢˜ç›®åŸé¢˜ï¼šZsetçš„åº•å±‚å¦‚ä½•å®ç°ï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 6 æœˆ 5 æ—¥ï¼Œä»Šå¤©æœ‰çƒå‹åœ¨<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">VIPç¾¤é‡Œ</a>å’¨è¯¢ offer çš„é€‰æ‹©ï¼Œä¸€ä¸ªæ‹¼å¤šå¤šï¼Œä¸€ä¸ªå¿«æ‰‹ï¼ŒçœŸè®©äººç¾¡æ…•çš„è¦æ­»å•Šï¼ŒğŸ˜„</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250605142339.png" alt="æ‹¼å¤šå¤šå’Œå¿«æ‰‹çš„ offer é€‰æ‹©" tabindex="0" loading="lazy"><figcaption>æ‹¼å¤šå¤šå’Œå¿«æ‰‹çš„ offer é€‰æ‹©</figcaption></figure><h3 id="_50-redis-ä¸ºä»€ä¹ˆä¸ç”¨-c-è¯­è¨€çš„åŸç”Ÿå­—ç¬¦ä¸²" tabindex="-1"><a class="header-anchor" href="#_50-redis-ä¸ºä»€ä¹ˆä¸ç”¨-c-è¯­è¨€çš„åŸç”Ÿå­—ç¬¦ä¸²"><span>50.Redis ä¸ºä»€ä¹ˆä¸ç”¨ C è¯­è¨€çš„åŸç”Ÿå­—ç¬¦ä¸²ï¼Ÿ</span></a></h3><p>ç¬¬ä¸€ï¼ŒC è¯­è¨€çš„å­—ç¬¦ä¸²å…¶å®å°±æ˜¯å­—ç¬¦æ•°ç»„ï¼Œä»¥ <code>\0</code> ç»“å°¾ï¼Œè¿™æ„å‘³ç€å¦‚æœæ•°æ®æœ¬èº«åŒ…å« <code>\0</code> å­—èŠ‚ï¼Œå°±ä¼šè¢«è¯¯è®¤ä¸ºå­—ç¬¦ä¸²ç»“æŸã€‚ä½† Redis éœ€è¦å­˜å‚¨å„ç§ç±»å‹çš„æ•°æ®ï¼ŒåŒ…æ‹¬å›¾ç‰‡ã€åºåˆ—åŒ–å¯¹è±¡ç­‰äºŒè¿›åˆ¶æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¸­å¾ˆå¯èƒ½åŒ…å« <code>\0</code>ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-2541fd26-4e84-467d-8d8c-c731154a85d7.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šCè¯­è¨€çš„å­—ç¬¦ä¸²" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šCè¯­è¨€çš„å­—ç¬¦ä¸²</figcaption></figure><p>ç¬¬äºŒï¼Œå¦‚æœéœ€è¦è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼ŒC è¯­è¨€åªèƒ½è°ƒç”¨ <code>strlen()</code> å‡½æ•°ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ <code>O(N)</code>ï¼Œå› ä¸ºè¦éå†æ•´ä¸ªå­—ç¬¦ä¸²ç›´åˆ°é‡åˆ° <code>\0</code>ã€‚</p><p>ç¬¬ä¸‰ï¼ŒC è¯­è¨€çš„å­—ç¬¦ä¸²ä¸ä¼šè‡ªåŠ¨æ£€æŸ¥è¾¹ç•Œï¼Œå¦‚æœå¾€ä¸€ä¸ªå­—ç¬¦æ•°ç»„é‡Œå†™å…¥è¶…è¿‡å…¶å®¹é‡çš„æ•°æ®ï¼Œå°±ä¼šå‡ºç°ç¼“å†²åŒºæº¢å‡ºã€‚</p><p>ç¬¬å››ï¼ŒC è¯­è¨€çš„å­—ç¬¦ä¸²ä¸æ”¯æŒåŠ¨æ€æ‰©å®¹ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹å†…å®¹ï¼Œå°±å¿…é¡»é‡æ–°åˆ†é…å†…å­˜å¹¶å¤åˆ¶æ•°æ®ï¼Œå¼€é”€å¾ˆå¤§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-fc26a4e7-1c8d-4e82-b7f8-1f6b43d16d38.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis sds" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis sds</figcaption></figure><p>Redis è®¾è®¡çš„ SDS å®Œç¾è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œè·å–é•¿åº¦å¯ä»¥ç›´æ¥é€šè¿‡ <code>len</code> å­—æ®µï¼Œæ—¶é—´å¤æ‚åº¦ä¸º <code>O(1)</code>ï¼›<code>free</code> å­—æ®µä¼šè®°å½•å‰©ä½™ç©ºé—´ï¼Œå› æ­¤ Redis å¯ä»¥æ ¹æ®é¢„åˆ†é…ç­–ç•¥åŠ¨æ€æ‰©å®¹ï¼Œä¸ç”¨åœ¨è¿½åŠ æ•°æ®æ—¶é‡æ–°åˆ†é…å†…å­˜ï¼›å¹¶ä¸”ä¸ä¾èµ–äº <code>\0</code> ç»“å°¾ï¼Œå¯ä»¥å­˜å‚¨ä»»æ„äºŒè¿›åˆ¶æ•°æ®ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sds {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> len;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // å­—ç¬¦ä¸²é•¿åº¦</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> free;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       // å‰©ä½™ç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    char</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> buf</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">[]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     // å­—ç¬¦æ•°ç»„</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_51-ä½ ç ”ç©¶è¿‡-redis-çš„å­—å…¸æºç å—" tabindex="-1"><a class="header-anchor" href="#_51-ä½ ç ”ç©¶è¿‡-redis-çš„å­—å…¸æºç å—"><span>51.ä½ ç ”ç©¶è¿‡ Redis çš„å­—å…¸æºç å—ï¼Ÿ</span></a></h3><p>æ˜¯çš„ï¼Œæœ‰ç ”ç©¶è¿‡ã€‚Redis çš„å­—å…¸åˆ†ä¸ºä¸‰å±‚ï¼Œæœ€å¤–å±‚æ˜¯ä¸€ä¸ª dict ç»“æ„ï¼ŒåŒ…å«ä¸¤ä¸ªå“ˆå¸Œè¡¨ <code>ht[0]</code> å’Œ <code>ht[1]</code>ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ã€‚æ¯ä¸ªå“ˆå¸Œè¡¨ç”±ä¸€ä¸ªæ•°ç»„å’Œé“¾è¡¨ç»„æˆï¼Œæ•°ç»„ç”¨äºå¿«é€Ÿå®šä½ï¼Œé“¾è¡¨ç”¨äºè§£å†³å“ˆå¸Œå†²çªã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e08347a6-efd5-47c0-9adb-23baff82dbbd.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRediså­—å…¸" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRediså­—å…¸</figcaption></figure><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æœ€å¤–å±‚çš„å­—å…¸ç»“æ„</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dict {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    dictht </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ht</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       // ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼è¿™æ˜¯å…³é”®</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> rehashidx;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     // rehashç´¢å¼•ï¼Œ-1è¡¨ç¤ºæ²¡æœ‰è¿›è¡Œrehash</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} dict;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å“ˆå¸Œè¡¨ç»“æ„</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dictht {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    dictEntry </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">**</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">table;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // å“ˆå¸Œè¡¨æ•°ç»„</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> size;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // å“ˆå¸Œè¡¨å¤§å°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sizemask;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> used;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} dictht;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å“ˆå¸Œè¡¨èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dictEntry {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">key;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">              // é”®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    v;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                 // å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dictEntry </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">next;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // æŒ‡å‘ä¸‹ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} dictEntry;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å­—å…¸æœ€æ ¸å¿ƒçš„ç‰¹ç‚¹æ˜¯æ¸è¿›å¼ rehashï¼Œè¿™æ˜¯æˆ‘è§‰å¾—æœ€ç²¾å½©çš„éƒ¨åˆ†ã€‚ä¼ ç»Ÿçš„å“ˆå¸Œè¡¨æ‰©å®¹éƒ½æ˜¯ä¸€æ¬¡æ€§å®Œæˆçš„ï¼Œä½† Redis ä¸æ˜¯è¿™æ ·çš„ã€‚</p><p>å½“è´Ÿè½½å› å­è§¦å‘ rehash æ¡ä»¶æ—¶ï¼ŒRedis ä¼šä¸ºå“ˆå¸Œè¡¨1 åˆ†é…æ–°çš„ç©ºé—´ï¼Œé€šå¸¸æ˜¯å“ˆå¸Œè¡¨ 0 çš„ä¸¤å€å¤§å°ï¼Œç„¶åå°† rehashidx è®¾ç½®ä¸º 0ã€‚</p><p>æ¥ä¸‹æ¥çš„å…³é”®æ˜¯ï¼ŒRedis ä¸ä¼šä¸€æ¬¡æ€§æŠŠæ‰€æœ‰æ•°æ®ä»å“ˆå¸Œè¡¨0 è¿ç§»åˆ°å“ˆå¸Œè¡¨1ï¼Œè€Œæ˜¯æ¯æ¬¡æ“ä½œå­—å…¸æ—¶ï¼Œé¡ºä¾¿è¿ç§»å“ˆå¸Œè¡¨0 ä¸­ rehashidx ä½ç½®ä¸Šçš„æ‰€æœ‰é”®å€¼å¯¹ã€‚è¿ç§»å®Œä¸€ä¸ªæ§½ä½åï¼Œrehashidx é€’å¢ï¼Œç›´åˆ°æ•´ä¸ªå“ˆå¸Œè¡¨0 è¿ç§»å®Œæ¯•ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250606105102.png" alt="Kousik Nathï¼šRedis rehash" tabindex="0" loading="lazy"><figcaption>Kousik Nathï¼šRedis rehash</figcaption></figure><p>è¿™ç§è®¾è®¡çš„å·§å¦™ä¹‹å¤„åœ¨äºæŠŠ rehash çš„å¼€é”€åˆ†æ‘Šåˆ°äº†æ¯æ¬¡æ“ä½œä¸­ã€‚å‡è®¾æœ‰ä¸€ä¸ªå‡ ç™¾ä¸‡é”®çš„å“ˆå¸Œè¡¨ï¼Œå¦‚æœä¸€æ¬¡æ€§ rehash å¯èƒ½éœ€è¦å‡ ç™¾æ¯«ç§’ï¼Œè¿™å¯¹å•çº¿ç¨‹çš„ Redis æ¥è¯´æ˜¯ç¾éš¾æ€§çš„ã€‚ä½†é€šè¿‡æ¸è¿›å¼ rehashï¼Œæ¯æ¬¡æ“ä½œåªå¢åŠ å¾ˆå°‘çš„é¢å¤–å¼€é”€ï¼Œç”¨æˆ·åŸºæœ¬æ„Ÿè§‰ä¸åˆ°å»¶è¿Ÿã€‚</p><p>åœ¨ rehash æœŸé—´ï¼ŒæŸ¥æ‰¾æ“ä½œä¼šå…ˆæŸ¥ å“ˆå¸Œè¡¨ 0ï¼Œæ²¡æ‰¾åˆ°å†æŸ¥å“ˆå¸Œè¡¨ 1ï¼›ä½†æ˜¯æ–°æ’å…¥çš„æ•°æ®åªä¼šæ”¾åˆ°å“ˆå¸Œè¡¨ 1 ä¸­ã€‚è¿™æ ·æ—¢å¯ä»¥ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ï¼Œåˆèƒ½é¿å…æ•°æ®çš„é‡å¤ã€‚</p><h4 id="é‡åˆ°å“ˆå¸Œå†²çªæ€ä¹ˆåŠ" tabindex="-1"><a class="header-anchor" href="#é‡åˆ°å“ˆå¸Œå†²çªæ€ä¹ˆåŠ"><span>é‡åˆ°å“ˆå¸Œå†²çªæ€ä¹ˆåŠï¼Ÿ</span></a></h4><p>Redis æ˜¯é€šè¿‡é“¾åœ°å€æ³•æ¥è§£å†³å“ˆå¸Œå†²çªçš„ï¼Œæ¯ä¸ªå“ˆå¸Œè¡¨çš„æ§½ä½å®é™…ä¸Šæ˜¯ä¸€ä¸ªé“¾è¡¨çš„å¤´æŒ‡é’ˆï¼Œå½“å¤šä¸ªé”®çš„å“ˆå¸Œå€¼æ˜ å°„åˆ°åŒä¸€ä¸ªæ§½ä½æ—¶ï¼Œè¿™äº›é”®ä¼šä»¥é“¾è¡¨çš„å½¢å¼ä¸²è”èµ·æ¥ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250606105352.png" alt="Kousik Nathï¼šå“ˆå¸Œå†²çª" tabindex="0" loading="lazy"><figcaption>Kousik Nathï¼šå“ˆå¸Œå†²çª</figcaption></figure><p>å…·ä½“å®ç°ä¸Šï¼ŒRedis ä¼šé€šè¿‡å“ˆå¸Œè¡¨èŠ‚ç‚¹çš„ next æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå…·æœ‰ç›¸åŒå“ˆå¸Œå€¼çš„èŠ‚ç‚¹ã€‚å½“å‘ç”Ÿå†²çªæ—¶ï¼Œæ–°çš„é”®å€¼å¯¹ä¼šæ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ <code>O(1)</code>ã€‚æŸ¥æ‰¾æ—¶éœ€è¦éå†æ•´ä¸ªé“¾è¡¨ï¼Œæœ€åçš„æƒ…å†µä¸‹æ—¶é—´å¤æ‚åº¦ä¸º <code>O(n)</code>ï¼Œä½†é€šå¸¸é“¾è¡¨éƒ½æ¯”è¾ƒçŸ­ã€‚</p><p>å¦å¤–ï¼ŒRedis è®¾è®¡çš„å“ˆå¸Œå‡½æ•°åœ¨åˆ†å¸ƒä¸Šä¹Ÿæ¯”è¾ƒå‡åŒ€ï¼Œèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘å“ˆå¸Œå†²çªçš„å‘ç”Ÿã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/* MurmurHash2, by Austin Appleby</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Note - This code makes a few assumptions about how your machine behaves -</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * 1. We can read a 4-byte value from any address without crashing</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * 2. sizeof(int) == 4</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> *</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * And it has a few limitations -</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> *</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * 1. It will not work incrementally.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * 2. It will not produce the same results on little-endian and big-endian</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> *    machines.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> dictGenHashFunction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /* &#39;m&#39; and &#39;r&#39; are mixing constants generated offline.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       They&#39;re not really &#39;magic&#39;, they just happen to work well.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> seed </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dict_hash_function_seed;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> m </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;"> 0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5bd1e995</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 24</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /* Initialize the hash to a &#39;random&#39; value */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> seed </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">^</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> len;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /* Mix 4 bytes at a time into the hash */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">data </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)key;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(len </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> k </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uint32_t*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)data;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        k </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> m;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        k </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">^=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> k </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        k </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> m;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> m;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">^=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> k;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        data </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        len </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /* Handle the last few bytes of the input array  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    switch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(len) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    case</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">^=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    case</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">^=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 8</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    case</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">^=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]; h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> m;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /* Do a few final mixes of the hash to ensure the last few</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       * bytes are well-incorporated. */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">^=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> m;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">^=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> h </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 15</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)h;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>memoï¼š2025 å¹´ 6 æœˆ 6 æ—¥ï¼Œä»Š<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">å¤©æœ‰çƒå‹å’¨è¯¢</a>å»é‡‘å±±åŠå…¬æš‘æœŸå®ä¹ ï¼Œè¦æå‰å­¦ç‚¹ä»€ä¹ˆï¼Ÿåˆä¸€ä¸ªå‡­å€Ÿ Java è¿™ä¸ªè½½ä½“æ‹¿åˆ° Go offer çš„çƒå‹ï¼Œè¯´æ˜å¤§å®¶åœ¨æ±‚èŒ Go å²—çš„æ—¶å€™ï¼Œä¹Ÿä¸ç”¨è¯´éè¦æå‰åˆ»æ„å»å­¦ä¹  Goï¼Œå½“ç„¶æœ‰ä¸€äº›åŸºç¡€æ˜¯æœ€å¥½çš„ï¼Œæˆ‘ä¹‹å‰ä¹Ÿæ•´ç†è¿‡ <a href="https://javabetter.cn/xuexiluxian/go.html" target="_blank" rel="noopener noreferrer">Go çš„å­¦ä¹ è·¯çº¿</a>åœ¨ Java è¿›é˜¶ä¹‹è·¯ä¸Šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250606111301.png" alt="æ‹¿ä¸‹é‡‘å±± offer" tabindex="0" loading="lazy"><figcaption>æ‹¿ä¸‹é‡‘å±± offer</figcaption></figure><h3 id="_52-ğŸŒŸä½ äº†è§£è·³è¡¨å—" tabindex="-1"><a class="header-anchor" href="#_52-ğŸŒŸä½ äº†è§£è·³è¡¨å—"><span>52.ğŸŒŸä½ äº†è§£è·³è¡¨å—ï¼Ÿ</span></a></h3><p>è·³è¡¨æ˜¯ä¸€ç§éå¸¸å·§å¦™çš„æ•°æ®ç»“æ„ï¼Œå®ƒåœ¨æœ‰åºé“¾è¡¨çš„åŸºç¡€ä¸Šå»ºç«‹äº†å¤šå±‚ç´¢å¼•ï¼Œæœ€åº•å±‚åŒ…å«æ‰€æœ‰æ•°æ®ï¼Œæ¯å¾€ä¸Šä¸€å±‚ï¼ŒèŠ‚ç‚¹æ•°é‡å°±å‡å°‘ä¸€åŠã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250608111336.png" alt="metahub followerï¼šskiplist" tabindex="0" loading="lazy"><figcaption>metahub followerï¼šskiplist</figcaption></figure><p>å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯&quot;ç”¨ç©ºé—´æ¢æ—¶é—´&quot;ï¼Œé€šè¿‡å¤šå±‚ç´¢å¼•æ¥è·³è¿‡å¤§é‡èŠ‚ç‚¹ï¼Œä»è€Œæé«˜æŸ¥æ‰¾æ•ˆç‡ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-08391728-5ba8-42a0-a287-9284451e0ee7.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šè·³è¡¨" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šè·³è¡¨</figcaption></figure><p>æ¯ä¸ªèŠ‚ç‚¹æœ‰ 50% çš„æ¦‚ç‡åªåœ¨ç¬¬ 1 å±‚å‡ºç°ï¼Œ25% çš„æ¦‚ç‡åœ¨ç¬¬ 2 å±‚å‡ºç°ï¼Œä¾æ­¤ç±»æ¨ã€‚æŸ¥æ‰¾çš„æ—¶å€™ä»æœ€é«˜å±‚å¼€å§‹æ°´å¹³ç§»åŠ¨ï¼Œå½“ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å€¼å¤§äºç›®æ ‡æ—¶ï¼Œå°±å‘ä¸‹è·³ä¸€å±‚ï¼Œç›´åˆ°æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250607102238.png" alt="Dylan Wangï¼šSkiplist" tabindex="0" loading="lazy"><figcaption>Dylan Wangï¼šSkiplist</figcaption></figure><h4 id="æ€ä¹ˆå¾€è·³è¡¨æ’å…¥èŠ‚ç‚¹å‘¢" tabindex="-1"><a class="header-anchor" href="#æ€ä¹ˆå¾€è·³è¡¨æ’å…¥èŠ‚ç‚¹å‘¢"><span>æ€ä¹ˆå¾€è·³è¡¨æ’å…¥èŠ‚ç‚¹å‘¢ï¼Ÿ</span></a></h4><p>é¦–å…ˆæ˜¯æ‰¾åˆ°æ’å…¥ä½ç½®ï¼Œä»æœ€é«˜å±‚çš„å¤´èŠ‚ç‚¹å¼€å§‹ï¼Œåœ¨æ¯ä¸€å±‚éƒ½æ‰¾åˆ°åº”è¯¥æ’å…¥ä½ç½®çš„å‰é©±èŠ‚ç‚¹ï¼Œç”¨ä¸€ä¸ª update æ•°ç»„æŠŠè¿™äº›å‰é©±èŠ‚ç‚¹è®°å½•ä¸‹æ¥ã€‚è¿™ä¸ªæŸ¥æ‰¾è¿‡ç¨‹å’Œæ™®é€šæŸ¥æ‰¾ä¸€æ ·ï¼Œåœ¨æ¯å±‚å‘å³ç§»åŠ¨ç›´åˆ°ä¸‹ä¸ªèŠ‚ç‚¹çš„å€¼å¤§äºè¦æ’å…¥çš„å€¼ï¼Œç„¶åä¸‹é™åˆ°ä¸‹ä¸€å±‚ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è®°å½•æ¯å±‚çš„æ’å…¥ä½ç½®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">zskiplistNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[ZSKIPLIST_MAXLEVEL];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">zskiplistNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">x;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i, level;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ä»æœ€é«˜å±‚å¼€å§‹æŸ¥æ‰¾</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">x </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> zsl</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">header;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> zsl</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">level</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">--</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // åœ¨å½“å‰å±‚æ°´å¹³ç§»åŠ¨ï¼Œæ‰¾åˆ°æ’å…¥ä½ç½®</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">           (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">score</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> score </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">||</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">score</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> score </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">             sdscmp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ele</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, ele) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        x </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> x;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // è®°å½•æ¯å±‚çš„å‰é©±èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥éšæœºç”Ÿæˆæ–°èŠ‚ç‚¹çš„å±‚æ•°ã€‚é€šå¸¸ç”¨ä¸€ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡æœ‰ 50% çš„æ¦‚ç‡ç»§ç»­å¾€ä¸Šï¼Œç›´åˆ°éšæœºå¤±è´¥æˆ–è¾¾åˆ°æœ€å¤§å±‚æ•°é™åˆ¶ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Redis ä¸­çš„éšæœºå±‚æ•°ç”Ÿæˆ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> zslRandomLevel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> level </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ((</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">random</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">FFFF</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (ZSKIPLIST_P </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;"> 0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">FFFF</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        level </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (level </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ZSKIPLIST_MAXLEVEL) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> level </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ZSKIPLIST_MAXLEVEL;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ç”Ÿæˆæ–°èŠ‚ç‚¹çš„å±‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">level </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> zslRandomLevel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºæ–°èŠ‚ç‚¹åï¼Œä»åº•å±‚å¼€å§‹åˆ°æ–°èŠ‚ç‚¹çš„æœ€é«˜å±‚ï¼Œåœ¨æ¯ä¸€å±‚éƒ½è¿›è¡Œæ ‡å‡†çš„é“¾è¡¨æ’å…¥æ“ä½œã€‚è¿™ä¸€æ­¥è¦åˆ©ç”¨ä¹‹å‰è®°å½•çš„ update æ•°ç»„ï¼Œå°†æ–°èŠ‚ç‚¹æ’å…¥åˆ°æ­£ç¡®ä½ç½®ï¼Œç„¶åæ›´æ–°å‰åæŒ‡é’ˆçš„è¿æ¥å…³ç³»ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ›´æ–°å‰è¿›æŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> level; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> x;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // æ›´æ–°è·¨åº¦ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">span</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">span</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rank</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rank</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i]);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">span</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rank</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rank</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i]) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ›´æ–°æœªæ¶‰åŠå±‚çš„è·¨åº¦</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> level; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> zsl</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">level; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i]-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">span</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ›´æ–°åé€€æŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">backward </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> zsl</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">header) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> NULL</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].forward)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].forward</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">backward </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> x;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    zsl</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tail </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> x;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ›´æ–°è·³è¡¨é•¿åº¦</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">zsl</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">length</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸ªè·³è¡¨çš„æ’å…¥è¿‡ç¨‹ï¼Œå‡è®¾æ’å…¥çš„æ•°æ®ä¾æ¬¡æ˜¯ 22ã€19ã€7ã€3ã€37ã€11ã€26ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250607103728.png" alt="zhangtielei.comï¼šè·³è¡¨æ’å…¥è¿‡ç¨‹" tabindex="0" loading="lazy"><figcaption>zhangtielei.comï¼šè·³è¡¨æ’å…¥è¿‡ç¨‹</figcaption></figure><p>é‚£å‡å¦‚æˆ‘ä»¬åœ¨ä¸€ä¸ªå·²ç»åˆ†å¸ƒäº† 1ã€14ã€27ã€31ã€44ã€56ã€63ã€70ã€80ã€91 çš„è·³è¡¨ä¸­æ’å…¥ä¸€ä¸ª 67 çš„èŠ‚ç‚¹ï¼Œæ’å…¥è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250607104019.png" alt="Dylan Wangï¼šæ’å…¥èŠ‚ç‚¹" tabindex="0" loading="lazy"><figcaption>Dylan Wangï¼šæ’å…¥èŠ‚ç‚¹</figcaption></figure><h4 id="zsetä¸ºä»€ä¹ˆè¦ä½¿ç”¨è·³è¡¨å‘¢" tabindex="-1"><a class="header-anchor" href="#zsetä¸ºä»€ä¹ˆè¦ä½¿ç”¨è·³è¡¨å‘¢"><span>zsetä¸ºä»€ä¹ˆè¦ä½¿ç”¨è·³è¡¨å‘¢ï¼Ÿ</span></a></h4><p>ç¬¬ä¸€ï¼Œè·³è¡¨å¤©ç„¶å°±æ˜¯æœ‰åºçš„æ•°æ®ç»“æ„ï¼ŒæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤éƒ½èƒ½ä¿æŒ <code>O(log n)</code> çš„æ—¶é—´å¤æ‚åº¦ã€‚</p><p>ç¬¬äºŒï¼Œè·³è¡¨æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œæ‰¾åˆ°èµ·å§‹ä½ç½®åå¯ä»¥ç›´æ¥æ²¿ç€åº•å±‚é“¾è¡¨é¡ºåºéå†ï¼Œæ»¡è¶³ ZRANGE æŒ‰æ’åè·å–å…ƒç´ ï¼Œæˆ–è€… ZRANGEBYSCORE æŒ‰åˆ†å€¼èŒƒå›´è·å–å…ƒç´ ã€‚</p><p>memoï¼š2025 å¹´ 6 æœˆ 7 æ—¥ï¼Œä»Šå¤©ç»™ä¸€ä¸ªå­¦é™¢æœ¬çƒå‹<a href="https://javabetter.cn/zhishixingqiu/jianli.html" target="_blank" rel="noopener noreferrer">ä¿®æ”¹ç®€å†</a>çš„æ—¶å€™ï¼Œä»–æåˆ°å®ä¹ çš„åŒäº‹ï¼Œéƒ½æ‹¿åˆ°äº† 20k ä»¥ä¸Šçš„ offerï¼Œç”šè‡³è¿˜æœ‰ 25k æºç¨‹ offer çš„ï¼Œè‡ªå·±å¹¶ä¸æ¯”ä»–ä»¬å·®ï¼Œé—®åœ¨å®ä¹ ã€é¡¹ç›®å’Œèƒ½åŠ›ä¸Šè¿˜èƒ½æ€ä¹ˆæé«˜ï¼Ÿ</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250607110105.png" alt="å­¦é™¢æœ¬çƒå‹çš„ç›®æ ‡å’Œè®¡åˆ’" tabindex="0" loading="lazy"><figcaption>å­¦é™¢æœ¬çƒå‹çš„ç›®æ ‡å’Œè®¡åˆ’</figcaption></figure><p>æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šäººé€‰æ‹©è·‘æ¥å·äº’è”ç½‘å¼€å‘çš„åŸå› å•Šï¼Œä¸Šçº¿æ¯”å…¶ä»–è¡Œä¸šé«˜å¤ªå¤šäº†ï¼Œè™½ç„¶äº’è”ç½‘å¼€å‘çš„å·¥ä½œå¼ºåº¦ä¹Ÿå¤§ï¼Œä½†æœ€èµ·ç èƒ½åŠ³æœ‰æ‰€è·ã€‚</p><h4 id="è·³è¡¨æ˜¯å¦‚ä½•å®šä¹‰çš„å‘¢" tabindex="-1"><a class="header-anchor" href="#è·³è¡¨æ˜¯å¦‚ä½•å®šä¹‰çš„å‘¢"><span>è·³è¡¨æ˜¯å¦‚ä½•å®šä¹‰çš„å‘¢ï¼Ÿ</span></a></h4><p>è·³è¡¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤šå±‚é“¾è¡¨ï¼Œåº•å±‚æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰å…ƒç´ çš„æœ‰åºé“¾è¡¨ï¼Œä¸Šä¸€å±‚ä½œä¸ºç´¢å¼•å±‚ï¼ŒåŒ…å«äº†ä¸‹ä¸€å±‚çš„éƒ¨åˆ†èŠ‚ç‚¹ï¼›å±‚æ•°é€šè¿‡éšæœºç®—æ³•ç¡®å®šï¼Œç†è®ºä¸Šå¯ä»¥æ— é™é«˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250607103155.png" alt="metahub followerï¼šè·³è¡¨" tabindex="0" loading="lazy"><figcaption>metahub followerï¼šè·³è¡¨</figcaption></figure><p>è·³è¡¨èŠ‚ç‚¹åŒ…å«åˆ†å€¼ scoreã€æˆå‘˜å¯¹è±¡ objã€ä¸€ä¸ªåé€€æŒ‡é’ˆ backwardï¼Œä»¥åŠä¸€ä¸ªå±‚çº§æ•°ç»„ levelã€‚æ¯ä¸ªå±‚çº§åŒ…å« forward å‰è¿›æŒ‡é’ˆå’Œ span è·¨åº¦ä¿¡æ¯ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> skiplistNode {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> score;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                    // åˆ†å€¼ï¼ˆç”¨äºæ’åºï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    robj </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">obj;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                      // æ•°æ®å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> skiplistNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">backward;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   // åé€€æŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> skiplistLevel {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> skiplistNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">forward;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // å‰è¿›æŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> span;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           // è·¨åº¦ï¼ˆåˆ°ä¸‹ä¸ªèŠ‚ç‚¹çš„è·ç¦»ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    } level</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">[]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                      // å±‚çº§æ•°ç»„</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} skiplistNode;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·³è¡¨æœ¬èº«åŒ…å«å¤´å°¾èŠ‚ç‚¹æŒ‡é’ˆã€èŠ‚ç‚¹æ€»æ•° length å’Œå½“å‰æœ€å¤§å±‚æ•° levelã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> skiplist {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> skiplistNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">header, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tail;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // å¤´å°¾èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> length;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">               // èŠ‚ç‚¹æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> level;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                         // æœ€å¤§å±‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} skiplist;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="span-è·¨åº¦æœ‰ä»€ä¹ˆç”¨" tabindex="-1"><a class="header-anchor" href="#span-è·¨åº¦æœ‰ä»€ä¹ˆç”¨"><span>span è·¨åº¦æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</span></a></h4><p>span è®°å½•äº†å½“å‰èŠ‚ç‚¹åˆ°ä¸‹ä¸€èŠ‚ç‚¹ä¹‹é—´ï¼Œåº•å±‚åˆ°åº•è·¨è¶Šäº†å‡ ä¸ªèŠ‚ç‚¹ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å¿«é€Ÿæ‰¾åˆ° ZSet ä¸­æŸä¸ªåˆ†å€¼çš„æ’åã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250608115835.png" alt="Aparajita Pandeyï¼šspan" tabindex="0" loading="lazy"><figcaption>Aparajita Pandeyï¼šspan</figcaption></figure><p>æ¯”å¦‚è¯´æˆ‘ä»¬æ‰§è¡Œ <code>ZRANK</code> å‘½ä»¤æ—¶ï¼Œå¦‚æœæ²¡æœ‰ spanï¼Œå°±éœ€è¦ä»å¤´èŠ‚ç‚¹å¼€å§‹éå†æ¯ä¸ªèŠ‚ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°ç›®æ ‡åˆ†å€¼ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦æ˜¯ <code>O(n)</code>ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ²¡æœ‰spançš„æ’åæŸ¥è¯¢ - O(n)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getRankWithoutSpan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">skiplist </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">zsl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> double</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> score</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> robj </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    skiplistNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">x </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> zsl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> rank </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (x) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">score</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> score </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> equalStringObjects</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, obj)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> rank </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // æ’åä»1å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        rank</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        x </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æœ‰äº† spanï¼Œæˆ‘ä»¬åœ¨ä»é«˜å±‚å¾€ä½å±‚æœç´¢çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡ä¸€äº›èŠ‚ç‚¹ï¼Œå¿«é€Ÿå®šä½åˆ°ç›®æ ‡åˆ†å€¼æ‰€åœ¨çš„èŒƒå›´ã€‚è¿™æ ·å°±èƒ½æŠŠæ—¶é—´å¤æ‚åº¦é™åˆ° <code>O(log n)</code>ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">long</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> skiplistGetRank</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">skiplist </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">zsl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> double</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> score</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> robj </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    skiplistNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">x </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> zsl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    unsigned</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> rank </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // ä»æœ€é«˜å±‚å¼€å§‹æŸ¥æ‰¾</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> zsl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">--</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">               (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">score</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> score </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">||</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">score</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> score </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                 compareStringObjects</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, obj) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            rank </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">span</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // ç´¯åŠ è·¨åº¦</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            x </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">forward</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">score</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> score </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            equalStringObjects</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, obj)) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            rank </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">span</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> rank;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸ºä»€ä¹ˆè·³è¡¨çš„èŒƒå›´æŸ¥è¯¢æ•ˆç‡æ¯”å­—å…¸é«˜" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆè·³è¡¨çš„èŒƒå›´æŸ¥è¯¢æ•ˆç‡æ¯”å­—å…¸é«˜"><span>ä¸ºä»€ä¹ˆè·³è¡¨çš„èŒƒå›´æŸ¥è¯¢æ•ˆç‡æ¯”å­—å…¸é«˜ï¼Ÿ</span></a></h4><p>å­—å…¸æ˜¯é€šè¿‡å“ˆå¸Œå‡½æ•°å°†é”®å€¼å¯¹åˆ†æ•£å­˜å‚¨çš„ï¼Œå…ƒç´ åœ¨å†…å­˜ä¸­æ˜¯æ— åºåˆ†å¸ƒçš„ï¼Œæ²¡æœ‰ä»»ä½•é¡ºåºå…³ç³»ã€‚è€Œè·³è¡¨æœ¬èº«å°±æ˜¯æœ‰åºçš„æ•°æ®ç»“æ„ï¼Œæ‰€æœ‰å…ƒç´ æŒ‰ç…§åˆ†å€¼ä»å°åˆ°å¤§æ’åˆ—ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250608112525.png" alt="WARRIORï¼šè·³è¡¨" tabindex="0" loading="lazy"><figcaption>WARRIORï¼šè·³è¡¨</figcaption></figure><p>å½“éœ€è¦è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå­—å…¸å¿…é¡»éå†æ‰€æœ‰å…ƒç´ ï¼Œé€ä¸ªæ£€æŸ¥æ¯ä¸ªå…ƒç´ æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ <code>O(n)</code>ã€‚æ¯”å¦‚è¦æ‰¾åˆ†å€¼åœ¨ 60 åˆ° 80 ä¹‹é—´çš„æ‰€æœ‰å…ƒç´ ï¼Œå­—å…¸åªèƒ½æŠŠæ•´ä¸ªå“ˆå¸Œè¡¨æ‰«æä¸€éï¼Œå› ä¸ºå®ƒæ— æ³•çŸ¥é“ç¬¦åˆæ¡ä»¶çš„å…ƒç´ åœ¨å“ªé‡Œã€‚</p><p>è€Œè·³è¡¨çš„èŒƒå›´æŸ¥è¯¢å°±é«˜æ•ˆå¤šäº†ã€‚é¦–å…ˆç”¨ <code>O(log n)</code> æ—¶é—´æ‰¾åˆ°èŒƒå›´çš„èµ·å§‹ä½ç½®ï¼Œç„¶åæ²¿ç€åº•å±‚çš„æœ‰åºé“¾è¡¨é¡ºåºéå†ï¼Œç›´åˆ°è¶…å‡ºèŒƒå›´ä¸ºæ­¢ã€‚æ€»æ—¶é—´å¤æ‚åº¦æ˜¯ <code>O(log n + k)</code>ï¼Œå…¶ä¸­ k æ˜¯ç»“æœé›†çš„å¤§å°ã€‚è¿™ç§æ•ˆç‡å·®å¼‚åœ¨æ•°æ®é‡å¤§çš„æ—¶å€™éå¸¸æ˜æ˜¾ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250608113417.png" alt="æ™´å¤©å“¥ï¼šzset åº•å±‚ç”±å­—å…¸å’Œè·³è¡¨ç»„æˆ" tabindex="0" loading="lazy"><figcaption>æ™´å¤©å“¥ï¼šzset åº•å±‚ç”±å­—å…¸å’Œè·³è¡¨ç»„æˆ</figcaption></figure><p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Redis çš„ zset è¦ç”¨è·³è¡¨è€Œä¸æ˜¯çº¯å“ˆå¸Œè¡¨çš„é‡è¦åŸå› ï¼Œå› ä¸º zset ç»å¸¸éœ€è¦ ZRANGEã€ZRANGEBYSCORE è¿™ç±»èŒƒå›´æ“ä½œã€‚å®é™…ä¸Š Redis çš„ zset æ˜¯è·³è¡¨å’Œå“ˆå¸Œè¡¨çš„ç»„åˆï¼šè·³è¡¨ä¿è¯æœ‰åºæ€§æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œå“ˆå¸Œè¡¨ä¿è¯ <code>O(1)</code> çš„å•ç‚¹æŸ¥æ‰¾æ•ˆç‡ï¼Œä¸¤è€…äº’è¡¥ã€‚</p><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å°ç±³æš‘æœŸå®ä¹ åŒå­¦ E ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆ hash è¡¨èŒƒå›´æŸ¥è¯¢æ•ˆç‡æ¯”è·³è¡¨ä½</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 8 ä¸€é¢é¢è¯•åŸé¢˜ï¼šè·³è¡¨çš„ç»“æ„</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 4 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis è·³è¡¨</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„é˜¿é‡Œç³»é¢ç»åŒå­¦ 19 é¥¿äº†ä¹ˆé¢è¯•åŸé¢˜ï¼šè·³è¡¨äº†è§£å—</li></ol></blockquote><p>memoï¼š2025 å¹´ 6 æœˆ 8 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘ä¿¡æ¯</a>ç§°èµ Java è¿›é˜¶ä¹‹è·¯çš„å†…å®¹å†™å¾—å¥½ï¼Œè¯´å®è¯ï¼Œæˆ‘æ˜¯æœ‰è¿™ä¸ªè‡ªä¿¡çš„ï¼ŒåŸºæœ¬ä¸Šæ‰€å†™çš„å†…å®¹ä¹Ÿéƒ½æ˜¯æˆ‘è¿™äº›å¹´ä»è¯»åˆ°çš„æ‰€æœ‰ä¹¦ç±ã€è§†é¢‘ã€æ•™ç¨‹ä¸­æç‚¼åˆ°çš„ç²¾åï¼ŒæŠŠä¸€äº›éš¾æ‡‚æ™¦æ¶©çš„çŸ¥è¯†éƒ½ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è¡¨è¾¾å‡ºæ¥ï¼Œé…åˆæ‰‹ç»˜å›¾ï¼Œèƒ½è®©äººæ›´å®¹æ˜“ç†è§£ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-äºŒå“¥ï¼Œæˆ‘æ„Ÿè§‰ä½ è¿™äº›çŸ¥è¯†ç‚¹å†™çš„çœŸä¸é”™ï¼Œâ‘¤ä¹‹å‰.png" alt="çƒå‹å¯¹äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯çš„ç§°èµ" tabindex="0" loading="lazy"><figcaption>çƒå‹å¯¹äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯çš„ç§°èµ</figcaption></figure><h3 id="_53-å‹ç¼©åˆ—è¡¨äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#_53-å‹ç¼©åˆ—è¡¨äº†è§£å—"><span>53.å‹ç¼©åˆ—è¡¨äº†è§£å—ï¼Ÿ</span></a></h3><p>ç­”ï¼šå‹ç¼©åˆ—è¡¨æ˜¯ Redis ä¸ºäº†èŠ‚çœå†…å­˜è€Œè®¾è®¡çš„ä¸€ç§ç´§å‡‘å‹æ•°æ®ç»“æ„ï¼Œå®ƒä¼šæŠŠæ‰€æœ‰æ•°æ®è¿ç»­å­˜å‚¨åœ¨ä¸€å—å†…å­˜å½“ä¸­ã€‚</p><p>æ•´ä¸ªç»“æ„åŒ…å«å¤´éƒ¨ä¿¡æ¯ï¼Œå¦‚æ€»çš„å­—èŠ‚æ•°ã€å°¾éƒ¨åç§»é‡ã€èŠ‚ç‚¹æ•°é‡ï¼Œä»¥åŠè¿ç»­çš„èŠ‚ç‚¹æ•°æ®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-6be492f7-9f92-4607-a4c4-81a612a3d7bd.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå‹ç¼©åˆ—è¡¨ç»„æˆéƒ¨åˆ†" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå‹ç¼©åˆ—è¡¨ç»„æˆéƒ¨åˆ†</figcaption></figure><p>å½“ listã€hash å’Œ set çš„æ•°æ®é‡è¾ƒå°ä¸”å€¼éƒ½ä¸å¤§æ—¶ï¼Œåº•å±‚ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥å®ç°ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20241225105623.png" alt="æˆªå›¾æ¥è‡ª Redis å®˜ç½‘" tabindex="0" loading="lazy"><figcaption>æˆªå›¾æ¥è‡ª Redis å®˜ç½‘</figcaption></figure><p>é€šå¸¸æƒ…å†µåœ¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šå‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ã€ç¼–ç ç±»å‹å’Œå®é™…çš„æ•°æ®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250609093621.png" alt="happytree001ï¼šziplist entry" tabindex="0" loading="lazy"><figcaption>happytree001ï¼šziplist entry</figcaption></figure><p>å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦æ˜¯ä¸ºäº†æ”¯æŒä»åå¾€å‰éå†ï¼›å½“å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦å°äº 254 å­—èŠ‚æ—¶ï¼Œä½¿ç”¨ 1 å­—èŠ‚å­˜å‚¨ï¼›å¦åˆ™ç”¨ 5 å­—èŠ‚å­˜å‚¨ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º 254ï¼Œåå››ä¸ªå­—èŠ‚å­˜å‚¨å®é™…é•¿åº¦ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250609093736.png" alt="happytree001ï¼šziplist prevlen" tabindex="0" loading="lazy"><figcaption>happytree001ï¼šziplist prevlen</figcaption></figure><p>ç¼–ç ç±»å‹ä¼šæ ¹æ®æ•°æ®çš„å®é™…æƒ…å†µé€‰æ‹©æœ€ç´§å‡‘çš„å­˜å‚¨æ–¹å¼ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b5d224c2-53ee-40a3-9efc-2feb7dd3d7a8.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå‹ç¼©åˆ—è¡¨ç¤ºä¾‹" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå‹ç¼©åˆ—è¡¨ç¤ºä¾‹</figcaption></figure><p>ä½†å‹ç¼©åˆ—è¡¨æœ‰ä¸ªè‡´å‘½é—®é¢˜ï¼Œå°±æ˜¯è¿é”æ›´æ–°ã€‚å½“æ’å…¥æˆ–åˆ é™¤èŠ‚ç‚¹å¯¼è‡´æŸä¸ªèŠ‚ç‚¹é•¿åº¦å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯èƒ½ä¼šå½±å“åç»­æ‰€æœ‰èŠ‚ç‚¹å­˜å‚¨çš„â€œå‰ä¸€ä¸ªèŠ‚ç‚¹é•¿åº¦â€å­—æ®µï¼Œæœ€åæƒ…å†µä¸‹æ—¶é—´å¤æ‚åº¦ä¼šé€€åŒ–åˆ° <code>O(nÂ²)</code>ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250604112846.png" alt="hjcenry.comï¼šè¿é”æ›´æ–°" tabindex="0" loading="lazy"><figcaption>hjcenry.comï¼šè¿é”æ›´æ–°</figcaption></figure><h4 id="ziplist-çš„èŠ‚ç‚¹æ•°é‡ä¼šè¶…è¿‡-65535-å—" tabindex="-1"><a class="header-anchor" href="#ziplist-çš„èŠ‚ç‚¹æ•°é‡ä¼šè¶…è¿‡-65535-å—"><span>ziplist çš„èŠ‚ç‚¹æ•°é‡ä¼šè¶…è¿‡ 65535 å—ï¼Ÿ</span></a></h4><p>ä¸ä¼šã€‚</p><p>Zllen å­—æ®µçš„ç±»å‹æ˜¯ <code>uint16_t</code>ï¼Œæœ€å¤§å€¼ä¸º 65535ï¼Œä¹Ÿå°±æ˜¯ 2 çš„ 16æ¬¡æ–¹ï¼Œæ‰€ä»¥å‹ç¼©åˆ—è¡¨çš„èŠ‚ç‚¹æ•°é‡ä¸ä¼šè¶…è¿‡ 65535ã€‚</p><p>å½“èŠ‚ç‚¹æ•°é‡å°äº 65535 æ—¶ï¼Œè¯¥å­—æ®µä¼šå­˜å‚¨å®é™…çš„æ•°é‡ï¼›å¦åˆ™è¯¥å­—æ®µå°±å›ºå®šä¸º 65535ï¼Œå®é™…å­˜å‚¨çš„æ•°é‡éœ€è¦é€ä¸ªéå†èŠ‚ç‚¹æ¥è®¡ç®—ã€‚</p><h4 id="ziplist-çš„ç¼–ç ç±»å‹äº†è§£å¤šå°‘" tabindex="-1"><a class="header-anchor" href="#ziplist-çš„ç¼–ç ç±»å‹äº†è§£å¤šå°‘"><span>ziplist çš„ç¼–ç ç±»å‹äº†è§£å¤šå°‘ï¼Ÿ</span></a></h4><p>ziplist çš„ç¼–ç ç±»å‹è®¾è®¡å¾—å¾ˆç²¾å·§ï¼Œä¸»è¦åˆ†ä¸ºå­—ç¬¦ä¸²ç¼–ç å’Œæ•´æ•°ç¼–ç ä¸¤å¤§ç±»ï¼Œç›®çš„æ˜¯ç”¨æœ€å°‘çš„å­—èŠ‚å­˜å‚¨æ•°æ®ã€‚</p><p>æ¯”å¦‚ 0 åˆ° 12 è¿™äº›å°æ•´æ•°ç›´æ¥ç¼–ç åœ¨ type å­—æ®µä¸­ï¼Œåªéœ€è¦ 1 ä¸ªå­—èŠ‚ã€‚</p><table><thead><tr><th>ç¼–ç </th><th>é•¿åº¦</th><th>æè¿°</th></tr></thead><tbody><tr><td>11000000</td><td>1å­—èŠ‚</td><td>int16_tç±»å‹æ•´æ•°ï¼Œ2 å­—èŠ‚</td></tr><tr><td>11010000</td><td>1å­—èŠ‚</td><td>int32_tç±»å‹æ•´æ•°ï¼Œ4 å­—èŠ‚</td></tr><tr><td>11100000</td><td>1å­—èŠ‚</td><td>int64_tç±»å‹æ•´æ•°ï¼Œ8 å­—èŠ‚</td></tr><tr><td>11110000</td><td>1å­—èŠ‚</td><td>24ä½æœ‰ç¬¦å·æ•´æ•° ï¼Œ3 å­—èŠ‚</td></tr><tr><td>1111xxxx</td><td>1å­—èŠ‚</td><td>æ•°æ®èŒƒå›´åœ¨[0-12]ï¼Œæ•°æ®åŒ…å«åœ¨ç¼–ç ä¸­</td></tr></tbody></table><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250609094439.png" alt="happytree001ï¼šziplist å°æ•´æ•°ç¼–ç " tabindex="0" loading="lazy"><figcaption>happytree001ï¼šziplist å°æ•´æ•°ç¼–ç </figcaption></figure><p>å¯¹äºå­—ç¬¦ä¸²ç¼–ç ï¼Œæ ¹æ®å­—ç¬¦ä¸²é•¿åº¦æœ‰ä¸‰ç§æ ¼å¼ã€‚é•¿åº¦å°äº 63 å­—èŠ‚çš„ç”¨ 00 å¼€å¤´çš„å•å­—èŠ‚ç¼–ç ï¼Œå‰©ä½™ 6 ä½å­˜å‚¨é•¿åº¦ã€‚é•¿åº¦åœ¨ 63 åˆ° 16383 ä¹‹é—´çš„ç”¨ 01 å¼€å¤´çš„åŒå­—èŠ‚ç¼–ç ï¼Œå‰©ä½™ 14 ä½å­˜å‚¨é•¿åº¦ã€‚è¶…è¿‡ 16383 å­—èŠ‚çš„ç”¨ 10 å¼€å¤´ï¼Œåé¢è·Ÿ 4 å­—èŠ‚å­˜å‚¨é•¿åº¦ã€‚</p><table><thead><tr><th>ç¼–ç </th><th>é•¿åº¦</th><th>æè¿°</th></tr></thead><tbody><tr><td>00pppppp</td><td>1å­—èŠ‚</td><td>0-63 å­—èŠ‚çš„å­—ç¬¦ä¸²</td></tr><tr><td>01pppppp qqqqqqqq</td><td>2å­—èŠ‚</td><td>64-16383å­—èŠ‚çš„å­—ç¬¦ä¸²</td></tr><tr><td>10______ qqqqqqqq rrrrrrrr ssssssss tttttttt</td><td>5å­—èŠ‚</td><td>16384-4294967295å­—èŠ‚çš„å­—ç¬¦ä¸²</td></tr></tbody></table><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250609094615.png" alt="happytree001ï¼šziplist å­—ç¬¦ä¸²ç¼–ç " tabindex="0" loading="lazy"><figcaption>happytree001ï¼šziplist å­—ç¬¦ä¸²ç¼–ç </figcaption></figure><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨å‹ç¼©åˆ—è¡¨</li></ol></blockquote><p>memoï¼š2025 å¹´ 6 æœˆ 9 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹ç‰¹æ„å‘ç§ä¿¡</a>ï¼Œæ„Ÿè°¢é¢æ¸£é€†è¢­å¯¹ä»–çš„å¸®åŠ©ã€‚å¯¹ï¼Œè¿™ä¹ˆæ£’çš„å†…å®¹ï¼Œæˆ‘ä¾ç„¶é€‰æ‹©äº†å…è´¹ï¼Œå› ä¸ºæˆ‘ç›¸ä¿¡çŸ¥è¯†æ˜¯æœ‰ä»·å€¼çš„ï¼Œåªæœ‰è¯šæ³çš„åˆ†äº«å‡ºæ¥æ‰èƒ½è®©æ›´å¤šäººå—ç›Šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250609100519.png" alt="çƒå‹å¯¹é¢æ¸£é€†è¢­çš„è®¤å¯" tabindex="0" loading="lazy"><figcaption>çƒå‹å¯¹é¢æ¸£é€†è¢­çš„è®¤å¯</figcaption></figure><h3 id="_54-quicklist-äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#_54-quicklist-äº†è§£å—"><span>54.quicklist äº†è§£å—ï¼Ÿ</span></a></h3><p>quicklist æ˜¯ Redis åœ¨ 3.2 ç‰ˆæœ¬æ—¶å¼•å…¥çš„ï¼Œä¸“é—¨ç”¨äº List çš„åº•å±‚å®ç°ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ··åˆå‹æ•°æ®ç»“æ„ï¼Œç»“åˆäº†å‹ç¼©åˆ—è¡¨å’ŒåŒå‘é“¾è¡¨çš„ä¼˜ç‚¹ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-3b9785b0-6573-4c2d-8b7d-d5d1be799e26.png" alt="ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šquicklist" tabindex="0" loading="lazy"><figcaption>ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šquicklist</figcaption></figure><p>åœ¨æ—©æœŸçš„ç‰ˆæœ¬ä¸­ï¼ŒList ä¼šæ ¹æ®å…ƒç´ çš„æ•°é‡å’Œå¤§å°é‡‡ç”¨ä¸¤ç§ä¸åŒçš„åº•å±‚æ•°æ®ç»“æ„ï¼Œå½“å…ƒç´ è¾ƒå°‘æˆ–è€…è¾ƒå°æ—¶ï¼Œä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ï¼›å¦åˆ™ç”¨åŒå‘é“¾è¡¨ã€‚</p><p>ä½†è¿™ç§è®¾è®¡æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“ List ä¸­çš„å…ƒç´ æ•°é‡è¾ƒå¤šæ—¶ï¼Œå‹ç¼©åˆ—è¡¨ä¼šå› ä¸ºè¿é”æ›´æ–°å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œè€ŒåŒå‘é“¾è¡¨åˆä¼šå ç”¨æ›´å¤šå†…å­˜ã€‚</p><p>quicklist é€šè¿‡å°† List æ‹†åˆ†ä¸ºå¤šä¸ªå°çš„ ziplistï¼Œå†é€šè¿‡æŒ‡é’ˆé“¾æ¥æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå·§å¦™çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250610105328.png" alt="å½±ä¸­äººlxï¼šquicklist" tabindex="0" loading="lazy"><figcaption>å½±ä¸­äººlxï¼šquicklist</figcaption></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ª ziplist å¯ä»¥å­˜å‚¨ 8KB çš„æ•°æ®ï¼Œå‡å¦‚æ¯ä¸ªå…ƒç´ çš„å¤§å°æ°å¥½æ˜¯ 1KBï¼Œé‚£ä¹ˆä¸€ä¸ª quicklist å°±å¯ä»¥å­˜å‚¨ 8 ä¸ªå…ƒç´ ã€‚80 ä¸ªè¿™æ ·çš„å…ƒç´ å°±ä¼šè¢«åˆ†æˆ 10 ä¸ª ziplistã€‚</p><p>è¿™æ ·æ—¢ä¿ç•™äº†å‹ç¼©åˆ—è¡¨çš„å†…å­˜ç´§å‡‘æ€§ï¼Œåˆå‡å°‘äº†åŒå‘é“¾è¡¨æŒ‡é’ˆçš„æ•°é‡ï¼Œè¿›ä¸€æ­¥é™ä½äº†å†…å­˜å¼€é”€ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250610110115.png" alt="metahub followerï¼šziplist" tabindex="0" loading="lazy"><figcaption>metahub followerï¼šziplist</figcaption></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œquicklist è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼Œå°±æ˜¯å®ƒçš„å¯é…ç½®æ€§ï¼Œå¯ä»¥é€šè¿‡å¡«å……å› å­æ§åˆ¶æ¯ä¸ª ziplist èŠ‚ç‚¹çš„å¤§å°ã€‚å½“å¡«å……å› å­ä¸ºæ­£æ•°æ—¶ï¼Œå®ƒè¿˜å¯ä»¥é™åˆ¶æ¯ä¸ª ziplist æœ€å¤šåŒ…å«çš„å…ƒç´ æ•°é‡ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># å¡«å……å› å­ï¼Œé»˜è®¤ -2ï¼ˆ8KBï¼‰</span></span>
<span class="line"><span>list-max-ziplist-size 10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæƒ³è¿›ä¸€æ­¥èŠ‚çœå†…å­˜ï¼Œquicklist è¿˜æ”¯æŒå¯¹ä¸­é—´èŠ‚ç‚¹è¿›è¡Œ LZF å‹ç¼©ï¼Œå‹ç¼©æ·±åº¦ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºé™¤äº†é¦–å°¾å„ 1 ä¸ªèŠ‚ç‚¹ä¸å‹ç¼©å¤–ï¼Œå…¶ä»–èŠ‚ç‚¹éƒ½å‹ç¼©ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># å‹ç¼©æ·±åº¦ï¼Œé»˜è®¤ 0ï¼ˆä¸å‹ç¼©ï¼‰</span></span>
<span class="line"><span>list-compress-depth 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250610112125.png" alt="wingsxdu.comï¼šLZF å‹ç¼©ç®—æ³•" tabindex="0" loading="lazy"><figcaption>wingsxdu.comï¼šLZF å‹ç¼©ç®—æ³•</figcaption></figure><h4 id="lzf-å‹ç¼©ç®—æ³•äº†è§£å—" tabindex="-1"><a class="header-anchor" href="#lzf-å‹ç¼©ç®—æ³•äº†è§£å—"><span>LZF å‹ç¼©ç®—æ³•äº†è§£å—ï¼Ÿ</span></a></h4><p>LZF æ˜¯ä¸€ç§å¿«é€Ÿçš„æ— æŸå‹ç¼©ç®—æ³•ï¼Œä¸»è¦ç”¨äºå‡å°‘æ•°æ®å­˜å‚¨ç©ºé—´ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æŸ¥æ‰¾é‡å¤æ•°æ®æ¥å®ç°å‹ç¼©ï¼Œé€šè¿‡ä¸€ä¸ªæ»‘åŠ¨çª—å£æ¥æŸ¥æ‰¾é‡å¤çš„å­—èŠ‚åºåˆ—ï¼Œå¹¶å°†è¿™äº›åºåˆ—æ›¿æ¢ä¸ºæ›´çŸ­çš„å¼•ç”¨ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>è¾“å…¥æ•°æ®: &quot;hello world hello redis&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤1: å¤„ç† &quot;hello world &quot;</span></span>
<span class="line"><span>- å»ºç«‹å­—å…¸ï¼Œè®°å½•å­—èŠ‚åºåˆ—ä½ç½®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤2: é‡åˆ°é‡å¤çš„ &quot;hello&quot;</span></span>
<span class="line"><span>- åœ¨å­—å…¸ä¸­æ‰¾åˆ°ä¹‹å‰çš„ &quot;hello&quot; ä½ç½®</span></span>
<span class="line"><span>- ç”¨ (è·ç¦», é•¿åº¦) å¯¹æ›¿æ¢: (12, 5)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>è¾“å‡º: &quot;hello world &quot; + (12,5) + &quot; redis&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div style="border:1px solid #096dd9;padding:20px;border-radius:15px;background-color:#f0f8ff;max-width:800px;margin:0 auto;box-shadow:0 4px 8px rgba(0, 0, 0, 0.1);"><p>å—¨å—¨å—¨ï¼Œæ—¶éš”ä¸¤å¹´ï¼Œé¢æ¸£é€†è¢­<a href="https://javabetter.cn/sidebar/sanfene/nixi.html" style="color:#096dd9;text-decoration:none;font-weight:bold;">ç¬¬äºŒç‰ˆ PDF ç»ˆäºå¯ä»¥ä¸‹è½½äº†</a>ã€‚æˆ‘ä»¬åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼š</p><ol style="margin-left:20px;"><li><strong><span style="color:#d32f2f;">å¯¹äºé«˜é¢‘é¢˜</span></strong>ï¼šä¼šæ ‡æ³¨åœ¨ã€Š<a href="https://javabetter.cn/zhishixingqiu/mianshi.html" style="color:#096dd9;">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>ä¸­å‡ºç°çš„ä½ç½®ï¼Œå“ªå®¶å…¬å¸ï¼ŒåŸé¢˜æ˜¯ä»€ä¹ˆï¼›å¦‚æœä½ æƒ³èŠ‚çœæ—¶é—´çš„è¯ï¼Œå¯ä»¥ä¼˜å…ˆèƒŒè¯µè¿™äº›é¢˜ç›®ï¼Œå°½å¿«åšåˆ°çŸ¥å½¼çŸ¥å·±ï¼Œç™¾æˆ˜ä¸æ®†ã€‚</li><li><strong><span style="color:#d32f2f;">ç»“åˆé¡¹ç›®</span></strong>ï¼šåŒ…æ‹¬<a href="https://javabetter.cn/zhishixingqiu/paicoding.html" style="color:#096dd9;">æŠ€æœ¯æ´¾</a>ã€<a href="https://t.zsxq.com/0bhcI0Gs6" style="color:#096dd9;">mydb</a>ã€<a href="https://javabetter.cn/zhishixingqiu/pmhub.html" style="color:#096dd9;">pmhub</a>æ¥ç»„ç»‡è¯­è¨€ï¼Œè®©é¢è¯•å®˜æœ€å¤§ç¨‹åº¦æ„Ÿå—åˆ°ä½ çš„è¯šæ„ï¼Œè€Œä¸æ˜¯æœºæ¢°åŒ–çš„èƒŒè¯µã€‚</li><li><strong><span style="color:#d32f2f;">ä¿®å¤é—®é¢˜</span></strong>ï¼šç¬¬ä¸€ç‰ˆä¸­å‡ºç°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬çƒå‹ä»¬çš„ç§ä¿¡åé¦ˆï¼Œç½‘ç«™ç•™è¨€åŒºçš„è¯„è®ºï¼Œä»¥åŠ<a href="https://github.com/itwanger/toBeBetterJavaer/issues" style="color:#096dd9;"> GitHub ä»“åº“ä¸­çš„ issue</a>ï¼Œè®©è¿™ä»½é¢è¯•æŒ‡å—æ›´åŠ å®Œå–„ã€‚</li><li><strong><span style="color:#d32f2f;">ä¼˜åŒ–æ’ç‰ˆ</span></strong>ï¼šå¢åŠ æ‰‹ç»˜å›¾ï¼Œé‡æ–°ç»„ç»‡ç­”æ¡ˆï¼Œä½¿å…¶æ›´åŠ å£è¯­åŒ–ï¼Œä»è€Œæ›´è´´è¿‘é¢è¯•å®˜çš„é¢„æœŸã€‚</li></ol><p>ä½ å¯ä»¥æ‰«ä¸‹é¢çš„äºŒç»´ç ï¼ˆæˆ–è€…é•¿æŒ‰è‡ªåŠ¨è¯†åˆ«ï¼‰å…³æ³¨ã€<b>æ²‰é»˜ç‹äºŒ</b>ã€‘å…¬ä¼—å·ï¼Œå‘é€å…³é”®å­— <b>222</b> æ¥è·å– PDF ç‰ˆæœ¬ï¼Œå¦‚æœé¢æ¸£é€†è¢­çœŸçš„å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¸Œæœ›èƒ½ç»™äºŒå“¥çš„å…¬ä¼—å·åŠ ä¸€ä¸ªæ˜Ÿæ ‡ï¼Œæ»¡è¶³æˆ‘é‚£ä¸€ä¸ç‚¹è™šè£å¿ƒï¼Œè¿™å°†æ˜¯æˆ‘æ›´æ–°ä¸‹å»çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p><div style="text-align:center;margin:20px 0;"><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width:100%;height:auto;border-radius:10px;"></div><p>é¢æ¸£é€†è¢­çš„æ•´ç†å·¥ä½œçœŸçš„å¤ªä¸å®¹æ˜“äº†ï¼ŒèŠ±äº†æˆ‘å¥½å¤šå¥½å¤šçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œå†…å®¹å®Œå…¨å…è´¹ï¼Œä½†è´¨é‡å´æœ‰å£çš†ç¢‘ï¼Œå°±æ˜¯ä¸ºäº†åšä¸€ç‚¹çœŸæ­£æœ‰æ„ä¹‰çš„ã€çº¯ç²¹çš„äº‹æƒ…ã€‚</p></div><p>memoï¼š2025 å¹´ 6 æœˆ 10 æ—¥ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘ä¿¡æ¯</a>è¯´æ‰¾æˆ‘ä¿®æ”¹äº†ç®€å†åï¼ŒåˆæŒ‰ç…§æ˜Ÿçƒçš„å­¦ä¹ èµ„æ–™å¥½å¥½å­¦äº†ä¸€ä¸‹ä¹‹åï¼Œæ‹¿åˆ°äº†å­—èŠ‚è·³åŠ¨çš„ offerï¼Œå¹¶ç‰¹æ„å‘äº†ä¸€ä¸ªå¤§çº¢åŒ…æ¥æ„Ÿè°¢ã€‚è¿™ç§è¢«è®¤å¯è¢«éœ€è¦çš„æ„Ÿè§‰ï¼ŒçœŸå¥½ï¼</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-äºŒå“¥ï¼Œæˆ‘æ˜¯ä¹‹å‰å‘é‚®ä»¶è¯·æ‚¨ä¿®æ”¹ç®€.png" alt="çƒå‹æ‹¿åˆ°äº†å­—èŠ‚è·³åŠ¨çš„ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°äº†å­—èŠ‚è·³åŠ¨çš„ offer</figcaption></figure><h2 id="è¡¥å……" tabindex="-1"><a class="header-anchor" href="#è¡¥å……"><span>è¡¥å……</span></a></h2><h3 id="_55-å‡å¦‚-redis-é‡Œé¢æœ‰-1-äº¿ä¸ª-key-å…¶ä¸­æœ‰-10w-ä¸ª-key-æ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥çš„å‰ç¼€å¼€å¤´çš„-å¦‚ä½•å°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥" tabindex="-1"><a class="header-anchor" href="#_55-å‡å¦‚-redis-é‡Œé¢æœ‰-1-äº¿ä¸ª-key-å…¶ä¸­æœ‰-10w-ä¸ª-key-æ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥çš„å‰ç¼€å¼€å¤´çš„-å¦‚ä½•å°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥"><span>55.å‡å¦‚ Redis é‡Œé¢æœ‰ 1 äº¿ä¸ª keyï¼Œå…¶ä¸­æœ‰ 10w ä¸ª key æ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥çš„å‰ç¼€å¼€å¤´çš„ï¼Œå¦‚ä½•å°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥ï¼Ÿ</span></a></h3><p>æˆ‘ä¼šä½¿ç”¨ SCAN å‘½ä»¤é…åˆ MATCH å‚æ•°æ¥è§£å†³ã€‚</p><p>æ¯”å¦‚è¦æ‰¾ä»¥ <code>user:</code> å¼€å¤´çš„ keyï¼Œå¯ä»¥æ‰§è¡Œ <code>SCAN 0 MATCH user:* COUNT 1000</code>ã€‚</p><p>SCAN çš„ä¼˜åŠ¿åœ¨äºå®ƒæ˜¯åŸºäºæ¸¸æ ‡çš„å¢é‡è¿­ä»£ï¼Œæ¯æ¬¡åªè¿”å›ä¸€å°æ‰¹ç»“æœï¼Œä¸ä¼šé˜»å¡æœåŠ¡å™¨ã€‚å¯ä»¥ä»æ¸¸æ ‡ 0 å¼€å§‹ï¼Œæ¯æ¬¡å¤„ç†è¿”å›çš„ key åˆ—è¡¨ï¼Œç„¶åç”¨è¿”å›çš„ä¸‹ä¸€ä¸ªæ¸¸æ ‡ç»§ç»­æ‰«æï¼Œç›´åˆ°æ¸¸æ ‡å›åˆ° 0 è¡¨ç¤ºæ‰«æå®Œæˆã€‚</p><p>ä½¿ç”¨ Spring Data Redis çš„ä»£ç ç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Service</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisKeyService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> scanKeysByPrefix</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> prefix</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> batchSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">keys</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ArrayList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        ScanOptions</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> options</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ScanOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">scanOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">match</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(prefix </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;*&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(batchSize)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Cursor</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cursor</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">scan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(options)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">cursor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hasNext</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                keys</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">cursor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> keys;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åƒä¸‡ä¸è¦ç”¨ KEYS å‘½ä»¤ï¼Œå› ä¸º KEYS ä¼šé˜»å¡ Redis æœåŠ¡å™¨ç›´åˆ°éå†å®Œæ‰€æœ‰ keyï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯¹ 1 äº¿ä¸ª key æ‰§è¡Œ KEYS æ˜¯éå¸¸å±é™©çš„ã€‚</p><p>memoï¼š2025 å¹´ 6 æœˆ 11 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©æœ‰è¯»è€…ç•™è¨€è¯´ï¼Œæ‰¾å®ä¹ çš„æ—¶å€™èƒŒäº†ä¸€ä¸ªæœˆçš„<a href="https://javabetter.cn/sidebar/sanfene/nixi.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­</a>ï¼Œç„¶åå¿«æ‰‹å’Œç¾å›¢éƒ½æ‹¿åˆ° offer äº†ã€‚èƒ½å¸®åŠ©åˆ°å¤§å®¶ï¼Œä¹Ÿæ˜¯æˆ‘åšæŠ€æœ¯åšä¸»æœ€å¼€å¿ƒçš„ä¸€ä»¶äº‹æƒ…äº†ï¼Œä¹Ÿæ„Ÿè°¢è¯»è€…ç»™çš„å£ç¢‘ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250612102525.png" alt="æ‹¿åˆ°å¿«æ‰‹å’Œç¾å›¢çš„è¯»è€…å‘æ¥æ„Ÿè°¢" tabindex="0" loading="lazy"><figcaption>æ‹¿åˆ°å¿«æ‰‹å’Œç¾å›¢çš„è¯»è€…å‘æ¥æ„Ÿè°¢</figcaption></figure><h3 id="_56-redisåœ¨ç§’æ€åœºæ™¯ä¸‹å¯ä»¥æ‰®æ¼”ä»€ä¹ˆè§’è‰²" tabindex="-1"><a class="header-anchor" href="#_56-redisåœ¨ç§’æ€åœºæ™¯ä¸‹å¯ä»¥æ‰®æ¼”ä»€ä¹ˆè§’è‰²"><span>56.Redisåœ¨ç§’æ€åœºæ™¯ä¸‹å¯ä»¥æ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿ</span></a></h3><p>ç§’æ€æ˜¯ä¸€ç§éå¸¸ç‰¹æ®Šçš„ä¸šåŠ¡åœºæ™¯ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯åœ¨æçŸ­æ—¶é—´å†…ä¼šæœ‰å¤§é‡ç”¨æˆ·æ¶Œå…¥ç³»ç»Ÿï¼Œå¯¹ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€å“åº”é€Ÿåº¦å’Œæ•°æ®ä¸€è‡´æ€§éƒ½æå‡ºäº†æé«˜çš„è¦æ±‚ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼ŒRedis ä½œä¸ºä¸€ç§é«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“ï¼Œèƒ½å¤Ÿå‘æŒ¥å¤šæ–¹é¢çš„å…³é”®ä½œç”¨ã€‚</p><p>æ¯”å¦‚è¯´åœ¨ç§’æ€å¼€å§‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†å•†å“ä¿¡æ¯ã€åº“å­˜æ•°æ®ç­‰é¢„å…ˆåŠ è½½åˆ° Redis ä¸­ï¼Œè¿™æ ·å¤§é‡çš„ç”¨æˆ·è¯»è¯·æ±‚å°±å¯ä»¥ç›´æ¥ä» Redis ä¸­è·å–å“åº”ï¼Œè€Œä¸å¿…æ¯æ¬¡éƒ½å»è®¿é—®æ•°æ®åº“ï¼Œè¿™æ ·å°±èƒ½å¤§å¤§å‡è½»æ•°æ®åº“çš„è®¿é—®å‹åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240420102552.png" alt="è®¸ä»¤æ³¢-ç§’æ€ç³»ç»Ÿçš„è®¾è®¡" tabindex="0" loading="lazy"><figcaption>è®¸ä»¤æ³¢-ç§’æ€ç³»ç»Ÿçš„è®¾è®¡</figcaption></figure><p>å…¶æ¬¡ï¼ŒRedis åœ¨åº“å­˜æ§åˆ¶æ–¹é¢å…·æœ‰å¾—å¤©ç‹¬åšçš„ä¼˜åŠ¿ã€‚ç§’æ€æœ€æ ¸å¿ƒçš„é—®é¢˜ä¹‹ä¸€å°±æ˜¯å®¹æ˜“å‘ç”Ÿè¶…å–ã€‚Redis æä¾›çš„åŸå­æ“ä½œå¦‚ DECRã€DECRBY ç­‰å‘½ä»¤ï¼Œå¯ä»¥ç¡®ä¿åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹åº“å­˜è®¡æ•°çš„å‡†ç¡®æ€§ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250612103728.png" alt="äº¬ä¸œäº‘ï¼šè¶…å–" tabindex="0" loading="lazy"><figcaption>äº¬ä¸œäº‘ï¼šè¶…å–</figcaption></figure><p>æ›´å¤æ‚çš„é€»è¾‘ï¼Œå¯ä»¥é€šè¿‡ Lua è„šæœ¬æ¥å®ç°ï¼Œå› ä¸º Lua è„šæœ¬åœ¨ Redis ä¸­æ˜¯åŸå­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¯ä»¥åŒ…å«å¤æ‚çš„åˆ¤æ–­å’Œæ“ä½œé€»è¾‘ï¼Œæ¯”å¦‚å…ˆæ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³ï¼Œå†è¿›è¡Œæ‰£å‡ï¼Œè¿™æ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸ä¼šè¢«å…¶ä»–æ“ä½œæ‰“æ–­çš„ã€‚</p><p>ç¬¬ä¸‰ç‚¹ï¼ŒRedis çš„åˆ†å¸ƒå¼é”å¯ä»¥ç¡®ä¿å¤šä¸ªç”¨æˆ·åŒæ—¶æŠ¢è´­åŒä¸€ä»¶å•†å“æ—¶çš„æ“ä½œæ˜¯äº’æ–¥çš„ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§çš„åŒæ—¶ï¼Œè¿˜å¯ä»¥ç”¨æ¥é˜²æ­¢ç”¨æˆ·é‡å¤ä¸‹å•ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250612104416.png" alt="å°ç±³ä¿¡æ¯æŠ€æœ¯å›¢é˜Ÿï¼šRedis åˆ†å¸ƒå¼é”" tabindex="0" loading="lazy"><figcaption>å°ç±³ä¿¡æ¯æŠ€æœ¯å›¢é˜Ÿï¼šRedis åˆ†å¸ƒå¼é”</figcaption></figure><p>ç¬¬å››ç‚¹ï¼Œé™æµå‰Šå³°ã€‚ç§’æ€å¼€å§‹çš„ç¬é—´ï¼Œå¯èƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡çš„è¯·æ±‚åŒæ—¶åˆ°è¾¾ï¼Œå¦‚æœä¸åŠ æ§åˆ¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚Redis å¯ä»¥å®ç°å¤šç§é™æµç®—æ³•ï¼Œæ¯”å¦‚ç®€å•çš„è®¡æ•°å™¨é™æµã€ä»¤ç‰Œæ¡¶æˆ–æ¼æ¡¶ç®—æ³•ç­‰ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250612104916.png" alt="zhuangyongxin.github.ioï¼šä»¤ç‰Œæ¡¶" tabindex="0" loading="lazy"><figcaption>zhuangyongxin.github.ioï¼šä»¤ç‰Œæ¡¶</figcaption></figure><p>é€šè¿‡é™æµç®—æ³•æˆ‘ä»¬å¯ä»¥æ§åˆ¶å•ä½æ—¶é—´å†…ç³»ç»Ÿèƒ½å¤Ÿå¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œè¶…å‡ºéƒ¨åˆ†å¯ä»¥æ’é˜Ÿæˆ–è€…ç›´æ¥æ‹’ç»ï¼Œä»è€Œä¿æŠ¤ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œã€‚</p><p>memoï¼š2025 å¹´ 6 æœˆ 12 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">æœ‰çƒå‹å‘ä¿¡æ¯è¯´</a>ï¼Œå¤§äºŒå°±æ‹¿ä¸‹äº†ç¾å›¢çš„å®ä¹  offerï¼Œç‰¹æ„å‘æ¥æ„Ÿè°¢ï¼Œè¯´æˆ‘çš„ä»˜å‡ºå¯¹ä»–æœ‰ç€å·¨å¤§çš„å¸®åŠ©ï¼ŒçœŸçš„å¾ˆæ„ŸåŠ¨ï¼Œæ¯ä¸€ä¸ªæ‡‚å¾—æ„Ÿæ©çš„çƒå‹ï¼Œä½ ä»¬ä¹Ÿæ˜¯æˆ‘åšæŒä¸‹å»çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250612152123.png" alt="å¤§äºŒé‚£äº›ç¾å›¢ï¼Œç‰¹æ„å‘æ¥æ„Ÿè°¢ï¼Œé¢æ¸£çš„å£ç¢‘ç»§ç»­+1" tabindex="0" loading="lazy"><figcaption>å¤§äºŒé‚£äº›ç¾å›¢ï¼Œç‰¹æ„å‘æ¥æ„Ÿè°¢ï¼Œé¢æ¸£çš„å£ç¢‘ç»§ç»­+1</figcaption></figure><h4 id="rediså…·ä½“å¦‚ä½•å®ç°å‰Šå³°å‘¢" tabindex="-1"><a class="header-anchor" href="#rediså…·ä½“å¦‚ä½•å®ç°å‰Šå³°å‘¢"><span>Rediså…·ä½“å¦‚ä½•å®ç°å‰Šå³°å‘¢ï¼Ÿ</span></a></h4><p>å‰Šå³°çš„æœ¬è´¨æ˜¯å°†ç¬æ—¶çš„é«˜æµé‡è¯·æ±‚ç¼“å†²èµ·æ¥ï¼Œé€šè¿‡æ’é˜Ÿã€é™æµç­‰æœºåˆ¶ï¼Œä½¿ç³»ç»Ÿä»¥ä¸€ä¸ªå¯æ‰¿å—çš„é€Ÿåº¦æ¥å¤„ç†è¯·æ±‚ã€‚</p><p>é‚£ç¬¬ä¸€æ­¥å°±æ˜¯ç¼“å­˜é¢„çƒ­ã€‚åœ¨ç§’æ€æ´»åŠ¨å¼€å§‹å‰ï¼Œå…ˆæŠŠå•†å“ä¿¡æ¯è¿™äº›çƒ­ç‚¹æ•°æ®æå‰åŠ è½½åˆ° Redis ä¸­ã€‚è¿™æ ·ç”¨æˆ·è®¿é—®å•†å“é¡µé¢æ—¶ï¼Œå¯ä»¥ç›´æ¥ä» Redis è¯»å–ï¼Œæ•°æ®åº“åŸºæœ¬ä¸Šä¸ä¼šæœ‰å‹åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250613104134.png" alt="å¤©ç¿¼äº‘å°ç¿¼ï¼šRedis ç¼“å­˜é¢„çƒ­" tabindex="0" loading="lazy"><figcaption>å¤©ç¿¼äº‘å°ç¿¼ï¼šRedis ç¼“å­˜é¢„çƒ­</figcaption></figure><p>ç¬¬äºŒæ­¥æ˜¯å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç‰¹åˆ«æ˜¯ä¸‹å•è¿™ç§å†™æ“ä½œï¼Œä¸èƒ½è®©ç”¨æˆ·ç­‰å¤ªä¹…ï¼Œä½†åç«¯å¤„ç†è®¢å•ã€æ‰£åº“å­˜è¿™äº›æ“ä½œåˆæ¯”è¾ƒé‡ã€‚æ‰€ä»¥å¯ä»¥ç”¨ Redis çš„ List åšäº†ä¸ªé˜Ÿåˆ—ï¼Œæˆ–è€…ç›´æ¥ç”¨ RocketMQ è¿™ç§æ ‡å‡†çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç”¨æˆ·ä¸‹å•åç«‹å³è¿”å›&quot;è®¢å•æäº¤æˆåŠŸ&quot;ï¼Œç„¶åæŠŠè®¢å•æ•°æ®ä¸¢åˆ°é˜Ÿåˆ—é‡Œï¼Œåå°æœåŠ¡æ…¢æ…¢æ¶ˆè´¹ã€‚è¿™æ ·æ—¢ä¿è¯äº†ç”¨æˆ·ä½“éªŒï¼Œåˆé¿å…äº†ç³»ç»Ÿè¢«ç¬æ—¶å†™è¯·æ±‚å‹å®ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240420104633.png" alt="è®¸ä»¤æ³¢-æ’é˜Ÿ" tabindex="0" loading="lazy"><figcaption>è®¸ä»¤æ³¢-æ’é˜Ÿ</figcaption></figure><p>ç¬¬ä¸‰æ­¥ï¼Œå¯ä»¥åœ¨ç§’æ€æ´»åŠ¨ä¸­åŠ å…¥ç­”é¢˜ç¯èŠ‚ï¼Œåªæœ‰ç­”å¯¹é¢˜ç›®çš„ç”¨æˆ·æ‰èƒ½å‚ä¸ç§’æ€æ´»åŠ¨ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§ç¨‹åº¦å‡å°‘æ— æ•ˆè¯·æ±‚ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240420104921.png" alt="è®¸ä»¤æ³¢-ç­”é¢˜" tabindex="0" loading="lazy"><figcaption>è®¸ä»¤æ³¢-ç­”é¢˜</figcaption></figure><p>ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ç§’æ€å‰Šå³°å¤„ç†æ–¹æ¡ˆï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Service</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> SeckillServiceImpl</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> SeckillService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> OrderService</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> orderService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CommodityService</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> commodityService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * ç§’æ€è¯·æ±‚å…¥å£</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Result</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> seckill</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> userId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> commodityId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // 1. ç”¨æˆ·è¯·æ±‚é¢‘ç‡é™åˆ¶</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">countRateLimit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> userId, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">60</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;è¯·æ±‚è¿‡äºé¢‘ç¹&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // 2. å•†å“æ˜¯å¦åœ¨ç§’æ€æ—¶é—´å†…</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">isInSeckillTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(commodityId)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ç§’æ€æœªå¼€å§‹æˆ–å·²ç»“æŸ&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // 3. æ˜¯å¦è¿˜æœ‰åº“å­˜(å¿«é€Ÿå¤±è´¥)</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stockKey</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;seckill:stock:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> commodityId;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Integer</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stock</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Integer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">valueOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(stockKey));</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (stock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> stock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;å•†å“å·²å”®ç½„&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // 4. å…¨å±€é™æµ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">acquireToken</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;global&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œå°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—å»¶è¿Ÿå¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            enqueueDelayedRequest</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(userId, commodityId);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">success</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ç§’æ€è¯·æ±‚å·²å—ç†ï¼Œæ’é˜Ÿå¤„ç†ä¸­&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // 5. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è´­ä¹°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hasUserBought</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(userId, commodityId)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;æ‚¨å·²ç»è´­ä¹°è¿‡è¯¥å•†å“&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // 6. å°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ï¼Œè¿”å›æ’é˜ŸçŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> requestId</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> generateRequestId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(userId, commodityId);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        enqueueRequest</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(userId, commodityId, requestId);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">success</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ç§’æ€è¯·æ±‚å·²æäº¤ï¼Œè¯·ç­‰å¾…ç»“æœ&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, requestId);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * å¼‚æ­¥å¤„ç†ç§’æ€è¯·æ±‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Scheduled</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">fixedRate</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 50</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ¯50mså¤„ç†ä¸€æ‰¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> processSeckillQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> queueKey</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;seckill:queue&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // æ‰¹é‡å¤„ç†ï¼Œæ§åˆ¶å¤„ç†é€Ÿåº¦</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i++) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> requestJson</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">leftPop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(queueKey);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (requestJson </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            SeckillRequest</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> request</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> JSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">parseObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(requestJson, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SeckillRequest</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // æ‰§è¡Œç§’æ€æ ¸å¿ƒé€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> success</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> doSeckill</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getUserId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getCommodityId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // æ›´æ–°è¯·æ±‚çŠ¶æ€ï¼Œä¾¿äºç”¨æˆ·æŸ¥è¯¢</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> statusKey</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;seckill:status:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getRequestId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(statusKey, success </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;SUCCESS&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;FAILED&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">HOURS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;å¤„ç†ç§’æ€è¯·æ±‚å¤±è´¥&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, e);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // è®°å½•å¤±è´¥çŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> statusKey</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;seckill:status:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getRequestId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(statusKey, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ERROR&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">HOURS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * ç§’æ€æ ¸å¿ƒé€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> doSeckill</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> userId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> commodityId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> script</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;-- æ£€æŸ¥åº“å­˜</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;local stockKey = KEYS[1]</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;local stock = tonumber(redis.call(&#39;get&#39;, stockKey))</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;if stock == nil or stock &lt;= 0 then</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;    return 0</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;end</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;-- æ£€æŸ¥æ˜¯å¦é‡å¤è´­ä¹°</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;local boughtKey = KEYS[2]</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;local hasBought = redis.call(&#39;sismember&#39;, boughtKey, ARGV[1])</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;if hasBought == 1 then</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;    return -1</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;end</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;-- æ‰£å‡åº“å­˜å¹¶è®°å½•è´­ä¹°</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;redis.call(&#39;decr&#39;, stockKey)</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;redis.call(&#39;sadd&#39;, boughtKey, ARGV[1])</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;-- è¿”å›æˆåŠŸ</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;return 1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stockKey</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;seckill:stock:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> commodityId;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> boughtKey</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;seckill:bought:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> commodityId;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> result</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (Long) </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DefaultRedisScript</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;(script, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            Arrays</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">asList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(stockKey, boughtKey),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            userId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        );</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // åˆ›å»ºè®¢å•(å¯ä»¥è¿›ä¸€æ­¥å¼‚æ­¥åŒ–)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            createOrder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(userId, commodityId);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // å…¶ä»–è¾…åŠ©æ–¹æ³•...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="rediså¦‚ä½•åšé™æµå‘¢" tabindex="-1"><a class="header-anchor" href="#rediså¦‚ä½•åšé™æµå‘¢"><span>Rediså¦‚ä½•åšé™æµå‘¢ï¼Ÿ</span></a></h4><p>é™æµæ˜¯ä¸ºäº†æ§åˆ¶ç³»ç»Ÿçš„è¯·æ±‚é€Ÿç‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¢«è¿‡å¤šçš„è¯·æ±‚å‹å®ã€‚</p><p>Redis å®ç°é™æµæœ€ç®€å•çš„æ–¹æ³•æ˜¯åŸºäºè®¡æ•°å™¨çš„å›ºå®šçª—å£é™æµã€‚æ¯”å¦‚é™åˆ¶ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤šè®¿é—® 100 æ¬¡ï¼Œæˆ‘ä»¬å°±ç”¨ INCR å‘½ä»¤ç»™æ¯ä¸ªç”¨æˆ·è®¾ä¸ªè®¡æ•°å™¨ï¼Œkey æ˜¯ <code>rate_limit:ç”¨æˆ·ID:åˆ†é’Ÿæ—¶é—´æˆ³</code>ï¼Œæ¯æ¬¡è¯·æ±‚å°±åŠ  1ï¼ŒåŒæ—¶è®¾ç½® 60 ç§’è¿‡æœŸã€‚å¦‚æœè®¡æ•°è¶…è¿‡ 100 å°±æ‹’ç»è¯·æ±‚ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ä¼ªä»£ç </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> key </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;rate_limit:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> userId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å°è¯•è·å–å½“å‰è®¡æ•°</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> count </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å¦‚æœkeyä¸å­˜åœ¨ï¼Œè®¾ç½®ä¸º1å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (count </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">60</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // 60ç§’çª—å£æœŸ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // å…è®¸è®¿é—®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// å¦‚æœè®¡æ•°æœªè¶…è¿‡é™åˆ¶</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (count </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> maxRequests) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">incr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // å…è®¸è®¿é—®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // æ‹’ç»è®¿é—®</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§æ–¹æ³•ç®€å•ç²—æš´ï¼Œä½†æœ‰ä¸ªé—®é¢˜å°±æ˜¯ä¸´ç•Œæ—¶é—´ä¼šæœ‰çªåˆºï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨ç¬¬ 59 ç§’è®¿é—®äº† 100 æ¬¡ï¼Œç¬¬ 61 ç§’åˆè®¿é—® 100 æ¬¡ï¼Œç›¸å½“äº 2 ç§’å†…è®¿é—®äº† 200 æ¬¡ã€‚</p><p>ç¬¬äºŒç§å°±æ˜¯æ»‘åŠ¨çª—å£é™æµï¼Œé€šè¿‡ Redis çš„ ZSET æ¥å®ç°ï¼ŒæŠŠæ¯æ¬¡è¯·æ±‚çš„æ—¶é—´æˆ³ä½œä¸º score å­˜è¿›å»ï¼Œç„¶åç”¨ ZREMRANGEBYSCORE åˆ é™¤çª—å£å¤–çš„æ—§æ•°æ®ï¼Œå†ç”¨ ZCARD ç»Ÿè®¡å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°ã€‚è¿™æ ·é™æµå°±æ¯”è¾ƒå‡åŒ€äº†ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ä¼ªä»£ç </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> key </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;sliding_window:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> userId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> now </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentTimeMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// æ·»åŠ å½“å‰è¯·æ±‚åˆ°æœ‰åºé›†åˆï¼Œscoreä¸ºå½“å‰æ—¶é—´æˆ³</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">zadd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, now, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">valueOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(now));</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// ç§»é™¤æ—¶é—´çª—å£ä¹‹å‰çš„è¯·æ±‚æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">zremrangeByScore</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, now </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> windowSize);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è®¾ç½®keyè¿‡æœŸæ—¶é—´ï¼Œé¿å…å†·ç”¨æˆ·æŒç»­å ç”¨å†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">expire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, windowSize </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// è·å–å½“å‰çª—å£çš„è¯·æ±‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> count </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">zcard</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> count </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> maxRequests</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œé€šå¸¸ä¼šé‡‡ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå®ƒå°±åƒåœ¨å¸éƒ½/é­”éƒ½ä¹°è½¦ï¼Œæ‘‡åˆ°å·æ‰æœ‰èµ„æ ¼ï¼Œæ²¡æ‘‡åˆ°å°±åªèƒ½ç­‰ä¸‹ä¸€æ¬¡ï¼ˆğŸ˜ï¼‰ã€‚</p><p>å¯ä»¥åœ¨ Redis é‡Œå­˜ä¸¤ä¸ªå€¼ï¼Œä¸€ä¸ªæ˜¯ä»¤ç‰Œæ•°é‡ï¼Œä¸€ä¸ªæ˜¯ä¸Šæ¬¡æ›´æ–°æ—¶é—´ã€‚æ¯æ¬¡è¯·æ±‚æ—¶ç”¨ Lua è„šæœ¬è®¡ç®—åº”è¯¥è¡¥å……å¤šå°‘ä»¤ç‰Œï¼Œç„¶ååˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20240420114025.png" alt="æå­æŒï¼šä»¤ç‰Œæ¡¶" tabindex="0" loading="lazy"><figcaption>æå­æŒï¼šä»¤ç‰Œæ¡¶</figcaption></figure><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- Redis Luaè„šæœ¬å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">KEYS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]  </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- é™æµçš„key</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> max_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])  </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- æœ€å¤§ä»¤ç‰Œæ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> permits_per_second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])  </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- æ¯ç§’äº§ç”Ÿçš„ä»¤ç‰Œæ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> required_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ARGV</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])  </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- è¯·æ±‚çš„ä»¤ç‰Œæ•°</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- è·å–å½“å‰æ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;time&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> now_micros</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]) * </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> + </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- è·å–ä¸Šæ¬¡æ›´æ–°çš„æ—¶é—´å’Œå½“å‰å­˜å‚¨çš„ä»¤ç‰Œæ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> last_micros</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;hget&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;last_micros&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) or </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stored_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tonumber</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;hget&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;stored_permits&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) or </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- è®¡ç®—æ—¶é—´é—´éš”å†…æ–°äº§ç”Ÿçš„ä»¤ç‰Œæ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> interval_micros</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now_micros</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">last_micros</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> new_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">interval_micros</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">permits_per_second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> / </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000000</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stored_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">math.min</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">max_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stored_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> + </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">new_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- åˆ¤æ–­ä»¤ç‰Œæ˜¯å¦è¶³å¤Ÿ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stored_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt;= </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">required_permits</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    -- ä»¤ç‰Œè¶³å¤Ÿï¼Œæ›´æ–°ä»¤ç‰Œæ•°å’Œæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    stored_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stored_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">required_permits</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- æ›´æ–°Redisä¸­çš„æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;hset&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;last_micros&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now_micros</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;hset&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;stored_permits&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stored_permits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;expire&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)  </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">-- è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé¿å…é•¿æœŸå ç”¨å†…å­˜</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> result</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 3 Java åç«¯é¢è¯•åŸé¢˜ï¼šç§’æ€é—®é¢˜ï¼ˆé”™å³°ã€å‰Šå³°ã€å‰ç«¯ã€æµé‡æ§åˆ¶ï¼‰</li><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„æ»´æ»´é¢ç»åŒå­¦ 3 ç½‘çº¦è½¦åç«¯å¼€å‘ä¸€é¢åŸé¢˜ï¼šé™æµç®—æ³•</li></ol></blockquote><p>memoï¼š2025 å¹´ 6 æœˆ 13 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">ä¿®æ”¹ç®€å†</a>çš„è¿‡ç¨‹ä¸­ï¼Œç¢°åˆ°ä¸€ä½è¥¿å®‰äº¤é€šå¤§å­¦çš„çƒå‹ï¼Œä»–æ•´ä¸ªæ ¡å›­ç»å†æ˜¯æ¯”è¾ƒä¸°å¯Œçš„ï¼Œå…ˆå»äº†æ–°åŠ å¡å›½ç«‹å¤§å­¦åšæš‘æœŸäº¤æ¢ç”Ÿï¼Œç„¶ååˆå»äº†åŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡åšå­¦æœŸäº¤æ¢ç”Ÿï¼Œå¸Œæœ›å¤§å®¶ä¹Ÿéƒ½èƒ½åœ¨å­¦æ ¡é˜¶æ®µå°½é‡ä¸°å¯Œè‡ªå·±çš„ç»å†ï¼Œäº‰å–å¤šæ‹¿ä¸€äº›å¥–å­¦é‡‘ã€å®ä¹ ç»å†ï¼Œè¿™æ ·æ‰èƒ½åœ¨æ¯•ä¸šæ—¶æœ‰æ›´å¼ºçš„ç«äº‰åŠ›ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250613110150.png" alt="è¥¿å®‰äº¤é€šå¤§å­¦çš„çƒå‹" tabindex="0" loading="lazy"><figcaption>è¥¿å®‰äº¤é€šå¤§å­¦çš„çƒå‹</figcaption></figure><h3 id="_57-å®¢æˆ·ç«¯å®•æœºå-redis-æœåŠ¡ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°" tabindex="-1"><a class="header-anchor" href="#_57-å®¢æˆ·ç«¯å®•æœºå-redis-æœåŠ¡ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°"><span>57.å®¢æˆ·ç«¯å®•æœºå Redis æœåŠ¡ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°ï¼Ÿ</span></a></h3><p>TCP çš„ keepalive æ˜¯ Redis ç”¨æ¥æ£€æµ‹å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€çš„ä¸»è¦æœºåˆ¶ï¼Œé»˜è®¤å€¼ä¸º 300 ç§’ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># é’ˆå¯¹ä½å»¶è¿Ÿåœºæ™¯ï¼Œè®¾ç½®ä¸º60ç§’ï¼Œè¡¨ç¤ºæ¯60ç§’å‘é€ä¸€æ¬¡keepaliveæ¢æµ‹</span></span>
<span class="line"><span>config set tcp-keepalive 60</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä»»ä½•æ•°æ®äº¤äº’æ—¶ï¼ŒRedis æœåŠ¡å™¨ä¼šå‘é€ TCP ACK æ¢æµ‹åŒ…ï¼Œå¦‚æœè¿ç»­å¤šæ¬¡æ²¡æœ‰æ”¶åˆ°å“åº”ï¼ŒTCP åè®®æ ˆä¼šé€šçŸ¥ Redis æœåŠ¡ç«¯è¿æ¥å·²æ–­å¼€ï¼Œä¹‹åï¼ŒRedis æœåŠ¡ç«¯ä¼šæ¸…ç†ç›¸å…³çš„è¿æ¥èµ„æºï¼Œé‡Šæ”¾è¿æ¥ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250614112846.png" alt="äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼šé»˜è®¤çš„tcp-keepaliveå’Œ timeout" tabindex="0" loading="lazy"><figcaption>äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼šé»˜è®¤çš„tcp-keepaliveå’Œ timeout</figcaption></figure><p>å¦å¤–è¿˜æœ‰ä¸€ä¸ª timeout å‚æ•°ï¼Œç”¨æ¥æ§åˆ¶å®¢æˆ·ç«¯è¿æ¥çš„ç©ºé—²è¶…æ—¶æ—¶é—´ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># è¡¨ç¤º600ç§’å†…æ²¡æœ‰ä»»ä½•å‘½ä»¤åˆ™æ–­å¼€è¿æ¥</span></span>
<span class="line"><span>config set timeout 600</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>é»˜è®¤å€¼ä¸º 0ï¼Œè¡¨ç¤ºæ°¸ä¸æ–­å¼€è¿æ¥ï¼›å½“è®¾ç½®ä¸ºéé›¶å€¼æ—¶ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰å‘é€ä»»ä½•å‘½ä»¤ï¼ŒæœåŠ¡ç«¯ä¼šä¸»åŠ¨æ–­å¼€è¿æ¥ã€‚</p><p>Redis æœåŠ¡å™¨ä¼šå®šæœŸæ£€æŸ¥ç©ºé—²è¿æ¥æ˜¯å¦è¶…æ—¶ï¼Œæ£€æŸ¥é¢‘ç‡ç”± hz å‚æ•°æ§åˆ¶ï¼›è¿™å°†æœ‰åŠ©äºé‡Šæ”¾é‚£äº›å®¢æˆ·ç«¯å¼‚å¸¸é€€å‡ºä½† TCP è¿æ¥æœªæ­£å¸¸å…³é—­çš„èµ„æºã€‚</p><p>ä¸åŒçš„è¿æ¥æ± ä¹Ÿä¼šæœ‰è‡ªå·±çš„è¿æ¥æ£€æµ‹æœºåˆ¶ï¼Œæ¯”å¦‚ Jedis è¿æ¥æ± å¯ä»¥é€šè¿‡è®¾ç½® <code>testOnBorrow</code> å’Œ <code>testWhileIdle</code> æ¥å¯ç”¨è¿æ¥æ£€æµ‹ã€‚</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># æ˜¯å¦å¯ç”¨è¿æ¥æ± </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">spring.redis.jedis.pool.enabled=true</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">spring.redis.jedis.pool.max-active=200</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># è¿æ¥æ± æœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">spring.redis.jedis.pool.max-idle=200</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># è¿æ¥æ± æœ€å°ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">spring.redis.jedis.pool.min-idle=50</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">spring.redis.jedis.pool.max-wait=3000</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># ç©ºé—²è¿æ¥æ£€æŸ¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">spring.redis.jedis.pool.time-between-eviction-runs=60000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ol><li><a href="https://javabetter.cn/zhishixingqiu/mianshi.html" target="_blank" rel="noopener noreferrer">Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰</a>æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 21 æŠ–éŸ³å•†åŸä¸€é¢é¢è¯•åŸé¢˜ï¼šå¦‚æœå®¢æˆ·ç«¯å®•æœºæœåŠ¡å™¨å¦‚ä½•æ„ŸçŸ¥ï¼Ÿ</li></ol></blockquote><p>memoï¼š2025 å¹´ 6 æœˆ 14 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©æœ‰<a href="https://javabetter.cn/zhishixingqiu/" target="_blank" rel="noopener noreferrer">çƒå‹åœ¨ VIP ç¾¤é‡Œ</a>å‘æ¶ˆæ¯è¯´ï¼Œå¿«æ‰‹oc äº†ï¼Œæ­å–œä»–ã€‚çƒå‹ä»¬éƒ½å¤ªæœ‰å®åŠ›äº†ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250614114251.png" alt="çƒå‹æ‹¿åˆ°å¿«æ‰‹ offer" tabindex="0" loading="lazy"><figcaption>çƒå‹æ‹¿åˆ°å¿«æ‰‹ offer</figcaption></figure><hr><p>æ•´æ•´ä¸€ä¸ªåŠæœˆï¼Œé¢æ¸£é€†è¢­ Redis ç¯‡ç¬¬äºŒç‰ˆç»ˆäºæ•´ç†å®Œäº†ï¼Œè¿™ä¸€ç‰ˆå‡ ä¹å¯ä»¥è¯´æ˜¯é‡å†™äº†ï¼Œæ¯å¤©è€—è´¹äº†å¤§é‡çš„ç²¾åŠ›åœ¨ä¸Šé¢ï¼Œå¯ä»¥è¯´æ˜¯æ”¹å¤´æ¢é¢ï¼Œæœ‰ä¸€ç§å£«åˆ«ä¿©æœˆï¼Œå½“åˆ®ç›®ç›¸çœ‹çš„æ„Ÿè§‰ï¼ˆä» 1.8 ä¸‡å­—æš´æ¶¨åˆ° 4.6 ä¸‡å­—ï¼ŒåŠ é¤çš„åŒæ—¶åŒºåˆ†é«˜é¢‘ä½é¢‘ç‰ˆï¼‰ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250614160051.png" alt="Redisã€MySQLã€Java åŸºç¡€ã€é›†åˆæ¡†æ¶ã€JVMã€å¹¶å‘ç¼–ç¨‹" tabindex="0" loading="lazy"><figcaption>Redisã€MySQLã€Java åŸºç¡€ã€é›†åˆæ¡†æ¶ã€JVMã€å¹¶å‘ç¼–ç¨‹</figcaption></figure><p>ç½‘ä¸Šçš„å…«è‚¡å…¶å®ä¸å°‘ï¼Œæœ‰äº›è¿˜æ˜¯ä»˜è´¹çš„ï¼Œæˆ‘è§‰å¾—æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œå¯ä»¥ç»™å¤§å®¶æä¾›æ›´å¤šçš„é€‰æ‹©ï¼Œä½†é¢æ¸£é€†è¢­çš„å«é‡‘é‡æ‡‚çš„éƒ½æ‡‚ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/mysql-20250427104555.png" alt="é¢æ¸£é€†è¢­é€‚åˆä¸­å›½å®å®ä½“è´¨å“ˆå“ˆ" tabindex="0" loading="lazy"><figcaption>é¢æ¸£é€†è¢­é€‚åˆä¸­å›½å®å®ä½“è´¨å“ˆå“ˆ</figcaption></figure><p>é¢æ¸£é€†è¢­ç¬¬äºŒç‰ˆæ˜¯åœ¨æ˜Ÿçƒå˜‰å®¾ä¸‰åˆ†æ¶çš„åˆç‰ˆåŸºç¡€ä¸Šï¼ŒåŠ å…¥äº†äºŒå“¥è‡ªå·±çš„æ€è€ƒï¼ŒåŠ å…¥äº† 1000 å¤šä»½çœŸå®é¢ç»ä¹‹åçš„ç»“æœï¼Œå¹¶ä¸”ä» 24 å±Šåˆ° 25 å±Šï¼Œå†åˆ° 26 å±Šï¼Œå¸®åŠ©äº†å¾ˆå¤šå°ä¼™ä¼´ã€‚æœªæ¥çš„ 27ã€28 å±Šï¼Œä¹Ÿå°†å› æ­¤å—ç›Šï¼Œä»è€Œæ‹¿åˆ°å¿ƒä»ªçš„ offerã€‚</p><p>èƒ½å¸®åŠ©åˆ°å¤§å®¶ï¼Œæˆ‘å¾ˆæ¬£æ…°ï¼Œå¹¶ä¸”åœ¨é‡åˆ¶é¢æ¸£é€†è¢­çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¹Ÿæˆé•¿äº†å¾ˆå¤šï¼Œå¾ˆå¤šè–„å¼±çš„åŸºç¡€ç¯èŠ‚éƒ½å¾—åˆ°äº†åŠ å¼ºï¼Œå› æ­¤ç¬¬äºŒç‰ˆçš„é¢æ¸£é€†è¢­ä¸åªæ˜¯ç»™å¤§å®¶çš„ç¤¼ç‰©ï¼Œä¹Ÿæ˜¯æˆ‘åœ¨æŠ€æœ¯ä¸Šèœ•å˜çš„è®°å½•ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/mysql-æˆ‘æŠŠä½ æ¨èç»™æˆ‘ä»¬å®éªŒå®¤çš„åŸºæœ¬æ‰€æœ‰äººäº†.png" alt="çƒå‹æŠŠé¢æ¸£é€†è¢­æ¨èç»™å®éªŒå®¤çš„æ‰€æœ‰äºº" tabindex="0" loading="lazy"><figcaption>çƒå‹æŠŠé¢æ¸£é€†è¢­æ¨èç»™å®éªŒå®¤çš„æ‰€æœ‰äºº</figcaption></figure><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/mysql-20250427104304.png" alt="å­¦é™¢æœ¬æ‹¿åˆ°æ»´æ»´ SP ç»™é¢æ¸£å£ç¢‘+1" tabindex="0" loading="lazy"><figcaption>å­¦é™¢æœ¬æ‹¿åˆ°æ»´æ»´ SP ç»™é¢æ¸£å£ç¢‘+1</figcaption></figure><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/mysql-20250427104416.png" alt="å¸‚é¢ä¸Šçš„å…«è‚¡çœ‹äº†ä¸å°‘ï¼Œè¿˜æ˜¯é¢æ¸£é€†è¢­æœ€èˆ’æœ" tabindex="0" loading="lazy"><figcaption>å¸‚é¢ä¸Šçš„å…«è‚¡çœ‹äº†ä¸å°‘ï¼Œè¿˜æ˜¯é¢æ¸£é€†è¢­æœ€èˆ’æœ</figcaption></figure><p>å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘è§‰å¾—è‡ªå·±æ˜¯ä¸€ä¸ªä½›ç³»çš„äººï¼Œä¸æ„¿æ„å’Œåˆ«äººäº‰ä¸ªé«˜ä½ï¼Œä¹Ÿä¸æ„¿æ„å»åˆ»æ„å®£ä¼ è‡ªå·±çš„ä½œå“ã€‚</p><p>æˆ‘å–œæ¬¢é™å¾…èŠ±å¼€ã€‚</p><p>å¦‚æœä½ è§‰å¾—é¢æ¸£é€†è¢­è¿˜ä¸é”™ï¼Œå¯ä»¥å‘Šè¯‰å­¦å¼Ÿå­¦å¦¹ä»¬æœ‰è¿™æ ·ä¸€ä»½å…è´¹çš„å­¦ä¹ èµ„æ–™ï¼Œå¸®æˆ‘åšä¸ªå£ç¢‘ã€‚</p><p>æˆ‘è¿˜ä¼šç»§ç»­ä¼˜åŒ–ï¼Œä¹Ÿä¸ç¡®å®šç¬¬ä¸‰ç‰ˆä»€ä¹ˆæ—¶å€™ä¼šæ¥ï¼Œä½†æˆ‘ä¼šå°½åŠ›ã€‚</p><p>æ„¿å¤§å®¶éƒ½æœ‰ä¸€ä¸ªå…‰æ˜çš„æœªæ¥ã€‚</p><p>ç”±äº PDF æ²¡åŠæ³•è‡ªæˆ‘æ›´æ–°ï¼Œæ‰€ä»¥éœ€è¦æœ€æ–°ç‰ˆçš„å°ä¼™ä¼´ï¼Œå¯ä»¥å¾®ä¿¡æœã€<strong>æ²‰é»˜ç‹äºŒ</strong>ã€‘ï¼Œæˆ–è€…æ‰«æ/é•¿æŒ‰è¯†åˆ«ä¸‹é¢çš„äºŒç»´ç ï¼Œå…³æ³¨äºŒå“¥çš„å…¬ä¼—å·ï¼Œå›å¤ã€<strong>222</strong>ã€‘å³å¯æ‹‰å–æœ€æ–°ç‰ˆæœ¬ã€‚</p><div style="text-align:center;margin:20px 0;"><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width:100%;height:auto;border-radius:10px;"></div><p>å½“ç„¶äº†ï¼Œè¯·å…è®¸æˆ‘çš„ä¸€ç‚¹ç‚¹ç§å¿ƒï¼Œé‚£å°±æ˜¯æ˜Ÿçƒçš„ PDF ç‰ˆæœ¬ä¼šæ¯”å…¬ä¼—å·æ—©ä¸€ä¸ªæœˆæ—¶é—´ï¼Œæ¯•ç«Ÿæ˜Ÿçƒç”¨æˆ·éƒ½ä»˜è´¹è¿‡äº†ï¼Œæˆ‘æœ‰å¿…è¦è®©ä»–ä»¬å…ˆäº«å—åˆ°ä¸€ç‚¹ç‚¹ç¦åˆ©ã€‚ç›¸ä¿¡å¤§å®¶ä¹Ÿéƒ½èƒ½ç†è§£ï¼Œæ¯•ç«Ÿåœ¨çº¿ç‰ˆæ˜¯å…è´¹çš„ï¼ŒCDNã€æœåŠ¡å™¨ã€åŸŸåã€OSS ç­‰ç­‰éƒ½æ˜¯éœ€è¦æˆæœ¬çš„ã€‚</p><p>æ›´åˆ«è¯´æˆ‘ä»˜å‡ºçš„æ—¶é—´å’Œç²¾åŠ›äº†ï¼Œå¤§å®¶è§‰å¾—æœ‰å¸®åŠ©è¿˜è¯·ç»™ä¸ªå£ç¢‘ï¼Œè®©ä½ èº«è¾¹çš„åŒäº‹ã€åŒå­¦éƒ½èƒ½å—ç›Šåˆ°ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/collection-20250512160410.png" alt="å›å¤ 222" tabindex="0" loading="lazy"><figcaption>å›å¤ 222</figcaption></figure><p>æˆ‘æŠŠäºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ã€JVM è¿›é˜¶ä¹‹è·¯ã€å¹¶å‘ç¼–ç¨‹è¿›é˜¶ä¹‹è·¯ï¼Œä»¥åŠæ‰€æœ‰é¢æ¸£é€†è¢­çš„ç‰ˆæœ¬éƒ½æ”¾è¿›æ¥äº†ï¼Œæ¶µç›– JavaåŸºç¡€ã€Javaé›†åˆã€Javaå¹¶å‘ã€JVMã€Springã€MyBatisã€è®¡ç®—æœºç½‘ç»œã€æ“ä½œç³»ç»Ÿã€MySQLã€Redisã€RocketMQã€åˆ†å¸ƒå¼ã€å¾®æœåŠ¡ã€è®¾è®¡æ¨¡å¼ã€Linux ç­‰ 16 ä¸ªå¤§çš„ä¸»é¢˜ï¼Œå…±æœ‰ 40 å¤šä¸‡å­—ï¼Œ2000+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯è¯šæ„æ»¡æ»¡ã€‚</p><p>è¿™æ¬¡ä»ç„¶æ˜¯ä¸‰ä¸ªç‰ˆæœ¬ï¼Œäº®ç™½ã€æš—é»‘å’Œ epub ç‰ˆæœ¬ã€‚ç»™å¤§å®¶å±•ç¤ºå…¶ä¸­ä¸€ä¸ª epub ç‰ˆæœ¬å§ï¼Œæœ‰äº›å°ä¼™ä¼´å¾ˆæ€¥éœ€è¿™ä¸ªç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¹Ÿæ»¡è¶³å¤§å®¶äº†ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/redis-20250614154745.png" alt="é¢æ¸£é€†è¢­ Redis ç¯‡ epub ç‰ˆæœ¬" tabindex="0" loading="lazy"><figcaption>é¢æ¸£é€†è¢­ Redis ç¯‡ epub ç‰ˆæœ¬</figcaption></figure><p>å›¾æ–‡è¯¦è§£ 57 é“ Redis é¢è¯•é«˜é¢‘é¢˜ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚æ•´ç†ï¼šæ²‰é»˜ç‹äºŒï¼Œæˆ³<a href="https://mp.weixin.qq.com/s/19u34NXALB1nOlBCE6Eg-Q" target="_blank" rel="noopener noreferrer">è½¬è½½é“¾æ¥</a>ï¼Œä½œè€…ï¼šä¸‰åˆ†æ¶ï¼Œæˆ³<a href="https://mp.weixin.qq.com/s/iJtNJYgirRugNBnzxkbB4Q" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a>ã€‚</p><p><em>æ²¡æœ‰ä»€ä¹ˆä½¿æˆ‘åœç•™â€”â€”é™¤äº†ç›®çš„ï¼Œçºµç„¶å²¸æ—æœ‰ç«ç‘°ã€æœ‰ç»¿è«ã€æœ‰å®é™çš„æ¸¯æ¹¾ï¼Œæˆ‘æ˜¯ä¸ç³»ä¹‹èˆŸ</em>ã€‚</p><p><strong>ç³»åˆ—å†…å®¹</strong>ï¼š</p><ul><li><a href="https://javabetter.cn/sidebar/sanfene/javase.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ Java SE ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/javathread.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ Java é›†åˆæ¡†æ¶ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/collection.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ Java å¹¶å‘ç¼–ç¨‹ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/jvm.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ JVM ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/spring.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ Spring ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/redis.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ Redis ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/mybatis.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ MyBatis ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/mysql.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ MySQL ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/os.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­æ“ä½œç³»ç»Ÿç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/network.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­è®¡ç®—æœºç½‘ç»œç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/rocketmq.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ RocketMQ ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/fenbushi.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­åˆ†å¸ƒå¼ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/weifuwu.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­å¾®æœåŠ¡ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/shejimoshi.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­è®¾è®¡æ¨¡å¼ç¯‡ ğŸ‘</a></li><li><a href="https://javabetter.cn/sidebar/sanfene/linux.html" target="_blank" rel="noopener noreferrer">é¢æ¸£é€†è¢­ Linux ç¯‡ ğŸ‘</a></li></ul></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/itwanger/toBeBetterJavaer/edit/master/docs/src/sidebar/sanfene/redis.md" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: www.qing_gee@163.com">æ²‰é»˜ç‹äºŒ</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/sidebar/sanfene/mysql.html" aria-label="é¢æ¸£é€†è¢­-MySQL"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->é¢æ¸£é€†è¢­-MySQL</div></a><a class="route-link auto-link next" href="/sidebar/sanfene/spring.html" aria-label="é¢æ¸£é€†è¢­-Spring"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">é¢æ¸£é€†è¢­-Spring<!----></div></a></nav><div id="vp-comment" class="giscus-wrapper input-top" style="display:block;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" preserveAspectRatio="xMidYMid" viewBox="0 0 100 100"><circle cx="28" cy="75" r="11" fill="currentColor"><animate attributeName="fill-opacity" begin="0s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></circle><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 47a28 28 0 0 1 28 28"><animate attributeName="stroke-opacity" begin="0.1s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 25a50 50 0 0 1 50 50"><animate attributeName="stroke-opacity" begin="0.2s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path></svg></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href="https://beian.miit.gov.cn/" target="_blank">è±«ICPå¤‡2021038026å·-4</a><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/beian.png" height="15px" width="15px" /><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41030502000411"><span>è±«å…¬ç½‘å®‰å¤‡ 41030502000411å·</span></a></div><div class="vp-copyright">Copyright Â© 2025 ä¸‰åˆ†æ¶ </div></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DlNMEcLQ.js" defer></script>
  </body>
</html>
