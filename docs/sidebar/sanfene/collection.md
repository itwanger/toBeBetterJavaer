---
title: Javaé¢è¯•é¢˜ä¹‹Javaé›†åˆæ¡†æ¶ç¯‡ï¼ˆJavaå®¹å™¨ç¯‡ï¼‰ï¼Œ30é“Javaé›†åˆæ¡†æ¶å…«è‚¡æ–‡ï¼ˆ7åƒå­—38å¼ æ‰‹ç»˜å›¾ï¼‰ï¼Œé¢æ¸£é€†è¢­å¿…çœ‹ğŸ‘
shortTitle: é¢æ¸£é€†è¢­-Javaé›†åˆæ¡†æ¶
author: ä¸‰åˆ†æ¶
category:
  - é¢æ¸£é€†è¢­
tag:
  - é¢æ¸£é€†è¢­
description: ä¸‹è½½æ¬¡æ•°è¶… 1 ä¸‡æ¬¡ï¼Œ7200 å­— 38 å¼ æ‰‹ç»˜å›¾ï¼Œè¯¦è§£ 30 é“ Java é›†åˆæ¡†æ¶é¢è¯•é«˜é¢‘é¢˜ï¼ˆè®©å¤©ä¸‹æ²¡æœ‰éš¾èƒŒçš„å…«è‚¡ï¼‰ï¼Œé¢æ¸£èƒŒä¼šè¿™äº› Java å®¹å™¨å…«è‚¡æ–‡ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚
head:
  - - meta
    - name: keywords
      content: Java,é›†åˆæ¡†æ¶,Javaå®¹å™¨,List,Map,Set,é¢è¯•é¢˜,å…«è‚¡æ–‡,java
---

7200 å­— 38 å¼ æ‰‹ç»˜å›¾ï¼Œè¯¦è§£ 30 é“ Java é›†åˆæ¡†æ¶é¢è¯•é«˜é¢‘é¢˜ï¼ˆè®©å¤©ä¸‹æ²¡æœ‰éš¾èƒŒçš„å…«è‚¡ï¼‰ï¼Œé¢æ¸£èƒŒä¼šè¿™äº› Java å®¹å™¨å…«è‚¡æ–‡ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚æ•´ç†ï¼šæ²‰é»˜ç‹äºŒï¼Œæˆ³[è½¬è½½é“¾æ¥](https://mp.weixin.qq.com/s/ptbM0EqlnCWeWm9VdSCDLg)ï¼Œä½œè€…ï¼šä¸‰åˆ†æ¶ï¼Œæˆ³[åŸæ–‡é“¾æ¥](https://mp.weixin.qq.com/s/SHkQ7LEOT0itt4bXMoDBPw)ã€‚

## å¼•è¨€

### 1.è¯´è¯´æœ‰å“ªäº›å¸¸è§çš„é›†åˆæ¡†æ¶ï¼Ÿ

æ¨èé˜…è¯»ï¼š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šJava é›†åˆæ¡†æ¶](https://javabetter.cn/collection/gailan.html)

Java é›†åˆæ¡†æ¶å¯ä»¥åˆ†ä¸ºä¸¤æ¡å¤§çš„æ”¯çº¿ï¼š

â‘ ã€Collectionï¼Œä¸»è¦ç”± Listã€Setã€Queue ç»„æˆï¼š

- List ä»£è¡¨æœ‰åºã€å¯é‡å¤çš„é›†åˆï¼Œå…¸å‹ä»£è¡¨å°±æ˜¯å°è£…äº†åŠ¨æ€æ•°ç»„çš„ [ArrayList](https://javabetter.cn/collection/arraylist.html) å’Œå°è£…äº†é“¾è¡¨çš„ [LinkedList](https://javabetter.cn/collection/linkedlist.html)ï¼›
- Set ä»£è¡¨æ— åºã€ä¸å¯é‡å¤çš„é›†åˆï¼Œå…¸å‹ä»£è¡¨å°±æ˜¯ HashSet å’Œ TreeSetï¼›
- Queue ä»£è¡¨é˜Ÿåˆ—ï¼Œå…¸å‹ä»£è¡¨å°±æ˜¯åŒç«¯é˜Ÿåˆ— [ArrayDeque](https://javabetter.cn/collection/arraydeque.html)ï¼Œä»¥åŠä¼˜å…ˆçº§é˜Ÿåˆ— [PriorityQueue](https://javabetter.cn/collection/PriorityQueue.html)ã€‚

â‘¡ã€Mapï¼Œä»£è¡¨é”®å€¼å¯¹çš„é›†åˆï¼Œå…¸å‹ä»£è¡¨å°±æ˜¯ [HashMap](https://javabetter.cn/collection/hashmap.html)ã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šJavaé›†åˆä¸»è¦å…³ç³»](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/collection/gailan-01.png)

æ¦‚è§ˆå›¾è¯´æ˜ï¼š

â‘ ã€Collection æ¥å£ï¼šæœ€åŸºæœ¬çš„é›†åˆæ¡†æ¶è¡¨ç¤ºæ–¹å¼ï¼Œæä¾›äº†æ·»åŠ ã€åˆ é™¤ã€æ¸…ç©ºç­‰åŸºæœ¬æ“ä½œï¼Œå®ƒä¸»è¦æœ‰ä¸‰ä¸ªå­æ¥å£ï¼š

- `List`ï¼šä¸€ä¸ªæœ‰åºçš„é›†åˆï¼Œå¯ä»¥åŒ…å«é‡å¤çš„å…ƒç´ ã€‚å®ç°ç±»åŒ…æ‹¬ ArrayListã€LinkedList ç­‰ã€‚
- `Set`ï¼šä¸€ä¸ªä¸åŒ…å«é‡å¤å…ƒç´ çš„é›†åˆã€‚å®ç°ç±»åŒ…æ‹¬ HashSetã€LinkedHashSetã€TreeSet ç­‰ã€‚
- `Queue`ï¼šä¸€ä¸ªç”¨äºä¿æŒå…ƒç´ é˜Ÿåˆ—çš„é›†åˆã€‚å®ç°ç±»åŒ…æ‹¬ PriorityQueueã€ArrayDeque ç­‰ã€‚

â‘¡ã€`Map` æ¥å£ï¼šè¡¨ç¤ºé”®å€¼å¯¹çš„é›†åˆï¼Œä¸€ä¸ªé”®æ˜ å°„åˆ°ä¸€ä¸ªå€¼ã€‚é”®ä¸èƒ½é‡å¤ï¼Œæ¯ä¸ªé”®åªèƒ½å¯¹åº”ä¸€ä¸ªå€¼ã€‚Map æ¥å£çš„å®ç°ç±»åŒ…æ‹¬ HashMapã€LinkedHashMapã€TreeMap ç­‰ã€‚

é›†åˆæ¡†æ¶ä½äº java.util åŒ…ä¸‹ï¼Œè¯¥åŒ…å«æä¾›äº†ä¸¤ä¸ªå¸¸ç”¨çš„å·¥å…·ç±»ï¼š

- [Collections](https://javabetter.cn/common-tool/collections.html)ï¼šæä¾›äº†ä¸€äº›å¯¹é›†åˆè¿›è¡Œæ’åºã€äºŒåˆ†æŸ¥æ‰¾ã€åŒæ­¥çš„é™æ€æ–¹æ³•ã€‚
- [Arrays](https://javabetter.cn/common-tool/arrays.html)ï¼šæä¾›äº†ä¸€äº›å¯¹æ•°ç»„è¿›è¡Œæ’åºã€æ‰“å°ã€å’Œ List è¿›è¡Œè½¬æ¢çš„é™æ€æ–¹æ³•ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç”¨å‹é‡‘èä¸€é¢åŸé¢˜ï¼šä½ äº†è§£å“ªäº›é›†åˆæ¡†æ¶ï¼Ÿ
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸ºä¸€é¢åŸé¢˜ï¼šè¯´ä¸‹ Java å®¹å™¨å’Œ HashMap

## List

### 2.ArrayList å’Œ LinkedList æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

æ¨èé˜…è¯»ï¼š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šArrayList å’Œ LinkedList](https://javabetter.cn/collection/list-war-2.html)

#### æ•°æ®ç»“æ„ä¸åŒ

- ArrayList åŸºäºæ•°ç»„å®ç°
- LinkedList åŸºäºé“¾è¡¨å®ç°

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šArrayListå’ŒLinkedListçš„æ•°æ®ç»“æ„](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-2.png)

#### ç”¨é€”ä¸åŒ

å¤šæ•°æƒ…å†µä¸‹ï¼ŒArrayList æ›´åˆ©äºæŸ¥æ‰¾ï¼ŒLinkedList æ›´åˆ©äºå¢åˆ 

â‘ ã€ç”±äº ArrayList æ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œæ‰€ä»¥ `get(int index)` å¯ä»¥ç›´æ¥é€šè¿‡æ•°ç»„ä¸‹æ ‡è·å–ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼›LinkedList æ˜¯åŸºäºé“¾è¡¨å®ç°çš„ï¼Œ`get(int index)` éœ€è¦éå†é“¾è¡¨ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ã€‚

å½“ç„¶ï¼Œ`get(E element)` è¿™ç§æŸ¥æ‰¾ï¼Œä¸¤ç§é›†åˆéƒ½éœ€è¦éå†é€šè¿‡ equals æ¯”è¾ƒè·å–å…ƒç´ ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(n)ã€‚

â‘¡ã€ArrayList å¦‚æœå¢åˆ çš„æ˜¯æ•°ç»„çš„å°¾éƒ¨ï¼Œç›´æ¥æ’å…¥æˆ–è€…åˆ é™¤å°±å¯ä»¥äº†ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼›å¦‚æœ add çš„æ—¶å€™æ¶‰åŠåˆ°æ‰©å®¹ï¼Œæ—¶é—´å¤æ‚åº¦ä¼šæå‡åˆ° O(n)ã€‚

ä½†å¦‚æœæ’å…¥çš„æ˜¯ä¸­é—´çš„ä½ç½®ï¼Œå°±éœ€è¦æŠŠæ’å…¥ä½ç½®åçš„å…ƒç´ å‘å‰æˆ–è€…å‘åç§»åŠ¨ï¼Œç”šè‡³è¿˜æœ‰å¯èƒ½è§¦å‘æ‰©å®¹ï¼Œæ•ˆç‡å°±ä¼šä½å¾ˆå¤šï¼ŒO(n)ã€‚

LinkedList å› ä¸ºæ˜¯é“¾è¡¨ç»“æ„ï¼Œæ’å…¥å’Œåˆ é™¤åªéœ€è¦æ”¹å˜å‰ç½®èŠ‚ç‚¹ã€åç½®èŠ‚ç‚¹å’Œæ’å…¥èŠ‚ç‚¹çš„å¼•ç”¨å°±è¡Œäº†ï¼Œä¸éœ€è¦ç§»åŠ¨å…ƒç´ ã€‚

å¦‚æœæ˜¯åœ¨é“¾è¡¨çš„å¤´éƒ¨æ’å…¥æˆ–è€…åˆ é™¤ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼›å¦‚æœæ˜¯åœ¨é“¾è¡¨çš„ä¸­é—´æ’å…¥æˆ–è€…åˆ é™¤ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œå› ä¸ºéœ€è¦éå†é“¾è¡¨æ‰¾åˆ°æ’å…¥ä½ç½®ï¼›å¦‚æœæ˜¯åœ¨é“¾è¡¨çš„å°¾éƒ¨æ’å…¥æˆ–è€…åˆ é™¤ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šArrayListå’ŒLinkedListä¸­é—´æ’å…¥](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-3.png)

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šArrayListå’ŒLinkedListä¸­é—´åˆ é™¤](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-4.png)

æ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸ªé™·é˜±ï¼ŒLinkedList æ›´åˆ©äºå¢åˆ ä¸æ˜¯ä½“ç°åœ¨æ—¶é—´å¤æ‚åº¦ä¸Šï¼Œå› ä¸ºäºŒè€…å¢åˆ çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(n)ï¼Œéƒ½éœ€è¦éå†åˆ—è¡¨ï¼›è€Œæ˜¯ä½“ç°åœ¨å¢åˆ çš„æ•ˆç‡ä¸Šï¼Œå› ä¸º LinkedList çš„å¢åˆ åªéœ€è¦æ”¹å˜å¼•ç”¨ï¼Œè€Œ ArrayList çš„å¢åˆ å¯èƒ½éœ€è¦ç§»åŠ¨å…ƒç´ ã€‚

#### æ˜¯å¦æ”¯æŒéšæœºè®¿é—®

â‘ ã€ArrayList æ˜¯åŸºäºæ•°ç»„çš„ï¼Œä¹Ÿå®ç°äº† RandomAccess æ¥å£ï¼Œæ‰€ä»¥å®ƒæ”¯æŒéšæœºè®¿é—®ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡ç›´æ¥è·å–å…ƒç´ ã€‚

![](https://cdn.tobebetterjavaer.com/stutymore/collection-20240319092907.png)

â‘¡ã€LinkedList æ˜¯åŸºäºé“¾è¡¨çš„ï¼Œæ‰€ä»¥å®ƒæ²¡æ³•æ ¹æ®ä¸‹æ ‡ç›´æ¥è·å–å…ƒç´ ï¼Œä¸æ”¯æŒéšæœºè®¿é—®ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ²¡æœ‰å®ç° RandomAccess æ¥å£ã€‚

![](https://cdn.tobebetterjavaer.com/stutymore/collection-20240319093038.png)

#### å†…å­˜å ç”¨

ArrayList æ˜¯åŸºäºæ•°ç»„çš„ï¼Œæ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å®ƒçš„å†…å­˜å ç”¨æ˜¯æ¯”è¾ƒç´§å‡‘çš„ï¼›ä½†å¦‚æœæ¶‰åŠåˆ°æ‰©å®¹ï¼Œå°±ä¼šé‡æ–°åˆ†é…å†…å­˜ï¼Œç©ºé—´æ˜¯åŸæ¥çš„ 1.5 å€ï¼Œå­˜åœ¨ä¸€å®šçš„ç©ºé—´æµªè´¹ã€‚

![](https://cdn.tobebetterjavaer.com/stutymore/collection-20240319093453.png)

LinkedList æ˜¯åŸºäºé“¾è¡¨çš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å’Œä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ï¼Œäºæ˜¯æ¯ä¸ªèŠ‚ç‚¹å ç”¨çš„å†…å­˜ç©ºé—´ç¨å¾®å¤§ä¸€ç‚¹ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„äº¬ä¸œåŒå­¦ 10 åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šArrayList å’Œ LinkedList çš„æ—¶é—´å¤æ‚åº¦

### 3.ArrayList çš„æ‰©å®¹æœºåˆ¶äº†è§£å—ï¼Ÿ

ArrayList æ˜¯åŸºäºæ•°ç»„çš„é›†åˆï¼Œæ•°ç»„çš„å®¹é‡æ˜¯åœ¨å®šä¹‰çš„æ—¶å€™ç¡®å®šçš„ï¼Œå¦‚æœæ•°ç»„æ»¡äº†ï¼Œå†æ’å…¥ï¼Œå°±ä¼šæ•°ç»„æº¢å‡ºã€‚æ‰€ä»¥åœ¨æ’å…¥æ—¶å€™ï¼Œä¼šå…ˆæ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œå¦‚æœå½“å‰å®¹é‡+1 è¶…è¿‡æ•°ç»„é•¿åº¦ï¼Œå°±ä¼šè¿›è¡Œæ‰©å®¹ã€‚

ArrayList çš„æ‰©å®¹æ˜¯åˆ›å»ºä¸€ä¸ª**1.5 å€**çš„æ–°æ•°ç»„ï¼Œç„¶åæŠŠåŸæ•°ç»„çš„å€¼æ‹·è´è¿‡å»ã€‚

![ArrayListæ‰©å®¹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-5.png)

### 4.ArrayList æ€ä¹ˆåºåˆ—åŒ–çš„çŸ¥é“å—ï¼Ÿ ä¸ºä»€ä¹ˆç”¨ transient ä¿®é¥°æ•°ç»„ï¼Ÿ

ArrayList çš„åºåˆ—åŒ–ä¸å¤ªä¸€æ ·ï¼Œå®ƒä½¿ç”¨`transient`ä¿®é¥°å­˜å‚¨å…ƒç´ çš„`elementData`çš„æ•°ç»„ï¼Œ`transient`å…³é”®å­—çš„ä½œç”¨æ˜¯è®©è¢«ä¿®é¥°çš„æˆå‘˜å±æ€§ä¸è¢«åºåˆ—åŒ–ã€‚

**ä¸ºä»€ä¹ˆæœ€ ArrayList ä¸ç›´æ¥åºåˆ—åŒ–å…ƒç´ æ•°ç»„å‘¢ï¼Ÿ**

å‡ºäºæ•ˆç‡çš„è€ƒè™‘ï¼Œæ•°ç»„å¯èƒ½é•¿åº¦ 100ï¼Œä½†å®é™…åªç”¨äº† 50ï¼Œå‰©ä¸‹çš„ 50 ä¸ç”¨å…¶å®ä¸ç”¨åºåˆ—åŒ–ï¼Œè¿™æ ·å¯ä»¥æé«˜åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ•ˆç‡ï¼Œè¿˜å¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´ã€‚

**é‚£ ArrayList æ€ä¹ˆåºåˆ—åŒ–å‘¢ï¼Ÿ**

ArrayList é€šè¿‡ä¸¤ä¸ªæ–¹æ³•**readObjectã€writeObject**è‡ªå®šä¹‰åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç­–ç•¥ï¼Œå®é™…ç›´æ¥ä½¿ç”¨ä¸¤ä¸ªæµ`ObjectOutputStream`å’Œ`ObjectInputStream`æ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

![ArrayListè‡ªå®šä¹‰åºåˆ—åŒ–](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-6.png)

### 5.å¿«é€Ÿå¤±è´¥(fail-fast)å’Œå®‰å…¨å¤±è´¥(fail-safe)äº†è§£å—ï¼Ÿ

**å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰**ï¼šå¿«é€Ÿå¤±è´¥æ˜¯ Java é›†åˆçš„ä¸€ç§é”™è¯¯æ£€æµ‹æœºåˆ¶

- åœ¨ç”¨è¿­ä»£å™¨éå†ä¸€ä¸ªé›†åˆå¯¹è±¡æ—¶ï¼Œå¦‚æœçº¿ç¨‹ A éå†è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ B å¯¹é›†åˆå¯¹è±¡çš„å†…å®¹è¿›è¡Œäº†ä¿®æ”¹ï¼ˆå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ï¼‰ï¼Œåˆ™ä¼šæŠ›å‡º Concurrent Modification Exceptionã€‚
- åŸç†ï¼šè¿­ä»£å™¨åœ¨éå†æ—¶ç›´æ¥è®¿é—®é›†åˆä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”åœ¨éå†è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸€ä¸ª ` modCount` å˜é‡ã€‚é›†åˆåœ¨è¢«éå†æœŸé—´å¦‚æœå†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šæ”¹å˜`modCount`çš„å€¼ã€‚æ¯å½“è¿­ä»£å™¨ä½¿ç”¨ hashNext()/next()éå†ä¸‹ä¸€ä¸ªå…ƒç´ ä¹‹å‰ï¼Œéƒ½ä¼šæ£€æµ‹ modCount å˜é‡æ˜¯å¦ä¸º expectedmodCount å€¼ï¼Œæ˜¯çš„è¯å°±è¿”å›éå†ï¼›å¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç»ˆæ­¢éå†ã€‚
- æ³¨æ„ï¼šè¿™é‡Œå¼‚å¸¸çš„æŠ›å‡ºæ¡ä»¶æ˜¯æ£€æµ‹åˆ° modCountï¼=expectedmodCount è¿™ä¸ªæ¡ä»¶ã€‚å¦‚æœé›†åˆå‘ç”Ÿå˜åŒ–æ—¶ä¿®æ”¹ modCount å€¼åˆšå¥½åˆè®¾ç½®ä¸ºäº† expectedmodCount å€¼ï¼Œåˆ™å¼‚å¸¸ä¸ä¼šæŠ›å‡ºã€‚å› æ­¤ï¼Œä¸èƒ½ä¾èµ–äºè¿™ä¸ªå¼‚å¸¸æ˜¯å¦æŠ›å‡ºè€Œè¿›è¡Œå¹¶å‘æ“ä½œçš„ç¼–ç¨‹ï¼Œè¿™ä¸ªå¼‚å¸¸åªå»ºè®®ç”¨äºæ£€æµ‹å¹¶å‘ä¿®æ”¹çš„ bugã€‚
- åœºæ™¯ï¼šjava.util åŒ…ä¸‹çš„é›†åˆç±»éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„ï¼Œä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸‹å‘ç”Ÿå¹¶å‘ä¿®æ”¹ï¼ˆè¿­ä»£è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹ï¼‰ï¼Œæ¯”å¦‚ ArrayList ç±»ã€‚

**å®‰å…¨å¤±è´¥ï¼ˆfailâ€”safeï¼‰**

- é‡‡ç”¨å®‰å…¨å¤±è´¥æœºåˆ¶çš„é›†åˆå®¹å™¨ï¼Œåœ¨éå†æ—¶ä¸æ˜¯ç›´æ¥åœ¨é›†åˆå†…å®¹ä¸Šè®¿é—®çš„ï¼Œè€Œæ˜¯å…ˆå¤åˆ¶åŸæœ‰é›†åˆå†…å®¹ï¼Œåœ¨æ‹·è´çš„é›†åˆä¸Šè¿›è¡Œéå†ã€‚
- åŸç†ï¼šç”±äºè¿­ä»£æ—¶æ˜¯å¯¹åŸé›†åˆçš„æ‹·è´è¿›è¡Œéå†ï¼Œæ‰€ä»¥åœ¨éå†è¿‡ç¨‹ä¸­å¯¹åŸé›†åˆæ‰€ä½œçš„ä¿®æ”¹å¹¶ä¸èƒ½è¢«è¿­ä»£å™¨æ£€æµ‹åˆ°ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘ Concurrent Modification Exceptionã€‚
- ç¼ºç‚¹ï¼šåŸºäºæ‹·è´å†…å®¹çš„ä¼˜ç‚¹æ˜¯é¿å…äº† Concurrent Modification Exceptionï¼Œä½†åŒæ ·åœ°ï¼Œè¿­ä»£å™¨å¹¶ä¸èƒ½è®¿é—®åˆ°ä¿®æ”¹åçš„å†…å®¹ï¼Œå³ï¼šè¿­ä»£å™¨éå†çš„æ˜¯å¼€å§‹éå†é‚£ä¸€åˆ»æ‹¿åˆ°çš„é›†åˆæ‹·è´ï¼Œåœ¨éå†æœŸé—´åŸé›†åˆå‘ç”Ÿçš„ä¿®æ”¹è¿­ä»£å™¨æ˜¯ä¸çŸ¥é“çš„ã€‚
- åœºæ™¯ï¼šjava.util.concurrent åŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨ï¼Œå¹¶å‘ä¿®æ”¹ï¼Œæ¯”å¦‚ CopyOnWriteArrayList ç±»ã€‚

### 6.æœ‰å“ªå‡ ç§å®ç° ArrayList çº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ï¼Ÿ

fail-fast æ˜¯ä¸€ç§å¯èƒ½è§¦å‘çš„æœºåˆ¶ï¼Œå®é™…ä¸Šï¼ŒArrayList çš„çº¿ç¨‹å®‰å…¨ä»ç„¶æ²¡æœ‰ä¿è¯ï¼Œä¸€èˆ¬ï¼Œä¿è¯ ArrayList çš„çº¿ç¨‹å®‰å…¨å¯ä»¥é€šè¿‡è¿™äº›æ–¹æ¡ˆï¼š

- ä½¿ç”¨ Vector ä»£æ›¿ ArrayListã€‚ï¼ˆä¸æ¨èï¼ŒVector æ˜¯ä¸€ä¸ªå†å²é—ç•™ç±»ï¼‰
- ä½¿ç”¨ Collections.synchronizedList åŒ…è£… ArrayListï¼Œç„¶åæ“ä½œåŒ…è£…åçš„ listã€‚
- ä½¿ç”¨ CopyOnWriteArrayList ä»£æ›¿ ArrayListã€‚
- åœ¨ä½¿ç”¨ ArrayList æ—¶ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡åŒæ­¥æœºåˆ¶å»æ§åˆ¶ ArrayList çš„è¯»å†™ã€‚

### 7.CopyOnWriteArrayList äº†è§£å¤šå°‘ï¼Ÿ

CopyOnWriteArrayList å°±æ˜¯çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬çš„ ArrayListã€‚

å®ƒçš„åå­—å«`CopyOnWrite`â€”â€”å†™æ—¶å¤åˆ¶ï¼Œå·²ç»æ˜ç¤ºäº†å®ƒçš„åŸç†ã€‚

CopyOnWriteArrayList é‡‡ç”¨äº†ä¸€ç§è¯»å†™åˆ†ç¦»çš„å¹¶å‘ç­–ç•¥ã€‚CopyOnWriteArrayList å®¹å™¨å…è®¸å¹¶å‘è¯»ï¼Œè¯»æ“ä½œæ˜¯æ— é”çš„ï¼Œæ€§èƒ½è¾ƒé«˜ã€‚è‡³äºå†™æ“ä½œï¼Œæ¯”å¦‚å‘å®¹å™¨ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™é¦–å…ˆå°†å½“å‰å®¹å™¨å¤åˆ¶ä¸€ä»½ï¼Œç„¶ååœ¨æ–°å‰¯æœ¬ä¸Šæ‰§è¡Œå†™æ“ä½œï¼Œç»“æŸä¹‹åå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°å®¹å™¨ã€‚

![CopyOnWriteArrayListåŸç†](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-7.png)

GitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„å¼€æºçŸ¥è¯†åº“ã€Š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://github.com/itwanger/toBeBetterJavaer)ã€‹ç¬¬ä¸€ç‰ˆ PDF ç»ˆäºæ¥äº†ï¼åŒ…æ‹¬ Java åŸºç¡€è¯­æ³•ã€æ•°ç»„&å­—ç¬¦ä¸²ã€OOPã€é›†åˆæ¡†æ¶ã€Java IOã€å¼‚å¸¸å¤„ç†ã€Java æ–°ç‰¹æ€§ã€ç½‘ç»œç¼–ç¨‹ã€NIOã€å¹¶å‘ç¼–ç¨‹ã€JVM ç­‰ç­‰ï¼Œå…±è®¡ 32 ä¸‡ä½™å­—ï¼Œ500+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯é€šä¿—æ˜“æ‡‚ã€é£è¶£å¹½é»˜â€¦â€¦è¯¦æƒ…æˆ³ï¼š[å¤ªèµäº†ï¼ŒGitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„ Java æ•™ç¨‹](https://javabetter.cn/overview/)

å¾®ä¿¡æœ **æ²‰é»˜ç‹äºŒ** æˆ–æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨äºŒå“¥çš„åŸåˆ›å…¬ä¼—å·æ²‰é»˜ç‹äºŒï¼Œå›å¤ **222** å³å¯å…è´¹é¢†å–ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png)

## Map

Map ä¸­ï¼Œæ¯«æ— ç–‘é—®ï¼Œæœ€é‡è¦çš„å°±æ˜¯ HashMapï¼Œé¢è¯•åŸºæœ¬è¢«ç›˜å‡ºåŒ…æµ†äº†ï¼Œå„ç§é—®æ³•ï¼Œä¸€å®šè¦å¥½å¥½å‡†å¤‡ã€‚

### 8.èƒ½è¯´ä¸€ä¸‹ HashMap çš„æ•°æ®ç»“æ„å—ï¼Ÿ

æ¨èé˜…è¯»ï¼š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šè¯¦è§£ HashMap](https://javabetter.cn/collection/hashmap.html)

JDK 8 ä¸­ HashMap çš„æ•°æ®ç»“æ„æ˜¯`æ•°ç»„`+`é“¾è¡¨`+`çº¢é»‘æ ‘`ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šJDK 8 HashMap æ•°æ®ç»“æ„ç¤ºæ„å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-8.png)

HashMap çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªåŠ¨æ€æ•°ç»„ï¼ˆ`Node[] table`ï¼‰ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ã€‚è¿™ä¸ªæ•°ç»„çš„æ¯ä¸ªå…ƒç´ ç§°ä¸ºä¸€ä¸ªâ€œæ¡¶â€ï¼ˆBucketï¼‰ï¼Œæ¯ä¸ªæ¡¶çš„ç´¢å¼•æ˜¯é€šè¿‡å¯¹é”®çš„å“ˆå¸Œå€¼è¿›è¡Œå“ˆå¸Œå‡½æ•°å¤„ç†å¾—åˆ°çš„ã€‚

å½“å¤šä¸ªé”®ç»å“ˆå¸Œå¤„ç†åå¾—åˆ°ç›¸åŒçš„ç´¢å¼•æ—¶ï¼Œä¼šå‘ç”Ÿå“ˆå¸Œå†²çªã€‚HashMap é€šè¿‡é“¾è¡¨æ¥è§£å†³å“ˆå¸Œå†²çªâ€”â€”å³å°†å…·æœ‰ç›¸åŒç´¢å¼•çš„é”®å€¼å¯¹é€šè¿‡é“¾è¡¨è¿æ¥èµ·æ¥ã€‚

ä¸è¿‡ï¼Œé“¾è¡¨è¿‡é•¿æ—¶ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¼šæ¯”è¾ƒä½ï¼Œäºæ˜¯å½“é“¾è¡¨çš„é•¿åº¦è¶…è¿‡ 8 æ—¶ï¼ˆä¸”æ•°ç»„çš„é•¿åº¦å¤§äº 64ï¼‰ï¼Œé“¾è¡¨å°±ä¼šè½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚çº¢é»‘æ ‘çš„æŸ¥è¯¢æ•ˆç‡æ˜¯ O(logn)ï¼Œæ¯”é“¾è¡¨çš„ O(n) è¦å¿«ã€‚æ•°ç»„çš„æŸ¥è¯¢æ•ˆç‡æ˜¯ O(1)ã€‚

å½“å‘ HashMap ä¸­æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œä¼šä½¿ç”¨å“ˆå¸Œå‡½æ•°è®¡ç®—é”®çš„å“ˆå¸Œç ï¼Œç¡®å®šå…¶åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå“ˆå¸Œå‡½æ•°çš„ç›®æ ‡æ˜¯å°½é‡å‡å°‘å“ˆå¸Œå†²çªï¼Œä¿è¯å…ƒç´ èƒ½å¤Ÿå‡åŒ€åœ°åˆ†å¸ƒåœ¨æ•°ç»„çš„æ¯ä¸ªä½ç½®ä¸Šã€‚

```java
static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

å½“å‘ HashMap ä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœè¯¥ä½ç½®å·²æœ‰å…ƒç´ ï¼ˆå‘ç”Ÿå“ˆå¸Œå†²çªï¼‰ï¼Œåˆ™æ–°å…ƒç´ å°†è¢«æ·»åŠ åˆ°é“¾è¡¨çš„æœ«å°¾æˆ–çº¢é»‘æ ‘ä¸­ã€‚å¦‚æœé”®å·²ç»å­˜åœ¨ï¼Œå…¶å¯¹åº”çš„å€¼å°†è¢«æ–°å€¼è¦†ç›–ã€‚

å½“ä» HashMap ä¸­è·å–å…ƒç´ æ—¶ï¼Œä¹Ÿä¼šä½¿ç”¨å“ˆå¸Œå‡½æ•°è®¡ç®—é”®çš„ä½ç½®ï¼Œç„¶åæ ¹æ®ä½ç½®åœ¨æ•°ç»„ã€é“¾è¡¨æˆ–è€…çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾å…ƒç´ ã€‚

HashMap çš„åˆå§‹å®¹é‡æ˜¯ 16ï¼Œéšç€å…ƒç´ çš„ä¸æ–­æ·»åŠ ï¼ŒHashMap çš„å®¹é‡ï¼ˆä¹Ÿå°±æ˜¯æ•°ç»„å¤§å°ï¼‰å¯èƒ½ä¸è¶³ï¼Œäºæ˜¯å°±éœ€è¦è¿›è¡Œæ‰©å®¹ï¼Œé˜ˆå€¼æ˜¯`capacity * loadFactor`ï¼Œcapacity ä¸ºå®¹é‡ï¼ŒloadFactor ä¸ºè´Ÿè½½å› å­ï¼Œé»˜è®¤ä¸º 0.75ã€‚

æ‰©å®¹åçš„æ•°ç»„å¤§å°æ˜¯åŸæ¥çš„ 2 å€ï¼Œç„¶åæŠŠåŸæ¥çš„å…ƒç´ é‡æ–°è®¡ç®—å“ˆå¸Œå€¼ï¼Œæ”¾åˆ°æ–°çš„æ•°ç»„ä¸­ã€‚

æ€»çš„æ¥è¯´ï¼ŒHashMap æ˜¯ä¸€ç§é€šè¿‡å“ˆå¸Œè¡¨å®ç°çš„é”®å€¼å¯¹é›†åˆï¼Œå®ƒé€šè¿‡å°†é”®å“ˆå¸ŒåŒ–æˆæ•°ç»„ç´¢å¼•ï¼Œå¹¶åœ¨å†²çªæ—¶ä½¿ç”¨é“¾è¡¨æˆ–çº¢é»‘æ ‘æ¥å­˜å‚¨å…ƒç´ ï¼Œä»è€Œå®ç°å¿«é€Ÿçš„æŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³ 25 å±Šæ—¥å¸¸å®ä¹ ä¸€é¢åŸé¢˜ï¼šè®²ä¸€è®² HashMap çš„åŸç†
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸ºä¸€é¢åŸé¢˜ï¼šè¯´ä¸‹ Java å®¹å™¨å’Œ HashMap
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸ºä¸€é¢åŸé¢˜ï¼šè¯´ä¸‹ Redis å’Œ HashMap çš„åŒºåˆ«
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å›½ä¼é¢è¯•åŸé¢˜ï¼šè¯´è¯´ HashMap çš„åº•å±‚æ•°æ®ç»“æ„ï¼Œé“¾è¡¨å’Œçº¢é»‘æ ‘çš„è½¬æ¢ï¼ŒHashMap çš„é•¿åº¦
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´ä¸€ä¸‹ HashMap æ•°æ®åº“ç»“æ„ å’Œ ä¸€äº›é‡è¦å‚æ•°

### 9.ä½ å¯¹çº¢é»‘æ ‘äº†è§£å¤šå°‘ï¼Ÿä¸ºä»€ä¹ˆä¸ç”¨äºŒå‰æ ‘/å¹³è¡¡æ ‘å‘¢ï¼Ÿ

çº¢é»‘æ ‘æœ¬è´¨ä¸Šæ˜¯ä¸€ç§äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œä¸ºäº†ä¿æŒå¹³è¡¡ï¼Œå®ƒåˆåœ¨äºŒå‰æŸ¥æ‰¾æ ‘çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€äº›è§„åˆ™ï¼š

1. æ¯ä¸ªèŠ‚ç‚¹è¦ä¹ˆæ˜¯çº¢è‰²ï¼Œè¦ä¹ˆæ˜¯é»‘è‰²ï¼›
2. æ ¹èŠ‚ç‚¹æ°¸è¿œæ˜¯é»‘è‰²çš„ï¼›
3. æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹éƒ½æ˜¯æ˜¯é»‘è‰²çš„ï¼ˆæ³¨æ„è¿™é‡Œè¯´å¶å­èŠ‚ç‚¹å…¶å®æ˜¯å›¾ä¸­çš„ NULL èŠ‚ç‚¹ï¼‰ï¼›
4. æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹ä¸€å®šéƒ½æ˜¯é»‘è‰²ï¼›
5. ä»ä»»ä¸€èŠ‚ç‚¹åˆ°å…¶å­æ ‘ä¸­æ¯ä¸ªå¶å­èŠ‚ç‚¹çš„è·¯å¾„éƒ½åŒ…å«ç›¸åŒæ•°é‡çš„é»‘è‰²èŠ‚ç‚¹ï¼›

![çº¢é»‘æ ‘](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-9.png)

> ä¹‹æ‰€ä»¥ä¸ç”¨äºŒå‰æ ‘ï¼š

çº¢é»‘æ ‘æ˜¯ä¸€ç§å¹³è¡¡çš„äºŒå‰æ ‘ï¼Œæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾çš„æœ€åæ—¶é—´å¤æ‚åº¦éƒ½ä¸º O(logn)ï¼Œé¿å…äº†äºŒå‰æ ‘æœ€åæƒ…å†µä¸‹çš„ O(n)æ—¶é—´å¤æ‚åº¦ã€‚

> ä¹‹æ‰€ä»¥ä¸ç”¨å¹³è¡¡äºŒå‰æ ‘ï¼š

å¹³è¡¡äºŒå‰æ ‘æ˜¯æ¯”çº¢é»‘æ ‘æ›´ä¸¥æ ¼çš„å¹³è¡¡æ ‘ï¼Œä¸ºäº†ä¿æŒä¿æŒå¹³è¡¡ï¼Œéœ€è¦æ—‹è½¬çš„æ¬¡æ•°æ›´å¤šï¼Œä¹Ÿå°±æ˜¯è¯´å¹³è¡¡äºŒå‰æ ‘ä¿æŒå¹³è¡¡çš„æ•ˆç‡æ›´ä½ï¼Œæ‰€ä»¥å¹³è¡¡äºŒå‰æ ‘æ’å…¥å’Œåˆ é™¤çš„æ•ˆç‡æ¯”çº¢é»‘æ ‘è¦ä½ã€‚

### 10.çº¢é»‘æ ‘æ€ä¹ˆä¿æŒå¹³è¡¡çš„çŸ¥é“å—ï¼Ÿ

çº¢é»‘æ ‘æœ‰ä¸¤ç§æ–¹å¼ä¿æŒå¹³è¡¡ï¼š`æ—‹è½¬`å’Œ`æŸ“è‰²`ã€‚

- æ—‹è½¬ï¼šæ—‹è½¬åˆ†ä¸ºä¸¤ç§ï¼Œå·¦æ—‹å’Œå³æ—‹

![å·¦æ—‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-10.png)

![å³æ—‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-11.png)

- æŸ“â¾Šï¼š

![æŸ“è‰²](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-12.png)

### 11.HashMap çš„ put æµç¨‹çŸ¥é“å—ï¼Ÿ

å…ˆä¸Šä¸ªæµç¨‹å›¾å§:

![HashMapæ’å…¥æ•°æ®æµç¨‹å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-13.jpg)

ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ hash æ–¹æ³•è®¡ç®— key çš„å“ˆå¸Œå€¼ã€‚

```java
static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

ç¬¬äºŒæ­¥ï¼Œæ•°ç»„è¿›è¡Œç¬¬ä¸€æ¬¡æ‰©å®¹ã€‚

```java
if ((tab = table) == null || (n = tab.length) == 0)
    n = (tab = resize()).length;
```

ç¬¬ä¸‰æ­¥ï¼Œæ ¹æ®å“ˆå¸Œå€¼è®¡ç®— key åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼Œå¦‚æœå¯¹åº”ä¸‹æ ‡æ­£å¥½æ²¡æœ‰å­˜æ”¾æ•°æ®ï¼Œåˆ™ç›´æ¥æ’å…¥ã€‚

```java
if ((p = tab[i = (n - 1) & hash]) == null)
    tab[i] = newNode(hash, key, value, null);
```

å¦‚æœå¯¹åº”ä¸‹æ ‡å·²ç»æœ‰æ•°æ®äº†ï¼Œå°±éœ€è¦åˆ¤æ–­æ˜¯å¦ä¸ºç›¸åŒçš„ keyï¼Œæ˜¯åˆ™è¦†ç›– valueï¼Œå¦åˆ™éœ€è¦åˆ¤æ–­æ˜¯å¦ä¸ºæ ‘èŠ‚ç‚¹ï¼Œæ˜¯åˆ™å‘æ ‘ä¸­æ’å…¥èŠ‚ç‚¹ï¼Œå¦åˆ™å‘é“¾è¡¨ä¸­æ’å…¥æ•°æ®ã€‚

```java
else {
    Node<K,V> e; K k;
    if (p.hash == hash &&
        ((k = p.key) == key || (key != null && key.equals(k))))
        e = p;
    else if (p instanceof TreeNode)
        e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
    else {
        for (int binCount = 0; ; ++binCount) {
            if ((e = p.next) == null) {
                p.next = newNode(hash, key, value, null);
                if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                    treeifyBin(tab, hash);
                break;
            }
            if (e.hash == hash &&
                ((k = e.key) == key || (key != null && key.equals(k))))
                break;
            p = e;
        }
    }
}
```

æ³¨æ„ï¼Œåœ¨é“¾è¡¨ä¸­æ’å…¥èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¦‚æœé“¾è¡¨é•¿åº¦å¤§äºç­‰äº 8ï¼Œåˆ™éœ€è¦æŠŠé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚

```java
if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
    treeifyBin(tab, hash);
```

æ‰€æœ‰å…ƒç´ å¤„ç†å®Œåï¼Œè¿˜éœ€è¦åˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼`threshold`ï¼Œè¶…è¿‡åˆ™æ‰©å®¹ã€‚

```java
if (++size > threshold)
    resize();
```

#### åªé‡å†™ equals æ²¡é‡å†™ hashcodeï¼Œmap put çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆ?

å¦‚æœåªé‡å†™ equals æ–¹æ³•ï¼Œæ²¡æœ‰é‡å†™ hashcode æ–¹æ³•ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´ equals ç›¸ç­‰çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œhashcode ä¸ç›¸ç­‰ï¼Œè¿™æ ·çš„è¯ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¼šè¢«æ”¾åˆ°ä¸åŒçš„æ¡¶ä¸­ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ get çš„æ—¶å€™ï¼Œæ‰¾ä¸åˆ°å¯¹åº”çš„å€¼ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„äº¬ä¸œåŒå­¦ 10 åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šhashcode å’Œ equals æ–¹æ³•åªé‡å†™ä¸€ä¸ªè¡Œä¸è¡Œï¼Œåªé‡å†™ equals æ²¡é‡å†™ hashcodeï¼Œmap put çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆ

### 12.HashMap æ€ä¹ˆæŸ¥æ‰¾å…ƒç´ çš„å‘¢ï¼Ÿ

å…ˆçœ‹æµç¨‹å›¾ï¼š

![HashMapæŸ¥æ‰¾æµç¨‹å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-14.png)

HashMap çš„æŸ¥æ‰¾å°±ç®€å•å¾ˆå¤šï¼š

1. ä½¿ç”¨æ‰°åŠ¨å‡½æ•°ï¼Œè·å–æ–°çš„å“ˆå¸Œå€¼
2. è®¡ç®—æ•°ç»„ä¸‹æ ‡ï¼Œè·å–èŠ‚ç‚¹
3. å½“å‰èŠ‚ç‚¹å’Œ key åŒ¹é…ï¼Œç›´æ¥è¿”å›
4. å¦åˆ™ï¼Œå½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºæ ‘èŠ‚ç‚¹ï¼ŒæŸ¥æ‰¾çº¢é»‘æ ‘
5. å¦åˆ™ï¼Œéå†é“¾è¡¨æŸ¥æ‰¾

### 13.HashMap çš„å“ˆå¸Œ/æ‰°åŠ¨å‡½æ•°æ˜¯æ€ä¹ˆè®¾è®¡çš„?

HashMap çš„å“ˆå¸Œå‡½æ•°æ˜¯å…ˆæ‹¿åˆ° key çš„ hashcodeï¼Œæ˜¯ä¸€ä¸ª 32 ä½çš„ int ç±»å‹çš„æ•°å€¼ï¼Œç„¶åè®© hashcode çš„é«˜ 16 ä½å’Œä½ 16 ä½è¿›è¡Œå¼‚æˆ–æ“ä½œã€‚

```java
    static final int hash(Object key) {
        int h;
        // keyçš„hashCodeå’Œkeyçš„hashCodeå³ç§»16ä½åšå¼‚æˆ–è¿ç®—
        return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
    }
```

è¿™ä¹ˆè®¾è®¡æ˜¯ä¸ºäº†é™ä½å“ˆå¸Œç¢°æ’çš„æ¦‚ç‡ã€‚

### 14.ä¸ºä»€ä¹ˆå“ˆå¸Œ/æ‰°åŠ¨å‡½æ•°èƒ½é™ hash ç¢°æ’ï¼Ÿ

å› ä¸º key.hashCode() å‡½æ•°è°ƒç”¨çš„æ˜¯ key é”®å€¼ç±»å‹è‡ªå¸¦çš„å“ˆå¸Œå‡½æ•°ï¼Œè¿”å› int å‹æ•£åˆ—å€¼ã€‚int å€¼èŒƒå›´ä¸º **-2147483648~2147483647**ï¼ŒåŠ èµ·æ¥å¤§æ¦‚ 40 äº¿çš„æ˜ å°„ç©ºé—´ã€‚

åªè¦å“ˆå¸Œå‡½æ•°æ˜ å°„å¾—æ¯”è¾ƒå‡åŒ€æ¾æ•£ï¼Œä¸€èˆ¬åº”ç”¨æ˜¯å¾ˆéš¾å‡ºç°ç¢°æ’çš„ã€‚ä½†é—®é¢˜æ˜¯ä¸€ä¸ª 40 äº¿é•¿åº¦çš„æ•°ç»„ï¼Œå†…å­˜æ˜¯æ”¾ä¸ä¸‹çš„ã€‚

å‡å¦‚ HashMap æ•°ç»„çš„åˆå§‹å¤§å°æ‰ 16ï¼Œå°±éœ€è¦ç”¨ä¹‹å‰éœ€è¦å¯¹æ•°ç»„çš„é•¿åº¦å–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ä½™æ•°æ‰èƒ½ç”¨æ¥è®¿é—®æ•°ç»„ä¸‹æ ‡ã€‚

æºç ä¸­æ¨¡è¿ç®—å°±æ˜¯æŠŠæ•£åˆ—å€¼å’Œæ•°ç»„é•¿åº¦ - 1 åšä¸€ä¸ª "`ä¸&`" æ“ä½œï¼Œä½è¿ç®—æ¯”å–ä½™ % è¿ç®—è¦å¿«ã€‚

```java
bucketIndex = indexFor(hash, table.length);

static int indexFor(int h, int length) {
     return h & (length-1);
}
```

é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿™ä¹Ÿæ­£å¥½è§£é‡Šäº†ä¸ºä»€ä¹ˆ HashMap çš„æ•°ç»„é•¿åº¦è¦å– 2 çš„æ•´æ•°å¹‚ã€‚å› ä¸ºè¿™æ ·ï¼ˆæ•°ç»„é•¿åº¦ - 1ï¼‰æ­£å¥½ç›¸å½“äºä¸€ä¸ª â€œä½ä½æ©ç â€ã€‚`ä¸` æ“ä½œçš„ç»“æœå°±æ˜¯æ•£åˆ—å€¼çš„é«˜ä½å…¨éƒ¨å½’é›¶ï¼Œåªä¿ç•™ä½ä½å€¼ï¼Œç”¨æ¥åšæ•°ç»„ä¸‹æ ‡è®¿é—®ã€‚ä»¥åˆå§‹é•¿åº¦ 16 ä¸ºä¾‹ï¼Œ16-1=15ã€‚2 è¿›åˆ¶è¡¨ç¤ºæ˜¯` 0000 0000 0000 0000 0000 0000 0000 1111`ã€‚å’ŒæŸä¸ªæ•£åˆ—å€¼åš `ä¸` æ“ä½œå¦‚ä¸‹ï¼Œç»“æœå°±æ˜¯æˆªå–äº†æœ€ä½çš„å››ä½å€¼ã€‚

![å“ˆå¸Œ&è¿ç®—](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-15.png)

è¿™æ ·æ˜¯è¦å¿«æ·ä¸€äº›ï¼Œä½†æ˜¯æ–°çš„é—®é¢˜æ¥äº†ï¼Œå°±ç®—æ•£åˆ—å€¼åˆ†å¸ƒå†æ¾æ•£ï¼Œè¦æ˜¯åªå–æœ€åå‡ ä½çš„è¯ï¼Œç¢°æ’ä¹Ÿä¼šå¾ˆä¸¥é‡ã€‚å¦‚æœæ•£åˆ—æœ¬èº«åšå¾—ä¸å¥½ï¼Œåˆ†å¸ƒä¸Šæˆç­‰å·®æ•°åˆ—çš„æ¼æ´ï¼Œå¦‚æœæ­£å¥½è®©æœ€åå‡ ä¸ªä½ä½å‘ˆç°è§„å¾‹æ€§é‡å¤ï¼Œé‚£å°±æ›´éš¾æäº†ã€‚

è¿™æ—¶å€™ `æ‰°åŠ¨å‡½æ•°` çš„ä»·å€¼å°±ä½“ç°å‡ºæ¥äº†ï¼Œçœ‹ä¸€ä¸‹æ‰°åŠ¨å‡½æ•°çš„ç¤ºæ„å›¾ï¼š

![æ‰°åŠ¨å‡½æ•°ç¤ºæ„å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-16.jpg)

å³ç§» 16 ä½ï¼Œæ­£å¥½æ˜¯ 32bit çš„ä¸€åŠï¼Œè‡ªå·±çš„é«˜åŠåŒºå’Œä½åŠåŒºåšå¼‚æˆ–ï¼Œå°±æ˜¯ä¸ºäº†æ··åˆåŸå§‹å“ˆå¸Œç çš„é«˜ä½å’Œä½ä½ï¼Œä»¥æ­¤æ¥åŠ å¤§ä½ä½çš„éšæœºæ€§ã€‚è€Œä¸”æ··åˆåçš„ä½ä½æºæ‚äº†é«˜ä½çš„éƒ¨åˆ†ç‰¹å¾ï¼Œè¿™æ ·é«˜ä½çš„ä¿¡æ¯ä¹Ÿè¢«å˜ç›¸ä¿ç•™ä¸‹æ¥ã€‚

### 15.ä¸ºä»€ä¹ˆ HashMap çš„å®¹é‡æ˜¯ 2 çš„å€æ•°å‘¢ï¼Ÿ

HashMap çš„å®¹é‡æ˜¯ 2 çš„å€æ•°ï¼Œæˆ–è€…è¯´æ˜¯ 2 çš„æ•´æ•°æ¬¡å¹‚ï¼Œæ˜¯ä¸ºäº†å¿«é€Ÿå®šä½å…ƒç´ çš„ä¸‹æ ‡ï¼š

HashMap åœ¨å®šä½å…ƒç´ ä½ç½®æ—¶ï¼Œå…ˆé€šè¿‡ `hash(key) = (h = key.hashCode()) ^ (h >>> 16)` è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œå†é€šè¿‡ `hash & (n-1)` æ¥å®šä½å…ƒç´ ä½ç½®çš„ï¼Œn ä¸ºæ•°ç»„çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ HashMap çš„å®¹é‡ã€‚

å› ä¸ºï¼ˆæ•°ç»„é•¿åº¦-1ï¼‰æ­£å¥½ç›¸å½“äºä¸€ä¸ªâ€œä½ä½æ©ç â€â€”â€”è¿™ä¸ªæ©ç çš„ä½ä½æœ€å¥½å…¨æ˜¯ 1ï¼Œè¿™æ · & æ“ä½œæ‰æœ‰æ„ä¹‰ï¼Œå¦åˆ™ç»“æœå°±è‚¯å®šæ˜¯ 0ã€‚

> a&b æ“ä½œçš„ç»“æœæ˜¯ï¼šaã€b ä¸­å¯¹åº”ä½åŒæ—¶ä¸º 1ï¼Œåˆ™å¯¹åº”ç»“æœä½ä¸º 1ï¼Œå¦åˆ™ä¸º 0ã€‚ä¾‹å¦‚ 5&3=1ï¼Œ5 çš„äºŒè¿›åˆ¶æ˜¯ 0101ï¼Œ3 çš„äºŒè¿›åˆ¶æ˜¯ 0011ï¼Œ5&3=0001=1ã€‚

2 çš„æ•´æ¬¡å¹‚ï¼ˆæˆ–è€…å« 2 çš„æ•´æ•°å€ï¼‰åˆšå¥½æ˜¯å¶æ•°ï¼Œå¶æ•°-1 æ˜¯å¥‡æ•°ï¼Œå¥‡æ•°çš„äºŒè¿›åˆ¶æœ€åä¸€ä½æ˜¯ 1ï¼Œä¿è¯äº† `hash &(length-1)` çš„æœ€åä¸€ä½å¯èƒ½ä¸º 0ï¼Œä¹Ÿå¯èƒ½ä¸º 1ï¼ˆå–å†³äº hash çš„å€¼ï¼‰ï¼Œå³ & è¿ç®—åçš„ç»“æœå¯èƒ½ä¸ºå¶æ•°ï¼Œä¹Ÿå¯èƒ½ä¸ºå¥‡æ•°ï¼Œè¿™æ ·ä¾¿å¯ä»¥ä¿è¯å“ˆå¸Œå€¼çš„å‡åŒ€åˆ†å¸ƒã€‚

æ¢å¥è¯è¯´ï¼Œ& æ“ä½œçš„ç»“æœå°±æ˜¯å°†å“ˆå¸Œå€¼çš„é«˜ä½å…¨éƒ¨å½’é›¶ï¼Œåªä¿ç•™ä½ä½å€¼ã€‚

å‡è®¾æŸå“ˆå¸Œå€¼çš„äºŒè¿›åˆ¶ä¸º `10100101 11000100 00100101`ï¼Œç”¨å®ƒæ¥åš & è¿ç®—ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç»“æœã€‚

æˆ‘ä»¬çŸ¥é“ï¼ŒHashMap çš„åˆå§‹é•¿åº¦ä¸º 16ï¼Œ16-1=15ï¼ŒäºŒè¿›åˆ¶æ˜¯ `00000000 00000000 00001111`ï¼ˆé«˜ä½ç”¨ 0 æ¥è¡¥é½ï¼‰ï¼š

```
	 10100101 11000100 00100101
&	 00000000 00000000 00001111
----------------------------------
	 00000000 00000000 00000101
```

å› ä¸º 15 çš„é«˜ä½å…¨éƒ¨æ˜¯ 0ï¼Œæ‰€ä»¥ & è¿ç®—åçš„é«˜ä½ç»“æœè‚¯å®šä¹Ÿæ˜¯ 0ï¼Œåªå‰©ä¸‹ 4 ä¸ªä½ä½ `0101`ï¼Œä¹Ÿå°±æ˜¯åè¿›åˆ¶çš„ 5ã€‚

è¿™æ ·ï¼Œå“ˆå¸Œå€¼ä¸º `10100101 11000100 00100101` çš„é”®å°±ä¼šæ”¾åœ¨æ•°ç»„çš„ç¬¬ 5 ä¸ªä½ç½®ä¸Šã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆæ˜¯ 2 æ¬¡å¹‚ åˆ°ä»€ä¹ˆæ—¶å€™å¼€å§‹æ‰©å®¹ æ‰©å®¹æœºåˆ¶æµç¨‹

### 16.å¦‚æœåˆå§‹åŒ– HashMapï¼Œä¼ ä¸€ä¸ª 17 çš„å€¼`new HashMap<>`ï¼Œå®ƒä¼šæ€ä¹ˆå¤„ç†ï¼Ÿ

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åˆå§‹åŒ–æ—¶ï¼Œä¼ çš„ä¸æ˜¯ 2 çš„å€æ•°æ—¶ï¼ŒHashMap ä¼šå‘ä¸Šå¯»æ‰¾`ç¦»å¾—æœ€è¿‘çš„2çš„å€æ•°`ï¼Œæ‰€ä»¥ä¼ å…¥ 17ï¼Œä½† HashMap çš„å®é™…å®¹é‡æ˜¯ 32ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹è¯¦æƒ…ï¼Œåœ¨ HashMap çš„åˆå§‹åŒ–ä¸­ï¼Œæœ‰è¿™æ ·â¼€æ®µâ½…æ³•ï¼›

```java
public HashMap(int initialCapacity, float loadFactor) {
 ...
 this.loadFactor = loadFactor;
 this.threshold = tableSizeFor(initialCapacity);
}
```

- é˜€å€¼ threshold ï¼Œé€šè¿‡â½…æ³•` tableSizeFor` è¿›â¾è®¡ç®—ï¼Œæ˜¯æ ¹æ®åˆå§‹åŒ–ä¼ çš„å‚æ•°æ¥è®¡ç®—çš„ã€‚
- åŒæ—¶ï¼Œè¿™ä¸ªâ½…æ³•ä¹Ÿè¦è¦å¯»æ‰¾â½åˆå§‹å€¼â¼¤çš„ï¼Œæœ€â¼©çš„é‚£ä¸ª 2 è¿›åˆ¶æ•°å€¼ã€‚â½å¦‚ä¼ äº† 17ï¼Œæˆ‘åº”è¯¥æ‰¾åˆ°çš„æ˜¯ 32ã€‚

```java
static final int tableSizeFor(int cap) {
 int n = cap - 1;
 n |= n >>> 1;
 n |= n >>> 2;
 n |= n >>> 4;
 n |= n >>> 8;
 n |= n >>> 16;
 return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1; }
```

- MAXIMUM_CAPACITY = 1 << 30ï¼Œè¿™ä¸ªæ˜¯ä¸´ç•ŒèŒƒå›´ï¼Œä¹Ÿå°±æ˜¯æœ€â¼¤çš„ Map é›†åˆã€‚
- è®¡ç®—è¿‡ç¨‹æ˜¯å‘å³ç§»ä½ 1ã€2ã€4ã€8ã€16ï¼Œå’ŒåŸæ¥çš„æ•°åš`|`è¿ç®—ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†æŠŠâ¼†è¿›åˆ¶çš„å„ä¸ªä½ç½®éƒ½å¡«ä¸Š 1ï¼Œå½“â¼†è¿›åˆ¶çš„å„ä¸ªä½ç½®éƒ½æ˜¯ 1 ä»¥åï¼Œå°±æ˜¯â¼€ä¸ªæ ‡å‡†çš„ 2 çš„å€æ•°å‡ 1 äº†ï¼Œæœ€åæŠŠç»“æœåŠ  1 å†è¿”å›å³å¯ã€‚

ä»¥ 17 ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹åˆå§‹åŒ–è®¡ç®— table å®¹é‡çš„è¿‡ç¨‹ï¼š

![å®¹é‡è®¡ç®—](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-18.png)

### 17.ä½ è¿˜çŸ¥é“å“ªäº›å“ˆå¸Œå‡½æ•°çš„æ„é€ æ–¹æ³•å‘¢ï¼Ÿ

HashMap é‡Œå“ˆå¸Œæ„é€ å‡½æ•°çš„æ–¹æ³•å«ï¼š

- **é™¤ç•™å–ä½™æ³•**ï¼šHï¼ˆkey)=key%pï¼ˆp<=Nï¼‰,å…³é”®å­—é™¤ä»¥ä¸€ä¸ªä¸å¤§äºå“ˆå¸Œè¡¨é•¿åº¦çš„æ­£æ•´æ•° pï¼Œæ‰€å¾—ä½™æ•°ä¸ºåœ°å€ï¼Œå½“ç„¶ HashMap é‡Œè¿›è¡Œäº†ä¼˜åŒ–æ”¹é€ ï¼Œæ•ˆç‡æ›´é«˜ï¼Œæ•£åˆ—ä¹Ÿæ›´å‡è¡¡ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰è¿™å‡ ç§å¸¸è§çš„å“ˆå¸Œå‡½æ•°æ„é€ æ–¹æ³•ï¼š

- **ç›´æ¥å®šå€æ³•**

  ç›´æ¥æ ¹æ®`key`æ¥æ˜ å°„åˆ°å¯¹åº”çš„æ•°ç»„ä½ç½®ï¼Œä¾‹å¦‚ 1232 æ”¾åˆ°ä¸‹æ ‡ 1232 çš„ä½ç½®ã€‚

- **æ•°å­—åˆ†ææ³•**

  å–`key`çš„æŸäº›æ•°å­—ï¼ˆä¾‹å¦‚åä½å’Œç™¾ä½ï¼‰ä½œä¸ºæ˜ å°„çš„ä½ç½®

- **å¹³æ–¹å–ä¸­æ³•**

  å–`key`å¹³æ–¹çš„ä¸­é—´å‡ ä½ä½œä¸ºæ˜ å°„çš„ä½ç½®

- **æŠ˜å æ³•**

  å°†`key`åˆ†å‰²æˆä½æ•°ç›¸åŒçš„å‡ æ®µï¼Œç„¶åæŠŠå®ƒä»¬çš„å åŠ å’Œä½œä¸ºæ˜ å°„çš„ä½ç½®

![æ•£åˆ—å‡½æ•°æ„é€ ](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-19.png)

### 18.è§£å†³å“ˆå¸Œå†²çªæœ‰å“ªäº›æ–¹æ³•å‘¢ï¼Ÿ

æˆ‘ä»¬åˆ°ç°åœ¨å·²ç»çŸ¥é“ï¼ŒHashMap ä½¿ç”¨é“¾è¡¨çš„åŸå› ä¸ºäº†å¤„ç†å“ˆå¸Œå†²çªï¼Œè¿™ç§æ–¹æ³•å°±æ˜¯æ‰€è°“çš„ï¼š

- **é“¾åœ°å€æ³•**ï¼šåœ¨å†²çªçš„ä½ç½®æ‹‰ä¸€ä¸ªé“¾è¡¨ï¼ŒæŠŠå†²çªçš„å…ƒç´ æ”¾è¿›å»ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å¸¸è§çš„è§£å†³å†²çªçš„åŠæ³•ï¼š

- **å¼€æ”¾å®šå€æ³•**ï¼šå¼€æ”¾å®šå€æ³•å°±æ˜¯ä»å†²çªçš„ä½ç½®å†æ¥ç€å¾€ä¸‹æ‰¾ï¼Œç»™å†²çªå…ƒç´ æ‰¾ä¸ªç©ºä½ã€‚

  æ‰¾åˆ°ç©ºé—²ä½ç½®çš„æ–¹æ³•ä¹Ÿæœ‰å¾ˆå¤šç§ï¼š

  - çº¿è¡Œæ¢æŸ¥æ³•: ä»å†²çªçš„ä½ç½®å¼€å§‹ï¼Œä¾æ¬¡åˆ¤æ–­ä¸‹ä¸€ä¸ªä½ç½®æ˜¯å¦ç©ºé—²ï¼Œç›´è‡³æ‰¾åˆ°ç©ºé—²ä½ç½®
  - å¹³æ–¹æ¢æŸ¥æ³•: ä»å†²çªçš„ä½ç½® x å¼€å§‹ï¼Œç¬¬ä¸€æ¬¡å¢åŠ `1^2`ä¸ªä½ç½®ï¼Œç¬¬äºŒæ¬¡å¢åŠ `2^2`â€¦ï¼Œç›´è‡³æ‰¾åˆ°ç©ºé—²çš„ä½ç½®
  - â€¦â€¦

![å¼€æ”¾å®šå€æ³•](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-20.png)

- **å†å“ˆå¸Œæ³•**ï¼šæ¢ç§å“ˆå¸Œå‡½æ•°ï¼Œé‡æ–°è®¡ç®—å†²çªå…ƒç´ çš„åœ°å€ã€‚
- **å»ºç«‹å…¬å…±æº¢å‡ºåŒº**ï¼šå†å»ºä¸€ä¸ªæ•°ç»„ï¼ŒæŠŠå†²çªçš„å…ƒç´ æ”¾è¿›å»ã€‚

### 19.ä¸ºä»€ä¹ˆ HashMap é“¾è¡¨è½¬çº¢é»‘æ ‘çš„é˜ˆå€¼ä¸º 8 å‘¢ï¼Ÿ

æ ‘åŒ–å‘ç”Ÿåœ¨ table æ•°ç»„çš„é•¿åº¦å¤§äº 64ï¼Œä¸”é“¾è¡¨çš„é•¿åº¦å¤§äº 8 çš„æ—¶å€™ã€‚

ä¸ºä»€ä¹ˆæ˜¯ 8 å‘¢ï¼Ÿæºç çš„æ³¨é‡Šä¹Ÿç»™å‡ºäº†ç­”æ¡ˆã€‚

![æºç æ³¨é‡Š](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-21.png)

çº¢é»‘æ ‘èŠ‚ç‚¹çš„å¤§å°å¤§æ¦‚æ˜¯æ™®é€šèŠ‚ç‚¹å¤§å°çš„ä¸¤å€ï¼Œæ‰€ä»¥è½¬çº¢é»‘æ ‘ï¼Œç‰ºç‰²äº†ç©ºé—´æ¢æ—¶é—´ï¼Œæ›´å¤šçš„æ˜¯ä¸€ç§å…œåº•çš„ç­–ç•¥ï¼Œä¿è¯æç«¯æƒ…å†µä¸‹çš„æŸ¥æ‰¾æ•ˆç‡ã€‚

é˜ˆå€¼ä¸ºä»€ä¹ˆè¦é€‰ 8 å‘¢ï¼Ÿå’Œç»Ÿè®¡å­¦æœ‰å…³ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œä½¿ç”¨éšæœºå“ˆå¸Œç ï¼Œé“¾è¡¨é‡Œçš„èŠ‚ç‚¹ç¬¦åˆæ³Šæ¾åˆ†å¸ƒï¼Œå‡ºç°èŠ‚ç‚¹ä¸ªæ•°çš„æ¦‚ç‡æ˜¯é€’å‡çš„ï¼ŒèŠ‚ç‚¹ä¸ªæ•°ä¸º 8 çš„æƒ…å†µï¼Œå‘ç”Ÿæ¦‚ç‡ä»…ä¸º`0.00000006`ã€‚

è‡³äºçº¢é»‘æ ‘è½¬å›é“¾è¡¨çš„é˜ˆå€¼ä¸ºä»€ä¹ˆæ˜¯ 6ï¼Œè€Œä¸æ˜¯ 8ï¼Ÿæ˜¯å› ä¸ºå¦‚æœè¿™ä¸ªé˜ˆå€¼ä¹Ÿè®¾ç½®æˆ 8ï¼Œå‡å¦‚å‘ç”Ÿç¢°æ’ï¼ŒèŠ‚ç‚¹å¢å‡åˆšå¥½åœ¨ 8 é™„è¿‘ï¼Œä¼šå‘ç”Ÿé“¾è¡¨å’Œçº¢é»‘æ ‘çš„ä¸æ–­è½¬æ¢ï¼Œå¯¼è‡´èµ„æºæµªè´¹ã€‚

### 20.æ‰©å®¹åœ¨ä»€ä¹ˆæ—¶å€™å‘¢ï¼Ÿä¸ºä»€ä¹ˆæ‰©å®¹å› å­æ˜¯ 0.75ï¼Ÿ

HashMap ä¼šåœ¨å­˜å‚¨çš„é”®å€¼å¯¹æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼ˆå³å®¹é‡ \* åŠ è½½å› å­ï¼‰æ—¶è¿›è¡Œæ‰©å®¹ã€‚

![](https://cdn.tobebetterjavaer.com/stutymore/collection-20240323113620.png)

é»˜è®¤çš„åŠ è½½å› å­æ˜¯ 0.75ï¼Œè¿™æ„å‘³ç€å½“ HashMap å¡«æ»¡äº†å¤§çº¦ 75%çš„å®¹é‡æ—¶ï¼Œå°±ä¼šè¿›è¡Œæ‰©å®¹ã€‚

```java
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16
```

é»˜è®¤çš„åˆå§‹å®¹é‡æ˜¯ 16ï¼Œé‚£å°±æ˜¯å¤§äº`16x0.75=12`æ—¶ï¼Œå°±ä¼šè§¦å‘ç¬¬ä¸€æ¬¡æ‰©å®¹æ“ä½œã€‚

#### é‚£ä¹ˆä¸ºä»€ä¹ˆé€‰æ‹©äº† 0.75 ä½œä¸º HashMap çš„é»˜è®¤åŠ è½½å› å­å‘¢ï¼Ÿ

ç®€å•æ¥è¯´ï¼Œè¿™æ˜¯å¯¹`ç©ºé—´`æˆæœ¬å’Œ`æ—¶é—´`æˆæœ¬å¹³è¡¡çš„è€ƒè™‘ã€‚

åœ¨ HashMap ä¸­æœ‰è¿™æ ·ä¸€æ®µæ³¨é‡Šï¼š

![å…³äºé»˜è®¤è´Ÿè½½å› å­çš„æ³¨é‡Š](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-24.png)

æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒHashMap çš„æ•£åˆ—æ„é€ æ–¹å¼æ˜¯ Hash å–ä½™ï¼Œè´Ÿè½½å› å­å†³å®šå…ƒç´ ä¸ªæ•°è¾¾åˆ°å¤šå°‘æ—¶å€™æ‰©å®¹ã€‚

å‡å¦‚æˆ‘ä»¬è®¾çš„æ¯”è¾ƒå¤§ï¼Œå…ƒç´ æ¯”è¾ƒå¤šï¼Œç©ºä½æ¯”è¾ƒå°‘çš„æ—¶å€™æ‰æ‰©å®¹ï¼Œé‚£ä¹ˆå‘ç”Ÿå“ˆå¸Œå†²çªçš„æ¦‚ç‡å°±å¢åŠ äº†ï¼ŒæŸ¥æ‰¾çš„æ—¶é—´æˆæœ¬å°±å¢åŠ äº†ã€‚

æˆ‘ä»¬è®¾çš„æ¯”è¾ƒå°çš„è¯ï¼Œå…ƒç´ æ¯”è¾ƒå°‘ï¼Œç©ºä½æ¯”è¾ƒå¤šçš„æ—¶å€™å°±æ‰©å®¹äº†ï¼Œå‘ç”Ÿå“ˆå¸Œç¢°æ’çš„æ¦‚ç‡å°±é™ä½äº†ï¼ŒæŸ¥æ‰¾æ—¶é—´æˆæœ¬é™ä½ï¼Œä½†æ˜¯å°±éœ€è¦æ›´å¤šçš„ç©ºé—´å»å­˜å‚¨å…ƒç´ ï¼Œç©ºé—´æˆæœ¬å°±å¢åŠ äº†ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆæ˜¯ 2 æ¬¡å¹‚ åˆ°ä»€ä¹ˆæ—¶å€™å¼€å§‹æ‰©å®¹ æ‰©å®¹æœºåˆ¶æµç¨‹

### 21.é‚£æ‰©å®¹æœºåˆ¶äº†è§£å—ï¼Ÿ

æ‰©å®¹æ—¶ï¼ŒHashMap ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå…¶å®¹é‡æ˜¯åŸæ•°ç»„å®¹é‡çš„ä¸¤å€ã€‚

ç„¶åå°†é”®å€¼å¯¹æ”¾åˆ°æ–°è®¡ç®—å‡ºçš„ç´¢å¼•ä½ç½®ä¸Šã€‚ä¸€éƒ¨åˆ†ç´¢å¼•ä¸å˜ï¼Œå¦ä¸€éƒ¨åˆ†ç´¢å¼•ä¸ºâ€œåŸç´¢å¼•+æ—§å®¹é‡â€ã€‚

åœ¨ JDK 7 ä¸­ï¼Œå®šä½å…ƒç´ ä½ç½®çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```java
static int indexFor(int h, int length) {
    // assert Integer.bitCount(length) == 1 : "length must be a non-zero power of 2";
    return h & (length-1);
}
```

å…¶å®å°±ç›¸å½“äºç”¨é”®çš„å“ˆå¸Œå€¼å’Œæ•°ç»„å¤§å°å–æ¨¡ï¼Œä¹Ÿå°±æ˜¯ `hashCode % table.length`ã€‚

é‚£æˆ‘ä»¬æ¥å‡è®¾ï¼š

- æ•°ç»„ table çš„é•¿åº¦ä¸º 2
- é”®çš„å“ˆå¸Œå€¼ä¸º 3ã€7ã€5

å–æ¨¡è¿ç®—åï¼Œé”®å‘ç”Ÿäº†å“ˆå¸Œå†²çªï¼Œéƒ½åˆ° `table[1]` ä¸Šäº†ã€‚é‚£ä¹ˆæ‰©å®¹å‰å°±æ˜¯è¿™ä¸ªæ ·å­ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/collection/hashmap-resize-01.png)

æ•°ç»„çš„å®¹é‡ä¸º 2ï¼Œkey ä¸º 3ã€7ã€5 çš„å…ƒç´ åœ¨ `table[1]` ä¸Šï¼Œéœ€è¦é€šè¿‡æ‹‰é“¾æ³•æ¥è§£å†³å“ˆå¸Œå†²çªã€‚

å‡è®¾è´Ÿè½½å› å­ loadFactor ä¸º 1ï¼Œä¹Ÿå°±æ˜¯å½“å…ƒç´ çš„ä¸ªæ•°å¤§äº table çš„é•¿åº¦æ—¶è¿›è¡Œæ‰©å®¹ã€‚

æ‰©å®¹åçš„æ•°ç»„å®¹é‡ä¸º 4ã€‚

- key 3 å–æ¨¡ï¼ˆ3%4ï¼‰åæ˜¯ 3ï¼Œæ”¾åœ¨ `table[3]` ä¸Šã€‚
- key 7 å–æ¨¡ï¼ˆ7%4ï¼‰åæ˜¯ 3ï¼Œæ”¾åœ¨ `table[3]` ä¸Šçš„é“¾è¡¨å¤´éƒ¨ã€‚
- key 5 å–æ¨¡ï¼ˆ5%4ï¼‰åæ˜¯ 1ï¼Œæ”¾åœ¨ `table[1]` ä¸Šã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/collection/hashmap-resize-02.png)

7 è·‘åˆ° 3 çš„å‰é¢äº†ï¼Œå› ä¸º JDK 7 ä½¿ç”¨çš„æ˜¯å¤´æ’æ³•ã€‚

```java
e.next = newTable[i];
```

åŒæ—¶ï¼Œæ‰©å®¹åçš„ 5 è·‘åˆ°äº†ä¸‹æ ‡ä¸º 1 çš„ä½ç½®ã€‚

æœ€å¥½çš„æƒ…å†µå°±æ˜¯ï¼Œæ‰©å®¹åçš„ 7 åœ¨ 3 çš„åé¢ï¼Œ5 åœ¨ 7 çš„åé¢ï¼Œä¿æŒåŸæ¥çš„é¡ºåºã€‚

JDK 8 å®Œå…¨æ‰­è½¬äº†è¿™ä¸ªå±€é¢ï¼Œå› ä¸º JDK 8 çš„å“ˆå¸Œç®—æ³•è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå½“æ•°ç»„é•¿åº¦ä¸º 2 çš„å¹‚æ¬¡æ–¹æ—¶ï¼Œèƒ½å¤Ÿå¾ˆå·§å¦™åœ°è§£å†³ JDK 7 ä¸­é‡åˆ°çš„é—®é¢˜ã€‚

JDK 8 çš„æ‰©å®¹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
Node<K,V>[] newTab = new Node[newCapacity];
for (int j = 0; j < oldTab.length; j++) {
    Node<K,V> e = oldTab[j];
    if (e != null) {
        int hash = e.hash;
        int newIndex = hash & (newCapacity - 1); // è®¡ç®—åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®
        // å°†èŠ‚ç‚¹ç§»åŠ¨åˆ°æ–°æ•°ç»„çš„å¯¹åº”ä½ç½®
        newTab[newIndex] = e;
    }
}
```

æ–°ç´¢å¼•çš„è®¡ç®—æ–¹å¼æ˜¯ `hash & (newCapacity - 1)`ï¼Œå’Œ JDK 7 çš„ `h & (length-1)`æ²¡ä»€ä¹ˆå¤§çš„å·®åˆ«ï¼Œå·®åˆ«ä¸»è¦åœ¨ hash æ–¹æ³•ä¸Šï¼ŒJDK 8 æ˜¯è¿™æ ·ï¼š

```java
static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

è¿‡å°†é”®çš„`hashCode()`è¿”å›çš„ 32 ä½å“ˆå¸Œå€¼ä¸è¿™ä¸ªå“ˆå¸Œå€¼æ— ç¬¦å·å³ç§» 16 ä½çš„ç»“æœè¿›è¡Œå¼‚æˆ–ã€‚

JDK 7 æ˜¯è¿™æ ·ï¼š

```java
final int hash(Object k) {
    int h = hashSeed;
    if (0 != h && k instanceof String) {
        return sun.misc.Hashing.stringHash32((String) k);
    }

    h ^= k.hashCode();

    // This function ensures that hashCodes that differ only by
    // constant multiples at each bit position have a bounded
    // number of collisions (approximately 8 at default load factor).
    h ^= (h >>> 20) ^ (h >>> 12);
    return h ^ (h >>> 7) ^ (h >>> 4);
}
```

æˆ‘ä»¬ç”¨ JDK 8 çš„å“ˆå¸Œç®—æ³•æ¥è®¡ç®—ä¸€ä¸‹å“ˆå¸Œå€¼ï¼Œå°±ä¼šå‘ç°åˆ«æœ‰æ´å¤©ã€‚

å‡è®¾æ‰©å®¹å‰çš„æ•°ç»„é•¿åº¦ä¸º 16ï¼ˆn-1 ä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶çš„ 0000 1111ï¼Œ1X$2^0$+1X$2^1$+1X$2^2$+1X$2^3$=1+2+4+8=15ï¼‰ï¼Œkey1 ä¸º 5ï¼ˆäºŒè¿›åˆ¶ä¸º 0000 0101ï¼‰ï¼Œkey2 ä¸º 21ï¼ˆäºŒè¿›åˆ¶ä¸º 0001 0101ï¼‰ã€‚

- key1 å’Œ n-1 åš & è¿ç®—åä¸º 0000 0101ï¼Œä¹Ÿå°±æ˜¯ 5ï¼›
- key2 å’Œ n-1 åš & è¿ç®—åä¸º 0000 0101ï¼Œä¹Ÿå°±æ˜¯ 5ã€‚
- æ­¤æ—¶å“ˆå¸Œå†²çªäº†ï¼Œç”¨æ‹‰é“¾æ³•æ¥è§£å†³å“ˆå¸Œå†²çªã€‚

ç°åœ¨ï¼ŒHashMap è¿›è¡Œäº†æ‰©å®¹ï¼Œå®¹é‡ä¸ºåŸæ¥çš„ 2 å€ï¼Œä¹Ÿå°±æ˜¯ 32ï¼ˆn-1 ä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶çš„ 0001 1111ï¼Œ1X$2^0$+1X$2^1$+1X$2^2$+1X$2^3$+1X$2^4$=1+2+4+8+16=31ï¼‰ã€‚

- key1 å’Œ n-1 åš & è¿ç®—åä¸º 0000 0101ï¼Œä¹Ÿå°±æ˜¯ 5ï¼›
- key2 å’Œ n-1 åš & è¿ç®—åä¸º 0001 0101ï¼Œä¹Ÿå°±æ˜¯ 21=5+16ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„æ‰©å®¹å‰çš„ä½ç½®+åŸæ•°ç»„çš„é•¿åº¦ã€‚

ç¥å¥‡å§ï¼Ÿ

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ‰©å®¹ä½ç½®å˜åŒ–](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-26.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ JDK 8 çš„æ–° hash ç®—æ³•ä¸‹ï¼Œæ•°ç»„æ‰©å®¹åçš„ç´¢å¼•ä½ç½®ï¼Œè¦ä¹ˆå°±æ˜¯åŸæ¥çš„ç´¢å¼•ä½ç½®ï¼Œè¦ä¹ˆå°±æ˜¯â€œåŸç´¢å¼•+åŸæ¥çš„å®¹é‡â€ï¼Œéµå¾ªä¸€å®šçš„è§„å¾‹ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ‰©å®¹èŠ‚ç‚¹è¿ç§»ç¤ºæ„å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-27.png)

å½“ç„¶äº†ï¼Œè¿™ä¸ªåŠŸåŠ³æ—¢å±äºæ–°çš„å“ˆå¸Œç®—æ³•ï¼Œä¹Ÿç¦»ä¸å¼€ n ä¸º 2 çš„æ•´æ•°æ¬¡å¹‚è¿™ä¸ªå‰æï¼Œè¿™æ˜¯å®ƒä¿©é€šåŠ›åˆä½œåçš„ç»“æœ `hash & (newCapacity - 1)`ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆæ˜¯ 2 æ¬¡å¹‚ åˆ°ä»€ä¹ˆæ—¶å€™å¼€å§‹æ‰©å®¹ æ‰©å®¹æœºåˆ¶æµç¨‹

### 22.jdk1.8 å¯¹ HashMap ä¸»è¦åšäº†å“ªäº›ä¼˜åŒ–å‘¢ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

jdk1.8 çš„ HashMap ä¸»è¦æœ‰äº”ç‚¹ä¼˜åŒ–ï¼š

1. **æ•°æ®ç»“æ„**ï¼šæ•°ç»„ + é“¾è¡¨æ”¹æˆäº†æ•°ç»„ + é“¾è¡¨æˆ–çº¢é»‘æ ‘

   `åŸå› `ï¼šå‘ç”Ÿ hash å†²çªï¼Œå…ƒç´ ä¼šå­˜å…¥é“¾è¡¨ï¼Œé“¾è¡¨è¿‡é•¿è½¬ä¸ºçº¢é»‘æ ‘ï¼Œå°†æ—¶é—´å¤æ‚åº¦ç”±`O(n)`é™ä¸º`O(logn)`

2. **é“¾è¡¨æ’å…¥æ–¹å¼**ï¼šé“¾è¡¨çš„æ’å…¥æ–¹å¼ä»å¤´æ’æ³•æ”¹æˆäº†å°¾æ’æ³•

   ç®€å•è¯´å°±æ˜¯æ’å…¥æ—¶ï¼Œå¦‚æœæ•°ç»„ä½ç½®ä¸Šå·²ç»æœ‰å…ƒç´ ï¼Œ1.7 å°†æ–°å…ƒç´ æ”¾åˆ°æ•°ç»„ä¸­ï¼ŒåŸå§‹èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œ1.8 éå†é“¾è¡¨ï¼Œå°†å…ƒç´ æ”¾ç½®åˆ°é“¾è¡¨çš„æœ€åã€‚

   `åŸå› `ï¼šå› ä¸º 1.7 å¤´æ’æ³•æ‰©å®¹æ—¶ï¼Œå¤´æ’æ³•ä¼šä½¿é“¾è¡¨å‘ç”Ÿåè½¬ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šäº§ç”Ÿç¯ã€‚

3. **æ‰©å®¹ rehash**ï¼šæ‰©å®¹çš„æ—¶å€™ 1.7 éœ€è¦å¯¹åŸæ•°ç»„ä¸­çš„å…ƒç´ è¿›è¡Œé‡æ–° hash å®šä½åœ¨æ–°æ•°ç»„çš„ä½ç½®ï¼Œ1.8 é‡‡ç”¨æ›´ç®€å•çš„åˆ¤æ–­é€»è¾‘ï¼Œä¸éœ€è¦é‡æ–°é€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—ä½ç½®ï¼Œæ–°çš„ä½ç½®ä¸å˜æˆ–ç´¢å¼• + æ–°å¢å®¹é‡å¤§å°ã€‚

   `åŸå› ï¼š`æé«˜æ‰©å®¹çš„æ•ˆç‡ï¼Œæ›´å¿«åœ°æ‰©å®¹ã€‚

4. **æ‰©å®¹æ—¶æœº**ï¼šåœ¨æ’å…¥æ—¶ï¼Œ1.7 å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œå†æ’å…¥ï¼Œ1.8 å…ˆè¿›è¡Œæ’å…¥ï¼Œæ’å…¥å®Œæˆå†åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼›

5. **æ•£åˆ—å‡½æ•°**ï¼š1.7 åšäº†å››æ¬¡ç§»ä½å’Œå››æ¬¡å¼‚æˆ–ï¼Œjdk1.8 åªåšä¸€æ¬¡ã€‚

   `åŸå› `ï¼šåš 4 æ¬¡çš„è¯ï¼Œè¾¹é™…æ•ˆç”¨ä¹Ÿä¸å¤§ï¼Œæ”¹ä¸ºä¸€æ¬¡ï¼Œæå‡æ•ˆç‡ã€‚

### 23.ä½ èƒ½è‡ªå·±è®¾è®¡å®ç°ä¸€ä¸ª HashMap å—ï¼Ÿ

è¿™é“é¢˜**å¿«æ‰‹**å¸¸è€ƒã€‚

ä¸è¦æ…Œï¼Œçº¢é»‘æ ‘ç‰ˆå’±ä»¬å¤šåŠæ˜¯å†™ä¸å‡ºæ¥ï¼Œä½†æ˜¯æ•°ç»„+é“¾è¡¨ç‰ˆè¿˜æ˜¯é—®é¢˜ä¸å¤§çš„ï¼Œè¯¦ç»†å¯è§ï¼š [æ‰‹å†™ HashMapï¼Œå¿«æ‰‹é¢è¯•å®˜ç›´å‘¼å†…è¡Œï¼](https://mp.weixin.qq.com/s/Z9yoRZW5itrtgbS-cj0bUg)ã€‚

æ•´ä½“çš„è®¾è®¡ï¼š

- æ•£åˆ—å‡½æ•°ï¼šhashCode()+é™¤ç•™ä½™æ•°æ³•
- å†²çªè§£å†³ï¼šé“¾åœ°å€æ³•
- æ‰©å®¹ï¼šèŠ‚ç‚¹é‡æ–° hash è·å–ä½ç½®

![è‡ªå®šä¹‰HashMapæ•´ä½“ç»“æ„](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-29.png)

å®Œæ•´ä»£ç ï¼š

![å®Œæ•´ä»£ç ](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-30.png)

### 24.HashMap æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿå¤šçº¿ç¨‹ä¸‹ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

> æ¨èé˜…è¯»ï¼š[HashMap è¯¦è§£](https://javabetter.cn/collection/hashmap.html#_04%E3%80%81%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8)

HashMap ä¹‹æ‰€ä»¥ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

â‘ ã€å¤šçº¿ç¨‹ä¸‹æ‰©å®¹ä¼šæ­»å¾ªç¯ã€‚JDK1.7 ä¸­çš„ HashMap ä½¿ç”¨çš„æ˜¯å¤´æ’æ³•æ’å…¥å…ƒç´ ï¼Œåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œæ‰©å®¹çš„æ—¶å€™å°±æœ‰å¯èƒ½å¯¼è‡´å‡ºç°ç¯å½¢é“¾è¡¨ï¼Œé€ æˆæ­»å¾ªç¯ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/collection/hashmap-thread-nosafe-07.png)

ä¸è¿‡ï¼ŒJDK 8 æ—¶å·²ç»ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼Œæ‰©å®¹æ—¶ä¼šä¿æŒé“¾è¡¨åŸæ¥çš„é¡ºåºã€‚

â‘¡ã€å¤šçº¿ç¨‹çš„ put å¯èƒ½ä¼šå¯¼è‡´å…ƒç´ çš„ä¸¢å¤±ã€‚å› ä¸ºè®¡ç®—å‡ºæ¥çš„ä½ç½®å¯èƒ½ä¼šè¢«å…¶ä»–çº¿ç¨‹çš„ put è¦†ç›–ï¼Œå¾ˆå¥½ç†è§£ã€‚æœ¬æ¥å“ˆå¸Œå†²çªæ˜¯åº”è¯¥ç”¨é“¾è¡¨çš„ï¼Œä½†å¤šçº¿ç¨‹æ—¶ç”±äºæ²¡æœ‰åŠ é”ï¼Œç›¸åŒä½ç½®çš„å…ƒç´ å¯èƒ½å°±è¢«å¹²æ‰äº†ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/collection/hashmap-thread-nosafe-10.png)

â‘¢ã€put å’Œ get å¹¶å‘æ—¶ï¼Œå¯èƒ½å¯¼è‡´ get ä¸º nullã€‚çº¿ç¨‹ 1 æ‰§è¡Œ put æ—¶ï¼Œå› ä¸ºå…ƒç´ ä¸ªæ•°è¶…å‡ºé˜ˆå€¼è€Œå¯¼è‡´å‡ºç°æ‰©å®¹ï¼Œçº¿ç¨‹ 2 æ­¤æ—¶æ‰§è¡Œ getï¼Œå°±æœ‰å¯èƒ½å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºçº¿ç¨‹ 1 æ‰§è¡Œå®Œ table = newTab ä¹‹åï¼Œçº¿ç¨‹ 2 ä¸­çš„ table æ­¤æ—¶ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œæ­¤æ—¶å» get çš„æ—¶å€™å½“ç„¶ä¼š get åˆ° null äº†ï¼Œå› ä¸ºå…ƒç´ è¿˜æ²¡æœ‰è½¬ç§»ã€‚

```java
final Node<K,V>[] resize() {
    Node<K,V>[] oldTab = table;
    int oldCap = (oldTab == null) ? 0 : oldTab.length;
    int oldThr = threshold;
    int newCap, newThr = 0;
    if (oldCap > 0) {
        // è¶…è¿‡æœ€å¤§å€¼å°±ä¸å†æ‰©å……äº†ï¼Œå°±åªå¥½éšä½ ç¢°æ’å»å§
        if (oldCap >= MAXIMUM_CAPACITY) {
            threshold = Integer.MAX_VALUE;
            return oldTab;
        }
        // æ²¡è¶…è¿‡æœ€å¤§å€¼ï¼Œå°±æ‰©å……ä¸ºåŸæ¥çš„2å€
        else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&
                 oldCap >= DEFAULT_INITIAL_CAPACITY)
            newThr = oldThr << 1; // double threshold
    }
    else if (oldThr > 0) // initial capacity was placed in threshold
        newCap = oldThr;
    else {               // zero initial threshold signifies using defaults
        newCap = DEFAULT_INITIAL_CAPACITY;
        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
    }
    // è®¡ç®—æ–°çš„resizeä¸Šé™
    if (newThr == 0) {
        float ft = (float)newCap * loadFactor;
        newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?
                  (int)ft : Integer.MAX_VALUE);
    }
    threshold = newThr;
    @SuppressWarnings({"rawtypes","unchecked"})
        Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];
    table = newTab;
}
```

> 1. åä¸º OD åŸé¢˜ï¼šHashMap æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ

### 25.æœ‰ä»€ä¹ˆåŠæ³•èƒ½è§£å†³ HashMap çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜å‘¢ï¼Ÿ

åœ¨ Java ä¸­ï¼Œæœ‰ 3 ç§çº¿ç¨‹å®‰å…¨çš„ Map å®ç°ï¼Œæœ€å¸¸ç”¨çš„æ˜¯[ConcurrentHashMap](https://javabetter.cn/thread/ConcurrentHashMap.html)å’Œ`Collections.synchronizedMap(Map)`åŒ…è£…å™¨ã€‚

Hashtable ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å®ƒçš„ä½¿ç”¨å·²ç»ä¸å†æ¨èä½¿ç”¨ï¼Œå› ä¸º ConcurrentHashMap æä¾›äº†æ›´é«˜çš„å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚

â‘ ã€HashTable æ˜¯ç›´æ¥åœ¨æ–¹æ³•ä¸ŠåŠ  [synchronized å…³é”®å­—](https://javabetter.cn/thread/synchronized-1.html)ï¼Œæ¯”è¾ƒç²—æš´ã€‚

![](https://cdn.tobebetterjavaer.com/stutymore/collection-20240323125211.png)

â‘¡ã€`Collections.synchronizedMap` è¿”å›çš„æ˜¯ [Collections](https://javabetter.cn/common-tool/collections.html) å·¥å…·ç±»çš„å†…éƒ¨ç±»ã€‚

![](https://cdn.tobebetterjavaer.com/stutymore/collection-20240323125418.png)

å†…éƒ¨æ˜¯é€šè¿‡ synchronized å¯¹è±¡é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚

â‘¢ã€[ConcurrentHashMap](https://javabetter.cn/thread/ConcurrentHashMap.html) åœ¨ JDK 7 ä¸­ä½¿ç”¨åˆ†æ®µé”ï¼Œåœ¨ JKD 8 ä¸­ä½¿ç”¨äº† CAS+èŠ‚ç‚¹é”ï¼Œæ€§èƒ½å¾—åˆ°è¿›ä¸€æ­¥æå‡ã€‚

![åˆå¿µåˆæ‹ï¼šConcurrentHashMap 8 ä¸­çš„å®ç°](https://cdn.tobebetterjavaer.com/stutymore/map-20230816155924.png)

#### ä¸ºä»€ä¹ˆ ConcurrentHashMap æ¯” Hashtable æ•ˆç‡é«˜

Hashtable åœ¨ä»»ä½•æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æ•´ä¸ª Mapï¼Œé€šè¿‡å¯¹æ•´ä¸ª Map åŠ é”æ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚

è€Œ ConcurrentHashMapï¼ˆå°¤å…¶æ˜¯åœ¨ JDK 8 åŠä¹‹åç‰ˆæœ¬ï¼‰é€šè¿‡é”åˆ†ç¦»å’Œ CAS æ“ä½œå®ç°æ›´ç»†ç²’åº¦çš„é”å®šç­–ç•¥ï¼Œå…è®¸æ›´é«˜çš„å¹¶å‘ã€‚

```java
static final <K,V> boolean casTabAt(Node<K,V>[] tab, int i,
                                    Node<K,V> c, Node<K,V> v) {
    return U.compareAndSwapObject(tab, ((long)i << ASHIFT) + ABASE, c, v);
}
```

CAS æ“ä½œæ˜¯ä¸€ç§ä¹è§‚é”ï¼Œå®ƒä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œè€Œæ˜¯åœ¨æ›´æ–°æ—¶æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹äº†æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å°±æ›´æ–°ï¼Œå¦‚æœæœ‰å°±é‡è¯•ã€‚

ConcurrentHashMap å…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘è¿›è¡Œè€Œä¸åŠ é”ï¼Œå› ä¸ºå®ƒé€šè¿‡ [volatile å˜é‡](https://javabetter.cn/thread/volatile.html)æ¥ä¿è¯è¯»å–æ“ä½œçš„å†…å­˜å¯è§æ€§ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒHashtable å¯¹è¯»æ“ä½œä¹ŸåŠ é”ï¼Œå¢åŠ äº†å¼€é”€ã€‚

```java
public V get(Object key) {
    Node<K,V>[] tab; Node<K,V> e, p; int n, eh; K ek;
	// 1. é‡hash
    int h = spread(key.hashCode());
    if ((tab = table) != null && (n = tab.length) > 0 &&
        (e = tabAt(tab, (n - 1) & h)) != null) {
        // 2. table[i]æ¡¶èŠ‚ç‚¹çš„keyä¸æŸ¥æ‰¾çš„keyç›¸åŒï¼Œåˆ™ç›´æ¥è¿”å›
		if ((eh = e.hash) == h) {
            if ((ek = e.key) == key || (ek != null && key.equals(ek)))
                return e.val;
        }
		// 3. å½“å‰èŠ‚ç‚¹hashå°äº0è¯´æ˜ä¸ºæ ‘èŠ‚ç‚¹ï¼Œåœ¨çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾å³å¯
        else if (eh < 0)
            return (p = e.find(h, key)) != null ? p.val : null;
        while ((e = e.next) != null) {
		//4. ä»é“¾è¡¨ä¸­æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾åˆ°åˆ™è¿”å›è¯¥èŠ‚ç‚¹çš„valueï¼Œå¦åˆ™å°±è¿”å›nullå³å¯
            if (e.hash == h &&
                ((ek = e.key) == key || (ek != null && key.equals(ek))))
                return e.val;
        }
    }
    return null;
}
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šæœ‰å“ªäº›çº¿ç¨‹å®‰å…¨çš„ mapï¼ŒConcurrentHashMap æ€ä¹ˆä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸ºä»€ä¹ˆæ¯” hashTable æ•ˆç‡å¥½

### 26.èƒ½å…·ä½“è¯´ä¸€ä¸‹ ConcurrentHashmap çš„å®ç°å—ï¼Ÿ

ConcurrentHashmap çº¿ç¨‹å®‰å…¨åœ¨ jdk1.7 ç‰ˆæœ¬æ˜¯åŸºäº`åˆ†æ®µé”`å®ç°ï¼Œåœ¨ jdk1.8 æ˜¯åŸºäº`CAS+synchronized`å®ç°ã€‚

#### 1.7 åˆ†æ®µé”

ä»ç»“æ„ä¸Šè¯´ï¼Œ1.7 ç‰ˆæœ¬çš„ ConcurrentHashMap é‡‡ç”¨åˆ†æ®µé”æœºåˆ¶ï¼Œé‡Œé¢åŒ…å«ä¸€ä¸ª Segment æ•°ç»„ï¼ŒSegment ç»§æ‰¿äº ReentrantLockï¼ŒSegment åˆ™åŒ…å« HashEntry çš„æ•°ç»„ï¼ŒHashEntry æœ¬èº«å°±æ˜¯ä¸€ä¸ªé“¾è¡¨çš„ç»“æ„ï¼Œå…·æœ‰ä¿å­˜ keyã€value çš„èƒ½åŠ›èƒ½æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚

å®é™…ä¸Šå°±æ˜¯ç›¸å½“äºæ¯ä¸ª Segment éƒ½æ˜¯ä¸€ä¸ª HashMapï¼Œé»˜è®¤çš„ Segment é•¿åº¦æ˜¯ 16ï¼Œä¹Ÿå°±æ˜¯æ”¯æŒ 16 ä¸ªçº¿ç¨‹çš„å¹¶å‘å†™ï¼ŒSegment ä¹‹é—´ç›¸äº’ä¸ä¼šå—åˆ°å½±å“ã€‚

![1.7ConcurrentHashMapç¤ºæ„å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-31.png)

**put æµç¨‹**

æ•´ä¸ªæµç¨‹å’Œ HashMap éå¸¸ç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯å…ˆå®šä½åˆ°å…·ä½“çš„ Segmentï¼Œç„¶åé€šè¿‡ ReentrantLock å»æ“ä½œè€Œå·²ï¼Œåé¢çš„æµç¨‹ï¼Œå°±å’Œ HashMap åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ã€‚

1. è®¡ç®— hashï¼Œå®šä½åˆ° segmentï¼Œsegment å¦‚æœæ˜¯ç©ºå°±å…ˆåˆå§‹åŒ–
2. ä½¿ç”¨ ReentrantLock åŠ é”ï¼Œå¦‚æœè·å–é”å¤±è´¥åˆ™å°è¯•è‡ªæ—‹ï¼Œè‡ªæ—‹è¶…è¿‡æ¬¡æ•°å°±é˜»å¡è·å–ï¼Œä¿è¯ä¸€å®šè·å–é”æˆåŠŸ
3. éå† HashEntryï¼Œå°±æ˜¯å’Œ HashMap ä¸€æ ·ï¼Œæ•°ç»„ä¸­ key å’Œ hash ä¸€æ ·å°±ç›´æ¥æ›¿æ¢ï¼Œä¸å­˜åœ¨å°±å†æ’å…¥é“¾è¡¨ï¼Œé“¾è¡¨åŒæ ·æ“ä½œ

<img src="https://gitee.com/sanfene/picgo3/raw/master/20211128230624.jpg" alt="jdk1.7 putæµç¨‹" style="zoom: 50%;" />

**get æµç¨‹**

get ä¹Ÿå¾ˆç®€å•ï¼Œkey é€šè¿‡ hash å®šä½åˆ° segmentï¼Œå†éå†é“¾è¡¨å®šä½åˆ°å…·ä½“çš„å…ƒç´ ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ value æ˜¯ volatile çš„ï¼Œæ‰€ä»¥ get æ˜¯ä¸éœ€è¦åŠ é”çš„ã€‚

#### **1.8 CAS+synchronized**

jdk1.8 å®ç°çº¿ç¨‹å®‰å…¨ä¸æ˜¯åœ¨æ•°æ®ç»“æ„ä¸Šä¸‹åŠŸå¤«ï¼Œå®ƒçš„æ•°æ®ç»“æ„å’Œ HashMap æ˜¯ä¸€æ ·çš„ï¼Œæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ã€‚å®ƒå®ç°çº¿ç¨‹å®‰å…¨çš„å…³é”®ç‚¹åœ¨äº put æµç¨‹ã€‚

**put æµç¨‹**

1. é¦–å…ˆè®¡ç®— hashï¼Œéå† node æ•°ç»„ï¼Œå¦‚æœ node æ˜¯ç©ºçš„è¯ï¼Œå°±é€šè¿‡ CAS+è‡ªæ—‹çš„æ–¹å¼åˆå§‹åŒ–

```java
 tab = initTable();
```

node æ•°ç»„åˆå§‹åŒ–ï¼š

```java
private final Node<K,V>[] initTable() {
    Node<K,V>[] tab; int sc;
    while ((tab = table) == null || tab.length == 0) {
        //å¦‚æœæ­£åœ¨åˆå§‹åŒ–æˆ–è€…æ‰©å®¹
        if ((sc = sizeCtl) < 0)
            //ç­‰å¾…
            Thread.yield(); // lost initialization race; just spin
        else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {   //CASæ“ä½œ
            try {
                if ((tab = table) == null || tab.length == 0) {
                    int n = (sc > 0) ? sc : DEFAULT_CAPACITY;
                    @SuppressWarnings("unchecked")
                    Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n];
                    table = tab = nt;
                    sc = n - (n >>> 2);
                }
            } finally {
                sizeCtl = sc;
            }
            break;
        }
    }
    return tab;
}
```

2.å¦‚æœå½“å‰æ•°ç»„ä½ç½®æ˜¯ç©ºåˆ™ç›´æ¥é€šè¿‡ CAS è‡ªæ—‹å†™å…¥æ•°æ®

```java
static final <K,V> boolean casTabAt(Node<K,V>[] tab, int i,
                                    Node<K,V> c, Node<K,V> v) {
    return U.compareAndSwapObject(tab, ((long)i << ASHIFT) + ABASE, c, v);
}
```

3. å¦‚æœ hash==MOVEDï¼Œè¯´æ˜éœ€è¦æ‰©å®¹ï¼Œæ‰§è¡Œæ‰©å®¹

```java
else if ((fh = f.hash) == MOVED)
                tab = helpTransfer(tab, f);
```

```java
final Node<K,V>[] helpTransfer(Node<K,V>[] tab, Node<K,V> f) {
    Node<K,V>[] nextTab; int sc;
    if (tab != null && (f instanceof ForwardingNode) &&
        (nextTab = ((ForwardingNode<K,V>)f).nextTable) != null) {
        int rs = resizeStamp(tab.length);
        while (nextTab == nextTable && table == tab &&
               (sc = sizeCtl) < 0) {
            if ((sc >>> RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||
                sc == rs + MAX_RESIZERS || transferIndex <= 0)
                break;
            if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) {
                transfer(tab, nextTab);
                break;
            }
        }
        return nextTab;
    }
    return table;
}
```

4. å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œå°±ä½¿ç”¨ synchronized å†™å…¥æ•°æ®ï¼Œå†™å…¥æ•°æ®åŒæ ·åˆ¤æ–­é“¾è¡¨ã€çº¢é»‘æ ‘ï¼Œé“¾è¡¨å†™å…¥å’Œ HashMap çš„æ–¹å¼ä¸€æ ·ï¼Œkey hash ä¸€æ ·å°±è¦†ç›–ï¼Œåä¹‹å°±å°¾æ’æ³•ï¼Œé“¾è¡¨é•¿åº¦è¶…è¿‡ 8 å°±è½¬æ¢æˆçº¢é»‘æ ‘

```java
 synchronized (f){
     â€¦â€¦
 }
```

![ConcurrentHashmap jdk1.8putæµç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-32.jpg)

**get æŸ¥è¯¢**

get å¾ˆç®€å•ï¼Œå’Œ HashMap åŸºæœ¬ç›¸åŒï¼Œé€šè¿‡ key è®¡ç®—ä½ç½®ï¼Œtable è¯¥ä½ç½® key ç›¸åŒå°±è¿”å›ï¼Œå¦‚æœæ˜¯çº¢é»‘æ ‘æŒ‰ç…§çº¢é»‘æ ‘è·å–ï¼Œå¦åˆ™å°±éå†é“¾è¡¨è·å–ã€‚

### 27.HashMap å†…éƒ¨èŠ‚ç‚¹æ˜¯æœ‰åºçš„å—ï¼Ÿ

HashMap æ˜¯æ— åºçš„ï¼Œæ ¹æ® hash å€¼éšæœºæ’å…¥ã€‚å¦‚æœæƒ³ä½¿ç”¨æœ‰åºçš„ Mapï¼Œå¯ä»¥ä½¿ç”¨ LinkedHashMap æˆ–è€… TreeMapã€‚

### 28.è®²è®² LinkedHashMap æ€ä¹ˆå®ç°æœ‰åºçš„ï¼Ÿ

LinkedHashMap ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæœ‰å¤´å°¾èŠ‚ç‚¹ï¼ŒåŒæ—¶ LinkedHashMap èŠ‚ç‚¹ Entry å†…éƒ¨é™¤äº†ç»§æ‰¿ HashMap çš„ Node å±æ€§ï¼Œè¿˜æœ‰ before å’Œ after ç”¨äºæ ‡è¯†å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹ã€‚

![EntryèŠ‚ç‚¹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-33.png)

å¯ä»¥å®ç°æŒ‰æ’å…¥çš„é¡ºåºæˆ–è®¿é—®é¡ºåºæ’åºã€‚

![LinkedHashMapå®ç°åŸç†](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-34.png)

### 29.è®²è®² TreeMap æ€ä¹ˆå®ç°æœ‰åºçš„ï¼Ÿ

TreeMap æ˜¯æŒ‰ç…§ Key çš„è‡ªç„¶é¡ºåºæˆ–è€… Comprator çš„é¡ºåºè¿›è¡Œæ’åºï¼Œå†…éƒ¨æ˜¯é€šè¿‡çº¢é»‘æ ‘æ¥å®ç°ã€‚æ‰€ä»¥è¦ä¹ˆ key æ‰€å±çš„ç±»å®ç° Comparable æ¥å£ï¼Œæˆ–è€…è‡ªå®šä¹‰ä¸€ä¸ªå®ç°äº† Comparator æ¥å£çš„æ¯”è¾ƒå™¨ï¼Œä¼ ç»™ TreeMap ç”¨äº key çš„æ¯”è¾ƒã€‚

![TreeMap](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-35.png)

## Set

### 30.è®²è®² HashSet çš„åº•å±‚å®ç°ï¼Ÿ

HashSet å…¶å®æ˜¯ç”± HashMap å®ç°çš„ï¼Œåªä¸è¿‡å€¼ç”±ä¸€ä¸ªå›ºå®šçš„ Object å¯¹è±¡å¡«å……ï¼Œè€Œé”®ç”¨äºæ“ä½œã€‚

```java
public class HashSet<E>
    extends AbstractSet<E>
    implements Set<E>, Cloneable, java.io.Serializable
{
    static final long serialVersionUID = -5024744406713321676L;
    private transient HashMap<E,Object> map;
    // Dummy value to associate with an Object in the backing Map
    private static final Object PRESENT = new Object();
    // â€¦â€¦
}
```

å®é™…å¼€å‘ä¸­ï¼ŒHashSet å¹¶ä¸å¸¸ç”¨ï¼Œæ¯”å¦‚ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æŒ‰ç…§é¡ºåºå­˜å‚¨ä¸€ç»„å…ƒç´ ï¼Œé‚£ä¹ˆ ArrayList å’Œ LinkedList å¯èƒ½æ›´é€‚åˆï¼›å¦‚æœæˆ‘ä»¬éœ€è¦å­˜å‚¨é”®å€¼å¯¹å¹¶æ ¹æ®é”®è¿›è¡ŒæŸ¥æ‰¾ï¼Œé‚£ä¹ˆ HashMap å¯èƒ½æ›´é€‚åˆã€‚

HashSet ä¸»è¦ç”¨äºå»é‡ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿè®¡ä¸€ç¯‡æ–‡ç« ä¸­æœ‰å¤šå°‘ä¸ªä¸é‡å¤çš„å•è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨ HashSet æ¥å®ç°ã€‚

```java
// åˆ›å»ºä¸€ä¸ª HashSet å¯¹è±¡
HashSet<String> set = new HashSet<>();

// æ·»åŠ å…ƒç´ 
set.add("æ²‰é»˜");
set.add("ç‹äºŒ");
set.add("é™ˆæ¸…æ‰¬");
set.add("æ²‰é»˜");

// è¾“å‡º HashSet çš„å…ƒç´ ä¸ªæ•°
System.out.println("HashSet size: " + set.size()); // output: 3

// éå† HashSet
for (String s : set) {
    System.out.println(s);
}
```

HashSet ä¼šè‡ªåŠ¨å»é‡ï¼Œå› ä¸ºå®ƒæ˜¯ç”¨ HashMap å®ç°çš„ï¼ŒHashMap çš„é”®æ˜¯å”¯ä¸€çš„ï¼ˆå“ˆå¸Œå€¼ï¼‰ï¼Œç›¸åŒé”®çš„å€¼ä¼šè¦†ç›–æ‰åŸæ¥çš„å€¼ï¼Œäºæ˜¯ç¬¬äºŒæ¬¡ set.add("æ²‰é»˜") çš„æ—¶å€™å°±è¦†ç›–äº†ç¬¬ä¸€æ¬¡çš„ set.add("æ²‰é»˜")ã€‚

![HashSetå¥—å¨ƒ](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-36.png)

#### HashSet å’Œ ArrayList çš„åŒºåˆ«

- ArrayList æ˜¯åŸºäºåŠ¨æ€æ•°ç»„å®ç°çš„ï¼ŒHashSet æ˜¯åŸºäº HashMap å®ç°çš„ã€‚
- ArrayList å…è®¸é‡å¤å…ƒç´ å’Œ null å€¼ï¼Œå¯ä»¥æœ‰å¤šä¸ªç›¸åŒçš„å…ƒç´ ï¼›HashSet ä¿è¯æ¯ä¸ªå…ƒç´ å”¯ä¸€ï¼Œä¸å…è®¸é‡å¤å…ƒç´ ï¼ŒåŸºäºå…ƒç´ çš„ hashCode å’Œ equals æ–¹æ³•æ¥ç¡®å®šå…ƒç´ çš„å”¯ä¸€æ€§ã€‚
- ArrayList ä¿æŒå…ƒç´ çš„æ’å…¥é¡ºåºï¼Œå¯ä»¥é€šè¿‡ç´¢å¼•è®¿é—®å…ƒç´ ï¼›HashSet ä¸ä¿è¯å…ƒç´ çš„é¡ºåºï¼Œå…ƒç´ çš„å­˜å‚¨é¡ºåºä¾èµ–äºå“ˆå¸Œç®—æ³•ï¼Œå¹¶ä¸”å¯èƒ½éšç€å…ƒç´ çš„æ·»åŠ æˆ–åˆ é™¤è€Œæ”¹å˜ã€‚

### HashSet æ€ä¹ˆåˆ¤æ–­å…ƒç´ é‡å¤ï¼Œé‡å¤äº†æ˜¯å¦ put

HashSet çš„ add æ–¹æ³•æ˜¯é€šè¿‡è°ƒç”¨ HashMap çš„ put æ–¹æ³•å®ç°çš„ï¼š

```java
public boolean add(E e) {
    return map.put(e, PRESENT)==null;
}
```

æ‰€ä»¥ HashSet åˆ¤æ–­å…ƒç´ é‡å¤çš„é€»è¾‘åº•å±‚ä¾ç„¶æ˜¯ HashMap çš„åº•å±‚é€»è¾‘ï¼š

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šHashMapæ’å…¥æ•°æ®æµç¨‹å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/collection-13.jpg)

HashMap åœ¨æ’å…¥å…ƒç´ æ—¶ï¼Œé€šå¸¸éœ€è¦ä¸‰æ­¥ï¼š

ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ hash æ–¹æ³•è®¡ç®— key çš„å“ˆå¸Œå€¼ã€‚

```java
static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

ç¬¬äºŒæ­¥ï¼Œæ•°ç»„è¿›è¡Œç¬¬ä¸€æ¬¡æ‰©å®¹ã€‚

```java
if ((tab = table) == null || (n = tab.length) == 0)
    n = (tab = resize()).length;
```

ç¬¬ä¸‰æ­¥ï¼Œæ ¹æ®å“ˆå¸Œå€¼è®¡ç®— key åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼Œå¦‚æœå¯¹åº”ä¸‹æ ‡æ­£å¥½æ²¡æœ‰å­˜æ”¾æ•°æ®ï¼Œåˆ™ç›´æ¥æ’å…¥ã€‚

```java
if ((p = tab[i = (n - 1) & hash]) == null)
    tab[i] = newNode(hash, key, value, null);
```

å¦‚æœå¯¹åº”ä¸‹æ ‡å·²ç»æœ‰æ•°æ®äº†ï¼Œå°±éœ€è¦åˆ¤æ–­æ˜¯å¦ä¸ºç›¸åŒçš„ keyï¼Œæ˜¯åˆ™è¦†ç›– valueï¼Œå¦åˆ™éœ€è¦åˆ¤æ–­æ˜¯å¦ä¸ºæ ‘èŠ‚ç‚¹ï¼Œæ˜¯åˆ™å‘æ ‘ä¸­æ’å…¥èŠ‚ç‚¹ï¼Œå¦åˆ™å‘é“¾è¡¨ä¸­æ’å…¥æ•°æ®ã€‚

```java
else {
    Node<K,V> e; K k;
    if (p.hash == hash &&
        ((k = p.key) == key || (key != null && key.equals(k))))
        e = p;
    else if (p instanceof TreeNode)
        e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
    else {
        for (int binCount = 0; ; ++binCount) {
            if ((e = p.next) == null) {
                p.next = newNode(hash, key, value, null);
                if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                    treeifyBin(tab, hash);
                break;
            }
            if (e.hash == hash &&
                ((k = e.key) == key || (key != null && key.equals(k))))
                break;
            p = e;
        }
    }
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼ŒHashSet é€šè¿‡å…ƒç´ çš„å“ˆå¸Œå€¼æ¥åˆ¤æ–­å…ƒç´ æ˜¯å¦é‡å¤ï¼Œå¦‚æœé‡å¤äº†ï¼Œä¼šè¦†ç›–åŸæ¥çš„å€¼ã€‚

```java
if (e != null) { // existing mapping for key
    V oldValue = e.value;
    if (!onlyIfAbsent || oldValue == null)
        e.value = value;
    afterNodeAccess(e);
    return oldValue;
}
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„äº¬ä¸œåŒå­¦ 10 åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šHashSet å’Œ ArrayList çš„åŒºåˆ«
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„äº¬ä¸œåŒå­¦ 10 åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šHashSet æ€ä¹ˆåˆ¤æ–­å…ƒç´ é‡å¤ï¼Œé‡å¤äº†æ˜¯å¦ put

> å›¾æ–‡è¯¦è§£ 30 é“ Java é›†åˆæ¡†æ¶é¢è¯•é«˜é¢‘é¢˜ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚æ•´ç†ï¼šæ²‰é»˜ç‹äºŒï¼Œæˆ³[è½¬è½½é“¾æ¥](https://mp.weixin.qq.com/s/ptbM0EqlnCWeWm9VdSCDLg)ï¼Œä½œè€…ï¼šä¸‰åˆ†æ¶ï¼Œæˆ³[åŸæ–‡é“¾æ¥](https://mp.weixin.qq.com/s/SHkQ7LEOT0itt4bXMoDBPw)ã€‚

---

_æ²¡æœ‰ä»€ä¹ˆä½¿æˆ‘åœç•™â€”â€”é™¤äº†ç›®çš„ï¼Œçºµç„¶å²¸æ—æœ‰ç«ç‘°ã€æœ‰ç»¿è«ã€æœ‰å®é™çš„æ¸¯æ¹¾ï¼Œæˆ‘æ˜¯ä¸ç³»ä¹‹èˆŸ_ã€‚

**ç³»åˆ—å†…å®¹**ï¼š

- [é¢æ¸£é€†è¢­ Java SE ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/javase.html)
- [é¢æ¸£é€†è¢­ Java é›†åˆæ¡†æ¶ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/javathread.html)
- [é¢æ¸£é€†è¢­ Java å¹¶å‘ç¼–ç¨‹ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/collection.html)
- [é¢æ¸£é€†è¢­ JVM ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/jvm.html)
- [é¢æ¸£é€†è¢­ Spring ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/spring.html)
- [é¢æ¸£é€†è¢­ Redis ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/redis.html)
- [é¢æ¸£é€†è¢­ MyBatis ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/mybatis.html)
- [é¢æ¸£é€†è¢­ MySQL ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/mysql.html)
- [é¢æ¸£é€†è¢­æ“ä½œç³»ç»Ÿç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/os.html)
- [é¢æ¸£é€†è¢­è®¡ç®—æœºç½‘ç»œç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/network.html)
- [é¢æ¸£é€†è¢­ RocketMQ ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/rocketmq.html)
- [é¢æ¸£é€†è¢­åˆ†å¸ƒå¼ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/fenbushi.html)
- [é¢æ¸£é€†è¢­å¾®æœåŠ¡ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/weifuwu.html)
- [é¢æ¸£é€†è¢­è®¾è®¡æ¨¡å¼ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/shejimoshi.html)

---

GitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„å¼€æºçŸ¥è¯†åº“ã€Š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://github.com/itwanger/toBeBetterJavaer)ã€‹ç¬¬ä¸€ç‰ˆ PDF ç»ˆäºæ¥äº†ï¼åŒ…æ‹¬ Java åŸºç¡€è¯­æ³•ã€æ•°ç»„&å­—ç¬¦ä¸²ã€OOPã€é›†åˆæ¡†æ¶ã€Java IOã€å¼‚å¸¸å¤„ç†ã€Java æ–°ç‰¹æ€§ã€ç½‘ç»œç¼–ç¨‹ã€NIOã€å¹¶å‘ç¼–ç¨‹ã€JVM ç­‰ç­‰ï¼Œå…±è®¡ 32 ä¸‡ä½™å­—ï¼Œ500+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯é€šä¿—æ˜“æ‡‚ã€é£è¶£å¹½é»˜â€¦â€¦è¯¦æƒ…æˆ³ï¼š[å¤ªèµäº†ï¼ŒGitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„ Java æ•™ç¨‹](https://javabetter.cn/overview/)

å¾®ä¿¡æœ **æ²‰é»˜ç‹äºŒ** æˆ–æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨äºŒå“¥çš„åŸåˆ›å…¬ä¼—å·æ²‰é»˜ç‹äºŒï¼Œå›å¤ **222** å³å¯å…è´¹é¢†å–ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png)
