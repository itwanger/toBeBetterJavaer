---
title: 40 é“ Nginx ç²¾é€‰é¢è¯•é¢˜ğŸ‘
shortTitle: 40 é“ Nginx ç²¾é€‰é¢è¯•é¢˜ğŸ‘
category:
  - æ±‚èŒé¢è¯•
tag:
  - é¢è¯•é¢˜&å…«è‚¡æ–‡
description: äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼Œå°ç™½çš„é›¶åŸºç¡€Javaæ•™ç¨‹ï¼Œ40 é“ Nginx ç²¾é€‰é¢è¯•é¢˜ğŸ‘
head:
  - - meta
    - name: keywords
      content: Nginx,nginx,é¢è¯•é¢˜,å…«è‚¡æ–‡
---

# Nginxï¼š40é“ç²¾é€‰é¢è¯•é¢˜å¿…çœ‹:+1:

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯äºŒå“¥å‘€ï¼é‚£å¤©ï¼Œæˆ‘å¾’å¼Ÿå°äºŒå·å·æ‘¸æ‘¸è·‘å»äº†ä¸€å®¶å…¬å¸é¢è¯•ï¼Œç»“æœå›æ¥ç»™æˆ‘è¯´åœ¨ Nginx ä¸Šè·ªäº†ï¼Œé—®æˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ

æˆ‘å…ˆæ˜¯æ¯«ä¸ç•™æƒ…åœ°æ‰¹è¯„äº†ä»–ï¼Œæ€ä¹ˆèƒ½èƒŒç€é¢†å¯¼å»é¢è¯•å‘¢ï¼Ÿä¸è¿‡ï¼Œçœ‹ç€å°äºŒéš¾è¿‡çš„è¡¨æƒ…ï¼Œæˆ‘è¿˜æ˜¯äºå¿ƒä¸å¿ï¼Œäºæ˜¯ç»™ä»–æ•´ç†äº† 40 é“ Nginx çš„é¢è¯•é¢˜ï¼Œå¸Œæœ›èƒ½å¸®ä»–ä¸€æŠŠã€‚

*   ä»€ä¹ˆæ˜¯Nginxï¼Ÿ
*   Nginx æœ‰å“ªäº›ä¼˜ç‚¹ï¼Ÿ
*   Nginxåº”ç”¨åœºæ™¯ï¼Ÿ
*   Nginxæ€ä¹ˆå¤„ç†è¯·æ±‚çš„ï¼Ÿ
*   Nginx æ˜¯å¦‚ä½•å®ç°é«˜å¹¶å‘çš„ï¼Ÿ
*   ä»€ä¹ˆæ˜¯æ­£å‘ä»£ç†ï¼Ÿ
*   ä»€ä¹ˆæ˜¯åå‘ä»£ç†ï¼Ÿ
*   åå‘ä»£ç†æœåŠ¡å™¨çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆ?
*   Nginxç›®å½•ç»“æ„æœ‰å“ªäº›ï¼Ÿ
*   Nginxé…ç½®æ–‡ä»¶nginx.confæœ‰å“ªäº›å±æ€§æ¨¡å—?
*   cookieå’ŒsessionåŒºåˆ«ï¼Ÿ
*   ä¸ºä»€ä¹ˆ Nginx ä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ
*   nginxå’Œapacheçš„åŒºåˆ«
*   ä»€ä¹ˆæ˜¯åŠ¨æ€èµ„æºã€é™æ€èµ„æºåˆ†ç¦»ï¼Ÿ
*   ä¸ºä»€ä¹ˆè¦åšåŠ¨ã€é™åˆ†ç¦»ï¼Ÿ
*   ä»€ä¹ˆå« CDN æœåŠ¡ï¼Ÿ
*   Nginxæ€ä¹ˆåšçš„åŠ¨é™åˆ†ç¦»ï¼Ÿ
*   Nginxè´Ÿè½½å‡è¡¡çš„ç®—æ³•æ€ä¹ˆå®ç°çš„?ç­–ç•¥æœ‰å“ªäº›?
*   å¦‚ä½•ç”¨Nginxè§£å†³å‰ç«¯è·¨åŸŸé—®é¢˜ï¼Ÿ
*   Nginxè™šæ‹Ÿä¸»æœºæ€ä¹ˆé…ç½®?
*   locationçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
*   é™æµæ€ä¹ˆåšçš„ï¼Ÿ
*   æ¼æ¡¶æµç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•çŸ¥é“ï¼Ÿ
*   Nginxé…ç½®é«˜å¯ç”¨æ€§æ€ä¹ˆé…ç½®ï¼Ÿ
*   Nginxæ€ä¹ˆåˆ¤æ–­åˆ«IPä¸å¯è®¿é—®ï¼Ÿ
*   åœ¨nginxä¸­ï¼Œå¦‚ä½•ä½¿ç”¨æœªå®šä¹‰çš„æœåŠ¡å™¨åç§°æ¥é˜»æ­¢å¤„ç†è¯·æ±‚ï¼Ÿ
*   æ€ä¹ˆé™åˆ¶æµè§ˆå™¨è®¿é—®ï¼Ÿ
*   Rewriteå…¨å±€å˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ
*   Nginx å¦‚ä½•å®ç°åç«¯æœåŠ¡çš„å¥åº·æ£€æŸ¥ï¼Ÿ
*   Nginx å¦‚ä½•å¼€å¯å‹ç¼©ï¼Ÿ
*   ngx_http_upstream_moduleçš„ä½œç”¨æ˜¯ä»€ä¹ˆ?
*   ä»€ä¹ˆæ˜¯C10Ké—®é¢˜?
*   Nginxæ˜¯å¦æ”¯æŒå°†è¯·æ±‚å‹ç¼©åˆ°ä¸Šæ¸¸?
*   å¦‚ä½•åœ¨Nginxä¸­è·å¾—å½“å‰çš„æ—¶é—´?
*   ç”¨NginxæœåŠ¡å™¨è§£é‡Š-sçš„ç›®çš„æ˜¯ä»€ä¹ˆ?
*   å¦‚ä½•åœ¨NginxæœåŠ¡å™¨ä¸Šæ·»åŠ æ¨¡å—?
*   ç”Ÿäº§ä¸­å¦‚ä½•è®¾ç½®workerè¿›ç¨‹çš„æ•°é‡å‘¢ï¼Ÿ
*   nginxçŠ¶æ€ç 

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nginx/40-interview-63553177-7359-4f68-8673-5b44285cb701.png)




* * *

## ä»€ä¹ˆæ˜¯Nginxï¼Ÿ

Nginxæ˜¯ä¸€ä¸ª è½»é‡çº§/é«˜æ€§èƒ½çš„åå‘ä»£ç†WebæœåŠ¡å™¨ï¼Œç”¨äº HTTPã€HTTPSã€SMTPã€POP3 å’Œ IMAP åè®®ã€‚ä»–å®ç°éå¸¸é«˜æ•ˆçš„åå‘ä»£ç†ã€è´Ÿè½½å¹³è¡¡ï¼Œä»–å¯ä»¥å¤„ç†2-3ä¸‡å¹¶å‘è¿æ¥æ•°ï¼Œå®˜æ–¹ç›‘æµ‹èƒ½æ”¯æŒ5ä¸‡å¹¶å‘ï¼Œç°åœ¨ä¸­å›½ä½¿ç”¨nginxç½‘ç«™ç”¨æˆ·æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚ï¼šæ–°æµªã€ç½‘æ˜“ã€ è…¾è®¯ç­‰ã€‚

## Nginx æœ‰å“ªäº›ä¼˜ç‚¹ï¼Ÿ

*   è·¨å¹³å°ã€é…ç½®ç®€å•ã€‚
*   éé˜»å¡ã€é«˜å¹¶å‘è¿æ¥ï¼šå¤„ç† 2-3 ä¸‡å¹¶å‘è¿æ¥æ•°ï¼Œå®˜æ–¹ç›‘æµ‹èƒ½æ”¯æŒ 5 ä¸‡å¹¶å‘ã€‚
*   å†…å­˜æ¶ˆè€—å°ï¼šå¼€å¯ 10 ä¸ª Nginx æ‰å  150M å†…å­˜ã€‚
*   æˆæœ¬ä½å»‰ï¼Œä¸”å¼€æºã€‚
*   ç¨³å®šæ€§é«˜ï¼Œå®•æœºçš„æ¦‚ç‡éå¸¸å°ã€‚
*   å†…ç½®çš„å¥åº·æ£€æŸ¥åŠŸèƒ½ï¼šå¦‚æœæœ‰ä¸€ä¸ªæœåŠ¡å™¨å®•æœºï¼Œä¼šåšä¸€ä¸ªå¥åº·æ£€æŸ¥ï¼Œå†å‘é€çš„è¯·æ±‚å°±ä¸ä¼šå‘é€åˆ°å®•æœºçš„æœåŠ¡å™¨äº†ã€‚é‡æ–°å°†è¯·æ±‚æäº¤åˆ°å…¶ä»–çš„èŠ‚ç‚¹ä¸Š

## Nginxåº”ç”¨åœºæ™¯ï¼Ÿ

*   httpæœåŠ¡å™¨ã€‚Nginxæ˜¯ä¸€ä¸ªhttpæœåŠ¡å¯ä»¥ç‹¬ç«‹æä¾›httpæœåŠ¡ã€‚å¯ä»¥åšç½‘é¡µé™æ€æœåŠ¡å™¨ã€‚
*   è™šæ‹Ÿä¸»æœºã€‚å¯ä»¥å®ç°åœ¨ä¸€å°æœåŠ¡å™¨è™šæ‹Ÿå‡ºå¤šä¸ªç½‘ç«™ï¼Œä¾‹å¦‚ä¸ªäººç½‘ç«™ä½¿ç”¨çš„è™šæ‹Ÿæœºã€‚
*   åå‘ä»£ç†ï¼Œè´Ÿè½½å‡è¡¡ã€‚å½“ç½‘ç«™çš„è®¿é—®é‡è¾¾åˆ°ä¸€å®šç¨‹åº¦åï¼Œå•å°æœåŠ¡å™¨ä¸èƒ½æ»¡è¶³ç”¨æˆ·çš„è¯·æ±‚æ—¶ï¼Œéœ€è¦ç”¨å¤šå°æœåŠ¡å™¨é›†ç¾¤å¯ä»¥ä½¿ç”¨nginxåšåå‘ä»£ç†ã€‚å¹¶ä¸”å¤šå°æœåŠ¡å™¨å¯ä»¥å¹³å‡åˆ†æ‹…è´Ÿè½½ï¼Œä¸ä¼šåº”ä¸ºæŸå°æœåŠ¡å™¨è´Ÿè½½é«˜å®•æœºè€ŒæŸå°æœåŠ¡å™¨é—²ç½®çš„æƒ…å†µã€‚
*   nginz ä¸­ä¹Ÿå¯ä»¥é…ç½®å®‰å…¨ç®¡ç†ã€æ¯”å¦‚å¯ä»¥ä½¿ç”¨Nginxæ­å»ºAPIæ¥å£ç½‘å…³,å¯¹æ¯ä¸ªæ¥å£æœåŠ¡è¿›è¡Œæ‹¦æˆªã€‚

## Nginxæ€ä¹ˆå¤„ç†è¯·æ±‚çš„ï¼Ÿ

```
server {         # ç¬¬ä¸€ä¸ªServeråŒºå—å¼€å§‹ï¼Œè¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿä¸»æœºç«™ç‚¹
   listen       80ï¼› # æä¾›æœåŠ¡çš„ç«¯å£ï¼Œé»˜è®¤80
   server_name  localhost; # æä¾›æœåŠ¡çš„åŸŸåä¸»æœºå
   location / { # ç¬¬ä¸€ä¸ªlocationåŒºå—å¼€å§‹
     root   html; # ç«™ç‚¹çš„æ ¹ç›®å½•ï¼Œç›¸å½“äºNginxçš„å®‰è£…ç›®å½•
     index  index.html index.html;  # é»˜è®¤çš„é¦–é¡µæ–‡ä»¶ï¼Œå¤šä¸ªç”¨ç©ºæ ¼åˆ†å¼€
} # ç¬¬ä¸€ä¸ªlocationåŒºå—ç»“æœ
```

*   é¦–å…ˆï¼ŒNginx åœ¨å¯åŠ¨æ—¶ï¼Œä¼šè§£æé…ç½®æ–‡ä»¶ï¼Œå¾—åˆ°éœ€è¦ç›‘å¬çš„ç«¯å£ä¸ IP åœ°å€ï¼Œç„¶ååœ¨ Nginx çš„ Master è¿›ç¨‹é‡Œé¢å…ˆåˆå§‹åŒ–å¥½è¿™ä¸ªç›‘æ§çš„Socket(åˆ›å»º S ocketï¼Œè®¾ç½® addrã€reuse ç­‰é€‰é¡¹ï¼Œç»‘å®šåˆ°æŒ‡å®šçš„ ip åœ°å€ç«¯å£ï¼Œå† listen ç›‘å¬)ã€‚
*   ç„¶åï¼Œå† fork(ä¸€ä¸ªç°æœ‰è¿›ç¨‹å¯ä»¥è°ƒç”¨ fork å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ã€‚ç”± fork åˆ›å»ºçš„æ–°è¿›ç¨‹è¢«ç§°ä¸ºå­è¿›ç¨‹ )å‡ºå¤šä¸ªå­è¿›ç¨‹å‡ºæ¥ã€‚
*   ä¹‹åï¼Œå­è¿›ç¨‹ä¼šç«äº‰ accept æ–°çš„è¿æ¥ã€‚æ­¤æ—¶ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥å‘ nginx å‘èµ·è¿æ¥äº†ã€‚å½“å®¢æˆ·ç«¯ä¸nginxè¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ï¼Œä¸ nginx å»ºç«‹å¥½ä¸€ä¸ªè¿æ¥åã€‚æ­¤æ—¶ï¼ŒæŸä¸€ä¸ªå­è¿›ç¨‹ä¼š accept æˆåŠŸï¼Œå¾—åˆ°è¿™ä¸ªå»ºç«‹å¥½çš„è¿æ¥çš„ Socket ï¼Œç„¶ååˆ›å»º nginx å¯¹è¿æ¥çš„å°è£…ï¼Œå³ ngx_connection_t ç»“æ„ä½“ã€‚
*   æ¥ç€ï¼Œè®¾ç½®è¯»å†™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå¹¶æ·»åŠ è¯»å†™äº‹ä»¶æ¥ä¸å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®çš„äº¤æ¢ã€‚
*   æœ€åï¼ŒNginx æˆ–å®¢æˆ·ç«¯æ¥ä¸»åŠ¨å…³æ‰è¿æ¥ï¼Œåˆ°æ­¤ï¼Œä¸€ä¸ªè¿æ¥å°±å¯¿ç»ˆæ­£å¯äº†ã€‚

## Nginx æ˜¯å¦‚ä½•å®ç°é«˜å¹¶å‘çš„ï¼Ÿ

å¦‚æœä¸€ä¸ª server é‡‡ç”¨ä¸€ä¸ªè¿›ç¨‹(æˆ–è€…çº¿ç¨‹)è´Ÿè´£ä¸€ä¸ªrequestçš„æ–¹å¼ï¼Œé‚£ä¹ˆè¿›ç¨‹æ•°å°±æ˜¯å¹¶å‘æ•°ã€‚é‚£ä¹ˆæ˜¾è€Œæ˜“è§çš„ï¼Œå°±æ˜¯ä¼šæœ‰å¾ˆå¤šè¿›ç¨‹åœ¨ç­‰å¾…ä¸­ã€‚ç­‰ä»€ä¹ˆï¼Ÿæœ€å¤šçš„åº”è¯¥æ˜¯ç­‰å¾…ç½‘ç»œä¼ è¾“ã€‚

è€Œ Nginx çš„å¼‚æ­¥éé˜»å¡å·¥ä½œæ–¹å¼æ­£æ˜¯åˆ©ç”¨äº†è¿™ç‚¹ç­‰å¾…çš„æ—¶é—´ã€‚åœ¨éœ€è¦ç­‰å¾…çš„æ—¶å€™ï¼Œè¿™äº›è¿›ç¨‹å°±ç©ºé—²å‡ºæ¥å¾…å‘½äº†ã€‚å› æ­¤è¡¨ç°ä¸ºå°‘æ•°å‡ ä¸ªè¿›ç¨‹å°±è§£å†³äº†å¤§é‡çš„å¹¶å‘é—®é¢˜ã€‚

Nginxæ˜¯å¦‚ä½•åˆ©ç”¨çš„å‘¢ï¼Œç®€å•æ¥è¯´ï¼šåŒæ ·çš„ 4 ä¸ªè¿›ç¨‹ï¼Œå¦‚æœé‡‡ç”¨ä¸€ä¸ªè¿›ç¨‹è´Ÿè´£ä¸€ä¸ª request çš„æ–¹å¼ï¼Œé‚£ä¹ˆï¼ŒåŒæ—¶è¿›æ¥ 4 ä¸ª request ä¹‹åï¼Œæ¯ä¸ªè¿›ç¨‹å°±è´Ÿè´£å…¶ä¸­ä¸€ä¸ªï¼Œç›´è‡³ä¼šè¯å…³é—­ã€‚æœŸé—´ï¼Œå¦‚æœæœ‰ç¬¬ 5 ä¸ªrequestè¿›æ¥äº†ã€‚å°±æ— æ³•åŠæ—¶ååº”äº†ï¼Œå› ä¸º 4 ä¸ªè¿›ç¨‹éƒ½æ²¡å¹²å®Œæ´»å‘¢ï¼Œå› æ­¤ï¼Œä¸€èˆ¬æœ‰ä¸ªè°ƒåº¦è¿›ç¨‹ï¼Œæ¯å½“æ–°è¿›æ¥äº†ä¸€ä¸ª request ï¼Œå°±æ–°å¼€ä¸ªè¿›ç¨‹æ¥å¤„ç†ã€‚

**å›æƒ³ä¸‹ï¼ŒBIO æ˜¯ä¸æ˜¯å­˜åœ¨é…±ç´«çš„é—®é¢˜ï¼Ÿ**

Nginx ä¸è¿™æ ·ï¼Œæ¯è¿›æ¥ä¸€ä¸ª request ï¼Œä¼šæœ‰ä¸€ä¸ª worker è¿›ç¨‹å»å¤„ç†ã€‚ä½†ä¸æ˜¯å…¨ç¨‹çš„å¤„ç†ï¼Œå¤„ç†åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿå¤„ç†åˆ°å¯èƒ½å‘ç”Ÿé˜»å¡çš„åœ°æ–¹ï¼Œæ¯”å¦‚å‘ä¸Šæ¸¸ï¼ˆåç«¯ï¼‰æœåŠ¡å™¨è½¬å‘ request ï¼Œå¹¶ç­‰å¾…è¯·æ±‚è¿”å›ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªå¤„ç†çš„ worker ä¸ä¼šè¿™ä¹ˆå‚»ç­‰ç€ï¼Œä»–ä¼šåœ¨å‘é€å®Œè¯·æ±‚åï¼Œæ³¨å†Œä¸€ä¸ªäº‹ä»¶ï¼šâ€œå¦‚æœ upstream è¿”å›äº†ï¼Œå‘Šè¯‰æˆ‘ä¸€å£°ï¼Œæˆ‘å†æ¥ç€å¹²â€ã€‚äºæ˜¯ä»–å°±ä¼‘æ¯å»äº†ã€‚æ­¤æ—¶ï¼Œå¦‚æœå†æœ‰ request è¿›æ¥ï¼Œä»–å°±å¯ä»¥å¾ˆå¿«å†æŒ‰è¿™ç§æ–¹å¼å¤„ç†ã€‚è€Œä¸€æ—¦ä¸Šæ¸¸æœåŠ¡å™¨è¿”å›äº†ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ï¼Œworker æ‰ä¼šæ¥æ¥æ‰‹ï¼Œè¿™ä¸ª request æ‰ä¼šæ¥ç€å¾€ä¸‹èµ°ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ï¼ŒNginx åŸºäºäº‹ä»¶æ¨¡å‹ã€‚

ç”±äº web server çš„å·¥ä½œæ€§è´¨å†³å®šäº†æ¯ä¸ª request çš„å¤§éƒ¨ä»½ç”Ÿå‘½éƒ½æ˜¯åœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œå®é™…ä¸ŠèŠ±è´¹åœ¨ server æœºå™¨ä¸Šçš„æ—¶é—´ç‰‡ä¸å¤šã€‚è¿™æ˜¯å‡ ä¸ªè¿›ç¨‹å°±è§£å†³é«˜å¹¶å‘çš„ç§˜å¯†æ‰€åœ¨ã€‚å³ï¼š

webserver åˆšå¥½å±äºç½‘ç»œ IO å¯†é›†å‹åº”ç”¨ï¼Œä¸ç®—æ˜¯è®¡ç®—å¯†é›†å‹ã€‚

å¼‚æ­¥ï¼Œéé˜»å¡ï¼Œä½¿ç”¨ epoll ï¼Œå’Œå¤§é‡ç»†èŠ‚å¤„çš„ä¼˜åŒ–ã€‚ä¹Ÿæ­£æ˜¯ Nginx ä¹‹æ‰€ä»¥ç„¶çš„æŠ€æœ¯åŸºçŸ³ã€‚

## ä»€ä¹ˆæ˜¯æ­£å‘ä»£ç†ï¼Ÿ

ä¸€ä¸ªä½äºå®¢æˆ·ç«¯å’ŒåŸå§‹æœåŠ¡å™¨(origin server)ä¹‹é—´çš„æœåŠ¡å™¨ï¼Œä¸ºäº†ä»åŸå§‹æœåŠ¡å™¨å–å¾—å†…å®¹ï¼Œå®¢æˆ·ç«¯å‘ä»£ç†å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æŒ‡å®šç›®æ ‡(åŸå§‹æœåŠ¡å™¨)ï¼Œç„¶åä»£ç†å‘åŸå§‹æœåŠ¡å™¨è½¬äº¤è¯·æ±‚å¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

å®¢æˆ·ç«¯æ‰èƒ½ä½¿ç”¨æ­£å‘ä»£ç†ã€‚æ­£å‘ä»£ç†æ€»ç»“å°±ä¸€å¥è¯ï¼šä»£ç†ç«¯ä»£ç†çš„æ˜¯å®¢æˆ·ç«¯ã€‚ä¾‹å¦‚è¯´ï¼šæˆ‘ä»¬ä½¿ç”¨çš„OpenVPN ç­‰ç­‰ã€‚

## ä»€ä¹ˆæ˜¯åå‘ä»£ç†ï¼Ÿ

åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰æ–¹å¼ï¼Œæ˜¯æŒ‡ä»¥ä»£ç†æœåŠ¡å™¨æ¥æ¥å— Internetä¸Šçš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚ï¼Œå‘ç»™å†…éƒ¨ç½‘ç»œä¸Šçš„æœåŠ¡å™¨å¹¶å°†ä»æœåŠ¡å™¨ä¸Šå¾—åˆ°çš„ç»“æœè¿”å›ç»™ Internet ä¸Šè¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ä»£ç†æœåŠ¡å™¨å¯¹å¤–å°±è¡¨ç°ä¸ºä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ã€‚

> åå‘ä»£ç†æ€»ç»“å°±ä¸€å¥è¯ï¼šä»£ç†ç«¯ä»£ç†çš„æ˜¯æœåŠ¡ç«¯ã€‚

## åå‘ä»£ç†æœåŠ¡å™¨çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆ?

åå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥éšè—æºæœåŠ¡å™¨çš„å­˜åœ¨å’Œç‰¹å¾ã€‚å®ƒå……å½“äº’è”ç½‘äº‘å’ŒwebæœåŠ¡å™¨ä¹‹é—´çš„ä¸­é—´å±‚ã€‚è¿™å¯¹äºå®‰å…¨æ–¹é¢æ¥è¯´æ˜¯å¾ˆå¥½çš„ï¼Œç‰¹åˆ«æ˜¯å½“æ‚¨ä½¿ç”¨webæ‰˜ç®¡æœåŠ¡æ—¶ã€‚

## Nginxç›®å½•ç»“æ„æœ‰å“ªäº›ï¼Ÿ

```Â 
treeÂ /usr/local/nginx
/usr/local/nginx
â”œâ”€â”€Â client_body_temp
â”œâ”€â”€Â confÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â Nginxæ‰€æœ‰é…ç½®æ–‡ä»¶çš„ç›®å½•
â”‚Â Â Â â”œâ”€â”€Â fastcgi.confÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â fastcgiç›¸å…³å‚æ•°çš„é…ç½®æ–‡ä»¶
â”‚Â Â Â â”œâ”€â”€Â fastcgi.conf.defaultÂ Â Â Â Â Â Â Â Â #Â fastcgi.confçš„åŸå§‹å¤‡ä»½æ–‡ä»¶
â”‚Â Â Â â”œâ”€â”€Â fastcgi_paramsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â fastcgiçš„å‚æ•°æ–‡ä»¶
â”‚Â Â Â â”œâ”€â”€Â fastcgi_params.defaultÂ Â Â Â Â Â Â 
â”‚Â Â Â â”œâ”€â”€Â koi-utf
â”‚Â Â Â â”œâ”€â”€Â koi-win
â”‚Â Â Â â”œâ”€â”€Â mime.typesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â åª’ä½“ç±»å‹
â”‚Â Â Â â”œâ”€â”€Â mime.types.default
â”‚Â Â Â â”œâ”€â”€Â nginx.confÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â Nginxä¸»é…ç½®æ–‡ä»¶
â”‚Â Â Â â”œâ”€â”€Â nginx.conf.default
â”‚Â Â Â â”œâ”€â”€Â scgi_paramsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â scgiç›¸å…³å‚æ•°æ–‡ä»¶
â”‚Â Â Â â”œâ”€â”€Â scgi_params.defaultÂ Â 
â”‚Â Â Â â”œâ”€â”€Â uwsgi_paramsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â uwsgiç›¸å…³å‚æ•°æ–‡ä»¶
â”‚Â Â Â â”œâ”€â”€Â uwsgi_params.default
â”‚Â Â Â â””â”€â”€Â win-utf
â”œâ”€â”€Â fastcgi_tempÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â fastcgiä¸´æ—¶æ•°æ®ç›®å½•
â”œâ”€â”€Â htmlÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â Nginxé»˜è®¤ç«™ç‚¹ç›®å½•
â”‚Â Â Â â”œâ”€â”€Â 50x.htmlÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â é”™è¯¯é¡µé¢ä¼˜é›…æ›¿ä»£æ˜¾ç¤ºæ–‡ä»¶ï¼Œä¾‹å¦‚å½“å‡ºç°502é”™è¯¯æ—¶ä¼šè°ƒç”¨æ­¤é¡µé¢
â”‚Â Â Â â””â”€â”€Â index.htmlÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â é»˜è®¤çš„é¦–é¡µæ–‡ä»¶
â”œâ”€â”€Â logsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â Nginxæ—¥å¿—ç›®å½•
â”‚Â Â Â â”œâ”€â”€Â access.logÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â è®¿é—®æ—¥å¿—æ–‡ä»¶
â”‚Â Â Â â”œâ”€â”€Â error.logÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â é”™è¯¯æ—¥å¿—æ–‡ä»¶
â”‚Â Â Â â””â”€â”€Â nginx.pidÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â pidæ–‡ä»¶ï¼ŒNginxè¿›ç¨‹å¯åŠ¨åï¼Œä¼šæŠŠæ‰€æœ‰è¿›ç¨‹çš„IDå·å†™åˆ°æ­¤æ–‡ä»¶
â”œâ”€â”€Â proxy_tempÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â ä¸´æ—¶ç›®å½•
â”œâ”€â”€Â sbinÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â Nginxå‘½ä»¤ç›®å½•
â”‚Â Â Â â””â”€â”€Â nginxÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â Nginxçš„å¯åŠ¨å‘½ä»¤
â”œâ”€â”€Â scgi_tempÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â ä¸´æ—¶ç›®å½•
â””â”€â”€Â uwsgi_tempÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â ä¸´æ—¶ç›®å½•
```

## Nginxé…ç½®æ–‡ä»¶nginx.confæœ‰å“ªäº›å±æ€§æ¨¡å—?

```
worker_processes  1ï¼›                                    # workerè¿›ç¨‹çš„æ•°é‡
events {                                                  # äº‹ä»¶åŒºå—å¼€å§‹
    worker_connections  1024ï¼›                            # æ¯ä¸ªworkerè¿›ç¨‹æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°
}                                                        # äº‹ä»¶åŒºå—ç»“æŸ
http {                                                   # HTTPåŒºå—å¼€å§‹
    include       mime.typesï¼›                            # Nginxæ”¯æŒçš„åª’ä½“ç±»å‹åº“æ–‡ä»¶
    default_type  application/octet-streamï¼›             # é»˜è®¤çš„åª’ä½“ç±»å‹
    sendfile        onï¼›                                   # å¼€å¯é«˜æ•ˆä¼ è¾“æ¨¡å¼
    keepalive_timeout  65ï¼›                               # è¿æ¥è¶…æ—¶
    server {                                            # ç¬¬ä¸€ä¸ªServeråŒºå—å¼€å§‹ï¼Œè¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿä¸»æœºç«™ç‚¹
        listen       80ï¼›                                  # æä¾›æœåŠ¡çš„ç«¯å£ï¼Œé»˜è®¤80
        server_name  localhostï¼›                           # æä¾›æœåŠ¡çš„åŸŸåä¸»æœºå
        location / {                                    # ç¬¬ä¸€ä¸ªlocationåŒºå—å¼€å§‹
            root   htmlï¼›                               # ç«™ç‚¹çš„æ ¹ç›®å½•ï¼Œç›¸å½“äºNginxçš„å®‰è£…ç›®å½•
            index  index.html index.htmï¼›                  # é»˜è®¤çš„é¦–é¡µæ–‡ä»¶ï¼Œå¤šä¸ªç”¨ç©ºæ ¼åˆ†å¼€
        }                                                  # ç¬¬ä¸€ä¸ªlocationåŒºå—ç»“æœ
        error_page   500502503504  /50x.htmlï¼›             # å‡ºç°å¯¹åº”çš„httpçŠ¶æ€ç æ—¶ï¼Œä½¿ç”¨50x.htmlå›åº”å®¢æˆ·
        location = /50x.html {                          # locationåŒºå—å¼€å§‹ï¼Œè®¿é—®50x.html
            root   htmlï¼›                                  # æŒ‡å®šå¯¹åº”çš„ç«™ç‚¹ç›®å½•ä¸ºhtml
        }
    }  
    ......
```

## cookieå’ŒsessionåŒºåˆ«ï¼Ÿ

#### å…±åŒï¼š

å­˜æ”¾ç”¨æˆ·ä¿¡æ¯ã€‚å­˜æ”¾çš„å½¢å¼ï¼škey-valueæ ¼å¼ å˜é‡å’Œå˜é‡å†…å®¹é”®å€¼å¯¹ã€‚

#### åŒºåˆ«ï¼š

cookie

*   å­˜æ”¾åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨
*   æ¯ä¸ªåŸŸåå¯¹åº”ä¸€ä¸ªcookieï¼Œä¸èƒ½è·¨è·ƒåŸŸåè®¿é—®å…¶ä»–cookie
*   ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æˆ–ä¿®æ”¹cookie
*   httpå“åº”æŠ¥æ–‡é‡Œé¢ç»™ä½ æµè§ˆå™¨è®¾ç½®
*   é’¥åŒ™ï¼ˆç”¨äºæ‰“å¼€æµè§ˆå™¨ä¸Šé”å¤´ï¼‰

session:

*   å­˜æ”¾åœ¨æœåŠ¡å™¨ï¼ˆæ–‡ä»¶ï¼Œæ•°æ®åº“ï¼Œredisï¼‰
*   å­˜æ”¾æ•æ„Ÿä¿¡æ¯
*   é”å¤´

## ä¸ºä»€ä¹ˆ Nginx ä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ

**Apache:**Â åˆ›å»ºå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ï¼Œè€Œæ¯ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹éƒ½ä¼šä¸ºå…¶åˆ†é… cpu å’Œå†…å­˜ï¼ˆçº¿ç¨‹è¦æ¯”è¿›ç¨‹å°çš„å¤šï¼Œæ‰€ä»¥ worker æ”¯æŒæ¯” perfork é«˜çš„å¹¶å‘ï¼‰ï¼Œå¹¶å‘è¿‡å¤§ä¼šæ¦¨å¹²æœåŠ¡å™¨èµ„æºã€‚

**Nginx:**Â é‡‡ç”¨å•çº¿ç¨‹æ¥å¼‚æ­¥éé˜»å¡å¤„ç†è¯·æ±‚ï¼ˆç®¡ç†å‘˜å¯ä»¥é…ç½® Nginx ä¸»è¿›ç¨‹çš„å·¥ä½œè¿›ç¨‹çš„æ•°é‡ï¼‰(epoll)ï¼Œä¸ä¼šä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é… cpu å’Œå†…å­˜èµ„æºï¼ŒèŠ‚çœäº†å¤§é‡èµ„æºï¼ŒåŒæ—¶ä¹Ÿå‡å°‘äº†å¤§é‡çš„ CPU çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ‰€ä»¥æ‰ä½¿å¾— Nginx æ”¯æŒæ›´é«˜çš„å¹¶å‘ã€‚

## nginxå’Œapacheçš„åŒºåˆ«

è½»é‡çº§ï¼ŒåŒæ ·èµ·webæœåŠ¡ï¼Œæ¯”apacheå ç”¨æ›´å°‘çš„å†…å­˜å’Œèµ„æºã€‚

æŠ—å¹¶å‘ï¼Œnginxå¤„ç†è¯·æ±‚æ˜¯å¼‚æ­¥éé˜»å¡çš„ï¼Œè€Œapacheåˆ™æ˜¯é˜»å¡æ€§çš„ï¼Œåœ¨é«˜å¹¶å‘ä¸‹nginxèƒ½ä¿æŒä½èµ„æºï¼Œä½æ¶ˆè€—é«˜æ€§èƒ½ã€‚

é«˜åº¦æ¨¡å—åŒ–çš„è®¾è®¡ï¼Œç¼–å†™æ¨¡å—ç›¸å¯¹ç®€å•ã€‚

æœ€æ ¸å¿ƒçš„åŒºåˆ«åœ¨äºapacheæ˜¯åŒæ­¥å¤šè¿›ç¨‹æ¨¡å‹ï¼Œä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ï¼Œnginxæ˜¯å¼‚æ­¥çš„ï¼Œå¤šä¸ªè¿æ¥å¯ä»¥å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nginx/40-interview-8cd652f4-5a93-4e12-a020-0d90b9379bf2.png)


## ä»€ä¹ˆæ˜¯åŠ¨æ€èµ„æºã€é™æ€èµ„æºåˆ†ç¦»ï¼Ÿ

åŠ¨æ€èµ„æºã€é™æ€èµ„æºåˆ†ç¦»ï¼Œæ˜¯è®©åŠ¨æ€ç½‘ç«™é‡Œçš„åŠ¨æ€ç½‘é¡µæ ¹æ®ä¸€å®šè§„åˆ™æŠŠä¸å˜çš„èµ„æºå’Œç»å¸¸å˜çš„èµ„æºåŒºåˆ†å¼€æ¥ï¼ŒåŠ¨é™èµ„æºåšå¥½äº†æ‹†åˆ†ä»¥åæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®é™æ€èµ„æºçš„ç‰¹ç‚¹å°†å…¶åšç¼“å­˜æ“ä½œï¼Œè¿™å°±æ˜¯ç½‘ç«™é™æ€åŒ–å¤„ç†çš„æ ¸å¿ƒæ€è·¯ã€‚

åŠ¨æ€èµ„æºã€é™æ€èµ„æºåˆ†ç¦»ç®€å•çš„æ¦‚æ‹¬æ˜¯ï¼šåŠ¨æ€æ–‡ä»¶ä¸é™æ€æ–‡ä»¶çš„åˆ†ç¦»ã€‚

## ä¸ºä»€ä¹ˆè¦åšåŠ¨ã€é™åˆ†ç¦»ï¼Ÿ

åœ¨æˆ‘ä»¬çš„è½¯ä»¶å¼€å‘ä¸­ï¼Œæœ‰äº›è¯·æ±‚æ˜¯éœ€è¦åå°å¤„ç†çš„ï¼ˆå¦‚ï¼š.jsp,.do ç­‰ç­‰ï¼‰ï¼Œæœ‰äº›è¯·æ±‚æ˜¯ä¸éœ€è¦ç»è¿‡åå°å¤„ç†çš„ï¼ˆå¦‚ï¼šcssã€htmlã€jpgã€js ç­‰ç­‰æ–‡ä»¶ï¼‰ï¼Œè¿™äº›ä¸éœ€è¦ç»è¿‡åå°å¤„ç†çš„æ–‡ä»¶ç§°ä¸ºé™æ€æ–‡ä»¶ï¼Œå¦åˆ™åŠ¨æ€æ–‡ä»¶ã€‚

å› æ­¤æˆ‘ä»¬åå°å¤„ç†å¿½ç•¥é™æ€æ–‡ä»¶ã€‚è¿™ä¼šæœ‰äººåˆè¯´é‚£æˆ‘åå°å¿½ç•¥é™æ€æ–‡ä»¶ä¸å°±å®Œäº†å—ï¼Ÿå½“ç„¶è¿™æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™æ ·åå°çš„è¯·æ±‚æ¬¡æ•°å°±æ˜æ˜¾å¢å¤šäº†ã€‚åœ¨æˆ‘ä»¬å¯¹èµ„æºçš„å“åº”é€Ÿåº¦æœ‰è¦æ±‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨è¿™ç§åŠ¨é™åˆ†ç¦»çš„ç­–ç•¥å»è§£å†³åŠ¨ã€é™åˆ†ç¦»å°†ç½‘ç«™é™æ€èµ„æºï¼ˆHTMLï¼ŒJavaScriptï¼ŒCSSï¼Œimgç­‰æ–‡ä»¶ï¼‰ä¸åå°åº”ç”¨åˆ†å¼€éƒ¨ç½²ï¼Œæé«˜ç”¨æˆ·è®¿é—®é™æ€ä»£ç çš„é€Ÿåº¦ï¼Œé™ä½å¯¹åå°åº”ç”¨è®¿é—®

è¿™é‡Œæˆ‘ä»¬å°†é™æ€èµ„æºæ”¾åˆ° Nginx ä¸­ï¼ŒåŠ¨æ€èµ„æºè½¬å‘åˆ° Tomcat æœåŠ¡å™¨ä¸­å»ã€‚

å½“ç„¶ï¼Œå› ä¸ºç°åœ¨ä¸ƒç‰›ã€é˜¿é‡Œäº‘ç­‰ CDN æœåŠ¡å·²ç»å¾ˆæˆç†Ÿï¼Œä¸»æµçš„åšæ³•ï¼Œæ˜¯æŠŠé™æ€èµ„æºç¼“å­˜åˆ° CDN æœåŠ¡ä¸­ï¼Œä»è€Œæå‡è®¿é—®é€Ÿåº¦ã€‚

ç›¸æ¯”æœ¬åœ°çš„ Nginx æ¥è¯´ï¼ŒCDN æœåŠ¡å™¨ç”±äºåœ¨å›½å†…æœ‰æ›´å¤šçš„èŠ‚ç‚¹ï¼Œå¯ä»¥å®ç°ç”¨æˆ·çš„å°±è¿‘è®¿é—®ã€‚å¹¶ä¸”ï¼ŒCDN æœåŠ¡å¯ä»¥æä¾›æ›´å¤§çš„å¸¦å®½ï¼Œä¸åƒæˆ‘ä»¬è‡ªå·±çš„åº”ç”¨æœåŠ¡ï¼Œæä¾›çš„å¸¦å®½æ˜¯æœ‰é™çš„ã€‚

## ä»€ä¹ˆå« CDN æœåŠ¡ï¼Ÿ

CDN ï¼Œå³å†…å®¹åˆ†å‘ç½‘ç»œã€‚

å…¶ç›®çš„æ˜¯ï¼Œé€šè¿‡åœ¨ç°æœ‰çš„ Internetä¸­ å¢åŠ ä¸€å±‚æ–°çš„ç½‘ç»œæ¶æ„ï¼Œå°†ç½‘ç«™çš„å†…å®¹å‘å¸ƒåˆ°æœ€æ¥è¿‘ç”¨æˆ·çš„ç½‘ç»œè¾¹ç¼˜ï¼Œä½¿ç”¨æˆ·å¯å°±è¿‘å–å¾—æ‰€éœ€çš„å†…å®¹ï¼Œæé«˜ç”¨æˆ·è®¿é—®ç½‘ç«™çš„é€Ÿåº¦ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œå› ä¸ºç°åœ¨ CDN æœåŠ¡æ¯”è¾ƒå¤§ä¼—ï¼Œæ‰€ä»¥åŸºæœ¬æ‰€æœ‰å…¬å¸éƒ½ä¼šä½¿ç”¨ CDN æœåŠ¡ã€‚

## Nginxæ€ä¹ˆåšçš„åŠ¨é™åˆ†ç¦»ï¼Ÿ

åªéœ€è¦æŒ‡å®šè·¯å¾„å¯¹åº”çš„ç›®å½•ã€‚location/å¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚å¹¶æŒ‡å®šå¯¹åº”çš„ç¡¬ç›˜ä¸­çš„ç›®å½•ã€‚å¦‚ä¸‹ï¼šï¼ˆæ“ä½œéƒ½æ˜¯åœ¨Linuxä¸Šï¼‰

```
location /image/ {
    root   /usr/local/static/;
    autoindex on;
}
```

æ­¥éª¤ï¼š

```
# åˆ›å»ºç›®å½•
mkdir /usr/local/static/image
 
# è¿›å…¥ç›®å½•
cd  /usr/local/static/image
 
# ä¸Šä¼ ç…§ç‰‡
photo.jpg
 
# é‡å¯nginx
sudo nginx -s reload
```

æ‰“å¼€æµè§ˆå™¨ è¾“å…¥Â `server_name/image/1.jpg`Â å°±å¯ä»¥è®¿é—®è¯¥é™æ€å›¾ç‰‡äº†

## Nginxè´Ÿè½½å‡è¡¡çš„ç®—æ³•æ€ä¹ˆå®ç°çš„?ç­–ç•¥æœ‰å“ªäº›?

ä¸ºäº†é¿å…æœåŠ¡å™¨å´©æºƒï¼Œå¤§å®¶ä¼šé€šè¿‡è´Ÿè½½å‡è¡¡çš„æ–¹å¼æ¥åˆ†æ‹…æœåŠ¡å™¨å‹åŠ›ã€‚å°†å¯¹å°æœåŠ¡å™¨ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œå½“ç”¨æˆ·è®¿é—®æ—¶ï¼Œå…ˆè®¿é—®åˆ°ä¸€ä¸ªè½¬å‘æœåŠ¡å™¨ï¼Œå†ç”±è½¬å‘æœåŠ¡å™¨å°†è®¿é—®åˆ†å‘åˆ°å‹åŠ›æ›´å°çš„æœåŠ¡å™¨ã€‚

Nginxè´Ÿè½½å‡è¡¡å®ç°çš„ç­–ç•¥æœ‰ä»¥ä¸‹äº”ç§ï¼š

#### 1 .è½®è¯¢(é»˜è®¤)

æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æŸä¸ªæœåŠ¡å™¨å®•æœºï¼Œèƒ½è‡ªåŠ¨å‰”é™¤æ•…éšœç³»ç»Ÿã€‚

```
upstream backserver { 
 server 192.168.0.12; 
 server 192.168.0.13; 
} 
```

#### 2\. æƒé‡ weight

weightçš„å€¼è¶Šå¤§ï¼Œåˆ†é…åˆ°çš„è®¿é—®æ¦‚ç‡è¶Šé«˜ï¼Œä¸»è¦ç”¨äºåç«¯æ¯å°æœåŠ¡å™¨æ€§èƒ½ä¸å‡è¡¡çš„æƒ…å†µä¸‹ã€‚å…¶æ¬¡æ˜¯ä¸ºåœ¨ä¸»ä»çš„æƒ…å†µä¸‹è®¾ç½®ä¸åŒçš„æƒå€¼ï¼Œè¾¾åˆ°åˆç†æœ‰æ•ˆçš„åœ°åˆ©ç”¨ä¸»æœºèµ„æºã€‚

```
# æƒé‡è¶Šé«˜ï¼Œåœ¨è¢«è®¿é—®çš„æ¦‚ç‡è¶Šå¤§ï¼Œå¦‚ä¸Šä¾‹ï¼Œåˆ†åˆ«æ˜¯20%ï¼Œ80%ã€‚
upstream backserver { 
 server 192.168.0.12 weight=2; 
 server 192.168.0.13 weight=8; 
} 
```

#### 3\. ip_hash( IPç»‘å®š)

æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®IPçš„å“ˆå¸Œç»“æœåˆ†é…ï¼Œä½¿æ¥è‡ªåŒä¸€ä¸ªIPçš„è®¿å®¢å›ºå®šè®¿é—®ä¸€å°åç«¯æœåŠ¡å™¨ï¼Œå¹¶ä¸”å¯ä»¥æœ‰æ•ˆè§£å†³åŠ¨æ€ç½‘é¡µå­˜åœ¨çš„sessionå…±äº«é—®é¢˜

```
upstream backserver { 
 ip_hash; 
 server 192.168.0.12:88; 
 server 192.168.0.13:80; 
} 
```

#### 4\. fair(ç¬¬ä¸‰æ–¹æ’ä»¶)

å¿…é¡»å®‰è£…upstream_fairæ¨¡å—ã€‚

å¯¹æ¯” weightã€ip_hashæ›´åŠ æ™ºèƒ½çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œfairç®—æ³•å¯ä»¥æ ¹æ®é¡µé¢å¤§å°å’ŒåŠ è½½æ—¶é—´é•¿çŸ­æ™ºèƒ½åœ°è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚

```
# å“ªä¸ªæœåŠ¡å™¨çš„å“åº”é€Ÿåº¦å¿«ï¼Œå°±å°†è¯·æ±‚åˆ†é…åˆ°é‚£ä¸ªæœåŠ¡å™¨ä¸Šã€‚
upstream backserver { 
 server server1; 
 server server2; 
 fair; 
} 
```

#### 5.url_hash(ç¬¬ä¸‰æ–¹æ’ä»¶)

å¿…é¡»å®‰è£…Nginxçš„hashè½¯ä»¶åŒ…

æŒ‰è®¿é—®urlçš„hashç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œä½¿æ¯ä¸ªurlå®šå‘åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è¿›ä¸€æ­¥æé«˜åç«¯ç¼“å­˜æœåŠ¡å™¨çš„æ•ˆç‡ã€‚

```
upstreamÂ backserverÂ {Â 
Â serverÂ squid1:3128;Â 
Â serverÂ squid2:3128;Â 
Â hashÂ $request_uri;Â 
Â hash_methodÂ crc32;Â 
}
```

## å¦‚ä½•ç”¨Nginxè§£å†³å‰ç«¯è·¨åŸŸé—®é¢˜ï¼Ÿ

ä½¿ç”¨Nginxè½¬å‘è¯·æ±‚ã€‚æŠŠè·¨åŸŸçš„æ¥å£å†™æˆè°ƒæœ¬åŸŸçš„æ¥å£ï¼Œç„¶åå°†è¿™äº›æ¥å£è½¬å‘åˆ°çœŸæ­£çš„è¯·æ±‚åœ°å€ã€‚

## Nginxè™šæ‹Ÿä¸»æœºæ€ä¹ˆé…ç½®?

1ã€åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœºï¼Œé€šè¿‡åŸŸåæ¥åŒºåˆ†è™šæ‹Ÿä¸»æœºâ€”â€”åº”ç”¨ï¼šå¤–éƒ¨ç½‘ç«™

2ã€åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœºï¼Œé€šè¿‡ç«¯å£æ¥åŒºåˆ†è™šæ‹Ÿä¸»æœºâ€”â€”åº”ç”¨ï¼šå…¬å¸å†…éƒ¨ç½‘ç«™ï¼Œå¤–éƒ¨ç½‘ç«™çš„ç®¡ç†åå°

3ã€åŸºäºipçš„è™šæ‹Ÿä¸»æœºã€‚

#### åŸºäºè™šæ‹Ÿä¸»æœºé…ç½®åŸŸå

éœ€è¦å»ºç«‹`/data/www /data/bbs`ç›®å½•ï¼Œwindowsæœ¬åœ°hostsæ·»åŠ è™šæ‹Ÿæœºipåœ°å€å¯¹åº”çš„åŸŸåè§£æï¼›å¯¹åº”åŸŸåç½‘ç«™ç›®å½•ä¸‹æ–°å¢index.htmlæ–‡ä»¶ï¼›

```
# å½“å®¢æˆ·ç«¯è®¿é—®www.lijie.com,ç›‘å¬ç«¯å£å·ä¸º80,ç›´æ¥è·³è½¬åˆ°data/wwwç›®å½•ä¸‹æ–‡ä»¶
server {
    listen       80;
    server_name  www.lijie.com;
    location / {
        root   data/www;
        index  index.html index.htm;
    }
}

# å½“å®¢æˆ·ç«¯è®¿é—®bbs.lijie.com,ç›‘å¬ç«¯å£å·ä¸º80,ç›´æ¥è·³è½¬åˆ°data/bbsç›®å½•ä¸‹æ–‡ä»¶
 server {
    listen       80;
    server_name  bbs.lijie.com;
    location / {
        root   data/bbs;
        index  index.html index.htm;
    }
}
```

#### åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº

ä½¿ç”¨ç«¯å£æ¥åŒºåˆ†ï¼Œæµè§ˆå™¨ä½¿ç”¨åŸŸåæˆ–ipåœ°å€:ç«¯å£å· è®¿é—®

```
# å½“å®¢æˆ·ç«¯è®¿é—®www.lijie.com,ç›‘å¬ç«¯å£å·ä¸º8080,ç›´æ¥è·³è½¬åˆ°data/wwwç›®å½•ä¸‹æ–‡ä»¶
 server {
    listen       8080;
    server_name  www.lijie.com;
    location / {
        root   data/www;
        index  index.html index.htm;
    }
}

# å½“å®¢æˆ·ç«¯è®¿é—®www.lijie.com,ç›‘å¬ç«¯å£å·ä¸º80ç›´æ¥è·³è½¬åˆ°çœŸå®ipæœåŠ¡å™¨åœ°å€ 127.0.0.1:8080
server {
    listen       80;
    server_name  www.lijie.com;
    location / {
         proxy_pass http://127.0.0.1:8080;
        index  index.html index.htm;
    }
}
```

## locationçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

locationæŒ‡ä»¤çš„ä½œç”¨æ˜¯æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„URIæ¥æ‰§è¡Œä¸åŒçš„åº”ç”¨ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„ç½‘ç«™URLè¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸå³è¿›è¡Œç›¸å…³çš„æ“ä½œã€‚

locationçš„è¯­æ³•èƒ½è¯´å‡ºæ¥å—ï¼Ÿ

> æ³¨æ„ï¼š~ ä»£è¡¨è‡ªå·±è¾“å…¥çš„è‹±æ–‡å­—æ¯

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nginx/40-interview-8b8c7eeb-5542-43ab-9acc-3c7e51b5a4ac.png)


#### Locationæ­£åˆ™æ¡ˆä¾‹

```
# ä¼˜å…ˆçº§1,ç²¾ç¡®åŒ¹é…ï¼Œæ ¹è·¯å¾„
location =/ {
    return 400;
}

# ä¼˜å…ˆçº§2,ä»¥æŸä¸ªå­—ç¬¦ä¸²å¼€å¤´,ä»¥avå¼€å¤´çš„ï¼Œä¼˜å…ˆåŒ¹é…è¿™é‡Œï¼ŒåŒºåˆ†å¤§å°å†™
location ^~ /av {
   root /data/av/;
}

# ä¼˜å…ˆçº§3ï¼ŒåŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…ï¼ŒåŒ¹é…/media*****è·¯å¾„
location ~ /media {
      alias /data/static/;
}

# ä¼˜å…ˆçº§4 ï¼Œä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…ï¼Œæ‰€æœ‰çš„****.jpg|gif|png éƒ½èµ°è¿™é‡Œ
location ~* .*\.(jpg|gif|png|js|css)$ {
   root  /data/av/;
}

# ä¼˜å…ˆ7ï¼Œé€šç”¨åŒ¹é…
location / {
    return 403;
}
```

## é™æµæ€ä¹ˆåšçš„ï¼Ÿ

Nginxé™æµå°±æ˜¯é™åˆ¶ç”¨æˆ·è¯·æ±‚é€Ÿåº¦ï¼Œé˜²æ­¢æœåŠ¡å™¨å—ä¸äº†

é™æµæœ‰3ç§

*   æ­£å¸¸é™åˆ¶è®¿é—®é¢‘ç‡ï¼ˆæ­£å¸¸æµé‡ï¼‰
*   çªå‘é™åˆ¶è®¿é—®é¢‘ç‡ï¼ˆçªå‘æµé‡ï¼‰
*   é™åˆ¶å¹¶å‘è¿æ¥æ•°

Nginxçš„é™æµéƒ½æ˜¯åŸºäºæ¼æ¡¶æµç®—æ³•

> å®ç°ä¸‰ç§é™æµç®—æ³•

#### 1ã€æ­£å¸¸é™åˆ¶è®¿é—®é¢‘ç‡ï¼ˆæ­£å¸¸æµé‡ï¼‰ï¼š

é™åˆ¶ä¸€ä¸ªç”¨æˆ·å‘é€çš„è¯·æ±‚ï¼Œæˆ‘Nginxå¤šä¹…æ¥æ”¶ä¸€ä¸ªè¯·æ±‚ã€‚

Nginxä¸­ä½¿ç”¨`ngx_http_limit_req_module`æ¨¡å—æ¥é™åˆ¶çš„è®¿é—®é¢‘ç‡ï¼Œé™åˆ¶çš„åŸç†å®è´¨æ˜¯åŸºäºæ¼æ¡¶ç®—æ³•åŸç†æ¥å®ç°çš„ã€‚åœ¨nginx.confé…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨`limit_req_zone`å‘½ä»¤åŠ`limit_req`å‘½ä»¤é™åˆ¶å•ä¸ªIPçš„è¯·æ±‚å¤„ç†é¢‘ç‡ã€‚

```
# å®šä¹‰é™æµç»´åº¦ï¼Œä¸€ä¸ªç”¨æˆ·ä¸€åˆ†é’Ÿä¸€ä¸ªè¯·æ±‚è¿›æ¥ï¼Œå¤šä½™çš„å…¨éƒ¨æ¼æ‰
limit_req_zone $binary_remote_addr zone=one:10m rate=1r/m;

# ç»‘å®šé™æµç»´åº¦
server{
    
    location/seckill.html{
        limit_req zone=zone;    
        proxy_pass http://lj_seckill;
    }

}
```

1r/sä»£è¡¨1ç§’ä¸€ä¸ªè¯·æ±‚ï¼Œ1r/mä¸€åˆ†é’Ÿæ¥æ”¶ä¸€ä¸ªè¯·æ±‚ï¼Œ å¦‚æœNginxè¿™æ—¶è¿˜æœ‰åˆ«äººçš„è¯·æ±‚æ²¡æœ‰å¤„ç†å®Œï¼ŒNginxå°±ä¼šæ‹’ç»å¤„ç†è¯¥ç”¨æˆ·è¯·æ±‚ã€‚

#### 2ã€çªå‘é™åˆ¶è®¿é—®é¢‘ç‡ï¼ˆçªå‘æµé‡ï¼‰ï¼š

é™åˆ¶ä¸€ä¸ªç”¨æˆ·å‘é€çš„è¯·æ±‚ï¼Œæˆ‘Nginxå¤šä¹…æ¥æ”¶ä¸€ä¸ªã€‚

ä¸Šé¢çš„é…ç½®ä¸€å®šç¨‹åº¦å¯ä»¥é™åˆ¶è®¿é—®é¢‘ç‡ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ç€ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœçªå‘æµé‡è¶…å‡ºè¯·æ±‚è¢«æ‹’ç»å¤„ç†ï¼Œæ— æ³•å¤„ç†æ´»åŠ¨æ—¶å€™çš„çªå‘æµé‡ï¼Œè¿™æ—¶å€™åº”è¯¥å¦‚ä½•è¿›ä¸€æ­¥å¤„ç†å‘¢ï¼Ÿ

Nginxæä¾›burstå‚æ•°ç»“åˆnodelayå‚æ•°å¯ä»¥è§£å†³æµé‡çªå‘çš„é—®é¢˜ï¼Œå¯ä»¥è®¾ç½®èƒ½å¤„ç†çš„è¶…è¿‡è®¾ç½®çš„è¯·æ±‚æ•°å¤–èƒ½é¢å¤–å¤„ç†çš„è¯·æ±‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¹‹å‰çš„ä¾‹å­æ·»åŠ burstå‚æ•°ä»¥åŠnodelayå‚æ•°ï¼š

```
# å®šä¹‰é™æµç»´åº¦ï¼Œä¸€ä¸ªç”¨æˆ·ä¸€åˆ†é’Ÿä¸€ä¸ªè¯·æ±‚è¿›æ¥ï¼Œå¤šä½™çš„å…¨éƒ¨æ¼æ‰
limit_req_zone $binary_remote_addr zone=one:10m rate=1r/m;

# ç»‘å®šé™æµç»´åº¦
server{
    
    location/seckill.html{
        limit_req zone=zone burst=5 nodelay;
        proxy_pass http://lj_seckill;
    }

}
```

ä¸ºä»€ä¹ˆå°±å¤šäº†ä¸€ä¸ª burst=5 nodelay; å‘¢ï¼Œå¤šäº†è¿™ä¸ªå¯ä»¥ä»£è¡¨Nginxå¯¹äºä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚ä¼šç«‹å³å¤„ç†å‰äº”ä¸ªï¼Œå¤šä½™çš„å°±æ…¢æ…¢æ¥è½ï¼Œæ²¡æœ‰å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚æˆ‘å°±å¤„ç†ä½ çš„ï¼Œæœ‰å…¶ä»–çš„è¯·æ±‚çš„è¯æˆ‘Nginxå°±æ¼æ‰ä¸æ¥å—ä½ çš„è¯·æ±‚

#### 3ã€ é™åˆ¶å¹¶å‘è¿æ¥æ•°

Nginxä¸­çš„`ngx_http_limit_conn_module`æ¨¡å—æä¾›äº†é™åˆ¶å¹¶å‘è¿æ¥æ•°çš„åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨`limit_conn_zone`æŒ‡ä»¤ä»¥åŠ`limit_conn`æ‰§è¡Œè¿›è¡Œé…ç½®ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹ä¸‹ï¼š

```
http {
    limit_conn_zone $binary_remote_addr zone=myip:10m;
    limit_conn_zone $server_name zone=myServerName:10m;
}

server {
    location / {
        limit_conn myip 10;
        limit_conn myServerName 100;
        rewrite / http://www.lijie.net permanent;
    }
} 
```

ä¸Šé¢é…ç½®äº†å•ä¸ªIPåŒæ—¶å¹¶å‘è¿æ¥æ•°æœ€å¤šåªèƒ½10ä¸ªè¿æ¥ï¼Œå¹¶ä¸”è®¾ç½®äº†æ•´ä¸ªè™šæ‹ŸæœåŠ¡å™¨åŒæ—¶æœ€å¤§å¹¶å‘æ•°æœ€å¤šåªèƒ½100ä¸ªé“¾æ¥ã€‚å½“ç„¶ï¼Œåªæœ‰å½“è¯·æ±‚çš„headerè¢«æœåŠ¡å™¨å¤„ç†åï¼Œè™šæ‹ŸæœåŠ¡å™¨çš„è¿æ¥æ•°æ‰ä¼šè®¡æ•°ã€‚åˆšæ‰æœ‰æåˆ°è¿‡Nginxæ˜¯åŸºäºæ¼æ¡¶ç®—æ³•åŸç†å®ç°çš„ï¼Œå®é™…ä¸Šé™æµä¸€èˆ¬éƒ½æ˜¯åŸºäºæ¼æ¡¶ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•å®ç°çš„ã€‚

## æ¼æ¡¶æµç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•çŸ¥é“ï¼Ÿ

#### æ¼æ¡¶ç®—æ³•

æ¼æ¡¶ç®—æ³•æ€è·¯å¾ˆç®€å•ï¼Œæˆ‘ä»¬æŠŠæ°´æ¯”ä½œæ˜¯è¯·æ±‚ï¼Œæ¼æ¡¶æ¯”ä½œæ˜¯ç³»ç»Ÿå¤„ç†èƒ½åŠ›æé™ï¼Œæ°´å…ˆè¿›å…¥åˆ°æ¼æ¡¶é‡Œï¼Œæ¼æ¡¶é‡Œçš„æ°´æŒ‰ä¸€å®šé€Ÿç‡æµå‡ºï¼Œå½“æµå‡ºçš„é€Ÿç‡å°äºæµå…¥çš„é€Ÿç‡æ—¶ï¼Œç”±äºæ¼æ¡¶å®¹é‡æœ‰é™ï¼Œåç»­è¿›å…¥çš„æ°´ç›´æ¥æº¢å‡ºï¼ˆæ‹’ç»è¯·æ±‚ï¼‰ï¼Œä»¥æ­¤å®ç°é™æµã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nginx/40-interview-57f54ac6-82fe-403c-af37-728d707d5eca.png)


#### ä»¤ç‰Œæ¡¶ç®—æ³•

ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£æˆåŒ»é™¢çš„æŒ‚å·çœ‹ç—…ï¼Œåªæœ‰æ‹¿åˆ°å·ä»¥åæ‰å¯ä»¥è¿›è¡Œè¯Šç—…ã€‚

ç³»ç»Ÿä¼šç»´æŠ¤ä¸€ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰æ¡¶ï¼Œä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿåº¦å¾€æ¡¶é‡Œæ”¾å…¥ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œè¿™æ—¶å¦‚æœæœ‰è¯·æ±‚è¿›æ¥æƒ³è¦è¢«å¤„ç†ï¼Œåˆ™éœ€è¦å…ˆä»æ¡¶é‡Œè·å–ä¸€ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œå½“æ¡¶é‡Œæ²¡æœ‰ä»¤ç‰Œï¼ˆtokenï¼‰å¯å–æ—¶ï¼Œåˆ™è¯¥è¯·æ±‚å°†è¢«æ‹’ç»æœåŠ¡ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•é€šè¿‡æ§åˆ¶æ¡¶çš„å®¹é‡ã€å‘æ”¾ä»¤ç‰Œçš„é€Ÿç‡ï¼Œæ¥è¾¾åˆ°å¯¹è¯·æ±‚çš„é™åˆ¶ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nginx/40-interview-4bebeaf2-3853-4bb3-a34d-10316a230854.png)


## Nginxé…ç½®é«˜å¯ç”¨æ€§æ€ä¹ˆé…ç½®ï¼Ÿ

å½“ä¸Šæ¸¸æœåŠ¡å™¨(çœŸå®è®¿é—®æœåŠ¡å™¨)ï¼Œä¸€æ—¦å‡ºç°æ•…éšœæˆ–è€…æ˜¯æ²¡æœ‰åŠæ—¶ç›¸åº”çš„è¯ï¼Œåº”è¯¥ç›´æ¥è½®è®­åˆ°ä¸‹ä¸€å°æœåŠ¡å™¨ï¼Œä¿è¯æœåŠ¡å™¨çš„é«˜å¯ç”¨

Nginxé…ç½®ä»£ç ï¼š

```
serverÂ {
Â Â Â Â Â Â Â Â listenÂ Â Â Â Â Â Â 80;
Â Â Â Â Â Â Â Â server_nameÂ Â www.lijie.com;
Â Â Â Â Â Â Â Â locationÂ /Â {
Â Â Â Â Â Â Â Â Â Â Â Â ###Â æŒ‡å®šä¸Šæ¸¸æœåŠ¡å™¨è´Ÿè½½å‡è¡¡æœåŠ¡å™¨
Â Â Â Â Â Â Â Â Â Â Â Â proxy_passÂ http://backServer;
Â Â Â Â Â Â Â Â Â Â Â Â ###nginxä¸ä¸Šæ¸¸æœåŠ¡å™¨(çœŸå®è®¿é—®çš„æœåŠ¡å™¨)è¶…æ—¶æ—¶é—´Â åç«¯æœåŠ¡å™¨è¿æ¥çš„è¶…æ—¶æ—¶é—´_å‘èµ·æ¡æ‰‹ç­‰å€™å“åº”è¶…æ—¶æ—¶é—´
Â Â Â Â Â Â Â Â Â Â Â Â proxy_connect_timeoutÂ 1s;
Â Â Â Â Â Â Â Â Â Â Â Â ###nginxå‘é€ç»™ä¸Šæ¸¸æœåŠ¡å™¨(çœŸå®è®¿é—®çš„æœåŠ¡å™¨)è¶…æ—¶æ—¶é—´
Â Â Â Â Â Â Â Â Â Â Â Â proxy_send_timeoutÂ 1s;
Â Â Â Â Â Â Â Â Â Â Â Â ###Â nginxæ¥å—ä¸Šæ¸¸æœåŠ¡å™¨(çœŸå®è®¿é—®çš„æœåŠ¡å™¨)è¶…æ—¶æ—¶é—´
Â Â Â Â Â Â Â Â Â Â Â Â proxy_read_timeoutÂ 1s;
Â Â Â Â Â Â Â Â Â Â Â Â indexÂ Â index.htmlÂ index.htm;
Â Â Â Â Â Â Â Â }
Â Â Â Â }
```

## Nginxæ€ä¹ˆåˆ¤æ–­åˆ«IPä¸å¯è®¿é—®ï¼Ÿ

```
  # å¦‚æœè®¿é—®çš„ipåœ°å€ä¸º192.168.9.115,åˆ™è¿”å›403
 if  ($remote_addr = 192.168.9.115) {  
     return 403;  
 }  
```

## åœ¨nginxä¸­ï¼Œå¦‚ä½•ä½¿ç”¨æœªå®šä¹‰çš„æœåŠ¡å™¨åç§°æ¥é˜»æ­¢å¤„ç†è¯·æ±‚ï¼Ÿ

åªéœ€å°†è¯·æ±‚åˆ é™¤çš„æœåŠ¡å™¨å°±å¯ä»¥å®šä¹‰ä¸ºï¼š

æœåŠ¡å™¨åè¢«ä¿ç•™ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œä»–åœ¨æ²¡æœ‰ä¸»æœºå¤´å­—æ®µçš„æƒ…å†µä¸‹åŒ¹é…è¯·æ±‚ï¼Œè€Œä¸€ä¸ªç‰¹æ®Šçš„nginxçš„éæ ‡å‡†ä»£ç è¢«è¿”å›ï¼Œä»è€Œç»ˆæ­¢è¿æ¥ã€‚

## æ€ä¹ˆé™åˆ¶æµè§ˆå™¨è®¿é—®ï¼Ÿ

```
## ä¸å…è®¸è°·æ­Œæµè§ˆå™¨è®¿é—® å¦‚æœæ˜¯è°·æ­Œæµè§ˆå™¨è¿”å›500
if ($http_user_agent ~ Chrome) {   
  return 500;  
}
```

## Rewriteå…¨å±€å˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ

```
$remote_addr        //è·å–å®¢æˆ·ç«¯ip
$binary_remote_addr //å®¢æˆ·ç«¯ipï¼ˆäºŒè¿›åˆ¶)
$remote_port        //å®¢æˆ·ç«¯portï¼Œå¦‚ï¼š50472
$remote_user        //å·²ç»ç»è¿‡Auth Basic ModuleéªŒè¯çš„ç”¨æˆ·å
$host           //è¯·æ±‚ä¸»æœºå¤´å­—æ®µï¼Œå¦åˆ™ä¸ºæœåŠ¡å™¨åç§°ï¼Œå¦‚:blog.sakmon.com
$request        //ç”¨æˆ·è¯·æ±‚ä¿¡æ¯ï¼Œå¦‚ï¼šGET ?a=1&b=2 HTTP/1.1
$request_filename   //å½“å‰è¯·æ±‚çš„æ–‡ä»¶çš„è·¯å¾„åï¼Œç”±rootæˆ–aliaså’ŒURI requestç»„åˆè€Œæˆï¼Œå¦‚ï¼š/2013/81.html
$status         //è¯·æ±‚çš„å“åº”çŠ¶æ€ç ,å¦‚:200
$body_bytes_sent        // å“åº”æ—¶é€å‡ºçš„bodyå­—èŠ‚æ•°æ•°é‡ã€‚å³ä½¿è¿æ¥ä¸­æ–­ï¼Œè¿™ä¸ªæ•°æ®ä¹Ÿæ˜¯ç²¾ç¡®çš„,å¦‚ï¼š40
$content_length        // ç­‰äºè¯·æ±‚è¡Œçš„â€œContent_Lengthâ€çš„å€¼
$content_type          // ç­‰äºè¯·æ±‚è¡Œçš„â€œContent_Typeâ€çš„å€¼
$http_referer          // å¼•ç”¨åœ°å€
$http_user_agent      // å®¢æˆ·ç«¯agentä¿¡æ¯,å¦‚ï¼šMozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36
$args            //ä¸$query_stringç›¸åŒ ç­‰äºå½“ä¸­URLçš„å‚æ•°(GET)ï¼Œå¦‚a=1&b=2
$document_uri        //ä¸$uriç›¸åŒ  è¿™ä¸ªå˜é‡æŒ‡å½“å‰çš„è¯·æ±‚URIï¼Œä¸åŒ…æ‹¬ä»»ä½•å‚æ•°(è§$args) å¦‚:/2013/81.html
$document_root       //é’ˆå¯¹å½“å‰è¯·æ±‚çš„æ ¹è·¯å¾„è®¾ç½®å€¼
$hostname        //å¦‚ï¼šcentos53.localdomain
$http_cookie        //å®¢æˆ·ç«¯cookieä¿¡æ¯
$cookie_COOKIE      //cookie COOKIEå˜é‡çš„å€¼
$is_args    //å¦‚æœæœ‰$argså‚æ•°ï¼Œè¿™ä¸ªå˜é‡ç­‰äºâ€?â€ï¼Œå¦åˆ™ç­‰äºâ€"ï¼Œç©ºå€¼ï¼Œå¦‚?
$limit_rate //è¿™ä¸ªå˜é‡å¯ä»¥é™åˆ¶è¿æ¥é€Ÿç‡ï¼Œ0è¡¨ç¤ºä¸é™é€Ÿ
$query_string       // ä¸$argsç›¸åŒ ç­‰äºå½“ä¸­URLçš„å‚æ•°(GET)ï¼Œå¦‚a=1&b=2
$request_body      // è®°å½•POSTè¿‡æ¥çš„æ•°æ®ä¿¡æ¯
$request_body_file  //å®¢æˆ·ç«¯è¯·æ±‚ä¸»ä½“ä¿¡æ¯çš„ä¸´æ—¶æ–‡ä»¶å
$request_method       //å®¢æˆ·ç«¯è¯·æ±‚çš„åŠ¨ä½œï¼Œé€šå¸¸ä¸ºGETæˆ–POST,å¦‚ï¼šGET
$request_uri          //åŒ…å«è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œå¦‚ï¼š/2013/81.html?a=1&b=2
$scheme            //HTTPæ–¹æ³•ï¼ˆå¦‚httpï¼Œhttpsï¼‰,å¦‚ï¼šhttp
$uri            //è¿™ä¸ªå˜é‡æŒ‡å½“å‰çš„è¯·æ±‚URIï¼Œä¸åŒ…æ‹¬ä»»ä½•å‚æ•°(è§$args) å¦‚:/2013/81.html
$request_completion //å¦‚æœè¯·æ±‚ç»“æŸï¼Œè®¾ç½®ä¸ºOK. å½“è¯·æ±‚æœªç»“æŸæˆ–å¦‚æœè¯¥è¯·æ±‚ä¸æ˜¯è¯·æ±‚é“¾ä¸²çš„æœ€åä¸€ä¸ªæ—¶ï¼Œä¸ºç©º(Empty)ï¼Œå¦‚ï¼šOK
$server_protocol    //è¯·æ±‚ä½¿ç”¨çš„åè®®ï¼Œé€šå¸¸æ˜¯HTTP/1.0æˆ–HTTP/1.1ï¼Œå¦‚ï¼šHTTP/1.1
$server_addr        //æœåŠ¡å™¨IPåœ°å€ï¼Œåœ¨å®Œæˆä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨åå¯ä»¥ç¡®å®šè¿™ä¸ªå€¼
$server_name        //æœåŠ¡å™¨åç§°ï¼Œå¦‚ï¼šblog.sakmon.com
$server_port        //è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨çš„ç«¯å£å·,å¦‚ï¼š80
```

## Nginx å¦‚ä½•å®ç°åç«¯æœåŠ¡çš„å¥åº·æ£€æŸ¥ï¼Ÿ

æ–¹å¼ä¸€ï¼Œåˆ©ç”¨ nginx è‡ªå¸¦æ¨¡å—Â `ngx_http_proxy_module`Â å’ŒÂ `ngx_http_upstream_module`Â å¯¹åç«¯èŠ‚ç‚¹åšå¥åº·æ£€æŸ¥ã€‚

æ–¹å¼äºŒ(æ¨è)ï¼Œåˆ©ç”¨Â `nginx_upstream_check_module`Â æ¨¡å—å¯¹åç«¯èŠ‚ç‚¹åšå¥åº·æ£€æŸ¥ã€‚

## Nginx å¦‚ä½•å¼€å¯å‹ç¼©ï¼Ÿ

å¼€å¯nginx gzipå‹ç¼©åï¼Œç½‘é¡µã€cssã€jsç­‰é™æ€èµ„æºçš„å¤§å°ä¼šå¤§å¤§çš„å‡å°‘ï¼Œä»è€Œå¯ä»¥èŠ‚çº¦å¤§é‡çš„å¸¦å®½ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ï¼Œç»™ç”¨æˆ·å¿«çš„ä½“éªŒã€‚è™½ç„¶ä¼šæ¶ˆè€—cpuèµ„æºï¼Œä½†æ˜¯ä¸ºäº†ç»™ç”¨æˆ·æ›´å¥½çš„ä½“éªŒæ˜¯å€¼å¾—çš„ã€‚

å¼€å¯çš„é…ç½®å¦‚ä¸‹ï¼š

å°†ä»¥ä¸Šé…ç½®æ”¾åˆ°nginx.confçš„`http{ â€¦ }`èŠ‚ç‚¹ä¸­ã€‚

```
http {
  # å¼€å¯gzip
  gzip on;
 
  # å¯ç”¨gzipå‹ç¼©çš„æœ€å°æ–‡ä»¶ï¼›å°äºè®¾ç½®å€¼çš„æ–‡ä»¶å°†ä¸ä¼šè¢«å‹ç¼©
  gzip_min_length 1k;
 
  # gzip å‹ç¼©çº§åˆ« 1-10 
  gzip_comp_level 2;
 
  # è¿›è¡Œå‹ç¼©çš„æ–‡ä»¶ç±»å‹ã€‚
 
  gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;
 
  # æ˜¯å¦åœ¨http headerä¸­æ·»åŠ Vary: Accept-Encodingï¼Œå»ºè®®å¼€å¯
  gzip_vary on;
}
```

ä¿å­˜å¹¶é‡å¯nginxï¼Œåˆ·æ–°é¡µé¢ï¼ˆä¸ºäº†é¿å…ç¼“å­˜ï¼Œè¯·å¼ºåˆ¶åˆ·æ–°ï¼‰å°±èƒ½çœ‹åˆ°æ•ˆæœäº†ã€‚ä»¥è°·æ­Œæµè§ˆå™¨ä¸ºä¾‹ï¼Œé€šè¿‡F12çœ‹è¯·æ±‚çš„å“åº”å¤´éƒ¨ï¼š

æˆ‘ä»¬å¯ä»¥å…ˆæ¥å¯¹æ¯”ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰å¼€å¯zipå‹ç¼©ä¹‹å‰ï¼Œæˆ‘ä»¬çš„å¯¹åº”çš„æ–‡ä»¶å¤§å°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nginx/40-interview-fb46fd48-e596-48ac-8759-0663d29593af.png)


ç°åœ¨æˆ‘ä»¬å¼€å¯äº†gzipè¿›è¡Œå‹ç¼©åçš„æ–‡ä»¶çš„å¤§å°ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nginx/40-interview-1ee18fd5-1cc1-478a-9fca-d15f85f0f5c7.png)


å¹¶ä¸”æˆ‘ä»¬æŸ¥çœ‹å“åº”å¤´ä¼šçœ‹åˆ°gzipè¿™æ ·çš„å‹ç¼©ï¼Œå¦‚ä¸‹æ‰€ç¤º

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nginx/40-interview-c3c95717-45ee-4f56-b606-d56d2fc3cc57.png)


gzipå‹ç¼©å‰åæ•ˆæœå¯¹æ¯”ï¼šjqueryåŸå¤§å°90kbï¼Œå‹ç¼©ååªæœ‰30kbã€‚

gzipè™½ç„¶å¥½ç”¨ï¼Œä½†æ˜¯ä»¥ä¸‹ç±»å‹çš„èµ„æºä¸å»ºè®®å¯ç”¨ã€‚

#### 1ã€å›¾ç‰‡ç±»å‹

åŸå› ï¼šå›¾ç‰‡å¦‚jpgã€pngæœ¬èº«å°±ä¼šæœ‰å‹ç¼©ï¼Œæ‰€ä»¥å°±ç®—å¼€å¯gzipåï¼Œå‹ç¼©å‰å’Œå‹ç¼©åå¤§å°æ²¡æœ‰å¤šå¤§åŒºåˆ«ï¼Œæ‰€ä»¥å¼€å¯äº†åè€Œä¼šç™½ç™½çš„æµªè´¹èµ„æºã€‚ï¼ˆTipsï¼šå¯ä»¥è¯•è¯•å°†ä¸€å¼ jpgå›¾ç‰‡å‹ç¼©ä¸ºzipï¼Œè§‚å¯Ÿå¤§å°å¹¶æ²¡æœ‰å¤šå¤§çš„å˜åŒ–ã€‚è™½ç„¶zipå’Œgzipç®—æ³•ä¸ä¸€æ ·ï¼Œä½†æ˜¯å¯ä»¥çœ‹å‡ºå‹ç¼©å›¾ç‰‡çš„ä»·å€¼å¹¶ä¸å¤§ï¼‰

#### 2ã€å¤§æ–‡ä»¶

åŸå› ï¼šä¼šæ¶ˆè€—å¤§é‡çš„cpuèµ„æºï¼Œä¸”ä¸ä¸€å®šæœ‰æ˜æ˜¾çš„æ•ˆæœã€‚

## ngx_http_upstream_moduleçš„ä½œç”¨æ˜¯ä»€ä¹ˆ?

ngx_http_upstream_moduleç”¨äºå®šä¹‰å¯é€šè¿‡fastcgiä¼ é€’ã€proxyä¼ é€’ã€uwsgiä¼ é€’ã€memcachedä¼ é€’å’Œscgiä¼ é€’æŒ‡ä»¤æ¥å¼•ç”¨çš„æœåŠ¡å™¨ç»„ã€‚

## ä»€ä¹ˆæ˜¯C10Ké—®é¢˜?

C10Ké—®é¢˜æ˜¯æŒ‡æ— æ³•åŒæ—¶å¤„ç†å¤§é‡å®¢æˆ·ç«¯(10,000)çš„ç½‘ç»œå¥—æ¥å­—ã€‚

## Nginxæ˜¯å¦æ”¯æŒå°†è¯·æ±‚å‹ç¼©åˆ°ä¸Šæ¸¸?

æ‚¨å¯ä»¥ä½¿ç”¨Nginxæ¨¡å—gunzipå°†è¯·æ±‚å‹ç¼©åˆ°ä¸Šæ¸¸ã€‚gunzipæ¨¡å—æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå®ƒå¯ä»¥å¯¹ä¸æ”¯æŒâ€œgzipâ€ç¼–ç æ–¹æ³•çš„å®¢æˆ·æœºæˆ–æœåŠ¡å™¨ä½¿ç”¨â€œå†…å®¹ç¼–ç :gzipâ€æ¥è§£å‹ç¼©å“åº”ã€‚

## å¦‚ä½•åœ¨Nginxä¸­è·å¾—å½“å‰çš„æ—¶é—´?

è¦è·å¾—Nginxçš„å½“å‰æ—¶é—´ï¼Œå¿…é¡»ä½¿ç”¨SSIæ¨¡å—ã€å’Œdate_localçš„å˜é‡ã€‚

```
Proxy_set_header THE-TIME $date_gmt;
```

## ç”¨NginxæœåŠ¡å™¨è§£é‡Š-sçš„ç›®çš„æ˜¯ä»€ä¹ˆ?

ç”¨äºè¿è¡ŒNginx -så‚æ•°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

## å¦‚ä½•åœ¨NginxæœåŠ¡å™¨ä¸Šæ·»åŠ æ¨¡å—?

åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå¿…é¡»é€‰æ‹©Nginxæ¨¡å—ï¼Œå› ä¸ºNginxä¸æ”¯æŒæ¨¡å—çš„è¿è¡Œæ—¶é—´é€‰æ‹©ã€‚

## ç”Ÿäº§ä¸­å¦‚ä½•è®¾ç½®workerè¿›ç¨‹çš„æ•°é‡å‘¢ï¼Ÿ

åœ¨æœ‰å¤šä¸ªcpuçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªworkerï¼Œworkerè¿›ç¨‹çš„æ•°é‡å¯ä»¥è®¾ç½®åˆ°å’Œcpuçš„æ ¸å¿ƒæ•°ä¸€æ ·å¤šï¼Œå¦‚æœåœ¨å•ä¸ªcpuä¸Šèµ·å¤šä¸ªworkerè¿›ç¨‹ï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿä¼šåœ¨å¤šä¸ªworkerä¹‹é—´è¿›è¡Œè°ƒåº¦ï¼Œè¿™ç§æƒ…å†µä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªcpuï¼Œé‚£ä¹ˆåªå¯åŠ¨ä¸€ä¸ªworkerè¿›ç¨‹å°±å¯ä»¥äº†ã€‚

## nginxçŠ¶æ€ç 

499ï¼š

æœåŠ¡ç«¯å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­äº†è¿æ¥ã€‚

502ï¼š

(1).FastCGIè¿›ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨

(2).FastCGI workerè¿›ç¨‹æ•°æ˜¯å¦ä¸å¤Ÿ

(3).FastCGIæ‰§è¡Œæ—¶é—´è¿‡é•¿

*   fastcgi_connect_timeout 300;
*   fastcgi_send_timeout 300;
*   fastcgi_read_timeout 300;

(4).FastCGI Bufferä¸å¤Ÿï¼Œnginxå’Œapacheä¸€æ ·ï¼Œæœ‰å‰ç«¯ç¼“å†²é™åˆ¶ï¼Œå¯ä»¥è°ƒæ•´ç¼“å†²å‚æ•°

*   fastcgi_buffer_size 32k;
*   fastcgi_buffers 8 32k;

(5). Proxy Bufferä¸å¤Ÿï¼Œå¦‚æœä½ ç”¨äº†Proxyingï¼Œè°ƒæ•´

*   proxy_buffer_size 16k;
*   proxy_buffers 4 16k;

(6).phpè„šæœ¬æ‰§è¡Œæ—¶é—´è¿‡é•¿

*   å°†php-fpm.confçš„0sçš„0sæ”¹æˆä¸€ä¸ªæ—¶é—´

------

çœ‹å®Œè¿™ 40 ä¸ª Nginx çš„é¢è¯•é¢˜ï¼Œå°äºŒæ˜¯æ„Ÿæ¿€æ¶•é›¶ï¼Œæ„ŸåŠ¨çš„ä¸€å¡Œç³Šæ¶‚ã€‚æˆ‘æ‹äº†æ‹ä»–çš„è‚©è†€ï¼Œå®‰æ…°ä»–è¯´ï¼šâ€œåŠ æ²¹ï¼Œæœªæ¥æ˜¯ä½ çš„ã€‚â€


>åŸæ–‡é“¾æ¥ï¼š[blog.csdn.net/wuzhiwei549/article/details/122758937](blog.csdn.net/wuzhiwei549/article/details/122758937)ï¼Œæ•´ç†ï¼šæ²‰é»˜ç‹äºŒ

---------

GitHub ä¸Šæ ‡æ˜Ÿ 9300+ çš„å¼€æºçŸ¥è¯†åº“ã€Š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://github.com/itwanger/toBeBetterJavaer)ã€‹ç¬¬ä¸€ç‰ˆ PDF ç»ˆäºæ¥äº†ï¼åŒ…æ‹¬JavaåŸºç¡€è¯­æ³•ã€æ•°ç»„&å­—ç¬¦ä¸²ã€OOPã€é›†åˆæ¡†æ¶ã€Java IOã€å¼‚å¸¸å¤„ç†ã€Java æ–°ç‰¹æ€§ã€ç½‘ç»œç¼–ç¨‹ã€NIOã€å¹¶å‘ç¼–ç¨‹ã€JVMç­‰ç­‰ï¼Œå…±è®¡ 32 ä¸‡ä½™å­—ï¼Œ500+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯é€šä¿—æ˜“æ‡‚ã€é£è¶£å¹½é»˜â€¦â€¦è¯¦æƒ…æˆ³ï¼š[å¤ªèµäº†ï¼ŒGitHub ä¸Šæ ‡æ˜Ÿ 9300+ çš„ Java æ•™ç¨‹](https://javabetter.cn/overview/)


å¾®ä¿¡æœ **æ²‰é»˜ç‹äºŒ** æˆ–æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨äºŒå“¥çš„åŸåˆ›å…¬ä¼—å·æ²‰é»˜ç‹äºŒï¼Œå›å¤ **222** å³å¯å…è´¹é¢†å–ã€‚


![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png)
