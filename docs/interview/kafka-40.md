---
title: 40 é“ç²¾é€‰ Kafka é¢è¯•é¢˜ğŸ‘
shortTitle: 40 é“ç²¾é€‰ Kafka é¢è¯•é¢˜ğŸ‘
author: èœå†œ
category:
  - æ±‚èŒé¢è¯•
tag:
  - é¢è¯•é¢˜&å…«è‚¡æ–‡
description: äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼Œå°ç™½çš„é›¶åŸºç¡€Javaæ•™ç¨‹ï¼Œ40 é“ Kafka ç²¾é€‰é¢è¯•é¢˜ğŸ‘
head:
  - - meta
    - name: keywords
      content: Kafka,é¢è¯•é¢˜,å…«è‚¡æ–‡
---

ä»Šå¤©ç»™çƒå‹ä»¬åˆ†äº«ä¸€ç¯‡è¯»è€…èœå†œæŠ•ç¨¿çš„æ–‡ç« ï¼š40 é“ç²¾é€‰ Kafka é¢è¯•é¢˜ğŸ‘ï¼Œå·²æ”¶å½•åœ¨ã€ŠJava é¢è¯•æŒ‡å—ã€‹çš„ã€Šç²¾é€‰é¢è¯•é¢˜ç¯‡ã€‹ä¸­ï¼Œä¸“æ æ‰˜ç®¡åœ¨è¯­é›€å¹³å°ä¸Šï¼ˆæ›´æ–¹ä¾¿ä½ æ²‰æµ¸å¼é˜…è¯»å’Œåšç¬”è®°ï¼‰ï¼Œè®¿é—®åœ°å€å’Œå¯†ç ï¼šhttps://t.zsxq.com/6iuzn6I

å‘è½¦ğŸš—

Kafkaæœ€åˆæ˜¯ç”±Linkedinå…¬å¸å¼€å‘çš„ï¼Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ã€å¯æ‰©å±•çš„ã€å®¹é”™çš„ã€æ”¯æŒåˆ†åŒºçš„ï¼ˆPartitionï¼‰ã€å¤šå‰¯æœ¬çš„ï¼ˆreplicaï¼‰ã€åŸºäºZookeeperæ¡†æ¶çš„å‘å¸ƒ-è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼ŒKafkaé€‚åˆç¦»çº¿å’Œåœ¨çº¿æ¶ˆæ¯æ¶ˆè´¹ã€‚å®ƒæ˜¯åˆ†å¸ƒå¼åº”ç”¨ç³»ç»Ÿä¸­çš„é‡è¦ç»„ä»¶ä¹‹ä¸€ï¼Œä¹Ÿè¢«å¹¿æ³›åº”ç”¨äºå¤§æ•°æ®å¤„ç†ã€‚Kafkaæ˜¯ç”¨Scalaè¯­è¨€å¼€å‘ï¼Œå®ƒçš„Javaç‰ˆæœ¬ç§°ä¸ºJafkaã€‚Linkedinäº2010å¹´å°†è¯¥ç³»ç»Ÿè´¡çŒ®ç»™äº†ApacheåŸºé‡‘ä¼šå¹¶æˆä¸ºé¡¶çº§å¼€æºé¡¹ç›®ä¹‹ä¸€ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-baogwdkafkamsgczhs-6c5e6ab3-ff41-4b91-a083-5f8df6d925bd.jpg)

**å¸Œæœ›è¿™40é“é¢è¯•é¢˜ä½œä¸ºå¤§å®¶å­¦ä¹  kafka çš„è·¯çº¿å›¾ï¼Œç”±æµ…å…¥æ·±ï¼Œæœ€å¤§ç¨‹åº¦ä¸Šè¦†ç›–æ•´ä¸ª Kafka çš„é—®ç­”å†…å®¹ï¼ˆé¢„ä¹ ï¼‹å¤ä¹ ä¸€æ­¥åˆ°ä½ï¼‰**

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-baogwdkafkamsgczhs-58771e78-0829-4ae8-ac93-50e83be044dc.jpg)

* * *


## 1ã€Kafka çš„è®¾è®¡

Kafka å°†æ¶ˆæ¯ä»¥ topic ä¸ºå•ä½è¿›è¡Œå½’çº³ï¼Œå‘å¸ƒæ¶ˆæ¯çš„ç¨‹åºç§°ä¸º **Producer**ï¼Œæ¶ˆè´¹æ¶ˆæ¯çš„ç¨‹åºç§°ä¸º **Consumer**ã€‚å®ƒæ˜¯ä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ç»„æˆï¼Œæ¯ä¸ªæœåŠ¡å«åšä¸€ä¸ª **Broker**ï¼ŒProducer é€šè¿‡ç½‘ç»œå°†æ¶ˆæ¯å‘é€åˆ° kafka é›†ç¾¤ï¼Œé›†ç¾¤å‘æ¶ˆè´¹è€…æä¾›æ¶ˆæ¯ï¼Œbroker åœ¨ä¸­é—´èµ·åˆ°ä¸€ä¸ªä»£ç†ä¿å­˜æ¶ˆæ¯çš„ä¸­è½¬ç«™ã€‚

**Kafka ä¸­é‡è¦çš„ç»„ä»¶**

*1ï¼‰Producer*ï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå‘å¸ƒæ¶ˆæ¯åˆ°Kafkaé›†ç¾¤çš„ç»ˆç«¯æˆ–æœåŠ¡

*2ï¼‰Broker*ï¼šä¸€ä¸ª Kafka èŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ª Brokerï¼Œå¤šä¸ªBrokerå¯ç»„æˆä¸€ä¸ªKafka é›†ç¾¤ã€‚

> å¦‚æœæŸä¸ª Topic ä¸‹æœ‰ n ä¸ªPartition ä¸”é›†ç¾¤æœ‰ n ä¸ªBrokerï¼Œé‚£ä¹ˆæ¯ä¸ª Brokerä¼šå­˜å‚¨è¯¥ Topic ä¸‹çš„ä¸€ä¸ª Partition
> 
> å¦‚æœæŸä¸ª Topic ä¸‹æœ‰ n ä¸ªPartition ä¸”é›†ç¾¤ä¸­æœ‰ m+n ä¸ªBrokerï¼Œé‚£ä¹ˆåªæœ‰ n ä¸ªBrokerä¼šå­˜å‚¨è¯¥Topicä¸‹çš„ä¸€ä¸ª Partition
> 
> å¦‚æœæŸä¸ª Topic ä¸‹æœ‰ n ä¸ªPartition ä¸”é›†ç¾¤ä¸­çš„Brokeræ•°é‡å°äº nï¼Œé‚£ä¹ˆä¸€ä¸ª Broker ä¼šå­˜å‚¨è¯¥ Topic ä¸‹çš„ä¸€ä¸ªæˆ–å¤šä¸ª Partitionï¼Œè¿™ç§æƒ…å†µå°½é‡é¿å…ï¼Œä¼šå¯¼è‡´é›†ç¾¤æ•°æ®ä¸å‡è¡¡

*3ï¼‰Topic*ï¼šæ¶ˆæ¯ä¸»é¢˜ï¼Œæ¯æ¡å‘å¸ƒåˆ°Kafkaé›†ç¾¤çš„æ¶ˆæ¯éƒ½ä¼šå½’é›†äºæ­¤ï¼ŒKafkaæ˜¯é¢å‘Topic çš„

*4ï¼‰Partition*ï¼šPartition æ˜¯Topicåœ¨ç‰©ç†ä¸Šçš„åˆ†åŒºï¼Œä¸€ä¸ªTopicå¯ä»¥åˆ†ä¸ºå¤šä¸ªPartitionï¼Œæ¯ä¸ªPartitionæ˜¯ä¸€ä¸ªæœ‰åºçš„ä¸å¯å˜çš„è®°å½•åºåˆ—ã€‚å•ä¸€ä¸»é¢˜ä¸­çš„åˆ†åŒºæœ‰åºï¼Œä½†æ— æ³•ä¿è¯ä¸»é¢˜ä¸­æ‰€æœ‰åˆ†åŒºçš„æ¶ˆæ¯æœ‰åºã€‚

*5ï¼‰Consumer*ï¼šä»Kafkaé›†ç¾¤ä¸­æ¶ˆè´¹æ¶ˆæ¯çš„ç»ˆç«¯æˆ–æœåŠ¡

*6ï¼‰Consumer Group*ï¼šæ¯ä¸ªConsumeréƒ½å±äºä¸€ä¸ªConsumer Groupï¼Œæ¯æ¡æ¶ˆæ¯åªèƒ½è¢«Consumer Groupä¸­çš„ä¸€ä¸ªConsumeræ¶ˆè´¹ï¼Œä½†å¯ä»¥è¢«å¤šä¸ªConsumer Groupæ¶ˆè´¹ã€‚

*7ï¼‰Replica*ï¼šPartition çš„å‰¯æœ¬ï¼Œç”¨æ¥ä¿éšœPartitionçš„é«˜å¯ç”¨æ€§ã€‚

*8ï¼‰Controllerï¼š* Kafka é›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªæœåŠ¡å™¨ï¼Œç”¨æ¥è¿›è¡ŒLeader electionä»¥åŠå„ç§ Failover æ“ä½œã€‚

*9ï¼‰Zookeeper*ï¼šKafka é€šè¿‡Zookeeperæ¥å­˜å‚¨é›†ç¾¤ä¸­çš„ meta æ¶ˆæ¯



## 2ã€Kafka æ€§èƒ½é«˜åŸå› 

1.  åˆ©ç”¨äº† PageCache ç¼“å­˜
2.  ç£ç›˜é¡ºåºå†™
3.  é›¶æ‹·è´æŠ€æœ¯
4.  pull æ‹‰æ¨¡å¼

## 3ã€Kafka æ–‡ä»¶é«˜æ•ˆå­˜å‚¨è®¾è®¡åŸç†

1.  KafkaæŠŠTopicä¸­ä¸€ä¸ªPartitionå¤§æ–‡ä»¶åˆ†æˆå¤šä¸ªå°æ–‡ä»¶æ®µï¼Œé€šè¿‡å¤šä¸ªå°æ–‡ä»¶æ®µï¼Œå°±å®¹æ˜“å®šæœŸæ¸…é™¤æˆ–åˆ é™¤å·²ç»æ¶ˆè´¹å®Œæˆçš„æ–‡ä»¶ï¼Œå‡å°‘ç£ç›˜å ç”¨
2.  é€šè¿‡ç´¢å¼•ä¿¡æ¯å¯ä»¥å¿«é€Ÿå®šä½Messageå’Œç¡®å®šresponseçš„æœ€å¤§å¤§å°
3.  é€šè¿‡å°†ç´¢å¼•å…ƒæ•°æ®å…¨éƒ¨æ˜ å°„åˆ° memoryï¼Œå¯ä»¥é¿å… Segment æ–‡ä»¶çš„ç£ç›˜I/Oæ“ä½œ
4.  é€šè¿‡ç´¢å¼•æ–‡ä»¶ç¨€ç–å­˜å‚¨ï¼Œå¯ä»¥å¤§å¹…é™ä½ç´¢å¼•æ–‡ä»¶å…ƒæ•°æ®å ç”¨ç©ºé—´å¤§å°

## 4ã€Kafka çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**

*   é«˜æ€§èƒ½ã€é«˜ååé‡ã€ä½å»¶è¿Ÿï¼šKafka ç”Ÿäº§å’Œæ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿåº¦éƒ½è¾¾åˆ°æ¯ç§’10ä¸‡çº§
*   é«˜å¯ç”¨ï¼šæ‰€æœ‰æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨åˆ°ç£ç›˜ï¼Œå¹¶æ”¯æŒæ•°æ®å¤‡ä»½é˜²æ­¢æ•°æ®ä¸¢å¤±
*   é«˜å¹¶å‘ï¼šæ”¯æŒæ•°åƒä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯»å†™
*   å®¹é”™æ€§ï¼šå…è®¸é›†ç¾¤ä¸­èŠ‚ç‚¹å¤±è´¥ï¼ˆè‹¥å‰¯æœ¬æ•°é‡ä¸ºnï¼Œåˆ™å…è®¸ n-1 ä¸ªèŠ‚ç‚¹å¤±è´¥ï¼‰
*   é«˜æ‰©å±•æ€§ï¼šKafka é›†ç¾¤æ”¯æŒçƒ­ä¼¸ç¼©ï¼Œæ— é¡»åœæœº

**ç¼ºç‚¹**

*   æ²¡æœ‰å®Œæ•´çš„ç›‘æ§å·¥å…·é›†
*   ä¸æ”¯æŒé€šé…ç¬¦ä¸»é¢˜é€‰æ‹©

## 5ã€Kafka çš„åº”ç”¨åœºæ™¯

1.  **æ—¥å¿—èšåˆ**ï¼šå¯æ”¶é›†å„ç§æœåŠ¡çš„æ—¥å¿—å†™å…¥kafkaçš„æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå­˜å‚¨
2.  **æ¶ˆæ¯ç³»ç»Ÿ**ï¼šå¹¿æ³›ç”¨äºæ¶ˆæ¯ä¸­é—´ä»¶
3.  **ç³»ç»Ÿè§£è€¦**ï¼šåœ¨é‡è¦æ“ä½œå®Œæˆåï¼Œå‘é€æ¶ˆæ¯ï¼Œç”±åˆ«çš„æœåŠ¡ç³»ç»Ÿæ¥å®Œæˆå…¶ä»–æ“ä½œ
4.  **æµé‡å‰Šå³°**ï¼šä¸€èˆ¬ç”¨äºç§’æ€æˆ–æŠ¢è´­æ´»åŠ¨ä¸­ï¼Œæ¥ç¼“å†²ç½‘ç«™çŸ­æ—¶é—´å†…é«˜æµé‡å¸¦æ¥çš„å‹åŠ›
5.  **å¼‚æ­¥å¤„ç†**ï¼šé€šè¿‡å¼‚æ­¥å¤„ç†æœºåˆ¶ï¼Œå¯ä»¥æŠŠä¸€ä¸ªæ¶ˆæ¯æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œä½†ä¸ç«‹å³å¤„ç†å®ƒï¼Œåœ¨éœ€è¦çš„æ—¶å€™å†è¿›è¡Œå¤„ç†

## 6ã€Kafka ä¸­åˆ†åŒºçš„æ¦‚å¿µ

ä¸»é¢˜æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œè¿˜å¯ä»¥ç»†åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼Œä¸€ä¸ªåˆ†åŒºåªå±äºå•ä¸ªä¸»é¢˜ï¼Œå¾ˆå¤šæ—¶å€™ä¹Ÿä¼šæŠŠåˆ†åŒºç§°ä¸ºä¸»é¢˜åˆ†åŒºï¼ˆTopic-Partitionï¼‰ã€‚åŒä¸€ä¸»é¢˜ä¸‹çš„ä¸åŒåˆ†åŒºåŒ…å«çš„æ¶ˆæ¯æ˜¯ä¸åŒçš„ï¼Œåˆ†åŒºåœ¨å­˜å‚¨å±‚é¢å¯ä»¥çœ‹åšä¸€ä¸ªå¯è¿½åŠ çš„`æ—¥å¿—æ–‡ä»¶` ï¼Œæ¶ˆæ¯åœ¨è¢«è¿½åŠ åˆ°åˆ†åŒºæ—¥å¿—æ–‡ä»¶çš„æ—¶å€™éƒ½ä¼šåˆ†é…ä¸€ä¸ªç‰¹å®šçš„åç§»é‡ï¼ˆoffsetï¼‰ã€‚offset æ˜¯æ¶ˆæ¯åœ¨åˆ†åŒºä¸­çš„å”¯ä¸€æ ‡è¯†ï¼Œkafka é€šè¿‡å®ƒæ¥ä¿è¯æ¶ˆæ¯åœ¨åˆ†åŒºå†…çš„é¡ºåºæ€§ï¼Œä¸è¿‡ offset å¹¶ä¸è·¨è¶Šåˆ†åŒºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œkafkaä¿è¯çš„æ˜¯åˆ†åŒºæœ‰åºè€Œä¸æ˜¯ä¸»é¢˜æœ‰åºã€‚

åœ¨åˆ†åŒºä¸­åˆå¼•å…¥äº†å¤šå‰¯æœ¬ï¼ˆreplicaï¼‰çš„æ¦‚å¿µï¼Œé€šè¿‡å¢åŠ å‰¯æœ¬æ•°é‡å¯ä»¥æé«˜å®¹ç¾èƒ½åŠ›ã€‚åŒä¸€åˆ†åŒºçš„ä¸åŒå‰¯æœ¬ä¸­ä¿å­˜çš„æ˜¯ç›¸åŒçš„æ¶ˆæ¯ã€‚å‰¯æœ¬ä¹‹é—´æ˜¯ä¸€ä¸»å¤šä»çš„å…³ç³»ï¼Œå…¶ä¸­ä¸»å‰¯æœ¬è´Ÿè´£è¯»å†™ï¼Œä»å‰¯æœ¬åªè´Ÿè´£æ¶ˆæ¯åŒæ­¥ã€‚å‰¯æœ¬å¤„äºä¸åŒçš„ broker ä¸­ï¼Œå½“ä¸»å‰¯æœ¬å‡ºç°å¼‚å¸¸ï¼Œä¾¿ä¼šåœ¨ä»å‰¯æœ¬ä¸­æå‡ä¸€ä¸ªä¸ºä¸»å‰¯æœ¬ã€‚

## 7ã€Kafka ä¸­åˆ†åŒºçš„åŸåˆ™

1.  æŒ‡æ˜Partitionçš„æƒ…å†µä¸‹ï¼Œç›´æ¥å°†æŒ‡æ˜çš„å€¼ä½œä¸ºPartitionå€¼
2.  æ²¡æœ‰æŒ‡æ˜Partitionå€¼ä½†æœ‰ key çš„æƒ…å†µä¸‹ï¼Œå°† key çš„ Hash å€¼ä¸ topic çš„Partitionå€¼è¿›è¡Œå–ä½™å¾—åˆ°Partitionå€¼
3.  æ—¢æ²¡æœ‰Partitionå€¼åˆæ²¡æœ‰ key å€¼çš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶éšæœºç”Ÿæˆä¸€ä¸ªæ•´æ•°ï¼ˆåé¢æ¯æ¬¡è°ƒç”¨åœ¨è¿™ä¸ªæ•´æ•°ä¸Šè‡ªå¢ï¼‰ï¼Œå°†è¿™ä¸ªå€¼ä¸Topicå¯ç”¨çš„Partitionæ€»æ•°å–ä½™å¾—åˆ°Parittionå€¼ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ round-robin ç®—æ³•

## 8ã€Kafka ä¸ºä»€ä¹ˆè¦æŠŠæ¶ˆæ¯åˆ†åŒº

1.  æ–¹ä¾¿åœ¨é›†ç¾¤ä¸­æ‰©å±•ï¼Œæ¯ä¸ª Partition å¯ç”¨é€šè¿‡è°ƒæ•´ä»¥é€‚åº”å®ƒæ‰€åœ¨çš„æœºå™¨ï¼Œè€Œä¸€ä¸ªTopicåˆå¯ä»¥æœ‰å¤šä¸ªPartitionç»„æˆï¼Œå› æ­¤æ•´ä¸ªé›†ç¾¤å°±å¯ä»¥é€‚åº”ä»»æ„å¤§å°çš„æ•°æ®äº†
2.  å¯ä»¥æé«˜å¹¶å‘ï¼Œå› ä¸ºå¯ä»¥ä»¥Partitionä¸ºå•ä½è¿›è¡Œè¯»å†™

## 9ã€Kafka ä¸­ç”Ÿäº§è€…è¿è¡Œæµç¨‹

1.  ä¸€æ¡æ¶ˆæ¯å‘è¿‡æ¥é¦–å…ˆä¼šè¢«å°è£…æˆä¸€ä¸ª ProducerRecord å¯¹è±¡
2.  å¯¹è¯¥å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–å¤„ç†ï¼ˆå¯ä»¥ä½¿ç”¨é»˜è®¤ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰åºåˆ—åŒ–ï¼‰
3.  å¯¹æ¶ˆæ¯è¿›è¡Œåˆ†åŒºå¤„ç†ï¼Œåˆ†åŒºçš„æ—¶å€™éœ€è¦è·å–é›†ç¾¤çš„å…ƒæ•°æ®ï¼Œå†³å®šè¿™ä¸ªæ¶ˆæ¯ä¼šè¢«å‘é€åˆ°å“ªä¸ªä¸»é¢˜çš„å“ªä¸ªåˆ†åŒº
4.  åˆ†å¥½åŒºçš„æ¶ˆæ¯ä¸ä¼šç›´æ¥å‘é€åˆ°æœåŠ¡ç«¯ï¼Œè€Œæ˜¯æ”¾å…¥ç”Ÿäº§è€…çš„ç¼“å­˜åŒºï¼Œå¤šæ¡æ¶ˆæ¯ä¼šè¢«å°è£…æˆä¸€ä¸ªæ‰¹æ¬¡ï¼ˆBatchï¼‰ï¼Œé»˜è®¤ä¸€ä¸ªæ‰¹æ¬¡çš„å¤§å°æ˜¯ 16KB
5.  Sender çº¿ç¨‹å¯åŠ¨ä»¥åä¼šä»ç¼“å­˜é‡Œé¢å»è·å–å¯ä»¥å‘é€çš„æ‰¹æ¬¡
6.  Sender çº¿ç¨‹æŠŠä¸€ä¸ªä¸€ä¸ªæ‰¹æ¬¡å‘é€åˆ°æœåŠ¡ç«¯

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-baogwdkafkamsgczhs-5ebd5e06-08cb-4c2d-9a84-b1fd15505f0a.jpg)

## 10ã€Kafka ä¸­çš„æ¶ˆæ¯å°è£…

åœ¨Kafka ä¸­ Producer å¯ä»¥ Batchçš„æ–¹å¼æ¨é€æ•°æ®è¾¾åˆ°æé«˜æ•ˆç‡çš„ä½œç”¨ã€‚Kafka Producer å¯ä»¥å°†æ¶ˆæ¯åœ¨å†…å­˜ä¸­ç´¯ç§¯åˆ°ä¸€å®šæ•°é‡åä½œä¸ºä¸€ä¸ª Batch å‘é€è¯·æ±‚ã€‚Batch çš„æ•°é‡å¤§å°å¯ä»¥é€šè¿‡ Producer çš„å‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œå¯ä»¥ä»ä¸‰ä¸ªç»´åº¦è¿›è¡Œæ§åˆ¶

*   ç´¯è®¡çš„æ¶ˆæ¯çš„æ•°é‡ï¼ˆå¦‚500æ¡ï¼‰
*   ç´¯è®¡çš„æ—¶é—´é—´éš”ï¼ˆå¦‚100msï¼‰
*   ç´¯è®¡çš„æ•°æ®å¤§å°ï¼ˆå¦‚64KBï¼‰

é€šè¿‡å¢åŠ  Batch çš„å¤§å°ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œè¯·æ±‚å’Œç£ç›˜I/Oçš„é¢‘æ¬¡ï¼Œå…·ä½“å‚æ•°é…ç½®éœ€è¦åœ¨æ•ˆç‡å’Œæ—¶æ•ˆæ€§åšä¸€ä¸ªæƒè¡¡ã€‚

## 11ã€Kafka æ¶ˆæ¯çš„æ¶ˆè´¹æ¨¡å¼

> Kafkaé‡‡ç”¨å¤§éƒ¨åˆ†æ¶ˆæ¯ç³»ç»Ÿéµå¾ªçš„ä¼ ç»Ÿæ¨¡å¼ï¼šProducerå°†æ¶ˆæ¯æ¨é€åˆ°Brokerï¼ŒConsumerä»Brokerè·å–æ¶ˆæ¯ã€‚

å¦‚æœé‡‡ç”¨ **Push** æ¨¡å¼ï¼Œåˆ™Consumeréš¾ä»¥å¤„ç†ä¸åŒé€Ÿç‡çš„ä¸Šæ¸¸æ¨é€æ¶ˆæ¯ã€‚

é‡‡ç”¨ Pull æ¨¡å¼çš„å¥½å¤„æ˜¯Consumerå¯ä»¥è‡ªä¸»å†³å®šæ˜¯å¦æ‰¹é‡çš„ä»Brokeræ‹‰å–æ•°æ®ã€‚Pullæ¨¡å¼æœ‰ä¸ªç¼ºç‚¹æ˜¯ï¼Œå¦‚æœBrokeræ²¡æœ‰å¯ä¾›æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œå°†å¯¼è‡´Consumerä¸æ–­åœ¨å¾ªç¯ä¸­è½®è¯¢ï¼Œç›´åˆ°æ–°æ¶ˆæ¯åˆ°è¾¾ã€‚ä¸ºäº†é¿å…è¿™ç‚¹ï¼ŒKafkaæœ‰ä¸ªå‚æ•°å¯ä»¥è®©Consumeré˜»å¡ç›´åˆ°æ–°æ¶ˆæ¯åˆ°è¾¾ã€‚

## 12ã€Kafka å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ä¸æ•…éšœè½¬ç§»

> è´Ÿè½½å‡è¡¡æ˜¯æŒ‡è®©ç³»ç»Ÿçš„è´Ÿè½½æ ¹æ®ä¸€å®šçš„è§„åˆ™å‡è¡¡åœ°åˆ†é…åœ¨æ‰€æœ‰å‚ä¸å·¥ä½œçš„æœåŠ¡å™¨ä¸Šï¼Œä»è€Œæœ€å¤§é™åº¦ä¿è¯ç³»ç»Ÿæ•´ä½“è¿è¡Œæ•ˆç‡ä¸ç¨³å®šæ€§

**è´Ÿè½½å‡è¡¡**

Kakfa çš„è´Ÿè½½å‡è¡¡å°±æ˜¯æ¯ä¸ª **Broker** éƒ½æœ‰å‡ç­‰çš„æœºä¼šä¸º Kafka çš„å®¢æˆ·ç«¯ï¼ˆç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ï¼‰æä¾›æœåŠ¡ï¼Œå¯ä»¥è´Ÿè½½åˆ†æ•£åˆ°æ‰€æœ‰é›†ç¾¤ä¸­çš„æœºå™¨ä¸Šã€‚Kafka é€šè¿‡æ™ºèƒ½åŒ–çš„åˆ†åŒºé¢†å¯¼è€…é€‰ä¸¾æ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œæä¾›æ™ºèƒ½åŒ–çš„ Leader é€‰ä¸¾ç®—æ³•ï¼Œå¯åœ¨é›†ç¾¤çš„æ‰€æœ‰æœºå™¨ä¸Šå‡åŒ€åˆ†æ•£å„ä¸ªPartitionçš„Leaderï¼Œä»è€Œæ•´ä½“ä¸Šå®ç°è´Ÿè½½å‡è¡¡ã€‚

**æ•…éšœè½¬ç§»**

Kafka çš„æ•…éšœè½¬ç§»æ˜¯é€šè¿‡ä½¿ç”¨**ä¼šè¯æœºåˆ¶**å®ç°çš„ï¼Œæ¯å° Kafka æœåŠ¡å™¨å¯åŠ¨åä¼šä»¥ä¼šè¯çš„å½¢å¼æŠŠè‡ªå·±æ³¨å†Œåˆ° Zookeeper æœåŠ¡å™¨ä¸Šã€‚ä¸€æ—¦æœåŠ¡å™¨è¿è½¬å‡ºç°é—®é¢˜ï¼Œå°±ä¼šå¯¼è‡´ä¸Zookeeper çš„ä¼šè¯ä¸èƒ½ç»´æŒä»è€Œè¶…æ—¶æ–­è¿ï¼Œæ­¤æ—¶Kafkaé›†ç¾¤ä¼šé€‰ä¸¾å‡ºå¦ä¸€å°æœåŠ¡å™¨æ¥å®Œå…¨æ›¿ä»£è¿™å°æœåŠ¡å™¨ç»§ç»­æä¾›æœåŠ¡ã€‚

## 13ã€Kafka ä¸­ Zookeeper çš„ä½œç”¨

Kafka æ˜¯ä¸€ä¸ªä½¿ç”¨ Zookeeper æ„å»ºçš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚Kafka çš„å„ Broker åœ¨å¯åŠ¨æ—¶éƒ½è¦åœ¨Zookeeperä¸Šæ³¨å†Œï¼Œç”±Zookeeperç»Ÿä¸€åè°ƒç®¡ç†ã€‚å¦‚æœä»»ä½•èŠ‚ç‚¹å¤±è´¥ï¼Œå¯é€šè¿‡Zookeeperä»å…ˆå‰æäº¤çš„åç§»é‡ä¸­æ¢å¤ï¼Œå› ä¸ºå®ƒä¼šåšå‘¨æœŸæ€§æäº¤åç§»é‡å·¥ä½œã€‚åŒä¸€ä¸ªTopicçš„æ¶ˆæ¯ä¼šè¢«åˆ†æˆå¤šä¸ªåˆ†åŒºå¹¶å°†å…¶åˆ†å¸ƒåœ¨å¤šä¸ªBrokerä¸Šï¼Œè¿™äº›åˆ†åŒºä¿¡æ¯åŠä¸Brokerçš„å¯¹åº”å…³ç³»ä¹Ÿæ˜¯Zookeeperåœ¨ç»´æŠ¤ã€‚

## 14ã€Kafka æä¾›äº†å“ªäº›ç³»ç»Ÿå·¥å…·

*   **Kafka è¿ç§»å·¥å…·**ï¼šå®ƒæœ‰åŠ©äºå°†ä»£ç†ä»ä¸€ä¸ªç‰ˆæœ¬è¿ç§»åˆ°å¦ä¸€ä¸ªç‰ˆæœ¬
*   **Mirror Maker**ï¼šMirror Maker å·¥å…·æœ‰åŠ©äºå°†ä¸€ä¸ª Kafka é›†ç¾¤çš„é•œåƒæä¾›ç»™å¦ä¸€ä¸ª
*   **æ¶ˆè´¹è€…æ£€æŸ¥**ï¼šå¯¹äºæŒ‡å®šçš„ä¸»é¢˜é›†å’Œæ¶ˆè´¹è€…ç»„ï¼Œå¯æ˜¾ç¤ºä¸»é¢˜ã€åˆ†åŒºã€æ‰€æœ‰è€…

## 15ã€Kafka ä¸­æ¶ˆè´¹è€…ä¸æ¶ˆè´¹è€…ç»„çš„å…³ç³»ä¸è´Ÿè½½å‡è¡¡å®ç°

Consumer Group æ˜¯Kafkaç‹¬æœ‰çš„å¯æ‰©å±•ä¸”å…·æœ‰å®¹é”™æ€§çš„æ¶ˆè´¹è€…æœºåˆ¶ã€‚ä¸€ä¸ªç»„å†…å¯ä»¥æœ‰å¤šä¸ªConsumerï¼Œå®ƒä»¬å…±äº«ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„Group IDã€‚ç»„å†…çš„æ‰€æœ‰Consumeråè°ƒåœ¨ä¸€èµ·æ¥æ¶ˆè´¹è®¢é˜…ä¸»é¢˜ï¼ˆTopicï¼‰å†…çš„æ‰€æœ‰åˆ†åŒºï¼ˆPartitionï¼‰ã€‚å½“ç„¶ï¼Œæ¯ä¸ªPartitionåªèƒ½ç”±åŒä¸€ä¸ªConsumer Groupå†…çš„ä¸€ä¸ªConsumer æ¥æ¶ˆè´¹ã€‚æ¶ˆè´¹ç»„å†…çš„æ¶ˆè´¹è€…å¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼å®ç°ï¼Œæ¶ˆè´¹è€…çš„æ•°é‡é€šå¸¸ä¸è¶…è¿‡åˆ†åŒºçš„æ•°é‡ï¼Œä¸”äºŒè€…æœ€å¥½ä¿æŒæ•´æ•°å€çš„å…³ç³»ï¼Œè¿™æ ·ä¸ä¼šé€ æˆæœ‰ç©ºé—²çš„æ¶ˆè´¹è€…ã€‚

> Consumer è®¢é˜…çš„æ˜¯Topicçš„Partitionï¼Œè€Œä¸æ˜¯Messageã€‚æ‰€ä»¥åœ¨åŒä¸€æ—¶é—´ç‚¹ä¸Šï¼Œè®¢é˜…åˆ°åŒä¸€ä¸ªåˆ†åŒºçš„Consumerå¿…ç„¶å±äºä¸åŒçš„Consumer Group

Consumer Groupä¸Consumerçš„å…³ç³»æ˜¯åŠ¨æ€ç»´æŠ¤çš„ï¼Œå½“ä¸€ä¸ªConsumerè¿›ç¨‹æŒ‚æ‰æˆ–è€…æ˜¯å¡ä½æ—¶ï¼Œè¯¥Consumeræ‰€è®¢é˜…çš„Partitionä¼šè¢«é‡æ–°åˆ†é…åˆ°æ”¹ç»„å†…çš„å…¶ä»–Consumerä¸Šï¼Œå½“ä¸€ä¸ªConsumeråŠ å…¥åˆ°ä¸€ä¸ªConsumer Groupä¸­æ—¶ï¼ŒåŒæ ·ä¼šä»å…¶ä»–çš„Consumerä¸­åˆ†é…å‡ºä¸€ä¸ªæˆ–è€…å¤šä¸ªPartitionåˆ°è¿™ä¸ªæ–°åŠ å…¥çš„Consumerã€‚

**è´Ÿè½½å‡è¡¡**

å½“å¯åŠ¨ä¸€ä¸ªConsumeræ—¶ï¼Œä¼šæŒ‡å®šå®ƒè¦åŠ å…¥çš„Groupï¼Œä½¿ç”¨çš„é…ç½®é¡¹æ˜¯ï¼šGroup.id

ä¸ºäº†ç»´æŒConsumerä¸Consumer Groupä¹‹é—´çš„å…³ç³»ï¼ŒConsumer ä¼šå‘¨æœŸæ€§åœ°å‘é€ hearbeat åˆ° coodinatorï¼ˆåè°ƒè€…ï¼‰ï¼Œå¦‚æœæœ‰ hearbeat è¶…æ—¶æˆ–æœªæ”¶åˆ° hearbeatï¼Œcoordinator ä¼šè®¤ä¸ºè¯¥Consumerå·²ç»é€€å‡ºï¼Œé‚£ä¹ˆå®ƒæ‰€è®¢é˜…çš„Partitionä¼šåˆ†é…åˆ°åŒä¸€ç»„å†…çš„å…¶ä»–Consumerä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º rebalanceï¼ˆå†å¹³è¡¡ï¼‰

## 16ã€Kafka ä¸­æ¶ˆæ¯åç§»çš„ä½œç”¨

ç”Ÿäº§è¿‡ç¨‹ä¸­ç»™åˆ†åŒºä¸­çš„æ¶ˆæ¯æä¾›ä¸€ä¸ªé¡ºåºIDå·ï¼Œç§°ä¹‹ä¸ºåç§»é‡ï¼Œåç§»é‡çš„ä¸»è¦ä½œç”¨ä¸ºäº†å”¯ä¸€åœ°åŒºåˆ«åˆ†åŒºä¸­çš„æ¯æ¡æ¶ˆæ¯ã€‚Kafkaçš„å­˜å‚¨æ–‡ä»¶éƒ½æ˜¯æŒ‰ç…§offset.kafkaæ¥å‘½å

## 17ã€ ç”Ÿäº§è¿‡ç¨‹ä¸­ä½•æ—¶ä¼šå‘ç”ŸQueueFullExpectionä»¥åŠå¦‚ä½•å¤„ç†

**ä½•æ—¶å‘ç”Ÿ**

å½“ç”Ÿäº§è€…è¯•å›¾å‘é€æ¶ˆæ¯çš„é€Ÿåº¦å¿«äºBrokerå¯ä»¥å¤„ç†çš„é€Ÿåº¦æ—¶ï¼Œé€šå¸¸ä¼šå‘ç”Ÿ **QueueFullException**

**å¦‚ä½•è§£å†³**

é¦–å…ˆå…ˆè¿›è¡Œåˆ¤æ–­ç”Ÿäº§è€…æ˜¯å¦èƒ½å¤Ÿé™ä½ç”Ÿäº§é€Ÿç‡ï¼Œå¦‚æœç”Ÿäº§è€…ä¸èƒ½é˜»æ­¢è¿™ç§æƒ…å†µï¼Œä¸ºäº†å¤„ç†å¢åŠ çš„è´Ÿè½½ï¼Œç”¨æˆ·éœ€è¦æ·»åŠ è¶³å¤Ÿçš„ Brokerã€‚æˆ–è€…é€‰æ‹©ç”Ÿäº§é˜»å¡ï¼Œè®¾ç½®`Queue.enQueueTimeout.ms` ä¸º -1ï¼Œé€šè¿‡è¿™æ ·å¤„ç†ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡çš„æƒ…å†µï¼Œç”Ÿäº§è€…å°†ç»„ç»‡è€Œä¸æ˜¯åˆ é™¤æ¶ˆæ¯ã€‚æˆ–è€…å®¹å¿è¿™ç§å¼‚å¸¸ï¼Œè¿›è¡Œæ¶ˆæ¯ä¸¢å¼ƒã€‚

## 18ã€Consumer å¦‚ä½•æ¶ˆè´¹æŒ‡å®šåˆ†åŒºæ¶ˆæ¯

Cosumer æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œæƒ³Broker å‘å‡º `fetch` è¯·æ±‚å»æ¶ˆè´¹ç‰¹å®šåˆ†åŒºçš„æ¶ˆæ¯ï¼ŒConsumer å¯ä»¥é€šè¿‡æŒ‡å®šæ¶ˆæ¯åœ¨æ—¥å¿—ä¸­çš„åç§»é‡ offsetï¼Œå°±å¯ä»¥ä»è¿™ä¸ªä½ç½®å¼€å§‹æ¶ˆæ¯æ¶ˆæ¯ï¼ŒConsumer æ‹¥æœ‰äº† offset çš„æ§åˆ¶æƒï¼Œä¹Ÿå¯ä»¥å‘åå›æ»šå»é‡æ–°æ¶ˆè´¹ä¹‹å‰çš„æ¶ˆæ¯ã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨ `seek(Long topicPartition)` æ¥æŒ‡å®šæ¶ˆè´¹çš„ä½ç½®ã€‚

## 19ã€Replicaã€Leader å’Œ Follower ä¸‰è€…çš„æ¦‚å¿µ

> Kafka ä¸­çš„ Partition æ˜¯æœ‰åºæ¶ˆæ¯æ—¥å¿—ï¼Œä¸ºäº†å®ç°é«˜å¯ç”¨æ€§ï¼Œéœ€è¦é‡‡ç”¨å¤‡ä»½æœºåˆ¶ï¼Œå°†ç›¸åŒçš„æ•°æ®å¤åˆ¶åˆ°å¤šä¸ªBrokerä¸Šï¼Œè€Œè¿™äº›å¤‡ä»½æ—¥å¿—å°±æ˜¯ Replicaï¼Œç›®çš„æ˜¯ä¸ºäº† **é˜²æ­¢æ•°æ®ä¸¢å¤±**ã€‚
> 
> æ‰€æœ‰Partition çš„å‰¯æœ¬é»˜è®¤æƒ…å†µä¸‹éƒ½ä¼šå‡åŒ€åœ°åˆ†å¸ƒåˆ°æ‰€æœ‰ Broker ä¸Š,ä¸€æ—¦é¢†å¯¼è€…å‰¯æœ¬æ‰€åœ¨çš„Brokerå®•æœºï¼ŒKafka ä¼šä»è¿½éšè€…å‰¯æœ¬ä¸­é€‰ä¸¾å‡ºæ–°çš„é¢†å¯¼è€…ç»§ç»­æä¾›æœåŠ¡ã€‚

**Leaderï¼š** å‰¯æœ¬ä¸­çš„é¢†å¯¼è€…ã€‚è´Ÿè´£å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¸å®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ã€‚ç”Ÿäº§è€…æ€»æ˜¯å‘ Leaderå‰¯æœ¬äº›æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ€»æ˜¯ä» Leader è¯»æ¶ˆæ¯

**Followerï¼š** å‰¯æœ¬ä¸­çš„è¿½éšè€…ã€‚è¢«åŠ¨åœ°è¿½éš Leaderï¼Œä¸èƒ½ä¸å¤–ç•Œè¿›è¡Œäº¤ä»˜ã€‚åªæ˜¯å‘Leaderå‘é€æ¶ˆæ¯ï¼Œè¯·æ±‚LeaderæŠŠæœ€æ–°ç”Ÿäº§çš„æ¶ˆæ¯å‘ç»™å®ƒï¼Œè¿›è€Œä¿æŒåŒæ­¥ã€‚

## 20ã€Replica çš„é‡è¦æ€§

Replica å¯ä»¥ç¡®ä¿å‘å¸ƒçš„æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œä¿è¯äº†Kafkaçš„é«˜å¯ç”¨æ€§ã€‚å¹¶ä¸”å¯ä»¥åœ¨å‘ç”Ÿä»»ä½•æœºå™¨é”™è¯¯ã€ç¨‹åºé”™è¯¯æˆ–è½¯ä»¶å‡çº§ã€æ‰©å®¹æ—¶éƒ½èƒ½ç”Ÿäº§ä½¿ç”¨ã€‚

## 21ã€Kafka ä¸­çš„ Geo-Replication æ˜¯ä»€ä¹ˆ

Kafkaå®˜æ–¹æä¾›äº†MirrorMakerç»„ä»¶ï¼Œä½œä¸ºè·¨é›†ç¾¤çš„æµæ•°æ®åŒæ­¥æ–¹æ¡ˆã€‚å€ŸåŠ©MirrorMakerï¼Œæ¶ˆæ¯å¯ä»¥è·¨å¤šä¸ªæ•°æ®ä¸­å¿ƒæˆ–äº‘åŒºåŸŸè¿›è¡Œå¤åˆ¶ã€‚æ‚¨å¯ä»¥åœ¨ä¸»åŠ¨/è¢«åŠ¨åœºæ™¯ä¸­å°†å…¶ç”¨äºå¤‡ä»½å’Œæ¢å¤ï¼Œæˆ–è€…åœ¨ä¸»åŠ¨/ä¸»åŠ¨æ–¹æ¡ˆä¸­å°†æ•°æ®æ”¾ç½®å¾—æ›´é è¿‘ç”¨æˆ·ï¼Œæˆ–æ”¯æŒæ•°æ®æœ¬åœ°åŒ–è¦æ±‚ã€‚

å®ƒçš„å®ç°åŸç†æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é€šè¿‡ä»æºé›†ç¾¤æ¶ˆè´¹æ¶ˆæ¯ï¼Œç„¶åå°†æ¶ˆæ¯ç”Ÿäº§åˆ°ç›®æ ‡é›†ç¾¤ï¼Œå³æ™®é€šçš„æ¶ˆæ¯ç”Ÿäº§å’Œæ¶ˆè´¹ã€‚ç”¨æˆ·åªè¦é€šè¿‡ç®€å•çš„Consumeré…ç½®å’ŒProduceré…ç½®ï¼Œç„¶åå¯åŠ¨Mirrorï¼Œå°±å¯ä»¥å®ç°é›†ç¾¤ä¹‹é—´çš„å‡†å®æ—¶çš„æ•°æ®åŒæ­¥.

## 22ã€Kafka ä¸­ ARã€ISRã€OSR ä¸‰è€…çš„æ¦‚å¿µ

*   `AR`ï¼šåˆ†åŒºä¸­æ‰€æœ‰å‰¯æœ¬ç§°ä¸º AR
*   `ISR`ï¼šæ‰€æœ‰ä¸ä¸»å‰¯æœ¬ä¿æŒä¸€å®šç¨‹åº¦åŒæ­¥çš„å‰¯æœ¬ï¼ˆåŒ…æ‹¬ä¸»å‰¯æœ¬ï¼‰ç§°ä¸º ISR
*   `OSR`ï¼šä¸ä¸»å‰¯æœ¬æ»åè¿‡å¤šçš„å‰¯æœ¬ç»„æˆ OSR

## 23ã€åˆ†åŒºå‰¯æœ¬ä»€ä¹ˆæƒ…å†µä¸‹ä¼šä» ISR ä¸­å‰”å‡º

Leader ä¼šç»´æŠ¤ä¸€ä¸ªä¸è‡ªå·±åŸºæœ¬ä¿æŒåŒæ­¥çš„Replicaåˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨ç§°ä¸ºISRï¼Œæ¯ä¸ªPartitionéƒ½ä¼šæœ‰ä¸€ä¸ªISRï¼Œè€Œä¸”æ˜¯ç”±LeaderåŠ¨æ€ç»´æŠ¤ã€‚æ‰€è°“åŠ¨æ€ç»´æŠ¤ï¼Œå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªFolloweræ¯”ä¸€ä¸ªLeaderè½åå¤ªå¤šï¼Œæˆ–è€…è¶…è¿‡ä¸€å®šæ—¶é—´æœªå‘èµ·æ•°æ®å¤åˆ¶è¯·æ±‚ï¼Œåˆ™Leaderå°†å…¶ä»ISRä¸­ç§»é™¤ã€‚å½“ISRä¸­æ‰€æœ‰Replicaéƒ½å‘Leaderå‘é€ACKï¼ˆAcknowledgementç¡®è®¤ï¼‰æ—¶ï¼ŒLeaderæ‰commitã€‚

## 24ã€åˆ†åŒºå‰¯æœ¬ä¸­çš„ Leader å¦‚æœå®•æœºä½† ISR å´ä¸ºç©ºè¯¥å¦‚ä½•å¤„ç†

å¯ä»¥é€šè¿‡é…ç½®`unclean.leader.election` ï¼š

*   **true**ï¼šå…è®¸ OSR æˆä¸º Leaderï¼Œä½†æ˜¯ OSR çš„æ¶ˆæ¯è¾ƒä¸ºæ»åï¼Œå¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ä¸ä¸€è‡´çš„é—®é¢˜
*   **false**ï¼šä¼šä¸€ç›´ç­‰å¾…æ—§ leader æ¢å¤æ­£å¸¸ï¼Œé™ä½äº†å¯ç”¨æ€§

## 25ã€å¦‚ä½•åˆ¤æ–­ä¸€ä¸ª Broker æ˜¯å¦è¿˜æœ‰æ•ˆ

1.  Brokerå¿…é¡»å¯ä»¥ç»´æŠ¤å’ŒZooKeeperçš„è¿æ¥ï¼ŒZookeeperé€šè¿‡å¿ƒè·³æœºåˆ¶æ£€æŸ¥æ¯ä¸ªç»“ç‚¹çš„è¿æ¥ã€‚
2.  å¦‚æœBrokeræ˜¯ä¸ªFollowerï¼Œå®ƒå¿…é¡»èƒ½åŠæ—¶åŒæ­¥Leaderçš„å†™æ“ä½œï¼Œå»¶æ—¶ä¸èƒ½å¤ªä¹…ã€‚

## 26ã€Kafka å¯æ¥æ”¶çš„æ¶ˆæ¯æœ€å¤§é»˜è®¤å¤šå°‘å­—èŠ‚ï¼Œå¦‚ä½•ä¿®æ”¹

Kafkaå¯ä»¥æ¥æ”¶çš„æœ€å¤§æ¶ˆæ¯é»˜è®¤ä¸º**1000000**å­—èŠ‚ï¼Œå¦‚æœæƒ³è°ƒæ•´å®ƒçš„å¤§å°ï¼Œå¯åœ¨Brokerä¸­ä¿®æ”¹é…ç½®å‚æ•°ï¼š`Message.max.bytes`çš„å€¼

> ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œä¿®æ”¹è¿™ä¸ªå€¼ï¼Œè¿˜è¦åŒæ—¶æ³¨æ„å…¶ä»–å¯¹åº”çš„å‚æ•°å€¼æ˜¯æ­£ç¡®çš„ï¼Œå¦åˆ™å°±å¯èƒ½å¼•å‘ä¸€äº›ç³»ç»Ÿå¼‚å¸¸ã€‚é¦–å…ˆè¿™ä¸ªå€¼è¦æ¯”æ¶ˆè´¹ç«¯çš„fetch.Message.max.bytesï¼ˆé»˜è®¤å€¼1MBï¼Œè¡¨ç¤ºæ¶ˆè´¹è€…èƒ½è¯»å–çš„æœ€å¤§æ¶ˆæ¯çš„å­—èŠ‚æ•°ï¼‰å‚æ•°å€¼è¦å°æ‰æ˜¯æ­£ç¡®çš„è®¾ç½®ï¼Œå¦åˆ™Brokerå°±ä¼šå› ä¸ºæ¶ˆè´¹ç«¯æ— æ³•ä½¿ç”¨è¿™ä¸ªæ¶ˆæ¯è€ŒæŒ‚èµ·ã€‚

## 27ã€Kafka çš„ ACK æœºåˆ¶

> Kafkaçš„Produceræœ‰ä¸‰ç§ackæœºåˆ¶ï¼Œå‚æ•°å€¼æœ‰0ã€1 å’Œ -1

*   **0ï¼š** ç›¸å½“äºå¼‚æ­¥æ“ä½œï¼ŒProducer ä¸éœ€è¦Leaderç»™äºˆå›å¤ï¼Œå‘é€å®Œå°±è®¤ä¸ºæˆåŠŸï¼Œç»§ç»­å‘é€ä¸‹ä¸€æ¡ï¼ˆæ‰¹ï¼‰Messageã€‚**æ­¤æœºåˆ¶å…·æœ‰æœ€ä½å»¶è¿Ÿï¼Œä½†æ˜¯æŒä¹…æ€§å¯é æ€§ä¹Ÿæœ€å·®ï¼Œå½“æœåŠ¡å™¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œå¾ˆå¯èƒ½å‘ç”Ÿæ•°æ®ä¸¢å¤±ã€‚**
*   **1ï¼š** Kafka é»˜è®¤çš„è®¾ç½®ã€‚è¡¨ç¤º Producer è¦ Leader ç¡®è®¤å·²æˆåŠŸæ¥æ”¶æ•°æ®æ‰å‘é€ä¸‹ä¸€æ¡ï¼ˆæ‰¹ï¼‰Messageã€‚ä¸è¿‡ Leader å®•æœºï¼ŒFollower å°šæœªå¤åˆ¶çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å°±ä¼šä¸¢å¤±ã€‚**æ­¤æœºåˆ¶æä¾›äº†è¾ƒå¥½çš„æŒä¹…æ€§å’Œè¾ƒä½çš„å»¶è¿Ÿæ€§ã€‚**
*   **\-1ï¼š** Leader æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œè¿˜å¿…é¡»è¦æ±‚ISRåˆ—è¡¨é‡Œè·ŸLeaderä¿æŒåŒæ­¥çš„é‚£äº›Followeréƒ½ç¡®è®¤æ¶ˆæ¯å·²åŒæ­¥ï¼ŒProducer æ‰å‘é€ä¸‹ä¸€æ¡ï¼ˆæ‰¹ï¼‰Messageã€‚**æ­¤æœºåˆ¶æŒä¹…æ€§å¯é æ€§æœ€å¥½ï¼Œä½†å»¶æ—¶æ€§æœ€å·®ã€‚**

## 28ã€Kafka çš„ consumer å¦‚ä½•æ¶ˆè´¹æ•°æ®

åœ¨Kafkaä¸­ï¼ŒProducerså°†æ¶ˆæ¯æ¨é€ç»™Brokerç«¯ï¼Œåœ¨Consumerå’ŒBrokerå»ºç«‹è¿æ¥ä¹‹åï¼Œä¼šä¸»åŠ¨å» Pullï¼ˆæˆ–è€…è¯´Fetchï¼‰æ¶ˆæ¯ã€‚è¿™ç§æ¨¡å¼æœ‰äº›ä¼˜ç‚¹ï¼Œé¦–å…ˆConsumerç«¯å¯ä»¥æ ¹æ®è‡ªå·±çš„æ¶ˆè´¹èƒ½åŠ›é€‚æ—¶çš„å»fetchæ¶ˆæ¯å¹¶å¤„ç†ï¼Œä¸”å¯ä»¥æ§åˆ¶æ¶ˆæ¯æ¶ˆè´¹çš„è¿›åº¦ï¼ˆoffsetï¼‰ï¼›æ­¤å¤–ï¼Œæ¶ˆè´¹è€…å¯ä»¥æ§åˆ¶æ¯æ¬¡æ¶ˆè´¹çš„æ•°ï¼Œå®ç°æ‰¹é‡æ¶ˆè´¹ã€‚

## 29ã€Kafka æä¾›çš„APIæœ‰å“ªäº›

Kafka æä¾›äº†ä¸¤å¥— Consumer APIï¼Œåˆ†ä¸º **High-level API** å’Œ **Sample API**

**Sample API**

è¿™æ˜¯ä¸€ä¸ªåº•å±‚APIï¼Œå®ƒç»´æŒäº†ä¸€ä¸ªä¸å•ä¸€ Broker çš„è¿æ¥ï¼Œå¹¶ä¸”è¿™ä¸ªAPI æ˜¯å®Œå…¨æ— çŠ¶æ€çš„ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦æŒ‡å®š offset å€¼ï¼Œå› æ­¤è¿™å¥— API ä¹Ÿæ˜¯æœ€çµæ´»çš„ã€‚

**High-level API**

è¯¥APIå°è£…äº†å¯¹é›†ç¾¤ä¸­ä¸€ç³»åˆ—Brokerçš„è®¿é—®ï¼Œå¯ä»¥é€æ˜åœ°æ¶ˆè´¹ä¸‹ä¸€ä¸ªTopicï¼Œå®ƒè‡ªå·±ç»´æŠ¤äº†å·²æ¶ˆè´¹æ¶ˆæ¯çš„çŠ¶æ€ï¼Œå³æ¯æ¬¡æ¶ˆè´¹çš„éƒ½ä¼šä¸‹ä¸€ä¸ªæ¶ˆæ¯ã€‚High-level API è¿˜æ”¯æŒä»¥ç»„çš„å½¢å¼æ¶ˆè´¹Topicï¼Œå¦‚æœ Consumers æœ‰åŒä¸€ä¸ªç»„åï¼Œé‚£ä¹ˆKafkaå°±ç›¸å½“äºä¸€ä¸ªé˜Ÿåˆ—æ¶ˆæ¯æœåŠ¡ï¼Œè€Œå„ä¸ª Consumer å‡è¡¡åœ°æ¶ˆè´¹ç›¸åº”Partitionä¸­çš„æ•°æ®ã€‚è‹¥Consumersæœ‰ä¸åŒçš„ç»„åï¼Œé‚£ä¹ˆæ­¤æ—¶Kafkaå°±ç›¸å½“äºä¸€ä¸ªå¹¿æ’­æœåŠ¡ï¼Œä¼šæŠŠTopicä¸­çš„æ‰€æœ‰æ¶ˆæ¯å¹¿æ’­åˆ°æ¯ä¸ªConsumer

## 30ã€Kafka çš„Topicä¸­ Partition æ•°æ®æ˜¯æ€ä¹ˆå­˜å‚¨åˆ°ç£ç›˜çš„

Topic ä¸­çš„å¤šä¸ª Partition ä»¥æ–‡ä»¶å¤¹çš„å½¢å¼ä¿å­˜åˆ° Brokerï¼Œæ¯ä¸ªåˆ†åŒºåºå·ä»0é€’å¢ï¼Œä¸”æ¶ˆæ¯æœ‰åºã€‚Partition æ–‡ä»¶ä¸‹æœ‰å¤šä¸ªSegmentï¼ˆxxx.indexï¼Œxxx.logï¼‰ï¼ŒSegmentæ–‡ä»¶é‡Œçš„å¤§å°å’Œé…ç½®æ–‡ä»¶å¤§å°ä¸€è‡´ã€‚é»˜è®¤ä¸º1GBï¼Œä½†å¯ä»¥æ ¹æ®å®é™…éœ€è¦ä¿®æ”¹ã€‚å¦‚æœå¤§å°å¤§äº1GBæ—¶ï¼Œä¼šæ»šåŠ¨ä¸€ä¸ªæ–°çš„Segmentå¹¶ä¸”ä»¥ä¸Šä¸€ä¸ªSegmentæœ€åä¸€æ¡æ¶ˆæ¯çš„åç§»é‡å‘½åã€‚

## 31ã€Kafka åˆ›å»ºTopicåå¦‚ä½•å°†åˆ†åŒºæ”¾ç½®åˆ°ä¸åŒçš„ Broker ä¸­

Kafkaåˆ›å»ºTopicå°†åˆ†åŒºæ”¾ç½®åˆ°ä¸åŒçš„Brokeræ—¶éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

1.  å‰¯æœ¬å› å­ä¸èƒ½å¤§äºBrokerçš„ä¸ªæ•°ã€‚
2.  ç¬¬ä¸€ä¸ªåˆ†åŒºï¼ˆç¼–å·ä¸º0ï¼‰çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬æ”¾ç½®ä½ç½®æ˜¯éšæœºä»Broker Listä¸­é€‰æ‹©çš„ã€‚
3.  å…¶ä»–åˆ†åŒºçš„ç¬¬ä¸€ä¸ªå‰¯æœ¬æ”¾ç½®ä½ç½®ç›¸å¯¹äºç¬¬0ä¸ªåˆ†åŒºä¾æ¬¡å¾€åç§»ã€‚ä¹Ÿå°±æ˜¯å¦‚æœæœ‰3ä¸ªBrokerï¼Œ3ä¸ªåˆ†åŒºï¼Œå‡è®¾ç¬¬ä¸€ä¸ªåˆ†åŒºæ”¾åœ¨ç¬¬äºŒä¸ªBrokerä¸Šï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªåˆ†åŒºå°†ä¼šæ”¾åœ¨ç¬¬ä¸‰ä¸ªBrokerä¸Šï¼›ç¬¬ä¸‰ä¸ªåˆ†åŒºå°†ä¼šæ”¾åœ¨ç¬¬ä¸€ä¸ªBrokerä¸Šï¼Œæ›´å¤šBrokerä¸æ›´å¤šåˆ†åŒºä¾æ­¤ç±»æ¨ã€‚å‰©ä½™çš„å‰¯æœ¬ç›¸å¯¹äºç¬¬ä¸€ä¸ªå‰¯æœ¬æ”¾ç½®ä½ç½®å…¶å®æ˜¯ç”±`nextReplicaShift`å†³å®šçš„ï¼Œè€Œè¿™ä¸ªæ•°ä¹Ÿæ˜¯éšæœºäº§ç”Ÿçš„ã€‚

## 32ã€Kafka çš„æ—¥å¿—ä¿ç•™æœŸä¸æ•°æ®æ¸…ç†ç­–ç•¥

**æ¦‚å¿µ**

ä¿ç•™æœŸå†…ä¿ç•™äº†Kafkaç¾¤é›†ä¸­çš„æ‰€æœ‰å·²å‘å¸ƒæ¶ˆæ¯ï¼Œè¶…è¿‡ä¿æœŸçš„æ•°æ®å°†è¢«æŒ‰æ¸…ç†ç­–ç•¥è¿›è¡Œæ¸…ç†ã€‚é»˜è®¤ä¿ç•™æ—¶é—´æ˜¯7å¤©ï¼Œå¦‚æœæƒ³ä¿®æ”¹æ—¶é—´ï¼Œåœ¨`server.properties`é‡Œæ›´æ”¹å‚æ•°`log.retention.hours/minutes/ms` çš„å€¼ä¾¿å¯ã€‚

**æ¸…ç†ç­–ç•¥**

*   **åˆ é™¤ï¼š** `log.cleanup.policy=delete` è¡¨ç¤ºå¯ç”¨åˆ é™¤ç­–ç•¥ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤ç­–ç•¥ã€‚ä¸€å¼€å§‹åªæ˜¯æ ‡è®°ä¸ºdeleteï¼Œæ–‡ä»¶æ— æ³•è¢«ç´¢å¼•ã€‚åªæœ‰è¿‡äº†`log.Segment.delete.delay.ms`è¿™ä¸ªå‚æ•°è®¾ç½®çš„æ—¶é—´ï¼Œæ‰ä¼šçœŸæ­£è¢«åˆ é™¤ã€‚
*   **å‹ç¼©ï¼š** `log.cleanup.policy=compact` è¡¨ç¤ºå¯ç”¨å‹ç¼©ç­–ç•¥ï¼Œå°†æ•°æ®å‹ç¼©ï¼Œåªä¿ç•™æ¯ä¸ªKeyæœ€åä¸€ä¸ªç‰ˆæœ¬çš„æ•°æ®ã€‚é¦–å…ˆåœ¨Brokerçš„é…ç½®ä¸­è®¾ç½®`log.cleaner.enable=true` å¯ç”¨ cleanerï¼Œè¿™ä¸ªé»˜è®¤æ˜¯å…³é—­çš„ã€‚

## 33ã€Kafka æ—¥å¿—å­˜å‚¨çš„Messageæ˜¯ä»€ä¹ˆæ ¼å¼

Kafkaä¸€ä¸ªMessageç”±**å›ºå®šé•¿åº¦çš„header**å’Œ**ä¸€ä¸ªå˜é•¿çš„æ¶ˆæ¯ä½“body**ç»„æˆã€‚å°†Messageå­˜å‚¨åœ¨æ—¥å¿—æ—¶é‡‡ç”¨ä¸åŒäºProducerå‘é€çš„æ¶ˆæ¯æ ¼å¼ã€‚æ¯ä¸ªæ—¥å¿—æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªlog entriesï¼ˆæ—¥å¿—é¡¹ï¼‰åºåˆ—ï¼š

1.  æ¯ä¸€ä¸ªlog entryåŒ…å«ä¸€ä¸ªå››å­—èŠ‚æ•´å‹æ•°ï¼ˆMessageé•¿åº¦ï¼Œå€¼ä¸º1+4+Nï¼‰ã€‚
2.  1ä¸ªå­—èŠ‚çš„magicï¼Œmagicè¡¨ç¤ºæœ¬æ¬¡å‘å¸ƒKafkaæœåŠ¡ç¨‹åºåè®®ç‰ˆæœ¬å·ã€‚
3.  4ä¸ªå­—èŠ‚çš„CRC32å€¼ï¼ŒCRC32ç”¨äºæ ¡éªŒMessageã€‚
4.  æœ€ç»ˆæ˜¯Nä¸ªå­—èŠ‚çš„æ¶ˆæ¯æ•°æ®ã€‚æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªå½“å‰Partitionä¸‹å”¯ä¸€çš„64ä½offsetã€‚

> Kafkaæ²¡æœ‰é™å®šå•ä¸ªæ¶ˆæ¯çš„å¤§å°ï¼Œä½†ä¸€èˆ¬æ¨èæ¶ˆæ¯å¤§å°ä¸è¦è¶…è¿‡1MBï¼Œé€šå¸¸ä¸€èˆ¬æ¶ˆæ¯å¤§å°éƒ½åœ¨1ï½10KBä¹‹é—´ã€‚

## 34ã€Kafka æ˜¯å¦æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»

> å¤šç§Ÿæˆ·æŠ€æœ¯ï¼ˆmulti-tenancy technologyï¼‰æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„æŠ€æœ¯ï¼Œå®ƒæ˜¯å®ç°å¦‚ä½•åœ¨å¤šç”¨æˆ·çš„ç¯å¢ƒä¸‹å…±ç”¨ç›¸åŒçš„ç³»ç»Ÿæˆ–ç¨‹åºç»„ä»¶ï¼Œå¹¶ä¸”ä»å¯ç¡®ä¿å„ç”¨æˆ·é—´æ•°æ®çš„éš”ç¦»æ€§ã€‚

**è§£å†³æ–¹æ¡ˆ**

é€šè¿‡é…ç½®å“ªä¸ªä¸»é¢˜å¯ä»¥ç”Ÿäº§æˆ–æ¶ˆè´¹æ•°æ®æ¥å¯ç”¨å¤šç§Ÿæˆ·ï¼Œä¹Ÿæœ‰å¯¹é…é¢çš„æ“ä½œæ”¯æŒã€‚ç®¡ç†å‘˜å¯ä»¥å¯¹è¯·æ±‚å®šä¹‰å’Œå¼ºåˆ¶é…é¢ï¼Œä»¥æ§åˆ¶å®¢æˆ·ç«¯ä½¿ç”¨çš„Brokerèµ„æºã€‚

## 35ã€Kafka çš„æ—¥å¿—åˆ†æ®µç­–ç•¥ä¸åˆ·æ–°ç­–ç•¥

**æ—¥å¿—åˆ†æ®µï¼ˆSegmentï¼‰ç­–ç•¥**

1.  `log.roll.hours/ms`ï¼šæ—¥å¿—æ»šåŠ¨çš„å‘¨æœŸæ—¶é—´ï¼Œåˆ°è¾¾æŒ‡å®šå‘¨æœŸæ—¶é—´æ—¶ï¼Œå¼ºåˆ¶ç”Ÿæˆä¸€ä¸ªæ–°çš„Segmentï¼Œé»˜è®¤å€¼168hï¼ˆ7dayï¼‰ã€‚
2.  `log.Segment.bytes`ï¼šæ¯ä¸ªSegmentçš„æœ€å¤§å®¹é‡ã€‚åˆ°è¾¾æŒ‡å®šå®¹é‡æ—¶ï¼Œå°†å¼ºåˆ¶ç”Ÿæˆä¸€ä¸ªæ–°çš„Segmentã€‚é»˜è®¤å€¼1GBï¼ˆ-1ä»£è¡¨ä¸é™åˆ¶ï¼‰ã€‚
3.  `log.retention.check.interval.ms`ï¼šæ—¥å¿—ç‰‡æ®µæ–‡ä»¶æ£€æŸ¥çš„å‘¨æœŸæ—¶é—´ã€‚é»˜è®¤å€¼60000msã€‚

**æ—¥å¿—åˆ·æ–°ç­–ç•¥**

Kafkaçš„æ—¥å¿—å®é™…ä¸Šæ˜¯å¼€å§‹æ˜¯åœ¨ç¼“å­˜ä¸­çš„ï¼Œç„¶åæ ¹æ®å®é™…å‚æ•°é…ç½®çš„ç­–ç•¥å®šæœŸä¸€æ‰¹ä¸€æ‰¹å†™å…¥åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä»¥æé«˜ååé‡ã€‚

1.  `log.flush.interval.Messages`ï¼šæ¶ˆæ¯è¾¾åˆ°å¤šå°‘æ¡æ—¶å°†æ•°æ®å†™å…¥åˆ°æ—¥å¿—æ–‡ä»¶ã€‚é»˜è®¤å€¼ä¸º10000ã€‚
2.  `log.flush.interval.ms`ï¼šå½“è¾¾åˆ°è¯¥æ—¶é—´æ—¶ï¼Œå¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡flushã€‚é»˜è®¤å€¼ä¸ºnullã€‚
3.  `log.flush.scheduler.interval.ms`ï¼šå‘¨æœŸæ€§æ£€æŸ¥ï¼Œæ˜¯å¦éœ€è¦å°†ä¿¡æ¯flushã€‚é»˜è®¤ä¸ºå¾ˆå¤§çš„å€¼ã€‚

## 36ã€Kafka ä¸­å¦‚ä½•è¿›è¡Œä¸»ä»åŒæ­¥

> KafkaåŠ¨æ€ç»´æŠ¤äº†ä¸€ä¸ªåŒæ­¥çŠ¶æ€çš„å‰¯æœ¬çš„é›†åˆï¼ˆa set of In-SyncReplicasï¼‰ï¼Œç®€ç§°ISRï¼Œåœ¨è¿™ä¸ªé›†åˆä¸­çš„ç»“ç‚¹éƒ½æ˜¯å’ŒLeaderä¿æŒé«˜åº¦ä¸€è‡´çš„ï¼Œä»»ä½•ä¸€æ¡æ¶ˆæ¯åªæœ‰è¢«è¿™ä¸ªé›†åˆä¸­çš„æ¯ä¸ªç»“ç‚¹è¯»å–å¹¶è¿½åŠ åˆ°æ—¥å¿—ä¸­ï¼Œæ‰ä¼šå‘å¤–éƒ¨é€šçŸ¥â€œè¿™ä¸ªæ¶ˆæ¯å·²ç»è¢«æäº¤â€ã€‚

kafka é€šè¿‡é…ç½® `producer.type` æ¥ç¡®å®šæ˜¯å¼‚æ­¥è¿˜æ˜¯åŒæ­¥ï¼Œé»˜è®¤æ˜¯åŒæ­¥

**åŒæ­¥å¤åˆ¶**

Producer ä¼šå…ˆé€šè¿‡Zookeeperè¯†åˆ«åˆ°Leaderï¼Œç„¶åå‘ Leader å‘é€æ¶ˆæ¯ï¼ŒLeader æ”¶åˆ°æ¶ˆæ¯åå†™å…¥åˆ°æœ¬åœ° logæ–‡ä»¶ã€‚è¿™ä¸ªæ—¶å€™Follower å†å‘ Leader Pull æ¶ˆæ¯ï¼ŒPull å›æ¥çš„æ¶ˆæ¯ä¼šå†™å…¥çš„æœ¬åœ° log ä¸­ï¼Œå†™å…¥å®Œæˆåä¼šå‘ Leader å‘é€ Ack å›æ‰§ï¼Œç­‰åˆ° Leader æ”¶åˆ°æ‰€æœ‰ Follower çš„å›æ‰§ä¹‹åï¼Œæ‰ä¼šå‘ Producer å›ä¼  Ackã€‚

**å¼‚æ­¥å¤åˆ¶**

Kafka ä¸­ Producer å¼‚æ­¥å‘é€æ¶ˆæ¯æ˜¯åŸºäºåŒæ­¥å‘é€æ¶ˆæ¯çš„æ¥å£æ¥å®ç°çš„ï¼Œå¼‚æ­¥å‘é€æ¶ˆæ¯çš„å®ç°å¾ˆç®€å•ï¼Œå®¢æˆ·ç«¯æ¶ˆæ¯å‘é€è¿‡æ¥ä»¥åï¼Œä¼šå…ˆæ”¾å…¥ä¸€ä¸ª `BlackingQueue` é˜Ÿåˆ—ä¸­ç„¶åå°±è¿”å›äº†ã€‚Producer å†å¼€å¯ä¸€ä¸ªçº¿ç¨‹ `ProducerSendTread` ä¸æ–­ä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨åŒæ­¥å‘é€æ¶ˆæ¯çš„æ¥å£å°†æ¶ˆæ¯å‘é€ç»™ Brokerã€‚

> Producerçš„è¿™ç§åœ¨å†…å­˜ç¼“å­˜æ¶ˆæ¯ï¼Œå½“ç´¯è®¡è¾¾åˆ°é˜€å€¼æ—¶æ‰¹é‡å‘é€è¯·æ±‚ï¼Œå°æ•°æ®I/Oå¤ªå¤šï¼Œä¼šæ‹–æ…¢æ•´ä½“çš„ç½‘ç»œå»¶è¿Ÿï¼Œæ‰¹é‡å»¶è¿Ÿå‘é€äº‹å®ä¸Šæå‡äº†ç½‘ç»œæ•ˆç‡ã€‚ä½†æ˜¯å¦‚æœåœ¨è¾¾åˆ°é˜€å€¼å‰ï¼ŒProducerä¸å¯ç”¨äº†ï¼Œç¼“å­˜çš„æ•°æ®å°†ä¼šä¸¢å¤±ã€‚

## 37ã€Kafka ä¸­ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±/ä¸ä¸€è‡´çš„é—®é¢˜

**æ¶ˆæ¯å‘é€æ—¶**

æ¶ˆæ¯å‘é€æœ‰ä¸¤ç§æ–¹å¼ï¼š`åŒæ­¥ - sync` å’Œ `å¼‚æ­¥ - async`ã€‚é»˜è®¤æ˜¯åŒæ­¥çš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡ producer.type å±æ€§è¿›è¡Œé…ç½®ï¼Œkafka ä¹Ÿå¯ä»¥é€šè¿‡é…ç½® acks å±æ€§æ¥ç¡®è®¤æ¶ˆæ¯çš„ç”Ÿäº§

*   `0`ï¼šè¡¨ç¤ºä¸è¿›è¡Œæ¶ˆæ¯æ¥æ”¶æ˜¯å¦æˆåŠŸçš„ç¡®è®¤
*   `1`ï¼šè¡¨ç¤ºå½“ leader æ¥æ”¶æˆåŠŸæ—¶çš„ç¡®è®¤
*   `-1`ï¼šè¡¨ç¤º leader å’Œ follower éƒ½æ¥æ”¶æˆåŠŸçš„ç¡®è®¤

å½“ acks = 0 æ—¶ï¼Œä¸å’Œ Kafka è¿›è¡Œæ¶ˆæ¯æ¥æ”¶ç¡®è®¤ï¼Œå¯èƒ½ä¼šå› ä¸ºç½‘ç»œå¼‚å¸¸ï¼Œç¼“å†²åŒºæ»¡çš„é—®é¢˜ï¼Œå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±

å½“ acks = 1 æ—¶ï¼Œåªæœ‰ leader åŒæ­¥æˆåŠŸè€Œ follower å°šæœªå®ŒæˆåŒæ­¥ï¼Œå¦‚æœ leader æŒ‚äº†ï¼Œå°±ä¼šé€ æˆæ•°æ®ä¸¢å¤±

**æ¶ˆæ¯æ¶ˆè´¹æ—¶**

Kafka æœ‰ä¸¤ä¸ªæ¶ˆæ¯æ¶ˆè´¹çš„ consumer æ¥å£ï¼Œåˆ†åˆ«æ˜¯ `low-level` å’Œ `hign-level`

1.  `low-level`ï¼šæ¶ˆè´¹è€…è‡ªå·±ç»´æŠ¤ offset ç­‰å€¼ï¼Œå¯ä»¥å®ç°å¯¹ kafka çš„å®Œå…¨æ§åˆ¶
2.  `high-level`ï¼šå°è£…äº†å¯¹ partition å’Œ offsetï¼Œä½¿ç”¨ç®€å•

å¦‚æœä½¿ç”¨é«˜çº§æ¥å£ï¼Œå¯èƒ½å­˜åœ¨ä¸€ä¸ªæ¶ˆè´¹è€…æå–äº†ä¸€ä¸ªæ¶ˆæ¯åä¾¿æäº¤äº† offsetï¼Œé‚£ä¹ˆè¿˜æ²¡æ¥å¾—åŠæ¶ˆè´¹å°±å·²ç»æŒ‚äº†ï¼Œä¸‹æ¬¡æ¶ˆè´¹æ—¶çš„æ•°æ®å°±æ˜¯ offset + 1 çš„ä½ç½®ï¼Œé‚£ä¹ˆåŸå…ˆ offset çš„æ•°æ®å°±ä¸¢å¤±äº†ã€‚

## 38ã€Kafka ä½œä¸ºæµå¤„ç†å¹³å°çš„ç‰¹ç‚¹

> æµå¤„ç†å°±æ˜¯è¿ç»­ã€å®æ—¶ã€å¹¶å‘å’Œä»¥é€æ¡è®°å½•çš„æ–¹å¼å¤„ç†æ•°æ®çš„æ„æ€ã€‚Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¤„ç†å¹³å°ï¼Œå®ƒçš„é«˜ååé‡ã€ä½å»¶æ—¶ã€é«˜å¯é æ€§ã€å®¹é”™æ€§ã€é«˜å¯æ‰©å±•æ€§éƒ½ä½¿å¾—Kafkaéå¸¸é€‚åˆä½œä¸ºæµå¼å¹³å°ã€‚

1.  å®ƒæ˜¯ä¸€ä¸ªç®€å•çš„ã€è½»é‡çº§çš„Javaç±»åº“ï¼Œèƒ½å¤Ÿè¢«é›†æˆåˆ°ä»»ä½•Javaåº”ç”¨ä¸­
2.  é™¤äº†Kafkaä¹‹å¤–æ²¡æœ‰ä»»ä½•å…¶ä»–çš„ä¾èµ–ï¼Œåˆ©ç”¨Kafkaçš„åˆ†åŒºæ¨¡å‹æ”¯æŒæ°´å¹³æ‰©å®¹å’Œä¿è¯é¡ºåºæ€§
3.  æ”¯æŒæœ¬åœ°çŠ¶æ€å®¹é”™ï¼Œå¯ä»¥æ‰§è¡Œéå¸¸å¿«é€Ÿæœ‰æ•ˆçš„æœ‰çŠ¶æ€æ“ä½œ
4.  æ”¯æŒ eexactly-once è¯­ä¹‰
5.  æ”¯æŒä¸€æ¬¡å¤„ç†ä¸€æ¡è®°å½•ï¼Œå®ç° ms çº§çš„å»¶è¿Ÿ

## 39ã€æ¶ˆè´¹è€…æ•…éšœï¼Œå‡ºç°æ´»é”é—®é¢˜å¦‚ä½•è§£å†³

**æ´»é”çš„æ¦‚å¿µ**ï¼šæ¶ˆè´¹è€…æŒç»­çš„ç»´æŒå¿ƒè·³ï¼Œä½†æ²¡æœ‰è¿›è¡Œæ¶ˆæ¯å¤„ç†ã€‚

ä¸ºäº†é¢„é˜²æ¶ˆè´¹è€…åœ¨è¿™ç§æƒ…å†µä¸€ç›´æŒæœ‰åˆ†åŒºï¼Œé€šå¸¸ä¼šåˆ©ç”¨ `max.poll.interval.ms`æ´»è·ƒæ£€æµ‹æœºåˆ¶ï¼Œå¦‚æœè°ƒç”¨ Poll çš„é¢‘ç‡å¤§äºæœ€å¤§é—´éš”ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…å°†ä¼šä¸»åŠ¨ç¦»å¼€æ¶ˆè´¹ç»„ï¼Œä»¥ä¾¿å…¶ä»–æ¶ˆè´¹è€…æ¥ç®¡è¯¥åˆ†åŒº

## 40ã€Kafa ä¸­å¦‚ä½•ä¿è¯é¡ºåºæ¶ˆè´¹

Kafka çš„æ¶ˆè´¹å•å…ƒæ˜¯ Partitionï¼ŒåŒä¸€ä¸ª Partition ä½¿ç”¨ offset ä½œä¸ºå”¯ä¸€æ ‡è¯†ä¿è¯é¡ºåºæ€§ï¼Œä½†è¿™åªæ˜¯ä¿è¯äº†åœ¨ Partition å†…éƒ¨çš„é¡ºåºæ€§è€Œä¸æ˜¯ Topic ä¸­çš„é¡ºåºï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰æ¶ˆæ¯å‘å¾€ç»Ÿä¸€ Partition æ‰èƒ½ä¿è¯æ¶ˆæ¯é¡ºåºæ¶ˆè´¹ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨å‘é€çš„æ—¶å€™æŒ‡å®š MessageKeyï¼ŒåŒä¸€ä¸ª key çš„æ¶ˆæ¯ä¼šå‘åˆ°åŒä¸€ä¸ª Partition ä¸­ã€‚



>å‚è€ƒé“¾æ¥ï¼š[https://mp.weixin.qq.com/s/1Mcm_vAq6Qv_pP-y0lPf0g](https://mp.weixin.qq.com/s/1Mcm_vAq6Qv_pP-y0lPf0g)ï¼Œå‡ºå¤„ï¼šèœå†œæ›°ï¼Œæ•´ç†ï¼šæ²‰é»˜ç‹äºŒ


---------

GitHub ä¸Šæ ‡æ˜Ÿ 9300+ çš„å¼€æºçŸ¥è¯†åº“ã€Š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://github.com/itwanger/toBeBetterJavaer)ã€‹ç¬¬ä¸€ç‰ˆ PDF ç»ˆäºæ¥äº†ï¼åŒ…æ‹¬JavaåŸºç¡€è¯­æ³•ã€æ•°ç»„&å­—ç¬¦ä¸²ã€OOPã€é›†åˆæ¡†æ¶ã€Java IOã€å¼‚å¸¸å¤„ç†ã€Java æ–°ç‰¹æ€§ã€ç½‘ç»œç¼–ç¨‹ã€NIOã€å¹¶å‘ç¼–ç¨‹ã€JVMç­‰ç­‰ï¼Œå…±è®¡ 32 ä¸‡ä½™å­—ï¼Œ500+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯é€šä¿—æ˜“æ‡‚ã€é£è¶£å¹½é»˜â€¦â€¦è¯¦æƒ…æˆ³ï¼š[å¤ªèµäº†ï¼ŒGitHub ä¸Šæ ‡æ˜Ÿ 9300+ çš„ Java æ•™ç¨‹](https://javabetter.cn/overview/)


å¾®ä¿¡æœ **æ²‰é»˜ç‹äºŒ** æˆ–æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨äºŒå“¥çš„åŸåˆ›å…¬ä¼—å·æ²‰é»˜ç‹äºŒï¼Œå›å¤ **222** å³å¯å…è´¹é¢†å–ã€‚


![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png)