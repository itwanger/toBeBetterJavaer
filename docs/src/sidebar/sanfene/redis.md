---
title: Redisé¢è¯•é¢˜ï¼Œ57é“Rediså…«è‚¡æ–‡ï¼ˆ1.9ä¸‡å­—97å¼ æ‰‹ç»˜å›¾ï¼‰ï¼Œé¢æ¸£é€†è¢­å¿…çœ‹ğŸ‘
shortTitle: é¢æ¸£é€†è¢­-Redis
description: ä¸‹è½½æ¬¡æ•°è¶… 1 ä¸‡æ¬¡ï¼Œ3.4 ä¸‡å­— 97 å¼ æ‰‹ç»˜å›¾ï¼Œè¯¦è§£ 57 é“ Redis é¢è¯•é«˜é¢‘é¢˜ï¼ˆè®©å¤©ä¸‹æ²¡æœ‰éš¾èƒŒçš„å…«è‚¡ï¼‰ï¼Œé¢æ¸£èƒŒä¼šè¿™äº› Redis å…«è‚¡æ–‡ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚
author: ä¸‰åˆ†æ¶
date: 2024-10-31
category:
  - é¢æ¸£é€†è¢­
tag:
  - é¢æ¸£é€†è¢­
head:
  - - meta
    - name: keywords
      content: Redisé¢è¯•é¢˜,Redis,å…«è‚¡æ–‡,é¢è¯•é¢˜
---

![é¢æ¸£é€†è¢­MySQLç¯‡å°é¢å›¾](https://cdn.tobebetterjavaer.com/stutymore/mysql-mianzhanixi-mysql.jpg)

## å‰è¨€

3.4 ä¸‡å­— 97 å¼ æ‰‹ç»˜å›¾ï¼Œè¯¦è§£ 57 é“ Redis é¢è¯•é«˜é¢‘é¢˜ï¼ˆè®©å¤©ä¸‹æ²¡æœ‰éš¾èƒŒçš„å…«è‚¡ï¼‰ï¼Œé¢æ¸£èƒŒä¼šè¿™äº› Redis å…«è‚¡æ–‡ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚æ•´ç†ï¼šæ²‰é»˜ç‹äºŒï¼Œæˆ³[è½¬è½½é“¾æ¥](https://mp.weixin.qq.com/s/19u34NXALB1nOlBCE6Eg-Q)ï¼Œä½œè€…ï¼šä¸‰åˆ†æ¶ï¼Œæˆ³[åŸæ–‡é“¾æ¥](https://mp.weixin.qq.com/s/iJtNJYgirRugNBnzxkbB4Q)ã€‚

äº®ç™½ç‰ˆæœ¬æ›´é€‚åˆæ‹¿å‡ºæ¥æ‰“å°ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¤šå­¦ç”Ÿå…šå–œæ¬¢çš„æ–¹å¼ï¼Œæ‰“å°å‡ºæ¥èƒŒè¯µçš„æ•ˆç‡ä¼šæ›´é«˜ã€‚

![é¢æ¸£é€†è¢­MySQLç¯‡.pdfç¬¬äºŒç‰ˆ](https://cdn.tobebetterjavaer.com/stutymore/mysql-20250427104843.png)

2025 å¹´ 04 æœˆ 27 æ—¥å¼€å§‹ç€æ‰‹ç¬¬äºŒç‰ˆæ›´æ–°ã€‚

- å¯¹äºé«˜é¢‘é¢˜ï¼Œä¼šæ ‡æ³¨åœ¨ã€Š[Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)ã€‹ä¸­å‡ºç°çš„ä½ç½®ï¼Œå“ªå®¶å…¬å¸ï¼ŒåŸé¢˜æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”ä¼šåŠ ğŸŒŸï¼Œç›®å½•ä¸€ç›®äº†ç„¶ï¼›å¦‚æœä½ æƒ³èŠ‚çœæ—¶é—´çš„è¯ï¼Œå¯ä»¥ä¼˜å…ˆèƒŒè¯µè¿™äº›é¢˜ç›®ï¼Œå°½å¿«åšåˆ°çŸ¥å½¼çŸ¥å·±ï¼Œç™¾æˆ˜ä¸æ®†ã€‚
- åŒºåˆ†å…«è‚¡ç²¾åå›ç­”ç‰ˆæœ¬å’ŒåŸç†åº•å±‚è§£é‡Šï¼Œè®©å¤§å®¶çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼ŒåŒæ—¶åˆèƒ½åšåˆ°é¢è¯•æ—¶çš„é«˜æ•ˆå›ç­”ã€‚
- ç»“åˆé¡¹ç›®ï¼ˆ[æŠ€æœ¯æ´¾](https://javabetter.cn/zhishixingqiu/paicoding.html)ã€[pmhub](https://javabetter.cn/zhishixingqiu/pmhub.html)ï¼‰æ¥ç»„ç»‡è¯­è¨€ï¼Œè®©é¢è¯•å®˜æœ€å¤§ç¨‹åº¦æ„Ÿå—åˆ°ä½ çš„è¯šæ„ï¼Œè€Œä¸æ˜¯æœºæ¢°åŒ–çš„èƒŒè¯µã€‚
- ä¿®å¤ç¬¬ä¸€ç‰ˆä¸­å‡ºç°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬çƒå‹ä»¬çš„ç§ä¿¡åé¦ˆï¼Œç½‘ç«™ç•™è¨€åŒºçš„è¯„è®ºï¼Œä»¥åŠ [GitHub ä»“åº“](https://github.com/itwanger/toBeBetterJavaer/issues)ä¸­çš„ issueï¼Œè®©è¿™ä»½é¢è¯•æŒ‡å—æ›´åŠ å®Œå–„ã€‚
- å¢åŠ [äºŒå“¥ç¼–ç¨‹æ˜Ÿçƒ](https://javabetter.cn/zhishixingqiu/)çš„çƒå‹ä»¬æ‹¿åˆ°çš„ä¸€äº› offerï¼Œå¯¹é¢æ¸£é€†è¢­çš„æ„Ÿè°¢ï¼Œä»¥åŠå¯¹ç®€å†ä¿®æ”¹çš„ä¸€äº›è®¤å¯ï¼Œä»¥æ­¤æ¥æ¿€åŠ±å¤§å®¶ï¼Œç»™å¤§å®¶æ›´å¤šä¿¡å¿ƒã€‚
- ä¼˜åŒ–æ’ç‰ˆï¼Œå¢åŠ æ‰‹ç»˜å›¾ï¼Œé‡æ–°ç»„ç»‡ç­”æ¡ˆï¼Œä½¿å…¶æ›´åŠ å£è¯­åŒ–ï¼Œä»è€Œæ›´è´´è¿‘é¢è¯•å®˜çš„é¢„æœŸã€‚

![é¢æ¸£é€†è¢­å·²ç»æäº¤ 1457 æ¬¡ GitHub è®°å½•](https://cdn.tobebetterjavaer.com/stutymore/mysql-20250427100320.png)

ç”±äº PDF æ²¡åŠæ³•è‡ªæˆ‘æ›´æ–°ï¼Œæ‰€ä»¥éœ€è¦æœ€æ–°ç‰ˆçš„å°ä¼™ä¼´ï¼Œå¯ä»¥å¾®ä¿¡æœã€**æ²‰é»˜ç‹äºŒ**ã€‘ï¼Œæˆ–è€…æ‰«æ/é•¿æŒ‰è¯†åˆ«ä¸‹é¢çš„äºŒç»´ç ï¼Œå…³æ³¨äºŒå“¥çš„å…¬ä¼—å·ï¼Œå›å¤ã€**222**ã€‘å³å¯æ‹‰å–æœ€æ–°ç‰ˆæœ¬ã€‚

<div style="text-align: center; margin: 20px 0;">
    <img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png" alt="å¾®ä¿¡æ‰«ç æˆ–è€…é•¿æŒ‰è¯†åˆ«ï¼Œæˆ–è€…å¾®ä¿¡æœç´¢â€œæ²‰é»˜ç‹äºŒâ€" style="max-width: 100%; height: auto;  border-radius: 10px;" />
</div>

æˆ‘æŠŠäºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ã€JVM è¿›é˜¶ä¹‹è·¯ã€å¹¶å‘ç¼–ç¨‹è¿›é˜¶ä¹‹è·¯ï¼Œä»¥åŠæ‰€æœ‰é¢æ¸£é€†è¢­çš„ç‰ˆæœ¬éƒ½æ”¾è¿›æ¥äº†ï¼Œæ¶µç›– JavaåŸºç¡€ã€Javaé›†åˆã€Javaå¹¶å‘ã€JVMã€Springã€MyBatisã€è®¡ç®—æœºç½‘ç»œã€æ“ä½œç³»ç»Ÿã€MySQLã€Redisã€RocketMQã€åˆ†å¸ƒå¼ã€å¾®æœåŠ¡ã€è®¾è®¡æ¨¡å¼ã€Linux ç­‰ 16 ä¸ªå¤§çš„ä¸»é¢˜ï¼Œå…±æœ‰ 30 å¤šä¸‡å­—ï¼Œ400+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯è¯šæ„æ»¡æ»¡ã€‚

![å›å¤ 222](https://cdn.tobebetterjavaer.com/stutymore/collection-20250512160410.png)

å½“ç„¶äº†ï¼Œè¯·å…è®¸æˆ‘çš„ä¸€ç‚¹ç‚¹ç§å¿ƒï¼Œé‚£å°±æ˜¯æ˜Ÿçƒçš„ PDF ç‰ˆæœ¬ä¼šæ¯”å…¬ä¼—å·æ—©ä¸€ä¸ªæœˆæ—¶é—´ï¼Œæ¯•ç«Ÿæ˜Ÿçƒç”¨æˆ·éƒ½ä»˜è´¹è¿‡äº†ï¼Œæˆ‘æœ‰å¿…è¦è®©ä»–ä»¬å…ˆäº«å—åˆ°ä¸€ç‚¹ç‚¹ç¦åˆ©ã€‚ç›¸ä¿¡å¤§å®¶ä¹Ÿéƒ½èƒ½ç†è§£ï¼Œæ¯•ç«Ÿåœ¨çº¿ç‰ˆæ˜¯å…è´¹çš„ï¼ŒCDNã€æœåŠ¡å™¨ã€åŸŸåã€OSS ç­‰ç­‰éƒ½æ˜¯éœ€è¦æˆæœ¬çš„ã€‚

æ›´åˆ«è¯´æˆ‘ä»˜å‡ºçš„æ—¶é—´å’Œç²¾åŠ›äº†ã€‚

å±•ç¤ºä¸€ä¸‹æš—é»‘ç‰ˆæœ¬çš„ PDF å§ï¼Œæ’ç‰ˆæ¸…æ™°ï¼Œå­—ä½“ä¼˜é›…ï¼Œæ›´åŠ é€‚åˆå¤œæœï¼Œæ™šä¸Šçœ‹ä¼šæ›´èˆ’æœä¸€ç‚¹ã€‚

![é¢æ¸£é€†è¢­MySQLç¯‡.pdfæš—é»‘ç‰ˆ](https://cdn.tobebetterjavaer.com/stutymore/mysql-20250427105032.png)


## åŸºç¡€

### ğŸŒŸ1.è¯´è¯´ä»€ä¹ˆæ˜¯ Redis?

[Redis](https://javabetter.cn/redis/rumen.html) æ˜¯ä¸€ç§åŸºäºé”®å€¼å¯¹çš„ NoSQL æ•°æ®åº“ã€‚

![äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼šmacOS å¯åŠ¨ Redis](https://cdn.tobebetterjavaer.com/stutymore/redis-20250427143333.png)

å®ƒä¸»è¦çš„ç‰¹ç‚¹æ˜¯æŠŠæ•°æ®æ”¾åœ¨å†…å­˜å½“ä¸­ï¼Œç›¸æ¯”ç›´æ¥è®¿é—®ç£ç›˜çš„å…³ç³»å‹æ•°æ®åº“ï¼Œè¯»å†™é€Ÿåº¦ä¼šå¿«å¾ˆå¤šï¼ŒåŸºæœ¬ä¸Šèƒ½è¾¾åˆ°å¾®ç§’çº§çš„å“åº”ã€‚

æ‰€ä»¥åœ¨ä¸€äº›å¯¹æ€§èƒ½è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚ç¼“å­˜çƒ­ç‚¹æ•°æ®ã€é˜²æ­¢æ¥å£çˆ†åˆ·ï¼Œéƒ½ä¼šç”¨åˆ° Redisã€‚

ä¸ä»…å¦‚æ­¤ï¼ŒRedis è¿˜æ”¯æŒæŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®å¼‚æ­¥è½ç›˜ï¼Œä»¥ä¾¿æœåŠ¡å®•æœºé‡å¯åèƒ½æ¢å¤æ•°æ®ã€‚

#### Redis å’Œ MySQL çš„åŒºåˆ«ï¼Ÿ

Redis å±äºéå…³ç³»å‹æ•°æ®åº“ï¼Œæ•°æ®æ˜¯é€šè¿‡é”®å€¼å¯¹çš„å½¢å¼æ”¾åœ¨å†…å­˜å½“ä¸­çš„ï¼›MySQL å±äºå…³ç³»å‹æ•°æ®åº“ï¼Œæ•°æ®ä»¥è¡Œå’Œåˆ—çš„å½¢å¼å­˜å‚¨åœ¨ç£ç›˜å½“ä¸­ã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis ä½œä¸º MySQL çš„ç¼“å­˜](https://cdn.tobebetterjavaer.com/stutymore/redis-20250427152053.png)

å®é™…å¼€å‘ä¸­ï¼Œä¼šå°† MySQL ä½œä¸ºä¸»å­˜å‚¨ï¼ŒRedis ä½œä¸ºç¼“å­˜ï¼Œé€šè¿‡å…ˆæŸ¥ Redisï¼Œæœªå‘½ä¸­å†æŸ¥ MySQL å¹¶å†™å›Redis çš„æ–¹å¼æ¥æé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚

#### é¡¹ç›®é‡Œå“ªé‡Œç”¨åˆ°äº† Redisï¼Ÿ

åœ¨[æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®](https://javabetter.cn/zhishixingqiu/paicoding.html)å½“ä¸­ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹éƒ½ç”¨åˆ°äº† Redisï¼Œæ¯”å¦‚è¯´ç”¨æˆ·æ´»è·ƒæ’è¡Œæ¦œç”¨åˆ°äº† zsetï¼Œä½œè€…ç™½åå•ç”¨åˆ°äº† setã€‚

![æŠ€æœ¯æ´¾ä¸“æ ï¼šç”¨æˆ·æ´»è¶Šæ’è¡Œæ¦œ](https://cdn.tobebetterjavaer.com/stutymore/redis-20240420093229.png)

è¿˜æœ‰ç”¨æˆ·ç™»å½•åçš„ Sessionã€ç«™ç‚¹åœ°å›¾ SiteMapï¼Œåˆ†åˆ«ç”¨åˆ°äº† Redis çš„å­—ç¬¦ä¸²å’Œå“ˆå¸Œè¡¨ä¸¤ç§æ•°æ®ç±»å‹ã€‚

![æŠ€æœ¯æ´¾ä¸“æ ï¼šRedis çš„ä½¿ç”¨ç¤ºä¾‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250427152536.png)

å…¶ä¸­æ¯”è¾ƒæœ‰æŒ‘æˆ˜æ€§çš„ä¸€ä¸ªåº”ç”¨æ˜¯ï¼Œé€šè¿‡ Lua è„šæœ¬å°è£… Redis çš„ setnex å‘½ä»¤æ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œä»¥ä¿è¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œçƒ­ç‚¹æ–‡ç« åœ¨çŸ­æ—¶é—´å†…çš„é«˜é¢‘è®¿é—®ä¸ä¼šå‡»ç©¿ MySQLã€‚

![æŠ€æœ¯æ´¾ä¸“æ ï¼šRedis åˆ†å¸ƒå¼é”çš„åº”ç”¨](https://cdn.tobebetterjavaer.com/stutymore/redis-20250427152627.png)

#### éƒ¨ç½²è¿‡ Redis å—ï¼Ÿ

ç¬¬ä¸€ç§å›ç­”ç‰ˆæœ¬ï¼š

æˆ‘åªåœ¨æœ¬åœ°éƒ¨ç½²è¿‡å•æœºç‰ˆï¼Œä¸‹è½½ Redis çš„å®‰è£…åŒ…ï¼Œè§£å‹åè¿è¡Œ `redis-server` å‘½ä»¤å³å¯ã€‚

ç¬¬äºŒç§å›ç­”ç‰ˆæœ¬ï¼š

æˆ‘æœ‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²å•æœºç‰ˆ Redisï¼Œä»å®˜ç½‘ä¸‹è½½æºç åŒ…è§£å‹åæ‰§è¡Œ `make && make install` ç¼–è¯‘å®‰è£…ã€‚ç„¶åç¼–è¾‘ `redis.conf` æ–‡ä»¶ï¼Œå¼€å¯è¿œç¨‹è®¿é—®ã€è®¾ç½®å¯†ç ã€é™åˆ¶å†…å­˜ã€è®¾ç½®å†…å­˜è¿‡æœŸæ·˜æ±°ç­–ç•¥ã€å¼€å¯ AOF æŒä¹…åŒ–ç­‰ï¼š

```
bind 0.0.0.0        # å…è®¸è¿œç¨‹è®¿é—®
requirepass your_password  # è®¾ç½®å¯†ç 
maxmemory 4gb      # é™åˆ¶å†…å­˜ï¼Œé¿å… OOM
maxmemory-policy allkeys-lru  # å†…å­˜æ·˜æ±°ç­–ç•¥
appendonly yes     # å¼€å¯ AOF æŒä¹…åŒ–
```

ç¬¬ä¸‰ç§å›ç­”ç‰ˆæœ¬ï¼š

æˆ‘æœ‰ä½¿ç”¨ Docker æ‹‰å– Redis é•œåƒåè¿›è¡Œå®¹å™¨åŒ–éƒ¨ç½²ã€‚

```shell
docker run -d --name redis -p 6379:6379 redis:7.0-alpine
```

#### Redis çš„é«˜å¯ç”¨æ–¹æ¡ˆæœ‰éƒ¨ç½²è¿‡å—ï¼Ÿ

æœ‰éƒ¨ç½²è¿‡å“¨å…µæœºåˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹æˆç†Ÿçš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„æ˜¯ä¸€ä¸»ä¸¤ä»çš„ Redis å®ä¾‹ï¼Œå†åŠ ä¸Šä¸‰ä¸ª Sentinel èŠ‚ç‚¹ç›‘æ§å®ƒä»¬ã€‚Sentinel çš„é…ç½®ç›¸å¯¹ç®€å•ï¼Œä¸»è¦è®¾ç½®äº†æ•…éšœè½¬ç§»çš„åˆ¤å®šæ¡ä»¶å’Œè¶…æ—¶é˜ˆå€¼ã€‚

ä¸»èŠ‚ç‚¹é…ç½®ï¼š

```shell
port 6379
appendonly yes
```

ä»èŠ‚ç‚¹é…ç½®ï¼š

```shell
replicaof 192.168.1.10 6379
```

å“¨å…µèŠ‚ç‚¹é…ç½®ï¼š

```shell
sentinel monitor mymaster 192.168.1.10 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
sentinel parallel-syncs mymaster 1
```

å½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼ŒSentinel èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹å¹¶åå•†é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å¤§æ¦‚éœ€è¦ 10-15 ç§’ã€‚

å¦ä¸€ä¸ªå¤§å‹é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Redis Cluster é›†ç¾¤æ–¹æ¡ˆã€‚è¯¥é¡¹ç›®æ•°æ®é‡å¤§ä¸”å¢é•¿å¿«ï¼Œéœ€è¦æ°´å¹³æ‰©å±•èƒ½åŠ›ã€‚æˆ‘ä»¬éƒ¨ç½²äº† 6 ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹é…å¤‡ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå½¢æˆäº†ä¸€ä¸ª 3ä¸»3ä» çš„åˆå§‹é›†ç¾¤ã€‚Redis Cluster çš„è®¾ç½®æ¯” Sentinel å¤æ‚ä¸€äº›ï¼Œéœ€è¦æ­£ç¡®é…ç½®é›†ç¾¤èŠ‚ç‚¹é—´é€šä¿¡ã€åˆ†ç‰‡æ˜ å°„ç­‰ã€‚

```shell
redis-server redis-7000.conf
redis-server redis-7001.conf
...

# ä½¿ç”¨ redis-cli åˆ›å»ºé›†ç¾¤
# Redis ä¼šè‡ªåŠ¨å°† key å“ˆå¸Œåˆ° 16384 ä¸ªæ§½ä½
# ä¸»èŠ‚ç‚¹å‡åˆ†æ§½ä½ï¼Œä»èŠ‚ç‚¹è‡ªåŠ¨è·Ÿéš
redis-cli --cluster create \
  127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
  127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 \
  --cluster-replicas 1
```

Redis Cluster æœ€å¤§çš„ä¼˜åŠ¿æ˜¯æ•°æ®è‡ªåŠ¨åˆ†ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç®€å•åœ°å¢åŠ èŠ‚ç‚¹æ¥æ‰©å±•é›†ç¾¤å®¹é‡ã€‚æ­¤å¤–ï¼Œå®ƒçš„æ•…éšœè½¬ç§»ä¹Ÿå¾ˆå¿«ï¼Œé€šå¸¸åœ¨å‡ ç§’å†…å°±èƒ½å®Œæˆã€‚

å¯¹äºä¸€äº›è½»é‡çº§åº”ç”¨ï¼Œæˆ‘ä¹Ÿä½¿ç”¨è¿‡ä¸»ä»å¤åˆ¶åŠ æ‰‹åŠ¨æ•…éšœè½¬ç§»çš„æ–¹æ¡ˆã€‚ä¸»èŠ‚ç‚¹è´Ÿè´£è¯»å†™æ“ä½œï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»æ“ä½œã€‚æ‰‹åŠ¨æ•…éšœè½¬ç§»æ—¶ï¼Œæˆ‘ä»¬ä¼šå…ˆå°†ä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œç„¶åé‡æ–°é…ç½®å…¶ä»–ä»èŠ‚ç‚¹ã€‚

```shell
# 1. å–æ¶ˆä»èŠ‚ç‚¹èº«ä»½
redis-cli -h <slave-ip> slaveof no one

# 2. å°†å…¶ä»–ä»èŠ‚ç‚¹æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹
redis-cli -h <other-slave-ip> slaveof <new-master-ip> <port>
```


> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸ºä¸€é¢åŸé¢˜ï¼šè¯´ä¸‹ Redis å’Œ HashMap çš„åŒºåˆ«
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨å•†ä¸šåŒ–ä¸€é¢çš„åŸé¢˜ï¼šRedis å’Œ MySQL çš„åŒºåˆ«
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 7 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis ç›¸å…³çš„åŸºç¡€çŸ¥è¯†
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸º OD é¢ç»åŒå­¦ 1 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„äº†è§£, éƒ¨ç½²æ–¹æ¡ˆ?
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 3 Java åç«¯é¢è¯•åŸé¢˜ï¼šé¡¹ç›®é‡Œå“ªé‡Œç”¨åˆ°äº† Redis
> 6. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ 360 é¢ç»åŒå­¦ 3 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šç”¨è¿‡ redis å— ç”¨æ¥å¹²ä»€ä¹ˆ
> 7. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æ‹›å•†é“¶è¡Œé¢ç»åŒå­¦ 6 æ‹›é“¶ç½‘ç»œç§‘æŠ€é¢è¯•åŸé¢˜ï¼šäº†è§£ MySQLã€Redis å—ï¼Ÿ
> 8. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç™¾åº¦é¢ç»åŒå­¦ 1 æ–‡å¿ƒä¸€è¨€ 25 å®ä¹  Java åç«¯é¢è¯•åŸé¢˜ï¼šé¡¹ç›®ä¸­ä»€ä¹ˆåœ°æ–¹ä½¿ç”¨äº† redis ç¼“å­˜ï¼Œredis ä¸ºä»€ä¹ˆå¿«ï¼Ÿ
> 9. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å›½ä¼é›¶ç¢é¢ç»åŒå­¦ 9 é¢è¯•åŸé¢˜ï¼šæ•°æ®åº“ç”¨ä»€ä¹ˆå¤šï¼ˆè¯´äº† Mysql å’Œ Redisï¼‰
> 10. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è£è€€é¢ç»åŒå­¦ 4 é¢è¯•åŸé¢˜ï¼šRediså’ŒMySQLçš„åŒºåˆ«ï¼Ÿ
> 11. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æµ·åº·å¨è§†åŒå­¦ 4é¢è¯•åŸé¢˜ï¼šRediséƒ¨ç½²
> 12. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸º OD é¢ç»åŒå­¦ 1 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„äº†è§£, éƒ¨ç½²æ–¹æ¡ˆ?
> 13. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šredisçš„éƒ¨ç½²æ–¹å¼éƒ½æœ‰å“ªäº›å‘¢ï¼Œå„è‡ªæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ

### 2.Redis å¯ä»¥ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ

Redis å¯ä»¥ç”¨æ¥åšç¼“å­˜ï¼Œæ¯”å¦‚è¯´æŠŠé«˜é¢‘è®¿é—®çš„æ–‡ç« è¯¦æƒ…ã€å•†å“ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯æ”¾å…¥ Redis å½“ä¸­ï¼Œå¹¶é€šè¿‡è®¾ç½®è¿‡æœŸæ—¶é—´æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œè¿™æ ·å°±å¯ä»¥å‡è½»æ•°æ®åº“çš„è®¿é—®å‹åŠ›ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisç¼“å­˜](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d44c2397-5994-452f-8b7b-eb85d2b87685.png)

Redis çš„ Zset è¿˜å¯ä»¥ç”¨æ¥å®ç°ç§¯åˆ†æ¦œã€çƒ­æœæ¦œï¼Œé€šè¿‡ score å­—æ®µè¿›è¡Œæ’åºï¼Œç„¶åå–å‰ N ä¸ªå…ƒç´ ï¼Œå°±èƒ½å®ç° TOPN çš„æ¦œå•åŠŸèƒ½ã€‚

![æŠ€æœ¯æ´¾ï¼šé˜…è¯»æ´»è·ƒæ¦œ](https://cdn.tobebetterjavaer.com/stutymore/redis-20240420100012.png)

åˆ©ç”¨ Redis çš„ SETNX å‘½ä»¤æˆ–è€… Redisson è¿˜å¯ä»¥å®ç°åˆ†å¸ƒå¼é”ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æŒæœ‰é”ï¼›ä¸ºäº†é˜²æ­¢å‡ºç°æ­»é”ï¼Œå¯ä»¥ç»™é”è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸåè‡ªåŠ¨é‡Šæ”¾ï¼›å¹¶ä¸”æœ€å¥½å¼€å¯ä¸€ä¸ªç›‘å¬çº¿ç¨‹ï¼Œå½“ä»»åŠ¡å°šæœªå®Œæˆæ—¶ç»™é”è‡ªåŠ¨ç»­æœŸã€‚

![PmHubï¼šRedisåˆ†å¸ƒå¼é”ä¿éšœæµç¨‹çŠ¶æ€æ›´æ–°](https://cdn.tobebetterjavaer.com/stutymore/redis-20250428152255.png)

å¦‚æœæ˜¯ç§’æ€æ¥å£ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ Lua è„šæœ¬æ¥å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œé™åˆ¶æ¯ç§’åªèƒ½å¤„ç† N ä¸ªè¯·æ±‚ã€‚

```lua
-- KEYS[1]: ä»¤ç‰Œæ¡¶çš„key
-- ARGV[1]: æ¡¶å®¹é‡
-- ARGV[2]: ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼ˆæ¯ç§’ï¼‰
-- ARGV[3]: å½“å‰æ—¶é—´æˆ³ï¼ˆç§’ï¼‰

local bucket = redis.call('HMGET', KEYS[1], 'tokens', 'timestamp')
local tokens = tonumber(bucket[1]) or ARGV[1]
local last_time = tonumber(bucket[2]) or ARGV[3]

local rate = tonumber(ARGV[2])
local capacity = tonumber(ARGV[1])
local now = tonumber(ARGV[3])

-- è®¡ç®—æ–°ä»¤ç‰Œæ•°
local delta = math.max(0, now - last_time)
local add_tokens = delta * rate
tokens = math.min(capacity, tokens + add_tokens)
last_time = now

local allowed = 0
if tokens >= 1 then
    tokens = tokens - 1
    allowed = 1
end

redis.call('HMSET', KEYS[1], 'tokens', tokens, 'timestamp', last_time)
redis.call('EXPIRE', KEYS[1], 3600) -- è¿‡æœŸæ—¶é—´å¯è‡ªå®šä¹‰

return allowed
```

åœ¨ Java ä¸­è°ƒç”¨ Lua è„šæœ¬ï¼š

```java
// ä»¤ç‰Œæ¡¶å‚æ•°
int capacity = 10; // æ¡¶å®¹é‡
int rate = 2;      // æ¯ç§’2ä¸ªä»¤ç‰Œ
long now = System.currentTimeMillis() / 1000;
String key = "token_bucket:user:123";

// è°ƒç”¨ Lua è„šæœ¬ï¼Œè¿”å› 1 è¡¨ç¤ºé€šè¿‡ï¼Œ0 è¡¨ç¤ºè¢«é™æµ
Long allowed = (Long) redis.eval(luaScript, 1, key, String.valueOf(capacity), String.valueOf(rate), String.valueOf(now));
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 7 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis ç›¸å…³çš„åŸºç¡€çŸ¥è¯†
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šè®²ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦ç”¨ Redis å»å­˜æƒé™åˆ—è¡¨ï¼Ÿ
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 20 æµ‹å¼€ä¸€é¢çš„åŸé¢˜ï¼šredis æœ‰ä»€ä¹ˆå¥½å¤„ï¼Œä¸ºä»€ä¹ˆç”¨ redis

memoï¼š2025 å¹´ 4 æœˆ 28 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©[å¸®çƒå‹ä¿®æ”¹ç®€å†](https://javabetter.cn/zhishixingqiu/jianli.html)çš„æ—¶å€™ï¼Œç¢°åˆ°ä¸€ä½ä¸œå—å¤§å­¦æœ¬ç¡•è¿è¯»çš„çƒå‹ï¼Œæ˜Ÿçƒèƒ½æ¥è¿™ä¹ˆå¤šä¼˜ç§€çš„çƒå‹ï¼ŒçœŸçš„å¾ˆå¼€å¿ƒå•Šã€‚

![ä¸œå—å¤§å­¦æœ¬ç¡•çš„çƒå‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250428163928.png)

### ğŸŒŸ3.Redisæœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Ÿ

Redis æ”¯æŒäº”ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å“ˆå¸Œã€é›†åˆå’Œæœ‰åºé›†åˆã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisåŸºæœ¬æ•°æ®ç±»å‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-10434dc7-c7a3-4c1a-b484-de3fb37669ee.png)

è¿˜æœ‰ä¸‰ç§æ‰©å±•æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ç”¨äºä½çº§æ“ä½œçš„ Bitmapã€ç”¨äºåŸºæ•°ä¼°ç®—çš„ HyperLogLogã€æ”¯æŒå­˜å‚¨å’ŒæŸ¥è¯¢åœ°ç†åæ ‡çš„ GEOã€‚

#### è¯¦ç»†ä»‹ç»ä¸‹å­—ç¬¦ä¸²ï¼Ÿ

å­—ç¬¦ä¸²æ˜¯æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥å­˜å‚¨æ–‡æœ¬ã€æ•°å­—æˆ–è€…äºŒè¿›åˆ¶æ•°æ®ï¼Œæœ€å¤§å®¹é‡æ˜¯ 512 MBã€‚

![Mräºï¼šRedis çš„ string](https://cdn.tobebetterjavaer.com/stutymore/redis-20250429112032.png)

é€‚åˆç¼“å­˜å•ä¸ªå¯¹è±¡ï¼Œæ¯”å¦‚éªŒè¯ç ã€tokenã€è®¡æ•°å™¨ç­‰ã€‚

#### è¯¦ç»†ä»‹ç»ä¸‹åˆ—è¡¨ï¼Ÿ

åˆ—è¡¨æ˜¯ä¸€ä¸ªæœ‰åºçš„å…ƒç´ é›†åˆï¼Œæ”¯æŒä»å¤´éƒ¨æˆ–å°¾éƒ¨æ’å…¥/åˆ é™¤å…ƒç´ ï¼Œå¸¸ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—æˆ–ä»»åŠ¡åˆ—è¡¨ã€‚

![Mräºï¼šRedis çš„ list](https://cdn.tobebetterjavaer.com/stutymore/redis-20250429112708.png)

#### è¯¦ç»†ä»‹ç»ä¸‹å“ˆå¸Œï¼Ÿ

å“ˆå¸Œæ˜¯ä¸€ä¸ªé”®å€¼å¯¹é›†åˆï¼Œé€‚åˆå­˜å‚¨å¯¹è±¡ï¼Œå¦‚å•†å“ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯ç­‰ã€‚æ¯”å¦‚è¯´ `value = {name: 'æ²‰é»˜ç‹äºŒ', age: 18}`ã€‚

![Mräºï¼šRedis çš„hash](https://cdn.tobebetterjavaer.com/stutymore/redis-20250429113019.png)

#### è¯¦ç»†ä»‹ç»ä¸‹é›†åˆï¼Ÿ

é›†åˆæ˜¯æ— åºä¸”ä¸é‡å¤çš„ï¼Œæ”¯æŒäº¤é›†ã€å¹¶é›†æ“ä½œï¼ŒæŸ¥è¯¢æ•ˆç‡èƒ½è¾¾åˆ° `O(1)` çº§åˆ«ï¼Œä¸»è¦ç”¨äºå»é‡ã€æ ‡ç­¾ã€å…±åŒå¥½å‹ç­‰åœºæ™¯ã€‚

![Mräºï¼šRedis çš„ set](https://cdn.tobebetterjavaer.com/stutymore/redis-20250429113501.png)

#### è¯¦ç»†ä»‹ç»ä¸‹æœ‰åºé›†åˆï¼Ÿ

æœ‰åºé›†åˆçš„å…ƒç´ æŒ‰åˆ†æ•°è¿›è¡Œæ’åºï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œé€‚ç”¨äºæ’è¡Œæ¦œæˆ–ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://cdn.tobebetterjavaer.com/stutymore/redis-20240315120652.png)

#### è¯¦ç»†ä»‹ç»ä¸‹Bitmapï¼Ÿ

Bitmap å¯ä»¥æŠŠä¸€ç»„äºŒè¿›åˆ¶ä½ç´§å‡‘åœ°å­˜å‚¨åœ¨ä¸€å—è¿ç»­å†…å­˜ä¸­ï¼Œæ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ˜¯å¦ç­¾åˆ°ã€æ˜¯å¦æ´»è·ƒç­‰ã€‚

![ç å“¥å­—èŠ‚ï¼šBitmap](https://cdn.tobebetterjavaer.com/stutymore/redis-20250429120349.png)

æ¯”å¦‚ç”¨æˆ· 0 çš„å·²ç­¾åˆ° 1ã€ç”¨æˆ· 1 æœªç­¾åˆ° 0ã€ç”¨æˆ· 2 å·²ç­¾åˆ°ï¼ŒRedis å°±ä¼šæŠŠè¿™äº›çŠ¶æ€æ”¾è¿›ä¸€ä¸ªè¿ç»­çš„äºŒè¿›åˆ¶ä¸² `101`ï¼Œ1 äº¿ç”¨æˆ·ç­¾åˆ°ä»…éœ€ `100,000,000 / 8 / 1024 â‰ˆ 12MB` çš„ç©ºé—´ï¼ŒçœŸçš„çœåˆ°ç¦»è°±ã€‚

#### è¯¦ç»†ä»‹ç»ä¸‹HyperLogLogï¼Ÿ

HyperLogLog æ˜¯ä¸€ç§ç”¨äºåŸºæ•°ç»Ÿè®¡çš„æ¦‚ç‡æ€§æ•°æ®ç»“æ„ï¼Œå¯ä»¥åœ¨ä»…æœ‰ 12KB çš„å†…å­˜ç©ºé—´ä¸‹ï¼Œç»Ÿè®¡æµ·é‡æ•°æ®é›†ä¸­ä¸é‡å¤å…ƒç´ çš„ä¸ªæ•°ï¼Œè¯¯å·®ç‡ä»… 0.81%ã€‚

![devops.devï¼šHyperLogLog](https://cdn.tobebetterjavaer.com/stutymore/redis-20250429121524.png)

åº•å±‚åŸºäº LogLog ç®—æ³•æ”¹è¿›ï¼Œå…ˆæŠŠæ¯ä¸ªå…ƒç´ å“ˆå¸Œæˆä¸€ä¸ªäºŒè¿›åˆ¶ä¸²ï¼Œç„¶åå–å‰ 14 ä½è¿›è¡Œåˆ†ç»„ï¼Œæ”¾åˆ° 16384 ä¸ªæ¡¶ä¸­ï¼Œè®°å½•æ¯ç»„æœ€å¤§çš„å‰å¯¼é›¶æ•°é‡ï¼Œæœ€åç”¨ä¸€ä¸ªè¿‘ä¼¼å…¬å¼æ¨ç®—å‡ºæ€»ä½“çš„åŸºæ•°ã€‚

![æ—å† å®ï¼šè¿‘ä¼¼å…¬å¼](https://cdn.tobebetterjavaer.com/stutymore/redis-20250429132129.png)

>$2^{14}$ä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶ 6 Bitï¼Œåˆšå¥½ `16384 * 6 /8 / 1024 K = 12KB`ï¼Œ8 bit = 1 byteã€‚

ä¸¾ä¸ªè¶…ç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æœ‰ä¸€ä¸ªç¥å¥‡çš„å“ˆå¸Œå‡½æ•°ï¼Œå¯ä»¥æŠŠå…ƒç´ æ•£åˆ—æˆä¸€ä¸ªäºŒè¿›åˆ¶æ•°ï¼Œæ¯”å¦‚ï¼š

å…ƒç´ |	å“ˆå¸Œå€¼|	å‰å¯¼é›¶ä¸ªæ•°
---|---|---
userA|	000100101â€¦|	3
userB|	001010011â€¦|	2
userC|	000000101â€¦|	6

å¯ä»¥å‘ç°ï¼Œå“ˆå¸Œå€¼è¶Šé•¿å‰å¯¼é›¶è¶Šå¤šï¼Œä¹Ÿå°±è¯´æ˜é›†åˆé‡Œçš„å…ƒç´ è¶Šå¤šã€‚

å¤§å‹ç½‘ç«™ UV ç»Ÿè®¡ç³»ç»Ÿç¤ºä¾‹ï¼š

```java
public class UVCounter {
    private Jedis jedis;
    
    public void recordVisit(String date, String userId) {
        String key = "uv:" + date;
        jedis.pfadd(key, userId);
    }
    
    public long getUV(String date) {
        return jedis.pfcount("uv:" + date);
    }
    
    public long getUVBetween(String startDate, String endDate) {
        List<String> keys = getDateKeys(startDate, endDate);
        return jedis.pfcount(keys.toArray(new String[0]));
    }
}
```

#### è¯¦ç»†ä»‹ç»ä¸‹GEOï¼Ÿ

GEO ç”¨äºå­˜å‚¨å’ŒæŸ¥è¯¢åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼ŒæŸ¥æ‰¾æŸä½ç½®åŠå¾„å†…çš„å…¶ä»–å…ƒç´ ã€‚

å¸¸è§çš„åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼šé™„è¿‘çš„äººæˆ–è€…å•†å®¶ã€è®¡ç®—å¤–å–å‘˜å’Œå•†å®¶çš„è·ç¦»ã€åˆ¤æ–­ç”¨æˆ·æ˜¯å¦è¿›å…¥æŸä¸ªåŒºåŸŸç­‰ã€‚

åº•å±‚åŸºäº ZSet å®ç°ï¼Œé€šè¿‡ Geohash ç®—æ³•æŠŠç»çº¬åº¦ç¼–ç æˆ scoreã€‚

![å°å¾å…ˆç”Ÿçš„ç¼–ç¨‹ä¸–ç•Œï¼šGEO åŸç†](https://cdn.tobebetterjavaer.com/stutymore/redis-20250429134358.png)

æ¯”å¦‚è¯´æŸ¥è¯¢é™„è¿‘çš„å•†å®¶æ—¶ï¼ŒRedis ä¼šæ ¹æ®ä¸­å¿ƒç‚¹ç»çº¬åº¦åæ¨å¯èƒ½çš„ Geohash èŒƒå›´ï¼Œ
åœ¨ ZSet ä¸ŠåšèŒƒå›´æŸ¥è¯¢ï¼Œæ‹¿åˆ°å€™é€‰ç‚¹åï¼Œç”¨ Haversine å…¬å¼ç²¾ç¡®è®¡ç®—çƒé¢è·ç¦»ï¼Œç­›é€‰å‡ºæœ€ç»ˆç¬¦åˆè¦æ±‚çš„ä½ç½®ã€‚

```java
public class NearbyShopService {
    private Jedis jedis;
    private static final String SHOP_KEY = "shops:geo";
    
    // æ·»åŠ å•†é“º
    public void addShop(String shopId, double longitude, double latitude) {
        jedis.geoadd(SHOP_KEY, longitude, latitude, shopId);
    }
    
    // æŸ¥è¯¢é™„è¿‘çš„å•†é“º
    public List<GeoRadiusResponse> getNearbyShops(
            double longitude, 
            double latitude, 
            double radiusKm) {
        return jedis.georadius(SHOP_KEY, 
                             longitude, 
                             latitude, 
                             radiusKm, 
                             GeoUnit.KM, 
                             GeoRadiusParam.geoRadiusParam()
                                         .withCoord()
                                         .withDist()
                                         .sortAscending()
                                         .count(20));
    }
    
    // è®¡ç®—ä¸¤ä¸ªå•†é“ºä¹‹é—´çš„è·ç¦»
    public double getShopDistance(String shop1Id, String shop2Id) {
        return jedis.geodist(SHOP_KEY, 
                           shop1Id, 
                           shop2Id, 
                           GeoUnit.KILOMETERS);
    }
}
```

#### ä¸ºä»€ä¹ˆä½¿ç”¨ hash ç±»å‹è€Œä¸ä½¿ç”¨ string ç±»å‹åºåˆ—åŒ–å­˜å‚¨ï¼Ÿ

Hash å¯ä»¥åªè¯»å–æˆ–è€…ä¿®æ”¹æŸä¸€ä¸ªå­—æ®µï¼Œè€Œ String éœ€è¦ä¸€æ¬¡æ€§æŠŠæ•´ä¸ªå¯¹è±¡å–å‡ºæ¥ã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šhash å’Œ string çš„åŒºåˆ«](https://cdn.tobebetterjavaer.com/stutymore/redis-20240315115713.png)

æ¯”å¦‚è¯´æœ‰ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ `user = {name: 'æ²‰é»˜ç‹äºŒ', age: 18}`ï¼Œå¦‚æœä½¿ç”¨ Hash å­˜å‚¨ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ `age` å­—æ®µï¼š

```java
redis.hset("user:1", "age", 19);
```

å¦‚æœä½¿ç”¨ String å­˜å‚¨ï¼Œéœ€è¦å…ˆå–å‡ºæ•´ä¸ªå¯¹è±¡ï¼Œä¿®æ”¹åå†å­˜å›å»ï¼š

```java
String userJson = redis.get("user:1");
User user = JSON.parseObject(userJson, User.class);
user.setAge(19);
redis.set("user:1", JSON.toJSONString(user));
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨å•†ä¸šåŒ–ä¸€é¢çš„åŸé¢˜ï¼šè¯´è¯´ Redis çš„ zsetï¼Œä»€ä¹ˆæ˜¯è·³è¡¨ï¼Œæ’å…¥ä¸€ä¸ªèŠ‚ç‚¹è¦æ„å»ºå‡ å±‚ç´¢å¼•
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 9 é£ä¹¦åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„æ•°æ®ç±»å‹ï¼ŒZSet çš„å®ç°
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æš‘æœŸå®ä¹ åŒå­¦ E ä¸€é¢é¢è¯•åŸé¢˜ï¼šä½ å¯¹ Redis äº†è§£å¤šå°‘ï¼Œè¯´è¯´å¸¸è§çš„æ•°æ®ç»“æ„å’Œåº”ç”¨åœºæ™¯
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 23 QQ åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„æ•°æ®ç±»å‹
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 7 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´ä¸€ä¸‹ Redis å¸¸ç”¨çš„æ•°æ®ç»“æ„
> 6. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 7 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis ç›¸å…³çš„åŸºç¡€çŸ¥è¯†
> 7. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸ºé¢ç»åŒå­¦ 11 é¢è¯•åŸé¢˜ï¼šé¡¹ç›®ä¸­ä½¿ç”¨äº† redisï¼Œredis æœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Ÿåˆ†åˆ«ä½¿ç”¨çš„åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆä½¿ç”¨ hash ç±»å‹è€Œä¸ä½¿ç”¨ string ç±»å‹åºåˆ—åŒ–å­˜å‚¨ï¼Ÿ
> 8. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ OPPO é¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRediså¸¸è§æ•°æ®ç»“æ„
> 9. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢åŒå­¦ 9 ä¸€é¢é¢è¯•åŸé¢˜ï¼šredisçš„æ•°æ®ç»“æ„ç±»å‹ï¼Ÿ
> 10. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„é˜¿é‡Œäº‘é¢ç»åŒå­¦ 22 é¢ç»ï¼šredisé«˜çº§æ•°æ®ç»“æ„çš„ä½¿ç”¨åœºæ™¯
> 11. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 29 Java åç«¯ä¸€é¢åŸé¢˜ï¼šRedisä¿è¯incrå‘½ä»¤åŸå­æ€§çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

memoï¼š2025 å¹´ 4 æœˆ 29 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©[æœ‰çƒå‹å‘ä¿¡æ¯](https://javabetter.cn/zhishixingqiu/)è¯´æ‹¿åˆ°äº†äºšé©¬é€Šçš„ offerï¼Œå·¥èµ„è¿˜ç»™çš„å¾ˆé«˜ï¼Œé—®æˆ‘è¦ä¸è¦é€‰ï¼Ÿ çœŸçš„æ­å–œäº†ğŸ‰ã€‚

![çƒå‹æ‹¿åˆ°äº†äºšé©¬é€Šçš„ offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250429155817.png)

### ğŸŒŸ4.Redis ä¸ºä»€ä¹ˆå¿«å‘¢ï¼Ÿ

ç¬¬ä¸€ï¼ŒRedis çš„æ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨å†…å­˜ä¸­ï¼Œè€Œå†…å­˜çš„è¯»å†™é€Ÿåº¦æœ¬èº«å°±æ¯”ç£ç›˜å¿«å‡ ä¸ªæ•°é‡çº§ã€‚

![Shirleyï¼šRedis åŸºäºå†…å­˜](https://cdn.tobebetterjavaer.com/stutymore/redis-20250430112922.png)

ç¬¬äºŒï¼ŒRedis é‡‡ç”¨äº†åŸºäº IO å¤šè·¯å¤ç”¨æŠ€æœ¯çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹æ¥å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å’Œæ‰§è¡Œ Redis å‘½ä»¤ã€‚

![å£«äº‘ï¼šRedisçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250430132517.png)

å…¶ä¸­çš„ IO å¤šè·¯å¤ç”¨æŠ€æœ¯å¯ä»¥åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼ŒåŒæ—¶ç›‘å¬æˆåƒä¸Šä¸‡ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œè§£å†³ä¼ ç»Ÿ IO æ¨¡å‹ä¸­æ¯ä¸ªè¿æ¥éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚

![Ricoï¼šIO å¤šè·¯å¤ç”¨](https://cdn.tobebetterjavaer.com/stutymore/redis-20250430143547.png)

IO å¤šè·¯å¤ç”¨ä¼šæŒç»­ç›‘å¬è¯·æ±‚ï¼Œç„¶åæŠŠå‡†å¤‡å¥½çš„è¯·æ±‚å‹å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—å½“ä¸­ï¼Œå¹¶å°†å…¶æœ‰åºåœ°ä¼ é€’ç»™æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼Œæœ€åç”±äº‹ä»¶å¤„ç†å™¨æ¥æ‰§è¡Œå¯¹åº”çš„ acceptã€read å’Œ write è¯·æ±‚ã€‚

![å¼€å‘è€…å†…åŠŸä¿®ç‚¼ï¼šRedis äº‹ä»¶é©±åŠ¨æœºåˆ¶](https://cdn.tobebetterjavaer.com/stutymore/redis-20250430150054.png)

Redis ä¼šæ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©æœ€ä¼˜çš„ IO å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œæ¯”å¦‚ Linux ä¸‹ä½¿ç”¨ epollï¼ŒmacOS ä¸‹ä½¿ç”¨ kqueue ç­‰ã€‚

```c
// epoll çš„åˆ›å»ºå’Œä½¿ç”¨
int epfd = epoll_create(1024); // åˆ›å»º epoll å®ä¾‹
struct epoll_event ev, events[MAX_EVENTS];

// æ·»åŠ ç›‘å¬äº‹ä»¶
ev.events = EPOLLIN;
ev.data.fd = listen_sock;
epoll_ctl(epfd, EPOLL_CTL_ADD, listen_sock, &ev);

// ç­‰å¾…äº‹ä»¶å‘ç”Ÿ
while (1) {
    int nfds = epoll_wait(epfd, events, MAX_EVENTS, -1);
    for (int i = 0; i < nfds; i++) {
        // å¤„ç†å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦
    }
}
```

åœ¨ Redis 6.0 ä¹‹å‰ï¼ŒåŒ…æ‹¬è¿æ¥å»ºç«‹ã€è¯·æ±‚è¯»å–ã€å“åº”å‘é€ï¼Œä»¥åŠå‘½ä»¤æ‰§è¡Œéƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­é¡ºåºæ‰§è¡Œçš„ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„é”ç«äº‰å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸º Redis çš„ç»å¤§éƒ¨åˆ†æ“ä½œéƒ½æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œçš„ï¼Œæ€§èƒ½ç“¶é¢ˆä¸»è¦æ˜¯å†…å­˜æ“ä½œå’Œç½‘ç»œé€šä¿¡ï¼Œè€Œä¸æ˜¯ CPUã€‚

![å°çœ¼ç›èŠæŠ€æœ¯ï¼šRedis å•çº¿ç¨‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250430145617.png)

ä¸ºäº†è¿›ä¸€æ­¥è§£å†³ç½‘ç»œ IO çš„æ€§èƒ½ç“¶é¢ˆï¼ŒRedis 6.0 å¼•å…¥äº†å¤šçº¿ç¨‹æœºåˆ¶ï¼ŒæŠŠç½‘ç»œ IO å’Œå‘½ä»¤æ‰§è¡Œåˆ†å¼€ï¼Œç½‘ç»œ IO äº¤ç»™çº¿ç¨‹æ± æ¥å¤„ç†ï¼Œè€Œå‘½ä»¤æ‰§è¡Œä»ç„¶åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œï¼Œè¿™æ ·å°±å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„æ€§èƒ½ã€‚

![å°çœ¼ç›èŠæŠ€æœ¯ï¼šRedis6.0 å¼•å…¥äº†å¤šçº¿ç¨‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250430145654.png)

ä¸»çº¿ç¨‹ä¸“æ³¨äºå‘½ä»¤æ‰§è¡Œï¼Œç½‘ç»œIO ç”±å…¶ä»–çº¿ç¨‹åˆ†æ‹…ï¼Œåœ¨å¤šæ ¸ CPU ç¯å¢ƒä¸‹ï¼ŒRedis çš„æ€§èƒ½å¯ä»¥å¾—åˆ°æ˜¾è‘—æå‡ã€‚

![lxkkaï¼šRedis io çº¿ç¨‹å’Œä¸»çº¿ç¨‹çš„å…³ç³»](https://cdn.tobebetterjavaer.com/stutymore/redis-20250430151846.png)

ç¬¬ä¸‰ï¼ŒRedis å¯¹åº•å±‚æ•°æ®ç»“æ„åšäº†æè‡´çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚è¯´ String çš„åº•å±‚æ•°æ®ç»“æ„åŠ¨æ€å­—ç¬¦ä¸²æ”¯æŒåŠ¨æ€æ‰©å®¹ã€é¢„åˆ†é…å†—ä½™ç©ºé—´ï¼Œèƒ½å¤Ÿå‡å°‘å†…å­˜ç¢ç‰‡å’Œå†…å­˜åˆ†é…çš„å¼€é”€ã€‚

![å¤æ˜åœ°ç›†ï¼šRedis çš„æ•°æ®ç±»å‹å’Œåº•å±‚æ•°æ®ç»“æ„](https://cdn.tobebetterjavaer.com/stutymore/redis-20250430152926.png)

æ€»ç»“ï¼š

![Backend Scaling Playbookï¼šRedis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504095007.png)

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯ Java åç«¯å®ä¹ ä¸€é¢åŸé¢˜ï¼šRedis ä¸ºä»€ä¹ˆè¯»å†™æ€§èƒ½é«˜ï¼Ÿ
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆ redis å¿«ï¼Œæ·˜æ±°ç­–ç•¥ æŒä¹…åŒ–
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šå•çº¿ç¨‹çš„ Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¾®ä¼—é“¶è¡ŒåŒå­¦ 1 Java åç«¯ä¸€é¢çš„åŸé¢˜ï¼šRedis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç™¾åº¦é¢ç»åŒå­¦ 1 æ–‡å¿ƒä¸€è¨€ 25 å®ä¹  Java åç«¯é¢è¯•åŸé¢˜ï¼šé¡¹ç›®ä¸­ä»€ä¹ˆåœ°æ–¹ä½¿ç”¨äº† redis ç¼“å­˜ï¼Œredis ä¸ºä»€ä¹ˆå¿«ï¼Ÿ
> 6. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 8 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis ä¸ºä»€ä¹ˆå¿«
> 7. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 21  æŠ–éŸ³å•†åŸä¸€é¢é¢è¯•åŸé¢˜ï¼šredisä¸ºä»€ä¹ˆèƒ½å¤„ç†é«˜å¹¶å‘

memoï¼š2025 å¹´ 4 æœˆ 30 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©[æœ‰çƒå‹å‘ä¿¡æ¯](https://javabetter.cn/zhishixingqiu/)è¯´æ‹¿åˆ°äº†æ»´æ»´çš„å®ä¹  offerï¼ŒçœŸçš„æ­å–œäº†ğŸ‰ã€‚

![çƒå‹æ‹¿åˆ°äº†æ»´æ»´çš„æš‘æœŸå®ä¹  offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250501102228.png)

### 5.èƒ½è¯¦ç»†è¯´ä¸€ä¸‹IOå¤šè·¯å¤ç”¨å—ï¼Ÿ

IO å¤šè·¯å¤ç”¨æ˜¯ä¸€ç§å…è®¸å•ä¸ªè¿›ç¨‹åŒæ—¶ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æŠ€æœ¯ï¼Œä½¿å¾—ç¨‹åºèƒ½å¤Ÿé«˜æ•ˆå¤„ç†å¤šä¸ªå¹¶å‘è¿æ¥è€Œæ— éœ€åˆ›å»ºå¤§é‡çº¿ç¨‹ã€‚

![Journey-Cï¼šIO å¤šè·¯å¤ç”¨](https://cdn.tobebetterjavaer.com/stutymore/redis-20250501104352.png)

IO å¤šè·¯å¤ç”¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šè®©å•ä¸ªçº¿ç¨‹å¯ä»¥ç­‰å¾…å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼Œç„¶åå¯¹å°±ç»ªçš„æè¿°ç¬¦è¿›è¡Œæ“ä½œã€‚è¿™æ ·å¯ä»¥åœ¨ä¸ä½¿ç”¨å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹çš„æƒ…å†µä¸‹å¤„ç†å¹¶å‘è¿æ¥ã€‚

![è›®è†ï¼šIO å¤šè·¯å¤ç”¨å’Œå¤šçº¿ç¨‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250501104549.png)

ä¸»è¦çš„å®ç°æœºåˆ¶åŒ…æ‹¬ selectã€pollã€epollã€kqueue å’Œ IOCP ç­‰ã€‚

#### è¯·è¯´è¯´ selectã€pollã€epollã€kqueue å’Œ IOCP çš„åŒºåˆ«ï¼Ÿ

select çš„ç¼ºç‚¹æ˜¯å•ä¸ªè¿›ç¨‹èƒ½ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡æœ‰é™ï¼Œä¸€èˆ¬ä¸º 1024 ä¸ªï¼Œä¸”æ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆä»ç”¨æˆ·æ€å¤åˆ¶åˆ°å†…æ ¸æ€ï¼Œç„¶åéå†æ‰¾å‡ºå°±ç»ªçš„æè¿°ç¬¦ï¼Œæ€§èƒ½è¾ƒå·®ã€‚

```c
// select çš„åŸºæœ¬ä½¿ç”¨
int select(int nfds, fd_set *readfds, fd_set *writefds, 
           fd_set *exceptfds, struct timeval *timeout);

// ç¤ºä¾‹ä»£ç 
fd_set readfds;
FD_ZERO(&readfds);                // æ¸…ç©ºé›†åˆ
FD_SET(sockfd, &readfds);         // æ·»åŠ ç›‘å¬å¥—æ¥å­—
select(sockfd + 1, &readfds, NULL, NULL, NULL);
if (FD_ISSET(sockfd, &readfds)) { // æ£€æŸ¥æ˜¯å¦å°±ç»ª
    // å¤„ç†è¯»äº‹ä»¶
}
```

poll çš„ä¼˜ç‚¹æ˜¯æ²¡æœ‰æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ï¼Œä½†æ˜¯æ¯æ¬¡è°ƒç”¨ä»ç„¶éœ€è¦å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆä»ç”¨æˆ·æ€å¤åˆ¶åˆ°å†…æ ¸æ€ï¼Œä¾ç„¶éœ€è¦éå†ï¼Œæ€§èƒ½ä»ç„¶è¾ƒå·®ã€‚

```c
// poll çš„åŸºæœ¬ä½¿ç”¨
int poll(struct pollfd *fds, nfds_t nfds, int timeout);

// ç¤ºä¾‹ä»£ç 
struct pollfd fds[MAX_EVENTS];
fds[0].fd = sockfd;
fds[0].events = POLLIN;    // ç›‘å¬è¯»äº‹ä»¶
poll(fds, 1, -1);
if (fds[0].revents & POLLIN) {
    // å¤„ç†è¯»äº‹ä»¶
}
```

epoll æ˜¯ Linux ç‰¹æœ‰çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œæ”¯æŒå¤§è§„æ¨¡å¹¶å‘è¿æ¥ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œæ€§èƒ½æ›´é«˜ã€‚å…¶å·¥ä½œåŸç†æ˜¯å°†æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ°å†…æ ¸ä¸­ï¼Œç„¶åé€šè¿‡äº‹ä»¶é€šçŸ¥æœºåˆ¶æ¥å¤„ç†å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸éœ€è¦è½®è¯¢ï¼Œä¹Ÿä¸éœ€è¦æ•°æ®æ‹·è´ï¼Œæ›´æ²¡æœ‰æ•°é‡é™åˆ¶ï¼Œæ‰€ä»¥æ€§èƒ½éå¸¸é«˜ã€‚

```c
// epoll çš„åŸºæœ¬ä½¿ç”¨
int epoll_create(int size);
int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);
int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);

// ç¤ºä¾‹ä»£ç 
int epfd = epoll_create(1);
struct epoll_event ev, events[MAX_EVENTS];
ev.events = EPOLLIN;
ev.data.fd = sockfd;
epoll_ctl(epfd, EPOLL_CTL_ADD, sockfd, &ev);

while (1) {
    int nfds = epoll_wait(epfd, events, MAX_EVENTS, -1);
    for (int i = 0; i < nfds; i++) {
        if (events[i].data.fd == sockfd) {
            // å¤„ç†è¯»äº‹ä»¶
        }
    }
}
```

kqueue æ˜¯ BSD/macOS ç³»ç»Ÿä¸‹çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œç±»ä¼¼äº epollï¼Œæ”¯æŒå¤§è§„æ¨¡å¹¶å‘è¿æ¥ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å‹ã€‚

```c
int kqueue(void);
int kevent(int kq, const struct kevent *changelist, int nchanges, struct kevent *eventlist, int nevents, const struct timespec *timeout);
```

IOCP æ˜¯ Windows ç³»ç»Ÿä¸‹çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä½¿ç”¨ä½¿ç”¨å®Œæˆç«¯å£æ¨¡å‹è€Œéäº‹ä»¶é€šçŸ¥ã€‚

```c
HANDLE CreateIoCompletionPort(HANDLE FileHandle, HANDLE ExistingCompletionPort, ULONG_PTR CompletionKey, DWORD NumberOfConcurrentThreads);
```

#### ä¸¾ä¸ªä¾‹å­è¯´ä¸€ä¸‹ IO å¤šè·¯å¤ç”¨ï¼Ÿ

æ¯”å¦‚è¯´æˆ‘æ˜¯ä¸€åæ•°å­¦è€å¸ˆï¼Œä¸Šè¯¾æ—¶æå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼šâ€œä»Šå¤©è°æ¥è¯æ˜ä¸€ä¸‹å‹¾è‚¡å®šå¾‹ï¼Ÿâ€

åŒå­¦å°ç‹ä¸¾æ‰‹ï¼Œæˆ‘å°±è®©å°ç‹å›ç­”ï¼›å°æä¸¾æ‰‹ï¼Œæˆ‘å°±è®©å°æå›ç­”ï¼›å°å¼ ä¸¾æ‰‹ï¼Œæˆ‘å°±è®©å°å¼ å›ç­”ã€‚

è¿™ç§æ¨¡å¼å°±æ˜¯ IO å¤šè·¯å¤ç”¨ï¼Œæˆ‘åªéœ€è¦åœ¨è®²å°ä¸Šç­‰ï¼Œè°ä¸¾æ‰‹è°å›ç­”ï¼Œä¸éœ€è¦ä¸€ä¸ªä¸€ä¸ªå»é—®ã€‚

![æœ‰ç›å…ˆç”Ÿï¼šIO å¤šè·¯å¤ç”¨](https://cdn.tobebetterjavaer.com/stutymore/redis-20240918114125.png)

Redis å°±æ˜¯ä½¿ç”¨ epoll è¿™æ ·çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåœ¨å•çº¿ç¨‹æ¨¡å‹ä¸‹å®ç°é«˜æ•ˆçš„ç½‘ç»œ IOï¼Œä»è€Œæ”¯æŒé«˜å¹¶å‘çš„è¯·æ±‚å¤„ç†ã€‚

#### ä¸¾ä¾‹å­è¯´ä¸€ä¸‹é˜»å¡ IOå’Œ IO å¤šè·¯å¤ç”¨çš„å·®åˆ«ï¼Ÿ

å‡è®¾æˆ‘æ˜¯ä¸€åè€å¸ˆï¼Œè®©å­¦ç”Ÿè§£ç­”ä¸€é“é¢˜ç›®ã€‚

æˆ‘çš„ç¬¬ä¸€ç§é€‰æ‹©ï¼šæŒ‰é¡ºåºé€ä¸ªæ£€æŸ¥ï¼Œå…ˆæ£€æŸ¥ AåŒå­¦ï¼Œç„¶åæ˜¯ Bï¼Œä¹‹åæ˜¯ Cã€Dã€‚ã€‚ã€‚è¿™ä¸­é—´å¦‚æœæœ‰ä¸€ä¸ªå­¦ç”Ÿå¡ä½ï¼Œå…¨ç­éƒ½ä¼šè¢«è€½è¯¯ã€‚

è¿™ç§å°±æ˜¯é˜»å¡ IOï¼Œä¸å…·æœ‰å¹¶å‘èƒ½åŠ›ã€‚

![é˜»å¡ IOå’Œ IOå¤šè·¯å¤ç”¨å·®åˆ«](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-eb541432-d68a-4dd9-b427-96c4dd607d64.png)

æˆ‘çš„ç¬¬äºŒç§é€‰æ‹©ï¼Œæˆ‘ç«™åœ¨è®²å°ä¸Šç­‰ï¼Œè°ä¸¾æ‰‹æˆ‘å»æ£€æŸ¥è°ã€‚Cã€D ä¸¾æ‰‹ï¼Œæˆ‘å»æ£€æŸ¥ Cã€D çš„ç­”æ¡ˆï¼Œç„¶åç»§ç»­å›åˆ°è®²å°ä¸Šç­‰ã€‚æ­¤æ—¶ Eã€A åˆä¸¾æ‰‹ï¼Œç„¶åå»å¤„ç† E å’Œ Aã€‚

#### selectã€poll å’Œ epoll çš„å®ç°åŸç†ï¼Ÿ

select å’Œ poll éƒ½æ˜¯é€šè¿‡æŠŠæ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™å†…æ ¸ï¼Œç”±å†…æ ¸éå†åˆ¤æ–­å“ªäº›å°±ç»ªã€‚

select å°†æ–‡ä»¶æè¿°ç¬¦ FD é€šè¿‡ BitsMap ä¼ å…¥å†…æ ¸ï¼Œè½®è¯¢æ‰€æœ‰çš„ FDï¼Œé€šè¿‡è°ƒç”¨ file->poll å‡½æ•°æŸ¥è¯¢æ˜¯å¦æœ‰å¯¹åº”äº‹ä»¶ï¼Œæ²¡æœ‰å°±å°† task åŠ å…¥ FD å¯¹åº” file çš„å¾…å”¤é†’é˜Ÿåˆ—ï¼Œç­‰å¾…äº‹ä»¶æ¥ä¸´è¢«å”¤é†’ã€‚

![journey-cï¼šselect](https://cdn.tobebetterjavaer.com/stutymore/redis-20250501113356.png)

poll æ”¹è¿›äº†è¿æ¥æ•°ä¸Šé™é—®é¢˜ï¼Œä¸å†ç”¨ BitsMap æ¥ä¼ å…¥ FDï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åŠ¨æ€æ•°ç»„ pollfdï¼Œä½†æœ¬è´¨ä¸Šä»æ˜¯çº¿æ€§éå†ï¼Œæ€§èƒ½æ²¡æœ‰æå‡å¤ªå¤šã€‚

![journey-cï¼špoll](https://cdn.tobebetterjavaer.com/stutymore/redis-20250501113618.png)

selectå’Œpollçš„æ¨¡å¼éƒ½æ˜¯ï¼Œä¸€æ¬¡å°†å‚æ•°æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œç­‰æœ‰ç»“æœäº†å†ä¸€æ¬¡æ‹·è´å‡ºå»ã€‚

epoll å°†ç›‘å¬çš„ FD æ³¨å†Œè¿›å†…æ ¸çš„çº¢é»‘æ ‘ï¼Œç”±å†…æ ¸åœ¨äº‹ä»¶è§¦å‘æ—¶å°†å°±ç»ªçš„ FD æ”¾å…¥ ready listã€‚åº”ç”¨ç¨‹åºé€šè¿‡ epoll_wait è·å–å°±ç»ªçš„ FDï¼Œä»è€Œé¿å…éå†æ‰€æœ‰è¿æ¥çš„å¼€é”€ã€‚

![journey-cï¼šepoll](https://cdn.tobebetterjavaer.com/stutymore/redis-20250501113710.png)

epoll æœ€å¤§çš„ä¼˜ç‚¹æ˜¯ï¼šæ”¯æŒäº‹ä»¶é©±åŠ¨ + è¾¹ç¼˜è§¦å‘ï¼ŒADD æ—¶æ‹·è´ä¸€æ¬¡ï¼Œepoll_wait æ—¶åˆ©ç”¨ MMAP å’Œç”¨æˆ·å…±äº«ç©ºé—´ï¼Œç›´æ¥æ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå› æ­¤åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½è¿œé«˜äº select å’Œ pollã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 21  æŠ–éŸ³å•†åŸä¸€é¢é¢è¯•åŸé¢˜ï¼šioå¤šè·¯å¤ç”¨äº†è§£å—ï¼Ÿ
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¿«æ‰‹åŒå­¦ 4 ä¸€é¢åŸé¢˜ï¼šIOå¤šè·¯å¤ç”¨ä¸­select/poll/epollå„è‡ªçš„å®ç°åŸç†å’ŒåŒºåˆ«ï¼Ÿ
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦19ç•ªèŒ„å°è¯´ä¸€é¢é¢è¯•åŸé¢˜ï¼šLinuxä¸­çš„IOå¤šè·¯å¤ç”¨

memoï¼š2025 å¹´ 5 æœˆ 1 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©[å¸®çƒå‹ä¿®æ”¹ç®€å†æ—¶](https://javabetter.cn/zhishixingqiu/jianli.html) æ—¶ï¼Œç¢°åˆ°ä¸€ååŒ—äº¬äº¤é€šå¤§å­¦çš„åŒå­¦ï¼Œåˆä¸€æ‰€ 211 é™¢æ ¡ï¼Œæ˜ŸçƒçœŸçš„æ˜¯äººæ‰æµæµï¼Œå¤§å®¶ä¸€èµ·åŠ æ²¹å§ï¼ˆéª„å‚²ï¼‰ã€‚

![åŒ—äº¬äº¤é€šå¤§å­¦çš„çƒå‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250502100516.png)

### 6. Redisä¸ºä»€ä¹ˆæ—©æœŸé€‰æ‹©å•çº¿ç¨‹ï¼Ÿ

ç¬¬ä¸€ï¼Œå•çº¿ç¨‹æ¨¡å‹ä¸éœ€è¦è€ƒè™‘å¤æ‚çš„é”æœºåˆ¶ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ­»é”ã€ç«æ€æ¡ä»¶ç­‰é—®é¢˜ï¼Œå¼€å‘èµ·æ¥æ›´å¿«ï¼Œä¹Ÿæ›´å®¹æ˜“ç»´æŠ¤ã€‚

![wsh-study.comï¼šRedisçš„å•çº¿ç¨‹æ¨¡å‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250502100006.png)

ç¬¬äºŒï¼ŒRedis æ˜¯IO å¯†é›†å‹è€Œé CPU å¯†é›†å‹ï¼Œä¸»è¦å—å†…å­˜å’Œç½‘ç»œ IO é™åˆ¶ï¼Œè€Œé CPU çš„è®¡ç®—èƒ½åŠ›ï¼Œå•çº¿ç¨‹å¯ä»¥é¿å…çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚

å“ªæ€•æˆ‘ä»¬åœ¨ä¸€ä¸ªæ™®é€šçš„ Linux æœåŠ¡å™¨ä¸Šå¯åŠ¨ Redis æœåŠ¡ï¼Œå®ƒä¹Ÿèƒ½åœ¨ 1s å†…å¤„ç† 1000000 ä¸ªç”¨æˆ·è¯·æ±‚ã€‚

ç¬¬ä¸‰ï¼Œå•çº¿ç¨‹å¯ä»¥ä¿è¯å‘½ä»¤æ‰§è¡Œçš„åŸå­æ€§ï¼Œæ— éœ€é¢å¤–çš„åŒæ­¥æœºåˆ¶ã€‚

![å®˜æ–¹å•çº¿ç¨‹è§£é‡Š](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-344b8461-98d4-495b-a697-70275b0abad6.png)

Redis è™½ç„¶æœ€åˆé‡‡ç”¨äº†å•çº¿ç¨‹è®¾è®¡ï¼Œä½†åç»­çš„ç‰ˆæœ¬ä¸­ä¹Ÿåœ¨ç‰¹å®šæ–¹é¢å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œæ¯”å¦‚è¯´ Redis 4.0 å°±å¼•å¼‚æ­¥å¤šçº¿ç¨‹ï¼Œç”¨äºæ¸…ç†è„æ•°æ®ã€é‡Šæ”¾æ— ç”¨è¿æ¥ã€åˆ é™¤å¤§ Key ç­‰ã€‚



```c
/* ä»æ•°æ®åº“ä¸­åˆ é™¤ä¸€ä¸ªé”®ã€å€¼ä»¥åŠç›¸å…³çš„è¿‡æœŸæ¡ç›®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚
 * å¦‚æœé‡Šæ”¾å€¼å¯¹è±¡éœ€è¦å¤§é‡çš„å†…å­˜åˆ†é…æ“ä½œï¼Œè¯¥å¯¹è±¡å¯èƒ½ä¼šè¢«æ”¾å…¥
 * å»¶è¿Ÿé‡Šæ”¾åˆ—è¡¨ä¸­ï¼Œè€Œä¸æ˜¯åŒæ­¥é‡Šæ”¾ã€‚å»¶è¿Ÿé‡Šæ”¾åˆ—è¡¨å°†åœ¨
 * bio.c çš„å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿›è¡Œå›æ”¶ã€‚ */
#define LAZYFREE_THRESHOLD 64
int dbAsyncDelete(redisDb *db, robj *key) {
    /* ä»è¿‡æœŸå­—å…¸ä¸­åˆ é™¤æ¡ç›®ä¸ä¼šé‡Šæ”¾é”®çš„ sdsï¼Œ
     * å› ä¸ºå®ƒä¸ä¸»å­—å…¸å…±äº«ã€‚ */
    if (dictSize(db->expires) > 0) dictDelete(db->expires,key->ptr);

    /* å¦‚æœå€¼å¯¹è±¡åªåŒ…å«å°‘é‡çš„å†…å­˜åˆ†é…ï¼Œä½¿ç”¨å»¶è¿Ÿé‡Šæ”¾æ–¹å¼
     * å®é™…ä¸Šä¼šæ›´æ…¢... æ‰€ä»¥åœ¨ä¸€å®šé˜ˆå€¼ä»¥ä¸‹ï¼Œæˆ‘ä»¬å°±ç›´æ¥
     * åŒæ­¥é‡Šæ”¾å¯¹è±¡ã€‚ */
    dictEntry *de = dictUnlink(db->dict,key->ptr);
    if (de) {
        robj *val = dictGetVal(de);
        // è®¡ç®—valueçš„å›æ”¶æ”¶ç›Š
        size_t free_effort = lazyfreeGetFreeEffort(val);

        /* å¦‚æœé‡Šæ”¾å¯¹è±¡çš„å·¥ä½œé‡å¤ªå¤§ï¼Œå°±é€šè¿‡å°†å¯¹è±¡æ·»åŠ åˆ°å»¶è¿Ÿé‡Šæ”¾åˆ—è¡¨
         * åœ¨åå°è¿›è¡Œå¤„ç†ã€‚
         * æ³¨æ„ï¼Œå¦‚æœå¯¹è±¡æ˜¯å…±äº«çš„ï¼Œç°åœ¨å°±å›æ”¶å®ƒæ˜¯ä¸å¯èƒ½çš„ã€‚è¿™ç§æƒ…å†µ
         * å¾ˆå°‘å‘ç”Ÿï¼Œä½†æ˜¯æœ‰æ—¶ Redis æ ¸å¿ƒçš„æŸäº›å®ç°éƒ¨åˆ†å¯èƒ½ä¼šè°ƒç”¨
         * incrRefCount() æ¥ä¿æŠ¤å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ dbDelete()ã€‚åœ¨è¿™ç§
         * æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šç»§ç»­æ‰§è¡Œå¹¶åˆ°è¾¾ dictFreeUnlinkedEntry() 
         * è°ƒç”¨ï¼Œè¿™ç›¸å½“äºä»…ä»…è°ƒç”¨ decrRefCount()ã€‚ */
        // åªæœ‰å›æ”¶æ”¶ç›Šè¶…è¿‡ä¸€å®šå€¼ï¼Œæ‰ä¼šæ‰§è¡Œå¼‚æ­¥åˆ é™¤ï¼Œå¦åˆ™è¿˜æ˜¯ä¼šé€€åŒ–åˆ°åŒæ­¥åˆ é™¤
        if (free_effort > LAZYFREE_THRESHOLD && val->refcount == 1) {
            atomicIncr(lazyfree_objects,1);
            bioCreateBackgroundJob(BIO_LAZY_FREE,val,NULL,NULL);
            dictSetVal(db->dict,de,NULL);
        }
    }

    /* é‡Šæ”¾é”®å€¼å¯¹ï¼Œå¦‚æœæˆ‘ä»¬å°† val å­—æ®µè®¾ç½®ä¸º NULL ä»¥ä¾¿ç¨å
     * å»¶è¿Ÿé‡Šæ”¾ï¼Œé‚£ä¹ˆå°±åªé‡Šæ”¾é”®ã€‚ */
    if (de) {
        dictFreeUnlinkedEntry(db->dict,de);
        if (server.cluster_enabled) slotToKeyDel(key->ptr);
        return 1;
    } else {
        return 0;
    }
}
```

å®˜æ–¹è§£é‡Šï¼š[https://redis.io/topics/faq](https://redis.io/topics/faq)

memoï¼š2025 å¹´ 5 æœˆ 2 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©[å¸®çƒå‹ä¿®æ”¹ç®€å†æ—¶](https://javabetter.cn/zhishixingqiu/jianli.html) æ—¶ï¼Œç¢°åˆ°ä¸€ååŒæµå¤§å­¦çš„åŒå­¦ï¼Œè®©æ„Ÿè§‰è‡ªå·±çš„ä»˜å‡ºæ­£åœ¨è¶Šæ¥è¶Šå¤šè¢«æ›´å¤šäººçœ‹åˆ°ï¼ŒçœŸçš„å¾ˆå¼€å¿ƒã€‚

![åŒæµå¤§å­¦çš„çƒå‹æ¥äº†](https://cdn.tobebetterjavaer.com/stutymore/redis-20250503091439.png)

### 7.Redis 6.0 ä½¿ç”¨å¤šçº¿ç¨‹æ˜¯æ€ä¹ˆå›äº‹?

Redis 6.0 çš„å¤šçº¿ç¨‹ä»…ç”¨äºå¤„ç†ç½‘ç»œ IOï¼ŒåŒ…æ‹¬ç½‘ç»œæ•°æ®çš„è¯»å–ã€å†™å…¥ï¼Œä»¥åŠè¯·æ±‚è§£æã€‚

```
â”‚ å•çº¿ç¨‹æ‰§è¡Œå‘½ä»¤ â”‚
                  â”‚    â†‘    â†“     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”
â”‚ I/Oçº¿ç¨‹1 â”‚ â†â†’ â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚                 â”‚
â”‚ I/Oçº¿ç¨‹2 â”‚ â†â†’ â”‚    ä¸»çº¿ç¨‹       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚                 â”‚
â”‚ I/Oçº¿ç¨‹3 â”‚ â†â†’ â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è€Œå‘½ä»¤çš„æ‰§è¡Œä¾ç„¶æ˜¯å•çº¿ç¨‹ï¼Œè¿™ç§è®¾è®¡è¢«ç§°ä¸ºâ€œIO çº¿ç¨‹åŒ–â€ï¼Œèƒ½å¤Ÿåœ¨é«˜è´Ÿè½½çš„æƒ…å†µä¸‹ï¼Œæœ€å¤§é™åº¦åœ°æå‡ Redis çš„å“åº”é€Ÿåº¦ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis6.0å¤šçº¿ç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b7b24e25-d2dc-4457-994f-95bdb3674b8e.png)

---- è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ start ----

è¿™ä¸€å˜åŒ–ä¸»è¦æ˜¯å› ä¸ºéšç€ç½‘ç»œå¸¦å®½å’ŒæœåŠ¡å™¨æ€§èƒ½çš„æå‡ï¼ŒRedis çš„ç“¶é¢ˆä» CPU é€æ¸è½¬ç§»åˆ°äº†ç½‘ç»œ IOï¼š

- å¸¦å®½ä» 10Gbps æå‡åˆ° 100Gbpsï¼Œç”šè‡³æ›´é«˜ã€‚
- è¯·æ±‚çš„å¹¶å‘æ•°ä»å‡ åƒåˆ°å‡ ä¸‡ï¼Œç”šè‡³å‡ åä¸‡ã€‚

å•çº¿ç¨‹åœ¨é«˜è´Ÿè½½åœºæ™¯ä¸‹å¤„ç†ç½‘ç»œ IO å‡ºç°äº†æ˜æ˜¾çš„æ€§èƒ½ç“¶é¢ˆï¼ŒRedis çš„å¼€å‘å›¢é˜Ÿé€šè¿‡ç ”ç©¶å‘ç°ï¼Œåœ¨å¤„ç†å¤§æ•°æ®åŒ…æ—¶ï¼Œå•çº¿ç¨‹ Redis æœ‰è¶…è¿‡ 80% çš„ CPU æ—¶é—´èŠ±åœ¨ç½‘ç»œ IO ä¸Šï¼Œè€Œå®é™…å‘½ä»¤æ‰§è¡Œä»…å  20% å·¦å³ã€‚

![wsh-study.comï¼šRedis 6.0çš„å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250502095838.png)

Redis 6.0 çš„å¤šçº¿ç¨‹ IO æ¨¡å‹ä¸»è¦åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š

- ä»ç„¶ç”±ä¸»çº¿ç¨‹è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚
- ä¸»çº¿ç¨‹å°†è¿æ¥è¯·æ±‚åˆ†å‘ç»™å¤šä¸ª IO çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸»çº¿ç¨‹è´Ÿè´£è§£æå’Œæ‰§è¡Œå‘½ä»¤ã€‚
- å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œç”±å¤šä¸ª IO çº¿ç¨‹å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

```c
// Redis ä¸»äº‹ä»¶å¾ªç¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
void beforeSleep(struct aeEventLoop *eventLoop) {
    // 1. ä¸»çº¿ç¨‹åˆ†æ´¾è¯»ä»»åŠ¡ç»™ I/O çº¿ç¨‹
    handleClientsWithPendingReadsUsingThreads();
    
    // 2. ç­‰å¾… I/O çº¿ç¨‹å®Œæˆè¯»å–
    waitForIOThreads();
    
    // 3. ä¸»çº¿ç¨‹å¤„ç†å‘½ä»¤
    processInputBuffer();
    
    // 4. ä¸»çº¿ç¨‹åˆ†æ´¾å†™ä»»åŠ¡ç»™ I/O çº¿ç¨‹
    handleClientsWithPendingWritesUsingThreads();
}
```

Redis 6.0 é»˜è®¤ä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼ï¼Œä½†å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æˆ–å‘½ä»¤è¡Œå‚æ•°å¯ç”¨å¤šçº¿ç¨‹æ¨¡å¼ã€‚

```shell
# å¯ç”¨å¤šçº¿ç¨‹æ¨¡å¼
io-threads 4

# å¯ç”¨å¤šçº¿ç¨‹å†™å…¥ï¼ˆRedis 6.0 é»˜è®¤åªå¼€å¯å¤šçº¿ç¨‹è¯»å–ï¼‰
io-threads-do-reads yes
```

å»ºè®®å°† IO çº¿ç¨‹æ•°è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°çš„ä¸€åŠï¼Œä¸€èˆ¬ä¸å»ºè®®è¶…è¿‡ 8 ä¸ªã€‚

ç»è¿‡å¤šæ¬¡æµ‹è¯•ï¼ŒRedis 6.0 åœ¨å¤„ç† 1-200 å­—èŠ‚çš„å°æ•°æ®åŒ…æ—¶ï¼Œæ€§èƒ½æå‡ 1.5-2 å€ï¼›åœ¨å¤„ç† 1KB ä»¥ä¸Šçš„å¤§æ•°æ®åŒ…æ—¶æå‡çº¦ 3-5 å€ã€‚

----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ end ----

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šredis6.0å¼•å…¥çš„å¤šçº¿ç¨‹ç”¨ä½œä»€ä¹ˆåœ°æ–¹

### 8.è¯´è¯´ Redis çš„å¸¸ç”¨å‘½ä»¤ï¼ˆè¡¥å……ï¼‰

> 2024 å¹´ 04 æœˆ 11 æ—¥å¢è¡¥

ä¸€å¥è¯å›ç­”ï¼ˆä¹Ÿä¸ç”¨å…¨éƒ¨éƒ½èƒŒï¼ŒæŒ‘ä¸‰ä¸ªå°±è¡Œï¼‰ï¼š

Redis æ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå¸¸ç”¨çš„å‘½ä»¤ä¹Ÿæ¯”è¾ƒå¤šï¼Œæ¯”å¦‚è¯´æ“ä½œå­—ç¬¦ä¸²å¯ä»¥ç”¨ `SET/GET/INCR`ï¼Œæ“ä½œå“ˆå¸Œå¯ä»¥ç”¨ `HSET/HGET/HGETALL`ï¼Œæ“ä½œåˆ—è¡¨å¯ä»¥ç”¨ `LPUSH/LPOP/LRANGE`ï¼Œæ“ä½œé›†åˆå¯ä»¥ç”¨ `SADD/SISMEMBER`ï¼Œæ“ä½œæœ‰åºé›†åˆå¯ä»¥ç”¨ `ZADD/ZRANGE/ZINCRBY`ç­‰ï¼Œé€šç”¨å‘½ä»¤æœ‰ `EXPIRE/DEL/KEYS` ç­‰ã€‚

----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ start----

â‘ ã€æ“ä½œå­—ç¬¦ä¸²çš„å‘½ä»¤æœ‰ï¼š

å‘½ä»¤|	ä½œç”¨|	ç¤ºä¾‹
---|---|---
`SET key value`|	è®¾ç½®å­—ç¬¦ä¸²é”®å€¼|	`SET name jack`
`GET key`|	è·å–å­—ç¬¦ä¸²å€¼|	`GET name`
`INCR key`|	æ•°å€¼è‡ªå¢ 1|	`INCR count`
`DECR key`|	æ•°å€¼è‡ªå‡ 1|	`DECR stock`
`INCRBY key N`|	å¢åŠ  N|	`INCRBY views 10`
`APPEND key value`|	è¿½åŠ å­—ç¬¦ä¸²|	`APPEND log "done"`
`GETRANGE key start end`|	è·å–å­ä¸²|	`GETRANGE name 0 3`
`MSET k1 v1 k2 v2`|	æ‰¹é‡è®¾ç½®å¤šä¸ªé”®å€¼|	`MSET a 1 b 2`

â‘¡ã€æ“ä½œåˆ—è¡¨çš„å‘½ä»¤æœ‰ï¼š

- `LPUSH key value`ï¼šå°†ä¸€ä¸ªå€¼æ’å…¥åˆ°åˆ—è¡¨ key çš„å¤´éƒ¨ã€‚
- `RPUSH key value`ï¼šå°†ä¸€ä¸ªå€¼æ’å…¥åˆ°åˆ—è¡¨ key çš„å°¾éƒ¨ã€‚
- `LPOP key`ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨ key çš„å¤´å…ƒç´ ã€‚
- `RPOP key`ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨ key çš„å°¾å…ƒç´ ã€‚
- `LRANGE key start stop`ï¼šè·å–åˆ—è¡¨ key ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ã€‚

â‘¢ã€æ“ä½œé›†åˆçš„å‘½ä»¤æœ‰ï¼š

- `SADD key member`ï¼šå‘é›†åˆ key æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚
- `SREM key member`ï¼šä»é›†åˆ key ä¸­ç§»é™¤ä¸€ä¸ªå…ƒç´ ã€‚
- `SMEMBERS key`ï¼šè¿”å›é›†åˆ key ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚

â‘£ã€æ“ä½œæœ‰åºé›†åˆçš„å‘½ä»¤æœ‰ï¼š

- `ZADD key score member`ï¼šå‘æœ‰åºé›†åˆ key æ·»åŠ ä¸€ä¸ªæˆå‘˜ï¼Œæˆ–æ›´æ–°å…¶åˆ†æ•°ã€‚
- `ZRANGE key start stop [WITHSCORES]`ï¼šæŒ‰ç…§ç´¢å¼•åŒºé—´è¿”å›æœ‰åºé›†åˆ key ä¸­çš„æˆå‘˜ï¼Œå¯é€‰ WITHSCORES å‚æ•°è¿”å›åˆ†æ•°ã€‚
- `ZREVRANGE key start stop [WITHSCORES]`ï¼šè¿”å›æœ‰åºé›†åˆ key ä¸­ï¼ŒæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ï¼ŒæŒ‰åˆ†æ•°é€’å‡ã€‚
- `ZREM key member`ï¼šç§»é™¤æœ‰åºé›†åˆ key ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ã€‚

â‘¤ã€æ“ä½œå“ˆå¸Œçš„å‘½ä»¤æœ‰ï¼š

- `HSET key field value`ï¼šå‘é”®ä¸º key çš„å“ˆå¸Œè¡¨ä¸­è®¾ç½®å­—æ®µ field çš„å€¼ä¸º valueã€‚
- `HGET key field`ï¼šè·å–é”®ä¸º key çš„å“ˆå¸Œè¡¨ä¸­å­—æ®µ field çš„å€¼ã€‚
- `HGETALL key`ï¼šè·å–é”®ä¸º key çš„å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„å­—æ®µå’Œå€¼ã€‚
- `HDEL key field`ï¼šåˆ é™¤é”®ä¸º key çš„å“ˆå¸Œè¡¨ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µã€‚

#### è¯¦ç»†è¯´è¯´ set å‘½ä»¤ï¼Ÿ

SET å‘½ä»¤ç”¨äºè®¾ç½®å­—ç¬¦ä¸²çš„ keyï¼Œæ”¯æŒè¿‡æœŸæ—¶é—´å’Œæ¡ä»¶å†™å…¥ï¼Œå¸¸ç”¨äºè®¾ç½®ç¼“å­˜ã€å®ç°åˆ†å¸ƒå¼é”ã€å»¶é•¿ Session ç­‰åœºæ™¯ã€‚

```shell
SET key value [EX seconds | PX milliseconds | EXAT timestamp | PXAT timestamp-milliseconds | KEEPTTL] [NX | XX] [GET]
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒSET ä¼šè¦†ç›–é”®å·²æœ‰çš„å€¼ã€‚

æ”¯æŒå¤šç§è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ–¹å¼ï¼Œæ¯”å¦‚è¯´ EX è®¾ç½®ç§’çº§è¿‡æœŸæ—¶é—´ï¼ŒPX è®¾ç½®æ¯«ç§’è¿‡æœŸæ—¶é—´ã€‚

æ”¯æŒæ¡ä»¶å†™å…¥ï¼Œä½¿å…¶å¯ä»¥å®ç°åŸå­æ€§æ“ä½œï¼Œæ¯”å¦‚è¯´ NX ä»…åœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½®å€¼ï¼ŒXX ä»…åœ¨é”®å­˜åœ¨æ—¶è®¾ç½®å€¼ã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šset å‘½ä»¤](https://cdn.tobebetterjavaer.com/stutymore/redis-20250503100720.png)

ç¼“å­˜å®ç°ï¼š

```shell
SET user:profile:{userid} {JSONæ•°æ®} EX 3600  # å­˜å‚¨ç”¨æˆ·èµ„æ–™ï¼Œå¹¶è®¾ç½®1å°æ—¶è¿‡æœŸ
```

å®ç°åˆ†å¸ƒå¼é”ï¼š

```shell
SET lock:resource_name {random_value} EX 10 NX  # è·å–é”ï¼Œ10ç§’åè‡ªåŠ¨é‡Šæ”¾
```

å­˜å‚¨ Sessionï¼š

```shell
SET session:{sessionid} {session_data} EX 1800  # å­˜å‚¨ç”¨æˆ·ä¼šè¯ï¼Œ30åˆ†é’Ÿè¿‡æœŸ
```

#### sadd å‘½ä»¤çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿ

SADD æ”¯æŒä¸€æ¬¡æ·»åŠ å¤šä¸ªå…ƒç´ ï¼Œè¿”å›å€¼ä¸ºå®é™…æ·»åŠ æˆåŠŸçš„å…ƒç´ æ•°é‡ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(N)ã€‚

```shell
redis-cli SADD myset "apple" "banana" "orange"
```

#### incrå‘½ä»¤äº†è§£å—ï¼Ÿ

INCR æ˜¯ä¸€ä¸ªåŸå­å‘½ä»¤ï¼Œå¯ä»¥å°†æŒ‡å®šé”®çš„å€¼åŠ  1ï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œä¼šå…ˆå°†å…¶è®¾ç½®ä¸º 0ï¼Œå†æ‰§è¡ŒåŠ  1 æ“ä½œã€‚

![äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ï¼šINCR](https://cdn.tobebetterjavaer.com/stutymore/redis-20250503095411.png)

å¸¸ç”¨äºç½‘ç«™è®¿é—®é‡ã€æ–‡ç« ç‚¹èµæ•°ç­‰è®¡æ•°å™¨çš„å®ç°ï¼›ç»“åˆè¿‡æœŸæ—¶é—´å®ç°é™æµå™¨ï¼›ç”Ÿæˆåˆ†å¸ƒå¼å”¯ä¸€ IDï¼›åº“å­˜æ‰£å‡ç­‰ã€‚

```shell
# é™åˆ¶ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤šè®¿é—®10æ¬¡
FUNCTION limit_api_call(user_id)
    current = INCR("rate:"+user_id)
    IF current == 1 THEN
        EXPIRE("rate:"+user_id, 60)
    END
    IF current > 10 THEN
        RETURN false  # è¶…å‡ºé™åˆ¶
    ELSE
        RETURN true   # å…è®¸è®¿é—®
    END
END
```


> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 1 Java æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´è¯´ Redis å¸¸ç”¨å‘½ä»¤
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 3 Java åç«¯é¢è¯•åŸé¢˜ï¼šè¯´çš„é‚£ä¹ˆå¥½ï¼ŒRedis è®¾ç½® key value çš„å‡½æ•°æ˜¯å•¥
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 1 éƒ¨é—¨ä¸»ç«™æŠ€æœ¯éƒ¨é¢è¯•åŸé¢˜ï¼šRedis çš„ sadd å‘½ä»¤æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿ

memoï¼š2025 å¹´ 5 æœˆ 3 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©[æœ‰çƒå‹å‘ä¿¡æ¯](https://javabetter.cn/zhishixingqiu/)è¯´æ‹¿åˆ°äº†ç¾çš„çš„è½¯å¼€æš‘æœŸå®ä¹  offerï¼Œè™½ç„¶ä»–è‡ªå·±ä¸æ»¡æ„ï¼Œä½†æš‚æ—¶æ²¡æœ‰å…¶ä»–æ›´å¥½çš„ï¼Œæˆ‘å»ºè®®ä»–å…ˆå»è¯•ä¸€ä¸‹ğŸ‰ã€‚

![çƒå‹æ‹¿åˆ°äº†ç¾çš„çš„ offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250503101721.png)

### 9.å•çº¿ç¨‹çš„Redis QPS èƒ½åˆ°å¤šå°‘ï¼Ÿ(è¡¥å……)

> 2024 å¹´ 4 æœˆ 14 æ—¥å¢è¡¥

æ ¹æ®[å®˜æ–¹çš„åŸºå‡†æµ‹è¯•](https://redis.io/docs/latest/operate/oss_and_stack/management/optimization/benchmarks/)ï¼Œä¸€ä¸ªæ™®é€šæœåŠ¡å™¨çš„ Redis å®ä¾‹é€šå¸¸å¯ä»¥è¾¾åˆ°æ¯ç§’åä¸‡å·¦å³çš„ QPSã€‚

![æ¯ç§’è¯·æ±‚æ•°èƒ½è¾¾åˆ°10 ä¸‡çº§](https://cdn.tobebetterjavaer.com/stutymore/redis-20250427143852.png)

----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ start ----

Redis çš„ QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰æ€§èƒ½å–å†³äºå¤šç§å› ç´ ï¼ŒåŒ…æ‹¬ç¡¬ä»¶é…ç½®ã€ç½‘ç»œå»¶è¿Ÿã€æ•°æ®ç»“æ„ã€å‘½ä»¤ç±»å‹ç­‰ã€‚

å¯ä»¥é€šè¿‡ `redis-benchmark` å‘½ä»¤è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼š

```shell
redis-benchmark -h 127.0.0.1 -p 6379 -c 50 -n 10000
```

- `-h`ï¼šæŒ‡å®š Redis æœåŠ¡å™¨çš„åœ°å€ï¼Œé»˜è®¤æ˜¯ 127.0.0.1ã€‚
- `-p`ï¼šæŒ‡å®š Redis æœåŠ¡å™¨çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯ 6379ã€‚
- `-c`ï¼šå¹¶å‘è¿æ¥æ•°ï¼Œå³åŒæ—¶æœ‰å¤šå°‘ä¸ªå®¢æˆ·ç«¯åœ¨è¿›è¡Œæµ‹è¯•ã€‚
- `-n`ï¼šè¯·æ±‚æ€»æ•°ï¼Œå³æµ‹è¯•è¿‡ç¨‹ä¸­æ€»å…±è¦æ‰§è¡Œå¤šå°‘ä¸ªè¯·æ±‚ã€‚

2023 å¹´å‰ï¼Œæˆ‘ç”¨çš„æ˜¯ä¸€å° macOSï¼Œ4 GHz å››æ ¸ Intel Core i7ï¼Œ32 GB 1867 MHz DDR3ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis çš„åŸºå‡†æµ‹è¯•](https://cdn.tobebetterjavaer.com/stutymore/redis-20240408100900.png)

å¯ä»¥çœ‹å¾—å‡ºï¼Œæ¯ç§’èƒ½å¤„ç†è¶…è¿‡ 10 ä¸‡æ¬¡è¯·æ±‚ã€‚

```
QPS = æ€»è¯·æ±‚æ•° / æ€»è€—æ—¶ = 10000 / 0.09 â‰ˆ 111111 QPS
```

å»¶è¿Ÿä¹Ÿéå¸¸ä½ï¼Œ99% çš„è¯·æ±‚éƒ½åœ¨ 0.3ms ä»¥å†…å®Œæˆäº†ã€‚

----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ end ----

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šå•çº¿ç¨‹ Redis çš„ QPS æ˜¯å¤šå°‘ï¼Ÿ

<MZNXQRcodeBanner />

## æŒä¹…åŒ–

### ğŸŒŸ10.Redisçš„æŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›ï¼Ÿ

ä¸»è¦æœ‰ä¸¤ç§ï¼ŒRDB å’Œ AOFã€‚RDB é€šè¿‡åˆ›å»ºæ—¶é—´ç‚¹å¿«ç…§æ¥å®ç°æŒä¹…åŒ–ï¼ŒAOF é€šè¿‡è®°å½•æ¯ä¸ªå†™æ“ä½œå‘½ä»¤æ¥å®ç°æŒä¹…åŒ–ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisæŒä¹…åŒ–çš„ä¸¤ç§æ–¹å¼](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-3bda4a46-adc3-4f0d-a135-b8ae5d4c0d5d.png)

è¿™ä¸¤ç§æ–¹å¼å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚è¿™æ ·å°±å¯ä»¥ä¿è¯ Redis æœåŠ¡å™¨åœ¨é‡å¯åä¸ä¸¢å¤±æ•°æ®ï¼Œé€šè¿‡ RDB å’Œ AOF æ–‡ä»¶æ¥æ¢å¤å†…å­˜ä¸­åŸæœ‰çš„æ•°æ®ã€‚

![Gauravï¼šRDB å’Œ AOF](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504101901.png)

#### è¯¦ç»†è¯´ä¸€ä¸‹ RDBï¼Ÿ

RDB æŒä¹…åŒ–æœºåˆ¶å¯ä»¥åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…å°† Redis æŸä¸€æ—¶åˆ»çš„æ•°æ®ä¿å­˜åˆ°ç£ç›˜ä¸Šçš„ RDB æ–‡ä»¶ä¸­ï¼Œå½“ Redis é‡å¯æ—¶ï¼Œå¯ä»¥é€šè¿‡åŠ è½½è¿™ä¸ª RDB æ–‡ä»¶æ¥æ¢å¤æ•°æ®ã€‚

![Animesh Gaitondeï¼šRDB](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504102121.png)

RDB æŒä¹…åŒ–å¯ä»¥é€šè¿‡ save å’Œ bgsave å‘½ä»¤æ‰‹åŠ¨è§¦å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ save æŒ‡ä»¤è‡ªåŠ¨è§¦å‘ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šsaveå’Œbgsave](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-ffe56e32-34c5-453d-8859-c2febbe6a038.png)

save å‘½ä»¤ä¼šé˜»å¡ Redis è¿›ç¨‹ï¼Œç›´åˆ° RDB æ–‡ä»¶åˆ›å»ºå®Œæˆã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šæ‰‹åŠ¨æ‰§è¡Œ RDB](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504103113.png)

bgsave å‘½ä»¤ä¼šåœ¨åå° fork ä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œ RDB æŒä¹…åŒ–æ“ä½œï¼Œä¸»è¿›ç¨‹ä¸ä¼šè¢«é˜»å¡ã€‚

![Mräºï¼šRedis bgsave](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504102942.png)


#### ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè‡ªåŠ¨è§¦å‘ RDB æŒä¹…åŒ–ï¼Ÿ

ç¬¬ä¸€ç§ï¼Œåœ¨ Redis é…ç½®æ–‡ä»¶ä¸­è®¾ç½® RDB æŒä¹…åŒ–å‚æ•° `save <seconds> <changes>`ï¼Œè¡¨ç¤ºåœ¨æŒ‡å®šæ—¶é—´é—´éš”å†…ï¼Œå¦‚æœæœ‰æŒ‡å®šæ•°é‡çš„é”®å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘ RDB æŒä¹…åŒ–ã€‚

```shell
save 900 1      # 900 ç§’ï¼ˆ15 åˆ†é’Ÿï¼‰å†…æœ‰ 1 ä¸ª key å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘å¿«ç…§
save 300 10     # 300 ç§’ï¼ˆ5 åˆ†é’Ÿï¼‰å†…æœ‰ 10 ä¸ª key å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘å¿«ç…§
save 60 10000   # 60 ç§’å†…æœ‰ 10000 ä¸ª key å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘å¿«ç…§
```

ç¬¬äºŒç§ï¼Œä¸»ä»å¤åˆ¶æ—¶ï¼Œå½“ä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥åˆ°ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šè‡ªåŠ¨æ‰§è¡Œ bgsave ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘é€ç»™ä»èŠ‚ç‚¹ã€‚

![è¾¾æ‘©é™¢çš„BLOGï¼šRedis ä¸»ä»å¤åˆ¶æ—¶ RDB è‡ªåŠ¨ç”Ÿæˆ](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504104821.png)

ç¬¬ä¸‰ç§ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ AOFï¼Œæ‰§è¡Œ shutdown å‘½ä»¤æ—¶ï¼ŒRedis ä¼šè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ RDB æ–‡ä»¶ï¼Œä»¥ç¡®ä¿æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚

#### è¯¦ç»†è¯´ä¸€ä¸‹ AOFï¼Ÿ

AOF é€šè¿‡è®°å½•æ¯ä¸ªå†™æ“ä½œå‘½ä»¤ï¼Œå¹¶å°†å…¶è¿½åŠ åˆ° AOF æ–‡ä»¶æ¥å®ç°æŒä¹…åŒ–ï¼ŒRedis æœåŠ¡å™¨å®•æœºåå¯ä»¥é€šè¿‡é‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥æ¢å¤æ•°æ®ã€‚

![Animesh Gaitondeï¼šAOF](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504105937.png)

å½“ Redis æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šå°†å†™å‘½ä»¤è¿½åŠ åˆ° AOF ç¼“å†²åŒºï¼›Redis ä¼šæ ¹æ®åŒæ­¥ç­–ç•¥å°†ç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ° AOF æ–‡ä»¶ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šAOFå·¥ä½œæµç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-a9fb6202-b1a1-484d-a4fa-fef519090b44.png)

å½“ AOF æ–‡ä»¶è¿‡å¤§æ—¶ï¼ŒRedis ä¼šè‡ªåŠ¨è¿›è¡Œ AOF é‡å†™ï¼Œå‰”é™¤å¤šä½™çš„å‘½ä»¤ï¼Œæ¯”å¦‚è¯´å¤šæ¬¡å¯¹åŒä¸€ä¸ª key çš„ set å’Œ delï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ï¼›å½“ Redis é‡å¯æ—¶ï¼Œè¯»å– AOF æ–‡ä»¶ä¸­çš„å‘½ä»¤å¹¶é‡æ–°æ‰§è¡Œï¼Œä»¥æ¢å¤æ•°æ®ã€‚

#### AOF çš„åˆ·ç›˜ç­–ç•¥äº†è§£å—ï¼Ÿ

Redis å°† AOF ç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ° AOF æ–‡ä»¶æ—¶ï¼Œæ¶‰åŠä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼šwrite å°†æ•°æ®å†™å…¥åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å†²åŒºï¼Œfsync å°† OS ç¼“å†²åŒºçš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ã€‚

è¿™é‡Œçš„åˆ·ç›˜æ¶‰åŠåˆ°ä¸‰ç§ç­–ç•¥ï¼šalwaysã€everysec å’Œ noã€‚

![bytebytegoï¼šRedis AOF çš„åˆ·ç›˜ç­–ç•¥](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504113511.png)

- alwaysï¼šæ¯æ¬¡å†™å‘½ä»¤æ‰§è¡Œå®Œï¼Œç«‹å³è°ƒç”¨ fsync åŒæ­¥åˆ°ç£ç›˜ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†æ€§èƒ½è¾ƒå·®ã€‚
- everysecï¼šæ¯ç§’è°ƒç”¨ä¸€æ¬¡ fsyncï¼Œå°†å¤šæ¡å‘½ä»¤ä¸€æ¬¡æ€§åŒæ­¥åˆ°ç£ç›˜ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œæ•°æ®ä¸¢å¤±çš„æ—¶é—´çª—å£ä¸º 1 ç§’ã€‚
- noï¼šä¸ä¸»åŠ¨è°ƒç”¨ fsyncï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šï¼Œæ€§èƒ½æœ€å¥½ï¼Œä½†æ•°æ®ä¸¢å¤±çš„æ—¶é—´çª—å£ä¸ç¡®å®šï¼Œä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ç¼“å­˜ç­–ç•¥ï¼Œå¯èƒ½ä¼šä¸¢å¤±å¤§é‡æ•°æ®ã€‚

å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ appendfsync å‚æ•°è¿›è¡Œè®¾ç½®ã€‚

```shell
appendfsync everysec  # æ¯ç§’ fsync ä¸€æ¬¡
```

#### è¯´è¯´AOFçš„é‡å†™æœºåˆ¶ï¼Ÿ

ç”±äº AOF æ–‡ä»¶ä¼šéšç€å†™æ“ä½œçš„å¢åŠ è€Œä¸æ–­å¢é•¿ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ Redis æä¾›äº†é‡å†™æœºåˆ¶æ¥å¯¹ AOF æ–‡ä»¶è¿›è¡Œå‹ç¼©å’Œä¼˜åŒ–ã€‚

![pdai.techï¼šAOF æ–‡ä»¶ç˜¦èº«](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504115144.png)

AOF é‡å†™å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è§¦å‘ï¼Œç¬¬ä¸€ç§æ˜¯æ‰‹åŠ¨æ‰§è¡Œ `BGREWRITEAOF` å‘½ä»¤ï¼Œé€‚ç”¨äºéœ€è¦ç«‹å³å‡å°AOFæ–‡ä»¶å¤§å°çš„åœºæ™¯ã€‚

ç¬¬äºŒç§æ˜¯åœ¨ Redis é…ç½®æ–‡ä»¶ä¸­è®¾ç½®è‡ªåŠ¨é‡å†™å‚æ•°ï¼Œæ¯”å¦‚è¯´ `auto-aof-rewrite-percentage` å’Œ `auto-aof-rewrite-min-size`ï¼Œè¡¨ç¤ºå½“ AOF æ–‡ä»¶å¤§å°è¶…è¿‡æŒ‡å®šå€¼æ—¶ï¼Œè‡ªåŠ¨è§¦å‘é‡å†™ã€‚

```shell
auto-aof-rewrite-percentage 100  # é»˜è®¤å€¼100ï¼Œè¡¨ç¤ºå½“å‰AOFæ–‡ä»¶å¤§å°ç›¸æ¯”ä¸Šæ¬¡é‡å†™åå¤§å°å¢é•¿äº†å¤šå°‘ç™¾åˆ†æ¯”æ—¶è§¦å‘é‡å†™
auto-aof-rewrite-min-size 64mb  # é»˜è®¤å€¼64MBï¼Œè¡¨ç¤ºAOFæ–‡ä»¶è‡³å°‘è¦è¾¾åˆ°è¿™ä¸ªå¤§å°æ‰ä¼šè€ƒè™‘é‡å†™
```

#### AOF é‡å†™çš„å…·ä½“è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ

Redis åœ¨æ”¶åˆ°é‡å†™æŒ‡ä»¤åï¼Œä¼šåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶ fork ä¸€ä»½ä¸çˆ¶è¿›ç¨‹å®Œå…¨ç›¸åŒçš„æ•°æ®å‰¯æœ¬ï¼Œç„¶åéå†å†…å­˜ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œç”Ÿæˆé‡å»ºå®ƒä»¬æ‰€éœ€çš„æœ€å°‘å‘½ä»¤ã€‚

![äº‘çƒŸæˆé›¨ï¼šRedis çš„ AOF é‡å†™æœºåˆ¶](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504114626.png)

æ¯”å¦‚è¯´å¤šä¸ª RPUSH å‘½ä»¤å¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ªå¸¦æœ‰å¤šä¸ªå‚æ•°çš„ RPUSHï¼›

æ¯”å¦‚è¯´ä¸€ä¸ªé”®è¢«è®¾ç½®ååˆè¢«åˆ é™¤ï¼Œè¿™ä¸ªé”®çš„æ‰€æœ‰æ“ä½œéƒ½ä¸ä¼šè¢«å†™å…¥æ–° AOFã€‚

æ¯”å¦‚è¯´ä½¿ç”¨ `SADD key member1 member2 member3` ä»£æ›¿å¤šä¸ªå•ç‹¬çš„ `SADD key memberX`ã€‚

å­è¿›ç¨‹åœ¨æ‰§è¡Œ AOF é‡å†™çš„åŒæ—¶ï¼Œä¸»è¿›ç¨‹å¯ä»¥ç»§ç»­å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚

ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼ŒRedis ä½¿ç”¨äº† AOF é‡å†™ç¼“å†²åŒºæœºåˆ¶ï¼Œä¸»è¿›ç¨‹åœ¨æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šå°†å‘½ä»¤åŒæ—¶å†™å…¥æ—§çš„ AOF æ–‡ä»¶å’Œé‡å†™ç¼“å†²åŒºã€‚

ç­‰å­è¿›ç¨‹å®Œæˆé‡å†™åï¼Œä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œä¸»è¿›ç¨‹æ”¶åˆ°åå°†é‡å†™ç¼“å†²åŒºä¸­çš„å‘½ä»¤è¿½åŠ åˆ°æ–°çš„ AOF æ–‡ä»¶ä¸­ï¼Œç„¶åè°ƒç”¨æ“ä½œç³»ç»Ÿçš„ renameï¼Œå°†æ—§çš„ AOF æ–‡ä»¶æ›¿æ¢ä¸ºæ–°çš„ AOF æ–‡ä»¶ã€‚

```
ä¸»è¿›ç¨‹ï¼ˆforkï¼‰  
   â”‚  
   â”œâ”€â†’ å­è¿›ç¨‹ï¼ˆç”Ÿæˆæ–°çš„ AOF æ–‡ä»¶ï¼‰  
   â”‚       â”‚  
   â”‚       â”œâ”€â†’ å†…å­˜å¿«ç…§  
   â”‚       â”œâ”€â†’ å†™å…¥ä¸´æ—¶ AOF æ–‡ä»¶  
   â”‚       â”œâ”€â†’ é€šçŸ¥ä¸»è¿›ç¨‹å®Œæˆ  
   â”‚  
   â”œâ”€â†’ ä¸»è¿›ç¨‹ï¼ˆè¿½åŠ ç¼“å†²åŒºåˆ°æ–° AOF æ–‡ä»¶ï¼‰  
   â”œâ”€â†’ æ›¿æ¢æ—§ AOF æ–‡ä»¶  
   â”œâ”€â†’ é‡å†™å®Œæˆ
```

AOF é‡å†™æœŸé—´ï¼ŒRedis æœåŠ¡å™¨ä¼šå¤„äºç‰¹æ®ŠçŠ¶æ€ï¼š

- aof_child_pid ä¸ä¸º 0ï¼Œè¡¨ç¤ºæœ‰å­è¿›ç¨‹åœ¨æ‰§è¡Œ AOF é‡å†™
- aof_rewrite_buf_blocks é“¾è¡¨ä¸ä¸ºç©ºï¼Œå­˜å‚¨ AOF é‡å†™ç¼“å†²åŒºå†…å®¹

å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® no-appendfsync-on-rewrite ä¸º yesï¼Œé‚£ä¹ˆé‡å†™æœŸé—´å¯èƒ½ä¼šæš‚åœ AOF æ–‡ä»¶çš„ fsync æ“ä½œã€‚

```shell
appendonly yes                # å¼€å¯AOF
appendfilename "appendonly.aof"  # AOFæ–‡ä»¶å
appendfsync everysec          # å†™å…¥ç£ç›˜ç­–ç•¥
no-appendfsync-on-rewrite no  # é‡å†™æœŸé—´æ˜¯å¦ä¸´æ—¶å…³é—­fsync
auto-aof-rewrite-percentage 100   # AOFæ–‡ä»¶å¢é•¿åˆ°åŸæ¥å¤šå°‘ç™¾åˆ†æ¯”æ—¶è§¦å‘é‡å†™
auto-aof-rewrite-min-size 64mb    # AOFæ–‡ä»¶æœ€å°å¤šå¤§æ—¶æ‰å…è®¸é‡å†™
```

#### AOF æ–‡ä»¶å­˜å‚¨çš„æ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®ï¼Ÿ

AOF æ–‡ä»¶å­˜å‚¨çš„æ˜¯ Redis æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å†™å‘½ä»¤æ•°æ®ï¼Œä»¥ Redis åè®®æ ¼å¼ä¿å­˜ã€‚

è¿™ç§æ ¼å¼çš„ç‰¹ç‚¹æ˜¯ï¼Œæ¯ä¸ªå‘½ä»¤ä»¥\*å¼€å¤´ï¼Œåè·Ÿå‚æ•°çš„æ•°é‡ï¼Œæ¯ä¸ªå‚æ•°å‰ç”¨`$`ç¬¦å·ï¼Œåè·Ÿå‚æ•°å­—èŠ‚é•¿åº¦ï¼Œç„¶åæ˜¯å‚æ•°çš„å®é™…å†…å®¹ã€‚

![äºŒå“¥çš„Java è¿›é˜¶ä¹‹è·¯ï¼šAOFæ–‡ä»¶å†…å®¹æ ¼å¼](https://cdn.tobebetterjavaer.com/stutymore/redis-20241208204853.png)

#### AOFé‡å†™æœŸé—´å‘½ä»¤å¯èƒ½ä¼šå†™å…¥ä¸¤æ¬¡ï¼Œä¼šé€ æˆä»€ä¹ˆå½±å“ï¼Ÿ

AOF é‡å†™æœŸé—´å‘½ä»¤ä¼šåŒæ—¶å†™å…¥ç°æœ‰AOFæ–‡ä»¶å’Œé‡å†™ç¼“å†²åŒºï¼Œè¿™ç§æœºåˆ¶æ˜¯æœ‰æ„è®¾è®¡çš„ï¼Œå¹¶ä¸ä¼šå¯¼è‡´æ•°æ®é‡å¤æˆ–ä¸ä¸€è‡´é—®é¢˜ã€‚

![UStarGaoï¼šAOF åŒå†™æœºåˆ¶](https://cdn.tobebetterjavaer.com/stutymore/redis-20250504121938.png)

å› ä¸ºæ–°æ—§æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œç°æœ‰å‘½ä»¤å†™å…¥å½“å‰ AOF æ–‡ä»¶ï¼Œé‡å†™ç¼“å†²åŒºçš„å‘½ä»¤æœ€ç»ˆå†™å…¥æ–°çš„ AOF æ–‡ä»¶ï¼Œå®Œæˆåï¼Œæ–°æ–‡ä»¶é€šè¿‡åŸå­æ€§çš„ rename æ“ä½œæ›¿æ¢æ—§æ–‡ä»¶ã€‚ä¸¤ä¸ªæ–‡ä»¶æ˜¯å®Œå…¨åˆ†ç¦»çš„ï¼Œä¸ä¼šå¯¼è‡´åŒä¸€ä¸ª AOF æ–‡ä»¶ä¸­å‡ºç°é‡å¤å‘½ä»¤ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆ redis å¿«ï¼Œæ·˜æ±°ç­–ç•¥ æŒä¹…åŒ–
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 7 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´ä¸€ä¸‹ Redis çš„æŒä¹…åŒ–æ–¹å¼
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°å…¬å¸é¢ç»åˆé›†åŒå­¦ 1 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis çš„æŒä¹…åŒ–æ–¹å¼ï¼ŸRDB å’Œ AOF çš„åŒºåˆ«ï¼ŸRedis å®•æœºå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«ï¼Ÿ
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 18 æˆéƒ½åˆ°å®¶é¢è¯•åŸé¢˜ï¼šredis æŒä¹…åŒ–
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ä½œä¸šå¸®é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šredisæŒä¹…åŒ–æœºåˆ¶
> 6. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ OPPO é¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRedisæŒä¹…åŒ–æ–¹æ¡ˆ
> 7. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 9 é¢è¯•é¢˜ç›®åŸé¢˜ï¼šRedisçš„åŸºæœ¬æ•°æ®ç±»å‹ï¼ŸRedisçš„æŒä¹…åŒ–å‘¢ï¼Ÿæœ‰ä½•ä¼˜ç¼ºç‚¹ï¼Ÿ
> 8. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æ»´æ»´é¢ç»åŒå­¦ 3 ç½‘çº¦è½¦åç«¯å¼€å‘ä¸€é¢åŸé¢˜ï¼šRedisæŒä¹…åŒ–
> 9. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 1 éƒ¨é—¨ä¸»ç«™æŠ€æœ¯éƒ¨é¢è¯•åŸé¢˜ï¼šRedisæ•°æ®çš„å¯é æ€§æ€ä¹ˆä¿è¯ï¼ŸAOFé‡å†™æœŸé—´å‘½ä»¤å¯èƒ½ä¼šå†™å…¥ä¸¤æ¬¡ï¼Œä¼šé€ æˆä»€ä¹ˆå½±å“ï¼Ÿ

memoï¼š2025 å¹´ 5 æœˆ 4 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©[æœ‰çƒå‹å‘ä¿¡æ¯](https://javabetter.cn/zhishixingqiu/)è¯´æŠŠå¹¶å‘ç¼–ç¨‹å’Œ JVM çš„é¢æ¸£é€†è¢­éƒ½æ‰“å°æˆçº¸è´¨ç‰ˆäº†ï¼Œè¯´å®è¯ï¼Œè¿™ä¸ªå°é¢çš„é¢œå€¼æˆ‘ä¹Ÿå¾ˆå–œæ¬¢ï¼Œå“ˆå“ˆã€‚

![é¢æ¸£é€†è¢­æ‰“å°æˆçº¸è´¨ç‰ˆäº†](https://cdn.tobebetterjavaer.com/stutymore/redis-è¿˜æ˜¯çœ‹çº¸è´¨ç‰ˆå¿ƒé‡Œè¸å®.jpg)

### 11.RDB å’Œ AOF å„è‡ªæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ

RDB é€šè¿‡ fork å­è¿›ç¨‹åœ¨ç‰¹å®šæ—¶é—´ç‚¹å¯¹å†…å­˜æ•°æ®è¿›è¡Œå…¨é‡å¤‡ä»½ï¼Œç”ŸæˆäºŒè¿›åˆ¶æ ¼å¼çš„å¿«ç…§æ–‡ä»¶ã€‚å…¶æœ€å¤§ä¼˜åŠ¿åœ¨äºå¤‡ä»½æ¢å¤æ•ˆç‡é«˜ï¼Œæ–‡ä»¶ç´§å‡‘ï¼Œæ¢å¤é€Ÿåº¦å¿«ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®çš„å¤‡ä»½å’Œè¿ç§»åœºæ™¯ã€‚

ç¼ºç‚¹æ˜¯å¯èƒ½ä¸¢å¤±ä¸¤æ¬¡å¿«ç…§æœŸé—´çš„æ‰€æœ‰æ•°æ®å˜æ›´ã€‚

![dfordebuggingï¼šrdb vs aof](https://cdn.tobebetterjavaer.com/stutymore/redis-20250505092638.png)

AOF ä¼šè®°å½•æ¯ä¸€æ¡ä¿®æ”¹æ•°æ®çš„å†™å‘½ä»¤ã€‚è¿™ç§æ—¥å¿—è¿½åŠ çš„æ–¹å¼è®© AOF èƒ½å¤Ÿæä¾›æ¥è¿‘å®æ—¶çš„æ•°æ®å¤‡ä»½ï¼Œæ•°æ®ä¸¢å¤±é£é™©å¯ä»¥æ§åˆ¶åœ¨ 1 ç§’å†…ç”šè‡³å®Œå…¨é¿å…ã€‚

ç¼ºç‚¹æ˜¯æ–‡ä»¶ä½“ç§¯è¾ƒå¤§ï¼Œæ¢å¤é€Ÿåº¦æ…¢ã€‚

æ¥ä¸ªè¡¨æ ¼å¯¹æ¯”ä¸€ä¸‹ï¼š

å¯¹æ¯”é¡¹|RDBï¼ˆå¿«ç…§ï¼‰|AOFï¼ˆå‘½ä»¤æ—¥å¿—ï¼‰
---|---|---
æ•°æ®å®Œæ•´æ€§|âŒ å¯èƒ½ä¸¢å¤±å‡ åˆ†é’Ÿæ•°æ®|âœ… æœ€å¤šä¸¢ 1 ç§’æ•°æ®
æ¢å¤é€Ÿåº¦|âœ… å¿«ï¼ˆç›´æ¥åŠ è½½äºŒè¿›åˆ¶å¿«ç…§ï¼‰|âŒ æ…¢ï¼ˆé€æ¡ replayï¼‰
æ–‡ä»¶å¤§å°|âœ… å°ï¼ˆå‹ç¼©åï¼‰|âŒ å¤§ï¼ˆå‘½ä»¤è¿½åŠ ï¼‰
æ€§èƒ½å½±å“|âœ… ä½ï¼ˆfork åä¿å­˜ï¼‰|âŒ è¾ƒé«˜ï¼ˆæ¯æ¬¡å†™éƒ½è®°å½•ï¼‰
å†™å…¥æ–¹å¼|å®šæœŸå…¨é‡å†™|æ¯æ¬¡å†™å‘½ä»¤å°±è®°å½•
é€‚ç”¨åœºæ™¯|å†·å¤‡ä»½ï¼Œç¾éš¾æ¢å¤|å®æ—¶æŒä¹…åŒ–ï¼Œæ•°æ®å®‰å…¨
é»˜è®¤çŠ¶æ€|é»˜è®¤å¯ç”¨|Redis 7 é»˜è®¤ä¹Ÿå¯ç”¨
é‡å†™æœºåˆ¶|æ— |æœ‰ï¼ˆBGREWRITEAOFï¼‰
æ··åˆæ”¯æŒ|Redis 4.0 åæ”¯æŒç»“åˆä½¿ç”¨ï¼ˆaof-use-rdb-preambleï¼‰|


> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°å…¬å¸é¢ç»åˆé›†åŒå­¦ 1 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis çš„æŒä¹…åŒ–æ–¹å¼ï¼ŸRDB å’Œ AOF çš„åŒºåˆ«ï¼ŸRedis å®•æœºå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«ï¼Ÿ

### 12.RDB å’Œ AOF å¦‚ä½•é€‰æ‹©ï¼Ÿ

åœ¨é€‰æ‹© Redis æŒä¹…åŒ–æ–¹æ¡ˆæ—¶ï¼Œæˆ‘ä¼šä»ä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯ç‰¹æ€§ä¸¤ä¸ªç»´åº¦æ¥è€ƒè™‘ã€‚

å¦‚æœæ˜¯ç¼“å­˜åœºæ™¯ï¼Œå¯ä»¥æ¥å—ä¸€å®šç¨‹åº¦çš„æ•°æ®ä¸¢å¤±ï¼Œæˆ‘ä¼šå€¾å‘äºé€‰æ‹© RDB æˆ–è€…å®Œå…¨ä¸ä½¿ç”¨æŒä¹…åŒ–ã€‚RDB çš„å¿«ç…§æ–¹å¼å¯¹æ€§èƒ½å½±å“å°ï¼Œè€Œä¸”æ¢å¤é€Ÿåº¦å¿«ï¼Œéå¸¸é€‚åˆè¿™ç±»åœºæ™¯ã€‚

![æ´’è„±çš„è€¿ï¼šRedis åšç¼“å­˜](https://cdn.tobebetterjavaer.com/stutymore/redis-20250505094156.png)

ä½†å¦‚æœæ˜¯å¤„ç†è®¢å•æˆ–è€…æ”¯ä»˜è¿™æ ·çš„æ ¸å¿ƒä¸šåŠ¡ï¼Œæ•°æ®ä¸¢å¤±å°†é€ æˆä¸¥é‡åæœï¼Œé‚£ä¹ˆ AOF å°±æˆä¸ºå¿…ç„¶é€‰æ‹©ã€‚é€šè¿‡é…ç½®æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œå¯ä»¥å°†æ½œåœ¨çš„æ•°æ®ä¸¢å¤±é£é™©é™åˆ¶åœ¨å¯æ¥å—èŒƒå›´å†…ã€‚

![æå®¢æ—¶é—´ï¼šreids åœ¨ç§’æ€ä¸­çš„åº”ç”¨](https://cdn.tobebetterjavaer.com/stutymore/redis-20250505095347.png)

åœ¨å®é™…çš„é¡¹ç›®å½“ä¸­ï¼Œæˆ‘æ›´åå‘äºä½¿ç”¨ RDB + AOF çš„æ··åˆæ¨¡å¼ã€‚

```shell
appendonly yes # å¼€å¯ AOF
appendfsync everysec # æ¯ç§’åˆ·ç›˜ä¸€æ¬¡
aof-use-rdb-preamble yes # å¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‡å¯æ—¶ä¼˜å…ˆåŠ è½½ RDBï¼ŒRDB ä½œä¸ºå†·å¤‡ï¼ŒAOF ä½œä¸ºå®æ—¶åŒæ­¥
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 18 æˆéƒ½åˆ°å®¶é¢è¯•åŸé¢˜ï¼šä»€ä¹ˆæ—¶å€™ç”¨ rdb ä»€ä¹ˆæ—¶å€™ç”¨ aof

### 13.Rediså¦‚ä½•æ¢å¤æ•°æ®ï¼Ÿ

å½“ Redis æœåŠ¡é‡å¯æ—¶ï¼Œå®ƒä¼šä¼˜å…ˆæŸ¥æ‰¾ AOF æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨å°±é€šè¿‡é‡æ”¾å…¶ä¸­çš„å‘½ä»¤æ¥æ¢å¤æ•°æ®ï¼›å¦‚æœä¸å­˜åœ¨æˆ–æœªå¯ç”¨ AOFï¼Œåˆ™ä¼šå°è¯•åŠ è½½ RDB æ–‡ä»¶ï¼Œç›´æ¥å°†äºŒè¿›åˆ¶æ•°æ®è½½å…¥å†…å­˜æ¥æ¢å¤ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRediså¯åŠ¨åŠ è½½æ•°æ®](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-f9aab5e9-a875-4316-9ec9-0c5650afe5c1.png)

å¦‚æœ AOF æ–‡ä»¶æŸåçš„è¯ï¼ŒRedis ä¼šå°è¯•é€šè¿‡ `redis-check-aof` å·¥å…·æ¥ä¿®å¤ AOF æ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ `--repair` å‚æ•°æ¥ä¿®å¤ã€‚

```shell
redis-check-aof --repair appendonly.aof
```

è™½ç„¶ Redis è¿˜æä¾›äº† `redis-check-rdb` å·¥å…·æ¥æ£€æŸ¥ RDB æ–‡ä»¶çš„å®Œæ•´æ€§ï¼Œä½†å®ƒå¹¶ä¸æ”¯æŒä¿®å¤ RDB æ–‡ä»¶ï¼Œåªèƒ½ç”¨æ¥éªŒè¯æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚

```shell
redis-check-rdb dump.rdb
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 4 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis å†…å­˜ä¸­æ•°æ®ä¸¢å¤±æ€ä¹ˆè§£å†³

memoï¼š2025 å¹´ 5 æœˆ 5 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©ç»™[çƒå‹ä¿®æ”¹ç®€å†](https://javabetter.cn/zhishixingqiu/jianli.html)æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªåç§‘æœ¬ç¡•çš„çƒå‹ï¼Œ985 é«˜æ ¡åˆ+1ï¼Œç›®å‰å›½å†…çš„ 985 é«˜æ ¡æœ‰ 39 æ‰€ï¼Œå¸Œæœ›ä¸ä¹…çš„å°†æ¥ï¼Œèƒ½å…¨éƒ¨é›†é½ã€‚ğŸ˜„

![åä¸­ç§‘æŠ€å¤§å­¦çš„çƒå‹+1](https://cdn.tobebetterjavaer.com/stutymore/redis-20250505101045.png)

### ğŸŒŸ14.Redis 4.0 çš„æ··åˆæŒä¹…åŒ–äº†è§£å—ï¼Ÿ

æ˜¯çš„ã€‚

æ··åˆæŒä¹…åŒ–ç»“åˆäº† RDB å’Œ AOF ä¸¤ç§æ–¹å¼çš„ä¼˜ç‚¹ï¼Œè§£å†³äº†å®ƒä»¬å„è‡ªçš„ä¸è¶³ã€‚åœ¨ Redis 4.0 ä¹‹å‰ï¼Œæˆ‘ä»¬è¦ä¹ˆé¢ä¸´ RDB å¯èƒ½ä¸¢å¤±æ•°æ®çš„é£é™©ï¼Œè¦ä¹ˆæ‰¿å— AOF æ¢å¤æ…¢çš„é—®é¢˜ï¼Œå¾ˆéš¾ä¸¤å…¨å…¶ç¾ã€‚

![Animesh Gaitondeï¼šaof-use-rdb-preamble](https://cdn.tobebetterjavaer.com/stutymore/redis-20250506103814.png)

æ··åˆæŒä¹…åŒ–çš„å·¥ä½œåŸç†éå¸¸å·§å¦™ï¼šåœ¨ AOF é‡å†™æœŸé—´ï¼Œå…ˆä»¥ RDB æ ¼å¼å°†å†…å­˜ä¸­çš„æ•°æ®å¿«ç…§ä¿å­˜åˆ° AOF æ–‡ä»¶çš„å¼€å¤´ï¼Œå†å°†é‡å†™æœŸé—´çš„å‘½ä»¤ä»¥ AOF æ ¼å¼è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ··åˆæŒä¹…åŒ–](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-19c531e5-da95-495a-a4c4-d63a0b8bba95.png)

è¿™æ ·ï¼Œå½“éœ€è¦æ¢å¤æ•°æ®æ—¶ï¼ŒRedis å…ˆåŠ è½½ RDB æ ¼å¼çš„æ•°æ®æ¥å¿«é€Ÿæ¢å¤å¤§éƒ¨åˆ†çš„æ•°æ®ï¼Œç„¶åé€šè¿‡é‡æ”¾å‘½ä»¤æ¢å¤æœ€è¿‘çš„æ•°æ®ï¼Œè¿™æ ·å°±èƒ½åœ¨ä¿è¯æ•°æ®å®Œæ•´æ€§çš„åŒæ—¶ï¼Œæå‡æ¢å¤é€Ÿåº¦ã€‚

#### å¦‚ä½•è®¾ç½®æŒä¹…åŒ–æ¨¡å¼ï¼Ÿ

å¯ç”¨æ··åˆæŒä¹…åŒ–çš„æ–¹å¼éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `aof-use-rdb-preamble yes` å°±å¯ä»¥äº†ã€‚

```shell
aof-use-rdb-preamble yes
```

#### ä½ åœ¨å¼€å‘ä¸­æ˜¯æ€ä¹ˆé…ç½® RDB å’Œ AOF çš„ï¼Ÿ

å¯¹äºå¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒï¼Œæˆ‘å€¾å‘äºä½¿ç”¨æ··åˆæŒä¹…åŒ–æ–¹å¼ï¼Œç»“åˆ RDB å’Œ AOF çš„ä¼˜ç‚¹ã€‚

```shell
# å¯ç”¨AOF
appendonly yes

# ä½¿ç”¨æ··åˆæŒä¹…åŒ–
aof-use-rdb-preamble yes

# æ¯ç§’åŒæ­¥ä¸€æ¬¡AOFï¼Œå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§
appendfsync everysec

# AOFé‡å†™è§¦å‘æ¡ä»¶ï¼šæ–‡ä»¶å¢é•¿100%ä¸”è‡³å°‘è¾¾åˆ°64MB
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# RDBå¤‡ä»½ç­–ç•¥
save 900 1    # 15åˆ†é’Ÿå†…æœ‰1ä¸ªä¿®æ”¹
save 300 10   # 5åˆ†é’Ÿå†…æœ‰10ä¸ªä¿®æ”¹
save 60 10000 # 1åˆ†é’Ÿå†…æœ‰10000ä¸ªä¿®æ”¹
```

å¯¹äºå•çº¯çš„ç¼“å­˜åœºæ™¯ï¼Œæˆ–è€…æœ¬åœ°å¼€å‘ï¼Œæˆ‘ä¼šåªå¯ç”¨ RDBï¼Œå…³é—­ AOFï¼š

```shell
# ç¦ç”¨AOF
appendonly no

# è¾ƒå®½æ¾çš„RDBç­–ç•¥
save 3600 1    # 1å°æ—¶å†…æœ‰1ä¸ªä¿®æ”¹
save 300 100   # 5åˆ†é’Ÿå†…æœ‰100ä¸ªä¿®æ”¹
```

è€Œå¯¹äºé‡‘èç±»ç­‰é«˜ä¸€è‡´æ€§çš„ç³»ç»Ÿï¼Œæˆ‘é€šå¸¸ä¼šåœ¨å…³é”®æ—¶é—´çª—å£åŠ¨æ€å°† `appendfsync` è®¾ç½®ä¸º `always`ï¼š

```shell
# å¯ç”¨AOF
appendonly yes

# ä½¿ç”¨æ··åˆæŒä¹…åŒ–
aof-use-rdb-preamble yes

# æ¯ä¸ªå‘½ä»¤éƒ½åŒæ­¥ï¼ˆè°¨æ…ä½¿ç”¨ï¼Œæ€§èƒ½å½±å“å¤§ï¼‰
# é€šå¸¸æˆ‘ä¼šåœ¨å…³é”®æ—¶é—´çª—å£åŠ¨æ€ä¿®æ”¹ä¸ºalways
appendfsync always

# æ›´é¢‘ç¹çš„RDBå¿«ç…§
save 300 1     # 5åˆ†é’Ÿå†…æœ‰1ä¸ªä¿®æ”¹
save 60 100    # 1åˆ†é’Ÿå†…æœ‰100ä¸ªä¿®æ”¹
```

å¦å¤–ï¼Œå¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œåº”è¯¥è®¾ç½®`no-appendfsync-on-rewrite yes`ï¼Œé¿å… AOF é‡å†™å½±å“ä¸»è¿›ç¨‹æ€§èƒ½ï¼›å¯¹äºå¤§å‹å®ä¾‹ï¼Œä¹Ÿåº”è¯¥è®¾ç½® `rdb-save-incremental-fsync yes` æ¥å‡å°‘å¤§å‹ RDB ä¿å­˜å¯¹æ€§èƒ½çš„å½±å“ã€‚

```shell
# AOFé‡å†™æœŸé—´ä¸fsyncï¼ŒAOF é‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹ä¸ä¼šå¯¹æ–°å†™å…¥çš„ AOF ç¼“å†²åŒºæ‰§è¡Œ fsync æ“ä½œï¼ˆå³ä¸å¼ºåˆ¶åˆ·ç›˜ï¼‰ï¼Œè€Œæ˜¯ç­‰é‡å†™ç»“æŸåå†ç»Ÿä¸€åˆ·ç›˜ã€‚
no-appendfsync-on-rewrite yes
# RDB å¿«ç…§ä¿å­˜æ—¶é‡‡ç”¨å¢é‡ fsyncï¼Œå³æ¯å†™å…¥ä¸€å®šé‡çš„æ•°æ®å°±æ‰§è¡Œä¸€æ¬¡ fsyncï¼Œå°†æ•°æ®åˆ†æ‰¹åŒæ­¥åˆ°ç£ç›˜ã€‚
rdb-save-incremental-fsync yes
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„æŒä¹…åŒ–æœºåˆ¶ï¼Ÿ
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°å…¬å¸é¢ç»åˆé›†åŒå­¦ 1 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedis å®•æœºå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«ï¼Ÿ
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 18 æˆéƒ½åˆ°å®¶é¢è¯•åŸé¢˜ï¼šå¦‚ä½•è®¾ç½®æŒä¹…åŒ–æ¨¡å¼
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 4 ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸šç•Œä½¿ç”¨å“ªä¸€ç§æ•°æ®æŒä¹…åŒ–ï¼Œä¸¤ç§æŒä¹…åŒ–æ–¹æ³•çš„ä¼˜ç¼ºç‚¹
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ä½œä¸šå¸®é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸¤ç§ RedisæŒä¹…åŒ–æœºåˆ¶å¯ä»¥æ··åˆä½¿ç”¨å—

<MZNXQRcodeBanner />

memoï¼š2025 å¹´ 5 æœˆ 6 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹[çƒå‹ç®€å†](https://javabetter.cn/zhishixingqiu/jianli.html)æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªä¸œåŒ—å¤§å­¦ç¡•åˆè‚¥å·¥ä¸šå¤§å­¦æœ¬çš„çƒå‹ï¼ŒçœŸçš„éå¸¸ä¼˜ç§€ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶èƒ½å¤Ÿé€šè¿‡æ˜Ÿçƒè¿™ä¸ªå¹³å°å½¼æ­¤æ¿€åŠ±ï¼Œå…±åŒè¿›æ­¥ã€‚

![ä¸œåŒ—å¤§å­¦çš„çƒå‹+1](https://cdn.tobebetterjavaer.com/stutymore/redis-20250506105448.png)

## é«˜å¯ç”¨

### 15.ä¸»ä»å¤åˆ¶äº†è§£å—ï¼Ÿ

ä¸»ä»å¤åˆ¶å…è®¸ä»èŠ‚ç‚¹ç»´æŠ¤ä¸»èŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸»èŠ‚ç‚¹å¯ä»¥è¿æ¥å¤šä¸ªä»èŠ‚ç‚¹ï¼Œä»è€Œå½¢æˆä¸€ä¸»å¤šä»çš„ç»“æ„ã€‚ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†å†™æ“ä½œï¼Œä»èŠ‚ç‚¹è‡ªåŠ¨åŒæ­¥ä¸»èŠ‚ç‚¹çš„æ•°æ®å˜æ›´ï¼Œå¹¶å¤„ç†è¯»è¯·æ±‚ï¼Œä»è€Œå®ç°è¯»å†™åˆ†ç¦»ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisä¸»ä»å¤åˆ¶ç®€å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-60497f1e-8afb-44b3-bb7a-d4c29e5ac484.png)

#### ä¸»ä»å¤åˆ¶çš„ä¸»è¦ä½œç”¨æ˜¯ä»€ä¹ˆ?

ç¬¬ä¸€ï¼Œä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†å†™è¯·æ±‚ï¼Œä»èŠ‚ç‚¹è´Ÿè´£å¤„ç†è¯»è¯·æ±‚ï¼Œä»è€Œå®ç°è¯»å†™åˆ†ç¦»ï¼Œå‡è½»ä¸»èŠ‚ç‚¹å‹åŠ›çš„åŒæ—¶æå‡ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ã€‚

![pdai.techï¼šä¸»ä»å¤åˆ¶çš„è¯»å†™åˆ†ç¦»](https://cdn.tobebetterjavaer.com/stutymore/redis-20250507142235.png)

ç¬¬äºŒï¼Œä»èŠ‚ç‚¹å¯ä»¥ä½œä¸ºä¸»èŠ‚ç‚¹çš„æ•°æ®å¤‡ä»½ï¼Œå½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œå¯ä»¥å¿«é€Ÿå°†ä»èŠ‚ç‚¹æå‡ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€‚

![ç³»ç»Ÿè¿ç»´ï¼šRedisä¸»ä»+Sentinelé›†ç¾¤](https://cdn.tobebetterjavaer.com/stutymore/redis-20250507142500.png)

#### ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°ä¸»ä»å¤åˆ¶æ•°æ®ä¸ä¸€è‡´ï¼Ÿ

Redis çš„ä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œå› æ­¤åœ¨ä¸»èŠ‚ç‚¹å®•æœºã€ç½‘ç»œæ³¢åŠ¨æˆ–å¤åˆ¶å»¶è¿Ÿè¾ƒé«˜æ—¶ä¼šå‡ºç°ä»èŠ‚ç‚¹æ•°æ®ä¸åŒæ­¥çš„æƒ…å†µã€‚

![ningg.topï¼šä¸»ä»å¤åˆ¶å¼‚æ­¥è¿›è¡Œ](https://cdn.tobebetterjavaer.com/stutymore/redis-20250507143956.png)

æ¯”å¦‚ä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®åå®•æœºï¼Œä½†ä»èŠ‚ç‚¹è¿˜æœªæ¥å¾—åŠå¤åˆ¶ï¼Œå°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚

```
æ—¶é—´çº¿ï¼šâ†’

å®¢æˆ·ç«¯  â†’  å‘ä¸»èŠ‚ç‚¹ SET user:1 äºŒå“¥     â†’  ä¸»èŠ‚ç‚¹å¤„ç†æˆåŠŸ âœ…
                            â†“
                          æ­£å‡†å¤‡æ¨é€ç»™ä»èŠ‚ç‚¹ï¼ˆå¼‚æ­¥å¤åˆ¶ï¼‰... ä½†è¿˜æ²¡æ¨é€å®Œ âŒ
                            â†“
                  â€”â€” çªç„¶ä¸»èŠ‚ç‚¹å®•æœºï¼ˆæœºå™¨æ­»æœºã€æ–­ç½‘ï¼‰ ğŸ’¥ â€”â€”
                            â†“
          Sentinel ç›‘æµ‹åˆ°æ•…éšœï¼Œfailoverï¼šå°†ä»èŠ‚ç‚¹æå‡ä¸ºæ–°ä¸»èŠ‚ç‚¹ ğŸ§ 
                            â†“
å®¢æˆ·ç«¯ç»§ç»­è¯·æ±‚ï¼šGET user:1 â“â†’ ä»èŠ‚ç‚¹è¿”å›ï¼šç©º âŒï¼ˆæ•°æ®æ²¡åŒæ­¥è¿‡æ¥ï¼‰
```

å¦ä¸€ä¸ªå®¹æ˜“è¢«å¿½è§†çš„å› ç´ æ˜¯ä¸»èŠ‚ç‚¹å†…å­˜å‹åŠ›ã€‚å½“ä¸»èŠ‚ç‚¹å†…å­˜æ¥è¿‘ä¸Šé™å¹¶å¯ç”¨äº†æ·˜æ±°ç­–ç•¥æ—¶ï¼ŒæŸäº›é”®å¯èƒ½è¢«è‡ªåŠ¨åˆ é™¤ï¼Œè€Œè¿™äº›åˆ é™¤æ“ä½œå¦‚æœæœªèƒ½åŠæ—¶åŒæ­¥ï¼Œå°±ä¼šé€ æˆä»èŠ‚ç‚¹ä¿ç•™äº†ä¸»èŠ‚ç‚¹å·²ç»ä¸å­˜åœ¨çš„æ•°æ®ã€‚

![å›¾ç‰‡æ¥æºäºç½‘ç»œï¼šä¸»ä»ä¸ä¸€è‡´](https://cdn.tobebetterjavaer.com/stutymore/redis-20250507162724.png)

#### ä¸»ä»å¤åˆ¶æ•°æ®ä¸ä¸€è‡´çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ

é¦–å…ˆæ˜¯ç½‘ç»œå±‚é¢çš„ä¼˜åŒ–ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œä¸»ä»èŠ‚ç‚¹åº”è¯¥éƒ¨ç½²åœ¨åŒä¸€ä¸ªç½‘ç»œåŒºåŸŸå†…ï¼Œé¿å…è·¨åŒºåŸŸçš„ç½‘ç»œå»¶è¿Ÿã€‚

å…¶æ¬¡æ˜¯é…ç½®å±‚é¢çš„è°ƒæ•´ï¼Œæ¯”å¦‚è¯´é€‚å½“å¢å¤§å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°å’Œå­˜æ´»æ—¶é—´ï¼Œä»¥ä¾¿ä»èŠ‚ç‚¹é‡è¿åè¿›è¡Œå¢é‡åŒæ­¥è€Œä¸æ˜¯å…¨é‡åŒæ­¥ï¼Œä»¥æœ€å¤§ç¨‹åº¦å‡å°‘ä¸»ä»åŒæ­¥çš„å»¶è¿Ÿã€‚

```shell
repl-backlog-size 1mb  # é»˜è®¤å€¼ 1MBï¼Œè¡¨ç¤ºä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºå¤§å°
repl-backlog-ttl 3600  # é»˜è®¤å€¼ 3600 ç§’ï¼Œè¡¨ç¤ºä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºå­˜æ´»æ—¶é—´
```

ç¬¬ä¸‰æ˜¯å¼•å…¥ç›‘æ§å’Œè‡ªåŠ¨ä¿®å¤æœºåˆ¶ï¼Œå®šæœŸæ£€æŸ¥ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ã€‚

æ¯”å¦‚è¯´é€šè¿‡æ¯”è¾ƒä¸»ä»çš„ offset å·®å€¼åˆ¤æ–­ä»åº“æ˜¯å¦è½åã€‚ä¸€æ—¦è¶…è¿‡è®¾å®šé˜ˆå€¼ï¼Œå°±å°†ä»èŠ‚ç‚¹å‰”é™¤ï¼Œå¹¶é‡æ–°è¿›è¡Œå…¨é‡åŒæ­¥ã€‚

![æå®¢æ—¶é—´ï¼šRedis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜](https://cdn.tobebetterjavaer.com/stutymore/redis-20240709135618.png)

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRedis åˆ†å¸ƒå¼ï¼Œä¸»ä»ï¼Œä¸€ä¸ªèŠ‚ç‚¹æŒ‚æ‰æ€ä¹ˆåŠ
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³é¢ç»åŒå­¦ F é¢è¯•åŸé¢˜ï¼šredis çš„ä¸»ä»æ¶æ„å’Œä¸»ä»å“¨å…µåŒºåˆ«
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æ”¶é’±å§é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedisè§£å†³å•ç‚¹æ•…éšœä¸»è¦é ä»€ä¹ˆï¼Ÿä¸»ä»æ¨¡å¼ç”¨çš„æ˜¯å¼‚æ­¥è¿˜æ˜¯åŒæ­¥ï¼Ÿ

memoï¼š2025 å¹´ 5 æœˆ 7 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹[çƒå‹ç®€å†](https://javabetter.cn/zhishixingqiu/jianli.html)æ—¶ï¼Œæ”¶åˆ°äº†çƒå‹å¯¹ç®€å†ä¿®æ”¹çš„è®¤å¯ï¼šâ€œç°åœ¨è¿™ä»½ç®€å†åº”è¯¥æ¯”è¾ƒå®Œç¾äº†â€ï¼Œå®Œç¾è¿™ä¸ªè¯æˆ‘è§‰å¾—è¤’å¥–çš„æœ‰ç‚¹å¤šäº†ï¼Œå“ˆå“ˆï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯å¾ˆå¼€å¿ƒçš„ã€‚

![çƒå‹å¯¹ç®€å†çš„è®¤å¯](https://cdn.tobebetterjavaer.com/stutymore/redis-20250508104145.png)

### 16.Redisä¸»ä»æœ‰å‡ ç§å¸¸è§çš„æ‹“æ‰‘ç»“æ„ï¼Ÿ

ä¸»è¦æœ‰ä¸‰ç§ã€‚

æœ€åŸºç¡€çš„æ˜¯ä¸€ä¸»ä¸€ä»ï¼Œè¿™ç§æ¨¡å¼é€‚åˆå°å‹é¡¹ç›®ã€‚ä¸€ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£å†™å…¥ï¼Œä¸€ä¸ªä»èŠ‚ç‚¹è´Ÿè´£è¯»å’Œæ•°æ®å¤‡ä»½ã€‚è¿™ç§ç»“æ„è™½ç„¶ç®€å•ï¼Œä½†ç»´æŠ¤æˆæœ¬ä½ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸€ä¸»ä¸€ä»](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5d91a67c-dbff-4a8d-bf9d-1fe7602d5a27.png)

éšç€ä¸šåŠ¡å¢é•¿ï¼Œè¯»è¯·æ±‚å¢å¤šï¼Œå¯ä»¥è€ƒè™‘æ‰©å±•ä¸ºä¸€ä¸»å¤šä»ç»“æ„ã€‚ä¸»èŠ‚ç‚¹è´Ÿè´£å†™å…¥ï¼Œå¤šä¸ªä»èŠ‚ç‚¹è¿˜å¯ä»¥åˆ†æ‘Šå‹åŠ›ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸€ä¸»å¤šä»ç»“æ„](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-71074254-699a-480b-bbb0-c68f364a380b.png)

åœ¨è·¨åœ°åŸŸéƒ¨ç½²åœºæ™¯ä¸­ï¼Œæ ‘çŠ¶ä¸»ä»ç»“æ„å¯ä»¥æœ‰æ•ˆé™ä½ä¸»èŠ‚ç‚¹è´Ÿè½½å’Œéœ€è¦ä¼ é€ç»™ä»èŠ‚ç‚¹çš„æ•°æ®é‡ã€‚é€šè¿‡å¼•å…¥å¤åˆ¶ä¸­é—´å±‚ï¼Œä»èŠ‚ç‚¹ä¸ä»…å¯ä»¥å¤åˆ¶ä¸»èŠ‚ç‚¹æ•°æ®ï¼ŒåŒæ—¶å¯ä»¥ä½œä¸ºå…¶ä»–ä»èŠ‚ç‚¹çš„ä¸»èŠ‚ç‚¹ç»§ç»­å‘ä¸‹å±‚å¤åˆ¶ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ ‘çŠ¶ä¸»ä»ç»“æ„](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-dff14203-5e01-4d1b-a775-10ee444ada54.png)

### 17.Redisçš„ä¸»ä»å¤åˆ¶åŸç†äº†è§£å—ï¼Ÿ

äº†è§£ã€‚

Redis çš„ä¸»ä»å¤åˆ¶æ˜¯æŒ‡é€šè¿‡å¼‚æ­¥å¤åˆ¶å°†ä¸»èŠ‚ç‚¹çš„æ•°æ®å˜æ›´åŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œä»è€Œå®ç°æ•°æ®å¤‡ä»½å’Œè¯»å†™åˆ†ç¦»ã€‚è¿™ä¸ªè¿‡ç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šå»ºç«‹è¿æ¥ã€åŒæ­¥æ•°æ®å’Œä¼ æ’­å‘½ä»¤ã€‚

![pdai.techï¼šRedisä¸»ä»å¤åˆ¶åŸç†](https://cdn.tobebetterjavaer.com/stutymore/redis-20250508105718.png)

åœ¨å»ºç«‹è¿æ¥é˜¶æ®µï¼Œä»èŠ‚ç‚¹é€šè¿‡æ‰§è¡Œ `replicaof` å‘½ä»¤è¿æ¥åˆ°ä¸»èŠ‚ç‚¹ã€‚è¿æ¥å»ºç«‹åï¼Œä»èŠ‚ç‚¹å‘ä¸»èŠ‚ç‚¹å‘é€ `psync` å‘½ä»¤ï¼Œè¯·æ±‚æ•°æ®åŒæ­¥ã€‚è¿™æ—¶ä¸»èŠ‚ç‚¹ä¼šä¸ºè¯¥ä»èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªè¿æ¥å’Œå¤åˆ¶ç¼“å†²åŒºã€‚

![MainWoodsï¼šå¤åˆ¶ç¼“å†²åŒº](https://cdn.tobebetterjavaer.com/stutymore/redis-20250508110132.png)

åŒæ­¥æ•°æ®é˜¶æ®µåˆ†ä¸ºå…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥ã€‚å½“ä»èŠ‚ç‚¹é¦–æ¬¡è¿æ¥ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¼šè§¦å‘å…¨é‡åŒæ­¥ã€‚

![ningGï¼šå¢é‡åŒæ­¥å’Œå…¨é‡åŒæ­¥](https://cdn.tobebetterjavaer.com/stutymore/redis-20250508143059.png)

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¼š fork ä¸€ä¸ªå­è¿›ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼ŒåŒæ—¶å°†æ–‡ä»¶ç”ŸæˆæœŸé—´æ”¶åˆ°çš„å†™å‘½ä»¤ç¼“å­˜åˆ°å¤åˆ¶ç¼“å†²åŒºã€‚ç„¶åå°† RDB æ–‡ä»¶å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¸…ç©ºè‡ªå·±çš„æ•°æ®å¹¶åŠ è½½è¿™ä¸ª RDB æ–‡ä»¶ã€‚ç­‰ RDB ä¼ è¾“å®Œæˆåï¼Œä¸»èŠ‚ç‚¹å†å°†ç¼“å­˜çš„å†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹æ‰§è¡Œï¼Œç¡®ä¿æ•°æ®å®Œå…¨ä¸€è‡´ã€‚

![åšå®¢å›­å¤šå°‘å¹…åº¦ï¼šä¸»ä»æ•°æ®å¤åˆ¶è¿‡ç¨‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250508143956.png)

ä¸»ä»å®Œæˆå…¨é‡åŒæ­¥åï¼Œä¸»è¦ä¾é ä¼ æ’­å‘½ä»¤é˜¶æ®µæ¥ä¿æŒæ•°æ®çš„å¢é‡åŒæ­¥ã€‚ä¸»èŠ‚ç‚¹ä¼šå°†æ¯æ¬¡æ‰§è¡Œçš„å†™å‘½ä»¤å®æ—¶å‘é€ç»™æ‰€æœ‰ä»èŠ‚ç‚¹ã€‚

![ningGï¼šå‘½ä»¤ä¼ æ’­](https://cdn.tobebetterjavaer.com/stutymore/redis-20250508145116.png)

Redis 2.8 ç‰ˆæœ¬åï¼Œä¸»èŠ‚ç‚¹ä¼šä¸ºæ¯ä¸ªä»èŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨æœ€è¿‘çš„å†™å‘½ä»¤ã€‚

![MainWoodsï¼šå¤åˆ¶ç§¯å‹ç¼“å†²åŒº](https://cdn.tobebetterjavaer.com/stutymore/redis-20250508144622.png)

å¢é‡å¤åˆ¶æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šæŠŠè¦åŒæ­¥çš„å†™å‘½ä»¤æš‚å­˜ä¸€ä»½åˆ°å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚è¿™æ ·å½“ä»èŠ‚ç‚¹å’Œä¸»èŠ‚ç‚¹å‘ç”Ÿç½‘ç»œæ–­è¿ï¼Œä»èŠ‚ç‚¹é‡æ–°è¿æ¥åï¼Œå¯ä»¥ä»å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­å¤åˆ¶å°šæœªåŒæ­¥çš„å†™å‘½ä»¤ã€‚

![ä»æ‰¬ï¼šå¢é‡åŒæ­¥](https://cdn.tobebetterjavaer.com/stutymore/redis-20250508151116.png)

memoï¼š2025 å¹´ 5 æœˆ 8 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©æœ‰çƒå‹åœ¨[æ˜Ÿçƒé‡Œå‘å¸–è¯´æ‹¿åˆ°äº†è…¾è®¯çš„å®ä¹  offer](https://javabetter.cn/zhishixingqiu/)ï¼ŒçœŸçš„è¦æ­å–œäº†ã€‚é¢ç»ï¼Œæˆ‘çœ‹é¢˜ç›®ä¸»è¦é›†ä¸­åœ¨æŠ€æœ¯æ´¾é¡¹ç›®å’ŒMySQLã€è®¡ç®—æœºç½‘ç»œçš„å…«è‚¡ä¸Šã€‚

![çƒå‹æ‹¿åˆ°è…¾è®¯æš‘æœŸå®ä¹  offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250509114339.png)

### 18.è¯¦ç»†è¯´è¯´å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥ï¼Ÿ

å…¨é‡åŒæ­¥ä¼šå°†ä¸»èŠ‚ç‚¹çš„å®Œæ•´æ•°æ®é›†ä¼ è¾“ç»™ä»èŠ‚ç‚¹ï¼Œé€šå¸¸å‘ç”Ÿåœ¨ä»èŠ‚ç‚¹é¦–æ¬¡è¿æ¥ä¸»èŠ‚ç‚¹æ—¶ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå…¨é‡åŒæ­¥](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-aa8d2960-b341-49cc-b04c-201241fd15de.png)

æ­¤æ—¶ï¼Œä»èŠ‚ç‚¹å‘é€ `psync ? -1` å‘½ä»¤è¯·æ±‚åŒæ­¥ã€‚`?` è¡¨ç¤ºä»èŠ‚ç‚¹æ²¡æœ‰ä¸»èŠ‚ç‚¹ IDï¼Œ`-1` è¡¨ç¤ºæ²¡æœ‰åç§»é‡ã€‚ä¸»èŠ‚ç‚¹æ”¶åˆ°åä¼šå›å¤ `FULLRESYNC`å“åº”ä»èŠ‚ç‚¹ã€‚åŒæ—¶ä¹Ÿä¼šåŒ…å«ä¸»åº“ runid å’Œå¤åˆ¶åç§»é‡ offset ä¸¤ä¸ªå‚æ•°ã€‚

ç„¶å fork ä¸€ä¸ªå­è¿›ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œå¹¶å°†æ–°çš„å†™å‘½ä»¤å­˜å…¥å¤åˆ¶ç¼“å†²åŒºã€‚

ä»åº“æ”¶åˆ° RDB æ–‡ä»¶åï¼Œæ¸…ç©ºæ—§æ•°æ®å¹¶åŠ è½½æ–°çš„ RDB æ–‡ä»¶ã€‚åŠ è½½å®Œæˆåï¼Œä»èŠ‚ç‚¹ä¼šå‘ä¸»èŠ‚ç‚¹å›å¤ç¡®è®¤æ¶ˆæ¯ï¼Œä¸»èŠ‚ç‚¹å†å°†å¤åˆ¶ç¼“å†²åŒºä¸­çš„æ•°æ®å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œç¡®ä¿ä»èŠ‚ç‚¹çš„æ•°æ®ä¸ä¸»èŠ‚ç‚¹ä¸€è‡´ã€‚

å…¨é‡åŒæ­¥çš„ä»£ä»·å¾ˆé«˜ï¼Œå› ä¸ºå®Œæ•´çš„ RDB æ–‡ä»¶åœ¨ç”Ÿæˆæ—¶ä¼šå ç”¨å¤§é‡çš„ CPU å’Œç£ç›˜ IOï¼›åœ¨ç½‘ç»œä¼ è¾“æ—¶è¿˜ä¼šæ¶ˆè€—æ‰ä¸å°‘å¸¦å®½ã€‚

äºæ˜¯ Redis åœ¨ 2.8 ç‰ˆæœ¬åå¼•å…¥äº†å¢é‡åŒæ­¥çš„æ¦‚å¿µï¼Œç›®çš„æ˜¯åœ¨æ–­çº¿é‡è¿åé¿å…å…¨é‡åŒæ­¥ã€‚

å¢é‡ä¾èµ–ä¸‰ä¸ªå…³é”®è¦ç´ ï¼š

â‘ ã€å¤åˆ¶åç§»é‡ï¼šä¸»ä»èŠ‚ç‚¹åˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡ï¼Œè®°å½•ä¼ è¾“çš„å­—èŠ‚æ•°ã€‚ä¸»èŠ‚ç‚¹æ¯ä¼ è¾“ N ä¸ªå­—èŠ‚æ•°æ®ï¼Œè‡ªèº«çš„å¤åˆ¶åç§»é‡å°±ä¼šå¢åŠ  Nï¼›ä»èŠ‚ç‚¹æ¯æ”¶åˆ° N ä¸ªå­—èŠ‚æ•°æ®ï¼Œä¹Ÿä¼šç›¸åº”å¢åŠ è‡ªå·±çš„åç§»é‡ã€‚

â‘¡ã€ä¸»èŠ‚ç‚¹ IDï¼šæ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€ IDï¼Œå³å¤åˆ¶ IDï¼Œç”¨äºæ ‡è¯†ä¸»èŠ‚ç‚¹çš„æ•°æ®ç‰ˆæœ¬ã€‚å½“ä¸»èŠ‚ç‚¹å‘ç”Ÿé‡å¯æˆ–è€…è§’è‰²å˜åŒ–æ—¶ï¼ŒID ä¼šæ”¹å˜ã€‚

â‘¢ã€å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼šä¸»èŠ‚ç‚¹ç»´æŠ¤çš„ä¸€ä¸ªå›ºå®šé•¿åº¦çš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º 1Mã€‚ä¸»èŠ‚ç‚¹åœ¨å‘ä»èŠ‚ç‚¹å‘é€å‘½ä»¤çš„åŒæ—¶ï¼Œä¹Ÿä¼šå°†å‘½ä»¤å†™å…¥è¿™ä¸ªç¼“å†²åŒºã€‚

å½“ä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹æ–­å¼€é‡è¿åï¼Œä¼šå‘é€ `psync{runId}{offset}` å‘½ä»¤ï¼Œå¸¦ä¸Šä¹‹å‰è®°å½•çš„ä¸»èŠ‚ç‚¹ ID å’Œå¤åˆ¶åç§»é‡ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå¢é‡åŒæ­¥](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-87600c72-cc6a-4656-81b2-e71864c97f23.png)

ä¸»èŠ‚ç‚¹æ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œä¼šæ£€æŸ¥ runId å’Œ offsetï¼š

å¦‚æœä¸»èŠ‚ç‚¹ ID ä¸ä»èŠ‚ç‚¹æä¾›çš„ runId ä¸åŒ¹é…ï¼Œè¯´æ˜ä¸»èŠ‚ç‚¹å·²ç»å˜åŒ–ï¼Œå¿…é¡»è¿›è¡Œå…¨é‡åŒæ­¥ã€‚

å¦‚æœ ID åŒ¹é…ï¼Œä¸»èŠ‚ç‚¹ä¼šæŸ¥æ‰¾ä»èŠ‚ç‚¹è¯·æ±‚çš„åç§»é‡ä¹‹åçš„æ•°æ®æ˜¯å¦è¿˜åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚

å¦‚æœåœ¨ï¼Œåªå‘é€ä»è¯¥åç§»é‡å¼€å§‹çš„å¢é‡æ•°æ®ï¼Œè¿™å°±æ˜¯å¢é‡åŒæ­¥ï¼›å¦åˆ™è¯´æ˜æ–­çº¿æ—¶é—´å¤ªé•¿ï¼Œç§¯å‹ç¼“å†²åŒºå·²ç»è¦†ç›–äº†è¿™éƒ¨åˆ†æ•°æ®ï¼Œéœ€è¦å…¨é‡åŒæ­¥ã€‚

![ç å“¥å­—èŠ‚ï¼šå¤åˆ¶ç§¯å‹ç¼“å†²åŒº](https://cdn.tobebetterjavaer.com/stutymore/redis-20250509154335.png)

å¢é‡åŒæ­¥çš„ä¼˜åŠ¿æ˜¾è€Œæ˜“è§ï¼šåªä¼ è¾“æ–­çº¿æœŸé—´çš„å‘½ä»¤æ•°æ®ï¼Œå¤§å¤§å‡å°‘äº†ç½‘ç»œä¼ è¾“é‡å’Œä¸»ä»èŠ‚ç‚¹çš„è´Ÿè½½ï¼Œä»èŠ‚ç‚¹ä¹Ÿä¸éœ€è¦æ¸…ç©ºé‡è½½æ•°æ®ï¼Œèƒ½æ›´å¿«åœ°è·Ÿä¸Šä¸»èŠ‚ç‚¹çŠ¶æ€ã€‚

å¯¹äºå†™å…¥é¢‘ç¹æˆ–ç½‘ç»œä¸ç¨³å®šçš„ç¯å¢ƒï¼Œåº”è¯¥å¢å¤§å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°ï¼Œç¡®ä¿çŸ­æ—¶é—´æ–­çº¿åèƒ½è¿›è¡Œå¢é‡åŒæ­¥è€Œä¸æ˜¯å…¨é‡åŒæ­¥ã€‚

```shell
repl-backlog-size 1mb  # é»˜è®¤å€¼ 1MBï¼Œè¡¨ç¤ºä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºå¤§å°
repl-backlog-ttl 3600  # é»˜è®¤å€¼ 3600 ç§’ï¼Œè¡¨ç¤ºä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºå­˜æ´»æ—¶é—´
```

memoï¼š2025 å¹´ 5 æœˆ 9 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹[çƒå‹ç®€å†](https://javabetter.cn/zhishixingqiu/jianli.html)æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªæ²³åŒ—å¤§å­¦ç¡•ä¸œåç†å·¥å¤§å­¦æœ¬çš„çƒå‹ï¼Œå¸Œæœ›è¿™ä¸ªå¤§å®¶åº­èƒ½ç»™å¤§å®¶å¸¦æ¥æ›´å¤šçš„å¸®åŠ©å’Œæ”¯æŒã€‚

![æ²³åŒ—å¤§å­¦çš„çƒå‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250509154541.png)

### 19.ä¸»ä»å¤åˆ¶å­˜åœ¨å“ªäº›é—®é¢˜å‘¢ï¼Ÿ

Redis ä¸»ä»å¤åˆ¶çš„æœ€å¤§æŒ‘æˆ˜æ¥è‡ªäºå®ƒçš„å¼‚æ­¥ç‰¹æ€§ï¼Œä¸»èŠ‚ç‚¹å¤„ç†å®Œå†™å‘½ä»¤åä¼šç«‹å³å“åº”å®¢æˆ·ç«¯ï¼Œè€Œä¸ä¼šç­‰å¾…ä»èŠ‚ç‚¹ç¡®è®¤ï¼Œè¿™å°±å¯¼è‡´åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚

![leonshï¼šä¸»ä»åŒæ­¥](https://cdn.tobebetterjavaer.com/stutymore/redis-20250510110627.png)

å¦ä¸€ä¸ªå¸¸è§é—®é¢˜æ˜¯å…¨é‡åŒæ­¥å¯¹ç³»ç»Ÿçš„å†²å‡»ã€‚å…¨é‡åŒæ­¥ä¼šå ç”¨å¤§é‡çš„ CPU å’Œ IO èµ„æºï¼Œå°¤å…¶æ˜¯åœ¨å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œä¼šå¯¼è‡´ä¸»èŠ‚ç‚¹çš„æ€§èƒ½ä¸‹é™ã€‚

#### è„‘è£‚é—®é¢˜äº†è§£å—ï¼Ÿ

åœ¨ Redis çš„å“¨å…µæ¶æ„ä¸­ï¼Œè„‘è£‚çš„å…¸å‹è¡¨ç°ä¸ºï¼šä¸»èŠ‚ç‚¹ä¸å“¨å…µã€ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œå‘ç”Ÿæ•…éšœäº†ï¼Œä½†ä¸å®¢æˆ·ç«¯çš„è¿æ¥æ˜¯æ­£å¸¸çš„ï¼Œå°±ä¼šå‡ºç°ä¸¤ä¸ªâ€œä¸»èŠ‚ç‚¹â€åŒæ—¶å¯¹å¤–æä¾›æœåŠ¡ã€‚

å“¨å…µè®¤ä¸ºä¸»èŠ‚ç‚¹å·²ç»ä¸‹çº¿äº†ï¼Œäºæ˜¯ä¼šå°†ä¸€ä¸ªä»èŠ‚ç‚¹é€‰ä¸¾ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚ä½†åŸä¸»èŠ‚ç‚¹å¹¶ä¸çŸ¥æƒ…ï¼Œä»ç„¶åœ¨ç»§ç»­å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚

![æ©¡ çš® äººï¼šè„‘è£‚é—®é¢˜](https://cdn.tobebetterjavaer.com/stutymore/redis-20250510112217.png)

ç­‰ä¸»èŠ‚ç‚¹ç½‘ç»œæ¢å¤æ­£å¸¸äº†ï¼Œå‘ç°å·²ç»æœ‰æ–°çš„ä¸»èŠ‚ç‚¹äº†ï¼Œäºæ˜¯åŸä¸»èŠ‚ç‚¹ä¼šè‡ªåŠ¨é™çº§ä¸ºä»èŠ‚ç‚¹ã€‚åœ¨é™çº§è¿‡ç¨‹ä¸­ï¼Œå®ƒéœ€è¦ä¸æ–°ä¸»èŠ‚ç‚¹è¿›è¡Œå…¨é‡åŒæ­¥ï¼Œæ­¤æ—¶åŸä¸»èŠ‚ç‚¹çš„æ•°æ®ä¼šè¢«æ¸…ç©ºã€‚å¯¼è‡´å®¢æˆ·ç«¯åœ¨åŸä¸»èŠ‚ç‚¹æ•…éšœæœŸé—´å†™å…¥çš„æ•°æ®å…¨éƒ¨ä¸¢å¤±ã€‚

![æå®¢æ—¶é—´ï¼šè„‘è£‚é—®é¢˜å¯¼è‡´æ•°æ®ä¸¢å¤±](https://cdn.tobebetterjavaer.com/stutymore/redis-20250510114037.png)

ä¸ºäº†é˜²æ­¢è¿™ç§æ•°æ®ä¸¢å¤±ï¼ŒRedis æä¾›äº† min-slaves-to-write å’Œ min-slaves-max-lag å‚æ•°ã€‚

è¿™ä¸¤ä¸ªå‚æ•°å¯ä»¥è®¾ç½®æœ€å°‘éœ€è¦å¤šå°‘ä¸ªä»èŠ‚ç‚¹åœ¨çº¿ï¼Œä»¥åŠä»èŠ‚ç‚¹çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´ã€‚

```shell
# è®¾ç½®ä¸»èŠ‚ç‚¹èƒ½è¿›è¡Œæ•°æ®åŒæ­¥çš„æœ€å°‘ä»èŠ‚ç‚¹æ•°é‡
min-slaves-to-write 1
# è®¾ç½®ä¸»ä»èŠ‚ç‚¹é—´è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œä»èŠ‚ç‚¹ç»™ä¸»èŠ‚ç‚¹å‘é€ ACK æ¶ˆæ¯çš„æœ€å¤§å»¶è¿Ÿï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰
min-slaves-max-lag 10
```

è®¾ç½®è¿™ä¸¤ä¸ªå‚æ•°åï¼Œå¦‚æœä¸»èŠ‚ç‚¹è¿æ¥ä¸åˆ°æŒ‡å®šæ•°é‡çš„ä»èŠ‚ç‚¹ï¼Œæˆ–è€…ä»èŠ‚ç‚¹å“åº”è¶…æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šæ‹’ç»å†™å…¥è¯·æ±‚ï¼Œä»è€Œé¿å…è„‘è£‚æœŸé—´çš„æ•°æ®å†²çªã€‚

å…·ä½“æ¥è¯´ï¼Œå½“ç½‘ç»œåˆ†åŒºå‘ç”Ÿï¼Œä¸»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹ã€å“¨å…µä¹‹é—´çš„è¿æ¥æ–­å¼€ï¼Œä½†ä¸»èŠ‚ç‚¹ä¸å®¢æˆ·ç«¯çš„è¿æ¥æ­£å¸¸æ—¶ï¼Œç”±äºä¸»èŠ‚ç‚¹æ— æ³•å†è¿æ¥åˆ°ä»»ä½•ä»èŠ‚ç‚¹ï¼Œæˆ–è€…å»¶è¿Ÿè¶…è¿‡äº†è®¾å®šå€¼ï¼Œæ¯”å¦‚è¯´é…ç½®äº†`min-slaves-to-write 1`ï¼Œä¸»èŠ‚ç‚¹å°±ä¼šè‡ªåŠ¨æ‹’ç»æ‰€æœ‰å†™è¯·æ±‚ã€‚

åŒæ—¶åœ¨ç½‘ç»œçš„å¦ä¸€ä¾§ï¼Œå“¨å…µä¼šæ£€æµ‹åˆ°ä¸»èŠ‚ç‚¹"ä¸‹çº¿"ï¼Œé€‰ä¸¾ä¸€ä¸ªä»èŠ‚ç‚¹æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚ç”±äºåŸä¸»èŠ‚ç‚¹å·²ç»åœæ­¢æ¥å—å†™å…¥ï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿæ–°çš„æ•°æ®å˜æ›´ï¼Œç­‰ç½‘ç»œæ¢å¤åï¼Œå³ä½¿åŸä¸»èŠ‚ç‚¹é™çº§ä¸ºä»èŠ‚ç‚¹å¹¶è¿›è¡Œå…¨é‡åŒæ­¥ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±ç½‘ç»œåˆ†åŒºæœŸé—´çš„å†™å…¥æ•°æ®ï¼Œå› ä¸ºæ ¹æœ¬å°±æ²¡æœ‰æ–°çš„å†™å…¥å‘ç”Ÿã€‚


> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šä¸»ä»å¤åˆ¶æœ‰ä»€ä¹ˆç¼ºç‚¹å‘¢ï¼Ÿredisçš„è„‘è£‚é—®é¢˜

memoï¼š2025 å¹´ 5 æœˆ 10 æ—¥ä»Šå¤©æŠŠæ–°é¡¹ç›®çš„å‰ç½®ç¯å¢ƒä¹Ÿé…çš„ä¸ƒä¸ƒå…«å…«äº†ï¼Œè¿˜å·®ä¸€ä¸ª Kafka çš„å®‰è£…æ•™ç¨‹ã€‚æ—¥æ‹±ä¸€å’ï¼Œäº‰å–[ç§‹æ‹›å‰ç»™å¤§å®¶çƒå‹ä»¬è§é¢](https://javabetter.cn/zhishixingqiu/)ã€‚

![æ˜Ÿçƒæ–°é¡¹ç›®çš„è¿›åº¦ï¼šå‰ç½®ç¯å¢ƒçš„æ•™ç¨‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250510220656.png)

### 20.Rediså“¨å…µæœºåˆ¶äº†è§£å—ï¼Ÿ

Redis ä¸­çš„å“¨å…µç”¨äºç›‘æ§ä¸»ä»é›†ç¾¤çš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åœ¨ä¸»èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis Sentinel](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-8b1a055c-f077-49ff-9432-c194d4fc3639.png)

æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ç›‘æ§ã€é€šçŸ¥å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚å“¨å…µä¼šå®šæœŸæ£€æŸ¥ä¸»ä»èŠ‚ç‚¹æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œï¼Œå½“æ£€æµ‹åˆ°ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œå°±åœ¨ä»èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶é€šçŸ¥å®¢æˆ·ç«¯è¿æ¥åˆ°æ–°çš„ä¸»èŠ‚ç‚¹ã€‚

```shell
# ç›‘æ§çš„ä¸»èŠ‚ç‚¹ä¿¡æ¯ + å¤šå°‘ä¸ªå“¨å…µåŒæ„æ‰ç®—å®•æœº
sentinel monitor mymaster 127.0.0.1 6379 2
# å¤šä¹…ä¸å“åº”å°±æ ‡è®°ä¸ºâ€œä¸»è§‚ä¸‹çº¿â€
sentinel down-after-milliseconds mymaster 5000
# æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´
sentinel failover-timeout mymaster 60000
# åŒæ—¶å…è®¸å¤šå°‘ä¸ªä»èŠ‚ç‚¹åŒæ­¥æ–°ä¸»èŠ‚ç‚¹æ•°æ®
sentinel parallel-syncs mymaster 1
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æ¯”äºšè¿ªé¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRedis çš„å“¨å…µæœºåˆ¶äº†è§£å—ï¼Ÿ


### 21.Rediså“¨å…µçš„å·¥ä½œåŸç†çŸ¥é“å—ï¼Ÿ

å“¨å…µçš„å·¥ä½œåŸç†å¯ä»¥æ¦‚æ‹¬ä¸º 4 ä¸ªå…³é”®æ­¥éª¤ï¼šå®šæ—¶ç›‘æ§ã€ä¸»è§‚ä¸‹çº¿ã€é¢†å¯¼è€…é€‰ä¸¾å’Œæ•…éšœè½¬ç§»ã€‚

é¦–å…ˆï¼Œå“¨å…µä¼šå®šæœŸå‘æ‰€æœ‰ Redis èŠ‚ç‚¹å‘é€ PING å‘½ä»¤æ¥æ£€æµ‹å®ƒä»¬æ˜¯å¦å¯è¾¾ã€‚å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œå“¨å…µä¼šå°†è¯¥èŠ‚ç‚¹æ ‡è®°ä¸ºâ€œä¸»è§‚ä¸‹çº¿â€ã€‚

![åŸé‡æ¼«æ­¥ï¼šsentinel](https://cdn.tobebetterjavaer.com/stutymore/redis-20250511135906.png)


å½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿åï¼Œä¼šè¯¢é—®å…¶ä»–å“¨å…µçš„æ„è§ï¼Œå¦‚æœè¾¾åˆ°é…ç½®çš„æ³•å®šäººæ•°ï¼Œä¸»èŠ‚ç‚¹ä¼šè¢«æ ‡è®°ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-11839a24-9249-48a5-8c9d-888aa80d91dc.png)

ç„¶åå¼€å§‹æ•…éšœè½¬ç§»ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå“¨å…µä¼šå…ˆé€‰ä¸¾å‡ºä¸€ä¸ªé¢†å¯¼è€…ï¼Œé¢†å¯¼è€…å†ä»ä»èŠ‚ç‚¹ä¸­é€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆçš„èŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œé€‰æ‹©æ ‡å‡†åŒ…æ‹¬å¤åˆ¶åç§»é‡ã€ä¼˜å…ˆçº§ç­‰å› ç´ ã€‚

![å›´é¾™å°å­ï¼šé¢†å¯¼è€…é€‰ä¸¾](https://cdn.tobebetterjavaer.com/stutymore/redis-20250511141612.png)

ç¡®å®šæ–°ä¸»èŠ‚ç‚¹åï¼Œå“¨å…µä¼šå‘å…¶å‘é€ `SLAVEOF NO ONE` å‘½ä»¤ä½¿å…¶å‡çº§ä¸ºä¸»èŠ‚ç‚¹ï¼Œç„¶åå‘å…¶ä»–ä»èŠ‚ç‚¹å‘é€ SLAVEOF å‘½ä»¤æŒ‡å‘æ–°ä¸»èŠ‚ç‚¹ï¼Œæœ€åé€šè¿‡å‘å¸ƒ/è®¢é˜…æœºåˆ¶é€šçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹å·²ç»å‘ç”Ÿå˜åŒ–ã€‚

![ä¸€æ³½æ¶Ÿæ¼ªï¼šRedis Sentinelæ•…éšœè½¬ç§»](https://cdn.tobebetterjavaer.com/stutymore/redis-20250511141103.png)

åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œä¸ºäº†ä¿è¯å“¨å…µæœºåˆ¶çš„å¯é æ€§ï¼Œé€šå¸¸å»ºè®®è‡³å°‘éƒ¨ç½²ä¸‰ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œå¹¶ä¸”è¿™äº›èŠ‚ç‚¹åº”åˆ†å¸ƒåœ¨ä¸åŒçš„ç‰©ç†æœºå™¨ä¸Šï¼Œé™ä½å•ç‚¹æ•…éšœé£é™©ã€‚

![å®ˆæ ªé˜ï¼šå“¨å…µæ•…éšœè½¬ç§»](https://cdn.tobebetterjavaer.com/stutymore/redis-20250512171147.png)

åŒæ—¶ï¼Œæ³•å®šäººæ•°çš„è®¾ç½®ä¹Ÿéå¸¸å…³é”®ï¼Œä¸€èˆ¬å»ºè®®è®¾ç½®ä¸ºå“¨å…µæ•°é‡çš„ä¸€åŠåŠ ä¸€ï¼Œæ—¢èƒ½ç¡®ä¿åœ¨å°‘æ•°å“¨å…µæ•…éšœæ—¶ç³»ç»Ÿä»èƒ½æ­£å¸¸å·¥ä½œï¼Œåˆèƒ½é¿å…ç½‘ç»œåˆ†åŒºå¯¼è‡´çš„è„‘è£‚é—®é¢˜ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ OPPO é¢ç»åŒå­¦ 1 é¢è¯•åŸé¢˜ï¼šRedisçš„Sentinelå’ŒClusteræ€ä¹ˆç†è§£ï¼Ÿè¯´ä¸€ä¸‹å¤§æ¦‚åŸç†

memoï¼šè´´ä¸€ä¸ªè¯»è€…å¯¹ Java è¿›é˜¶ä¹‹è·¯çš„ç¾èµå§ï¼Œæˆ‘ä¹Ÿæ˜¯äººï¼Œä¹Ÿéœ€è¦å¤§å®¶çš„æƒ…ç»ªå…±é¸£ï¼Œå“ˆå“ˆï¼Œå°±è®©èµç¾å¤šä¸€ç‚¹å§ğŸ˜„

![è¯»è€…å¯¹ Java è¿›é˜¶ä¹‹è·¯çš„ç¾èµ](https://cdn.tobebetterjavaer.com/stutymore/redis-20250511142127.png)

### 22.Redisé¢†å¯¼è€…é€‰ä¸¾äº†è§£å—ï¼Ÿ

Redis ä½¿ç”¨ Raft ç®—æ³•å®ç°é¢†å¯¼è€…é€‰ä¸¾ï¼Œç›®çš„æ˜¯åœ¨ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œé€‰å‡ºä¸€ä¸ªå“¨å…µæ¥è´Ÿè´£æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šé¢†å¯¼è€…é€‰ä¸¾](https://cdn.tobebetterjavaer.com/stutymore/redis-20240819112712.png)

é€‰ä¸¾è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

â‘ ã€å½“ä¸€ä¸ªå“¨å…µç¡®è®¤ä¸»èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿åï¼Œä¼šå‘å…¶ä»–å“¨å…µèŠ‚ç‚¹å‘é€è¯·æ±‚ï¼Œè¡¨æ˜å¸Œæœ›ç”±è‡ªå·±æ¥æ‰§è¡Œä¸»ä»åˆ‡æ¢ï¼Œå¹¶è®©æ‰€æœ‰å…¶ä»–å“¨å…µè¿›è¡ŒæŠ•ç¥¨ã€‚å€™é€‰è€…ä¼šå…ˆç»™è‡ªå·±å…ˆæŠ• 1 ç¥¨ï¼Œç„¶åç­‰å¾…å…¶ä»–å“¨å…µèŠ‚ç‚¹çš„æŠ•ç¥¨ç»“æœã€‚

```c
// sentinel.cä¸­çš„sentinelAskMasterStateToOtherSentinelså‡½æ•°
void sentinelAskMasterStateToOtherSentinels(sentinelRedisInstance *master) {
    dictIterator *di;
    dictEntry *de;

    di = dictGetIterator(master->sentinels);
    while((de = dictNext(di)) != NULL) {
        sentinelRedisInstance *sentinel = dictGetVal(de);
        int retval;
        
        // åªæœ‰åœ¨è¿›å…¥é¢†å¯¼è€…é€‰ä¸¾é˜¶æ®µæ‰å‘é€æŠ•ç¥¨è¯·æ±‚
        if (master->failover_state == SENTINEL_FAILOVER_STATE_SELECT_LEADER) {
            // å‘é€ç‰¹æ®Šçš„is-master-down-by-addrå‘½ä»¤è¯·æ±‚æŠ•ç¥¨
            retval = redisAsyncCommand(sentinel->cc,
                sentinelReceiveVoteFromSentinel, sentinel,
                "SENTINEL is-master-down-by-addr %s %d %llu %s",
                master->addr->ip, master->addr->port,
                (unsigned long long)master->failover_epoch,
                // è¿™é‡Œå‘é€è‡ªå·±çš„runidè¯·æ±‚æŠ•ç¥¨
                sentinelGetMyRunID());
        } else {
            // å¦åˆ™åªè¯¢é—®ä¸»èŠ‚ç‚¹çŠ¶æ€ï¼Œä¸è¯·æ±‚æŠ•ç¥¨
            retval = redisAsyncCommand(sentinel->cc,
                sentinelReceiveIsMasterDownReply, sentinel,
                "SENTINEL is-master-down-by-addr %s %d %llu *",
                master->addr->ip, master->addr->port,
                (unsigned long long)0);
        }
    }
    dictReleaseIterator(di);
}
```

â‘¡ã€æ”¶åˆ°è¯·æ±‚çš„å“¨å…µèŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå€™é€‰è€…çš„æ—¥å¿—å’Œè‡ªå·±çš„ä¸€æ ·æ–°ï¼Œä»»æœŸå·ä¹Ÿå°äºè‡ªå·±ï¼Œä¸”ä¹‹å‰æ²¡æœ‰æŠ•ç¥¨è¿‡ï¼Œå°±ä¼šæŠ•åŒæ„ç¥¨ Yã€‚å¦åˆ™å›å¤ Nã€‚

```c
// sentinel.cä¸­çš„sentinelCommandå‡½æ•°éƒ¨åˆ†(å¤„ç†SENTINELå‘½ä»¤)
// å¤„ç†is-master-down-by-addrå‘½ä»¤
else if (!strcasecmp(c->argv[1]->ptr,"is-master-down-by-addr")) {
    /* SENTINEL IS-MASTER-DOWN-BY-ADDR <ip> <port> <current-epoch> <runid> */
    sentinelRedisInstance *ri;
    char *master_ip = c->argv[2]->ptr;
    int master_port = atoi(c->argv[3]->ptr);
    long long req_epoch = strtoull(c->argv[4]->ptr,NULL,10);
    char *req_runid = c->argv[5]->ptr;
    int isdown = 0;
    char *leader = "*";
    long long leader_epoch = -1;
    
    ri = sentinelGetMasterByAddress(master_ip, master_port);
    if (ri) {
        isdown = ri->flags & SRI_S_DOWN;
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯æŠ•ç¥¨è¯·æ±‚
        if (req_runid[0] != '*') {
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å½“å‰é…ç½®çºªå…ƒä¸­æŠ•è¿‡ç¥¨
            if (req_epoch > sentinel.current_epoch) {
                // æ›´æ–°è‡ªå·±çš„é…ç½®çºªå…ƒ
                sentinel.current_epoch = req_epoch;
            }
            
            // å¦‚æœæˆ‘ä»¬è§‰å¾—ä¸»èŠ‚ç‚¹ä¸‹çº¿äº†ï¼Œä¸”åœ¨è¿™ä¸ªepochè¿˜æ²¡æŠ•è¿‡ç¥¨ï¼Œåˆ™æŠ•ç¥¨
            if (isdown && sentinel.current_epoch == req_epoch &&
                sentinel.leader_epoch < req_epoch)
            {
                // è®°å½•æŠ•ç¥¨ä¿¡æ¯
                sentinel.leader_epoch = req_epoch;
                sentinel.leader = sdsnew(req_runid);
                leader = req_runid;
                leader_epoch = req_epoch;
            }
        }
    }
    
    // è¿”å›æŠ•ç¥¨ç»“æœ
    addReplyMultiBulkLen(c,3);
    addReplyLongLong(c, isdown);
    addReplyBulkCString(c, leader);
    addReplyLongLong(c, leader_epoch);
}
```

â‘¢ã€å€™é€‰è€…æ”¶åˆ°æŠ•ç¥¨åä¼šç»Ÿè®¡è‡ªå·±çš„å¾—ç¥¨æ•°ï¼Œå¦‚æœè·å¾—äº†é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°èŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œå®ƒå°±ä¼šå½“é€‰ä¸ºé¢†å¯¼è€…ã€‚

```c
// sentinel.cä¸­çš„sentinelReceiveVoteFromSentinelå‡½æ•°
void sentinelReceiveVoteFromSentinel(redisAsyncContext *c, void *reply, void *privdata) {
    sentinelRedisInstance *sentinel = privdata;
    sentinelRedisInstance *master = sentinel->master;
    redisReply *r = reply;
    char *leader = NULL;
    
    // å¤„ç†å›å¤
    if (r->type == REDIS_REPLY_ARRAY && r->elements == 3) {
        // è§£æå›å¤ä¸­çš„leaderä¿¡æ¯
        if (r->element[1]->type == REDIS_REPLY_STRING)
            leader = r->element[1]->str;
        
        // æ£€æŸ¥æ˜¯å¦æŠ•ç»™äº†æˆ‘ä»¬
        if (leader && strcmp(leader, sentinelGetMyRunID()) == 0) {
            // è®°å½•è·å¾—ä¸€ç¥¨
            dictAdd(master->sentinels_voted, sdsnew(sentinel->runid), sentinel);
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦è·å¾—å¤šæ•°ç¥¨
    if (master->failover_state == SENTINEL_FAILOVER_STATE_SELECT_LEADER) {
        int voters = dictSize(master->sentinels) + 1; // +1æ˜¯å› ä¸ºåŒ…æ‹¬è‡ªå·±
        int votes = dictSize(master->sentinels_voted) + 1; // è‡ªå·±ä¹Ÿç®—ä¸€ç¥¨
        
        // å¦‚æœè·å¾—å¤šæ•°ç¥¨(å¤§äºä¸€åŠ)
        if (votes >= voters/2+1) {
            // æˆä¸ºé¢†å¯¼è€…ï¼Œå¼€å§‹æ‰§è¡Œæ•…éšœè½¬ç§»
            sentinelEvent(LL_WARNING, "+elected-leader", master, "%@");
            master->failover_state = SENTINEL_FAILOVER_STATE_FAILOVER_IN_PROGRESS;
            sentinelFailoverSelectSlave(master);
        }
    }
}
```

â‘£ã€å¦‚æœæ²¡æœ‰å“¨å…µåœ¨è¿™ä¸€è½®æŠ•ç¥¨ä¸­è·å¾—è¶…è¿‡åŠæ•°çš„é€‰ç¥¨ï¼Œè¿™æ¬¡é€‰ä¸¾å°±ä¼šå¤±è´¥ï¼Œç„¶åè¿›è¡Œä¸‹ä¸€è½®çš„é€‰ä¸¾ã€‚ä¸ºäº†é˜²æ­¢æ— é™åˆ¶çš„é€‰ä¸¾å¤±è´¥ï¼Œæ¯ä¸ªå“¨å…µéƒ½ä¼šæœ‰ä¸€ä¸ªé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œä¸”æ˜¯éšæœºçš„ã€‚

```c
// sentinel.cä¸­çš„sentinelFailoverSelectLeaderå‡½æ•°
void sentinelFailoverSelectLeader(sentinelRedisInstance *master) {
    // æ£€æŸ¥é€‰ä¸¾æ˜¯å¦è¶…æ—¶
    mstime_t election_timeout = SENTINEL_ELECTION_TIMEOUT * 2;
    if (mstime() - master->failover_start_time > election_timeout) {
        // é€‰ä¸¾è¶…æ—¶ï¼Œé‡ç½®çŠ¶æ€
        sentinelEvent(LL_WARNING, "-failover-abort-timeout", master, "%@");
        sentinelAbortFailover(master);
        return;
    }
    
    // ... å…¶ä»–é€‰ä¸¾é€»è¾‘ ...
    
    // å¦‚æœæ²¡æœ‰è¶³å¤Ÿç¥¨æ•°ä¸”æœªè¶…æ—¶ï¼Œåˆ™ç»§ç»­ç­‰å¾…
}
```

è¿™é‡Œ SENTINEL_ELECTION_TIMEOUT_MIN é€šå¸¸ä¸º 0ï¼ŒSENTINEL_ELECTION_TIMEOUT_MAX é€šå¸¸ä¸º 2000 æ¯«ç§’ã€‚è¿™æ ·æ¯ä¸ªå“¨å…µä¼šåœ¨ 0-2 ç§’çš„éšæœºæ—¶é—´åå¼€å§‹é€‰ä¸¾ï¼Œå‡å°‘é€‰ä¸¾å†²çªã€‚

æ¨èé˜…è¯»ï¼š[Raftç®—æ³•çš„é€‰ä¸»è¿‡ç¨‹è¯¦è§£](https://hoverzheng.github.io/post/technology-blog/blockchain/raft%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A33--%E9%80%89%E4%B8%BB/)

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„8 åç«¯å¼€å‘ç§‹æ‹›ä¸€é¢é¢è¯•åŸé¢˜ï¼šraftä¸»èŠ‚ç‚¹æŒ‚äº†æ€ä¹ˆé€‰ä»èŠ‚ç‚¹

memoï¼š2025 å¹´ 5 æœˆ 12 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©[æœ‰çƒå‹å‘å¾®ä¿¡](https://javabetter.cn/zhishixingqiu/)è¯´æ‹¿åˆ°äº†ä¸‰ä¸ªå¤§å‚çš„ offerï¼Œåˆ†åˆ«æ˜¯èš‚èšã€ç¾å›¢å’Œè…¾è®¯ï¼ŒçœŸçš„æ˜¯å¤ªä¼˜ç§€äº†å‘€ã€‚

![çƒå‹æ‹¿åˆ°äº†èš‚èšã€ç¾å›¢å’Œè…¾è®¯çš„ offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250512174725.png)

### 23.æ–°çš„ä¸»èŠ‚ç‚¹æ˜¯æ€æ ·è¢«æŒ‘é€‰å‡ºæ¥çš„ï¼Ÿ

å“¨å…µåœ¨æŒ‘é€‰æ–°çš„ä¸»èŠ‚ç‚¹æ—¶ï¼Œéå¸¸ç²¾ç»†åŒ–ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ–°ä¸»èŠ‚ç‚¹çš„æŒ‘é€‰è¿‡ç¨‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-03976d35-20b6-4efe-aa9c-7d3759460d34.png)

é¦–å…ˆï¼Œå“¨å…µä¼šå¯¹æ‰€æœ‰ä»èŠ‚ç‚¹è¿›è¡Œä¸€è½®åŸºç¡€ç­›é€‰ï¼Œæ’é™¤é‚£äº›ä¸æ»¡è¶³åŸºæœ¬æ¡ä»¶çš„èŠ‚ç‚¹ã€‚æ¯”å¦‚è¯´å·²ä¸‹çº¿çš„èŠ‚ç‚¹ã€ç½‘ç»œè¿æ¥ä¸ç¨³å®šçš„èŠ‚ç‚¹ï¼Œä»¥åŠä¼˜å…ˆçº§è®¾ä¸º 0 æ˜ç¡®ä¸å‚ä¸æŒ‘é€‰çš„èŠ‚ç‚¹ã€‚

```c
// ç¬¬ä¸€è½®ç­›é€‰ï¼šæ’é™¤ä¸æ»¡è¶³åŸºæœ¬æ¡ä»¶çš„ä»èŠ‚ç‚¹
for (int i = 0; i < numslaves; i++) {
    sentinelRedisInstance *slave = slaves[i];
    
    // æ’é™¤å·²ä¸‹çº¿çš„ä»èŠ‚ç‚¹
    if (slave->flags & (SRI_S_DOWN|SRI_O_DOWN)) continue;
    // æ’é™¤æ–­å¼€è¿æ¥çš„ä»èŠ‚ç‚¹
    if (slave->link->disconnected) continue;
    // æ’é™¤è¿‘æœŸï¼ˆ5ç§’å†…ï¼‰æ–­è¿‡è¿çš„ä»èŠ‚ç‚¹
    if (mstime() - slave->link->last_avail_time > 5000) continue;
    // æ’é™¤æœªå»ºç«‹ä¸»ä»å¤åˆ¶çš„èŠ‚ç‚¹
    if (slave->slave_priority == 0) continue;
    
    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ä»èŠ‚ç‚¹
    selected = i;
    break;
}
```

ç„¶åï¼Œå“¨å…µä¼šå¯¹å‰©ä¸‹çš„ä»èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œé€‰å‡ºæœ€åˆé€‚çš„ä¸»èŠ‚ç‚¹ã€‚

```c
// sentinel.cä¸­çš„compareSlaveså‡½æ•°
int compareSlaves(sentinelRedisInstance *a, sentinelRedisInstance *b) {
    // 1. é¦–å…ˆæ¯”è¾ƒç”¨æˆ·è®¾ç½®çš„ä¼˜å…ˆçº§ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
    if (a->slave_priority != b->slave_priority)
        return (a->slave_priority < b->slave_priority) ? 1 : 2;
        
    // 2. å¦‚æœä¼˜å…ˆçº§ç›¸åŒï¼Œæ¯”è¾ƒå¤åˆ¶åç§»é‡ï¼Œåç§»é‡è¶Šå¤§æ•°æ®è¶Šæ–°
    if (a->slave_repl_offset > b->slave_repl_offset) return 1;
    else if (a->slave_repl_offset < b->slave_repl_offset) return 2;
    
    // 3. å¦‚æœå¤åˆ¶åç§»é‡ä¹Ÿç›¸åŒï¼Œæ¯”è¾ƒè¿è¡ŒIDçš„å­—å…¸åº
    return (strcmp(a->runid, b->runid) < 0) ? 1 : 2;
}
```

æ’åºçš„æ ‡å‡†æœ‰ä¸‰ä¸ªï¼š

â‘ ã€**ä»èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼š** slave-priority çš„å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œä¼˜å…ˆçº§ä¸º 0 çš„ä»èŠ‚ç‚¹ä¸ä¼šè¢«é€‰ä¸­ã€‚

â‘¡ã€**å¤åˆ¶åç§»é‡ï¼š** åç§»é‡è¶Šå¤§æ„å‘³ç€ä»èŠ‚ç‚¹çš„æ•°æ®è¶Šæ–°ï¼Œå¤åˆ¶çš„è¶Šå®Œæ•´ã€‚

â‘¢ã€**è¿è¡Œ IDï¼š** å¦‚æœä¼˜å…ˆçº§å’Œåç§»é‡éƒ½ç›¸åŒï¼Œå°±æ¯”è¾ƒè¿è¡Œ ID çš„å­—å…¸åºï¼Œå­—å…¸åºå°çš„ä¼˜å…ˆã€‚

é€‰å‡ºæ–°ä¸»èŠ‚ç‚¹åï¼Œå“¨å…µä¼šå‘å…¶å‘é€ `SLAVEOF NO ONE` å‘½ä»¤å°†å…¶æå‡ä¸ºä¸»èŠ‚ç‚¹ã€‚

```c
// sentinel.cä¸­çš„sentinelFailoverPromoteSlaveå‡½æ•°
void sentinelFailoverPromoteSlave(sentinelRedisInstance *master) {
    // ... é€‰æ‹©æœ€ä½³ä»èŠ‚ç‚¹çš„é€»è¾‘ ...
    
    // å‘é€‰ä¸­çš„ä»èŠ‚ç‚¹å‘é€SLAVEOF NO ONEå‘½ä»¤ï¼Œä½¿å…¶æˆä¸ºä¸»èŠ‚ç‚¹
    retval = redisAsyncCommand(slave->link->cc,
        sentinelReceivePromotionResponseFromSlave, master,
        "SLAVEOF NO ONE");
        
    // æ›´æ–°çŠ¶æ€
    master->promoted_slave = slave;
    slave->flags |= SRI_PROMOTED;
    
    // è®°å½•æ—¥å¿—
    sentinelEvent(LL_WARNING, "+promoted-slave", slave, "%@");
    sentinelEvent(LL_WARNING, "+failover-state-wait-promotion", master, "%@");
}
```

ä¹‹åï¼Œå“¨å…µä¼šç­‰å¾…æ–°ä¸»èŠ‚ç‚¹çš„è§’è‰²è½¬æ¢å®Œæˆï¼Œé€šè¿‡å‘é€ INFO å‘½ä»¤æ£€æŸ¥å…¶è§’è‰²æ˜¯å¦å·²å˜ä¸º master æ¥ç¡®è®¤ã€‚ç¡®è®¤æˆåŠŸåï¼Œä¼šæ›´æ–°æ‰€æœ‰ä»èŠ‚ç‚¹çš„å¤åˆ¶ç›®æ ‡ï¼ŒæŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹ã€‚

```shell
SLAVEOF new-master-ip new-master-port
```

memoï¼š2025 å¹´ 5 æœˆ 13 æ—¥ï¼Œä»Šå¤©[æœ‰çƒå‹å‘å¾®ä¿¡](https://javabetter.cn/zhishixingqiu/)è¯´æ‹¿åˆ°äº†æºç¨‹çš„ offerï¼Œæºç¨‹ç°åœ¨ä¹Ÿæ˜¯ç¬¬äºŒæ¢¯é˜Ÿçš„äº’è”ç½‘å¤§å‚äº†ï¼Œå€¼å¾—ä¸€æ‰‹æ­å–œå•Šã€‚

![çƒå‹æ‹¿åˆ°äº†æºç¨‹çš„å®ä¹  offer](https://cdn.tobebetterjavaer.com/stutymore/redis-è¿™ä¸ç”¨é€‰ï¼Œè‚¯å®šæœ‰é™æºç¨‹å•Š.png)

### 24.Redisé›†ç¾¤äº†è§£å—ï¼Ÿ

ä¸»ä»å¤åˆ¶å®ç°äº†è¯»å†™åˆ†ç¦»å’Œæ•°æ®å¤‡ä»½ï¼Œå“¨å…µæœºåˆ¶å®ç°äº†ä¸»èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisé›†ç¾¤ç¤ºæ„å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5cbc6009-251e-4d5b-8f22-8d543938eccb.png)

é›†ç¾¤æ¶æ„æ˜¯å¯¹å‰ä¸¤ç§æ–¹æ¡ˆçš„è¿›ä¸€æ­¥æ‰©å±•å’Œå®Œå–„ï¼Œé€šè¿‡æ•°æ®åˆ†ç‰‡è§£å†³ Redis å•æœºå†…å­˜å¤§å°çš„é™åˆ¶ï¼Œå½“ç”¨æˆ·åŸºæ•°ä»ç™¾ä¸‡å¢é•¿åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼Œæˆ‘ä»¬åªéœ€ç®€å•åœ°å‘é›†ç¾¤ä¸­æ·»åŠ èŠ‚ç‚¹ï¼Œå°±èƒ½è½»æ¾åº”å¯¹ä¸æ–­å¢é•¿çš„æ•°æ®é‡å’Œè®¿é—®å‹åŠ›ã€‚

æ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥å°†å•å®ä¾‹æ¨¡å¼ä¸‹çš„æ•°æ®å¹³å‡åˆ†ä¸º 5 ä»½ï¼Œç„¶åå¯åŠ¨ 5 ä¸ª Redis å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹ä¿å­˜ 5G çš„æ•°æ®ï¼Œä»è€Œå®ç°é›†ç¾¤åŒ–ã€‚

![æå®¢æ—¶é—´ï¼šåˆ‡ç‰‡é›†ç¾¤æ¶æ„å›¾](https://cdn.tobebetterjavaer.com/stutymore/redis-20240408104101.png)

### 25.è¯·è¯¦ç»†è¯´ä¸€è¯´Redis Clusterï¼Ÿï¼ˆè¡¥å……ï¼‰

> 2024 å¹´ 04 æœˆ 26 æ—¥æ–°å¢

Redis Cluster æ˜¯ Redis å®˜æ–¹æä¾›çš„ä¸€ç§åˆ†å¸ƒå¼é›†ç¾¤è§£å†³æ–¹æ¡ˆã€‚å…¶æ ¸å¿ƒç†å¿µæ˜¯å»ä¸­å¿ƒåŒ–ï¼Œé‡‡ç”¨ P2P æ¨¡å¼ï¼Œæ²¡æœ‰ä¸­å¿ƒèŠ‚ç‚¹çš„æ¦‚å¿µã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ç€æ•°æ®å’Œæ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šè¿‡ gossip åè®®äº¤æ¢ä¿¡æ¯ã€‚

![Rajat Pachauriï¼šRedis Cluster](https://cdn.tobebetterjavaer.com/stutymore/redis-20250514144353.png)

åœ¨æ•°æ®åˆ†ç‰‡æ–¹é¢ï¼ŒRedis Cluster ä½¿ç”¨å“ˆå¸Œæ§½æœºåˆ¶å°†æ•´ä¸ªé›†ç¾¤åˆ’åˆ†ä¸º 16384 ä¸ªå•å…ƒã€‚

![aditya goelï¼šå“ˆå¸Œæ§½åˆ†ç‰‡](https://cdn.tobebetterjavaer.com/stutymore/redis-20250514150007.png)

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ 4 ä¸ª Redis å®ä¾‹ï¼Œé‚£ä¹ˆæ¯ä¸ªå®ä¾‹ä¼šè´Ÿè´£ 4000 å¤šä¸ªå“ˆå¸Œæ§½ã€‚

![Rajat Pachauriï¼šåˆ†ç‰‡ç»“æœ](https://cdn.tobebetterjavaer.com/stutymore/redis-20250514144913.png)

åœ¨è®¡ç®—å“ˆå¸Œæ§½ç¼–å·æ—¶ï¼ŒRedis Cluster ä¼šé€šè¿‡ CRC16 ç®—æ³•å…ˆè®¡ç®—å‡ºé”®çš„å“ˆå¸Œå€¼ï¼Œå†å¯¹è¿™ä¸ªå“ˆå¸Œå€¼è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ª 0 åˆ° 16383 ä¹‹é—´çš„æ•´æ•°ã€‚

```
slot = CRC16(key) mod 16384
```

è¿™ç§æ–¹å¼å¯ä»¥å°†æ•°æ®å‡åŒ€åœ°åˆ†å¸ƒåˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œé¿å…æ•°æ®å€¾æ–œçš„é—®é¢˜ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ§½](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e0ed9d62-3406-40db-8b01-c931f1020612.png)

å½“éœ€è¦å­˜å‚¨æˆ–æŸ¥è¯¢ä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼ŒRedis Cluster ä¼šå…ˆè®¡ç®—è¿™ä¸ªé”®çš„å“ˆå¸Œæ§½ç¼–å·ï¼Œç„¶åæ ¹æ®å“ˆå¸Œæ§½ç¼–å·æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚

æ¨èé˜…è¯»ï¼š[Redis Cluster](https://adityagoel123.medium.com/scalability-ha-with-redis-cluster-3d6499084550)

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis åˆ‡ç‰‡é›†ç¾¤ï¼Ÿæ•°æ®å’Œå®ä¾‹ä¹‹é—´çš„å¦‚ä½•è¿›è¡Œæ˜ å°„ï¼Ÿ
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 1 éƒ¨é—¨ä¸»ç«™æŠ€æœ¯éƒ¨é¢è¯•åŸé¢˜ï¼šRedis çš„ cluster é›†ç¾¤å¦‚ä½•å®ç°ï¼Ÿ

memoï¼š2025 å¹´ 5 æœˆ 14 æ—¥ï¼Œä»Šå¤©[æœ‰çƒå‹å‘å¾®ä¿¡](https://javabetter.cn/zhishixingqiu/)è¯´æ‹¿åˆ°äº†ç™¾åº¦å’Œç¾å›¢çš„æš‘æœŸå®ä¹  offerï¼Œæœç„¶äº”æœˆä¹Ÿæ˜¯ä¸€ä¸ªå¼€èŠ±ç»“æœçš„å­£èŠ‚ã€‚

![çƒå‹æ‹¿åˆ°äº†ç¾å›¢å’Œç™¾åº¦çš„æš‘æœŸå®ä¹  offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250514151059.png)


### 26.é›†ç¾¤ä¸­æ•°æ®å¦‚ä½•åˆ†åŒºï¼Ÿ

å¸¸è§çš„æ•°æ®åˆ†åŒºæœ‰ä¸‰ç§ï¼šèŠ‚ç‚¹å–ä½™ã€ä¸€è‡´æ€§å“ˆå¸Œå’Œå“ˆå¸Œæ§½ã€‚

èŠ‚ç‚¹å–ä½™åˆ†åŒºç®€å•æ˜äº†ï¼Œé€šè¿‡è®¡ç®—é”®çš„å“ˆå¸Œå€¼ï¼Œç„¶åå¯¹èŠ‚ç‚¹æ•°é‡å–ä½™ï¼Œç»“æœå°±æ˜¯ç›®æ ‡èŠ‚ç‚¹çš„ç´¢å¼•ã€‚

```
target_node = hash(key) % N  // Nä¸ºèŠ‚ç‚¹æ•°é‡
```

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šèŠ‚ç‚¹å–ä½™åˆ†åŒº](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-8b1fcaec-37e6-420a-9ca2-03615232af17.png)

ç¼ºç‚¹æ˜¯å¢åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹åï¼ŒèŠ‚ç‚¹æ•°é‡ä» N å˜ä¸º N+1ï¼Œå‡ ä¹æ‰€æœ‰çš„å–ä½™ç»“æœéƒ½ä¼šæ”¹å˜ï¼Œå¯¼è‡´å¤§éƒ¨åˆ†ç¼“å­˜å¤±æ•ˆã€‚

ä¸ºäº†è§£å†³èŠ‚ç‚¹å˜åŒ–å¯¼è‡´çš„å¤§è§„æ¨¡æ•°æ®è¿ç§»é—®é¢˜ï¼Œä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºå‡ºç°äº†ï¼šå®ƒå°†æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´æƒ³è±¡æˆä¸€ä¸ªç¯ï¼ŒèŠ‚ç‚¹å’Œæ•°æ®éƒ½æ˜ å°„åˆ°è¿™ä¸ªç¯ä¸Šã€‚æ•°æ®è¢«åˆ†é…åˆ°é¡ºæ—¶é’ˆæ–¹å‘ä¸Šé‡åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒº](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-89bd1c1c-251c-4f53-bba3-fe945b2ae9e2.png)

è¿™ç§è®¾è®¡çš„å·§å¦™ä¹‹å¤„åœ¨äºï¼Œå½“èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶ï¼Œåªæœ‰éƒ¨åˆ†æ•°æ®éœ€è¦é‡æ–°åˆ†é…ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬ä» 5 ä¸ªèŠ‚ç‚¹æ‰©å®¹åˆ° 8 ä¸ªèŠ‚ç‚¹ï¼Œç†è®ºä¸Šåªæœ‰çº¦ 3/8 çš„æ•°æ®éœ€è¦è¿ç§»ï¼Œå¤§å¤§å‡è½»äº†æ‰©å®¹æ—¶çš„ç³»ç»Ÿå‹åŠ›ã€‚

ä½†ä¸€è‡´æ€§å“ˆå¸Œä»ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæ•°æ®åˆ†å¸ƒä¸å‡åŒ€ã€‚æ¯”å¦‚è¯´åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒèŠ‚ç‚¹ 1 å’ŒèŠ‚ç‚¹ 2 çš„æ•°æ®é‡å·®ä¸å¤šï¼Œä½†èŠ‚ç‚¹ 3 çš„æ•°æ®é‡å´è¿œè¿œå°äºå®ƒä»¬ã€‚

Redis Cluster çš„å“ˆå¸Œæ§½åˆ†åŒºåœ¨ä¸€è‡´æ€§å“ˆå¸Œå’ŒèŠ‚ç‚¹å–ä½™çš„åŸºç¡€ä¸Šï¼Œåšäº†ä¸€äº›æ”¹è¿›ã€‚

![Dan Palmerï¼šå“ˆå¸Œæ§½](https://cdn.tobebetterjavaer.com/stutymore/redis-20250515104833.png)

å®ƒå°†æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´åˆ’åˆ†ä¸º 16384 ä¸ªæ§½ä½ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ï¼Œæ•°æ®é€šè¿‡ CRC16 ç®—æ³•è®¡ç®—åå¯¹ 16384 å–æ¨¡ï¼Œç¡®å®šå®ƒå±äºå“ªä¸ªæ§½ã€‚

```
slot = CRC16(key) % 16384
```

![Dan Palmerï¼šç¡®å®šæ§½](https://cdn.tobebetterjavaer.com/stutymore/redis-20250515104933.png)

å‡è®¾ç³»ç»Ÿä¸­æœ‰ 4 ä¸ªèŠ‚ç‚¹ï¼Œä¸ºå…¶åˆ†é…äº† 16 ä¸ªæ§½(0-15)ï¼›

- æ§½ 0-3 ä½äºèŠ‚ç‚¹ node1ï¼›
- æ§½ 4-7 ä½äºèŠ‚ç‚¹ node2ï¼›
- æ§½ 8-11 ä½äºèŠ‚ç‚¹ node3ï¼›
- æ§½ 12-15 ä½äºèŠ‚ç‚¹ node4ã€‚

å¦‚æœæ­¤æ—¶åˆ é™¤ `node2`ï¼Œåªéœ€è¦å°†æ§½ 4-7 é‡æ–°åˆ†é…å³å¯ï¼Œä¾‹å¦‚å°†æ§½ 4-5 åˆ†é…ç»™ `node1`ï¼Œæ§½ 6 åˆ†é…ç»™ `node3`ï¼Œæ§½ 7 åˆ†é…ç»™ `node4`ï¼Œæ•°æ®åœ¨èŠ‚ç‚¹ä¸Šçš„åˆ†å¸ƒä»ç„¶è¾ƒä¸ºå‡è¡¡ã€‚

å¦‚æœæ­¤æ—¶å¢åŠ  node5ï¼Œä¹Ÿåªéœ€è¦å°†ä¸€éƒ¨åˆ†æ§½åˆ†é…ç»™ node5 å³å¯ï¼Œæ¯”å¦‚è¯´å°†æ§½ 3ã€æ§½ 7ã€æ§½ 11ã€æ§½ 15 è¿ç§»ç»™ node5ï¼ŒèŠ‚ç‚¹ä¸Šçš„å…¶ä»–æ§½ä½ä¿ç•™ã€‚

å› ä¸ºæ§½çš„ä¸ªæ•°åˆšå¥½æ˜¯ 2 çš„ 14 æ¬¡æ–¹ï¼Œå’Œ HashMap ä¸­æ•°ç»„çš„é•¿åº¦å¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹æœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚å®ƒèƒ½ä¿è¯æ‰©å®¹åï¼Œå¤§éƒ¨åˆ†æ•°æ®åœç•™åœ¨æ‰©å®¹å‰çš„ä½ç½®ï¼Œåªæœ‰å°‘éƒ¨åˆ†æ•°æ®éœ€è¦è¿ç§»åˆ°æ–°çš„æ§½ä¸Šã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æš‘æœŸå®ä¹ åŒå­¦ E ä¸€é¢é¢è¯•åŸé¢˜ï¼šä½ çŸ¥é“ Redis çš„ä¸€è‡´æ€§ hash å—
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis æ‰©å®¹ä¹‹åï¼Œå“ˆå¸Œæ§½çš„ä½ç½®æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Ÿ
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 8 Java åç«¯å®ä¹ ä¸€é¢é¢è¯•åŸé¢˜ï¼šredis åˆ†ç‰‡é›†ç¾¤ï¼Œå¦‚ä½•åˆ†ç‰‡çš„ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„

memoï¼š2025 å¹´ 5 æœˆ 15 æ—¥ï¼Œä»Šå¤©[æœ‰çƒå‹å‘å¾®ä¿¡](https://javabetter.cn/zhishixingqiu/)è¯´åŠ äº†æ˜Ÿçƒåï¼Œç®—ä¸€ç®—ï¼Œè¸©ç€ç‚¹æ‹¿åˆ°äº†æ»´æ»´çš„å®ä¹  offerï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹æ—¶é—´çº¿ï¼Œä¹Ÿå°±ä¸€ä¸ªæœˆæ—¶é—´ä¸åˆ°ï¼ŒçœŸçš„å¤ªå¼ºäº†ã€‚

![çƒå‹æ‹¿åˆ°äº†æ»´æ»´çš„ offer](https://cdn.tobebetterjavaer.com/stutymore/redis-çœ‹çœ‹ï¼Œæ˜Ÿçƒç¼–å·æ˜¯.jpg)

### 27.èƒ½è¯´è¯´ Redis é›†ç¾¤çš„åŸç†å—ï¼Ÿ

Redis é›†ç¾¤çš„æ­å»ºå§‹äºèŠ‚ç‚¹çš„æ·»åŠ å’Œæ¡æ‰‹ã€‚æ¯ä¸ªèŠ‚ç‚¹é€šè¿‡è®¾ç½® `cluster-enabled yes` æ¥å¼€å¯é›†ç¾¤æ¨¡å¼ã€‚ç„¶åé€šè¿‡ `CLUSTER MEET` è¿›è¡Œæ¡æ‰‹ï¼Œå°†å¯¹æ–¹æ·»åŠ åˆ°å„è‡ªçš„èŠ‚ç‚¹åˆ—è¡¨ä¸­ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šèŠ‚ç‚¹å’Œæ¡æ‰‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e6064ba6-fd6f-4270-92f9-68c0bb98fd4b.png)

è¿™ä¸ªè¿‡ç¨‹è®¾è®¡çš„éå¸¸ç²¾å·§ï¼šèŠ‚ç‚¹ A å‘é€ MEET æ¶ˆæ¯ï¼ŒèŠ‚ç‚¹ B å›å¤ PONG å¹¶å‘é€ PINGï¼ŒèŠ‚ç‚¹ A å›å¤ PONGï¼Œäºæ˜¯åŒå‘çš„é€šä¿¡é“¾è·¯å°±å»ºç«‹å®Œæˆäº†ã€‚

![happenï¼šcluster meet](https://cdn.tobebetterjavaer.com/stutymore/redis-20250516093632.png)

æœ‰è¶£çš„æ˜¯ï¼Œç”±äºé‡‡ç”¨äº† Gossip åè®®ï¼Œæˆ‘ä»¬ä¸éœ€è¦è®©æ¯å¯¹èŠ‚ç‚¹éƒ½æ‰§è¡Œæ¡æ‰‹ã€‚åœ¨ä¸€ä¸ªå¤šèŠ‚ç‚¹é›†ç¾¤çš„éƒ¨ç½²ä¸­ï¼Œä»…éœ€è¦è®©ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸å…¶ä»–èŠ‚ç‚¹æ¡æ‰‹ï¼Œå…¶ä½™èŠ‚ç‚¹å°±èƒ½é€šè¿‡ä¿¡æ¯ä¼ æ’­è‡ªåŠ¨å‘ç°å¹¶è¿æ¥å½¼æ­¤ã€‚

![ç¨‹åºå‘˜å†å°å†°ï¼šGossip](https://cdn.tobebetterjavaer.com/stutymore/redis-20250516093948.png)

æ¡æ‰‹å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ `CLUSTER ADDSLOTS` å‘½ä»¤ä¸ºä¸»èŠ‚ç‚¹åˆ†é…å“ˆå¸Œæ§½ã€‚å½“ 16384 ä¸ªæ§½å…¨éƒ¨åˆ†é…å®Œæ¯•ï¼Œé›†ç¾¤æ­£å¼è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šåˆ†é…æ§½](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-15341792-e7a6-428c-a109-22827e02be5f.png)

æ•…éšœæ£€æµ‹å’Œæ¢å¤æ˜¯ä¿éšœ Redis é›†ç¾¤é«˜å¯ç”¨çš„å…³é”®ã€‚æ¯ç§’é’Ÿï¼ŒèŠ‚ç‚¹ä¼šå‘ä¸€å®šæ•°é‡çš„éšæœºèŠ‚ç‚¹å‘é€ PING æ¶ˆæ¯ï¼Œå½“å‘ç°æŸä¸ªèŠ‚ç‚¹é•¿æ—¶é—´æœªå“åº” PING æ¶ˆæ¯ï¼Œå°±ä¼šå°†å…¶æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸»è§‚ä¸‹çº¿](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-84a2a89e-f9ea-4681-b748-1a4f1dee172b.png)

å½“åŠæ•°ä»¥ä¸Šçš„ä¸»èŠ‚ç‚¹éƒ½è®¤ä¸ºæŸèŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿æ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¢«æ ‡è®°ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b61a6109-7aea-45ab-a53c-267eebb9180a.png)

å¦‚æœä¸‹çº¿çš„æ˜¯ä¸»èŠ‚ç‚¹ï¼Œå®ƒçš„ä»èŠ‚ç‚¹ä¹‹ä¸€å°†è¢«é€‰ä¸¾ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œæ¥ç®¡åŸä¸»èŠ‚ç‚¹è´Ÿè´£çš„å“ˆå¸Œæ§½ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé€‰ä¸¾æŠ•ç¥¨](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d0e16ea3-6683-43f4-82a3-80478703ae06.png)


#### éƒ¨ç½² Redis é›†ç¾¤è‡³å°‘éœ€è¦å‡ ä¸ªç‰©ç†èŠ‚ç‚¹ï¼Ÿ

éƒ¨ç½²ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒå¯ç”¨çš„ Redis é›†ç¾¤ï¼Œä»æŠ€æœ¯è§’åº¦æ¥è¯´ï¼Œè‡³å°‘éœ€è¦ 3 ä¸ªç‰©ç†èŠ‚ç‚¹ã€‚

è¿™ä¸ªæœ€å°èŠ‚ç‚¹æ•°çš„è®¾å®šå¹¶é Redis æŠ€æœ¯ä¸Šçš„ç¡¬æ€§è¦æ±‚ï¼Œè€Œæ˜¯åŸºäºé«˜å¯ç”¨åŸåˆ™çš„å®è·µè€ƒé‡ã€‚

ä»å®è·µè§’åº¦çœ‹ï¼Œæœ€ç»å…¸çš„ Redis é›†ç¾¤é…ç½®æ˜¯ 3 ä¸» 3 ä»ï¼Œå…± 6 ä¸ª Redis å®ä¾‹ã€‚è€ƒè™‘åˆ°éœ€è¦ 3 ä¸ªä¸»èŠ‚ç‚¹å’Œ 3 ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯å¯¹ä¸»ä»ä¸èƒ½åœ¨åŒä¸€ç‰©ç†æœºä¸Šï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦ 3 ä¸ªç‰©ç†èŠ‚ç‚¹ï¼Œæ¯ä¸ªç‰©ç†èŠ‚ç‚¹ä¸Šè¿è¡Œ 1 ä¸ªä¸»èŠ‚ç‚¹å’Œå¦ä¸€ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚

- ç‰©ç†èŠ‚ç‚¹1ï¼šä¸»èŠ‚ç‚¹A + ä»èŠ‚ç‚¹B'
- ç‰©ç†èŠ‚ç‚¹2ï¼šä¸»èŠ‚ç‚¹B + ä»èŠ‚ç‚¹C'
- ç‰©ç†èŠ‚ç‚¹3ï¼šä¸»èŠ‚ç‚¹C + ä»èŠ‚ç‚¹A'

è¿™ç§äº¤é”™éƒ¨ç½²æ–¹å¼å¯ä»¥ç¡®ä¿ä»»ä½•ä¸€ä¸ªç‰©ç†èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œæœ€å¤šåªå½±å“ä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œä¸€ä¸ªä¸åŒä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚

memoï¼š2025 å¹´ 5 æœˆ 16 æ—¥ï¼Œä»Šå¤©åœ¨[ä¿®æ”¹ç®€å†](https://javabetter.cn/zhishixingqiu/jianli.html)çš„æ—¶å€™ï¼Œç¢°åˆ°ä¸€ä¸ªæ²³å—ç†å·¥æœ¬ç§‘ï¼Œéƒ‘å·å¤§å­¦ç¡•å£«çš„çƒå‹ï¼Œä¹Ÿæ˜¯å¸Œæœ›è¿™ä¸ªç¤¾ç¾¤èƒ½å¤Ÿå¸®åŠ©åˆ°æ›´å¤šçš„åŒå­¦ï¼Œæ— è®ºæ¥è‡ªå“ªé‡Œï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾å›é‚£ä¸ªæ¸´æœ›è¿›æ­¥ï¼Œæ¸´æœ›æ‹¿åˆ°ä¼˜è´¨ offer çš„è‡ªå·±ã€‚

![æ²³å—ç†å·¥å¤§å­¦æœ¬ã€éƒ‘å·å¤§å­¦ç¡•çš„çƒå‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250516100305.png)

### 28.è¯´è¯´Redisé›†ç¾¤çš„åŠ¨æ€ä¼¸ç¼©ï¼Ÿ

Redis é›†ç¾¤åŠ¨æ€ä¼¸ç¼©çš„æ ¸å¿ƒæœºåˆ¶æ˜¯é€šè¿‡é‡æ–°åˆ†é…å“ˆå¸Œæ§½å®ç°çš„ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé›†ç¾¤çš„ä¼¸ç¼©](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-dd3e9494-eddb-4861-85f7-2646018d93f6.png)

å½“éœ€è¦æ‰©å®¹æ—¶ï¼Œé¦–å…ˆé€šè¿‡ `CLUSTER MEET` å‘½ä»¤å°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼›ç„¶åä½¿ç”¨ reshard å‘½ä»¤å°†éƒ¨åˆ†å“ˆå¸Œæ§½é‡æ–°åˆ†é…ç»™æ–°èŠ‚ç‚¹ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ‰©å®¹å®ä¾‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-1d24bb63-2b05-4db9-bd6b-983f16a4830e.png)

----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒstart----

å‡†å¤‡æ–°çš„èŠ‚ç‚¹ï¼š

```shell
# redis.conf
port 6382
cluster-enabled yes
cluster-config-file nodes-6382.conf
cluster-node-timeout 5000
appendonly yes
```

ç„¶åå¯åŠ¨æ–°çš„èŠ‚ç‚¹ï¼š

```shell
redis-server /path/to/redis-6382.conf
```

æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ `CLUSTER MEET` å‘½ä»¤å°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼š

```shell
redis-cli -p 6379 cluster meet 127.0.0.1 6382
```

æ£€æŸ¥æ–°èŠ‚ç‚¹æ˜¯å¦åŠ å…¥ï¼š

```shell
redis-cli -p 6379 cluster nodes
```

ç„¶åï¼Œé‡æ–°åˆ†é…å“ˆå¸Œæ§½ï¼š

```shell
redis-cli --cluster reshard 127.0.0.1:6379
```

åœ¨æç¤ºä¸­è¾“å…¥è¦è¿ç§»çš„å“ˆå¸Œæ§½èŒƒå›´ã€‚

```text
# è¾“å…¥è¦è¿ç§»çš„æ§½æ•°é‡ï¼Œæ¯”å¦‚ 4096ï¼ˆå¹³å‡åˆ†é…çš„è¯ï¼Œ16384/4=4096ï¼‰ã€‚
How many slots do you want to move (from 16384 total slots)? 4096
# è¾“å…¥ 6382 èŠ‚ç‚¹çš„ IDï¼ˆå¯é€šè¿‡ cluster nodes å‘½ä»¤æŸ¥åˆ°ï¼‰ã€‚
What is the receiving node ID? <6382çš„èŠ‚ç‚¹ID>
# è¾“å…¥ allï¼ˆè¡¨ç¤ºä»æ‰€æœ‰èŠ‚ç‚¹å¹³å‡è¿ç§»ï¼‰ã€‚
Source node IDs? all
# è¾“å…¥ yesï¼ˆè¡¨ç¤ºç¡®è®¤è¿ç§»ï¼‰ã€‚
Do you want to proceed with the proposed reshard plan (yes/no)? yes
```

æ£€æŸ¥æ£€æŸ¥æ§½åˆ†é…æƒ…å†µï¼š

```shell
redis-cli -p 6379 cluster slots
```

éªŒè¯é›†ç¾¤çš„çŠ¶æ€ï¼š

```shell
redis-cli -p 6382 cluster info
```

ä¹Ÿå¯ä»¥ç›´æ¥ä¸€æ­¥åˆ°ä½ï¼š

```shell
redis-cli --cluster reshard 127.0.0.1:6379 --cluster-from all --cluster-to <6382çš„èŠ‚ç‚¹ID> --cluster-slots 4096 --cluster-yes
```

----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒend----

ç¼©å®¹åˆ™æ˜¯åå‘æ“ä½œï¼šå…ˆå°†è¦ä¸‹çº¿èŠ‚ç‚¹è´Ÿè´£çš„æ‰€æœ‰æ§½è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œå†é€šè¿‡ `CLUSTER FORGET` å‘½ä»¤å°†èŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤ã€‚

æ•´ä¸ªä¼¸ç¼©è¿‡ç¨‹æ”¯æŒåœ¨çº¿æ“ä½œï¼Œæ— éœ€åœæœºï¼Œå¾—ç›Šäº Redis é›†ç¾¤çš„ MOVED å’Œ ASK é‡å®šå‘æœºåˆ¶ã€‚å½“å®¢æˆ·ç«¯è®¿é—®çš„é”®ä¸åœ¨å½“å‰èŠ‚ç‚¹æ—¶ï¼Œä¼šæ”¶åˆ°é‡å®šå‘å“åº”ï¼ŒæŒ‡å¼•å®ƒè¿æ¥åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ã€‚

#### MOVED å’Œ ASK é‡å®šå‘çš„åŒºåˆ«ï¼Ÿ

MOVED é‡å®šå‘åæ˜ çš„æ˜¯å“ˆå¸Œæ§½çš„æ°¸ä¹…æ€§å˜æ›´ã€‚å½“å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªé”®ï¼Œä½†é”®æ‰€åœ¨çš„æ§½ä¸åœ¨å½“å‰èŠ‚ç‚¹æ—¶ï¼ŒèŠ‚ç‚¹ä¼šè¿”å› MOVED å“åº”ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯è¿™ä¸ªæ§½ç°åœ¨å½’å±äºå“ªä¸ªèŠ‚ç‚¹ã€‚é€šå¸¸å‘ç”Ÿåœ¨é›†ç¾¤å®Œæˆé‡æ–°åˆ†ç‰‡åï¼Œæ§½çš„åˆ†é…å…³ç³»å·²ç»ç¨³å®šã€‚

![Aaron Zhuï¼šMOVED é‡å®šå‘](https://cdn.tobebetterjavaer.com/stutymore/redis-20250517100408.png)

æ¯”å¦‚è¯´æŸä¸ªæ§½ä»èŠ‚ç‚¹ A ç§»åŠ¨åˆ°èŠ‚ç‚¹ B åï¼Œå¦‚æœå®¢æˆ·ç«¯ä»å‘èŠ‚ç‚¹ A è¯·æ±‚è¯¥æ§½ä¸­çš„é”®ï¼Œä¼šæ”¶åˆ° MOVED å“åº”ï¼Œæç¤ºåº”è¯¥è¿æ¥èŠ‚ç‚¹ Bã€‚

ASK é‡å®šå‘å‡ºç°åœ¨æ§½è¿ç§»è¿‡ç¨‹ä¸­ï¼Œè¡¨ç¤ºè¯·æ±‚çš„é”®å¯èƒ½å·²ç»ä»æºèŠ‚ç‚¹è¿ç§»åˆ°äº†ç›®æ ‡èŠ‚ç‚¹ï¼Œä½†è¿ç§»å°šæœªå®Œæˆã€‚

![Aaron Zhuï¼šASK é‡å®šå‘](https://cdn.tobebetterjavaer.com/stutymore/redis-20250517100517.png)


<MZNXQRcodeBanner/>

memoï¼š2025 å¹´ 5 æœˆ 17 æ—¥ï¼Œä»Šå¤©[æœ‰çƒå‹å‘å¾®ä¿¡](https://javabetter.cn/zhishixingqiu/)è¯´æ‹¿åˆ°äº†ä¸€ä¸ªå›½ä¼å­å…¬å¸çš„ Java åç«¯å¼€å‘å’Œä¸€ä¸ªå°ç±³å®‰å“çš„ offerï¼Œé—®æˆ‘è¯¥æ€ä¹ˆé€‰æ‹©ï¼Ÿ

![çƒå‹æ‹¿åˆ°äº†ä¸€ä¸ªå›½ä¼å­å…¬å¸å’Œå°ç±³çš„ offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250517101545.png)

## ç¼“å­˜è®¾è®¡

### ğŸŒŸ29.ä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿ

ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡æŸä¸ªçƒ­ç‚¹æ•°æ®ç¼“å­˜è¿‡æœŸæ—¶ï¼Œå¤§é‡è¯·æ±‚å°±ä¼šç©¿é€ç¼“å­˜ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“ç¬é—´æ‰¿å—çš„å‹åŠ›å·¨å¤§ã€‚

![fengkui.netï¼šç¼“å­˜å‡»ç©¿](https://cdn.tobebetterjavaer.com/stutymore/redis-20250518092219.png)

è§£å†³ç¼“å­˜å‡»ç©¿æœ‰ä¸¤ç§å¸¸ç”¨çš„ç­–ç•¥ï¼š

ç¬¬ä¸€ç§æ˜¯åŠ äº’æ–¥é”ã€‚å½“ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œç¬¬ä¸€ä¸ªè®¿é—®çš„çº¿ç¨‹å…ˆè·å–é”å¹¶è´Ÿè´£é‡å»ºç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…æˆ–é‡è¯•ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šåŠ é”æ›´æ–°](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-cf63911a-8501-493e-a375-8b47a9f33358.png)

è¿™ç§ç­–ç•¥è™½ç„¶ä¼šå¯¼è‡´éƒ¨åˆ†è¯·æ±‚å»¶è¿Ÿï¼Œä½†å®ç°èµ·æ¥ç›¸å¯¹ç®€å•ã€‚åœ¨[æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®](https://javabetter.cn/zhishixingqiu/paicoding.html)ä¸­ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨äº† Redisson çš„åˆ†å¸ƒå¼é”æ¥ç¡®ä¿åªæœ‰ä¸€ä¸ªæœåŠ¡å®ä¾‹èƒ½æ›´æ–°ç¼“å­˜ã€‚

```java
String cacheKey = "product::" + productId;
RLock lock = redissonClient.getLock("lock::" + productId);
if (lock.tryLock(10, TimeUnit.SECONDS)) {
    try {
        String result = cache.get(cacheKey);
        if (result == null) {
            result = database.queryProductById(productId);
            cache.set(cacheKey, result, 60 * 1000); // è®¾ç½®ç¼“å­˜
        }
    } finally {
        lock.unlock();
    }
}
```

ç¬¬äºŒç§æ˜¯æ°¸ä¸è¿‡æœŸç­–ç•¥ã€‚ç¼“å­˜é¡¹æœ¬èº«ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯æ°¸ä¸è¿‡æœŸï¼Œä½†åœ¨ç¼“å­˜å€¼ä¸­ç»´æŠ¤ä¸€ä¸ªé€»è¾‘è¿‡æœŸæ—¶é—´ã€‚å½“ç¼“å­˜é€»è¾‘ä¸Šè¿‡æœŸæ—¶ï¼Œè¿”å›æ—§å€¼çš„åŒæ—¶ï¼Œå¼‚æ­¥å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ›´æ–°ç¼“å­˜ã€‚

```java
public String getData(String key) {
    CacheItem item = cache.get(key);
    
    if (item == null) {
        // ç¼“å­˜ä¸å­˜åœ¨ï¼ŒåŒæ­¥åŠ è½½
        String data = db.query(key);
        cache.set(key, new CacheItem(data, System.currentTimeMillis() + expireTime));
        return data;
    } else if (item.isLogicalExpired()) {
        // é€»è¾‘è¿‡æœŸï¼Œå¼‚æ­¥åˆ·æ–°
        asyncRefresh(key);
        // è¿”å›æ—§æ•°æ®
        return item.getData();
    }
    
    return item.getData();
}

// å¼‚æ­¥åˆ·æ–°ç¼“å­˜
private void asyncRefresh(final String key) {
    threadPool.execute(() -> {
        // é‡æ–°æŸ¥è¯¢æ•°æ®åº“
        String newData = db.query(key);
        // æ›´æ–°ç¼“å­˜
        cache.set(key, new CacheItem(newData, System.currentTimeMillis() + expireTime));
    });
}
```

memoï¼š2025 å¹´ 5 æœˆ 18 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©ç»™[çƒå‹æ”¹ç®€å†æ—¶](https://javabetter.cn/zhishixingqiu/)ï¼Œç¢°åˆ°ä¸€ä¸ªè¥¿åŒ—å·¥ä¸šå¤§å­¦çš„çƒå‹ï¼Œè¿™åˆæ˜¯ä¸€æ‰€ 985 é™¢æ ¡ï¼Œå¸Œæœ›è¿™ä¸ªç¤¾ç¾¤èƒ½æŠŠæ‰€æœ‰çš„ 985 é™¢æ ¡é›†é½ï¼Œä¹Ÿå¸Œæœ›å»å¸®åŠ©åˆ°æ›´å¤šé™¢æ ¡çš„åŒå­¦ï¼Œå¸Œæœ›å¤§å®¶éƒ½èƒ½æ‹¿åˆ°ä¸€ä¸ªæ»¡æ„çš„ offerã€‚

![è¥¿åŒ—å·¥ä¸šå¤§å­¦çš„çƒå‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250518093130.png)

#### ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿ

ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢çš„æ•°æ®åœ¨ç¼“å­˜ä¸­æ²¡æœ‰å‘½ä¸­ï¼Œå› ä¸ºæ•°æ®å‹æ ¹ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è¯·æ±‚ä¼šç›´æ¥è½åˆ°æ•°æ®åº“ä¸Šã€‚å¦‚æœè¿™ç§æŸ¥è¯¢éå¸¸é¢‘ç¹ï¼Œå°±ä¼šç»™æ•°æ®åº“é€ æˆå¾ˆå¤§çš„å‹åŠ›ã€‚

![fengkui.netï¼šç¼“å­˜ç©¿é€](https://cdn.tobebetterjavaer.com/stutymore/redis-20250519082725.png)

ç¼“å­˜å‡»ç©¿æ˜¯å› ä¸ºå•ä¸ªçƒ­ç‚¹æ•°æ®ç¼“å­˜å¤±æ•ˆå¯¼è‡´çš„ï¼Œè€Œç¼“å­˜ç©¿é€æ˜¯å› ä¸ºæŸ¥è¯¢çš„æ•°æ®ä¸å­˜åœ¨ï¼ŒåŸå› å¯èƒ½æ˜¯è‡ªèº«çš„ä¸šåŠ¡ä»£ç æœ‰é—®é¢˜ï¼Œæˆ–è€…æ˜¯æ¶æ„æ”»å‡»é€ æˆçš„ï¼Œæ¯”å¦‚çˆ¬è™«ã€‚

å¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼šç¬¬ä¸€ç§æ˜¯å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®ƒæ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡å¾ˆé«˜çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ã€‚

æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼ŒæŸ¥è¯¢æ—¶å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è®¤ä¸ºè¯¥æ•°æ®ä¸å­˜åœ¨ï¼Œå°±ç›´æ¥è¿”å›ç©ºï¼›å¦åˆ™å†å»æŸ¥è¯¢ç¼“å­˜ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ— æ•ˆçš„ç¼“å­˜æŸ¥è¯¢ã€‚

![é…’å‰‘ä»™ï¼šå¸ƒéš†è¿‡æ»¤å™¨è§£å†³ç¼“å­˜ç©¿é€](https://cdn.tobebetterjavaer.com/stutymore/redis-20250519085312.png)

ä»£ç ç¤ºä¾‹ï¼š

```java
public String getData(String key) {
    // ç¼“å­˜ä¸­ä¸å­˜åœ¨è¯¥key
    String cacheResult = cache.get(key);
    if (cacheResult != null) {
        return cacheResult;
    }
    
    // å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­keyæ˜¯å¦å¯èƒ½å­˜åœ¨
    if (!bloomFilter.mightContain(key)) {
        return null; // ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
    }
    
    // å¯èƒ½å­˜åœ¨ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    String dbResult = db.query(key);
    
    // å°†ç»“æœæ”¾å…¥ç¼“å­˜ï¼ŒåŒ…æ‹¬ç©ºå€¼
    cache.set(key, dbResult != null ? dbResult : "", expireTime);
    
    return dbResult;
}
```

å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤ï¼Œå³å¯èƒ½ä¼šè®¤ä¸ºæŸä¸ªæ•°æ®å­˜åœ¨ï¼Œä½†å®é™…ä¸Šå¹¶ä¸å­˜åœ¨ã€‚ä½†ç»ä¸ä¼šæ¼åˆ¤ï¼Œå³å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è®¤ä¸ºæŸä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œé‚£å®ƒä¸€å®šä¸å­˜åœ¨ã€‚å› æ­¤å®ƒå¯ä»¥æœ‰æ•ˆæ‹¦æˆªä¸å­˜åœ¨çš„æ•°æ®æŸ¥è¯¢ï¼Œå‡è½»æ•°æ®åº“å‹åŠ›ã€‚

ç¬¬äºŒç§æ˜¯ç¼“å­˜ç©ºå€¼ã€‚å¯¹äºä¸å­˜åœ¨çš„æ•°æ®ï¼Œæˆ‘ä»¬å°†ç©ºå€¼å†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ã€‚è¿™æ ·ä¸‹æ¬¡ç›¸åŒçš„æŸ¥è¯¢å°±èƒ½ç›´æ¥ä»ç¼“å­˜è¿”å›ï¼Œè€Œä¸å†è®¿é—®æ•°æ®åº“ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šç¼“å­˜ç©ºå€¼/é»˜è®¤å€¼](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-288af5a2-ae5a-427a-95e9-b4a658b01386.png)

ä»£ç ç¤ºä¾‹ï¼š

```java
public String getData(String key) {
    String cacheResult = cache.get(key);
    
    // ç¼“å­˜å‘½ä¸­ï¼ŒåŒ…æ‹¬ç©ºå€¼
    if (cacheResult != null) {
        // ç‰¹æ®Šå€¼è¡¨ç¤ºç©ºç»“æœ
        if (cacheResult.equals("")) {
            return null;
        }
        return cacheResult;
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    String dbResult = db.query(key);
    
    // å†™å…¥ç¼“å­˜ï¼Œç©ºå€¼ä¹Ÿç¼“å­˜ï¼Œä½†è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´
    int expireTime = dbResult == null ? EMPTY_EXPIRE_TIME : NORMAL_EXPIRE_TIME;
    cache.set(key, dbResult != null ? dbResult : "", expireTime);
    
    return dbResult;
}
```

ç¼“å­˜ç©ºå€¼çš„æ–¹æ³•å®ç°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†éœ€è¦ç»™ç©ºå€¼è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œä»¥å…æ•°æ®åº“ä¸­æ–°å¢äº†è¿™äº›æ•°æ®åï¼Œç¼“å­˜ä»ç„¶è¿”å›ç©ºå€¼ã€‚

åœ¨å®é™…çš„é¡¹ç›®å½“ä¸­ï¼Œè¿˜éœ€è¦åœ¨æ¥å£å±‚é¢åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚è¯´å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒï¼Œæ‹¦æˆªæ˜æ˜¾ä¸åˆç†çš„è¯·æ±‚ï¼›æˆ–è€…å¯¹ç–‘ä¼¼æ”»å‡»çš„ IP è¿›è¡Œé™æµå’Œå°ç¦ã€‚

memoï¼š2025 å¹´ 5 æœˆ 19 æ—¥ï¼Œä»Šå¤©[æœ‰çƒå‹å‘å¾®ä¿¡](https://javabetterjavaer.com/zhishixingqiu/)è¯´æ‹¿åˆ°äº†æ»´æ»´çš„æµ‹å¼€å®ä¹  offerï¼Œç›®å‰è¿˜æƒ³ç»§ç»­æ‰¾ï¼Œé—®æˆ‘è¯¥ç»§ç»­å­¦ç‚¹ä»€ä¹ˆï¼Œæˆ‘çš„å›å¤è¯´ï¼Œæš‘æœŸèƒ½æ‹¿åˆ° offerï¼Œç§‹æ‹›ç»§ç»­å°±è¡Œäº†ï¼ŒåŠ ä¸Šæ»´æ»´çš„å®ä¹ ç»å†å°±å¾ˆç¡¬æ ¸äº†ã€‚å¤§å®¶åœ¨å‡†å¤‡æš‘æœŸå’Œç§‹æ‹›çš„æ—¶å€™ï¼Œä¹Ÿä¸è¦å¤ªç„¦è™‘ï¼Œä¿æŒä¸€ä¸ªå¥½çš„å­¦ä¹ ä¹ æƒ¯ï¼Œç§‹æ‹›æ²¡é—®é¢˜çš„ã€‚

![æ»´æ»´çš„æµ‹å¼€offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250520092547.png)

#### ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ

ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨æŸä¸€æ—¶é—´æ®µï¼Œå¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆæˆ–è€…ç¼“å­˜æœåŠ¡çªç„¶å®•æœºäº†ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚ç›´æ¥æ¶Œå‘æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›å‰§å¢ï¼Œç”šè‡³å¼•å‘ç³»ç»Ÿå´©æºƒçš„ç°è±¡ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šç¼“å­˜é›ªå´©](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-1464fe22-c463-4850-8989-b899510cb10e.png)

ç¼“å­˜å‡»ç©¿æ˜¯å•ä¸ªçƒ­ç‚¹æ•°æ®å¤±æ•ˆå¯¼è‡´çš„ï¼Œç¼“å­˜ç©¿é€æ˜¯å› ä¸ºè¯·æ±‚ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè€Œç¼“å­˜é›ªå´©æ˜¯å› ä¸ºå¤§èŒƒå›´çš„ç¼“å­˜å¤±æ•ˆã€‚

ç¼“å­˜é›ªå´©ä¸»è¦æœ‰ä¸‰ç§æˆå› å’Œåº”å¯¹ç­–ç•¥ã€‚

ç¬¬ä¸€ç§ï¼Œå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œè§£å†³æ–¹æ³•æ˜¯æ·»åŠ éšæœºè¿‡æœŸæ—¶é—´ã€‚

```java
public void setCache(String key, String value) {
    // åŸºç¡€è¿‡æœŸæ—¶é—´ï¼Œä¾‹å¦‚30åˆ†é’Ÿ
    int baseExpireSeconds = 1800;
    // å¢åŠ éšæœºè¿‡æœŸæ—¶é—´ï¼ŒèŒƒå›´0-300ç§’
    int randomSeconds = new Random().nextInt(300);
    // æœ€ç»ˆè¿‡æœŸæ—¶é—´ä¸ºåŸºç¡€æ—¶é—´åŠ éšæœºæ—¶é—´
    cache.set(key, value, baseExpireSeconds + randomSeconds);
}
```

ç¬¬äºŒç§ï¼Œç¼“å­˜æœåŠ¡å´©æºƒï¼Œè§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨é«˜å¯ç”¨çš„ç¼“å­˜é›†ç¾¤ã€‚

æ¯”å¦‚è¯´ä½¿ç”¨ Redis Cluster æ„å»ºå¤šèŠ‚ç‚¹é›†ç¾¤ï¼Œç¡®ä¿æ•°æ®åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šæœ‰å¤‡ä»½ï¼Œå¹¶ä¸”æ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚

![Rajat Pachauriï¼šRedis Cluster](https://cdn.tobebetterjavaer.com/stutymore/redis-20240326220634.png)

å¯¹äºä¸€äº›é«˜é¢‘å…³é”®æ•°æ®ï¼Œå¯ä»¥é…ç½®æœ¬åœ°ç¼“å­˜ä½œä¸ºäºŒçº§ç¼“å­˜ï¼Œç¼“è§£ Redis çš„å‹åŠ›ã€‚åœ¨[æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®](https://javabetter.cn/zhishixingqiu/paicoding.html)ä¸­ï¼Œæˆ‘ä»¬å°±é‡‡ç”¨äº†å¤šçº§ç¼“å­˜çš„ç­–ç•¥ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ä½¿ç”¨æœ¬åœ°ç¼“å­˜ Caffeine æ¥ä½œä¸ºäºŒçº§ç¼“å­˜ï¼Œå½“ Redis å‡ºç°é—®é¢˜æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°ç¼“å­˜ã€‚

![æŠ€æœ¯æ´¾æ•™ç¨‹ï¼šCaffeineæœ¬åœ°ç¼“å­˜](https://cdn.tobebetterjavaer.com/stutymore/redis-20240421105333.png)

è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºâ€œç¼“å­˜é™çº§â€ï¼Œä¿è¯ Redis å‘ç”Ÿæ•…éšœæ—¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿç»§ç»­æä¾›æœåŠ¡ã€‚

```java
LoadingCache<String, UserPermissions> permissionsCache = Caffeine.newBuilder()
    .maximumSize(1000)
    .expireAfterWrite(10, TimeUnit.MINUTES)
    .build(this::loadPermissionsFromRedis);

public UserPermissions loadPermissionsFromRedis(String userId) {
    try {
        return redisClient.getPermissions(userId);
    } catch (Exception ex) {
        // Redis å¼‚å¸¸å¤„ç†ï¼Œå°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–
        return permissionsCache.getIfPresent(userId);
    }
}
```

ç¬¬ä¸‰ç§ï¼Œç¼“å­˜æœåŠ¡æ­£å¸¸ä½†å¹¶å‘è¯·æ±‚é‡è¶…è¿‡äº†ç¼“å­˜æœåŠ¡çš„æ‰¿è½½èƒ½åŠ›ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥é‡‡ç”¨é™æµå’Œé™çº§æªæ–½ã€‚

```java
public String getData(String key) {
    try {
        // å°è¯•ä»ç¼“å­˜è·å–æ•°æ®
        return cache.get(key);
    } catch (Exception e) {
        // ç¼“å­˜æœåŠ¡å¼‚å¸¸ï¼Œè§¦å‘ç†”æ–­
        if (circuitBreaker.shouldTrip()) {
            // ç›´æ¥ä»æ•°æ®åº“è·å–ï¼Œå¹¶è¿›å…¥é™çº§æ¨¡å¼
            circuitBreaker.trip();
            return getFromDbDirectly(key);
        }
        throw e;
    }
}

private String getFromDbDirectly(String key) {
    // å®æ–½é™æµä¿æŠ¤
    if (!rateLimit.tryAcquire()) {
        // è¶…è¿‡é™æµé˜ˆå€¼ï¼Œè¿”å›å…œåº•æ•°æ®æˆ–é»˜è®¤å€¼
        return getDefaultValue(key);
    }
    
    // é™æµé€šè¿‡ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
    return db.query(key);
}
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 22 æš‘æœŸå®ä¹ ä¸€é¢é¢è¯•åŸé¢˜ï¼šç¼“å­˜é›ªå´©ï¼Œå¦‚ä½•è§£å†³
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 7 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´ä¸€ä¸‹ ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šRedis å®•æœºä¼šä¸ä¼šå¯¹æƒé™ç³»ç»Ÿæœ‰å½±å“ï¼Ÿ
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šè¯´ä¸€ä¸‹ Redis é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ç­‰åœºæ™¯çš„è§£å†³æ–¹æ¡ˆ
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³åŒå­¦ F é¢è¯•åŸé¢˜ï¼šç¼“å­˜å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼ˆå¼•ç”³åˆ°å¤šçº§ç¼“å­˜ï¼‰ï¼Œå¤šçº§ç¼“å­˜ï¼ˆredisï¼Œnginxï¼Œæœ¬åœ°ç¼“å­˜ï¼‰çš„å®ç°æ€è·¯
> 6. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„TPè”æ´²åŒå­¦ 5 Java åç«¯ä¸€é¢çš„åŸé¢˜ï¼šå¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€
> 7. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç†æƒ³æ±½è½¦é¢ç»åŒå­¦ 2 ä¸€é¢é¢è¯•åŸé¢˜ï¼šå¦‚ä½•ç†è§£ç¼“å­˜é›ªå´©ã€ç¼“å­˜å‡»ç©¿å’Œç¼“å­˜ç©¿é€ï¼Ÿ

memoï¼š2025 å¹´ 5 æœˆ 20 æ—¥ï¼Œä»Šå¤©[æœ‰çƒå‹å‘å¾®ä¿¡](https://javabetter.cn/zhishixingqiu/)è¯´é¡¹ç›®ç”¨çš„æŠ€æœ¯æ´¾ï¼Œå…«è‚¡èƒŒçš„é¢æ¸£ï¼Œæ˜¥æ‹›æ‹¿åˆ°äº†å››ä¸ª offerï¼Œå…¶ä¸­åŒ…æ‹¬æ³°éš†é“¶è¡Œå’Œäº¤é€šé“¶è¡Œï¼Œé—®æˆ‘è¯¥æ€ä¹ˆé€‰æ‹©ï¼Œè¯´å®è¯æˆ‘çœ‹å®Œåè§‰å¾—æŒºéš¾é€‰çš„ï¼ŒğŸ˜„ä¸è¿‡è¿˜æ˜¯å€¼å¾—æ­å–œä¸€æ‰‹ã€‚å¤§å®¶åœ¨å‡†å¤‡æ˜¥æ‹›çš„æ—¶å€™ä¹Ÿä¸è¦ç€æ€¥ï¼Œä»˜å‡ºæ€»ä¼šæœ‰å›æŠ¥çš„ã€‚

![çƒå‹æ˜¥æ‹›æ‹¿åˆ°äº†å››ä¸ª offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250520094922.png)

### ğŸŒŸ30.èƒ½è¯´è¯´å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ

å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡æé«˜çš„æ¦‚ç‡æ€§æ•°æ®ç»“æ„ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿä»¥æå°çš„å†…å­˜æ¶ˆè€—ï¼Œåˆ¤æ–­ä¸€ä¸ªå…ƒç´ â€œä¸€å®šä¸åœ¨é›†åˆä¸­â€æˆ–â€œå¯èƒ½åœ¨é›†åˆä¸­â€ï¼Œå¸¸ç”¨æ¥è§£å†³ Redis ç¼“å­˜ç©¿é€çš„é—®é¢˜ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå¸ƒéš†è¿‡æ»¤å™¨](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d0b8d85c-85dc-4843-b4be-d5d48338a44e.png)

----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒstart----

å¸ƒéš†è¿‡æ»¤å™¨çš„æ ¸å¿ƒç”±ä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶å‘é‡å’Œä¸€ç³»åˆ—å“ˆå¸Œå‡½æ•°ç»„æˆã€‚

- åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º m çš„ä½æ•°ç»„ï¼Œåˆå§‹å€¼å…¨ä¸º 0ï¼ŒåŒæ—¶é€‰æ‹© k ä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°
- å½“æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œç”¨ k ä¸ªå“ˆå¸Œå‡½æ•°è®¡ç®—å‡º k ä¸ªå“ˆå¸Œå€¼ï¼Œç„¶åå¯¹ m å–æ¨¡ï¼Œå¾—åˆ° k ä¸ªä½ç½®ï¼Œå°†è¿™äº›ä½ç½®çš„äºŒè¿›åˆ¶ä½éƒ½è®¾ä¸º 1
- å½“éœ€è¦åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­æ—¶ï¼ŒåŒæ ·ç”¨ k ä¸ªå“ˆå¸Œå‡½æ•°è®¡ç®—å‡º k ä¸ªä½ç½®ï¼Œå¦‚æœè¿™äº›ä½ç½®çš„äºŒè¿›åˆ¶ä½æœ‰ä»»ä½•ä¸€ä¸ªä¸º 0ï¼Œè¯¥å…ƒç´ ä¸€å®šä¸åœ¨é›†åˆä¸­ï¼›å¦‚æœå…¨éƒ¨ä¸º 1ï¼Œåˆ™è¯¥å…ƒç´ å¯èƒ½åœ¨é›†åˆä¸­

```java
public class BloomFilter<T> {
    private BitSet bitSet;
    private int bitSetSize;
    private int numberOfHashFunctions;
    
    public BloomFilter(double falsePositiveProbability, int expectedNumberOfElements) {
        // æ ¹æ®é¢„æœŸå…ƒç´ æ•°é‡å’ŒæœŸæœ›çš„è¯¯åˆ¤ç‡ï¼Œè®¡ç®—æœ€ä¼˜çš„ä½æ•°ç»„å¤§å°å’Œå“ˆå¸Œå‡½æ•°ä¸ªæ•°
        this.bitSetSize = calculateOptimalBitSetSize(expectedNumberOfElements, falsePositiveProbability);
        this.numberOfHashFunctions = calculateOptimalNumberOfHashFunctions(expectedNumberOfElements, bitSetSize);
        this.bitSet = new BitSet(bitSetSize);
    }
    
    public void add(T element) {
        int[] hashes = createHashes(element);
        for (int hash : hashes) {
            bitSet.set(Math.abs(hash % bitSetSize), true);
        }
    }
    
    public boolean mightContain(T element) {
        int[] hashes = createHashes(element);
        for (int hash : hashes) {
            if (!bitSet.get(Math.abs(hash % bitSetSize))) {
                return false; // å¦‚æœä»»ä½•ä¸€ä½ä¸º0ï¼Œå…ƒç´ ä¸€å®šä¸å­˜åœ¨
            }
        }
        return true; // æ‰€æœ‰ä½éƒ½ä¸º1ï¼Œå…ƒç´ å¯èƒ½å­˜åœ¨
    }
    
    // å…¶ä»–è¾…åŠ©æ–¹æ³•ï¼Œå¦‚è®¡ç®—å“ˆå¸Œå€¼ï¼Œè®¡ç®—æœ€ä¼˜å‚æ•°ç­‰
}
```

----è¿™éƒ¨åˆ†é¢è¯•ä¸­å¯ä»¥ä¸èƒŒend----

#### å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤å—ï¼Ÿ

æ˜¯çš„ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤ã€‚å®ƒå¯èƒ½ä¼šé”™è¯¯åœ°è®¤ä¸ºæŸä¸ªå…ƒç´ åœ¨é›†åˆä¸­ï¼Œè€Œå…ƒç´ å®é™…ä¸Šå¹¶ä¸åœ¨é›†åˆä¸­ã€‚

![å‹‡å“¥ï¼šå¸ƒéš†è¿‡æ»¤å™¨](https://cdn.tobebetterjavaer.com/stutymore/redis-20241019191741.png)

ä½†å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è®¤ä¸ºæŸä¸ªå…ƒç´ ä¸å­˜åœ¨äºé›†åˆä¸­ï¼Œé‚£ä¹ˆå®ƒä¸€å®šä¸å­˜åœ¨ã€‚

è¯¯åˆ¤äº§ç”Ÿçš„åŸå› æ˜¯å› ä¸ºå“ˆå¸Œå†²çªã€‚åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¤šä¸ªä¸åŒçš„å…ƒç´ å¯èƒ½æ˜ å°„åˆ°ç›¸åŒçš„ä½ç½®ã€‚éšç€å‘å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ·»åŠ çš„å…ƒç´ è¶Šæ¥è¶Šå¤šï¼Œä½æ•°ç»„ä¸­çš„ 1 ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œå‘ç”Ÿå“ˆå¸Œå†²çªçš„æ¦‚ç‡éšä¹‹å¢åŠ ï¼Œè¯¯åˆ¤ç‡ä¹Ÿå°±éšä¹‹ä¸Šå‡ã€‚

![å‹‡å“¥ï¼šå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤](https://cdn.tobebetterjavaer.com/stutymore/redis-20241019192648.png)

è¯¯åˆ¤ç‡å–å†³äºä»¥ä¸‹ 3 ä¸ªå› ç´ ï¼š

1. ä½æ•°ç»„çš„å¤§å°ï¼ˆmï¼‰ï¼šm å†³å®šäº†å¯ä»¥å­˜å‚¨çš„æ ‡å¿—ä½æ•°é‡ã€‚å¦‚æœä½æ•°ç»„è¿‡å°ï¼Œé‚£ä¹ˆå“ˆå¸Œç¢°æ’çš„å‡ ç‡å°±ä¼šå¢åŠ ï¼Œä»è€Œå¯¼è‡´æ›´é«˜çš„è¯¯åˆ¤ç‡ã€‚
2. å“ˆå¸Œå‡½æ•°çš„æ•°é‡ï¼ˆkï¼‰ï¼šk å†³å®šäº†æ¯ä¸ªå…ƒç´ åœ¨ä½æ•°ç»„ä¸­æ ‡è®°çš„ä½æ•°ã€‚å“ˆå¸Œå‡½æ•°è¶Šå¤šï¼Œç¢°æ’çš„æ¦‚ç‡ä¹Ÿä¼šç›¸åº”å˜åŒ–ã€‚å¦‚æœå“ˆå¸Œå‡½æ•°å¤ªå°‘ï¼Œè¿‡æ»¤å™¨å¾ˆå¿«ä¼šå˜å¾—ä¸ç²¾ç¡®ï¼›å¦‚æœå¤ªå¤šï¼Œè¯¯åˆ¤ç‡ä¹Ÿä¼šå‡é«˜ï¼Œæ•ˆç‡ä¸‹é™ã€‚
3. å­˜å…¥çš„å…ƒç´ æ•°é‡ï¼ˆnï¼‰ï¼šn è¶Šå¤šï¼Œå“ˆå¸Œç¢°æ’çš„å‡ ç‡è¶Šå¤§ï¼Œä»è€Œå¯¼è‡´æ›´é«˜çš„è¯¯åˆ¤ç‡ã€‚

$$
f(k) = \left( 1 - e^{- \frac{kn}{m}} \right)^k
$$

è¦é™ä½è¯¯åˆ¤ç‡ï¼Œå¯ä»¥å¢åŠ ä½æ•°ç»„çš„å¤§å°æˆ–è€…å‡å°‘æ’å…¥çš„å…ƒç´ æ•°é‡ã€‚

è¦å½»åº•è§£å†³å¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤é—®é¢˜ï¼Œå¯ä»¥åœ¨å¸ƒéš†è¿‡æ»¤å™¨è¿”å›"å¯èƒ½å­˜åœ¨"æ—¶ï¼Œå†é€šè¿‡æ•°æ®åº“è¿›è¡ŒäºŒæ¬¡ç¡®è®¤ã€‚

#### å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒåˆ é™¤å—ï¼Ÿ

å¸ƒéš†è¿‡æ»¤å™¨å¹¶ä¸æ”¯æŒåˆ é™¤æ“ä½œï¼Œè¿™æ˜¯å®ƒçš„ä¸€ä¸ªé‡è¦é™åˆ¶ã€‚

å½“æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šå°†ä½æ•°ç»„ä¸­çš„ k ä¸ªä½ç½®è®¾ç½®ä¸º 1ã€‚ç”±äºå¤šä¸ªä¸åŒå…ƒç´ å¯èƒ½å…±äº«ç›¸åŒçš„ä½ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå°†å…¶å¯¹åº”çš„ k ä¸ªä½é‡ç½®ä¸º 0ï¼Œå¯èƒ½ä¼šé”™è¯¯åœ°å½±å“åˆ°å…¶ä»–å…ƒç´ çš„åˆ¤æ–­ç»“æœã€‚

ä¾‹å¦‚ï¼Œå…ƒç´  A å’Œå…ƒç´  B éƒ½å°†ä½ç½® 5 è®¾ä¸º 1ï¼Œå¦‚æœåˆ é™¤å…ƒç´  A æ—¶å°†ä½ç½® 5 é‡ç½®ä¸º 0ï¼Œé‚£ä¹ˆå¯¹å…ƒç´  B çš„æŸ¥è¯¢å°±ä¼šäº§ç”Ÿé”™è¯¯çš„"ä¸å­˜åœ¨"ç»“æœï¼Œè¿™è¿èƒŒäº†å¸ƒéš†è¿‡æ»¤å™¨çš„åŸºæœ¬ç‰¹æ€§ã€‚

å¦‚æœæƒ³è¦å®ç°åˆ é™¤æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®ƒåœ¨æ¯ä¸ªä½ç½®ä¸Šå­˜å‚¨ä¸€ä¸ªè®¡æ•°å™¨è€Œä¸æ˜¯å•ä¸€çš„ä½ã€‚è¿™æ ·å¯ä»¥é€šè¿‡å‡å°‘è®¡æ•°å™¨çš„å€¼æ¥å®ç°åˆ é™¤æ“ä½œï¼Œä½†ä¼šå¢åŠ å†…å­˜å¼€é”€ã€‚

```java
public class CountingBloomFilter<T> {
    private int[] counters;
    private int size;
    private int hashFunctions;
    
    public CountingBloomFilter(int size, int hashFunctions) {
        this.size = size;
        this.hashFunctions = hashFunctions;
        this.counters = new int[size];
    }
    
    public void add(T element) {
        int[] positions = getHashPositions(element);
        for (int position : positions) {
            counters[position]++;
        }
    }
    
    public void remove(T element) {
        int[] positions = getHashPositions(element);
        for (int position : positions) {
            if (counters[position] > 0) {
                counters[position]--;
            }
        }
    }
    
    public boolean mightContain(T element) {
        int[] positions = getHashPositions(element);
        for (int position : positions) {
            if (counters[position] == 0) {
                return false;
            }
        }
        return true;
    }
    
    private int[] getHashPositions(T element) {
        // è®¡ç®—å“ˆå¸Œä½ç½®çš„ä»£ç 
    }
}
```

#### ä¸ºä»€ä¹ˆä¸èƒ½ç”¨å“ˆå¸Œè¡¨è€Œæ˜¯ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿ

å¸ƒéš†è¿‡æ»¤å™¨æœ€çªå‡ºçš„ä¼˜åŠ¿æ˜¯å†…å­˜æ•ˆç‡ã€‚

å‡å¦‚æˆ‘ä»¬è¦åˆ¤æ–­ 10 äº¿ä¸ªç”¨æˆ· ID æ˜¯å¦æ›¾ç»è®¿é—®è¿‡ç‰¹å®šé¡µé¢ï¼Œä½¿ç”¨å“ˆå¸Œè¡¨è‡³å°‘éœ€è¦ 10G å†…å­˜ï¼ˆæ¯ä¸ª ID è‡³å°‘éœ€è¦8å­—èŠ‚ï¼‰ï¼Œè€Œä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨åªéœ€è¦ 1.2G å†…å­˜ã€‚

```
m â‰ˆ -n*ln(p)/ln(2)Â² â‰ˆ -10â¹*ln(0.01)/ln(2)Â² â‰ˆ 9.6 billion bits â‰ˆ 1.2GB
```


> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šæœ‰äº†è§£è¿‡å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„TPè”æ´²åŒå­¦ 5 Java åç«¯ä¸€é¢çš„åŸé¢˜ï¼šå¸ƒéš†è¿‡æ»¤å™¨åŸç†ï¼Œè¿™ç§æ–¹å¼ä¸‹5%çš„é”™è¯¯ç‡å¯æ¥å—ï¼Ÿ
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢åŒå­¦ 9 ä¸€é¢é¢è¯•åŸé¢˜ï¼šå¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿå¸ƒéš†è¿‡æ»¤å™¨ä¼˜ç‚¹ï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½ç”¨å“ˆå¸Œè¡¨è¦ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿ
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç†æƒ³æ±½è½¦é¢ç»åŒå­¦ 2 ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¿½é—®ï¼šè¯´æ˜ä¸€ä¸‹å¸ƒéš†è¿‡æ»¤å™¨

memoï¼š2025 å¹´ 5 æœˆ 20 æ—¥ï¼Œä»Šå¤©[æœ‰çƒå‹å‘è´´](https://javabetter.cn/zhishixingqiu/)è¯´æ‹¿åˆ°äº†æ»´æ»´çš„æš‘æœŸ offerï¼Œç‰¹æ„æ¥æ„Ÿè°¢äº†ä¸€ä¸‹é¢æ¸£é€†è¢­ã€‚

![æ‹¿åˆ°äº†æ»´æ»´çš„ offer](https://cdn.tobebetterjavaer.com/stutymore/redis-20250521151850.png)

### ğŸŒŸ31.å¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®â¼€è‡´æ€§ï¼Ÿ

åœ¨[æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®](https://javabetter.cn/zhishixingqiu/paicoding.html)ä¸­ï¼Œå¯¹äºæ–‡ç« æ ‡ç­¾è¿™ç§å…è®¸çŸ­æš‚ä¸ä¸€è‡´çš„æ•°æ®ï¼Œæˆ‘ä¼šé‡‡ç”¨ [Cache Aside](https://coolshell.cn/articles/17416.html) + TTL è¿‡æœŸæœºåˆ¶æ¥ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚

![æŠ€æœ¯æ´¾æ•™ç¨‹ï¼šMySQL å’Œ Redis ä¸€è‡´æ€§](https://cdn.tobebetterjavaer.com/stutymore/redis-20240325221330.png)


å…·ä½“åšæ³•æ˜¯è¯»å–æ—¶å…ˆæŸ¥ Redisï¼Œæœªå‘½ä¸­å†æŸ¥ MySQLï¼ŒåŒæ—¶ä¸ºç¼“å­˜è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ï¼›æ›´æ–°æ—¶å…ˆæ›´æ–° MySQLï¼Œå†åˆ é™¤ Redisã€‚

```java
// è¯»å–é€»è¾‘
public UserInfo getUser(String userId) {
    // å…ˆæŸ¥ç¼“å­˜
    UserInfo user = cache.get("user:" + userId);
    if (user != null) {
        return user;
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
    user = database.selectUser(userId);
    if (user != null) {
        // æ”¾å…¥ç¼“å­˜ï¼Œè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
        cache.set("user:" + userId, user, 3600);
    }
    
    return user;
}

// æ›´æ–°é€»è¾‘
public void updateUser(UserInfo user) {
    // å…ˆæ›´æ–°æ•°æ®åº“
    database.updateUser(user);
    
    // åˆ é™¤ç¼“å­˜
    cache.delete("user:" + user.getId());
}
```

è¿™ç§æ–¹å¼ç®€å•æœ‰æ•ˆï¼Œé€‚ç”¨äºåº¦å¤šäº›å°‘çš„åœºæ™¯ã€‚TTL è¿‡æœŸæ—¶é—´ä¹Ÿèƒ½å¤Ÿä¿è¯å³ä½¿æ›´æ–°æ“ä½œå¤±è´¥ï¼Œæœªèƒ½åŠæ—¶åˆ é™¤ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—´ä¹Ÿèƒ½ç¡®ä¿æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚

#### é‚£å†æ¥è¯´è¯´ä¸ºä»€ä¹ˆè¦åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ

æœ€åˆè®¾è®¡ç¼“å­˜ç­–ç•¥æ—¶ï¼Œæˆ‘ä¹Ÿè€ƒè™‘è¿‡ç›´æ¥æ›´æ–°ç¼“å­˜ï¼Œä½†é€šè¿‡å®è·µå‘ç°ï¼Œåˆ é™¤ç¼“å­˜æ˜¯æ›´ä¼˜çš„é€‰æ‹©ã€‚

![æŠ€æœ¯æ´¾ï¼šæ›´æ–° Redis è€Œä¸æ˜¯åˆ é™¤ Redis](https://cdn.tobebetterjavaer.com/stutymore/redis-20250522100735.png)

æœ€ä¸»è¦çš„åŸå› æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå¹¶å‘çš„æ›´æ–°æ“ä½œï¼Œå¦‚æœé‡‡ç”¨æ›´æ–°ç¼“å­˜çš„ç­–ç•¥ï¼Œå°±å¯èƒ½å‡ºç°è¿™æ ·çš„æ—¶åºé—®é¢˜ï¼š

- æ“ä½œ A å’Œæ“ä½œ B åŒæ—¶å‘ç”Ÿï¼ŒA å…ˆæ›´æ–° MySQL å°†å€¼æ”¹ä¸º 10ï¼ŒB åæ›´æ–° MySQL å°†å€¼æ”¹ä¸º 11ã€‚ä½†åœ¨ç¼“å­˜æ›´æ–°æ—¶ï¼Œå¯èƒ½ B å…ˆæ‰§è¡Œå°†ç¼“å­˜è®¾ä¸º 11ï¼Œç„¶å A æ‰æ‰§è¡Œå°†ç¼“å­˜è®¾ä¸º10ã€‚è¿™æ ·å°±ä¼šé€ æˆ MySQL æ˜¯ 11 ä½† Redis æ˜¯ 10 çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚

è€Œé‡‡ç”¨åˆ é™¤ç­–ç•¥ï¼Œæ— è®º A å’Œ B è°å…ˆåˆ é™¤ç¼“å­˜ï¼Œåç»­çš„è¯»å–æ“ä½œéƒ½ä¼šä» MySQL è·å–æœ€æ–°å€¼ã€‚

å¦å¤–ï¼Œç›¸å¯¹è€Œè¨€ï¼Œåˆ é™¤ç¼“å­˜çš„é€Ÿåº¦æ¯”æ›´æ–°ç¼“å­˜çš„é€Ÿåº¦å¿«å¾—å¤šã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šåˆ é™¤ç¼“å­˜å’Œæ›´æ–°ç¼“å­˜](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-ebad0a67-3012-4466-a4dc-e834104c48f8.png)

å› ä¸ºåˆ é™¤æ“ä½œåªæ˜¯ç®€å•çš„ DEL å‘½ä»¤ï¼Œè€Œæ›´æ–°å¯èƒ½éœ€è¦é‡æ–°åºåˆ—åŒ–æ•´ä¸ªå¯¹è±¡å†å†™å…¥ç¼“å­˜ã€‚

#### é‚£å†è¯´è¯´ä¸ºä»€ä¹ˆè¦å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼Ÿ

è¿™ä¸ªæ“ä½œé¡ºåºçš„é€‰æ‹©ä¹Ÿæ˜¯æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­è¸©è¿‡å‘æ‰æ·±åˆ»ç†è§£çš„ã€‚å‡è®¾æˆ‘ä»¬é‡‡ç”¨å…ˆåˆ ç¼“å­˜å†æ›´æ–°æ•°æ®åº“çš„ç­–ç•¥ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å°±å¯èƒ½å‡ºç°è¿™æ ·çš„é—®é¢˜ï¼š

- çº¿ç¨‹ A è¦æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œå…ˆåˆ é™¤äº†ç¼“å­˜
- çº¿ç¨‹ B æ°å¥½æ­¤æ—¶è¦è¯»å–è¯¥ç”¨æˆ·ä¿¡æ¯ï¼Œå‘ç°ç¼“å­˜ä¸ºç©ºï¼Œäºæ˜¯æŸ¥è¯¢æ•°æ®åº“ï¼Œæ­¤æ—¶è¿˜æ˜¯æ—§å€¼
- çº¿ç¨‹ B å°†æŸ¥åˆ°çš„æ—§å€¼é‡æ–°æ”¾å…¥ç¼“å­˜
- çº¿ç¨‹ A å®Œæˆæ•°æ®åº“æ›´æ–°

ç»“æœå°±æ˜¯æ•°æ®åº“æ˜¯æ–°çš„å€¼ï¼Œä½†ç¼“å­˜ä¸­è¿˜æ˜¯æ—§å€¼ã€‚

![æŠ€æœ¯æ´¾ï¼šå…ˆåˆ  Redis å†æ›´æ–° MySQL](https://cdn.tobebetterjavaer.com/stutymore/redis-20250522102052.png)

è€Œé‡‡ç”¨å…ˆæ›´æ–°æ•°æ®åº“å†åˆ ç¼“å­˜çš„ç­–ç•¥ï¼Œå³ä½¿å‡ºç°ç±»ä¼¼çš„å¹¶å‘æƒ…å†µï¼Œæœ€åçš„æƒ…å†µä¹Ÿåªæ˜¯çŸ­æš‚åœ°ä»ç¼“å­˜ä¸­è¯»å–åˆ°äº†æ—§å€¼ï¼Œä½†ç¼“å­˜åˆ é™¤åçš„è¯·æ±‚ä¼šç›´æ¥ä»æ•°æ®åº“ä¸­è·å–æœ€æ–°å€¼ã€‚

å¦å¤–ï¼Œå¦‚æœå…ˆåˆ ç¼“å­˜å†æ›´æ–°æ•°æ®åº“ï¼Œå½“æ•°æ®åº“æ›´æ–°å¤±è´¥æ—¶ï¼Œç¼“å­˜å·²ç»è¢«åˆ é™¤äº†ã€‚è¿™ä¼šå¯¼è‡´çŸ­æœŸå†…æ‰€æœ‰è¯»è¯·æ±‚éƒ½ä¼šç©¿é€åˆ°æ•°æ®åº“ï¼Œå¯¹æ•°æ®åº“é€ æˆé¢å¤–çš„å‹åŠ›ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå…ˆæ›´æ•°æ®åº“è¿˜æ˜¯å…ˆåˆ ç¼“å­˜](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5c929a9e-a723-43b3-8f3c-f22c83765f9d.png)

è€Œå…ˆæ›´æ–°æ•°æ®åº“å†åˆ ç¼“å­˜ï¼Œå¦‚æœæ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œç¼“å­˜ä¿æŒåŸçŠ¶ï¼Œç³»ç»Ÿä»ç„¶èƒ½ç»§ç»­æ­£å¸¸æä¾›æœåŠ¡ã€‚

```java
public void updateUser(User user) {
    try {
        // å…ˆæ›´æ–°æ•°æ®åº“
        database.updateUser(user);
        
        // å†åˆ é™¤ç¼“å­˜
        cache.delete("user:" + user.getId());
    } catch (DatabaseException e) {
        // æ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œç¼“å­˜ä¿æŒåŸçŠ¶ï¼Œç³»ç»Ÿä»å¯æ­£å¸¸æä¾›æœåŠ¡
        log.error("Database update failed", e);
        throw e;
    } catch (CacheException e) {
        // ç¼“å­˜åˆ é™¤å¤±è´¥ï¼Œæ•°æ®åº“å·²æ›´æ–°ï¼Œæ•°æ®ä¼šåœ¨TTLåè‡ªåŠ¨ä¸€è‡´
        log.warn("Cache deletion failed, will be eventually consistent", e);
        // å¯ä»¥é€‰æ‹©ä¸æŠ›å¼‚å¸¸ï¼Œå› ä¸ºæœ‰TTLå…œåº•
    }
}
```

memoï¼š2025 å¹´ 5 æœˆ 22 æ—¥ï¼Œä»Šå¤©ç»™çƒå‹[ä¿®æ”¹ç®€å†](https://javabetter.cn/zhishixingqiu/)æ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªè¥¿åŒ—å·¥ä¸šå¤§å­¦æœ¬ã€ç”µå­ç§‘æŠ€å¤§å­¦ç¡•çš„çƒå‹ï¼Œä¸€ä¸‹å­ 985 é«˜æ ¡åˆé›†é½äº†ä¸¤æ‰€ã€‚å¦‚æœçƒå‹ä»¬åœ¨æ˜Ÿçƒé‡Œæœ‰æ‰€æ”¶è·ï¼Œä¹Ÿè¯·ç»™å­¦å¼Ÿå­¦å¦¹ä»¬ä¸€ä¸ªå£ç¢‘ï¼Œè®©å¤§å®¶éƒ½èƒ½å› æ­¤å—ç›Šï¼Œæ‹¿åˆ°æ›´å¥½çš„ offerã€‚

![è¥¿åŒ—å·¥ä¸šå¤§å­¦æœ¬ã€ç”µå­ç§‘æŠ€å¤§å­¦ç¡•çš„çƒå‹](https://cdn.tobebetterjavaer.com/stutymore/redis-20250522102954.png)

#### é‚£å‡å¦‚å¯¹ç¼“å­˜æ•°æ®åº“ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

å½“ä¸šåŠ¡å¯¹ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜æ—¶ï¼Œæ¯”å¦‚æ”¯ä»˜ç³»ç»Ÿã€åº“å­˜ç®¡ç†ç­‰åœºæ™¯ï¼Œæˆ‘ä¼šé‡‡ç”¨å¤šç§ç­–ç•¥æ¥ä¿è¯å¼ºä¸€è‡´æ€§ã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šç¼“å­˜å¼ºä¸€è‡´æ€§](https://cdn.tobebetterjavaer.com/stutymore/redis-20240325225250.png)

ç¬¬ä¸€ç§ï¼Œå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—æ¥ä¿è¯ç¼“å­˜æœ€ç»ˆè¢«åˆ é™¤ï¼Œæ¯”å¦‚è¯´åœ¨æ•°æ®åº“æ›´æ–°çš„äº‹åŠ¡ä¸­æ’å…¥ä¸€æ¡æœ¬åœ°æ¶ˆæ¯è®°å½•ï¼Œäº‹åŠ¡æäº¤åå¼‚æ­¥å‘é€ç»™ MQ è¿›è¡Œç¼“å­˜åˆ é™¤ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¿è¯keyè¢«åˆ é™¤](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e4a61193-515a-409f-a436-2733abc3a86e.png)

å³ä½¿ç¼“å­˜åˆ é™¤å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„é‡è¯•æœºåˆ¶ä¹Ÿèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚

```java
@Transactional
public void updateUser(UserInfo user) {
    // åœ¨äº‹åŠ¡ä¸­æ›´æ–°æ•°æ®åº“
    database.updateUser(user);
    
    // åœ¨åŒä¸€äº‹åŠ¡ä¸­è®°å½•éœ€è¦åˆ é™¤çš„ç¼“å­˜ä¿¡æ¯
    LocalMessage message = new LocalMessage("CACHE_DELETE", "user:" + user.getId());
    database.insertLocalMessage(message);

    // æ˜¾å¼å‘å¸ƒäº‹ä»¶ï¼Œä¾›ç›‘å¬å™¨æ•è·
    eventPublisher.publishEvent(new UserUpdateEvent(this, "user:" + user.getId()));
}

// äº‹åŠ¡æäº¤åå‘é€MQæ¶ˆæ¯
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void sendCacheDeleteMessage(UserUpdateEvent event) {
    messageQueue.send("cache-delete-topic", event.getCacheKey());
}
```

ç¬¬äºŒç§ï¼Œä½¿ç”¨ [Canal](https://github.com/alibaba/canal) ç›‘å¬ MySQL çš„ binlogï¼Œåœ¨æ•°æ®æ›´æ–°æ—¶ï¼Œå°†æ•°æ®å˜æ›´è®°å½•åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…æ¶ˆæ¯ç›‘å¬åˆ°å˜æ›´åå»åˆ é™¤ç¼“å­˜ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæ•°æ®åº“è®¢é˜…+æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯keyè¢«åˆ é™¤](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-37c07418-9cd8-43d9-90e7-0cb43b329025.png)

è¿™ç§æ–¹æ¡ˆçš„ä¼˜åŠ¿æ˜¯å®Œå…¨è§£è€¦äº†ä¸šåŠ¡ä»£ç å’Œç¼“å­˜ç»´æŠ¤é€»è¾‘ã€‚

```java
@CanalListener
public class CacheUpdateListener {
    
    @EventHandler
    public void handleUserUpdate(UserUpdateEvent event) {
        // ä»binlogäº‹ä»¶ä¸­æå–å˜æ›´ä¿¡æ¯
        String userId = event.getUserId();
        
        // å‘é€ç¼“å­˜åˆ é™¤æ¶ˆæ¯
        CacheDeleteMessage message = new CacheDeleteMessage();
        message.setCacheKey("user:" + userId);
        messageQueue.send("cache-delete-topic", message);
    }
}
// æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—
@KafkaListener(topics = "cache-delete-topic")
public void handleCacheDeleteMessage(CacheDeleteMessage message) {
    // åˆ é™¤ç¼“å­˜
    cache.delete(message.getCacheKey());
}
```

å½“ç„¶äº†ï¼Œå¦‚æœè¯´ä¸šåŠ¡æ¯”è¾ƒç®€å•ï¼Œä¸éœ€è¦ä¸Šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥é€šè¿‡å»¶è¿ŸåŒåˆ ç­–ç•¥é™ä½ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´çš„æ—¶é—´çª—å£ï¼Œåœ¨ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ä¹‹åï¼Œè¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå†æ¬¡å°è¯•åˆ é™¤ç¼“å­˜ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå»¶æ—¶åŒåˆ ](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-fab24753-9c53-4432-9413-5feba07ae1e3.png)

è¿™ç§æ–¹å¼ä¸»è¦é’ˆå¯¹ç¼“å­˜ä¸å­˜åœ¨ï¼Œä½†å†™å…¥äº†è„æ•°æ®çš„æƒ…å†µã€‚

```java
public void updateUser(UserInfo user) {
    // ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ï¼Œå‡å°‘ä¸ä¸€è‡´æ—¶é—´çª—å£
    cache.delete("user:" + user.getId());
    
    // æ›´æ–°æ•°æ®åº“
    database.updateUser(user);
    
    // ç«‹å³åˆ é™¤ç¼“å­˜
    cache.delete("user:" + user.getId());
    
    // å»¶æ—¶åˆ é™¤ï¼Œåº”å¯¹å¯èƒ½çš„å¹¶å‘è¯»å–
    CompletableFuture.runAsync(() -> {
        try {
            Thread.sleep(1000); // å»¶æ—¶æ—¶é—´æ ¹æ®ä¸»ä»åŒæ­¥å»¶è¿Ÿè°ƒæ•´
            cache.delete("user:" + user.getId());
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    });
}
```

æœ€åï¼Œæ— è®ºé‡‡ç”¨å“ªç§ç­–ç•¥ï¼Œæœ€å¥½ä¸ºç¼“å­˜è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ä½œä¸ºæœ€åçš„ä¿éšœã€‚å³ä½¿æ‰€æœ‰çš„ä¸»åŠ¨åˆ é™¤æœºåˆ¶éƒ½å¤±è´¥äº†ï¼ŒTTL ä¹Ÿèƒ½ç¡®ä¿æ•°æ®æœ€ç»ˆè¾¾åˆ°ä¸€è‡´ï¼š

```java
// æ ¹æ®æ•°æ®çš„é‡è¦ç¨‹åº¦è®¾ç½®ä¸åŒçš„TTL
public void setCache(String key, Object value, DataImportance importance) {
    int ttl;
    switch (importance) {
        case HIGH:      // å…³é”®æ•°æ®ï¼ŒçŸ­TTL
            ttl = 300;  // 5åˆ†é’Ÿ
            break;
        case MEDIUM:    // ä¸€èˆ¬æ•°æ®
            ttl = 1800; // 30åˆ†é’Ÿ
            break;
        case LOW:       // ä¸å¤ªé‡è¦çš„æ•°æ®
            ttl = 3600; // 1å°æ—¶
            break;
    }
    
    cache.setWithTTL(key, value, ttl);
}
```

è¿™ç§æ–¹å¼è™½ç„¶ç®€å•ï¼Œä½†èƒ½ç¡®ä¿å³ä½¿å‡ºç°æç«¯æƒ…å†µï¼Œæ•°æ®ä¸ä¸€è‡´çš„å½±å“ä¹Ÿæ˜¯å¯æ§çš„ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸ºé¢ç»åŒå­¦ 8 æŠ€æœ¯äºŒé¢é¢è¯•åŸé¢˜ï¼šæ€æ ·ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Ÿ
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 23 QQ åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šæ•°æ®ä¸€è‡´æ€§é—®é¢˜
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¾®ä¼—é“¶è¡ŒåŒå­¦ 1 Java åç«¯ä¸€é¢çš„åŸé¢˜ï¼šMySQL å’Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜äº†è§£å—ï¼Ÿ
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 3 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šå¦‚ä½•ä¿è¯ redis ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æ¯”äºšè¿ªé¢ç»åŒå­¦ 12 Java æŠ€æœ¯é¢è¯•åŸé¢˜ï¼šæ€ä¹ˆè§£å†³rediså’Œmysqlçš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜
> 6. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 17 åç«¯æŠ€æœ¯é¢è¯•åŸé¢˜ï¼šåŒå†™ä¸€è‡´æ€§æ€ä¹ˆè§£å†³çš„
> 7. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 9 é¢è¯•åŸé¢˜ï¼šredisçš„æ•°æ®å’Œç¼“å­˜ä¸ä¸€è‡´åº”è¯¥å¤„ç†

memoï¼š2025 å¹´ 5 æœˆ 23 æ—¥ä¿®æ”¹è‡³æ­¤ï¼Œä»Šå¤©åœ¨ä¿®æ”¹[çƒå‹ç®€å†](https://javabetter.cn/zhishixingqiu/jianli.html)æ—¶ï¼Œçœ‹åˆ°ä¸€æ¡éå¸¸æ¸©æš–çš„æ„Ÿè°¢ä¿¡ï¼Œçƒå‹è¯´æ”¹å®Œåçš„ç®€å†ï¼Œæ¯ä¸€å¥éƒ½æ¯”ä¹‹å‰çš„å¥½å¾ˆå¤šï¼ŒçœŸçš„å¾ˆæ¬£æ…°ï¼Œæ„Ÿè§‰è‡ªå·±çš„ä»˜å‡ºå¾—åˆ°äº†å›æŠ¥ã€‚ğŸ˜„

![çƒå‹å¯¹ç®€å†ä¿®æ”¹çš„è®¤å¯](https://cdn.tobebetterjavaer.com/stutymore/redis-æ„Ÿè°¢äºŒå“¥çš„æŒ‡æ­£ï¼Œæ¯ä¸€å¥éƒ½æ„Ÿè§‰æ¯”æˆ‘çš„å¥½å¾ˆå¤šï¼Œæ”¹å®Œä¹‹åç®€å†è´¨é‡é ­é—´æ¶¨äº†ä¸å°‘ï¼Œå¤ªæ„Ÿè°¢äº†.png)

### 32.å¦‚ä½•ä¿è¯æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜çš„ä¸€è‡´ï¼Ÿ

åœ¨[æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®](https://javabetter.cn/zhishixingqiu/paicoding.html)ä¸­ï¼Œä¸ºäº†å‡è½» Redis çš„è´Ÿè½½ï¼Œæˆ‘åˆè¿½åŠ äº†ä¸€å±‚æœ¬åœ°ç¼“å­˜ Caffeineã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå»¶æ—¶åŒåˆ ](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-6d4ab7e6-8337-4576-bbf0-79202a1c3331.png)

ä¸ºäº†ä¿è¯æœ¬åœ°ç¼“å­˜å’Œ Redis ç¼“å­˜çš„ä¸€è‡´æ€§ï¼Œé€šå¸¸é‡‡ç”¨çš„ç­–ç•¥æœ‰ï¼š

â‘ ã€è®¾ç½®æœ¬åœ°ç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™æ˜¯æœ€ç®€å•ä¹Ÿæ˜¯æœ€ç›´æ¥çš„æ–¹æ³•ï¼Œå½“æœ¬åœ°ç¼“å­˜è¿‡æœŸæ—¶ï¼Œå°±ä» Redis ç¼“å­˜ä¸­å»åŒæ­¥ã€‚

â‘¡ã€ä½¿ç”¨ Redis çš„ Pub/Sub æœºåˆ¶ï¼Œå½“ Redis ç¼“å­˜å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘å¸ƒä¸€ä¸ªæ¶ˆæ¯ï¼Œæœ¬åœ°ç¼“å­˜è®¢é˜…è¿™ä¸ªæ¶ˆæ¯ï¼Œç„¶ååˆ é™¤å¯¹åº”çš„æœ¬åœ°ç¼“å­˜ã€‚

â‘¢ã€Redis ç¼“å­˜å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯”å¦‚ RocketMQã€RabbitMQ å»æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šæœ¬åœ°ç¼“å­˜/åˆ†å¸ƒå¼ç¼“å­˜ä¿æŒä¸€è‡´](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-20c15f0d-fb3c-4922-94b1-edcd856658be.png)

ç”±äºæŠ€æœ¯æ´¾æœ¬èº«å¯¹ç¼“å­˜çš„ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œæ‰€ä»¥æˆ‘å°±é‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼ã€‚

å¦å¤–ï¼Œåœ¨æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®ä¸­ï¼Œæˆ‘å¯¹ç¼“å­˜çš„ä½¿ç”¨åœºæ™¯åšäº†ç»†åŒ–ã€‚æ¯”å¦‚è¯´ï¼Œä½¿ç”¨ CacheBuilder æ¥å®Œæˆ Guava Cache çš„æ„å»ºï¼Œåƒä¸€äº›ç®€å•çš„ç¼“å­˜åœºæ™¯ï¼Œæ¯”å¦‚è¯´è·å–èœå•åˆ†ç±»ã€è·å–ç™»å½•éªŒè¯ç ã€è·å–ç”¨æˆ·è½¬å­˜å›¾ç‰‡ç­‰ï¼Œéƒ½ä½¿ç”¨äº† Guava Cacheã€‚

![æŠ€æœ¯æ´¾æ•™ç¨‹ï¼šGuava](https://cdn.tobebetterjavaer.com/stutymore/redis-20240507105407.png)

åƒé¦–é¡µä¾§è¾¹æ ã€ä¸“æ ä¾§è¾¹æ ã€æ–‡ç« è¯¦æƒ…ä¾§è¾¹æ ç­‰ç¼“å­˜åœºæ™¯ï¼Œå°±ä½¿ç”¨äº† Caffeine ä½œä¸ºæœ¬åœ°ç¼“å­˜ï¼Œé€šè¿‡ @Cacheableã€@CacheEvitã€@CachePut ç­‰æ³¨è§£å®ç°ï¼Œéå¸¸è½»å·§ã€‚

![æŠ€æœ¯æ´¾æ•™ç¨‹ï¼šCaffeine](https://cdn.tobebetterjavaer.com/stutymore/redis-20240507110254.png)

è€Œåƒç”¨æˆ· Session å’Œç½‘ç«™åœ°å›¾ SiteMap ç­‰ç¼“å­˜åœºæ™¯ï¼Œå°±ä½¿ç”¨äº† Redis æ¥ä½œä¸ºç¼“å­˜ã€‚

![æŠ€æœ¯æ´¾æ•™ç¨‹ï¼šRedis](https://cdn.tobebetterjavaer.com/stutymore/redis-20240507110652.png)

#### å¦‚æœåœ¨é¡¹ç›®ä¸­å¤šä¸ªåœ°æ–¹éƒ½è¦ä½¿ç”¨åˆ°äºŒçº§ç¼“å­˜çš„é€»è¾‘ï¼Œå¦‚ä½•è®¾è®¡è¿™ä¸€å—ï¼Ÿ

åœ¨è®¾è®¡æ—¶ï¼Œåº”è¯¥æ¸…æ¥šåœ°åŒºåˆ†ä½•æ—¶ä½¿ç”¨ä¸€çº§ç¼“å­˜å’Œä½•æ—¶ä½¿ç”¨äºŒçº§ç¼“å­˜ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯¹äºé¢‘ç¹è®¿é—®ä½†ä¸ç»å¸¸æ›´æ”¹çš„æ•°æ®ï¼Œå¯ä»¥æ”¾åœ¨æœ¬åœ°ç¼“å­˜ä¸­ä»¥æä¾›æœ€å¿«çš„è®¿é—®é€Ÿåº¦ã€‚è€Œå¯¹äºéœ€è¦å…±äº«æˆ–è€…ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜çš„æ•°æ®ï¼Œåº”å½“æ”¾åœ¨ä¸€çº§ç¼“å­˜ä¸­ã€‚

#### æœ¬åœ°ç¼“å­˜å’Œ Redis ç¼“å­˜çš„åŒºåˆ«å’Œæ•ˆç‡å¯¹æ¯”ï¼Ÿ

Redis å¯ä»¥éƒ¨ç½²åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ”¯æŒæ•°æ®åˆ†ç‰‡ï¼Œé€‚ç”¨äºè·¨æœåŠ¡å™¨çš„ç¼“å­˜å…±äº«ã€‚è€Œæœ¬åœ°ç¼“å­˜åªèƒ½åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šä½¿ç”¨ã€‚

Redis è¿˜å¯ä»¥æŒä¹…åŒ–æ•°æ®ï¼Œæ”¯æŒæ•°æ®å¤‡ä»½å’Œæ¢å¤ï¼Œé€‚ç”¨äºå¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ã€‚å¹¶ä¸”æ”¯æŒå‘å¸ƒ/è®¢é˜…ã€äº‹åŠ¡ã€Lua è„šæœ¬ç­‰é«˜çº§åŠŸèƒ½ã€‚

æ•ˆç‡ä¸Šï¼ŒRedis å’Œæœ¬åœ°ç¼“å­˜éƒ½æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦éƒ½éå¸¸å¿«ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨åŒå­¦ 7 Java åç«¯å®ä¹ ä¸€é¢çš„åŸé¢˜ï¼šæ€ä¹ˆä¿è¯äºŒçº§ç¼“å­˜å’Œ Redis ç¼“å­˜çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸ºé¢ç»åŒå­¦ 11 é¢è¯•åŸé¢˜ï¼šä½¿ç”¨çš„ guava cache å’Œ redis æ˜¯å¦‚ä½•ç»„åˆä½¿ç”¨çš„ï¼Ÿå¦‚æœåœ¨é¡¹ç›®ä¸­å¤šä¸ªåœ°æ–¹éƒ½è¦ä½¿ç”¨åˆ°äºŒçº§ç¼“å­˜çš„é€»è¾‘ï¼Œå¦‚ä½•è®¾è®¡è¿™ä¸€å—ï¼Ÿ
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å»å“ªå„¿åŒå­¦ 1 æŠ€æœ¯äºŒé¢çš„åŸé¢˜ï¼šredis å’Œæœ¬åœ°ç¼“å­˜çš„åŒºåˆ«ï¼Œå“ªä¸ªæ•ˆç‡é«˜
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æ‹¼å¤šå¤šé¢ç»åŒå­¦ 8 ä¸€é¢é¢è¯•åŸé¢˜ï¼šç¼“å­˜ä¸€è‡´æ€§å¦‚ä½•ä¿è¯

### 33.æ€ä¹ˆå¤„ç†çƒ­ keyï¼Ÿ

æ¨èé˜…è¯»ï¼š

- [é˜¿é‡Œï¼šå‘ç°å¹¶å¤„ç† Redis çš„å¤§ Key å’Œçƒ­ Key](https://help.aliyun.com/zh/redis/user-guide/identify-and-handle-large-keys-and-hotkeys)
- [è‘£å®—ç£Šï¼šRedis çƒ­ Key å‘ç°ä»¥åŠè§£å†³åŠæ³•](https://dongzl.github.io/2021/01/14/03-Redis-Hot-Key/index.html)

æ‰€è°“çš„çƒ­ keyï¼Œå°±æ˜¯æŒ‡åœ¨å¾ˆçŸ­æ—¶é—´å†…è¢«é¢‘ç¹è®¿é—®çš„é”®ã€‚

æ¯”å¦‚ï¼Œçƒ­é—¨æ–°é—»æˆ–çƒ­é—¨å•†å“ï¼Œè¿™ç±» key é€šå¸¸ä¼šæœ‰å¤§æµé‡çš„è®¿é—®ï¼Œå¯¹å­˜å‚¨è¿™ç±»ä¿¡æ¯çš„ Redis æ¥è¯´ï¼Œæ˜¯ä¸å°çš„å‹åŠ›ã€‚

> æŸå¤©æŸæµé‡æ˜æ˜Ÿçªç„¶çˆ†å‡ºä¸€ä¸ªå¤§ç“œï¼Œå¾®åšçªç„¶å°±å´©äº†ï¼Œè¿™å°±æ˜¯çƒ­ key çš„å‹åŠ›ã€‚

å†æ¯”å¦‚è¯´ Redis æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œçƒ­ key å¯èƒ½ä¼šé€ æˆæ•´ä½“æµé‡çš„ä¸å‡è¡¡ï¼ˆç½‘ç»œå¸¦å®½ã€CPU å’Œå†…å­˜èµ„æºï¼‰ï¼Œä¸ªåˆ«èŠ‚ç‚¹å‡ºç° OPS è¿‡å¤§çš„æƒ…å†µï¼Œæç«¯æƒ…å†µä¸‹çƒ­ç‚¹ key ç”šè‡³ä¼šè¶…è¿‡ Redis æœ¬èº«èƒ½å¤Ÿæ‰¿å—çš„ OPSã€‚

> OPSï¼ˆOperations Per Secondï¼‰æ˜¯ Redis çš„ä¸€ä¸ªé‡è¦æŒ‡æ ‡ï¼Œè¡¨ç¤º Redis æ¯ç§’é’Ÿèƒ½å¤Ÿå¤„ç†çš„å‘½ä»¤æ•°ã€‚

é€šå¸¸ä»¥ Key è¢«è¯·æ±‚çš„é¢‘ç‡æ¥åˆ¤å®šï¼Œæ¯”å¦‚ï¼š

- **QPS é›†ä¸­åœ¨ç‰¹å®šçš„ Key**ï¼šæ€»çš„ QPSï¼ˆæ¯ç§’æŸ¥è¯¢ç‡ï¼‰ä¸º 10000ï¼Œå…¶ä¸­ä¸€ä¸ª Key çš„ QPS é£™åˆ°äº† 8000ã€‚
- **å¸¦å®½ä½¿ç”¨ç‡é›†ä¸­åœ¨ç‰¹å®šçš„ Key**ï¼šä¸€ä¸ªæ‹¥æœ‰ä¸Šåƒæˆå‘˜ä¸”æ€»å¤§å°ä¸º 1M çš„å“ˆå¸Œ Keyï¼Œæ¯ç§’å‘é€å¤§é‡çš„ HGETALL è¯·æ±‚ã€‚
- **CPU ä½¿ç”¨ç‡é›†ä¸­åœ¨ç‰¹å®šçš„ Key**ï¼šä¸€ä¸ªæ‹¥æœ‰æ•°ä¸‡ä¸ªæˆå‘˜çš„ ZSET Keyï¼Œæ¯ç§’å‘é€å¤§é‡çš„ ZRANGE è¯·æ±‚ã€‚

> - HGETALL å‘½ä»¤ç”¨äºè¿”å›å“ˆå¸Œè¡¨ä¸­ï¼Œæ‰€æœ‰çš„å­—æ®µå’Œå€¼ã€‚
> - ZRANGE å‘½ä»¤ç”¨äºè¿”å›æœ‰åºé›†ä¸­ï¼ŒæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ã€‚

#### æ€ä¹ˆå¤„ç†çƒ­ keyï¼Ÿ

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šçƒ­keyå¤„ç†](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-6fa972ec-5531-48f2-a608-4465d79d4518.png)

å¯¹çƒ­ key çš„å¤„ç†ï¼Œæœ€å…³é”®çš„æ˜¯å¯¹çƒ­ key çš„ç›‘æ§:

â‘ ã€å®¢æˆ·ç«¯

å®¢æˆ·ç«¯å…¶å®æ˜¯è·ç¦» keyâ€œæœ€è¿‘â€çš„åœ°æ–¹ï¼Œå› ä¸º Redis å‘½ä»¤å°±æ˜¯ä»å®¢æˆ·ç«¯å‘å‡ºçš„ï¼Œä¾‹å¦‚åœ¨å®¢æˆ·ç«¯è®¾ç½®å…¨å±€å­—å…¸ï¼ˆkey å’Œè°ƒç”¨æ¬¡æ•°ï¼‰ï¼Œæ¯æ¬¡è°ƒç”¨ Redis å‘½ä»¤æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªå­—å…¸è¿›è¡Œè®°å½•ã€‚

â‘¡ã€ä»£ç†ç«¯

åƒ Twemproxyã€Codis è¿™äº›åŸºäºä»£ç†çš„ Redis åˆ†å¸ƒå¼æ¶æ„ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½æ˜¯é€šè¿‡ä»£ç†ç«¯å®Œæˆçš„ï¼Œå¯ä»¥åœ¨ä»£ç†ç«¯è¿›è¡Œç›‘æ§ã€‚

â‘¢ã€Redis æœåŠ¡ç«¯

ä½¿ç”¨ monitor å‘½ä»¤ç»Ÿè®¡çƒ­ç‚¹ key æ˜¯å¾ˆå¤šå¼€å‘å’Œè¿ç»´äººå‘˜é¦–å…ˆæƒ³åˆ°çš„æ–¹æ¡ˆï¼Œmonitor å‘½ä»¤å¯ä»¥ç›‘æ§åˆ° Redis æ‰§è¡Œçš„æ‰€æœ‰å‘½ä»¤ã€‚

> monitor å‘½ä»¤çš„ä½¿ç”¨ï¼š`redis-cli monitor`

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šmonitor](https://cdn.tobebetterjavaer.com/stutymore/redis-20240309085135.png)

è¿˜å¯ä»¥é€šè¿‡ bigkeys å‚æ•°æ¥åˆ†æçƒ­ Keyã€‚

> bigkeys å‘½ä»¤çš„ä½¿ç”¨ï¼š`redis-cli --bigkeys`

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šbigkeys](https://cdn.tobebetterjavaer.com/stutymore/redis-20240309090340.png)

åªè¦ç›‘æ§åˆ°äº†çƒ­ keyï¼Œå¯¹çƒ­ key çš„å¤„ç†å°±ç®€å•äº†ï¼š

â‘ ã€æŠŠçƒ­ key æ‰“æ•£åˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼Œé™ä½å‹â¼’ã€‚

åŸºæœ¬æ€è·¯å°±æ˜¯ç»™çƒ­ Key åŠ ä¸Šå‰ç¼€æˆ–è€…åç¼€ï¼Œè§ä¸‹ä¾‹ï¼š

```java
// N ä¸º Redis å®ä¾‹ä¸ªæ•°ï¼ŒM ä¸º N çš„ 2å€
const M = N * 2
//ç”Ÿæˆéšæœºæ•°
random = GenRandom(0, M)
//æ„é€ å¤‡ä»½æ–° Key
bakHotKey = hotKey + "_" + random
data = redis.GET(bakHotKey)
if data == NULL {
    data = redis.GET(hotKey)
    if data == NULL {
        data = GetFromDB()
        // å¯ä»¥åˆ©ç”¨åŸå­é”æ¥å†™å…¥æ•°æ®ä¿è¯æ•°æ®ä¸€è‡´æ€§
        redis.SET(hotKey, data, expireTime)
        redis.SET(bakHotKey, data, expireTime + GenRandom(0, 5))
    } else {
        redis.SET(bakHotKey, data, expireTime + GenRandom(0, 5))
    }
}
```

â‘¡ã€åŠ â¼Šâ¼†çº§ç¼“å­˜ï¼Œå½“å‡ºç°çƒ­ Key åï¼ŒæŠŠçƒ­ Key åŠ è½½åˆ° JVM ä¸­ï¼Œåç»­é’ˆå¯¹è¿™äº›çƒ­ Key çš„è¯·æ±‚ï¼Œç›´æ¥ä» JVM ä¸­è¯»å–ã€‚

è¿™äº›æœ¬åœ°çš„ç¼“å­˜å·¥å…·æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ Caffeineã€Guava ç­‰ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ HashMap ä½œä¸ºæœ¬åœ°ç¼“å­˜éƒ½æ˜¯å¯ä»¥çš„ã€‚

æ³¨æ„ï¼Œå¦‚æœå¯¹çƒ­ Key è¿›è¡Œæœ¬åœ°ç¼“å­˜ï¼Œéœ€è¦é˜²æ­¢æœ¬åœ°ç¼“å­˜è¿‡å¤§ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸º OD çš„é¢è¯•ä¸­å‡ºç°è¿‡è¯¥é¢˜ï¼šè®²ä¸€è®² Redis çš„çƒ­ Key å’Œå¤§ Key

### 34.ç¼“å­˜é¢„çƒ­æ€ä¹ˆåšå‘¢ï¼Ÿ

ç¼“å­˜é¢„çƒ­æ˜¯æŒ‡åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œæå‰å°†ä¸€äº›é¢„å®šä¹‰çš„æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œä»¥é¿å…åœ¨ç³»ç»Ÿè¿è¡ŒåˆæœŸç”±äºç¼“å­˜æœªå‘½ä¸­ï¼ˆcache missï¼‰å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚

é€šè¿‡ç¼“å­˜é¢„çƒ­ï¼Œå¯ä»¥ç¡®ä¿ç³»ç»Ÿåœ¨ä¸Šçº¿åèƒ½å¤Ÿç«‹å³æä¾›é«˜æ•ˆçš„æœåŠ¡ï¼Œå‡å°‘é¦–æ¬¡è®¿é—®æ—¶çš„å»¶è¿Ÿã€‚

ç¼“å­˜é¢„çƒ­çš„æ–¹æ³•æœ‰å¤šç§ï¼Œåœ¨[æŠ€æœ¯æ´¾å®æˆ˜é¡¹ç›®](https://javabetter.cn/zhishixingqiu/paicoding.html)ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†é¡¹ç›®å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½å’Œå®šæ—¶é¢„çƒ­ä¸¤ç§æ–¹å¼ï¼Œæ¯”å¦‚è¯´æ¯å¤©å®šæ—¶æ›´æ–°ç«™ç‚¹åœ°å›¾åˆ° Redis ç¼“å­˜ä¸­ã€‚

```java
/**
 * é‡‡ç”¨å®šæ—¶å™¨æ–¹æ¡ˆï¼Œæ¯å¤©5:15åˆ†åˆ·æ–°ç«™ç‚¹åœ°å›¾ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§
 */
@Scheduled(cron = "0 15 5 * * ?")
public void autoRefreshCache() {
    log.info("å¼€å§‹åˆ·æ–°sitemap.xmlçš„urlåœ°å€ï¼Œé¿å…å‡ºç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜!");
    refreshSitemap();
    log.info("åˆ·æ–°å®Œæˆï¼");
}

@Override
public void refreshSitemap() {
    initSiteMap();
}

private synchronized void initSiteMap() {
    long lastId = 0L;
    RedisClient.del(SITE_MAP_CACHE_KEY);
    while (true) {
        List<SimpleArticleDTO> list = articleDao.getBaseMapper().listArticlesOrderById(lastId, SCAN_SIZE);

        // åˆ·æ–°ç«™ç‚¹åœ°å›¾ä¿¡æ¯
        Map<String, Long> map = list.stream().collect(Collectors.toMap(s -> String.valueOf(s.getId()), s -> s.getCreateTime().getTime(), (a, b) -> a));
        RedisClient.hMSet(SITE_MAP_CACHE_KEY, map);
        if (list.size() < SCAN_SIZE) {
            break;
        }
        lastId = list.get(list.size() - 1).getId();
    }
}
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 1 æŠ€æœ¯äºŒé¢é¢è¯•åŸé¢˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜é¢„çƒ­ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ

### 35.çƒ­ç‚¹ key é‡å»ºï¼Ÿé—®é¢˜ï¼Ÿè§£å†³ï¼Ÿ

å¼€å‘çš„æ—¶å€™ä¸€èˆ¬ä½¿ç”¨â€œç¼“å­˜+è¿‡æœŸæ—¶é—´â€çš„ç­–ç•¥ï¼Œæ—¢å¯ä»¥åŠ é€Ÿæ•°æ®è¯»å†™ï¼Œåˆä¿è¯æ•°æ®çš„å®šæœŸæ›´æ–°ï¼Œè¿™ç§æ¨¡å¼åŸºæœ¬èƒ½å¤Ÿæ»¡è¶³ç»å¤§éƒ¨åˆ†éœ€æ±‚ã€‚

ä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜å¦‚æœåŒæ—¶å‡ºç°ï¼Œå¯èƒ½å°±ä¼šå‡ºç°æ¯”è¾ƒå¤§çš„é—®é¢˜ï¼š

- å½“å‰ key æ˜¯ä¸€ä¸ªçƒ­ç‚¹ keyï¼ˆä¾‹å¦‚ä¸€ä¸ªçƒ­é—¨çš„å¨±ä¹æ–°é—»ï¼‰ï¼Œå¹¶å‘é‡éå¸¸å¤§ã€‚

- é‡å»ºç¼“å­˜ä¸èƒ½åœ¨çŸ­æ—¶é—´å®Œæˆï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªå¤æ‚è®¡ç®—ï¼Œä¾‹å¦‚å¤æ‚çš„ SQLã€å¤šæ¬¡ IOã€å¤šä¸ªä¾èµ–ç­‰ã€‚ åœ¨ç¼“å­˜å¤±æ•ˆçš„ç¬é—´ï¼Œæœ‰å¤§é‡çº¿ç¨‹æ¥é‡å»ºç¼“å­˜ï¼Œé€ æˆåç«¯è´Ÿè½½åŠ å¤§ï¼Œç”šè‡³å¯èƒ½ä¼šè®©åº”ç”¨å´©æºƒã€‚

#### æ€ä¹ˆå¤„ç†çƒ­keyå‘¢ï¼Ÿ

è¦è§£å†³è¿™ä¸ªé—®é¢˜ä¹Ÿä¸æ˜¯å¾ˆå¤æ‚ï¼Œè§£å†³é—®é¢˜çš„è¦ç‚¹åœ¨äºï¼š

- å‡å°‘é‡å»ºç¼“å­˜çš„æ¬¡æ•°ã€‚
- æ•°æ®å°½å¯èƒ½ä¸€è‡´ã€‚
- è¾ƒå°‘çš„æ½œåœ¨å±é™©ã€‚

æ‰€ä»¥ä¸€èˆ¬é‡‡ç”¨å¦‚ä¸‹æ–¹å¼ï¼š

1.  äº’æ–¥é”ï¼ˆmutex keyï¼‰
    è¿™ç§æ–¹æ³•åªå…è®¸ä¸€ä¸ªçº¿ç¨‹é‡å»ºç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…é‡å»ºç¼“å­˜çš„çº¿ç¨‹æ‰§è¡Œå®Œï¼Œé‡æ–°ä»ç¼“å­˜è·å–æ•°æ®å³å¯ã€‚
2.  æ°¸è¿œä¸è¿‡æœŸ
    â€œæ°¸è¿œä¸è¿‡æœŸâ€åŒ…å«ä¸¤å±‚æ„æ€ï¼š

- ä»ç¼“å­˜å±‚é¢æ¥çœ‹ï¼Œç¡®å®æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°çƒ­ç‚¹ key è¿‡æœŸåäº§ç”Ÿçš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯â€œç‰©ç†â€ä¸è¿‡æœŸã€‚
- ä»åŠŸèƒ½å±‚é¢æ¥çœ‹ï¼Œä¸ºæ¯ä¸ª value è®¾ç½®ä¸€ä¸ªé€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œå½“å‘ç°è¶…è¿‡é€»è¾‘è¿‡æœŸæ—¶é—´åï¼Œä¼šä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹å»æ„å»ºç¼“å­˜ã€‚

### 36.æ— åº•æ´é—®é¢˜å—ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ

2010 å¹´ï¼ŒFacebook çš„ Memcache èŠ‚ç‚¹å·²ç»è¾¾åˆ°äº† 3000 ä¸ªï¼Œæ‰¿è½½ç€ TB çº§åˆ«çš„ç¼“å­˜æ•°æ®ã€‚ä½†å¼€å‘å’Œè¿ç»´äººå‘˜å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºäº†æ»¡è¶³ä¸šåŠ¡è¦æ±‚æ·»åŠ äº†å¤§é‡æ–° Memcache èŠ‚ç‚¹ï¼Œä½†æ˜¯å‘ç°æ€§èƒ½ä¸ä½†æ²¡æœ‰å¥½è½¬åè€Œä¸‹é™äº†ï¼Œå½“æ—¶å°†è¿™ ç§ç°è±¡ç§°ä¸ºç¼“å­˜çš„â€œ**æ— åº•æ´**â€ç°è±¡ã€‚

é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šäº§ç”Ÿè¿™ç§ç°è±¡å‘¢?

é€šå¸¸æ¥è¯´æ·»åŠ èŠ‚ç‚¹ä½¿å¾— Memcache é›†ç¾¤ æ€§èƒ½åº”è¯¥æ›´å¼ºäº†ï¼Œä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚é”®å€¼æ•°æ®åº“ç”±äºé€šå¸¸é‡‡ç”¨å“ˆå¸Œå‡½æ•°å°† key æ˜ å°„åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œé€ æˆ key çš„åˆ†å¸ƒä¸ä¸šåŠ¡æ— å…³ï¼Œä½†æ˜¯ç”±äºæ•°æ®é‡å’Œè®¿é—®é‡çš„æŒç»­å¢é•¿ï¼Œé€ æˆéœ€è¦æ·»åŠ å¤§é‡èŠ‚ç‚¹åšæ°´å¹³æ‰©å®¹ï¼Œå¯¼è‡´é”®å€¼åˆ†å¸ƒåˆ°æ›´å¤šçš„ èŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥æ— è®ºæ˜¯ Memcache è¿˜æ˜¯ Redis çš„åˆ†å¸ƒå¼ï¼Œæ‰¹é‡æ“ä½œé€šå¸¸éœ€è¦ä»ä¸åŒèŠ‚ç‚¹ä¸Šè·å–ï¼Œç›¸æ¯”äºå•æœºæ‰¹é‡æ“ä½œåªæ¶‰åŠä¸€æ¬¡ç½‘ç»œæ“ä½œï¼Œåˆ†å¸ƒå¼æ‰¹é‡æ“ä½œä¼šæ¶‰åŠå¤šæ¬¡ç½‘ç»œæ—¶é—´ã€‚

#### æ— åº•æ´é—®é¢˜å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ

å…ˆåˆ†æä¸€ä¸‹æ— åº•æ´é—®é¢˜ï¼š

- å®¢æˆ·ç«¯ä¸€æ¬¡æ‰¹é‡æ“ä½œä¼šæ¶‰åŠå¤šæ¬¡ç½‘ç»œæ“ä½œï¼Œä¹Ÿå°±æ„å‘³ç€æ‰¹é‡æ“ä½œä¼šéšç€èŠ‚ç‚¹çš„å¢å¤šï¼Œè€—æ—¶ä¼šä¸æ–­å¢å¤§ã€‚

- ç½‘ç»œè¿æ¥æ•°å˜å¤šï¼Œå¯¹èŠ‚ç‚¹çš„æ€§èƒ½ä¹Ÿæœ‰ä¸€å®šå½±å“ã€‚

å¸¸è§çš„ä¼˜åŒ–æ€è·¯å¦‚ä¸‹ï¼š

- å‘½ä»¤æœ¬èº«çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚ä¼˜åŒ–æ“ä½œè¯­å¥ç­‰ã€‚

- å‡å°‘ç½‘ç»œé€šä¿¡æ¬¡æ•°ã€‚

- é™ä½æ¥å…¥æˆæœ¬ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯ä½¿ç”¨é•¿è¿/è¿æ¥æ± ã€NIO ç­‰ã€‚

GitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„å¼€æºçŸ¥è¯†åº“ã€Š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://github.com/itwanger/toBeBetterJavaer)ã€‹ç¬¬ä¸€ç‰ˆ PDF ç»ˆäºæ¥äº†ï¼åŒ…æ‹¬ Java åŸºç¡€è¯­æ³•ã€æ•°ç»„&å­—ç¬¦ä¸²ã€OOPã€é›†åˆæ¡†æ¶ã€Java IOã€å¼‚å¸¸å¤„ç†ã€Java æ–°ç‰¹æ€§ã€ç½‘ç»œç¼–ç¨‹ã€NIOã€å¹¶å‘ç¼–ç¨‹ã€JVM ç­‰ç­‰ï¼Œå…±è®¡ 32 ä¸‡ä½™å­—ï¼Œ500+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯é€šä¿—æ˜“æ‡‚ã€é£è¶£å¹½é»˜â€¦â€¦è¯¦æƒ…æˆ³ï¼š[å¤ªèµäº†ï¼ŒGitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„ Java æ•™ç¨‹](https://javabetter.cn/overview/)

å¾®ä¿¡æœ **æ²‰é»˜ç‹äºŒ** æˆ–æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨äºŒå“¥çš„åŸåˆ›å…¬ä¼—å·æ²‰é»˜ç‹äºŒï¼Œå›å¤ **222** å³å¯å…è´¹é¢†å–ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png)

## Redis è¿ç»´

### 37.Redis æŠ¥å†…å­˜ä¸è¶³æ€ä¹ˆå¤„ç†ï¼Ÿ

Redis å†…å­˜ä¸è¶³æœ‰è¿™ä¹ˆå‡ ç§å¤„ç†æ–¹å¼ï¼š

- ä¿®æ”¹é…ç½®æ–‡ä»¶ redis.conf çš„ maxmemory å‚æ•°ï¼Œå¢åŠ  Redis å¯ç”¨å†…å­˜
- ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤ set maxmemory åŠ¨æ€è®¾ç½®å†…å­˜ä¸Šé™
- ä¿®æ”¹å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ŒåŠæ—¶é‡Šæ”¾å†…å­˜ç©ºé—´
- ä½¿ç”¨ Redis é›†ç¾¤æ¨¡å¼ï¼Œè¿›è¡Œæ¨ªå‘æ‰©å®¹ã€‚

### 38.Redis key è¿‡æœŸç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

Redis çš„ key è¿‡æœŸå›æ”¶ç­–ç•¥ä¸»è¦æœ‰ä¸¤ç§ï¼šæƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis çš„è¿‡æœŸæ·˜æ±°ç­–ç•¥](https://cdn.tobebetterjavaer.com/stutymore/redis-20240326214119.png)

å½“æŸä¸ªé”®è¢«è®¿é—®æ—¶ï¼Œå¦‚æœå‘ç°å®ƒå·²ç»è¿‡æœŸï¼ŒRedis ä¼šç«‹å³åˆ é™¤è¯¥é”®ï¼Œä¿—ç§°æƒ°æ€§åˆ é™¤ã€‚ä½†è¿™ä¹Ÿæ„å‘³ç€å¦‚æœä¸€ä¸ªå·²è¿‡æœŸçš„é”®ä»æœªè¢«è®¿é—®ï¼Œå®ƒå°±ä¸ä¼šè¢«åˆ é™¤ï¼Œä¼šå ç”¨é¢å¤–çš„å†…å­˜ç©ºé—´ã€‚

é‚£è¿˜æœ‰ä¸€ç§å®šæœŸåˆ é™¤ç­–ç•¥ï¼Œå³æ¯éš”ä¸€æ®µæ—¶é—´ï¼ŒRedis å°±ä¼šéšæœºæ£€æŸ¥ä¸€äº›é”®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±åˆ é™¤ã€‚è¿™ç§ç­–ç•¥å¯ä»¥ä¿è¯è¿‡æœŸé”®åŠæ—¶è¢«åˆ é™¤ï¼Œä½†ä¹Ÿä¼šå¢åŠ  Redis çš„ CPU æ¶ˆè€—ã€‚

å¯ä»¥é€šè¿‡ `config get hz` å‘½ä»¤æŸ¥çœ‹ Redis å†…éƒ¨å®šæ—¶ä»»åŠ¡çš„é¢‘ç‡ã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šconfig get hz](https://cdn.tobebetterjavaer.com/stutymore/redis-20240326214800.png)

ç»“æœæ˜¾ç¤º hz çš„å€¼ä¸º "10"ï¼Œæ„å‘³ç€ Redis æœåŠ¡å™¨æ¯ç§’æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„é¢‘ç‡æ˜¯ 10 æ¬¡ã€‚å¯ä»¥é€šè¿‡ `CONFIG SET hz 20` è¿›è¡Œè°ƒæ•´ã€‚

![äºŒå“¥æœ¬åœ° Redis çš„é…ç½®æ–‡ä»¶è·¯å¾„å’Œ hz çš„é»˜è®¤å€¼](https://cdn.tobebetterjavaer.com/stutymore/redis-20240326215240.png)

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 22 æš‘æœŸå®ä¹ ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis key åˆ é™¤ç­–ç•¥
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å»å“ªå„¿é¢ç»åŒå­¦ 1 æŠ€æœ¯ 2 é¢é¢è¯•åŸé¢˜ï¼šredis å†…å­˜æ·˜æ±°å’Œè¿‡æœŸç­–ç•¥
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 5 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šredis keyè¿‡æœŸç­–ç•¥

### 39.Redis æœ‰å“ªäº›å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Ÿ

å½“ Redis çš„å†…å­˜ä½¿ç”¨è¾¾åˆ°æœ€å¤§å€¼æ—¶ï¼Œå®ƒä¼šæ ¹æ®é…ç½®çš„å†…å­˜æ·˜æ±°ç­–ç•¥æ¥å†³å®šå¦‚ä½•å¤„ç†æ–°çš„è¯·æ±‚ã€‚

>æœ€å¤§å€¼é€šè¿‡ maxmemory å‚æ•°è®¾ç½®

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRediså…­ç§å†…å­˜æº¢å‡ºæ§åˆ¶ç­–ç•¥](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-5be7405c-ee11-4d2b-bea4-9598f10a1b17.png)

å¸¸è§çš„ç­–ç•¥æœ‰ï¼š

1. noevictionï¼šé»˜è®¤ç­–ç•¥ï¼Œä¸è¿›è¡Œä»»ä½•æ•°æ®æ·˜æ±°ï¼Œç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ã€‚
2. allkeys-lruï¼šä»æ‰€æœ‰é”®ä¸­ï¼Œä½¿ç”¨ LRU ç®—æ³•æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é”®ã€‚
3. allkeys-lfuï¼šä»æ‰€æœ‰é”®ä¸­ï¼Œä½¿ç”¨ LFU ç®—æ³•æ·˜æ±°æœ€å°‘ä½¿ç”¨çš„é”®ã€‚
4. volatile-lruï¼šä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ä¸­æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é”®ã€‚
5. volatile-ttlï¼šä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ä¸­æ·˜æ±°å³å°†è¿‡æœŸçš„é”®ã€‚

>TTLï¼ŒTime To Liveï¼Œå­˜æ´»æ—¶é—´

#### LRU å’Œ LFU çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

LRUï¼ˆLeast Recently Usedï¼‰ï¼šåŸºäºæ—¶é—´ç»´åº¦ï¼Œæ·˜æ±°æœ€è¿‘æœ€å°‘è®¿é—®çš„é”®ã€‚é€‚åˆè®¿é—®å…·æœ‰æ—¶é—´ç‰¹æ€§çš„åœºæ™¯ã€‚

LFUï¼ˆLeast Frequently Usedï¼‰ï¼šåŸºäºæ¬¡æ•°ç»´åº¦ï¼Œæ·˜æ±°è®¿é—®é¢‘ç‡æœ€ä½çš„é”®ã€‚æ›´é€‚åˆé•¿æœŸçƒ­ç‚¹æ•°æ®åœºæ™¯ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æ˜¥æ‹›åŒå­¦ K ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆ redis å¿«ï¼Œæ·˜æ±°ç­–ç•¥ æŒä¹…åŒ–
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å»å“ªå„¿é¢ç»åŒå­¦ 1 æŠ€æœ¯ 2 é¢é¢è¯•åŸé¢˜ï¼šredis å†…å­˜æ·˜æ±°å’Œè¿‡æœŸç­–ç•¥
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ä½œä¸šå¸®é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šrediså†…å­˜æ·˜æ±°ç­–ç•¥
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„é˜¿é‡Œç³»é¢ç»åŒå­¦ 19 é¥¿äº†ä¹ˆé¢è¯•åŸé¢˜ï¼šrediså†…å­˜æ·˜æ±°æœºåˆ¶  å»¶ä¼¸åˆ°LRU   LFU

### 40.Redis é˜»å¡ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ

Redis å‘ç”Ÿé˜»å¡ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ’æŸ¥ï¼š
![Redisé˜»å¡æ’æŸ¥](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e6a35258-7a78-4489-90b7-e47a4190802b.png)

- **API æˆ–æ•°æ®ç»“æ„ä½¿ç”¨ä¸åˆç†**

  é€šå¸¸ Redis æ‰§è¡Œå‘½ä»¤é€Ÿåº¦éå¸¸å¿«ï¼Œä½†æ˜¯ä¸åˆç†åœ°ä½¿ç”¨å‘½ä»¤ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‰§è¡Œé€Ÿåº¦å¾ˆæ…¢ï¼Œå¯¼è‡´é˜»å¡ï¼Œå¯¹äºé«˜å¹¶å‘çš„åœºæ™¯ï¼Œåº”è¯¥å°½é‡é¿å…åœ¨å¤§å¯¹è±¡ä¸Šæ‰§è¡Œç®—æ³•å¤æ‚ åº¦è¶…è¿‡ Oï¼ˆnï¼‰çš„å‘½ä»¤ã€‚

  å¯¹æ…¢æŸ¥è¯¢çš„å¤„ç†åˆ†ä¸ºä¸¤æ­¥ï¼š

  1. å‘ç°æ…¢æŸ¥è¯¢ï¼š slowlog get{n}å‘½ä»¤å¯ä»¥è·å–æœ€è¿‘ çš„ n æ¡æ…¢æŸ¥è¯¢å‘½ä»¤ï¼›
  2. å‘ç°æ…¢æŸ¥è¯¢åï¼Œå¯ä»¥ä»ä¸¤ä¸ªæ–¹å‘å»ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼š
     1ï¼‰ä¿®æ”¹ä¸ºä½ç®—æ³•å¤æ‚åº¦çš„å‘½ä»¤ï¼Œå¦‚ hgetall æ”¹ä¸º hmget ç­‰ï¼Œç¦ç”¨ keysã€sort ç­‰å‘½ ä»¤
     2ï¼‰è°ƒæ•´å¤§å¯¹è±¡ï¼šç¼©å‡å¤§å¯¹è±¡æ•°æ®æˆ–æŠŠå¤§å¯¹è±¡æ‹†åˆ†ä¸ºå¤šä¸ªå°å¯¹è±¡ï¼Œé˜²æ­¢ä¸€æ¬¡å‘½ä»¤æ“ä½œè¿‡å¤šçš„æ•°æ®ã€‚

- **CPU é¥±å’Œçš„é—®é¢˜**

  å•çº¿ç¨‹çš„ Redis å¤„ç†å‘½ä»¤æ—¶åªèƒ½ä½¿ç”¨ä¸€ä¸ª CPUã€‚è€Œ CPU é¥±å’Œæ˜¯æŒ‡ Redis å•æ ¸ CPU ä½¿ç”¨ç‡è·‘åˆ°æ¥è¿‘ 100%ã€‚

  é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œå¤„ç†æ­¥éª¤ä¸€èˆ¬å¦‚ä¸‹ï¼š

  1. åˆ¤æ–­å½“å‰ Redis å¹¶å‘é‡æ˜¯å¦å·²ç»è¾¾åˆ°æé™ï¼Œå¯ä»¥ä½¿ç”¨ç»Ÿè®¡å‘½ä»¤ redis-cli-h{ip}-p{port}--stat è·å–å½“å‰ Redis ä½¿ç”¨æƒ…å†µ
  2. å¦‚æœ Redis çš„è¯·æ±‚å‡ ä¸‡+ï¼Œé‚£ä¹ˆå¤§æ¦‚å°±æ˜¯ Redis çš„ OPS å·²ç»åˆ°äº†æé™ï¼Œåº”è¯¥åšé›†ç¾¤åŒ–æ°´å“æ‰©å±•æ¥åˆ†æ‘Š OPS å‹åŠ›
  3. å¦‚æœåªæœ‰å‡ ç™¾å‡ åƒï¼Œé‚£ä¹ˆå°±å¾—æ’æŸ¥å‘½ä»¤å’Œå†…å­˜çš„ä½¿ç”¨

- **æŒä¹…åŒ–ç›¸å…³çš„é˜»å¡**

  å¯¹äºå¼€å¯äº†æŒä¹…åŒ–åŠŸèƒ½çš„ Redis èŠ‚ç‚¹ï¼Œéœ€è¦æ’æŸ¥æ˜¯å¦æ˜¯æŒä¹…åŒ–å¯¼è‡´çš„é˜»å¡ã€‚

  1. fork é˜»å¡
     fork æ“ä½œå‘ç”Ÿåœ¨ RDB å’Œ AOF é‡å†™æ—¶ï¼ŒRedis ä¸»çº¿ç¨‹è°ƒç”¨ fork æ“ä½œäº§ç”Ÿå…±äº« å†…å­˜çš„å­è¿›ç¨‹ï¼Œç”±å­è¿›ç¨‹å®ŒæˆæŒä¹…åŒ–æ–‡ä»¶é‡å†™å·¥ä½œã€‚å¦‚æœ fork æ“ä½œæœ¬èº«è€—æ—¶è¿‡é•¿ï¼Œå¿…ç„¶ä¼šå¯¼è‡´ä¸»çº¿ç¨‹çš„é˜»å¡ã€‚
  2. AOF åˆ·ç›˜é˜»å¡
     å½“æˆ‘ä»¬å¼€å¯ AOF æŒä¹…åŒ–åŠŸèƒ½æ—¶ï¼Œæ–‡ä»¶åˆ·ç›˜çš„æ–¹å¼ä¸€èˆ¬é‡‡ç”¨æ¯ç§’ä¸€æ¬¡ï¼Œåå°çº¿ç¨‹æ¯ç§’å¯¹ AOF æ–‡ä»¶åš fsync æ“ä½œã€‚å½“ç¡¬ç›˜å‹åŠ›è¿‡å¤§æ—¶ï¼Œfsync æ“ä½œéœ€è¦ç­‰ å¾…ï¼Œç›´åˆ°å†™å…¥å®Œæˆã€‚å¦‚æœä¸»çº¿ç¨‹å‘ç°è·ç¦»ä¸Šä¸€æ¬¡çš„ fsync æˆåŠŸè¶…è¿‡ 2 ç§’ï¼Œä¸ºäº† æ•°æ®å®‰å…¨æ€§å®ƒä¼šé˜»å¡ç›´åˆ°åå°çº¿ç¨‹æ‰§è¡Œ fsync æ“ä½œå®Œæˆã€‚
  3. HugePage å†™æ“ä½œé˜»å¡
     å¯¹äºå¼€å¯ Transparent HugePages çš„ æ“ä½œç³»ç»Ÿï¼Œæ¯æ¬¡å†™å‘½ä»¤å¼•èµ·çš„å¤åˆ¶å†…å­˜é¡µå•ä½ç”± 4K å˜ä¸º 2MBï¼Œæ”¾å¤§äº† 512 å€ï¼Œä¼šæ‹–æ…¢å†™æ“ä½œçš„æ‰§è¡Œæ—¶é—´ï¼Œå¯¼è‡´å¤§é‡å†™æ“ä½œæ…¢æŸ¥è¯¢ã€‚

### 41.å¤§ key é—®é¢˜äº†è§£å—ï¼Ÿ

å¤§ key æŒ‡çš„æ˜¯å­˜å‚¨äº†å¤§é‡æ•°æ®çš„é”®ï¼Œæ¯”å¦‚ï¼š

- å•ä¸ªç®€å•çš„ key å­˜å‚¨çš„ value å¾ˆå¤§ï¼Œsize è¶…è¿‡ 10KB
- hashï¼Œsetï¼Œzsetï¼Œlist ä¸­å­˜å‚¨è¿‡å¤šçš„å…ƒç´ ï¼ˆä»¥ä¸‡ä¸ºå•ä½ï¼‰

æ¨èé˜…è¯»ï¼š[é˜¿é‡Œï¼šå‘ç°å¹¶å¤„ç† Redis çš„å¤§ Key å’Œçƒ­ Key](https://help.aliyun.com/zh/redis/user-guide/identify-and-handle-large-keys-and-hotkeys)

**å¤§ key ä¼šé€ æˆä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ**

- å®¢æˆ·ç«¯è€—æ—¶å¢åŠ ï¼Œç”šè‡³è¶…æ—¶
- å¯¹å¤§ key è¿›è¡Œ IO æ“ä½œæ—¶ï¼Œä¼šä¸¥é‡å ç”¨å¸¦å®½å’Œ CPU
- é€ æˆ Redis é›†ç¾¤ä¸­æ•°æ®å€¾æ–œ
- ä¸»åŠ¨åˆ é™¤ã€è¢«åŠ¨åˆ ç­‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´é˜»å¡

**å¦‚ä½•æ‰¾åˆ°å¤§ key?**

â‘ ã€bigkeys å‚æ•°ï¼šä½¿ç”¨ bigkeys å‘½ä»¤ä»¥éå†çš„æ–¹å¼åˆ†æ Redis å®ä¾‹ä¸­çš„æ‰€æœ‰ Keyï¼Œå¹¶è¿”å›æ•´ä½“ç»Ÿè®¡ä¿¡æ¯ä¸æ¯ä¸ªæ•°æ®ç±»å‹ä¸­ Top1 çš„å¤§ Key

> bigkeys å‘½ä»¤çš„ä½¿ç”¨ï¼š`redis-cli --bigkeys`

![](https://cdn.tobebetterjavaer.com/stutymore/redis-20240309091503.png)

â‘¡ã€redis-rdb-toolsï¼šredis-rdb-tools æ˜¯ç”± Python è¯­è¨€ç¼–å†™çš„ç”¨æ¥åˆ†æ Redis ä¸­ rdb å¿«ç…§æ–‡ä»¶çš„å·¥å…·ã€‚

æºç åœ°å€ï¼š[https://github.com/sripathikrishnan/redis-rdb-tools/](https://github.com/sripathikrishnan/redis-rdb-tools/)

> rdbï¼Œå…¨ç§° Redis DataBaseï¼Œæ˜¯ Redis åœ¨å†…å­˜ä¸­çš„æ•°æ®æ ¼å¼çš„ä¸€ç§æŒä¹…åŒ–å­˜å‚¨æ–¹å¼ã€‚

![](https://cdn.tobebetterjavaer.com/stutymore/redis-20240309092121.png)

æ¨èé˜…è¯»ï¼š[RDB è¯¦è§£](https://redisbook.readthedocs.io/en/latest/internal/rdb.html)

**å¦‚ä½•å¤„ç†å¤§ key?**

![å¤§keyå¤„ç†](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e4aaafda-fce1-47f0-8b2b-7261d47b720b.png)

â‘ ã€**åˆ é™¤å¤§ key**

- å½“ Redis ç‰ˆæœ¬å¤§äº 4.0 æ—¶ï¼Œå¯ä½¿ç”¨ UNLINK å‘½ä»¤å®‰å…¨åœ°åˆ é™¤å¤§ Keyï¼Œè¯¥å‘½ä»¤èƒ½å¤Ÿä»¥éé˜»å¡çš„æ–¹å¼ï¼Œé€æ­¥åœ°æ¸…ç†ä¼ å…¥çš„å¤§ Keyã€‚
- å½“ Redis ç‰ˆæœ¬å°äº 4.0 æ—¶ï¼Œå»ºè®®é€šè¿‡ SCAN å‘½ä»¤æ‰§è¡Œå¢é‡è¿­ä»£æ‰«æ keyï¼Œç„¶ååˆ¤æ–­è¿›è¡Œåˆ é™¤ã€‚

â‘¡ã€**å‹ç¼©å’Œæ‹†åˆ† key**

- å½“ vaule æ˜¯ string æ—¶ï¼Œæ¯”è¾ƒéš¾æ‹†åˆ†ï¼Œåˆ™ä½¿ç”¨åºåˆ—åŒ–ã€å‹ç¼©ç®—æ³•å°† key çš„å¤§å°æ§åˆ¶åœ¨åˆç†èŒƒå›´å†…ï¼Œä½†æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–éƒ½ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½æ¶ˆè€—ã€‚
- å½“ value æ˜¯ stringï¼Œå‹ç¼©ä¹‹åä»ç„¶æ˜¯å¤§ key æ—¶ï¼Œåˆ™éœ€è¦è¿›è¡Œæ‹†åˆ†ï¼Œå°†ä¸€ä¸ªå¤§ key åˆ†ä¸ºä¸åŒçš„éƒ¨åˆ†ï¼Œè®°å½•æ¯ä¸ªéƒ¨åˆ†çš„ keyï¼Œä½¿ç”¨ multiget ç­‰æ“ä½œå®ç°äº‹åŠ¡è¯»å–ã€‚
- å½“ value æ˜¯ list/set ç­‰é›†åˆç±»å‹æ—¶ï¼Œæ ¹æ®é¢„ä¼°çš„æ•°æ®è§„æ¨¡æ¥è¿›è¡Œåˆ†ç‰‡ï¼Œä¸åŒçš„å…ƒç´ è®¡ç®—ååˆ†åˆ°ä¸åŒçš„ç‰‡ã€‚

> 1. åä¸º OD çš„é¢è¯•ä¸­å‡ºç°è¿‡è¯¥é¢˜ï¼šè®²ä¸€è®² Redis çš„çƒ­ Key å’Œå¤§ Key

### 42.Redis å¸¸è§æ€§èƒ½é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼Ÿ

1.  Master æœ€å¥½ä¸è¦åšä»»ä½•æŒä¹…åŒ–å·¥ä½œï¼ŒåŒ…æ‹¬å†…å­˜å¿«ç…§å’Œ AOF æ—¥å¿—æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯ä¸è¦å¯ç”¨å†…å­˜å¿«ç…§åšæŒä¹…åŒ–ã€‚
2.  å¦‚æœæ•°æ®æ¯”è¾ƒå…³é”®ï¼ŒæŸä¸ª Slave å¼€å¯ AOF å¤‡ä»½æ•°æ®ï¼Œç­–ç•¥ä¸ºæ¯ç§’åŒæ­¥ä¸€æ¬¡ã€‚
3.  ä¸ºäº†ä¸»ä»å¤åˆ¶çš„é€Ÿåº¦å’Œè¿æ¥çš„ç¨³å®šæ€§ï¼ŒSlave å’Œ Master æœ€å¥½åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘å†…ã€‚
4.  å°½é‡é¿å…åœ¨å‹åŠ›è¾ƒå¤§çš„ä¸»åº“ä¸Šå¢åŠ ä»åº“ã€‚
5.  Master è°ƒç”¨ BGREWRITEAOF é‡å†™ AOF æ–‡ä»¶ï¼ŒAOF åœ¨é‡å†™çš„æ—¶å€™ä¼šå å¤§é‡çš„ CPU å’Œå†…å­˜èµ„æºï¼Œå¯¼è‡´æœåŠ¡ load è¿‡é«˜ï¼Œå‡ºç°çŸ­æš‚æœåŠ¡æš‚åœç°è±¡ã€‚
6.  ä¸ºäº† Master çš„ç¨³å®šæ€§ï¼Œä¸»ä»å¤åˆ¶ä¸è¦ç”¨å›¾çŠ¶ç»“æ„ï¼Œç”¨å•å‘é“¾è¡¨ç»“æ„æ›´ç¨³å®šï¼Œå³ä¸»ä»å…³ä¸ºï¼šMaster<â€“Slave1<â€“Slave2<â€“Slave3â€¦ï¼Œè¿™æ ·çš„ç»“æ„ä¹Ÿæ–¹ä¾¿è§£å†³å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå®ç° Slave å¯¹ Master çš„æ›¿æ¢ï¼Œä¹Ÿå³ï¼Œå¦‚æœ Master æŒ‚äº†ï¼Œå¯ä»¥ç«‹é©¬å¯ç”¨ Slave1 åš Masterï¼Œå…¶ä»–ä¸å˜ã€‚

GitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„å¼€æºçŸ¥è¯†åº“ã€Š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://github.com/itwanger/toBeBetterJavaer)ã€‹ç¬¬ä¸€ç‰ˆ PDF ç»ˆäºæ¥äº†ï¼åŒ…æ‹¬ Java åŸºç¡€è¯­æ³•ã€æ•°ç»„&å­—ç¬¦ä¸²ã€OOPã€é›†åˆæ¡†æ¶ã€Java IOã€å¼‚å¸¸å¤„ç†ã€Java æ–°ç‰¹æ€§ã€ç½‘ç»œç¼–ç¨‹ã€NIOã€å¹¶å‘ç¼–ç¨‹ã€JVM ç­‰ç­‰ï¼Œå…±è®¡ 32 ä¸‡ä½™å­—ï¼Œ500+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯é€šä¿—æ˜“æ‡‚ã€é£è¶£å¹½é»˜â€¦â€¦è¯¦æƒ…æˆ³ï¼š[å¤ªèµäº†ï¼ŒGitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„ Java æ•™ç¨‹](https://javabetter.cn/overview/)

å¾®ä¿¡æœ **æ²‰é»˜ç‹äºŒ** æˆ–æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨äºŒå“¥çš„åŸåˆ›å…¬ä¼—å·æ²‰é»˜ç‹äºŒï¼Œå›å¤ **222** å³å¯å…è´¹é¢†å–ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png)

## Redis åº”ç”¨

### 43.ä½¿ç”¨ Redis å¦‚ä½•å®ç°å¼‚æ­¥é˜Ÿåˆ—ï¼Ÿ

æˆ‘ä»¬çŸ¥é“ redis æ”¯æŒå¾ˆå¤šç§ç»“æ„çš„æ•°æ®ï¼Œé‚£ä¹ˆå¦‚ä½•ä½¿ç”¨ redis ä½œä¸ºå¼‚æ­¥é˜Ÿåˆ—ä½¿ç”¨å‘¢ï¼Ÿ
ä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

- **ä½¿ç”¨ list ä½œä¸ºé˜Ÿåˆ—ï¼Œlpush ç”Ÿäº§æ¶ˆæ¯ï¼Œrpop æ¶ˆè´¹æ¶ˆæ¯**

è¿™ç§æ–¹å¼ï¼Œæ¶ˆè´¹è€…æ­»å¾ªç¯ rpop ä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ¶ˆæ¯ã€‚ä½†æ˜¯è¿™æ ·ï¼Œå³ä½¿é˜Ÿåˆ—é‡Œæ²¡æœ‰æ¶ˆæ¯ï¼Œä¹Ÿä¼šè¿›è¡Œ rpopï¼Œä¼šå¯¼è‡´ Redis CPU çš„æ¶ˆè€—ã€‚
![listä½œä¸ºé˜Ÿåˆ—](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e4b192a1-3ba7-4f4e-98de-e93f437cff7c.png)
å¯ä»¥é€šè¿‡è®©æ¶ˆè´¹è€…ä¼‘çœ çš„æ–¹å¼çš„æ–¹å¼æ¥å¤„ç†ï¼Œä½†æ˜¯è¿™æ ·åˆä¼šåˆæ¶ˆæ¯çš„å»¶è¿Ÿé—®é¢˜ã€‚

-**ä½¿ç”¨ list ä½œä¸ºé˜Ÿåˆ—ï¼Œlpush ç”Ÿäº§æ¶ˆæ¯ï¼Œbrpop æ¶ˆè´¹æ¶ˆæ¯**

brpop æ˜¯ rpop çš„é˜»å¡ç‰ˆæœ¬ï¼Œlist ä¸ºç©ºçš„æ—¶å€™ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ° list ä¸­æœ‰å€¼æˆ–è€…è¶…æ—¶ã€‚
![listä½œä¸ºé˜Ÿåˆ—ï¼Œbrpop](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e9581e51-ffc8-4326-9af4-07816743dc88.png)

è¿™ç§æ–¹å¼åªèƒ½å®ç°ä¸€å¯¹ä¸€çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚

- **ä½¿ç”¨ Redis çš„ pub/sub æ¥è¿›è¡Œæ¶ˆæ¯çš„å‘å¸ƒ/è®¢é˜…**

å‘å¸ƒ/è®¢é˜…æ¨¡å¼å¯ä»¥ 1ï¼šN çš„æ¶ˆæ¯å‘å¸ƒ/è®¢é˜…ã€‚å‘å¸ƒè€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°æŒ‡å®šçš„é¢‘é“é¢‘é“ï¼ˆchannelï¼‰ï¼Œè®¢é˜…ç›¸åº”é¢‘é“çš„å®¢æˆ·ç«¯éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯ã€‚

![pub/sub](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-bc6d05be-3701-4e23-b4ca-6330c949f020.png)
ä½†æ˜¯è¿™ç§æ–¹å¼ä¸æ˜¯å¯é çš„ï¼Œå®ƒä¸ä¿è¯è®¢é˜…è€…ä¸€å®šèƒ½æ”¶åˆ°æ¶ˆæ¯ï¼Œä¹Ÿä¸è¿›è¡Œæ¶ˆæ¯çš„å­˜å‚¨ã€‚

æ‰€ä»¥ï¼Œä¸€èˆ¬çš„å¼‚æ­¥é˜Ÿåˆ—çš„å®ç°è¿˜æ˜¯äº¤ç»™ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚

### 44.Redis å¦‚ä½•å®ç°å»¶æ—¶é˜Ÿåˆ—?

å¯ä»¥ä½¿ç”¨ Redis çš„ zsetï¼ˆæœ‰åºé›†åˆï¼‰æ¥å®ç°å»¶æ—¶é˜Ÿåˆ—ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šzsetå®ç°å»¶æ—¶é˜Ÿåˆ—](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-54bbcc36-0b00-4142-a6eb-bf2ef48c2213.png)

ç¬¬ä¸€æ­¥ï¼Œå°†ä»»åŠ¡æ·»åŠ åˆ° zset ä¸­ï¼Œscore ä¸ºä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æˆ³ï¼Œvalue ä¸ºä»»åŠ¡çš„å†…å®¹ã€‚

```bash
ZADD delay_queue 1617024000 task1
```

ç¬¬äºŒæ­¥ï¼Œå®šæœŸï¼ˆä¾‹å¦‚æ¯ç§’ï¼‰ä» zset ä¸­è·å– score å°äºå½“å‰æ—¶é—´æˆ³çš„ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œä»»åŠ¡ã€‚

```bash
ZREMRANGEBYSCORE delay_queue -inf 1617024000
```

ç¬¬ä¸‰æ­¥ï¼Œä»»åŠ¡æ‰§è¡Œåï¼Œä» zset ä¸­åˆ é™¤ä»»åŠ¡ã€‚

```bash
ZREM delay_queue task1
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 23 QQ åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis å®ç°å»¶è¿Ÿé˜Ÿåˆ—
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 8 Java åç«¯å®ä¹ ä¸€é¢é¢è¯•åŸé¢˜ï¼šredis æ•°æ®ç»“æ„ï¼Œç”¨ä»€ä¹ˆç»“æ„å®ç°å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—

### 45.Redis æ”¯æŒäº‹åŠ¡å—ï¼Ÿ

Redis æ”¯æŒç®€å•çš„äº‹åŠ¡ï¼Œå¯ä»¥å°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§çš„ï¼ŒæŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚ä¸»è¦é€šè¿‡ multiã€execã€discardã€watch ç­‰å‘½ä»¤æ¥å®ç°ï¼š

- multiï¼šæ ‡è®°ä¸€ä¸ªäº‹åŠ¡å—çš„å¼€å§‹
- execï¼šæ‰§è¡Œæ‰€æœ‰äº‹åŠ¡å—å†…çš„å‘½ä»¤
- discardï¼šå–æ¶ˆäº‹åŠ¡ï¼Œæ”¾å¼ƒæ‰§è¡Œäº‹åŠ¡å—å†…çš„æ‰€æœ‰å‘½ä»¤
- watchï¼šç›‘è§†ä¸€ä¸ªæˆ–å¤šä¸ª keyï¼Œå¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¿™ä¸ª key è¢«å…¶ä»–å‘½ä»¤æ‰€æ”¹åŠ¨ï¼Œé‚£ä¹ˆäº‹åŠ¡å°†è¢«æ‰“æ–­

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedis äº‹åŠ¡](https://cdn.tobebetterjavaer.com/stutymore/redis-20240314101439.png)

#### è¯´ä¸€ä¸‹ Redis äº‹åŠ¡çš„åŸç†ï¼Ÿ

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedisäº‹åŠ¡](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-2ed7ae21-16a6-4716-ac89-117a8c76d3db.png)

- ä½¿ç”¨ MULTI å‘½ä»¤å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ã€‚ä»è¿™ä¸ªå‘½ä»¤æ‰§è¡Œä¹‹åå¼€å§‹ï¼Œæ‰€æœ‰çš„åç»­å‘½ä»¤éƒ½ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¢«æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒRedis åªæ˜¯è®°å½•ä¸‹äº†è¿™äº›å‘½ä»¤ã€‚
- ä½¿ç”¨ EXEC å‘½ä»¤è§¦å‘äº‹åŠ¡çš„æ‰§è¡Œã€‚ä¸€æ—¦æ‰§è¡Œäº† EXECï¼Œä¹‹å‰ MULTI åé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤ä¼šè¢«åŸå­åœ°ï¼ˆatomicï¼‰æ‰§è¡Œã€‚è¿™é‡Œçš„â€œåŸå­â€æ„å‘³ç€è¿™äº›å‘½ä»¤è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆï¼ˆåœ¨å‡ºç°é”™è¯¯æ—¶ï¼‰å…¨éƒ¨ä¸æ‰§è¡Œã€‚
- å¦‚æœåœ¨æ‰§è¡Œ EXEC ä¹‹å‰å†³å®šä¸æ‰§è¡Œäº‹åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ DISCARD å‘½ä»¤æ¥å–æ¶ˆäº‹åŠ¡ã€‚è¿™ä¼šæ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—å¹¶é€€å‡ºäº‹åŠ¡çŠ¶æ€ã€‚
- WATCH å‘½ä»¤ç”¨äºå®ç°ä¹è§‚é”ã€‚WATCH å‘½ä»¤å¯ä»¥ç›‘è§†ä¸€ä¸ªæˆ–å¤šä¸ªé”®ï¼Œå¦‚æœåœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­ï¼ˆå³åœ¨æ‰§è¡Œ MULTI ä¹‹åï¼Œæ‰§è¡Œ EXEC ä¹‹å‰ï¼‰ï¼Œè¢«ç›‘è§†çš„é”®è¢«å…¶ä»–å‘½ä»¤æ”¹å˜äº†ï¼Œé‚£ä¹ˆå½“æ‰§è¡Œ EXEC æ—¶ï¼Œäº‹åŠ¡å°†è¢«å–æ¶ˆï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚

#### Redis äº‹åŠ¡çš„æ³¨æ„ç‚¹æœ‰å“ªäº›ï¼Ÿ

Redis äº‹åŠ¡æ˜¯ä¸æ”¯æŒå›æ»šçš„ï¼Œä¸€æ—¦ EXEC å‘½ä»¤è¢«è°ƒç”¨ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå³ä½¿æœ‰äº›å‘½ä»¤å¯èƒ½æ‰§è¡Œå¤±è´¥ã€‚

#### Redis äº‹åŠ¡ä¸ºä»€ä¹ˆä¸æ”¯æŒå›æ»šï¼Ÿ

å¼•å…¥äº‹åŠ¡å›æ»šæœºåˆ¶ä¼šå¤§å¤§å¢åŠ  Redis çš„å¤æ‚æ€§ï¼Œå› ä¸ºéœ€è¦è·Ÿè¸ªäº‹åŠ¡ä¸­æ¯ä¸ªå‘½ä»¤çš„çŠ¶æ€ï¼Œå¹¶åœ¨å‘ç”Ÿé”™è¯¯æ—¶é€†å‘æ‰§è¡Œå‘½ä»¤ä»¥æ¢å¤åŸå§‹çŠ¶æ€ã€‚

Redis æ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œå…¶è®¾è®¡é‡ç‚¹æ˜¯å®ç°é«˜æ€§èƒ½ã€‚äº‹åŠ¡å›æ»šéœ€è¦é¢å¤–çš„èµ„æºå’Œæ—¶é—´æ¥ç®¡ç†å’Œæ‰§è¡Œï¼Œè¿™ä¸ Redis çš„è®¾è®¡ç›®æ ‡ç›¸è¿èƒŒã€‚å› æ­¤ï¼ŒRedis é€‰æ‹©ä¸æ”¯æŒäº‹åŠ¡å›æ»šã€‚

æ¢å¥è¯è¯´ï¼Œ**å°±æ˜¯æˆ‘ Redis ä¸æƒ³æ”¯æŒäº‹åŠ¡ï¼Œä¹Ÿæ²¡æœ‰è¿™ä¸ªå¿…è¦**ã€‚

#### Redis äº‹åŠ¡çš„ ACID ç‰¹æ€§å¦‚ä½•ä½“ç°ï¼Ÿ

ACID ä¸€èˆ¬æŒ‡ MySQL äº‹åŠ¡ä¸­çš„å››ä¸ªç‰¹æ€§ï¼šåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ã€‚è™½ç„¶ Redis æä¾›äº†äº‹åŠ¡çš„æ”¯æŒï¼Œä½†å®ƒåœ¨ ACID ä¸Šçš„è¡¨ç°ä¸ MySQL æœ‰æ‰€ä¸åŒã€‚

Redis äº‹åŠ¡ä¸­ï¼Œæ‰€æœ‰å‘½ä»¤ä¼šä¾æ¬¡æ‰§è¡Œï¼Œä½†å¹¶ä¸æ”¯æŒéƒ¨åˆ†å¤±è´¥åçš„è‡ªåŠ¨å›æ»šã€‚å› æ­¤ Redis åœ¨äº‹åŠ¡å±‚é¢å¹¶ä¸èƒ½ä¿è¯ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡ç¨‹åºé€»è¾‘æ¥è¿›è¡Œä¼˜åŒ–ã€‚

Redis äº‹åŠ¡åœ¨ä¸€å®šç¨‹åº¦ä¸Šæä¾›äº†éš”ç¦»æ€§ï¼Œäº‹åŠ¡ä¸­çš„å‘½ä»¤ä¼šæŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤æ’å…¥ã€‚

Redis çš„æŒä¹…æ€§ä¾èµ–äºå…¶æŒä¹…åŒ–æœºåˆ¶ï¼ˆå¦‚ RDB å’Œ AOFï¼‰ï¼Œè€Œä¸æ˜¯äº‹åŠ¡æœ¬èº«ã€‚

#### Redisäº‹åŠ¡æ»¡è¶³åŸå­æ€§å—ï¼Ÿè¦æ€ä¹ˆæ”¹è¿›ï¼Ÿ

ä¸æ»¡è¶³ï¼ŒRedis äº‹åŠ¡ä¸æ”¯æŒå›æ»šï¼Œä¸€æ—¦ EXEC å‘½ä»¤è¢«è°ƒç”¨ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå³ä½¿æœ‰äº›å‘½ä»¤å¯èƒ½æ‰§è¡Œå¤±è´¥ã€‚

å¯ä»¥é€šè¿‡ Lua è„šæœ¬æ¥å®ç°äº‹åŠ¡çš„åŸå­æ€§ï¼ŒLua è„šæœ¬åœ¨ Redis ä¸­æ˜¯åŸå­æ‰§è¡Œçš„ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­é—´ä¸ä¼šæ’å…¥å…¶ä»–å‘½ä»¤ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åä¸ºä¸€é¢åŸé¢˜ï¼šè¯´ä¸‹ Redis äº‹åŠ¡
> 2. [äºŒå“¥ç¼–ç¨‹æ˜Ÿçƒ](https://javabetter.cn/zhishixingqiu/)çƒå‹[æ•äº‘çœ ç¾å›¢ AI é¢è¯•åŸé¢˜](https://t.zsxq.com/BaHOh)ï¼šä»€ä¹ˆæ˜¯ redis çš„äº‹åŠ¡ï¼Œå®ƒçš„ ACID å±æ€§å¦‚ä½•ä½“ç°


### 46.æœ‰ Lua è„šæœ¬æ“ä½œ Redis çš„ç»éªŒå—ï¼Ÿ

Redis çš„äº‹åŠ¡ä¸å…·å¤‡å¼ºåˆ¶æ€§çš„åŸå­æ€§ï¼Œä½†å¯ä»¥é€šè¿‡ Lua è„šæœ¬æ¥å¢å¼º Redis çš„åŸå­èƒ½åŠ›ã€‚

åœ¨ Redis ä¸­ï¼ŒLua è„šæœ¬æ˜¯ä»¥åŸå­æ“ä½œçš„æ–¹å¼æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è„šæœ¬æ‰§è¡ŒæœŸé—´ï¼Œä¸ä¼šæ’å…¥å…¶ä»–å‘½ä»¤ï¼Œå¤©ç„¶ä¿è¯äº†äº‹åŠ¡æ€§ã€‚

æ¯”å¦‚ç§’æ€ç³»ç»Ÿæ˜¯ä¸€ä¸ªç»å…¸åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Lua è„šæœ¬æ¥å®ç°æ‰£å‡ Redis åº“å­˜çš„åŠŸèƒ½ã€‚

```java
-- åº“å­˜æœªé¢„çƒ­
if (redis.call('exists', KEYS[2]) == 1) then
    return -9;
end;
-- ç§’æ€å•†å“åº“å­˜å­˜åœ¨
if (redis.call('exists', KEYS[1]) == 1) then
    local stock = tonumber(redis.call('get', KEYS[1]));
    local num = tonumber(ARGV[1]);
    -- å‰©ä½™åº“å­˜å°‘äºè¯·æ±‚æ•°é‡
    if (stock < num) then
        return -3
    end;
    -- æ‰£å‡åº“å­˜
    if (stock >= num) then
        redis.call('incrby', KEYS[1], 0 - num);
        -- æ‰£å‡æˆåŠŸ
        return 1
    end;
    return -2;
end;
-- ç§’æ€å•†å“åº“å­˜ä¸å­˜åœ¨
return -1;
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¿«æ‰‹åŒå­¦ 4 ä¸€é¢åŸé¢˜ï¼šRedisäº‹åŠ¡æ»¡è¶³åŸå­æ€§å—ï¼Ÿè¦æ€ä¹ˆæ”¹è¿›ï¼Ÿ

### 47.Redis çš„ç®¡é“Pipelineäº†è§£å—ï¼Ÿ

Pipeline æ˜¯ Redis æä¾›çš„ä¸€ç§ä¼˜åŒ–æ‰‹æ®µï¼Œå…è®¸å®¢æˆ·ç«¯ä¸€æ¬¡æ€§å‘æœåŠ¡å™¨å‘é€å¤šä¸ªå‘½ä»¤ï¼Œè€Œä¸å¿…ç­‰å¾…æ¯ä¸ªå‘½ä»¤çš„å“åº”ï¼Œä»è€Œå‡å°‘ç½‘ç»œå»¶è¿Ÿã€‚å®ƒçš„å·¥ä½œåŸç†ç±»ä¼¼äºæ‰¹é‡æ“ä½œï¼Œå³å¤šä¸ªå‘½ä»¤ä¸€æ¬¡æ€§æ‰“åŒ…å‘é€ï¼ŒRedis æœåŠ¡å™¨ä¾æ¬¡æ‰§è¡Œåå†å°†ç»“æœä¸€æ¬¡æ€§è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

é€šå¸¸åœ¨ Redis ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šéµå¾ªä»¥ä¸‹æµç¨‹ï¼š

1. å®¢æˆ·ç«¯å‘é€å‘½ä»¤åˆ°æœåŠ¡å™¨ã€‚
2. æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤å¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚
3. å®¢æˆ·ç«¯æ¥æ”¶è¿”å›ç»“æœã€‚

æ¯ä¸€ä¸ªè¯·æ±‚å’Œå“åº”ä¹‹é—´å­˜åœ¨ä¸€æ¬¡ç½‘ç»œé€šä¿¡çš„å¾€è¿”æ—¶é—´ï¼ˆRTTï¼ŒRound-Trip Timeï¼‰ï¼Œå¦‚æœå¤§é‡è¯·æ±‚ä¾æ¬¡å‘é€ï¼Œç½‘ç»œå»¶è¿Ÿä¼šæ˜¾è‘—å¢åŠ è¯·æ±‚çš„æ€»æ‰§è¡Œæ—¶é—´ã€‚

æœ‰äº† Pipeline åï¼Œæµç¨‹å˜ä¸ºï¼š

>å‘é€å‘½ä»¤1ã€å‘½ä»¤2ã€å‘½ä»¤3â€¦â€¦ -> æœåŠ¡å™¨å¤„ç† -> ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰ç»“æœã€‚

ä¾‹å¦‚ï¼Œæ‰¹é‡å†™å…¥å¤§é‡æ•°æ®æˆ–æ‰§è¡Œä¸€ç³»åˆ—æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥å°†è¿™äº›æ“ä½œæ‰“åŒ…é€šè¿‡ Pipeline æ‰§è¡Œã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šPipeliningç¤ºæ„å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-38aee4c1-efd2-495e-8a6d-164d21a129b1.png)

åœ¨ Pipeline æ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯ä¸ä¼šåœ¨æ¯æ¡å‘½ä»¤å‘é€åç«‹å³ç­‰å¾… Redis çš„å“åº”ï¼Œè€Œæ˜¯å°†å¤šä¸ªå‘½ä»¤ä¾æ¬¡å†™å…¥ TCP ç¼“å†²åŒºï¼Œæ‰€æœ‰å‘½ä»¤ä¸€èµ·å‘é€åˆ° Redis æœåŠ¡å™¨ã€‚

Redis æœåŠ¡å™¨æ¥æ”¶åˆ°æ‰¹é‡å‘½ä»¤åï¼Œä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå‘½ä»¤ã€‚

Redis æœåŠ¡å™¨æ‰§è¡Œå®Œæ‰€æœ‰å‘½ä»¤åï¼Œå°†æ¯æ¡å‘½ä»¤çš„ç»“æœä¸€æ¬¡æ€§æ‰“åŒ…é€šè¿‡ TCP è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

å®¢æˆ·ç«¯ä¸€æ¬¡æ€§æ¥æ”¶æ‰€æœ‰è¿”å›ç»“æœï¼Œå¹¶è§£ææ¯ä¸ªå‘½ä»¤çš„æ‰§è¡Œç»“æœã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 8 é¢è¯•åŸé¢˜ï¼šå¯¹pipelineçš„ç†è§£ï¼Œä»€ä¹ˆåœºæ™¯é€‚åˆä½¿ç”¨pipelineï¼Ÿæœ‰äº†è§£è¿‡pipelineçš„åº•å±‚ï¼Ÿ 

### 48.Redis å®ç°åˆ†å¸ƒå¼é”äº†è§£å—ï¼Ÿ

åˆ†å¸ƒå¼é”æ˜¯ä¸€ç§ç”¨äºæ§åˆ¶å¤šä¸ªä¸åŒè¿›ç¨‹åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è®¿é—®å…±äº«èµ„æºçš„é”æœºåˆ¶ã€‚å®ƒç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å¯¹èµ„æºè¿›è¡Œè®¿é—®ï¼Œä»è€Œé¿å…å¹¶å‘é—®é¢˜ã€‚

**å¯ä»¥ä½¿ç”¨ Redis çš„ SET å‘½ä»¤å®ç°åˆ†å¸ƒå¼é”**ã€‚åŒæ—¶æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Œä»¥é˜²æ­¢æ­»é”çš„å‘ç”Ÿã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šsetåŸå­å‘½ä»¤](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-710cdd19-98ea-4e96-b579-ff1ebb0d5de9.png)

```
SET key value NX PX 30000
```

- `key` æ˜¯é”åã€‚
- `value` æ˜¯é”çš„æŒæœ‰è€…æ ‡è¯†ï¼Œå¯ä»¥ä½¿ç”¨ UUID ä½œä¸º valueã€‚
- `NX` åªåœ¨ key ä¸å­˜åœ¨æ—¶æ‰åˆ›å»ºï¼ˆé¿å…è¦†ç›–é”ï¼‰ã€‚
- `PX 30000`ï¼šè®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ä¸º 30 ç§’ï¼ˆé˜²æ­¢æ­»é”ï¼‰ã€‚

ç”¨ Java æ¥å®ç°å°±æ˜¯ï¼š

```java
String lockKey = "lock:order:123";
String uniqueId = UUID.randomUUID().toString();
boolean isLocked = redisTemplate.opsForValue()
    .setIfAbsent(lockKey, uniqueId, 10, TimeUnit.SECONDS);
if (isLocked) {
    try {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    } finally {
        // é‡Šæ”¾é”
    }
}
```

#### ä»€ä¹ˆæ˜¯ setnxï¼Ÿ

setnx ä» Redis ç‰ˆæœ¬ 2.6.12 å¼€å§‹è¢«å¼ƒç”¨ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡ set å‘½ä»¤çš„ NX é€‰é¡¹æ¥å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚

![æˆªå›¾æ¥è‡ªRedis docs](https://cdn.tobebetterjavaer.com/stutymore/redis-20241122182250.png)

ä½¿ç”¨ setnx åˆ›å»ºåˆ†å¸ƒå¼é”æ—¶ï¼Œè™½ç„¶è®¾ç½®è¿‡æœŸæ—¶é—´å¯ä»¥é¿å…æ­»é”é—®é¢˜ï¼Œä½†å¯èƒ½å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼šçº¿ç¨‹ A è·å–é”åå¼€å§‹ä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”çš„è¿‡æœŸæ—¶é—´ï¼Œé”ä¼šæå‰é‡Šæ”¾ï¼Œå¯¼è‡´çº¿ç¨‹ B ä¹Ÿè·å–äº†é”å¹¶å¼€å§‹æ‰§è¡Œä»»åŠ¡ã€‚è¿™ä¼šç ´åé”çš„ç‹¬å æ€§ï¼Œå¯¼è‡´å¹¶å‘è®¿é—®èµ„æºï¼Œè¿›è€Œé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚

![æŠ€æœ¯æ´¾ï¼šRedis é”](https://cdn.tobebetterjavaer.com/stutymore/redis-20241122191044.png)

å¯ä»¥å¼•å…¥é”çš„è‡ªåŠ¨ç»­çº¦æœºåˆ¶ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å®šæœŸç»­æœŸï¼Œç¡®ä¿é”åœ¨ä»»åŠ¡å®Œæˆä¹‹å‰ä¸ä¼šè¿‡æœŸã€‚

![æŠ€æœ¯æ´¾ï¼šredisson çœ‹é—¨ç‹—](https://cdn.tobebetterjavaer.com/stutymore/redis-20241122192038.png)

æ¯”å¦‚è¯´ Redisson çš„ RedissonLock å°±æ”¯æŒè‡ªåŠ¨ç»­æœŸï¼Œé€šè¿‡çœ‹é—¨ç‹—æœºåˆ¶å®šæœŸç»­æœŸé”çš„æœ‰æ•ˆæœŸã€‚

![äºŒå“¥çš„Java è¿›é˜¶ä¹‹è·¯ï¼šrenewExpirationAsync](https://cdn.tobebetterjavaer.com/stutymore/redis-20241122192708.png)

#### Redisson äº†è§£å—ï¼Ÿ

å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸“ä¸šçš„è½®å­â€”â€”[Redisson](https://xie.infoq.cn/article/d8e897f768eb1a358a0fd6300)ã€‚

![å›¾ç‰‡æ¥æºäºç½‘ç»œ](https://cdn.tobebetterjavaer.com/stutymore/redis-20240308174708.png)

Redisson æ˜¯ä¸€ä¸ªåŸºäº Redis çš„ Java é©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼Œæä¾›äº†ä¸€ç³»åˆ— API ç”¨æ¥æ“ä½œ Redisï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„åŠŸèƒ½å°±æ˜¯åˆ†å¸ƒå¼é”ã€‚

```java
RLock lock = redisson.getLock("lock");
lock.lock();
try {
    // do something
} finally {
    lock.unlock();
}
```

å®ç°æºç åœ¨ RedissonLock ç±»ä¸­ï¼Œé€šè¿‡ Lua è„šæœ¬å°è£… Redis å‘½ä»¤æ¥å®ç°ï¼Œæ¯”å¦‚è¯´ tryLockInnerAsync æºç ï¼š

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedissonLock](https://cdn.tobebetterjavaer.com/stutymore/redis-20240425120229.png)

å…¶ä¸­ hincrby å‘½ä»¤ç”¨äºå¯¹å“ˆå¸Œè¡¨ä¸­çš„å­—æ®µå€¼æ‰§è¡Œè‡ªå¢æ“ä½œï¼Œpexpire å‘½ä»¤ç”¨äºè®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ã€‚

#### PmHub ç³»ç»Ÿé‡Œé¢çš„åˆ†å¸ƒå¼é”æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

ä¸»è¦é€šè¿‡ Redisson æ¡†æ¶å®ç°çš„ RedLock æ¥å®Œæˆçš„ã€‚

```java
// åˆ›å»º Redisson å®¢æˆ·ç«¯é…ç½®
Config config = new Config();
config.useClusterServers()
        .addNodeAddress("redis://127.0.0.1:6379",
                "redis://127.0.0.1:6380",
                "redis://127.0.0.1:6381"); // å‡è®¾æœ‰ä¸‰ä¸ª Redis èŠ‚ç‚¹
// åˆ›å»º Redisson å®¢æˆ·ç«¯å®ä¾‹
RedissonClient redissonClient = Redisson.create(config);
// åˆ›å»º RedLock å¯¹è±¡
RLock redLock = redissonClient.getLock("lock_key");

try {
    // å°è¯•è·å–åˆ†å¸ƒå¼é”ï¼Œæœ€å¤šå°è¯• 5 ç§’è·å–é”ï¼Œå¹¶ä¸”é”çš„æœ‰æ•ˆæœŸä¸º 5000 æ¯«ç§’
    boolean lockAcquired = redLock.tryLock(5, 5000, TimeUnit.MILLISECONDS);
    if (lockAcquired) {
        // åŠ é”æˆåŠŸï¼Œæ‰§è¡Œä¸šåŠ¡ä»£ç ...
    } else {
        System.out.println("Failed to acquire the lock!");
    }
} catch (InterruptedException e) {
    Thread.currentThread().interrupt();
    System.err.println("Interrupted while acquiring the lock");
} finally {
    // æ— è®ºæ˜¯å¦æˆåŠŸè·å–åˆ°é”ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘ç»“æŸåéƒ½è¦é‡Šæ”¾é”
    if (redLock.isLocked()) {
        redLock.unlock();
    }
    // å…³é—­ Redisson å®¢æˆ·ç«¯è¿æ¥
    redissonClient.shutdown();
}
```

#### ä½ æåˆ°äº†Redlockï¼Œé‚£å®ƒæœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

Redlock æ˜¯ Redis ä½œè€…æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼é”å®ç°æ–¹æ¡ˆï¼Œç”¨äºç¡®ä¿åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å®‰å…¨å¯é åœ°è·å–é”ã€‚å®ƒçš„ç›®æ ‡æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æä¾›ä¸€ç§é«˜å¯ç”¨ã€é«˜å®¹é”™çš„é”æœºåˆ¶ï¼Œç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½å¤ŸæˆåŠŸè·å¾—é”ï¼Œä»è€Œå®ç°å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ã€‚

Redisson ä¸­çš„ RedLock æ˜¯åŸºäº RedissonMultiLockï¼ˆè”é”ï¼‰å®ç°çš„ã€‚

![äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯ï¼šRedissonRedLock](https://cdn.tobebetterjavaer.com/stutymore/redis-20240816113330.png)

RedissonMultiLock çš„ tryLock æ–¹æ³•ä¼šåœ¨æŒ‡å®šçš„ Redis å®ä¾‹ä¸Šé€ä¸€å°è¯•è·å–é”ã€‚

åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­ï¼ŒRedlock ä¼šæ ¹æ®é…ç½®çš„ waitTimeï¼ˆæœ€å¤§ç­‰å¾…æ—¶é—´ï¼‰å’Œ leaseTimeï¼ˆé”çš„æŒæœ‰æ—¶é—´ï¼‰è¿›è¡Œçµæ´»æ§åˆ¶ã€‚æ¯”å¦‚ï¼Œå¦‚æœè·å–é”çš„æ—¶é—´å°äºé”çš„æœ‰æ•ˆæœŸï¼ˆé€šè¿‡TTLå‘½ä»¤è·å–é”çš„å‰©ä½™æ—¶é—´ï¼‰ï¼Œåˆ™è¡¨ç¤ºè·å–é”æˆåŠŸã€‚

é€šå¸¸ï¼Œè‡³å°‘éœ€è¦å¤šæ•°ï¼ˆå¦‚ 5 ä¸ªå®ä¾‹ä¸­çš„ 3 ä¸ªï¼‰å®ä¾‹æˆåŠŸè·å–é”ï¼Œæ‰èƒ½è®¤ä¸ºæ•´ä¸ªé”è·å–æˆåŠŸã€‚

å¦‚æœæŒ‡å®šäº†é”çš„æŒæœ‰æ—¶é—´ï¼ˆleaseTimeï¼‰ï¼Œåœ¨æˆåŠŸè·å–é”åï¼ŒRedlock ä¼šä¸ºé”è¿›è¡Œç»­æœŸï¼Œä»¥é˜²æ­¢é”åœ¨æ“ä½œå®Œæˆä¹‹å‰æ„å¤–å¤±æ•ˆã€‚

#### çº¢é”èƒ½ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾ä¸Šé”ï¼Ÿ

Redlock ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾ä¸Šé”ï¼Œå› ä¸ºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œå»¶è¿Ÿã€æ—¶é’Ÿæ¼‚ç§»ã€Redis å®ä¾‹å®•æœºç­‰å› ç´ éƒ½å¯èƒ½å¯¼è‡´é”çš„è·å–å¤±è´¥ã€‚

#### åŠ åˆ†å¸ƒå¼é”æ—¶Rediså¦‚ä½•ä¿è¯ä¸ä¼šå‘ç”Ÿå†²çªï¼Ÿ

â‘ ã€ä½¿ç”¨ SET NX PX æˆ– SETNX å‘½ä»¤ç¡®ä¿é”çš„è·å–æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼ŒåŒæ—¶è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´é˜²æ­¢æ­»é”ã€‚

æ¯”å¦‚è¯´ `SET lock_key unique_value NX PX 5000` å‘½ä»¤ï¼Œå…¶ä¸­ `NX` ç¡®ä¿äº†åŸå­æ“ä½œï¼Œï¼Œå¦‚æœ lock_key å·²å­˜åœ¨ï¼ŒSET æ“ä½œä¼šè¿”å› nilï¼›`PX 5000` è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 5000 æ¯«ç§’ï¼Œé¿å…æ­»é”ã€‚

â‘¡ã€ä½¿ç”¨ Lua è„šæœ¬å°†é”çš„æ£€æŸ¥å’Œé‡Šæ”¾æ“ä½œå°è£…ä¸ºä¸€ä¸ªåŸå­æ“ä½œï¼Œç¡®ä¿å®‰å…¨åœ°é‡Šæ”¾é”ã€‚

```
EVAL "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end" 1 lock_key unique_value
```

â‘¢ã€ä½¿ç”¨ Redlock ç®—æ³•ç¡®ä¿é”çš„æ­£ç¡®è·å–å’Œé‡Šæ”¾ã€‚

```java
RLock lock = redisson.getLock("lock_key");
try {
    // 500ms ç­‰å¾…æ—¶é—´ï¼Œ10000ms é”è¿‡æœŸæ—¶é—´
    boolean isLocked = lock.tryLock(500, 10000, TimeUnit.MILLISECONDS);
    if (isLocked) {
        // æ‰§è¡Œéœ€è¦åŒæ­¥çš„æ“ä½œ
    }
} finally {
    lock.unlock();
}
```

#### Redisson ä¸­çš„çœ‹é—¨ç‹—æœºåˆ¶äº†è§£å—ï¼Ÿ

Redisson æä¾›çš„åˆ†å¸ƒå¼é”æ˜¯æ”¯æŒé”è‡ªåŠ¨ç»­æœŸçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœçº¿ç¨‹åœ¨é”åˆ°æœŸä¹‹å‰è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œé‚£ä¹ˆ Redisson ä¼šè‡ªåŠ¨ç»™é”ç»­æœŸã€‚

![éƒ­æ…•è£åšå®¢å›­ï¼šçœ‹é—¨ç‹—](https://cdn.tobebetterjavaer.com/stutymore/redis-20240918110433.png)

è¿™è¢«ç§°ä¸ºâ€œçœ‹é—¨ç‹—â€æœºåˆ¶ã€‚

```java
class RedissonWatchdogExample {
    public static void main(String[] args) {
        // é…ç½® Redisson å®¢æˆ·ç«¯
        Config config = new Config();
        config.useSingleServer().setAddress("redis://127.0.0.1:6379");
        RedissonClient redisson = Redisson.create(config);

        // è·å–é”å¯¹è±¡
        RLock lock = redisson.getLock("myLock");

        try {
            // è·å–é”ï¼Œé»˜è®¤çœ‹é—¨ç‹—æœºåˆ¶ä¼šå¯åŠ¨
            lock.lock();

            // æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œ
            System.out.println("Task is running...");
            Thread.sleep(40000); // æ¨¡æ‹Ÿé•¿æ—¶é—´ä»»åŠ¡ï¼ˆ40ç§’ï¼‰

            System.out.println("Task completed.");
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            // é‡Šæ”¾é”
            lock.unlock();
        }

        // å…³é—­ Redisson å®¢æˆ·ç«¯
        redisson.shutdown();
    }
}
```

çœ‹é—¨ç‹—å¯åŠ¨åï¼Œæ¯éš” 10 ç§’ä¼šåˆ·æ–°é”çš„è¿‡æœŸæ—¶é—´ï¼Œå°†å…¶å»¶é•¿åˆ° 30 ç§’ï¼Œç¡®ä¿åœ¨é”æŒæœ‰æœŸé—´ä¸ä¼šå› ä¸ºè¿‡æœŸè€Œé‡Šæ”¾ã€‚

å½“ä»»åŠ¡æ‰§è¡Œå®Œæˆæ—¶ï¼Œå®¢æˆ·ç«¯è°ƒç”¨ `unlock()` æ–¹æ³•é‡Šæ”¾é”ï¼Œçœ‹é—¨ç‹—ä¹Ÿéšä¹‹åœæ­¢ã€‚

#### æ£€æŸ¥é”çš„è¿‡ç¨‹æ˜¯åŸå­æ“ä½œå—ï¼Ÿ

åœ¨ Redis çš„çœ‹é—¨ç‹—æœºåˆ¶ä¸­ï¼Œæ£€æŸ¥é”çš„è¿‡ç¨‹å¹¶ä¸æ˜¯å•ç‹¬çš„ä¸€ä¸ªæ­¥éª¤ï¼Œè€Œæ˜¯ä¸é”çš„ç»­æœŸæ“ä½œç»‘å®šåœ¨ä¸€èµ·ï¼Œé€šè¿‡ Lua è„šæœ¬å®Œæˆçš„ã€‚å› æ­¤ï¼Œæ£€æŸ¥ä¸ç»­æœŸæ˜¯ä¸€ä¸ªæ•´ä½“çš„åŸå­æ“ä½œï¼Œä»¥ç¡®ä¿åªæœ‰æŒæœ‰é”çš„å®¢æˆ·ç«¯æ‰èƒ½æˆåŠŸç»­æœŸã€‚

```java
if redis.call('get', KEYS[1]) == ARGV[1] then
    return redis.call('expire', KEYS[1], ARGV[2])
else
    return 0
end
```


> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯ Java åç«¯å®ä¹ ä¸€é¢åŸé¢˜ï¼šåˆ†å¸ƒå¼é”ç”¨äº† Redis çš„ä»€ä¹ˆæ•°æ®ç»“æ„
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°å…¬å¸é¢ç»åˆé›†åŒå­¦ 1 Java åç«¯é¢è¯•åŸé¢˜ï¼šRedisson çš„åº•å±‚åŸç†ï¼Ÿä»¥åŠä¸ SETNX çš„åŒºåˆ«ï¼Ÿ
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç™¾åº¦é¢ç»åŒå­¦ 1 æ–‡å¿ƒä¸€è¨€ 25 å®ä¹  Java åç«¯é¢è¯•åŸé¢˜ï¼šredis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ï¼Ÿsetnxï¼Ÿ
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³åŒå­¦ F é¢è¯•åŸé¢˜ï¼šè‡ªå·±å®ç° redis åˆ†å¸ƒå¼é”çš„å‘ï¼ˆä¸»åŠ¨æäº† Redissionï¼‰
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯äº‘æ™ºé¢ç»åŒå­¦ 20 äºŒé¢é¢è¯•åŸé¢˜ï¼šredission çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ setnx + lua è„šæœ¬ï¼Ÿ
> 6. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æ”¶é’±å§é¢ç»åŒå­¦ 1 Java åç«¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šç³»ç»Ÿé‡Œé¢åˆ†å¸ƒå¼é”æ˜¯æ€ä¹ˆåšçš„ï¼Ÿä½ æåˆ°äº†redlockï¼Œé‚£å®ƒæœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿçº¢é”èƒ½ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾ä¸Šé”ï¼Ÿ
> 7. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 21  æŠ–éŸ³å•†åŸä¸€é¢é¢è¯•åŸé¢˜ï¼šåŠ åˆ†å¸ƒå¼é”æ—¶rediså¦‚ä½•ä¿è¯ä¸ä¼šå‘ç”Ÿå†²çªï¼Ÿåˆ†å¸ƒå¼é”è¿‡æœŸæ€ä¹ˆåŠï¼Ÿ
> 8. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æ‹¼å¤šå¤šé¢ç»åŒå­¦ 8 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedisåˆ†å¸ƒå¼é”å¦‚ä½•å®ç°çš„
> 9. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç™¾åº¦åŒå­¦ 4 é¢è¯•åŸé¢˜ï¼šSetnx,çŸ¥é“å—? ç”¨è¿™ä¸ªåŠ é”æœ‰ä»€ä¹ˆé—®é¢˜å—?æ€ä¹ˆè§£å†³?
> 10. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„é˜¿é‡Œç³»é¢ç»åŒå­¦ 19 é¥¿äº†ä¹ˆé¢è¯•åŸé¢˜ï¼šåˆ†å¸ƒå¼é”ç”¨rediså®ç°æ€è·¯
> 11. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„äº¬ä¸œé¢ç»åŒå­¦ 9 é¢è¯•åŸé¢˜ï¼šredisçš„åˆ†å¸ƒå¼é”æœ‰äº†è§£è¿‡å—
> 12. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šredisé”æœ‰å‡ ç§å®ç°æ–¹å¼


GitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„å¼€æºçŸ¥è¯†åº“ã€Š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://github.com/itwanger/toBeBetterJavaer)ã€‹ç¬¬ä¸€ç‰ˆ PDF ç»ˆäºæ¥äº†ï¼åŒ…æ‹¬ Java åŸºç¡€è¯­æ³•ã€æ•°ç»„&å­—ç¬¦ä¸²ã€OOPã€é›†åˆæ¡†æ¶ã€Java IOã€å¼‚å¸¸å¤„ç†ã€Java æ–°ç‰¹æ€§ã€ç½‘ç»œç¼–ç¨‹ã€NIOã€å¹¶å‘ç¼–ç¨‹ã€JVM ç­‰ç­‰ï¼Œå…±è®¡ 32 ä¸‡ä½™å­—ï¼Œ500+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯é€šä¿—æ˜“æ‡‚ã€é£è¶£å¹½é»˜â€¦â€¦è¯¦æƒ…æˆ³ï¼š[å¤ªèµäº†ï¼ŒGitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„ Java æ•™ç¨‹](https://javabetter.cn/overview/)

å¾®ä¿¡æœ **æ²‰é»˜ç‹äºŒ** æˆ–æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨äºŒå“¥çš„åŸåˆ›å…¬ä¼—å·æ²‰é»˜ç‹äºŒï¼Œå›å¤ **222** å³å¯å…è´¹é¢†å–ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png)

## åº•å±‚ç»“æ„

è¿™ä¸€éƒ¨åˆ†å°±æ¯”è¾ƒæ·±äº†ï¼Œå¦‚æœä¸æ˜¯ç®€å†ä¸Šå†™äº†ç²¾é€š Redisï¼Œåº”è¯¥ä¸ä¼šæ€ä¹ˆé—®ã€‚

### 49.è¯´è¯´ Redis åº•å±‚æ•°æ®ç»“æ„ï¼Ÿ

Redis çš„åº•å±‚æ•°æ®ç»“æ„æœ‰**åŠ¨æ€å­—ç¬¦ä¸²(sds)**ã€**é“¾è¡¨(list)**ã€**å­—å…¸(ht)**ã€**è·³è·ƒè¡¨(skiplist)**ã€**æ•´æ•°é›†åˆ(intset)**ã€**å‹ç¼©åˆ—è¡¨(ziplist)** ç­‰ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šRedis Objectå¯¹åº”çš„æ˜ å°„](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-a1b2d2f9-6895-4749-9bda-9314f08bca68.png)

æ¯”å¦‚è¯´ string æ˜¯é€šè¿‡ SDS å®ç°çš„ï¼Œlist æ˜¯é€šè¿‡é“¾è¡¨å®ç°çš„ï¼Œhash æ˜¯é€šè¿‡å­—å…¸å®ç°çš„ï¼Œset æ˜¯é€šè¿‡å­—å…¸å®ç°çš„ï¼Œzset æ˜¯é€šè¿‡è·³è·ƒè¡¨å®ç°çš„ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šç±»å‹-ç¼–ç -ç»“æ„](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-7cf91aa9-8db5-4abe-803e-a9e8f3bcb9e4.png)

#### ç®€å•ä»‹ç»ä¸‹ SDSï¼Ÿ

Redis æ˜¯é€šè¿‡ C è¯­è¨€å®ç°çš„ï¼Œä½† Redis å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ C è¯­è¨€çš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº†ä¸€ç§å«åšåŠ¨æ€å­—ç¬¦ä¸² SDS çš„ç±»å‹ã€‚

```c
struct sdshdr {
    int len; // buf ä¸­å·²ä½¿ç”¨çš„é•¿åº¦
    int free; // buf ä¸­æœªä½¿ç”¨çš„é•¿åº¦
    char buf[]; // æ•°æ®ç©ºé—´
};
```

å› ä¸º C è¯­â¾”çš„å­—ç¬¦ä¸²ä¸è®°å½•â¾ƒèº«çš„â»“åº¦ä¿¡æ¯ï¼Œå½“éœ€è¦è·å–å­—ç¬¦ä¸²â»“åº¦æ—¶ï¼Œéœ€è¦éå†æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(N)ã€‚

â½½ SDS ä¿å­˜äº†â»“åº¦ä¿¡æ¯ï¼Œè¿™æ ·å°±å°†è·å–å­—ç¬¦ä¸²â»“åº¦çš„æ—¶é—´ç”± O(N) é™ä½åˆ°äº† O(1)ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šSDS](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-7c038f2c-b5ee-4229-9449-713fab3b1855.png)

#### ç®€å•ä»‹ç»ä¸‹é“¾è¡¨ linkedlist

Redis çš„é“¾è¡¨æ˜¯â¼€ä¸ªåŒå‘â½†ç¯é“¾è¡¨ç»“æ„ï¼Œå’Œ Java ä¸­çš„ [LinkedList](https://javabetter.cn/collection/linkedlist.html) ç±»ä¼¼ã€‚

é“¾è¡¨çš„èŠ‚ç‚¹ç”±â¼€ä¸ªå«åš listNode çš„ç»“æ„æ¥è¡¨ç¤ºï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰æŒ‡å‘å…¶å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹çš„æŒ‡é’ˆï¼ŒåŒæ—¶å¤´èŠ‚ç‚¹çš„å‰ç½®å’Œå°¾èŠ‚ç‚¹çš„åç½®å‡æŒ‡å‘ nullã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé“¾è¡¨linkedlist](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-1adef9c0-8feb-4836-8997-84bda96e2498.png)

#### ç®€å•ä»‹ç»ä¸‹å­—å…¸ dict

â½¤äºä¿å­˜é”®å€¼å¯¹çš„æŠ½è±¡æ•°æ®ç»“æ„ã€‚Redis ä½¿â½¤ hash è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œä¸€ä¸ªå“ˆå¸Œè¡¨é‡Œå¯ä»¥æœ‰å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œè€Œæ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å°±ä¿å­˜äº†å­—å…¸é‡Œä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹ã€‚

æ¯ä¸ªå­—å…¸å¸¦æœ‰ä¸¤ä¸ª hash è¡¨ï¼Œä¾›å¹³æ—¶ä½¿â½¤å’Œ rehash æ—¶ä½¿â½¤ï¼Œhash è¡¨ä½¿â½¤é“¾åœ°å€æ³•æ¥è§£å†³é”®å†²çªï¼Œè¢«åˆ†é…åˆ°åŒâ¼€ä¸ªç´¢å¼•ä½ç½®çš„å¤šä¸ªé”®å€¼å¯¹ä¼šå½¢æˆâ¼€ä¸ªå•å‘é“¾è¡¨ï¼Œåœ¨å¯¹ hash è¡¨è¿›â¾æ‰©å®¹æˆ–è€…ç¼©å®¹çš„æ—¶å€™ï¼Œä¸ºäº†æœåŠ¡çš„å¯â½¤æ€§ï¼Œrehash çš„è¿‡ç¨‹ä¸æ˜¯â¼€æ¬¡æ€§å®Œæˆçš„ï¼Œâ½½æ˜¯æ¸è¿›å¼çš„ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå­—å…¸](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-9934b4a2-c253-4d42-acf4-c6c940840779.png)

#### ç®€å•ä»‹ç»ä¸‹è·³è¡¨ skiplist

æ¨èé˜…è¯»ï¼š[å…¨ç½‘æœ€è¯¦ç»†çš„è·³è¡¨æ–‡ç« ](https://www.jianshu.com/p/9d8296562806)

è·³è¡¨æ˜¯æœ‰åºé›†åˆ Zset çš„åº•å±‚å®ç°ä¹‹â¼€ã€‚åœ¨ Redis 7.0 ä¹‹å‰ï¼Œå¦‚æœæœ‰åºé›†åˆçš„å…ƒç´ ä¸ªæ•°å°äº 128 ä¸ªï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ çš„å€¼å°äº 64 å­—èŠ‚æ—¶ï¼ŒRedis ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º Zset çš„åº•å±‚å®ç°ï¼Œå¦åˆ™ä¼šä½¿ç”¨è·³è¡¨ï¼›åœ¨ Redis 7.0 ä¹‹åï¼Œå‹ç¼©åˆ—è¡¨å·²ç»åºŸå¼ƒï¼Œäº¤ç”± listpack æ¥æ›¿ä»£ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šè·³è¡¨](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-886ee2a8-fb02-4908-bbba-d4ad2a211094.png)

è·³è¡¨ç”± zskiplist å’Œ zskiplistNode ç»„æˆï¼Œzskiplist â½¤äºä¿å­˜è·³è¡¨çš„åŸºæœ¬ä¿¡æ¯ï¼ˆè¡¨å¤´ã€è¡¨å°¾ã€â»“åº¦ã€å±‚é«˜ç­‰ï¼‰ã€‚

```c
typedef struct zskiplist {
    struct zskiplistNode *header, *tail;
    unsigned long length;
    int level;
} zskiplist;
```

zskiplistNode â½¤äºè¡¨ç¤ºè·³è¡¨èŠ‚ç‚¹ï¼Œæ¯ä¸ªè·³è¡¨èŠ‚ç‚¹çš„å±‚â¾¼æ˜¯ä¸å›ºå®šçš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰â¼€ä¸ªæŒ‡å‘ä¿å­˜äº†å½“å‰èŠ‚ç‚¹çš„åˆ†å€¼å’Œæˆå‘˜å¯¹è±¡çš„æŒ‡é’ˆã€‚

```c
typedef struct zskiplistNode {
    sds ele;
    double score;
    struct zskiplistNode *backward;
    struct zskiplistLevel {
        struct zskiplistNode *forward;
        unsigned int span;
    } level[];
} zskiplistNode;
```

#### ç®€å•ä»‹ç»ä¸‹æ•´æ•°é›†åˆ intset

â½¤äºä¿å­˜æ•´æ•°å€¼çš„é›†åˆæŠ½è±¡æ•°æ®ç»“æ„ï¼Œä¸ä¼šå‡ºç°é‡å¤å…ƒç´ ï¼Œåº•å±‚å®ç°ä¸ºæ•°ç»„ã€‚

![æ•´æ•°é›†åˆintset](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-833dbfb2-7c79-4e7b-a143-8a4a2936cdd8.png)

#### ç®€å•ä»‹ç»ä¸‹å‹ç¼©åˆ—è¡¨ ziplist

å‹ç¼©åˆ—è¡¨æ˜¯ä¸ºèŠ‚çº¦å†…å­˜â½½å¼€å‘çš„é¡ºåºæ€§æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜â¼€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…æ•´æ•°å€¼ã€‚

![å‹ç¼©åˆ—è¡¨ç»„æˆ](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-99bcbe82-1d91-41bf-8900-a240856071f5.png)

#### ç®€å•ä»‹ç»ä¸‹ç´§å‡‘åˆ—è¡¨ listpack

listpack æ˜¯ Redis ç”¨æ¥æ›¿ä»£å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰çš„ä¸€ç§å†…å­˜æ›´åŠ ç´§å‡‘çš„æ•°æ®ç»“æ„ã€‚

![æå®¢æ—¶é—´ï¼šlistpack](https://cdn.tobebetterjavaer.com/stutymore/redis-20240403105313.png)

ä¸ºäº†é¿å… ziplist å¼•èµ·çš„è¿é”æ›´æ–°é—®é¢˜ï¼Œlistpack ä¸­çš„å…ƒç´ ä¸å†åƒ ziplist é‚£æ ·ï¼Œä¿å­˜å…¶å‰ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ï¼Œè€Œæ˜¯ä¿å­˜å½“å‰å…ƒç´ çš„ç¼–ç ç±»å‹ã€æ•°æ®ï¼Œä»¥åŠç¼–ç ç±»å‹å’Œæ•°æ®çš„é•¿åº¦ã€‚

![æå®¢æ—¶é—´ï¼šlistpack çš„å…ƒç´ ](https://cdn.tobebetterjavaer.com/stutymore/redis-20240403105754.png)

listpack æ¯ä¸ªå…ƒç´ é¡¹ä¸å†ä¿å­˜ä¸Šä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ï¼Œè€Œæ˜¯ä¼˜åŒ–å…ƒç´ å†…å­—æ®µçš„é¡ºåºï¼Œæ¥ä¿è¯æ—¢å¯ä»¥ä»å‰ä¹Ÿå¯ä»¥å‘åéå†ã€‚

ä½†å› ä¸º List/Hash/Set/ZSet éƒ½ä¸¥é‡ä¾èµ– ziplistï¼Œæ‰€ä»¥è¿™ä¸ªæ›¿æ¢ä¹‹è·¯å¾ˆæ¼«é•¿ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨å•†ä¸šåŒ–ä¸€é¢çš„åŸé¢˜ï¼šè¯´è¯´ Redis çš„ zsetï¼Œä»€ä¹ˆæ˜¯è·³è¡¨ï¼Œæ’å…¥ä¸€ä¸ªèŠ‚ç‚¹è¦æ„å»ºå‡ å±‚ç´¢å¼•
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 9 é£ä¹¦åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis çš„æ•°æ®ç±»å‹ï¼ŒZSet çš„å®ç°
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æš‘æœŸå®ä¹ åŒå­¦ E ä¸€é¢é¢è¯•åŸé¢˜ï¼šä½ çŸ¥é“ Redis çš„ zset åº•å±‚å®ç°å—
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 23 QQ åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šzset çš„åº•å±‚åŸç†
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¿«æ‰‹é¢ç»åŒå­¦ 7 Java åç«¯æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šè¯´ä¸€ä¸‹ ZSet åº•å±‚ç»“æ„
> 6. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢åŒå­¦ 9 ä¸€é¢é¢è¯•åŸé¢˜ï¼šredisçš„æ•°æ®ç»“æ„åº•å±‚åŸç†ï¼Ÿ
> 7. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 27 äº‘åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šZsetçš„åº•å±‚å®ç°ï¼Ÿ
> 8. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 9 é¢è¯•é¢˜ç›®åŸé¢˜ï¼šZsetçš„åº•å±‚å¦‚ä½•å®ç°ï¼Ÿ

### 50.Redis çš„ SDS å’Œ C ä¸­å­—ç¬¦ä¸²ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

C è¯­è¨€ä½¿ç”¨äº†ä¸€ä¸ªé•¿åº¦ä¸º `N+1` çš„å­—ç¬¦æ•°ç»„æ¥è¡¨ç¤ºé•¿åº¦ä¸º `N` çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å­—ç¬¦æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ æ€»æ˜¯ `\0`ï¼Œè¿™ç§ç®€å•çš„å­—ç¬¦ä¸²è¡¨ç¤ºæ–¹å¼ ä¸ç¬¦åˆ Redis å¯¹å­—ç¬¦ä¸²åœ¨å®‰å…¨æ€§ã€æ•ˆç‡ä»¥åŠåŠŸèƒ½æ–¹é¢çš„è¦æ±‚ã€‚

![Cè¯­è¨€çš„å­—ç¬¦ä¸²](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-2541fd26-4e84-467d-8d8c-c731154a85d7.png)

#### C è¯­è¨€çš„å­—ç¬¦ä¸²å¯èƒ½æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

è¿™æ ·ç®€å•çš„æ•°æ®ç»“æ„å¯èƒ½ä¼šé€ æˆä»¥ä¸‹ä¸€äº›é—®é¢˜ï¼š

- **è·å–å­—ç¬¦ä¸²é•¿åº¦å¤æ‚åº¦é«˜** ï¼šå› ä¸º C ä¸ä¿å­˜æ•°ç»„çš„é•¿åº¦ï¼Œæ¯æ¬¡éƒ½éœ€è¦éå†ä¸€éæ•´ä¸ªæ•°ç»„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼›
- ä¸èƒ½æœç» **ç¼“å†²åŒºæº¢å‡º/å†…å­˜æ³„æ¼** çš„é—®é¢˜ : C å­—ç¬¦ä¸²ä¸è®°å½•è‡ªèº«é•¿åº¦å¸¦æ¥çš„å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯å®¹æ˜“é€ æˆç¼“å­˜åŒºæº¢å‡ºï¼ˆbuffer overflowï¼‰ï¼Œä¾‹å¦‚åœ¨å­—ç¬¦ä¸²æ‹¼æ¥çš„æ—¶å€™ï¼Œæ–°çš„
- C å­—ç¬¦ä¸² **åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ®** â†’ å› ä¸º C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²å¿…é¡»ç¬¦åˆæŸç§ç¼–ç ï¼ˆæ¯”å¦‚ ASCIIï¼‰ï¼Œä¾‹å¦‚ä¸­é—´å‡ºç°çš„ `'\0'` å¯èƒ½ä¼šè¢«åˆ¤å®šä¸ºæå‰ç»“æŸçš„å­—ç¬¦ä¸²è€Œè¯†åˆ«ä¸äº†ï¼›

#### Redis å¦‚ä½•è§£å†³ï¼Ÿä¼˜åŠ¿ï¼Ÿ

![Redis sds](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-fc26a4e7-1c8d-4e82-b7f8-1f6b43d16d38.png)

ç®€å•æ¥è¯´ä¸€ä¸‹ Redis å¦‚ä½•è§£å†³çš„ï¼š

1. **å¤šå¢åŠ  len è¡¨ç¤ºå½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦**ï¼šè¿™æ ·å°±å¯ä»¥ç›´æ¥è·å–é•¿åº¦äº†ï¼Œå¤æ‚åº¦ O(1)ï¼›
2. **è‡ªåŠ¨æ‰©å±•ç©ºé—´**ï¼šå½“ SDS éœ€è¦å¯¹å­—ç¬¦ä¸²è¿›è¡Œä¿®æ”¹æ—¶ï¼Œé¦–å…ˆå€ŸåŠ©äº `len` å’Œ `alloc` æ£€æŸ¥ç©ºé—´æ˜¯å¦æ»¡è¶³ä¿®æ”¹æ‰€éœ€çš„è¦æ±‚ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿçš„è¯ï¼ŒSDS ä¼šè‡ªåŠ¨æ‰©å±•ç©ºé—´ï¼Œé¿å…äº†åƒ C å­—ç¬¦ä¸²æ“ä½œä¸­çš„æº¢å‡ºæƒ…å†µï¼›
3. **æœ‰æ•ˆé™ä½å†…å­˜åˆ†é…æ¬¡æ•°**ï¼šC å­—ç¬¦ä¸²åœ¨æ¶‰åŠå¢åŠ æˆ–è€…æ¸…é™¤æ“ä½œæ—¶ä¼šæ”¹å˜åº•å±‚æ•°ç»„çš„å¤§å°é€ æˆé‡æ–°åˆ†é…ï¼ŒSDS ä½¿ç”¨äº† **ç©ºé—´é¢„åˆ†é…** å’Œ **æƒ°æ€§ç©ºé—´é‡Šæ”¾** æœºåˆ¶ï¼Œç®€å•ç†è§£å°±æ˜¯æ¯æ¬¡åœ¨æ‰©å±•æ—¶æ˜¯æˆå€çš„å¤šåˆ†é…çš„ï¼Œåœ¨ç¼©å®¹æ˜¯ä¹Ÿæ˜¯å…ˆç•™ç€å¹¶ä¸æ­£å¼å½’è¿˜ç»™ OSï¼›
4. **äºŒè¿›åˆ¶å®‰å…¨**ï¼šC è¯­è¨€å­—ç¬¦ä¸²åªèƒ½ä¿å­˜ `ascii` ç ï¼Œå¯¹äºå›¾ç‰‡ã€éŸ³é¢‘ç­‰ä¿¡æ¯æ— æ³•ä¿å­˜ï¼ŒSDS æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œå†™å…¥ä»€ä¹ˆè¯»å–å°±æ˜¯ä»€ä¹ˆï¼Œä¸åšä»»ä½•è¿‡æ»¤å’Œé™åˆ¶ï¼›

### 51.å­—å…¸æ˜¯å¦‚ä½•å®ç°çš„ï¼ŸRehash äº†è§£å—ï¼Ÿ

å­—å…¸æ˜¯ Redis æœåŠ¡å™¨ä¸­å‡ºç°æœ€ä¸ºé¢‘ç¹çš„å¤åˆå‹æ•°æ®ç»“æ„ã€‚é™¤äº† **hash** ç»“æ„çš„æ•°æ®ä¼šç”¨åˆ°å­—å…¸å¤–ï¼Œæ•´ä¸ª Redis æ•°æ®åº“çš„æ‰€æœ‰ `key` å’Œ `value` ä¹Ÿç»„æˆäº†ä¸€ä¸ª **å…¨å±€å­—å…¸**ï¼Œè¿˜æœ‰å¸¦è¿‡æœŸæ—¶é—´çš„ `key` ä¹Ÿæ˜¯ä¸€ä¸ªå­—å…¸ã€‚_(å­˜å‚¨åœ¨ RedisDb æ•°æ®ç»“æ„ä¸­)_

#### å­—å…¸ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

**Redis** ä¸­çš„å­—å…¸ç›¸å½“äº Java ä¸­çš„ **HashMap**ï¼Œå†…éƒ¨å®ç°ä¹Ÿå·®ä¸å¤šç±»ä¼¼ï¼Œé‡‡ç”¨å“ˆå¸Œä¸è¿ç®—è®¡ç®—ä¸‹æ ‡ä½ç½®ï¼›é€šè¿‡ **"æ•°ç»„ + é“¾è¡¨" **çš„**é“¾åœ°å€æ³•** æ¥è§£å†³å“ˆå¸Œå†²çªï¼ŒåŒæ—¶è¿™æ ·çš„ç»“æ„ä¹Ÿå¸æ”¶äº†ä¸¤ç§ä¸åŒæ•°æ®ç»“æ„çš„ä¼˜ç‚¹ã€‚

![Rediså­—å…¸ç»“æ„](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-e08347a6-efd5-47c0-9adb-23baff82dbbd.png)

#### å­—å…¸æ˜¯æ€ä¹ˆæ‰©å®¹çš„ï¼Ÿ

å­—å…¸ç»“æ„å†…éƒ¨åŒ…å« **ä¸¤ä¸ª hashtable**ï¼Œé€šå¸¸æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªå“ˆå¸Œè¡¨ `ht[0]` æœ‰å€¼ï¼Œåœ¨æ‰©å®¹çš„æ—¶å€™ï¼ŒæŠŠ `ht[0]`é‡Œçš„å€¼ rehash åˆ° `ht[1]`ï¼Œç„¶åè¿›è¡Œ **æ¸è¿›å¼ rehash** â€”â€”æ‰€è°“æ¸è¿›å¼ rehashï¼ŒæŒ‡çš„æ˜¯è¿™ä¸ª rehash çš„åŠ¨ä½œå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼åœ°å®Œæˆçš„ï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼åœ°å®Œæˆçš„ã€‚

å¾…æ¬è¿ç»“æŸåï¼Œ`h[1]`å°±å–ä»£ `h[0]`å­˜å‚¨å­—å…¸çš„å…ƒç´ ã€‚

### 52.è·³è¡¨æ˜¯å¦‚ä½•å®ç°çš„ï¼ŸåŸç†ï¼Ÿ

è·³è¡¨æ˜¯ä¸€ç§æœ‰åºçš„æ•°æ®ç»“æ„ï¼Œå®ƒé€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ç»´æŒå¤šä¸ªæŒ‡å‘å…¶å®ƒèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œä»è€Œè¾¾åˆ°å¿«é€Ÿè®¿é—®èŠ‚ç‚¹çš„ç›®çš„ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šè·³è¡¨](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-08391728-5ba8-42a0-a287-9284451e0ee7.png)

#### ä¸ºä»€ä¹ˆä½¿ç”¨è·³è¡¨ï¼Ÿ

é¦–å…ˆï¼Œå› ä¸º zset è¦æ”¯æŒéšæœºçš„æ’å…¥å’Œåˆ é™¤ï¼Œæ‰€ä»¥å®ƒ **ä¸å®œä½¿ç”¨æ•°ç»„æ¥å®ç°**ï¼Œå…³äºæ’åºé—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“å°±æƒ³åˆ° **çº¢é»‘æ ‘/ å¹³è¡¡æ ‘** è¿™æ ·çš„æ ‘å½¢ç»“æ„ï¼Œä¸ºä»€ä¹ˆ Redis ä¸ä½¿ç”¨è¿™æ ·ä¸€äº›ç»“æ„å‘¢ï¼Ÿ

1. **æ€§èƒ½è€ƒè™‘ï¼š** åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæ ‘å½¢ç»“æ„éœ€è¦æ‰§è¡Œä¸€äº›ç±»ä¼¼äº rebalance è¿™æ ·çš„å¯èƒ½æ¶‰åŠæ•´æ£µæ ‘çš„æ“ä½œï¼Œç›¸å¯¹æ¥è¯´è·³è·ƒè¡¨çš„å˜åŒ–åªæ¶‰åŠå±€éƒ¨ï¼›
2. **å®ç°è€ƒè™‘ï¼š** åœ¨å¤æ‚åº¦ä¸çº¢é»‘æ ‘ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œè·³è·ƒè¡¨å®ç°èµ·æ¥æ›´ç®€å•ï¼Œçœ‹èµ·æ¥ä¹Ÿæ›´åŠ ç›´è§‚ï¼›

åŸºäºä»¥ä¸Šçš„ä¸€äº›è€ƒè™‘ï¼ŒRedis åŸºäº **William Pugh** çš„è®ºæ–‡åšå‡ºä¸€äº›æ”¹è¿›åé‡‡ç”¨äº† **è·³è·ƒè¡¨** è¿™æ ·çš„ç»“æ„ã€‚

æœ¬è´¨æ˜¯è§£å†³æŸ¥æ‰¾é—®é¢˜ã€‚

#### è·³è·ƒè¡¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

è·³è·ƒè¡¨çš„èŠ‚ç‚¹é‡Œæœ‰è¿™äº›å…ƒç´ ï¼š

â‘ ã€**å±‚**

è·³è·ƒè¡¨èŠ‚ç‚¹çš„ level æ•°ç»„å¯ä»¥åŒ…å«å¤šä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘å…¶å®ƒèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œç¨‹åºå¯ä»¥é€šè¿‡è¿™äº›å±‚æ¥åŠ å¿«è®¿é—®å…¶å®ƒèŠ‚ç‚¹çš„é€Ÿåº¦ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå±‚çš„æ•°é‡æœˆå¤šï¼Œè®¿é—®å…¶å®ƒèŠ‚ç‚¹çš„é€Ÿåº¦å°±è¶Šå¿«ã€‚

æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„è·³è·ƒè¡¨èŠ‚ç‚¹çš„æ—¶å€™ï¼Œç¨‹åºéƒ½æ ¹æ®å¹‚æ¬¡å®šå¾‹ï¼Œéšæœºç”Ÿæˆä¸€ä¸ªä»‹äº 1 å’Œ 32 ä¹‹é—´çš„å€¼ä½œä¸º level æ•°ç»„çš„å¤§å°ï¼Œè¿™ä¸ªå¤§å°å°±æ˜¯å±‚çš„â€œé«˜åº¦â€

â‘¡ã€**å‰è¿›æŒ‡é’ˆ**

æ¯ä¸ªå±‚éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘è¡¨å°¾çš„å‰è¿›æŒ‡é’ˆï¼ˆ`level[i].forward` å±æ€§ï¼‰ï¼Œç”¨äºä»è¡¨å¤´å‘è¡¨å°¾æ–¹å‘è®¿é—®èŠ‚ç‚¹ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸‹è·³è·ƒè¡¨ä»è¡¨å¤´åˆ°è¡¨å°¾ï¼Œéå†æ‰€æœ‰èŠ‚ç‚¹çš„è·¯å¾„ï¼š

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šé€šè¿‡å‰è¿›æŒ‡é’ˆéå†](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b153f782-e2e5-4f98-b251-04f06e16c073.png)

â‘¢ã€**è·¨åº¦**

å±‚çš„è·¨åº¦ç”¨äºè®°å½•ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»ã€‚è·¨åº¦æ˜¯ç”¨æ¥è®¡ç®—æ’ä½ï¼ˆrankï¼‰çš„ï¼šåœ¨æŸ¥æ‰¾æŸä¸ªèŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œå°†æ²¿é€”è®¿é—®è¿‡çš„æ‰€æœ‰å±‚çš„è·¨åº¦ç´¯è®¡èµ·æ¥ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ã€‚

ä¾‹å¦‚æŸ¥æ‰¾ï¼Œåˆ†å€¼ä¸º 3.0ã€æˆå‘˜å¯¹è±¡ä¸º o3 çš„èŠ‚ç‚¹æ—¶ï¼Œæ²¿é€”ç»å†çš„å±‚ï¼šæŸ¥æ‰¾çš„è¿‡ç¨‹åªç»è¿‡äº†ä¸€ä¸ªå±‚ï¼Œå¹¶ä¸”å±‚çš„è·¨åº¦ä¸º 3ï¼Œæ‰€ä»¥ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ä¸º 3ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šè®¡ç®—èŠ‚ç‚¹çš„æ’ä½](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-d2395b7e-2f31-4ca8-b06d-2cb47afaeb74.png)

â‘£ã€**åˆ†å€¼å’Œæˆå‘˜**

èŠ‚ç‚¹çš„åˆ†å€¼ï¼ˆscore å±æ€§ï¼‰æ˜¯ä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ï¼Œè·³è·ƒè¡¨ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æŒ‰åˆ†å€¼ä»å°åˆ°å¤§æ¥æ’åºã€‚

èŠ‚ç‚¹çš„æˆå‘˜å¯¹è±¡ï¼ˆobj å±æ€§ï¼‰æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œè€Œå­—ç¬¦ä¸²å¯¹è±¡åˆ™ä¿å­˜è¿™ä¸€ä¸ª SDS å€¼ã€‚

#### ä¸ºä»€ä¹ˆ hash è¡¨èŒƒå›´æŸ¥è¯¢æ•ˆç‡æ¯”è·³è¡¨ä½ï¼Ÿ

å“ˆå¸Œè¡¨æ˜¯ä¸€ç§åŸºäºé”®å€¼å¯¹çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦ç”¨äºå¿«é€ŸæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚

å“ˆå¸Œè¡¨é€šè¿‡è®¡ç®—é”®çš„å“ˆå¸Œå€¼æ¥ç¡®å®šå€¼çš„å­˜å‚¨ä½ç½®ï¼Œè¿™ä½¿å¾—å®ƒåœ¨å•ä¸ªå…ƒç´ çš„è®¿é—®ä¸Šéå¸¸é«˜æ•ˆï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚

ç„¶è€Œï¼Œå“ˆå¸Œè¡¨å†…çš„å…ƒç´ æ˜¯æ— åºçš„ã€‚å› æ­¤ï¼Œå¯¹äºèŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚æŸ¥æ‰¾æ‰€æœ‰åœ¨æŸä¸ªèŒƒå›´å†…çš„å…ƒç´ ï¼‰ï¼Œå“ˆå¸Œè¡¨æ— æ³•ç›´æ¥æ”¯æŒï¼Œå¿…é¡»éå†æ•´ä¸ªè¡¨æ¥æ£€æŸ¥å“ªäº›å…ƒç´ æ»¡è¶³æ¡ä»¶ï¼Œè¿™ä½¿å¾—å…¶åœ¨èŒƒå›´æŸ¥è¯¢ä¸Šçš„æ•ˆç‡ä½ä¸‹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚

è·³è¡¨æ˜¯ä¸€ç§æœ‰åºçš„æ•°æ®ç»“æ„ï¼Œèƒ½å¤Ÿä¿æŒå…ƒç´ çš„æ’åºé¡ºåºã€‚

å®ƒé€šè¿‡å¤šå±‚çš„é“¾è¡¨ç»“æ„å®ç°å¿«é€Ÿçš„æ’å…¥ã€åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œï¼Œå…¶ä¸­æ¯ä¸€å±‚éƒ½æ˜¯ä¸‹ä¸€å±‚çš„ä¸€ä¸ªå­é›†ï¼Œå¹¶ä¸”å…ƒç´ åœ¨æ¯ä¸€å±‚éƒ½æ˜¯æœ‰åºçš„ã€‚

å½“è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œè·³è¡¨å¯ä»¥ä»æœ€é«˜å±‚å¼€å§‹ï¼Œå¿«é€Ÿå®šä½åˆ°èŒƒå›´çš„èµ·å§‹ç‚¹ï¼Œç„¶åæ²¿ç€ä¸‹ä¸€å±‚ç»§ç»­ç›´åˆ°æ‰¾åˆ°èŒƒå›´çš„ç»“æŸç‚¹ã€‚è¿™ç§åˆ†å±‚çš„ç»“æ„ä½¿å¾—è·³è¡¨åœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶éå¸¸é«˜æ•ˆï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(log n) åŠ ä¸ŠèŒƒå›´å†…å…ƒç´ çš„æ•°é‡ã€‚

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å°ç±³æš‘æœŸå®ä¹ åŒå­¦ E ä¸€é¢é¢è¯•åŸé¢˜ï¼šä¸ºä»€ä¹ˆ hash è¡¨èŒƒå›´æŸ¥è¯¢æ•ˆç‡æ¯”è·³è¡¨ä½
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„è…¾è®¯é¢ç»åŒå­¦ 23 QQ åå°æŠ€æœ¯ä¸€é¢é¢è¯•åŸé¢˜ï¼šzset çš„åº•å±‚åŸç†
> 3. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å¾—ç‰©é¢ç»åŒå­¦ 8 ä¸€é¢é¢è¯•åŸé¢˜ï¼šè·³è¡¨çš„ç»“æ„
> 4. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„ç¾å›¢é¢ç»åŒå­¦ 4 ä¸€é¢é¢è¯•åŸé¢˜ï¼šRedis è·³è¡¨
> 5. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„é˜¿é‡Œç³»é¢ç»åŒå­¦ 19 é¥¿äº†ä¹ˆé¢è¯•åŸé¢˜ï¼šè·³è¡¨äº†è§£å—

### 53.å‹ç¼©åˆ—è¡¨äº†è§£å—ï¼Ÿ

å‹ç¼©åˆ—è¡¨æ˜¯ Redis **ä¸ºäº†èŠ‚çº¦å†…å­˜** è€Œä½¿ç”¨çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆçš„é¡ºåºå‹æ•°æ®ç»“æ„ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå‹ç¼©åˆ—è¡¨ç»„æˆéƒ¨åˆ†](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-6be492f7-9f92-4607-a4c4-81a612a3d7bd.png)

hashã€listã€zset åœ¨å…ƒç´ è¾ƒå°‘æ—¶ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ã€‚

![æˆªå›¾æ¥è‡ª Redis å®˜ç½‘](https://cdn.tobebetterjavaer.com/stutymore/redis-20241225105623.png)

ä¸€ä¸ªå‹ç¼©åˆ—è¡¨åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼ã€‚

![ä¸‰åˆ†æ¶é¢æ¸£é€†è¢­ï¼šå‹ç¼©åˆ—è¡¨ç¤ºä¾‹](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-b5d224c2-53ee-40a3-9efc-2feb7dd3d7a8.png)

- **zlbyttes**ï¼šè®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°
- **zltail**ï¼šè®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»å‹ç¼©åˆ—è¡¨çš„èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚
- **zllen**ï¼šè®°å½•å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡
- **entryX**ï¼šåˆ—è¡¨èŠ‚ç‚¹
- **zlend**ï¼šç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯


> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„åŒå­¦ 30 è…¾è®¯éŸ³ä¹é¢è¯•åŸé¢˜ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨å‹ç¼©åˆ—è¡¨

### 54.å¿«é€Ÿåˆ—è¡¨ quicklist äº†è§£å—ï¼Ÿ

Redis æ—©æœŸç‰ˆæœ¬å­˜å‚¨ list åˆ—è¡¨æ•°æ®ç»“æ„ä½¿ç”¨çš„æ˜¯å‹ç¼©åˆ—è¡¨ ziplist å’Œæ™®é€šçš„åŒå‘é“¾è¡¨ linkedlistï¼Œä¹Ÿå°±æ˜¯è¯´å½“å…ƒç´ å°‘æ—¶ä½¿ç”¨ ziplistï¼Œå½“å…ƒç´ å¤šæ—¶ç”¨ linkedlistã€‚

ä½†è€ƒè™‘åˆ°é“¾è¡¨çš„é™„åŠ ç©ºé—´ç›¸å¯¹è¾ƒé«˜ï¼Œ`prev` å’Œ `next` æŒ‡é’ˆå°±è¦å å» `16` ä¸ªå­—èŠ‚ï¼ˆ64 ä½æ“ä½œç³»ç»Ÿå ç”¨ `8` ä¸ªå­—èŠ‚ï¼‰ï¼Œå¦å¤–æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜éƒ½æ˜¯å•ç‹¬åˆ†é…ï¼Œä¼šå®¶å…·å†…å­˜çš„ç¢ç‰‡åŒ–ï¼Œå½±å“å†…å­˜ç®¡ç†æ•ˆç‡ã€‚

åæ¥ Redis æ–°ç‰ˆæœ¬ï¼ˆ3.2ï¼‰å¯¹åˆ—è¡¨æ•°æ®ç»“æ„è¿›è¡Œäº†æ”¹é€ ï¼Œä½¿ç”¨ `quicklist` ä»£æ›¿äº† `ziplist` å’Œ `linkedlist`ï¼Œquicklist æ˜¯ç»¼åˆè€ƒè™‘äº†æ—¶é—´æ•ˆç‡ä¸ç©ºé—´æ•ˆç‡å¼•å…¥çš„æ–°å‹æ•°æ®ç»“æ„ã€‚

quicklist ç”± list å’Œ ziplist ç»“åˆè€Œæˆï¼Œå®ƒæ˜¯ä¸€ä¸ªç”± ziplist å……å½“èŠ‚ç‚¹çš„åŒå‘é“¾è¡¨ã€‚
![quicklist](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/sidebar/sanfene/redis-3b9785b0-6573-4c2d-8b7d-d5d1be799e26.png)

GitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„å¼€æºçŸ¥è¯†åº“ã€Š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://github.com/itwanger/toBeBetterJavaer)ã€‹ç¬¬ä¸€ç‰ˆ PDF ç»ˆäºæ¥äº†ï¼åŒ…æ‹¬ Java åŸºç¡€è¯­æ³•ã€æ•°ç»„&å­—ç¬¦ä¸²ã€OOPã€é›†åˆæ¡†æ¶ã€Java IOã€å¼‚å¸¸å¤„ç†ã€Java æ–°ç‰¹æ€§ã€ç½‘ç»œç¼–ç¨‹ã€NIOã€å¹¶å‘ç¼–ç¨‹ã€JVM ç­‰ç­‰ï¼Œå…±è®¡ 32 ä¸‡ä½™å­—ï¼Œ500+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯é€šä¿—æ˜“æ‡‚ã€é£è¶£å¹½é»˜â€¦â€¦è¯¦æƒ…æˆ³ï¼š[å¤ªèµäº†ï¼ŒGitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„ Java æ•™ç¨‹](https://javabetter.cn/overview/)

å¾®ä¿¡æœ **æ²‰é»˜ç‹äºŒ** æˆ–æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨äºŒå“¥çš„åŸåˆ›å…¬ä¼—å·æ²‰é»˜ç‹äºŒï¼Œå›å¤ **222** å³å¯å…è´¹é¢†å–ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png)

## è¡¥å……

### 55.å‡å¦‚ Redis é‡Œé¢æœ‰ 1 äº¿ä¸ª keyï¼Œå…¶ä¸­æœ‰ 10w ä¸ª key æ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥çš„å‰ç¼€å¼€å¤´çš„ï¼Œå¦‚ä½•å°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥ï¼Ÿ

ä½¿ç”¨ `keys` æŒ‡ä»¤å¯ä»¥æ‰«å‡ºæŒ‡å®šæ¨¡å¼çš„ key åˆ—è¡¨ã€‚ä½†æ˜¯è¦æ³¨æ„ keys æŒ‡ä»¤ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´ï¼Œçº¿ä¸ŠæœåŠ¡ä¼šåœé¡¿ï¼Œç›´åˆ°æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼ŒæœåŠ¡æ‰èƒ½æ¢å¤ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ `scan` æŒ‡ä»¤ï¼Œ`scan` æŒ‡ä»¤å¯ä»¥æ— é˜»å¡çš„æå–å‡ºæŒ‡å®šæ¨¡å¼çš„ `key` åˆ—è¡¨ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€å®šçš„é‡å¤æ¦‚ç‡ï¼Œåœ¨å®¢æˆ·ç«¯åšä¸€æ¬¡å»é‡å°±å¯ä»¥äº†ï¼Œä½†æ˜¯æ•´ä½“æ‰€èŠ±è´¹çš„æ—¶é—´ä¼šæ¯”ç›´æ¥ç”¨ `keys` æŒ‡ä»¤é•¿ã€‚

### 56.Redis çš„ç§’æ€åœºæ™¯ä¸‹æ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²ï¼Ÿï¼ˆè¡¥å……ï¼‰

ç§’æ€ä¸»è¦æ˜¯æŒ‡å¤§é‡ç”¨æˆ·é›†ä¸­åœ¨çŸ­æ—¶é—´å†…å¯¹æœåŠ¡å™¨è¿›è¡Œè®¿é—®ï¼Œä»è€Œå¯¼è‡´æœåŠ¡å™¨è´Ÿè½½å‰§å¢ï¼Œå¯èƒ½å‡ºç°ç³»ç»Ÿå“åº”ç¼“æ…¢ç”šè‡³å´©æºƒçš„æƒ…å†µã€‚

é’ˆå¯¹ç§’æ€çš„åœºæ™¯æ¥è¯´ï¼Œæœ€ç»ˆæŠ¢åˆ°å•†å“çš„ç”¨æˆ·æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ 100 ä¸ªäººå’Œ 10000 ä¸ªäººæ¥æŠ¢ä¸€ä¸ªå•†å“ï¼Œæœ€ç»ˆéƒ½åªèƒ½æœ‰ 100 ä¸ªäººæŠ¢åˆ°ã€‚

ä½†æ˜¯å¯¹äºç§’æ€æ´»åŠ¨çš„åˆå¿ƒæ¥è¯´ï¼Œè‚¯å®šæ˜¯å¸Œæœ›å‚ä¸çš„ç”¨æˆ·è¶Šå¤šè¶Šå¥½ï¼Œä½†çœŸæ­£å¼€å§‹ä¸‹å•æ—¶ï¼Œæœ€å¥½èƒ½æŠŠè¯·æ±‚æ§åˆ¶åœ¨æœåŠ¡å™¨èƒ½å¤Ÿæ‰¿å—çš„èŒƒå›´ä¹‹å†…ï¼ˆğŸ˜‚ï¼‰ã€‚

![è®¸ä»¤æ³¢-ç§’æ€ç³»ç»Ÿçš„è®¾è®¡](https://cdn.tobebetterjavaer.com/stutymore/redis-20240420102552.png)

è§£å†³è¿™ä¸€é—®é¢˜çš„å…³é”®å°±åœ¨äºé”™å³°å‰Šå³°å’Œé™æµã€‚å½“ç„¶äº†ï¼Œå‰ç«¯é¡µé¢çš„é™æ€åŒ–ã€æŒ‰é’®é˜²æŠ–ä¹Ÿèƒ½å¤Ÿæœ‰æ•ˆçš„å‡è½»æœåŠ¡å™¨çš„å‹åŠ›ã€‚

- é¡µé¢é™æ€åŒ–ï¼šå°†å•†å“è¯¦æƒ…ç­‰é¡µé¢é™æ€åŒ–ï¼Œä½¿ç”¨ CDN åˆ†å‘ã€‚
- æŒ‰é’®é˜²æŠ–ï¼šé¿å…ç”¨æˆ·å› é¢‘ç¹ç‚¹å‡»é€ æˆçš„é¢å¤–è¯·æ±‚ï¼Œæ¯”å¦‚è®¾å®šé—´éš”æ—¶é—´åæ‰èƒ½å†æ¬¡ç‚¹å‡»ã€‚

#### å¦‚ä½•å®ç°é”™å³°å‰Šå³°å‘¢ï¼Ÿ

é’ˆå¯¹è½¦æµé‡çš„æ™šé«˜å³°å’Œæ—©é«˜å³°ï¼Œæœ€å¼ºæœ‰åŠ›çš„åŠæ³•å°±æ˜¯é™è¡Œï¼Œä½†é™è¡Œä¸æ˜¯æ— æŸçš„ï¼Œæ¯•ç«Ÿé™è¡Œçš„ç‰Œå·æ— æ³•å‡ºè¡Œã€‚

æ— æŸçš„æ–¹å¼å°±æ˜¯æœ‰çš„è½¦è¾†æ—©å‡ºå‘ï¼Œæœ‰çš„è½¦è¾†æ™šå‡ºå‘ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå®ç°é”™å³°å‡ºè¡Œã€‚

åœ¨ç§’æ€åœºæ™¯ä¸‹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å®ç°é”™å³°å‰Šå³°ï¼š

â‘ ã€**é¢„çƒ­ç¼“å­˜**ï¼šæå‰å°†çƒ­ç‚¹æ•°æ®åŠ è½½åˆ° Redis ç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®å‹åŠ›ã€‚

â‘¡ã€**æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°†è¯·æ±‚å¼‚æ­¥å¤„ç†ï¼Œå‡å°‘ç¬æ—¶è¯·æ±‚å‹åŠ›ã€‚æ¶ˆæ¯é˜Ÿåˆ—å°±åƒä¸€ä¸ªæ°´åº“ï¼Œå¯ä»¥å‰Šå‡ä¸Šæ¸¸çš„æ´ªå³°æµé‡ã€‚

![è®¸ä»¤æ³¢-æ’é˜Ÿ](https://cdn.tobebetterjavaer.com/stutymore/redis-20240420104633.png)

â‘¢ã€**å¤šé˜¶æ®µå¤šæ—¶é—´çª—å£**ï¼šå°†ç§’æ€æ´»åŠ¨åˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µè®¾ç½®ä¸åŒçš„æ—¶é—´çª—å£ï¼Œè®©ç”¨æˆ·åœ¨ä¸åŒçš„æ—¶é—´æ®µå†…å‚ä¸ç§’æ€æ´»åŠ¨ã€‚

â‘£ã€**æ’å…¥ç­”é¢˜ç³»ç»Ÿ**ï¼šåœ¨ç§’æ€æ´»åŠ¨ä¸­åŠ å…¥ç­”é¢˜ç¯èŠ‚ï¼Œåªæœ‰ç­”å¯¹é¢˜ç›®çš„ç”¨æˆ·æ‰èƒ½å‚ä¸ç§’æ€æ´»åŠ¨ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ— æ•ˆè¯·æ±‚ã€‚

![è®¸ä»¤æ³¢-ç­”é¢˜](https://cdn.tobebetterjavaer.com/stutymore/redis-20240420104921.png)

#### å¦‚ä½•é™æµå‘¢ï¼Ÿ

é‡‡ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå®ƒå°±åƒåœ¨å¸éƒ½ä¹°è½¦ï¼Œæ‘‡åˆ°å·æ‰æœ‰èµ„æ ¼ï¼Œæ²¡æ‘‡åˆ°å°±åªèƒ½ç­‰ä¸‹ä¸€æ¬¡ï¼ˆğŸ˜ï¼‰ã€‚

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç»´æŠ¤ä¸€ä¸ªå®¹å™¨ï¼ŒæŒ‰ç…§å›ºå®šçš„é€Ÿç‡å¾€å®¹å™¨ä¸­æ”¾ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œå½“è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä»å®¹å™¨ä¸­å–å‡ºä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœå®¹å™¨ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚

![æå­æŒï¼šä»¤ç‰Œæ¡¶](https://cdn.tobebetterjavaer.com/stutymore/redis-20240420114025.png)

ç¬¬ä¸€æ­¥ï¼Œä½¿ç”¨ Redis åˆå§‹åŒ–ä»¤ç‰Œæ¡¶ï¼š

```shell
redis-cli SET "token_bucket" "100"
```

ç¬¬äºŒæ­¥ï¼Œä½¿ç”¨ Lua è„šæœ¬å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•ï¼›å‡è®¾æ¯ç§’å‘æ¡¶ä¸­æ·»åŠ  10 ä¸ªä»¤ç‰Œï¼Œä½†ä¸è¶…è¿‡æ¡¶çš„æœ€å¤§å®¹é‡ã€‚

```lua
-- Lua è„šæœ¬æ¥æ·»åŠ ä»¤ç‰Œï¼Œå¹¶ç¡®ä¿ä¸è¶…è¿‡æœ€å¤§å®¹é‡
local bucket = KEYS[1]
local add_count = tonumber(ARGV[1])
local max_tokens = tonumber(ARGV[2])
local current = tonumber(redis.call('GET', bucket) or 0)
local new_count = math.min(current + add_count, max_tokens)
redis.call('SET', bucket, tostring(new_count))
return new_count
```

ç¬¬ä¸‰æ­¥ï¼Œä½¿ç”¨ Shell è„šæœ¬è°ƒç”¨ Lua è„šæœ¬ï¼š

```shell
#!/bin/bash
while true; do
    redis-cli EVAL "$(cat add_tokens.lua)" 1 token_bucket 10 100
    sleep 1
done
```

ç¬¬å››æ­¥ï¼Œå½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œéœ€è¦æ£€æŸ¥å¹¶æ¶ˆè€—ä¸€ä¸ªä»¤ç‰Œã€‚

```lua
-- Lua è„šæœ¬æ¥æ¶ˆè€—ä¸€ä¸ªä»¤ç‰Œ
local bucket = KEYS[1]
local tokens = tonumber(redis.call('GET', bucket) or 0)
if tokens > 0 then
    redis.call('DECR', bucket)
    return 1  -- æˆåŠŸæ¶ˆè€—ä»¤ç‰Œ
else
    return 0  -- ä»¤ç‰Œä¸è¶³
end
```

è°ƒç”¨ Lua è„šæœ¬ï¼š

```shell
redis-cli EVAL "$(cat consume_token.lua)" 1 token_bucket
```

> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å†œä¸šé“¶è¡Œé¢ç»åŒå­¦ 3 Java åç«¯é¢è¯•åŸé¢˜ï¼šç§’æ€é—®é¢˜ï¼ˆé”™å³°ã€å‰Šå³°ã€å‰ç«¯ã€æµé‡æ§åˆ¶ï¼‰
> 2. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„æ»´æ»´é¢ç»åŒå­¦ 3 ç½‘çº¦è½¦åç«¯å¼€å‘ä¸€é¢åŸé¢˜ï¼šé™æµç®—æ³•

### 57. å®¢æˆ·ç«¯å®•æœºå Redis æœåŠ¡ç«¯å¦‚ä½•æ„ŸçŸ¥åˆ°ï¼Ÿ

æ¯ä¸ªå®¢æˆ·ç«¯åœ¨ Redis ä¸­ç»´æŠ¤ä¸€ä¸ªç‰¹å®šçš„é”®ï¼ˆç§°ä¸ºå¿ƒè·³é”®ï¼‰ï¼Œç”¨äºè¡¨ç¤ºå®¢æˆ·ç«¯çš„å¥åº·çŠ¶æ€ã€‚è¯¥é”®å…·æœ‰ä¸€ä¸ªè®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œä¾‹å¦‚ 10 ç§’ã€‚

å®¢æˆ·ç«¯å®šæœŸï¼ˆå¦‚æ¯ 5 ç§’ï¼‰æ›´æ–°è¿™ä¸ªå¿ƒè·³é”®çš„è¶…æ—¶æ—¶é—´ï¼Œä¿æŒå®ƒçš„å­˜æ´»çŠ¶æ€ï¼Œé€šå¸¸é€šè¿‡ SET å‘½ä»¤é‡è®¾é”®çš„è¿‡æœŸæ—¶é—´ã€‚

```java
import redis.clients.jedis.Jedis;

public class ClientHeartbeat {
    private static final String HEARTBEAT_KEY = "client:heartbeat";
    private static final int EXPIRE_TIME = 10; // 10ç§’

    public static void main(String[] args) {
        // åˆ›å»º Redis è¿æ¥
        Jedis jedis = new Jedis("localhost");

        // å®šæ—¶æ›´æ–°å¿ƒè·³é”®
        while (true) {
            try {
                // è®¾ç½®å¿ƒè·³é”®å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
                jedis.setex(HEARTBEAT_KEY, EXPIRE_TIME, "alive");

                // æ‰“å°å¿ƒè·³æ—¥å¿—
                System.out.println("Heartbeat sent.");

                // ç­‰å¾…ä¸€æ®µæ—¶é—´åå†æ¬¡å‘é€å¿ƒè·³
                Thread.sleep(5000); // æ¯5ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
            } catch (InterruptedException e) {
                e.printStackTrace();
                break;
            }
        }
    }
}
```

Redis æœåŠ¡ç«¯å®šæœŸæ£€æŸ¥è¿™ä¸ªå¿ƒè·³é”®ã€‚å¦‚æœå‘ç°è¯¥é”®å·²è¶…æ—¶å¹¶è¢« Redis è‡ªåŠ¨åˆ é™¤ï¼Œè¯´æ˜å®¢æˆ·ç«¯å¯èƒ½å·²å®•æœºã€‚

```java
import redis.clients.jedis.Jedis;

public class ServerMonitor {
    private static final String HEARTBEAT_KEY = "client:heartbeat";

    public static void main(String[] args) {
        // åˆ›å»º Redis è¿æ¥
        Jedis jedis = new Jedis("localhost");

        // å®šæœŸæ£€æŸ¥å¿ƒè·³é”®
        while (true) {
            try {
                // æ£€æŸ¥å¿ƒè·³é”®æ˜¯å¦å­˜åœ¨
                if (jedis.exists(HEARTBEAT_KEY)) {
                    System.out.println("Client is alive.");
                } else {
                    System.out.println("Client is down or disconnected.");
                }

                // æ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥ä¸€æ¬¡
                Thread.sleep(10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
            } catch (InterruptedException e) {
                e.printStackTrace();
                break;
            }
        }
    }
}
```


> 1. [Java é¢è¯•æŒ‡å—ï¼ˆä»˜è´¹ï¼‰](https://javabetter.cn/zhishixingqiu/mianshi.html)æ”¶å½•çš„å­—èŠ‚è·³åŠ¨é¢ç»åŒå­¦ 21  æŠ–éŸ³å•†åŸä¸€é¢é¢è¯•åŸé¢˜ï¼šå¦‚æœå®¢æˆ·ç«¯å®•æœºæœåŠ¡å™¨å¦‚ä½•æ„ŸçŸ¥ï¼Ÿ

---

å›¾æ–‡è¯¦è§£ 57 é“ Redis é¢è¯•é«˜é¢‘é¢˜ï¼Œè¿™æ¬¡åŠæ‰“é¢è¯•å®˜ï¼Œæˆ‘è§‰å¾—ç¨³äº†ï¼ˆæ‰‹åŠ¨ dogï¼‰ã€‚æ•´ç†ï¼šæ²‰é»˜ç‹äºŒï¼Œæˆ³[è½¬è½½é“¾æ¥](https://mp.weixin.qq.com/s/19u34NXALB1nOlBCE6Eg-Q)ï¼Œä½œè€…ï¼šä¸‰åˆ†æ¶ï¼Œæˆ³[åŸæ–‡é“¾æ¥](https://mp.weixin.qq.com/s/iJtNJYgirRugNBnzxkbB4Q)ã€‚

_æ²¡æœ‰ä»€ä¹ˆä½¿æˆ‘åœç•™â€”â€”é™¤äº†ç›®çš„ï¼Œçºµç„¶å²¸æ—æœ‰ç«ç‘°ã€æœ‰ç»¿è«ã€æœ‰å®é™çš„æ¸¯æ¹¾ï¼Œæˆ‘æ˜¯ä¸ç³»ä¹‹èˆŸ_ã€‚

**ç³»åˆ—å†…å®¹**ï¼š

- [é¢æ¸£é€†è¢­ Java SE ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/javase.html)
- [é¢æ¸£é€†è¢­ Java é›†åˆæ¡†æ¶ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/javathread.html)
- [é¢æ¸£é€†è¢­ Java å¹¶å‘ç¼–ç¨‹ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/collection.html)
- [é¢æ¸£é€†è¢­ JVM ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/jvm.html)
- [é¢æ¸£é€†è¢­ Spring ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/spring.html)
- [é¢æ¸£é€†è¢­ Redis ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/redis.html)
- [é¢æ¸£é€†è¢­ MyBatis ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/mybatis.html)
- [é¢æ¸£é€†è¢­ MySQL ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/mysql.html)
- [é¢æ¸£é€†è¢­æ“ä½œç³»ç»Ÿç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/os.html)
- [é¢æ¸£é€†è¢­è®¡ç®—æœºç½‘ç»œç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/network.html)
- [é¢æ¸£é€†è¢­ RocketMQ ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/rocketmq.html)
- [é¢æ¸£é€†è¢­åˆ†å¸ƒå¼ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/fenbushi.html)
- [é¢æ¸£é€†è¢­å¾®æœåŠ¡ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/weifuwu.html)
- [é¢æ¸£é€†è¢­è®¾è®¡æ¨¡å¼ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/shejimoshi.html)
- [é¢æ¸£é€†è¢­ Linux ç¯‡ ğŸ‘](https://javabetter.cn/sidebar/sanfene/linux.html)

---

GitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„å¼€æºçŸ¥è¯†åº“ã€Š[äºŒå“¥çš„ Java è¿›é˜¶ä¹‹è·¯](https://github.com/itwanger/toBeBetterJavaer)ã€‹ç¬¬ä¸€ç‰ˆ PDF ç»ˆäºæ¥äº†ï¼åŒ…æ‹¬ Java åŸºç¡€è¯­æ³•ã€æ•°ç»„&å­—ç¬¦ä¸²ã€OOPã€é›†åˆæ¡†æ¶ã€Java IOã€å¼‚å¸¸å¤„ç†ã€Java æ–°ç‰¹æ€§ã€ç½‘ç»œç¼–ç¨‹ã€NIOã€å¹¶å‘ç¼–ç¨‹ã€JVM ç­‰ç­‰ï¼Œå…±è®¡ 32 ä¸‡ä½™å­—ï¼Œ500+å¼ æ‰‹ç»˜å›¾ï¼Œå¯ä»¥è¯´æ˜¯é€šä¿—æ˜“æ‡‚ã€é£è¶£å¹½é»˜â€¦â€¦è¯¦æƒ…æˆ³ï¼š[å¤ªèµäº†ï¼ŒGitHub ä¸Šæ ‡æ˜Ÿ 10000+ çš„ Java æ•™ç¨‹](https://javabetter.cn/overview/)

å¾®ä¿¡æœ **æ²‰é»˜ç‹äºŒ** æˆ–æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨äºŒå“¥çš„åŸåˆ›å…¬ä¼—å·æ²‰é»˜ç‹äºŒï¼Œå›å¤ **222** å³å¯å…è´¹é¢†å–ã€‚

![](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png)
