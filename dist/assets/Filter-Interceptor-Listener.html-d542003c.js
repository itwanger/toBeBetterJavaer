import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o,c,a as n,d as s,b as t,e as i}from"./app-72970f25.js";const l={},u=i(`<h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€" aria-hidden="true">#</a> å‰è¨€</h2><p>å…ˆè¯´ä½œç”¨ã€‚</p><ul><li>è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ï¼šå½“æœ‰ä¸€å †è¯·æ±‚ï¼Œåªå¸Œæœ›ç¬¦åˆé¢„æœŸçš„è¯·æ±‚è¿›æ¥ã€‚</li><li>æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰ï¼šæƒ³è¦å¹²æ¶‰é¢„æœŸçš„è¯·æ±‚ã€‚</li><li>ç›‘å¬å™¨ï¼ˆListenerï¼‰ï¼šæƒ³è¦ç›‘å¬è¿™äº›è¯·æ±‚å…·ä½“åšäº†ä»€ä¹ˆã€‚</li></ul><p>å†è¯´åŒºåˆ«ã€‚</p><p>è¿‡æ»¤å™¨æ˜¯åœ¨è¯·æ±‚è¿›å…¥å®¹å™¨åï¼Œä½†è¿˜æ²¡æœ‰è¿›å…¥ Servlet ä¹‹å‰è¿›è¡Œé¢„å¤„ç†çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/springboot/Filter-Interceptor-Listener-2a28621b-2cc1-4d29-87a1-cf6a01d95443.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ‹¦æˆªå™¨æ˜¯åœ¨è¯·æ±‚è¿›å…¥æ§åˆ¶å™¨ï¼ˆControllerï¼‰ ä¹‹å‰è¿›è¡Œé¢„å¤„ç†çš„ã€‚</p><p>è™šçº¿å†…å°±æ˜¯è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨çš„ä½œç”¨èŒƒå›´ï¼š</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/springboot/Filter-Interceptor-Listener-dd48851b-c123-4fd8-b82d-9ae87b33745d.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>è¿‡æ»¤å™¨ä¾èµ–äº Servlet å®¹å™¨ï¼Œè€Œæ‹¦æˆªå™¨ä¾èµ–äº Spring çš„ IoC å®¹å™¨ï¼Œå› æ­¤å¯ä»¥é€šè¿‡æ³¨å…¥çš„æ–¹å¼è·å–å®¹å™¨å½“ä¸­çš„å¯¹è±¡ã€‚</p><p>ç›‘å¬å™¨ç”¨äºç›‘å¬ Web åº”ç”¨ä¸­æŸäº›å¯¹è±¡çš„åˆ›å»ºã€é”€æ¯ã€å¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ç­‰åŠ¨ä½œï¼Œç„¶ååšå‡ºç›¸åº”çš„å¤„ç†ã€‚</p><h2 id="è¿‡æ»¤å™¨" tabindex="-1"><a class="header-anchor" href="#è¿‡æ»¤å™¨" aria-hidden="true">#</a> è¿‡æ»¤å™¨</h2><ul><li>è¿‡æ»¤æ•æ„Ÿè¯æ±‡ï¼ˆé˜²æ­¢sqlæ³¨å…¥ï¼‰</li><li>è®¾ç½®å­—ç¬¦ç¼–ç </li><li>URLçº§åˆ«çš„æƒé™è®¿é—®æ§åˆ¶</li><li>å‹ç¼©å“åº”ä¿¡æ¯</li></ul><p>è¿‡æ»¤å™¨çš„åˆ›å»ºå’Œé”€æ¯éƒ½ç”± Web æœåŠ¡å™¨è´Ÿè´£ï¼ŒWeb åº”ç”¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼Œåˆ›å»ºè¿‡æ»¤å™¨å¯¹è±¡ï¼Œä¸ºåç»­çš„è¯·æ±‚è¿‡æ»¤åšå¥½å‡†å¤‡ã€‚</p><p>è¿‡æ»¤å™¨å¯ä»¥æœ‰å¾ˆå¤šä¸ªï¼Œä¸€ä¸ªä¸ªè¿‡æ»¤å™¨ç»„åˆèµ·æ¥å°±æˆäº† FilterChainï¼Œä¹Ÿå°±æ˜¯è¿‡æ»¤å™¨é“¾ã€‚</p><p>åœ¨ Spring ä¸­ï¼Œè¿‡æ»¤å™¨éƒ½é»˜è®¤ç»§æ‰¿äº† OncePerRequestFilterï¼Œé¡¾åæ€ä¹‰ï¼ŒOncePerRequestFilter çš„ä½œç”¨å°±æ˜¯ç¡®ä¿ä¸€æ¬¡è¯·æ±‚åªé€šè¿‡ä¸€æ¬¡è¿‡æ»¤å™¨ï¼Œè€Œä¸é‡å¤æ‰§è¡Œã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/springboot/Filter-Interceptor-Listener-aaa1c537-c8ed-4c5d-b27f-93c1409f2748.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åœ¨ç¼–ç¨‹å–µå®æˆ˜é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°±æ˜¯é€šè¿‡ç»§æ‰¿ OncePerRequestFilter æ¥å®ç° JWT ç™»å½•æˆæƒè¿‡æ»¤çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
                                    <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»å®¢æˆ·ç«¯è¯·æ±‚ä¸­è·å– JWT</span>
        <span class="token class-name">String</span> authHeader <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¯¥ JWT æ˜¯æˆ‘ä»¬è§„å®šçš„æ ¼å¼ï¼Œä»¥ tokenHead å¼€å¤´</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>authHeader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> authHeader<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenHead<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// The part after &quot;Bearer &quot;</span>
            <span class="token class-name">String</span> authToken <span class="token operator">=</span> authHeader<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenHead<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ä» JWT ä¸­è·å–ç”¨æˆ·å</span>
            <span class="token class-name">String</span> username <span class="token operator">=</span> jwtTokenUtil<span class="token punctuation">.</span><span class="token function">getUserNameFromToken</span><span class="token punctuation">(</span>authToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;checking username:{}&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// SecurityContextHolder æ˜¯ SpringSecurity çš„ä¸€ä¸ªå·¥å…·ç±»</span>
            <span class="token comment">// ä¿å­˜åº”ç”¨ç¨‹åºä¸­å½“å‰ä½¿ç”¨äººçš„å®‰å…¨ä¸Šä¸‹æ–‡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ ¹æ®ç”¨æˆ·åè·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯</span>
                <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// éªŒè¯ token æ˜¯å¦è¿‡æœŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>jwtTokenUtil<span class="token punctuation">.</span><span class="token function">validateToken</span><span class="token punctuation">(</span>authToken<span class="token punctuation">,</span> userDetails<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å°†ç™»å½•ç”¨æˆ·ä¿å­˜åˆ°å®‰å…¨ä¸Šä¸‹æ–‡ä¸­</span>
                    <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span>
                            <span class="token keyword">null</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    authentication<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬åˆ©ç”¨ Spring Initializr æ¥æ–°å»ºä¸€ä¸ª Web é¡¹ç›® codingmore-filter-interceptor-listenerã€‚</p><p>æ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨ MyFilter ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@WebFilter</span><span class="token punctuation">(</span>urlPatterns <span class="token operator">=</span> <span class="token string">&quot;/*&quot;</span><span class="token punctuation">,</span> filterName <span class="token operator">=</span> <span class="token string">&quot;myFilter&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>filterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Execute cost=&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>@WebFilter æ³¨è§£ç”¨äºå°†ä¸€ä¸ªç±»å£°æ˜ä¸ºè¿‡æ»¤å™¨ï¼ŒurlPatterns å±æ€§ç”¨æ¥æŒ‡å®šè¿‡æ»¤å™¨çš„ URL åŒ¹é…æ¨¡å¼ï¼ŒfilterName ç”¨æ¥å®šä¹‰è¿‡æ»¤å™¨çš„åå­—ã€‚</p><p>MyFilter è¿‡æ»¤å™¨çš„é€»è¾‘éå¸¸ç®€å•ï¼Œé‡å†™äº† Filter çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œåœ¨ doFilter æ–¹æ³•ä¸­åŠ å…¥äº†æ—¶é—´æˆ³çš„è®°å½•ã€‚</p><p>ç„¶åæˆ‘ä»¬åœ¨é¡¹ç›®å…¥å£ç±»ä¸ŠåŠ ä¸Š @ServletComponentScan æ³¨è§£ï¼Œè¿™æ ·è¿‡æ»¤å™¨å°±ä¼šè‡ªåŠ¨æ³¨å†Œã€‚</p><p>å¯åŠ¨æœåŠ¡å™¨ï¼Œè®¿é—®ä»»æ„çš„ URLã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/springboot/Filter-Interceptor-Listener-c865b6d2-30d3-435b-a930-c732caed17ce.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="æ‹¦æˆªå™¨" tabindex="-1"><a class="header-anchor" href="#æ‹¦æˆªå™¨" aria-hidden="true">#</a> æ‹¦æˆªå™¨</h2><ul><li>ç™»å½•éªŒè¯ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•</li><li>æƒé™éªŒè¯ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®èµ„æºï¼Œå¦‚æ ¡éªŒtoken</li><li>æ—¥å¿—è®°å½•ï¼Œè®°å½•è¯·æ±‚æ“ä½œæ—¥å¿—ï¼ˆç”¨æˆ·ipï¼Œè®¿é—®æ—¶é—´ç­‰ï¼‰ï¼Œä»¥ä¾¿ç»Ÿè®¡è¯·æ±‚è®¿é—®é‡</li><li>å¤„ç†cookieã€æœ¬åœ°åŒ–ã€å›½é™…åŒ–ã€ä¸»é¢˜ç­‰</li><li>æ€§èƒ½ç›‘æ§ï¼Œç›‘æ§è¯·æ±‚å¤„ç†æ—¶é•¿ç­‰</li></ul><p>æˆ‘ä»¬æ¥å†™ä¸€ä¸ªç®€å•çš„æ‹¦æˆªå™¨ LoggerInterceptorï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggerInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;preHandle{}...&quot;</span><span class="token punctuation">,</span>request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> modelAndView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€ä¸ªæ‹¦æˆªå™¨å¿…é¡»å®ç° HandlerInterceptor æ¥å£ï¼ŒpreHandle æ–¹æ³•æ˜¯ Controller æ–¹æ³•è°ƒç”¨å‰æ‰§è¡Œï¼ŒpostHandle æ˜¯ Controller æ–¹æ³•æ­£å¸¸è¿”å›åæ‰§è¡Œï¼ŒafterCompletion æ–¹æ³•æ— è®º Controller æ–¹æ³•æ˜¯å¦æŠ›å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œã€‚</p><p>åªæœ‰ preHandle è¿”å› true çš„è¯ï¼Œå…¶ä»–ä¸¤ä¸ªæ–¹æ³•æ‰ä¼šæ‰§è¡Œã€‚</p><p>å¦‚æœ preHandle è¿”å› false çš„è¯ï¼Œè¡¨ç¤ºä¸éœ€è¦è°ƒç”¨Controlleræ–¹æ³•ç»§ç»­å¤„ç†äº†ï¼Œé€šå¸¸åœ¨è®¤è¯æˆ–è€…å®‰å…¨æ£€æŸ¥å¤±è´¥æ—¶ç›´æ¥è¿”å›é”™è¯¯å“åº”ã€‚</p><p>å†æ¥ä¸€ä¸ª InterceptorConfig å¯¹æ‹¦æˆªå™¨è¿›è¡Œé…ç½®ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>@Configuration æ³¨è§£ç”¨äºå®šä¹‰é…ç½®ç±»ï¼Œå¹²æ‰äº†ä»¥å¾€ Spring ç¹ççš„ xml é…ç½®æ–‡ä»¶ã€‚</p><p>ç¼–å†™ä¸€ä¸ªç”¨äºè¢«æ‹¦æˆªçš„æ§åˆ¶å™¨ MyInterceptorControllerï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/myinterceptor&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyInterceptorController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;æ²‰é»˜ç‹äºŒæ˜¯å‚»X&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>@RestController æ³¨è§£ç›¸å½“äº @Controller + @ResponseBody æ³¨è§£ï¼Œ@ResponseBody æ³¨è§£ç”¨äºå°† Controller æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œé€šè¿‡é€‚å½“çš„ HttpMessageConverter è½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼åï¼Œå†™å…¥åˆ° Response å¯¹è±¡çš„ body æ•°æ®åŒºï¼Œé€šå¸¸ç”¨æ¥è¿”å› JSON æˆ–è€… XML æ•°æ®ï¼Œè¿”å› JSON æ•°æ®çš„æƒ…å†µæ¯”è¾ƒå¤šã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/springboot/Filter-Interceptor-Listener-27c3f03f-8cca-4cbe-84cb-005075c0b8c9.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¯åŠ¨æœåŠ¡å™¨ï¼Œè®¿é—® <code>http://localhost:8080/myinterceptor/hello</code>ã€‚</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/springboot/Filter-Interceptor-Listener-dcd99eeb-c00e-4a7a-a1c2-f8c5ca952aed.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åœ¨æ§åˆ¶å°å¯ä»¥çœ‹åˆ°æ‹¦æˆªå™¨ä¸­çš„æ—¥å¿—ä¿¡æ¯ï¼š</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/springboot/Filter-Interceptor-Listener-20bb0987-77c8-4069-a59f-bbd2d5584d8c.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ— è®ºæ˜¯è¿‡æ»¤å™¨è¿˜æ˜¯æ‹¦æˆªå™¨ï¼Œéƒ½å±äºAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ€æƒ³çš„å…·ä½“å®ç°ã€‚é™¤äº†è¿™ä¸¤ç§å®ç°ä¹‹å¤–ï¼Œè¿˜æœ‰å¦ä¸€ç§æ›´çµæ´»çš„AOPå®ç°æŠ€æœ¯ï¼Œå³ Aspectï¼Œåœ¨ç¼–ç¨‹å–µå®æˆ˜é¡¹ç›®é‡Œï¼Œä½ å¯ä»¥çœ‹åˆ° Aspect å…·ä½“å®ç°ã€‚</p><p>æ¯”å¦‚è¯´ç»Ÿä¸€æ—¥å¿—åˆ‡é¢ WebLogAspectï¼Œå°±æ˜¯ç”¨æ¥è®°å½•è¯·æ±‚ä¿¡æ¯çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebLogAspect</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> <span class="token constant">LOGGER</span> <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">WebLogAspect</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(public * com.codingmore.controller.*.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">webLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;webLog()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doBefore</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;webLog()&quot;</span><span class="token punctuation">,</span> returning <span class="token operator">=</span> <span class="token string">&quot;ret&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAfterReturning</span><span class="token punctuation">(</span><span class="token class-name">Object</span> ret<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;webLog()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doAround</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è·å–å½“å‰è¯·æ±‚å¯¹è±¡</span>
        <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webLog<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        webLog<span class="token punctuation">.</span><span class="token function">setUri</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;parameter&quot;</span><span class="token punctuation">,</span>webLog<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;spendTime&quot;</span><span class="token punctuation">,</span>webLog<span class="token punctuation">.</span><span class="token function">getSpendTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span>webLog<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>webLog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * æ ¹æ®æ–¹æ³•å’Œä¼ å…¥çš„å‚æ•°è·å–è¯·æ±‚å‚æ•°
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡æ‹¦æˆªåçš„è¯·æ±‚ä¿¡æ¯å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><figure><img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/springboot/Filter-Interceptor-Listener-7a4b219d-bd3e-435e-a2dc-93f4fe4e8cc2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="ç›‘å¬å™¨" tabindex="-1"><a class="header-anchor" href="#ç›‘å¬å™¨" aria-hidden="true">#</a> ç›‘å¬å™¨</h2><p>æ ¹æ®ç›‘å¬å¯¹è±¡å¯ä»¥æŠŠç›‘å¬å™¨åˆ†ä¸º 3 ç±»ï¼š</p><hr>`,53),r={href:"https://javabetter.cn/zhishixingqiu/",target:"_blank",rel:"noopener noreferrer"},k=n("strong",null,"ç¼–ç¨‹å–µ",-1),d=n("hr",null,null,-1),v=n("h2",{id:"æºç è·¯å¾„",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#æºç è·¯å¾„","aria-hidden":"true"},"#"),s(" æºç è·¯å¾„ï¼š")],-1),m={href:"https://github.com/itwanger/coding-more",target:"_blank",rel:"noopener noreferrer"},b={href:"https://github.com/itwanger/codingmore-learning/tree/main/codingmore-filter-interceptor-listener",target:"_blank",rel:"noopener noreferrer"},g=n("figure",null,[n("img",{src:"https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongzhonghao.png",alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1);function f(h,w){const a=p("ExternalLinkIcon");return o(),c("div",null,[u,n("p",null,[s("æ›´å¤šå†…å®¹ï¼Œåªé’ˆå¯¹ã€ŠäºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯ã€‹æ˜Ÿçƒç”¨æˆ·å¼€æ”¾ï¼Œéœ€è¦çš„å°ä¼™ä¼´å¯ä»¥"),n("a",r,[s("æˆ³é“¾æ¥ğŸ”—"),t(a)]),s("åŠ å…¥æˆ‘ä»¬çš„æ˜Ÿçƒï¼Œä¸€èµ·å­¦ä¹ ï¼Œä¸€èµ·å·ã€‚ã€‚"),k,s("ğŸ±æ˜¯ä¸€ä¸ª Spring Boot+Vue çš„å‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼Œèåˆäº†å¸‚é¢ä¸Šç»å¤§å¤šæ•°æµè¡Œçš„æŠ€æœ¯è¦ç‚¹ã€‚é€šè¿‡å­¦ä¹ å®æˆ˜é¡¹ç›®ï¼Œä½ å¯ä»¥å°†æ‰€å­¦çš„çŸ¥è¯†é€šè¿‡å®è·µè¿›è¡Œæ£€éªŒã€ä½ å¯ä»¥æ‹“å®½è‡ªå·±çš„æŠ€æœ¯è¾¹ç•Œï¼Œä½ å¯ä»¥æŒæ¡ä¸€ä¸ªçœŸæ­£çš„å®æˆ˜é¡¹ç›®æ˜¯å¦‚ä½•ä» 0 åˆ° 1 çš„ã€‚")]),d,v,n("blockquote",null,[n("ul",null,[n("li",null,[s("ç¼–ç¨‹å–µï¼š"),n("a",m,[s("https://github.com/itwanger/coding-more"),t(a)])]),n("li",null,[s("è¿‡æ»¤å™¨ï¼Œæ‹¦æˆªå™¨ã€ç›‘å¬å™¨ä¸“ç”¨ï¼š"),n("a",b,[s("https://github.com/itwanger/coding-more"),t(a)])])])]),g])}const j=e(l,[["render",f],["__file","Filter-Interceptor-Listener.html.vue"]]);export{j as default};
